<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pseudo web sockets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Inspired by this article about Socket connections in Web applications, I decided to make a more or less universal module with a user-friendly interfac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pseudo web sockets</h1><div class="post__text post__text-html js-mediator-article">  Inspired by <a href="http://habrahabr.ru/post/41223/">this article</a> about Socket connections in Web applications, I decided to make a more or less universal module with a user-friendly interface that implements this technology. <br>  In this article, the word "socket" means software interface that provides data exchange between server and client scripts, with the ability of the client to constantly "listen to the port".  In other words, as soon as something happens on the server, he can immediately inform the client about it, and vice versa.  Of course, in javascript there is no possibility to ‚Äúlisten to ports‚Äù and create full-fledged sockets, but then we have matches, electrical tape and plasticine, from which we can make some sort of similarity. <br>  First, I will describe the approximate principle of this system, and then, according to tradition, I will give the code of a primitive chat based on it, with, of course, a link.  I would like to see with my own eyes habraeffekt in action.  At the end there will be a link to the source repository. <br><br><a name="habracut"></a><br><h1>  Operating principle </h1><br>  Based on <a href="http://javascript.ru/ajax/comet/long-poll">the long poll</a> method.  The client module sends a request to the server script, which does not close it in advance for a long time (time depends on the maximum possible time of the script on the server, for example, 20 - 25 seconds).  If nothing happened during this time, the script notifies the client about it and stops working.  The client, having received such a message, immediately creates a new request.  All this continues until some event of interest to the client occurs on the server, the server script immediately starts some predefined your function, which forms the answer to the client in the form of a hash, gives it back, and the answer is immediately sent to the client.  At the same time, the client can initiate any event and send information to the server, the rest of the clients ‚Äúlistening‚Äù to this port will immediately recognize this event. <br>  The system is implemented as two plug-in modules.  One, client, of course, in javascript.  The second server is written in perl.  The names of the modules themselves, and all the properties and methods exported by them, variables and functions are inspired by, it seemed to me amusing, an analogy-association with a music lover <code>( )</code> listening to phonographs in different rooms <code>("")</code> as soon as a music lover hears that in some The room was replaced with a record - it informs about some of your predetermined function.  (all of these synonyms of anology, in spite of my titanic efforts to restore order, chaotically replace each other in the following text and in the comments to the code, so it is worth remembering them at least about :) <br><br><h1>  Client part: </h1><br>  It connects something like this: <br><pre> <code class="javascript hljs">&lt;script type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> src=<span class="hljs-string"><span class="hljs-string">"MWS_meloman.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ‚ÄúListening‚Äù is started by the <b>Listen</b> function, it is passed one parameter - a string in the format <br> <code>&lt; -&gt; : &lt;    &gt;</code> <br>  the handler function will start as soon as something arrives at this port, and this ‚Äúsomething‚Äù will immediately be transferred to it as an object (property: value, ...). <br>  For example, <br><pre> <code class="javascript hljs">meloman.Listen(<span class="hljs-string"><span class="hljs-string">'handler1:5'</span></span>) <span class="hljs-comment"><span class="hljs-comment">//  meloman.Listen('handler1:5-7') //    meloman.Listen('handler1:5-7; handler2 : 8-10; handler3 : 11-20');</span></span></code> </pre><br><br>  If for some reason you need to stop listening, <b>Listen</b> you must pass an empty string: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//  meloman.Listen(''); //  : meloman.Listen(); // , ,   :)</span></span></code> </pre><br><br>  If something the server needs to ‚Äúknow‚Äù about, and those who listen to this port, happened to the client, then it ‚Äúpacks‚Äù this ‚Äúsomething‚Äù into the object and passes it to the <b>Change</b> function, specifying the ‚Äúport‚Äù as the first parameter. <br>  For example: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> some = { <span class="hljs-string"><span class="hljs-string">'name'</span></span> : <span class="hljs-string"><span class="hljs-string">'Mr.Smith'</span></span>, <span class="hljs-string"><span class="hljs-string">'message'</span></span> : <span class="hljs-string"><span class="hljs-string">'Find Neo'</span></span>} meloman.Change( <span class="hljs-number"><span class="hljs-number">5</span></span>, some );</code> </pre><br><br>  it is immediately sent to the server and passed to your perl function, which knows what to do with it, in the form of a hash. <br><br>  There are also several properties-settings: <br><br>  <b>minReconnectTime</b> - time in milliseconds, which more often than not can send requests to the server, <br><br>  <b>reconnectTime</b> - time in milliseconds after which a new request is sent to the server, <br><br>  <b>waitingTimeOut</b> - the maximum waiting time for a response from the server, <br><br>  <b>waitingTimeOutHandler</b> is a function that handles a situation when, during the waitingTimeOut, there was no response from the server at all, <br><br>  <b>connectionErrorHandler</b> is a function that handles server errors (if the response from the server is not 200 OK), <br><br>  <b>routeToChange</b> - the path to the server script to which the object will be passed by the Change function, <br><br>  <b>routeToListen</b> - the path to the server script that will ‚Äúlisten‚Äù to the specified port (s) and send, in which case, information to the client, <br><br>  <b>ignoreMyChanges</b> - if false, the changes you made to the Change function will be perceived by you as a new event on the server, <br><br>  of all these settings, only <b>routeToChange</b> and <b>routeToListen are required</b> , the others either have default settings, or they are not important for proper operation. <br><br><h1>  Server part: </h1><br><br>  The <b>Patefon.pm</b> module <b>is</b> downloaded, copied somewhere, for example, to ./libs and connected: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> lib <span class="hljs-string"><span class="hljs-string">"./.libs"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Patefon;</code> </pre><br><br>  The module exports the <b>&amp; change_the_plate</b> and <b>&amp; listen_the_plate functions</b> and the settings hash <b>% patefons_knobs.</b>  (Now the beta version exports a little more (for debugging), but this will be fixed in the next version.) <br><br>  I recommend making two separate scripts on the server, one for listening, the second for ‚Äúreceiving‚Äù information from the client.  Although no one would mind if everything is crammed into one script. <br>  The one that ‚Äúlistens to‚Äù uses the <b>&amp; listen_the_plate</b> function, it starts without parameters.  Before launching, it is necessary to specify handler functions for all necessary ports. <br><br> <code>$patefons_knobs{handlers}{&lt; &gt;} = &lt;  -&gt;;</code> <br> <br>  For example: <br><pre> <code class="perl hljs">$patefons_knobs<span class="hljs-string"><span class="hljs-string">{handlers}</span></span><span class="hljs-string"><span class="hljs-string">{1}</span></span> = \&amp;handler_1;</code> </pre><br><br>  This handler function must be ready to accept the first parameter the number of the room-port in which something has changed, and the second (if it needs it) number of the new playing record.  Something with all this (and, perhaps, not only with this) to do, and return the hash, which must be sent to the client. <br><br>  Before all this, you must specify the path to the folder with "rooms-ports": <br><br><pre> <code class="perl hljs">$patefons_knobs<span class="hljs-string"><span class="hljs-string">{path_to_rooms}</span></span> = <span class="hljs-string"><span class="hljs-string">'./.rooms/'</span></span>;</code> </pre><br><br>  each folder should have a folder of the same name in this folder, each such folder should have a door file (no matter what is written there, it will completely disappear and 'nothing') it is used to block the ‚Äúroom-port‚Äù at the moment something changes the &amp; change_the_plate function (at the moment when something from a client came to the server). <br>  approximate directory scheme ./.rooms: <br><pre> ./.rooms/
      ./one/
           ./door
      ./2/
           ./door
</pre><br>  etc. <br><br>  The script that listens uses the <b>&amp; change_the_plate</b> function.  Before its launch, you must specify the path to the "port-rooms": <br><pre> <code class="perl hljs">$patefons_knobs<span class="hljs-string"><span class="hljs-string">{path_to_rooms}</span></span> = <span class="hljs-string"><span class="hljs-string">'./.rooms/'</span></span>;</code> </pre><br><br>  and handler functions: <br> <code>$patefons_knobs{ChngHandlers}{&lt;&gt;} = &lt;  -&gt;;</code> <br> <br>  the handler will be passed to the function a reference to the hash that came from the client. <br><br>  after she does something with him she should return a value that can be interpreted as true, for example 1. <br><br>  It is also important that all transmitted hashes / objects must be one-dimensional. <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// ,  : var some = { 'name' : 'Mr.Smith', 'message' : 'Find Neo!', 'time' : 'Now!' }; //   : var some = { 'name' : 'Mr.Smith', 'action' : { 'message' : 'Find Neo!', 'time' : 'Now!' } };</span></span></code> </pre><br><br>  In the settings hash, in addition to specifying handlers and paths to the ‚Äúrooms‚Äù, you can twist these handles: <br><br>  <b>patefons_knobs {sample_rate}</b> - time in seconds, after which the state of the port will be polled, by default 1. <br>  <b>patefons_knobs {maxSleeping}</b> - the time in seconds after which the listening script finishes its work by default 20. <br><br>  There is an array of <b>patefons_knobs {errors}</b> in which all errors are added, the module function that executed without errors returns 1, with errors - 0. This can be used, for example, to record errors in the log.  So, for example: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">unless</span></span> ( &amp;change_the_plate ) { <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> LOG, <span class="hljs-string"><span class="hljs-string">"&gt;&gt;log"</span></span>; $" = <span class="hljs-string"><span class="hljs-string">"\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> LOG <span class="hljs-string"><span class="hljs-string">qq(ERRORS: </span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">@{$patefons_knobs</span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">{errors}</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">)</span></span>; }</code> </pre><br><br>  So, below is the promised code for a primitive chat.  Note that (without taking into account any whistles in the form of autoscrolling and sound) javascript'a there are only 16 lines (and if the default settings were used, then, in general, 14). <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http-equiv</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/html; charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"stylesheet"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat_style.css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/css"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">media</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"screen"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MWS_meloman.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> mayScroll = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">true</span></span></span><span class="javascript">; meloman.ignoreMyChanges = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">true</span></span></span><span class="javascript">; meloman.routeToListen = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'ls.pl'</span></span></span><span class="javascript">; meloman.reconnectTime = </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">25000</span></span></span><span class="javascript">; meloman.routeToChange = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'ch.pl'</span></span></span><span class="javascript">; meloman.Listen(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'j3:1'</span></span></span><span class="javascript">); </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">j3</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params"> a </span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> string = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">''</span></span></span><span class="javascript">; </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">for</span></span></span><span class="javascript"> ( </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> Name </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">in</span></span></span><span class="javascript"> a ) { string += Name + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"\t"</span></span></span><span class="javascript"> + a[Name] + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"\n"</span></span></span><span class="javascript"> } </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'chat'</span></span></span><span class="javascript">).innerHTML += a[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">]; playsound(); scrollchat(); }; </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">send_message</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> banderol = {}; banderol[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">] = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">).value; banderol[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'user'</span></span></span><span class="javascript">] = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'user'</span></span></span><span class="javascript">).value || </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'Anonymous'</span></span></span><span class="javascript">; banderol[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'color'</span></span></span><span class="javascript">] = </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'color'</span></span></span><span class="javascript">).value || </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'#333333'</span></span></span><span class="javascript">; </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> ( </span><span class="hljs-regexp"><span class="javascript"><span class="hljs-regexp">/\S+/</span></span></span><span class="javascript">.test( banderol[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">] ) &amp;&amp; banderol[</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">].length &lt; </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">500</span></span></span><span class="javascript"> ) { meloman.Change( </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">1</span></span></span><span class="javascript">, banderol) } </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'message'</span></span></span><span class="javascript">).value = </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">''</span></span></span><span class="javascript">; } </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">scrollchat</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> ( mayScroll ) </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'chat'</span></span></span><span class="javascript">).scrollTop = </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">9999</span></span></span><span class="javascript">; } </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> </span></span><span class="hljs-title"><span class="javascript"><span class="hljs-function"><span class="hljs-title">playsound</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> ( </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'need_sound'</span></span></span><span class="javascript">).checked ) { </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"snd"</span></span></span><span class="javascript">).volume = </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">0.4</span></span></span><span class="javascript">; </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.getElementById(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">"snd"</span></span></span><span class="javascript">).play(); } } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"settings"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"params"</span></span></span><span class="hljs-tag">&gt;</span></span>: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autofocus</span></span></span><span class="hljs-tag"> /&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"params"</span></span></span><span class="hljs-tag">&gt;</span></span>: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"color"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#00aa00"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"color"</span></span></span><span class="hljs-tag"> /&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"params"</span></span></span><span class="hljs-tag">&gt;</span></span>: <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"checkbox"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"need_sound"</span></span></span><span class="hljs-tag"> /&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">span</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"cont"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"chat"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onmouseover</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mayScroll=false;"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onmouseout</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"mayScroll=true"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onsubmit</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"send_message();return false;"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message_cont"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autocomplete</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"off"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">spellcheck</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audio</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"snd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"beep.ogg"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio/ogg; codecs=vorbis"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"beep.mp3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audio/mpeg"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audio</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  And the server part: <br><br>  "Listening" script: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; use warnings; use lib "./.libs"; use Patefon; $patefons_knobs{handlers}{1} = \&amp;j_1; $patefons_knobs{path_to_rooms} = './.rooms/'; $patefons_knobs{maxSleeping} = 20; listen_the_plate(); sub j_1 { my $new = $_[1]; my $old = ( $new - $_[0] ) &lt; 5 ? $_[0] : ( $new - 5 ); my $unreaden_messages; for ( my $i = ++$old; $i &lt;= $new; $i++ ) { open F, "&lt;utf8", "./general_chat/$i" or next; $unreaden_messages .= &lt;F&gt;; } my %hash = ( 'message' =&gt; $unreaden_messages ); return %hash; }</span></span></code> </pre><br><br>  and ‚Äúplate changing‚Äù: <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; use warnings; use lib "./.libs"; use Patefon; $patefons_knobs{path_to_rooms} = './.rooms/'; $patefons_knobs{ChngHandlers}{1} = \&amp;j_1; unless ( &amp;change_the_plate ) { open LOG, "&gt;&gt;log"; $" = "\n"; print LOG qq(ERRORS: @{$patefons_knobs{errors}}); } sub j_1 { my ( $room, $plate, $banderol ) = @_; return 0 if ( ${$banderol}{message} eq '' ); unless ( ${$banderol}{color} =~ /^#[0-9a-f]{3}$|^#[0-9a-f]{6}$/i ) { ${$banderol}{color} = '#FE5590' } # shield &lt; and &gt; for ( ${$banderol}{message}, ${$banderol}{user} ) { s/&lt;/&lt;/g; s/&gt;/&gt;/g } open F, "&gt;", "./general_chat/$plate"; print F qq(&lt;span class="name" style="color:${$banderol}{color};"&gt;${$banderol}{user}&lt;/span&gt;: &lt;span class="mess"&gt;${$banderol}{message}&lt;/span&gt;&lt;br /&gt;) }</span></span></code> </pre><br><br>  and the link to the actual chat: <br>  &lt;she was here, but she is no more.  you forgive me =)&gt; <br><br>  In addition to toy chats, these modules can be found, I think, many different applications, I, for example, did all this for a multiplayer admin panel. <br><br>  This system of ‚Äúpseudo-web sockets‚Äù modules is only beta, still, for sure, very raw, but already quite working.  I have not found any bugs yet, I hope for those who will use it :) <br>  Here, the sources are available on bitbucket.org.  Use, forge, write bug reports or throw stones.  I‚Äôm happy to put all the ‚Äústones‚Äù on and try to tap them somewhere with tape, stick with clay, back up with matches, or glue them with snot. </div><p>Source: <a href="https://habr.com/ru/post/160679/">https://habr.com/ru/post/160679/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../160665/index.html">Flurry: China will soon overtake the United States by the number of smartphones</a></li>
<li><a href="../160667/index.html">Managing Parallels Automation for Cloud Infrastructure with API</a></li>
<li><a href="../160669/index.html">Desire HD: Which firmware is better?</a></li>
<li><a href="../160675/index.html">About the absence of hot swap drives in the BX924 S3</a></li>
<li><a href="../160677/index.html">SCSS and cross-platform gradient (well, almost)</a></li>
<li><a href="../160681/index.html">Create an AD user through the web interface</a></li>
<li><a href="../160685/index.html">How does Fishing Joy 2 in China manage to get $ 1.6 million per month</a></li>
<li><a href="../160687/index.html">Types and formats of references</a></li>
<li><a href="../160689/index.html">Digitizing 35mm film</a></li>
<li><a href="../160691/index.html">"Failsafe" system based on Ubuntu and btrfs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>