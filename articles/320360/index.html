<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What the flask?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Actually, this is a picture from wtforms, but for some reason my gimp doesn't start. 


 I am writing this article in a bar. I really want to talk a l...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What the flask?</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/0b6/9c4/bae/0b69c4bae2684163a67b526da89f1597.png" alt="kdpv"><br>  <em>Actually, this is a picture from wtforms, but for some reason my gimp doesn't start.</em> </p><br><p>  I am writing this article in a bar.  I really want to talk a little, but the barman looks at me with round eyes, and the hookah man just smiles and shakes his head. </p><br><p>  Once, I was asked: what's wrong with a flask?  Then I was completely satisfied with this cute framework.  Having worked with him for some time, I wrote everything I think, a worker is weak, to which I was answered: "Murad, be kinder."  Actually, I'm kind and fluffy, but wtf ?! </p><a name="habracut"></a><br><p>  It is worth noting that I am a big fan of the work of <a href="http://lucumr.pocoo.org/about/">Armin</a> .  His packages are used in many of my projects.  And he is an incredible thorn in the Python community.  And this is good. </p><br><h2 id="flask">  Flask </h2><br><p>  Flask is a wrapper over very cool detached projects.  Some compare it with janga.  I xs why. </p><br><p>  If you try to describe all the problems of Flask in two points: </p><br><ol><li>  imports </li><li>  request context </li></ol><br><p>  Everything.  Then you can not read.  But if it is still not clear, look further. </p><br><h2 id="blueprints">  Blueprints </h2><br><p> If in janga all applications are connected to <code>INSTALLED_APPS</code> , then the concept of <code>blueprints</code> used in the <code>blueprints</code> .  This application and a separate namespace url in one bottle: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Flask <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> yourapplication.simple_page <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> simple_page app = Flask(__name__) app.register_blueprint(simple_page, end_point=<span class="hljs-string"><span class="hljs-string">'/simple_page'</span></span>)</code> </pre> <br><p>  Further, you can route urls like this: <code>url_for('simple_page.index')</code> . </p><br><h3 id="vlozhennost">  Nesting </h3><br><p>  And it is not.  You can not just take and make an embedded namespace.  You can find ‚Äúsolutions‚Äù on the web, but here I‚Äôll only look at boxed flagship, because you can write everything. </p><br><h3 id="importy">  Imports </h3><br><p>  When you do this in the production code: </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> foo == <span class="hljs-number"><span class="hljs-number">3</span></span>: do_stuff(foo)</code> </pre> <br><p>  Somewhere in the world I'm sad!  Take care of me, take it to the settings. </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> myapp <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> app <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(FlaskForm)</span></span></span><span class="hljs-class">:</span></span> choices = SelectField(choices=app.conf.FOO_CHOICES)</code> </pre> <br><p>  Conceptually.  But it will not work.  Because a couple of lines ago, we imported the package into <code>myapp</code> and forever ordered our way there. </p><br><p>  Wait, there must be a way out!  Aha </p><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> flask <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> current_app</code> </pre> <br><p>  And it does not work.  Because <code>current_app</code> is available only in context of the request! </p><br><p>  - Finally, bring it to the settings file of the application, you bastard!  - voice from the audience. <br>  - And how will I replace them on the prode or test, huh? </p><br><p>  By the way, I have a special <a href="https://github.com/byashimov/django-pkgconf">battery</a> for this case. <br>  Just imagine the wonderful wonderful world where <code>django.conf.settings</code> is available only in the context of a request! </p><br><h2 id="flaskg">  flask.g </h2><br><p>  It is impossible not to joke about the same point.  And most importantly, it does not need to search, it is always here: <code>flask.g</code> .  Bad boom shh! <br>  That's why Armin is my idol! </p><br><p>  You can send everything you need into it: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.before_request def before_request(): g.locale = get_locale() g.foo = foo</span></span></code> </pre> <br><p>  However, this will work only in the context of a request, like any other magical objects of the fusion. </p><br><h2 id="routing-urlov-i-ih-metody">  Routing URLs and their methods </h2><br><p>  I have such a piece of urls <a href="https://github.com/byashimov/website">on</a> my <a href="https://github.com/byashimov/website">site</a> : </p><br><pre> <code class="python hljs">bp.add_url_rule(<span class="hljs-string"><span class="hljs-string">'/api/v1/'</span></span>, view_func=ApiView.as_view(<span class="hljs-string"><span class="hljs-string">'api_view'</span></span>)) ... bp.add_url_rule(<span class="hljs-string"><span class="hljs-string">'/&lt;path:path&gt;/'</span></span>, view_func=PageView.as_view(<span class="hljs-string"><span class="hljs-string">'page_view'</span></span>))</code> </pre> <br><p>  <code>ApiView</code> processes only one method - <code>POST</code> .  Guess what happens if you ask for <code>GET</code> ?  Aha, 404. It is provided by the second view. <br>  To get <code>NOT ALLOWED</code> , you need to explicitly return 405 to <code>ApiView</code> ! </p><br><p>  Fask, what's wrong with you? </p><br><h2 id="steyk">  Steak! </h2><br><p>  A. Wait a minute.  That's for me.  Omnom-omnom. </p><br><h2 id="flask-wtf-csrf">  flask-wtf.  CSRF </h2><br><p>  Oh.  Suppose we need to turn off the check in one view: </p><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@app.route('/foo', methods=('GET', 'POST')) @csrf.exempt def my_handler(): # ... return 'ok'</span></span></code> </pre> <br><p>  So we need an <code>app</code> .  Remember imports, right?  We are looking for a way out, we climb in sortsy: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exempt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, view)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(view, string_types): view_location = view <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: view_location = <span class="hljs-string"><span class="hljs-string">'.'</span></span>.join((view.__module__, view.__name__)) self._exempt_views.add(view_location) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> view</code> </pre> <br><p>  Hooray!  You can pass the path to the view (in the version that came out two weeks ago)!  We try: </p><br><pre> <code class="python hljs">csrf.exempt(<span class="hljs-string"><span class="hljs-string">'website.apps.typus_web.views.ApiView'</span></span>)</code> </pre> <br><p>  Does not work.  Actually (I hate this expression), we changed the name of the view when we called <code>ApiView.as_view('api_view')</code> : </p><br><pre> <code class="python hljs">csrf.exempt(<span class="hljs-string"><span class="hljs-string">'website.apps.typus_web.views.api_view'</span></span>)</code> </pre> <br><p>  And "all the same" that we indicate the path to an object that does not exist.  Works!  Does not work. </p><br><p>  Do you know why?  Because the form.  She doesn't know anything about the view: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiForm</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ViewForm)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(ViewForm.Meta)</span></span></span><span class="hljs-class">:</span></span> csrf = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span></code> </pre> <br><p>  Now it works. </p><br><h2 id="url_for">  url_for () </h2><br><p>  Suppose you want to do this: </p><br><pre> <code class="python hljs">NAVIGATION = ( (url_for(<span class="hljs-string"><span class="hljs-string">'flatpages:index'</span></span>), _(<span class="hljs-string"><span class="hljs-string">'Home page'</span></span>)), )</code> </pre> <br><p>  Forget it.  Out of context does not work.  Probably, you can make your lazy object, in the end, it didn‚Äôt immediately appear in janga either. </p><br><h2 id="flask-testing">  flask-testing </h2><br><p>  Stuck, designed to help with the tests.  For example, you can look at the context that is passed to the template.  And let's try: </p><br><pre> <code class="python hljs">AssertionError: Popped wrong request context.</code> </pre> <br><p>  Oh.  Something went wrong.  And you know what?  I don't know either. <br>  Actually (I hate this expression), I grabbed <code>NotImplementedError</code> in one of the methods that I did not override.  But the point is that dropping the tests, you will never understand the reason. </p><br><h2 id="vsyakoe-raznoe">  Any different </h2><br><p>  In the process of picking up a flake, I found several points: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jsonify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> args <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> kwargs: <span class="hljs-keyword"><span class="hljs-keyword">raise</span></span> TypeError(<span class="hljs-string"><span class="hljs-string">'jsonify() behavior undefined when passed both args and kwargs'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> len(args) == <span class="hljs-number"><span class="hljs-number">1</span></span>: <span class="hljs-comment"><span class="hljs-comment"># single args are passed directly to dumps() data = args[0] else: data = args or kwargs</span></span></code> </pre> <br><p>  Something is happening here.  That is all I understand. </p><br><p>  And this: </p><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(*args)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> args: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current_app.response_class() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(args) == <span class="hljs-number"><span class="hljs-number">1</span></span>: args = args[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> current_app.make_response(args)</code> </pre> <br><p>  And now the berries: </p><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Flask</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(_PackageBoundObject)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">make_response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, rv)</span></span></span><span class="hljs-function">:</span></span> status_or_headers = headers = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(rv, tuple): rv, status_or_headers, headers = rv + (<span class="hljs-keyword"><span class="hljs-keyword">None</span></span>,) * (<span class="hljs-number"><span class="hljs-number">3</span></span> - len(rv))</code> </pre> <br><p>  All burn! </p><br><p>  PS Why am I writing articles alone, m?  Who wants to go to the bar (in St. Petersburg, in the Starry area) on Tuesday (say, to accommodate more) that week? .. Write in inbox. </p><br><p>  PPS Habr, why aren't you typing texts?  Here, I even wrote a <a href="https://habrahabr.ru/post/320174/">piece</a> ! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/320360/">https://habr.com/ru/post/320360/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320346/index.html">Docker implementation for a small project in Production, part 2</a></li>
<li><a href="../320348/index.html">How to establish a trust relationship between the computer and the main domain</a></li>
<li><a href="../320350/index.html">Five years, five educational projects: briefly about the main and the history of teachers</a></li>
<li><a href="../320354/index.html">How were born the IT-dynasties in Belarus</a></li>
<li><a href="../320356/index.html">How we lost 150,000 and closed the project</a></li>
<li><a href="../320362/index.html">The first real campaign campaigns Yandex Direct in Adwords</a></li>
<li><a href="../320364/index.html">National domains vs one common domain: case of 841% growth from an international brand</a></li>
<li><a href="../320366/index.html">How to achieve replication with zero RPO over long distances</a></li>
<li><a href="../320370/index.html">ITSM. What we understand about services</a></li>
<li><a href="../320372/index.html">How IT professionals work. Andrei Yankovsky, JSRs CSSSR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>