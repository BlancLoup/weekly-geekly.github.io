<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Moving beyond the boundaries of the Windows 8 Modern-Application container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Back in the Windows Vista operating system, Microsoft added a sandbox creation tool, the so-called Integrity Levels : 
 Untrusted <Low <Medium <High <...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Moving beyond the boundaries of the Windows 8 Modern-Application container</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/0a6/e0c/175/0a6e0c175f5ce3b254909d17ab3ed627.jpg" align="right">  Back in the Windows Vista operating system, Microsoft added a sandbox creation tool, the so-called <a href="http://msdn.microsoft.com/en-us/library/bb625963.aspx">Integrity Levels</a> : <br>  <b>Untrusted &lt;Low &lt;Medium &lt;High &lt;System</b> . <br><br>  Everything in the operating system (files, registry branches, synchronization objects, pipes, processes, threads) has its Integrity Level.  A process that has, for example, Low Integrity Level cannot open a file from a disk that has a Medium Integrity Level (the default level). <br><br>  It is on this mechanism that UAC and Run as administrator work, increasing the Integrity Level of the process being launched.  The sandbox in Google Chrome works on this technology: all tab processes have the lowest Integrity Level - Untrusted, which makes it impossible for the process to interact with any files, processes, registry branches, etc. at all. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage2/d03/afe/63f/d03afe63f263fb350fe5c5a7f26b5ca3.png"><br><br>  This is one of the strengths of Chrome security - after all, even if you find in it some stack overflow, you will be rested against the OS security system, which will not allow you to go beyond the boundaries of the process.  By the way, Microsoft itself applied such a browser sandboxing mechanism only 4 years later in Win8.1 + IE 11 (it was in the off state in Win8 + IE 10 - but who will go and search and enable it, so it does not count). <br><br>  With the release of Windows 8, Microsoft needed to make the isolation mechanism of Modern-applications, similar to those used in other mobile operating systems.  It was necessary to make it clear to both the user and the developer that the program from the store would not get the user's private data without his consent, would not break his system and would not disrupt other applications, even with his own crash.  To implement this idea, the Integrity Levels mechanism was again used.  Microsoft came up with such a thing as "AppContainer".  Reading the <a href="http://recxltd.blogspot.com/2012/03/windows-8-app-container-security-notes.html">docks</a> on the Internet and even looking at the <a href="">process description</a> in Process Explorer, you might think that AppContainer is another Integrity Level.  True, it is not clear where he is - between Low and Medium?  Between Untrusted and Low?  What can I say: both the docks on the Internet and the Process Explorer utility are <u>lying</u> .  I can‚Äôt imagine how marketers should have programmed their heads up so that the data fields from the official structures were intentionally displayed incorrectly, but this is how it is. <br><br>  The correct state of affairs is shown by the third-party <a href="http://processhacker.sourceforge.net/">ProcessHacker</a> utility.  As we can see from it, AppContainer is not a new Integrity Level.  This is just a special label that is added to the process that is running under the Low Integrity Level.  At the same time, this label is unique for each application and is used as an additional barrier, restricting access not only to applications with higher Integrity Levels, but even between processes with Low Integrity Levels, but different AppContainer tags. <br><br>  Up to this point, everything was more or less logical.  But from here begins obscurantism. <br><a name="habracut"></a><br><br><h4>  Obscurantism </h4><br>  For some reason, this default behavior by many (including Microsoft employees) is called the only possible one.  Here, for example, a <a href="https://wiki.mozilla.org/Windows_8_Integration">study of</a> Mozilla, to which Microsoft declared that they could not use pipelines between a modern application and a regular desktop.  Here is the <a href="http://stackoverflow.com/questions/7465517/how-can-a-metro-app-in-windows-8-communicate-with-a-backend-desktop-app-on-the-s">question</a> on Stackoverflow with the same answer from a Microsoft employee.  Here is a <a href="http://channel9.msdn.com/Events/BUILD/BUILD2011/TOOL-789C">report</a> at the BUILD conference, where again the Microsoft employee twice (at 47:20 and 55:00) states that it is impossible to create a complex from the backend in the desktop application and the frontend in the Modern part.  And once again about the same thing in a <a href="http://blogs.msdn.com/b/larryosterman/archive/2011/09/16/what-has-larry-been-doing-for-two-years-and-why-has-the-blog-been-dark-for-so-long.aspx">blog</a> on MSDN - again from a Microsoft employee. <br><br>  All this is nonsense, the default behavior can be changed and from the application in AppContainer we can communicate (via pipes, memory-mapped files, mutexes, etc.) with applications under any higher Integrity Levels. <br><br><h4>  Spoiler </h4><br>  I‚Äôll say right away that there will not be any ‚Äú0-day exploit‚Äù and ‚Äúwow, we hacked Windows!‚Äù.  Everything that I will talk about is in MSDN, is official and works under Win8 and Win 8.1.  Just somehow it is difficult to find it, plus from across the sea of ‚Äã‚Äãobvious misinformation from the links above it‚Äôs all that no one is even looking for. <br><br><h4>  The essence </h4><br>  Yes, the application in the AppContainer (by the way, this is not only the Modern-application, but also the same desktop IE 11) cannot itself go beyond the boundary of its container, the global named operating system objects are not available to it, it cannot open the file from the disk (except your folder).  But let's remember our task - to associate a desktop application running at least Medium Integrity Level with an application in AppContainer.  And it turns out that an application can create a named object (which by default inherits the Integrity Level process) and give access to it to applications with lower Integrity Levels.  Moreover, on this object we can even hang the label of a certain AppContainer or even all AppContainers in the system, which will make it possible to access this object from these processes. <br><br>  It is possible to draw an analogy with a prisoner in a cell who cannot get out of it himself, but a guard outside the cell may quite willingly communicate with him or even give access to that part of the prison where he can get to. <br><br>  The starting point for us is the code from <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/hh448493(v%3Dvs.85).aspx">this article</a> in MSDN: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">pragma</span></span></span><span class="hljs-meta"> comment(lib, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"advapi32.lib"</span></span></span><span class="hljs-meta">) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;windows.h&gt; #include &lt;stdio.h&gt; #include &lt;aclapi.h&gt; #include &lt;tchar.h&gt; int main(void) { BOOL GetLogonSid (HANDLE hToken, PSID *ppsid) { BOOL bSuccess = FALSE; DWORD dwLength = 0; PTOKEN_GROUPS ptg = NULL; // Verify the parameter passed in is not NULL. if (NULL == ppsid) goto Cleanup; // Get required buffer size and allocate the TOKEN_GROUPS buffer. if (!GetTokenInformation( hToken, // handle to the access token TokenLogonSid, // get information about the token's groups (LPVOID) ptg, // pointer to TOKEN_GROUPS buffer 0, // size of buffer &amp;dwLength // receives required buffer size )) { if (GetLastError() != ERROR_INSUFFICIENT_BUFFER) goto Cleanup; ptg = (PTOKEN_GROUPS)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dwLength); if (ptg == NULL) goto Cleanup; } // Get the token group information from the access token. if (!GetTokenInformation( hToken, // handle to the access token TokenLogonSid, // get information about the token's groups (LPVOID) ptg, // pointer to TOKEN_GROUPS buffer dwLength, // size of buffer &amp;dwLength // receives required buffer size ) || ptg-&gt;GroupCount != 1) { goto Cleanup; } // Found the logon SID; make a copy of it. dwLength = GetLengthSid(ptg-&gt;Groups[0].Sid); *ppsid = (PSID) HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, dwLength); if (*ppsid == NULL) goto Cleanup; if (!CopySid(dwLength, *ppsid, ptg-&gt;Groups[0].Sid)) { HeapFree(GetProcessHeap(), 0, (LPVOID)*ppsid); goto Cleanup; } bSuccess = TRUE; Cleanup: // Free the buffer for the token groups. if (ptg != NULL) HeapFree(GetProcessHeap(), 0, (LPVOID)ptg); return bSuccess; } BOOL CreateObjectSecurityDescriptor(PSID pLogonSid, PSECURITY_DESCRIPTOR* ppSD) { BOOL bSuccess = FALSE; DWORD dwRes; PSID pAllAppsSID = NULL; PACL pACL = NULL; PSECURITY_DESCRIPTOR pSD = NULL; EXPLICIT_ACCESS ea[2]; SID_IDENTIFIER_AUTHORITY ApplicationAuthority = SECURITY_APP_PACKAGE_AUTHORITY; // Create a well-known SID for the all appcontainers group. if(!AllocateAndInitializeSid(&amp;ApplicationAuthority, SECURITY_BUILTIN_APP_PACKAGE_RID_COUNT, SECURITY_APP_PACKAGE_BASE_RID, SECURITY_BUILTIN_PACKAGE_ANY_PACKAGE, 0, 0, 0, 0, 0, 0, &amp;pAllAppsSID)) { wprintf(L"AllocateAndInitializeSid Error %u\n", GetLastError()); goto Cleanup; } // Initialize an EXPLICIT_ACCESS structure for an ACE. // The ACE will allow LogonSid generic all access ZeroMemory(&amp;ea, 2 * sizeof(EXPLICIT_ACCESS)); ea[0].grfAccessPermissions = STANDARD_RIGHTS_ALL | MUTEX_ALL_ACCESS; ea[0].grfAccessMode = SET_ACCESS; ea[0].grfInheritance= NO_INHERITANCE; ea[0].Trustee.TrusteeForm = TRUSTEE_IS_SID; ea[0].Trustee.TrusteeType = TRUSTEE_IS_USER; ea[0].Trustee.ptstrName = (LPTSTR) pLogonSid; // Initialize an EXPLICIT_ACCESS structure for an ACE. // The ACE will allow the all appcontainers execute permission ea[1].grfAccessPermissions = STANDARD_RIGHTS_READ | STANDARD_RIGHTS_EXECUTE | SYNCHRONIZE | MUTEX_MODIFY_STATE; ea[1].grfAccessMode = SET_ACCESS; ea[1].grfInheritance= NO_INHERITANCE; ea[1].Trustee.TrusteeForm = TRUSTEE_IS_SID; ea[1].Trustee.TrusteeType = TRUSTEE_IS_GROUP; ea[1].Trustee.ptstrName = (LPTSTR) pAllAppsSID; // Create a new ACL that contains the new ACEs. dwRes = SetEntriesInAcl(2, ea, NULL, &amp;pACL); if (ERROR_SUCCESS != dwRes) { wprintf(L"SetEntriesInAcl Error %u\n", GetLastError()); goto Cleanup; } // Initialize a security descriptor. pSD = (PSECURITY_DESCRIPTOR) LocalAlloc(LPTR, SECURITY_DESCRIPTOR_MIN_LENGTH); if (NULL == pSD) { wprintf(L"LocalAlloc Error %u\n", GetLastError()); goto Cleanup; } if (!InitializeSecurityDescriptor(pSD, SECURITY_DESCRIPTOR_REVISION)) { wprintf(L"InitializeSecurityDescriptor Error %u\n", GetLastError()); goto Cleanup; } // Add the ACL to the security descriptor. if (!SetSecurityDescriptorDacl(pSD, TRUE, // bDaclPresent flag pACL, FALSE)) // not a default DACL { wprintf(L"SetSecurityDescriptorDacl Error %u\n", GetLastError()); goto Cleanup; } *ppSD = pSD; pSD = NULL; bSuccess = TRUE; Cleanup: if (pAllAppsSID) FreeSid(pAllAppsSID); if (pACL) LocalFree(pACL); if (pSD) LocalFree(pSD); return bSuccess; }   PSID pLogonSid = NULL; PSECURITY_DESCRIPTOR pSd = NULL; SECURITY_ATTRIBUTES SecurityAttributes; HANDLE hToken = NULL; HANDLE hMutex = NULL;   //Allowing LogonSid and all appcontainers. if (GetLogonSid(hToken, &amp;pLogonSid) &amp;&amp; CreateObjectSecurityDescriptor(pLogonSid, &amp;pSd) ) { SecurityAttributes.nLength = sizeof(SECURITY_ATTRIBUTES); SecurityAttributes.bInheritHandle = TRUE; SecurityAttributes.lpSecurityDescriptor = pSd; hMutex = CreateMutex( &amp;SecurityAttributes, // default security descriptor FALSE, // mutex not owned TEXT("NameOfMutexObject")); // object name } return 0; }</span></span></span></span></code> </pre> <br></div></div><br><br>  This is where a mutex is created, shared between this process and all AppContainers of the current user of the system.  A mutex created in this way can be quietly opened from the process of any Modern-application or desktop application running in AppContainer. <br><br><h4>  Couple of moments </h4><br><ul><li>  The code in MSDN is slightly incomplete (see - there are question marks there).  The token should not be NULL, it should be valid before first use.  You can, for example, take the current process token: <br><pre> <code class="cpp hljs"> OpenProcessToken(GetCurrentProcess(), TOKEN_READ, &amp;hToken);</code> </pre><br></li><li>  In order to create a shared pipe or a memory-mapped file, you need to slightly change the access rights.  You see, there is a couple of macros in the code with the text ‚ÄúMUTEX‚Äù - they do not make sense for other named objects.  If you do not want to bother, you can simply write instead. <pre> <code class="cpp hljs"> STANDARD_RIGHTS_ALL | SPECIFIC_RIGHTS_ALL</code> </pre>  - it is slightly redundant, but it will definitely work. <br><br></li><li>  Well, in general, of all AppContainers, access is good for a test code, but if you want to use it in this application, it‚Äôs better to limit yourself to your container. <br></li></ul><br><br>  Good luck in the development and less believe when you say "it can not be done in any way." </div><p>Source: <a href="https://habr.com/ru/post/186812/">https://habr.com/ru/post/186812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../186794/index.html">"Pioneers" of the moon race</a></li>
<li><a href="../186796/index.html">Extended ‚ÄúHello! World "on the Flask microform</a></li>
<li><a href="../186800/index.html">PHDays III CTF: An Inside Look (Part 2)</a></li>
<li><a href="../186804/index.html">Microsoft Smart Watch: Empire Strikes Back</a></li>
<li><a href="../186806/index.html">OpenMCAPI: simultaneous launch of Linux and RTOS on multi-core processors</a></li>
<li><a href="../186814/index.html">Elon Musk will soon present the project of a new system of passenger transport Hyperloop</a></li>
<li><a href="../186818/index.html">Migration of PROXMOX VE 3.0 to software RAID1</a></li>
<li><a href="../186820/index.html">Test the galaxy for strength</a></li>
<li><a href="../186822/index.html">Is Scalaxy dead yet?</a></li>
<li><a href="../186824/index.html">A Google employee is the first person Microsoft has paid for a found vulnerability in IE11</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>