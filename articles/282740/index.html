<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows performance analysis using OS features and PAL utility</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Article author - Mikhail Komarov, MVP - Cloud and Datacenter Management 
 This article will cover: 


- mechanism for working with performance counter...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows performance analysis using OS features and PAL utility</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  <i>Article author - Mikhail Komarov, MVP - Cloud and Datacenter Management</i> </blockquote><br>  This article will cover: <br><ul><li>  mechanism for working with performance counters; </li><li>  setting up data collectors using both the graphical interface and the command line; </li><li>  creating a black box to record data. </li></ul><br>  We will also consider and discuss working with the <i>PAL</i> utility and its application for data collection and analysis, including typical problems of localized systems. <a name="habracut"></a><br><br>  In general, the performance task can be presented in three parts: data collection, analysis of the obtained data and the creation of a black box for proactive monitoring of the problem system. <br><br><br><h1>  Data collection </h1><br>  Let's start with the well-known Performance Monitor.  This is a standard utility that is included in all modern editions of Windows.  It is called either from the menu, or from the command line or the search bar in Windows 8/10 by entering the perfmon command.  After launching the utility, we see a standard panel in which we can add and remove counters, change the presentation and scale the charts with data. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/b54/27d/499/b5427d4995e14a59af0a586e2f99f558.png"><br><br>  There are also data collectors that collect system performance data.  With certain skills and dexterity, the operations of adding counters and setting up data collection parameters can be performed from the graphical interface.  But when the task of setting up data collection from multiple servers arises, it is wiser to use command line utilities.  Here we will deal with these utilities. <br><br>  The first utility is <i>Typeperf</i> , which can output data from performance counters to the screen or to a file, and also allows you to get a list of counters installed in the system.  Examples of using. <br><br>  Displays the CPU load at 1 second intervals: <br><br><pre><code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">typeperf</span></span> <span class="hljs-string"><span class="hljs-string">"\Processor(_Total)\% Processor Time"</span></span></code> </pre> <br><br><img src="https://habrastorage.org/files/467/613/263/4676132634be489e8f5d2533ecf663cd.png"><br><br>  Displays the names of the performance counters associated with the PhysicalDisk object to the file: <br><br><pre> <code class="hljs perl">typeperf -<span class="hljs-keyword"><span class="hljs-keyword">qx</span></span> PhysicalDisk -o counters.txt</code> </pre> <br><br>  In our case, we can use the <i>Typeperf</i> utility to create a file with the counters we need, which we will later use as a template for importing counters into <b>a data collector</b> . <br><br>  The next utility is <i>Logman</i> .  This utility allows you to create, modify and manage various data collectors.  We will create a data collector for performance counters.  Here, for example, is a brief help on the <i>Logman command</i> , which relates to performance counters and data collector management. <br><br><img src="https://habrastorage.org/files/330/6f4/ac9/3306f4ac98be4d1dafc71ccafaa5c222.png"><br><img src="https://habrastorage.org/files/02b/e03/abe/02be03abea2f443993d3d01ea676fb9b.png"><br><br>  Let us examine a few examples that we need in the future. <br><br>  Create a data collector named <b>DataCollector_test</b> by importing performance counters from the <b>test.xml</b> file: <br><pre> <code class="hljs pgsql">logman <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> DataCollector_test -<span class="hljs-type"><span class="hljs-type">xml</span></span> C:\PerfTest\test.xml</code> </pre> <br><br>  Creating a file for collecting performance data with the circular mode enabled and the specified size: <br><br><pre> <code class="hljs sql">logman <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> DataCollector_test -f bincirc -<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> <span class="hljs-number"><span class="hljs-number">600</span></span></code> </pre> <br><br>  Changing the path to the default performance file: <br><br><pre> <code class="hljs tex">logman update DataCollector_test -o C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PerfTest</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Test</span></span></span></span>_log.blg</code> </pre> <br><br>  Starting <b>DataCollector_test</b> data <b>collector</b> : <br><br><pre> <code class="hljs pgsql">logman <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> DataCollector_test</code> </pre> <br><br>  Stop the <b>DataCollector_test</b> data <b>collector</b> : <br><br><pre> <code class="hljs sql">logman <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> DataCollector_test</code> </pre> <br><br>  Note that all these actions can be performed with a remote computer. <br><br>  Consider another utility - <i>Relog</i> , which allows you to manipulate the data file after the data collector.  Here is its description: <br><br><img src="https://habrastorage.org/files/440/e74/e64/440e74e64c844330894f0f2490506d5e.png"><br><br>  Below are a few scenarios for using this utility. <br><br>  Extracting performance counter data from the <b>logfile.blg</b> file <b>using the</b> counters <b>list.txt</b> filter with a list of <b>counters</b> and writing the result to a binary format: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">relog</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logfile</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.blg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-cf</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">counters</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.txt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-f</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">bin</span></span></code> </pre> <br><br>  Extract a list of performance counters from <b>logfile.blg</b> to a text file <b>counters.txt</b> : <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">relog</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">logfile</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.blg</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-q</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">counters</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.txt</span></span></code> </pre> <br><br>  We will not work directly with this utility, but information about it will help in the future if there are any problems in the PowerShell file that the <i>PAL</i> utility generates. <br><br>  We note one more thing: some analysis systems require data with the names of performance counters in English.  If the interface of our system is in Russian, then we need to do the following manipulations: get a local user, give him the right to collect data (usually give local administrator rights), log in to the system under it and change the interface language in the system properties. <br><br><img src="https://habrastorage.org/files/749/7c5/392/7497c539299a4439a6bec4ab883397d3.png"><br><br>  Be sure to log out and log in a second time under this user to initialize the English interface and log out.  Then specify in the data collector that data will be collected on behalf of this user. <br><br><img src="https://habrastorage.org/files/aff/3b5/4f9/aff3b54f92594160a9fae1b13c13e5c1.png"><br><br>  After that, the names of the counters and files will be in English. <br><br>  We also note the possibility of collecting data for SQL Server using the utility from the product.  This is <i>SQLDIAG</i> , which handles Windows performance logs, Windows event logs, SQL Server Profiler traces, SQL Server lock information, and SQL Server configuration information.  <i>You</i> can <i>specify</i> which types of information you need to collect using the <i>SQLdiag</i> program in the <b>SQLDiag.xml</b> configuration file. <br><br><img src="https://habrastorage.org/files/2fa/129/fb0/2fa129fb073747dd80c91cd1afe80ca0.png"><br><br>  You can use the <i>PSSDIAG</i> tool with codeplex.com to configure the <b>SQLDiag.xml</b> file. <br><br><img src="https://habrastorage.org/files/a35/5e1/5cd/a355e15cd3dc42bba03ac19e23e258ef.png"><br><br>  Here is the window of this tool. <br><br><img src="https://habrastorage.org/files/852/e60/d5c/852e60d5c3f347e79cd00db23f974304.png"><br><br>  In summary, the data collection process for SQL may look like this.  With the help of <i>PSSDIAG,</i> we generate an xml file.  Then we send this file to the client, which launches <i>SQLDIAG</i> with our xml file on a remote server and sends us for analysis the result of the work as a blg file, which we will analyze in the next section. <br><br><br><h1>  Data Analysis with PAL </h1><br>  This utility is written by Clint Huffman, who is a Microsoft PFE engineer and is engaged in analyzing system performance.  He is also one of the authors of the authorized Vital Sign course, which is readable at Microsoft and is available for corporate customers, including in Russia in Russian.  The utility is distributed freely; I will provide a link to it below. <br><br>  This is what the utility startup window looks like. <br><br><img src="https://habrastorage.org/files/402/501/87b/40250187bfce4485bf040ece8e74f563.png"><br><br>  The <i>Counter Log tab</i> specifies the path to the data file with performance counters collected earlier.  We can also set the interval for which the analysis will be performed. <br><br><img src="https://habrastorage.org/files/1db/907/652/1db907652316444aa3a739512c605e2e.png"><br><br>  The <i>Threshold File</i> tab contains a list of templates that can be exported to xml format and used as a list of counters for the data collector.  Check out the large selection of templates for performance analysis for various systems.  An example of loading from the command line was shown above.  The most valuable thing is that in these previously prepared templates, the boundary values ‚Äã‚Äãfor these parameters are set, which will be used later for analyzing the collected data !!! <br><br><img src="https://habrastorage.org/files/f67/df0/1dc/f67df01dccc442b0accf44c59f3cacd2.png"><br><img src="https://habrastorage.org/files/d8f/ccb/16d/d8fccb16d5374976a25512dc527e5cc8.png"><br><br>  So, for example, look at the boundary values ‚Äã‚Äãfor disk performance counters: <br><br><img src="https://habrastorage.org/files/020/c13/118/020c131185f444a1913a684868bce231.png"><br><br>  We can create our own templates using the necessary counters that will be tailored to the needs of our organization. <br><br>  We act according to the following algorithm: on the workstation, we launch the <i>PAL</i> utility, go to the <i>Threshold File</i> tab and export the template as an xml file.  Based on this file on the server, we create a data collector and start the assembly of information. <br>  After collecting the data, copy the resulting file to the workstation so that the analysis does not load the server, return to the <i>Counter Log tab</i> , specify the path to the file.  Go back to the <i>Threshold File</i> and select the same template that was exported for the data collector. <br><br>  Switch to the <i>Question</i> tab and specify the amount of RAM on the server on which the data was collected.  In the case of a 32-bit system, fill in <i>UserVa</i> . <br><br><img src="https://habrastorage.org/files/364/16c/02a/36416c02a5f645ab9e69a2a9e7689a8d.png"><br><br>  Go to the <i>Output Options</i> tab, on which we set the split interval for analysis.  The default <b>AUTO</b> divides the interval into 30 equal parts. <br><br><img src="https://habrastorage.org/files/d89/495/fc8/d89495fc8edb411fb5de03b9595b80b7.png"><br><br>  The <i>File Output</i> tab looks pretty ordinary, we point out the path to the final report files in HTML or XML format. <br><br><img src="https://habrastorage.org/files/f50/b5f/cec/f50b5fcec7144fcfad0e1cfc9eb47e75.png"><br><br>  The <i>Queue</i> tab shows the final script on PowerShell.  In general, we can say that the utility collects the parameters that it substitutes in the <b>PAL.PS1</b> script. <br><br><img src="https://habrastorage.org/files/600/27e/415/60027e4150bd407db0d9ee5872f61a89.png"><br><br>  The final tab sets the performance options.  You can simultaneously run multiple scripts and specify the number of threads on the processor.  I would like to emphasize that processing blg is not done by the utility, but by the PowerShell script, and this opens up possibilities for fully automating the analysis of logs.  For example, the data collector is restarted every day, as a result, the current blg file is released and a new one is created.  The old file is copied to a special server where the script that will process this file will be launched.  After that, the finished HTML or XML file with the results is moved to a specific directory or sent to the mailbox. <br><br><img src="https://habrastorage.org/files/04e/157/9e8/04e1579e84aa4f8a89d31aba2ec1ea43.png"><br><br>  Please note that the utility should work only in English localization.  Otherwise, we get an error message. <br><br><img src="https://habrastorage.org/files/5d4/99b/684/5d499b684e4d44759ff9d705492fbb8d.png"><br><br>  Also, the data file should be with the names of the counters in English.  I have indicated above how to do this.  After clicking <b>Finish,</b> the PowerShell script will run, the time of which depends on the amount of data and the speed of the workstation. <br><br>  The result of the utility will be a report in the selected format, in which there are graphs and numerical data that allow you to understand what happened in the system for a given period, taking into account the boundary values ‚Äã‚Äãof the alerts in the template on the <i>Threshold File</i> tab.  In general, analyzing an HTML file will at the initial stage identify problem areas in the system and understand where to go next, both in terms of more precise monitoring and in terms of upgrading or reconfiguring the system.  The Clint Huffman blog has a script that can be used to convert a template file with boundary conditions into a more understandable format. <br><br><img src="https://habrastorage.org/files/af6/7ca/eaa/af67caeaa97e49179869dd620055180a.png"><br><br><img src="https://habrastorage.org/files/519/a31/1a0/519a311a0e094cd190b60248b8fd6d99.png"><br><br><br><h1>  Black box </h1><br>  Sometimes there is a need for preventive monitoring of the problem system.  To do this, we will create a ‚Äúblack box‚Äù in which we will write performance data.  Let's return to the scripts described earlier. <br><br>  Create a data collector named <b>BlackBox</b> by importing performance counters from the <b>SystemOverview.xml</b> file that you <b>downloaded</b> from the <i>PAL</i> utility or created yourself: <br><br><pre> <code class="hljs pgsql">logman <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> BlackBox -<span class="hljs-type"><span class="hljs-type">xml</span></span> C:\ BlackBox\SystemOverview.xml</code> </pre> <br><br>  Creating a file for collecting performance data with the circular mode enabled and the specified size of 600 MB (about 2 days with a standard set of counters): <br><br><pre> <code class="hljs sql">logman <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> BlackBox -f bincirc -<span class="hljs-keyword"><span class="hljs-keyword">max</span></span> <span class="hljs-number"><span class="hljs-number">600</span></span></code> </pre> <br><br>  Changing the path to the default performance file: <br><br><pre> <code class="hljs tex">logman update BlackBox -o C:<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>BlackBox <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>BlackBox _log.blg</code> </pre> <br><br>  Launch BlackBox Data Collector: <br><br><pre> <code class="hljs pgsql">logman <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> BlackBox</code> </pre> <br><br>  This script creates a task to restart the data collector in case of a system restart: <br><br><pre> <code class="hljs pgsql">schtasks /<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> /tn pal /sc onstart /tr "logman start BlackBox " /ru <span class="hljs-keyword"><span class="hljs-keyword">system</span></span></code> </pre> <br><br>  Just in case, we will correct the properties of the data manager in order not to fill the disk space, since after restarting the data collector, a new file is created with a limit of 600 MB. <br><br><img src="https://habrastorage.org/files/99c/571/e6a/99c571e6a8184137956d4e9ca61b70b7.png"><br><br>  Note that you can copy the data file only when the data collector is stopped.  You can stop the latter using a script or using a graphical interface. <br><br>  Stop BlackBox data collector: <br><br><pre> <code class="hljs sql">logman <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> BlackBox</code> </pre> <br><br>  This concludes the part devoted to the collection and primary performance analysis. <br><br><br><h1>  Resources </h1><br>  Performance monitor <br>  <a href="https://technet.microsoft.com/en-us/library/cc749154.aspx">https://technet.microsoft.com/en-us/library/cc749154.aspx</a> <a href="https://technet.microsoft.com/en-us/library/cc749154.aspx"><br></a> <br>  PAL utility <br>  <a href="https://pal.codeplex.com/">https://pal.codeplex.com/</a> <a href="https://pal.codeplex.com/"><br></a> <br>  Clint Huffman Blog <br>  <a href="http://blogs.technet.com/b/clinth/">http://blogs.technet.com/b/clinth/</a> <a href="http://blogs.technet.com/b/clinth/"><br></a> <br>  Book clint huffman <br>  Windows Performance Analysis Field Guide <br>  <a href="http://www.amazon.com/dp/0124167012/ref%3Dwl...%3DI2TOVTYHI6HDHC">http://www.amazon.com/dp/0124167012/ref=wl...=I2TOVTYHI6HDHC</a> </div><p>Source: <a href="https://habr.com/ru/post/282740/">https://habr.com/ru/post/282740/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282728/index.html">Disconnection of analog satellite TV: 4 years later (part 1)</a></li>
<li><a href="../282732/index.html">My Location Companion - Photo messages and magnetic field control</a></li>
<li><a href="../282734/index.html">OpenStack: How not to ‚Äútread on the rake‚Äù of OpenSource business</a></li>
<li><a href="../282736/index.html">Development in own juice or as we understood that we are not doing what users need</a></li>
<li><a href="../282738/index.html">We present data and code in order: optimization and memory, part 1</a></li>
<li><a href="../282742/index.html">Hotel business: an easy target for hackers with attractive profits</a></li>
<li><a href="../282744/index.html">Microsoft improves Windows 10 kernel security mechanisms</a></li>
<li><a href="../282750/index.html">Analysis of English text with a cup of coffee "JavaSE8"</a></li>
<li><a href="../282752/index.html">Chewing Algorithm for Touchscreen</a></li>
<li><a href="../282756/index.html">Code examples for the Internet of things: smart sprinkler</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>