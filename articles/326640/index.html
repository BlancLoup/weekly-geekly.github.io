<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to cram your sensor in Android OS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once, programmers sat and wrote another temperature sensor and programs with buttons. And suddenly it turned out that this sensor wants one small phon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to cram your sensor in Android OS</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/5cc/51f/5c5/5cc51f5c5f144d08bd8e7d5afb2254f6.png"></div><br>  Once, programmers sat and wrote another temperature sensor and programs with buttons.  And suddenly it turned out that this sensor wants one small phone manufacturer in a future model.  Thus, the task was formed to support the I2C / GPIO sensor at the Android OS level, since the sensor promises to be an integral part of the phone itself. <br><br>  Being a deep subcontract, there was no hope for a quick and regular response from the final customer, we decided to practice on cats and shove our piece of iron into some affordable Android device. <br><a name="habracut"></a><br>  The task did not look very difficult and meant finding a tablet, a scheme for it, soldering where necessary, without breaking anything, and writing some code that would have a beneficial effect on the presence of our sensor in the final operating system. <br><br>  We look in order that there is: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Introduction </li><li>  How to connect to a real device like a tablet </li><li>  How to get to the debug UART in the audio output and find that it does not work </li><li>  How to write a simple kernel driver with I2C, GPIO, interrupts and background tasks </li><li>  How to make an abstraction of your piece of iron in Android middleware or use an existing one </li><li>  How to add your system service and where to add it so that it turns on and is found </li><li>  How to break through SEAndroid / SELinux by adding your own rules </li><li>  How to check - we will write simple </li><li>  How to collect all this </li><li>  How to understand that in the previous paragraphs something is wrong </li></ol><br>  <b>Introduction</b> <br><br>  The matter, as usual, developed in such a way that it was necessary to prove the consistency and feasibility of the task as early as possible, therefore several parts of the work were formed, not all of which will be described, but I will give them for the integrity of the impression. <br><br>  In search of a tablet, the choice was on the Nexus 7 for a number of reasons: he was with a friend and was not needed because he was beaten up by a moth enough (the mole broke the touch screen and had to use the mouse), but it‚Äôs still Nexus, which means there was more information and source on Google sites.  Since it was scary to start working on the tablet right away, the Raspberry Pi3 was the first to get into the mix.  Most of the debugging occurred on it.  Further, the story will not commemorate the Raspberry Pi 3, but you can keep in mind that most of the software problems were solved on it. <br><br>  <b>How to connect to a real device like a tablet</b> <br><br>  Connecting to such a sophisticated device as a tablet without a scheme is <s>dementia and bravery is</s> a thankless task.  Therefore, at first there was a scheme.  Generally speaking, electrical circuits of modern phones and tablets are not the most open thing, but if you try and not be afraid of the abundance of Chinese in the browser window, you can find something.  We found it pretty quickly around <a href="http://wenku.baidu.com/view/7c59c71ac281e53a5802ff15.html">here</a> .  Further sketches using circuitry are clippings from this schematic document. <br><br>  In theory, the tablet should have quite a lot of I2C tires and orders of magnitude more than any GPIO, you just need to find the right ones, solder and be drawn to the right level.  Fortunately, in the Nexus 7 tablets there is no rear camera, which just uses the I2C for control and two pins (power and reset).  And we need I2C and 2 GPIO (one for on / off hibernation, and the second for interrupting at the expense of a new temperature measurement). <br><br>  The correlation of real viscera and the scheme showed that everything is not as simple as in the name of the tablet.  Namely, There are at least three versions of the Nexus 7: <br><br><ol><li>  The 2013 version does not fit the scheme we found, because it has other processors and a bunch of different small details </li><li>  Version 2012 .1 has a decoupled seat for the rear camera and everything in it is good </li><li>  The 2012 version .2 has no decoupled space and it is much more difficult to solder there. </li></ol><br>  We had a tablet in 2012, where there was no ready-made connector, and in addition a broken touch and a mouse in the kit, which sometimes delivered a lot.  In the end, after some dancing with a tambourine around the bush, it was decided to buy another one with the same soldered connector.  New Nexus 7 is long gone, so we searched on the "bazaars", which allowed us to look under the cover and select the desired one with a wired space under the camera. <br><br>  We found the number of the correct I2C bus by a simple search using a simple program using NDK.  To do this, I had to install Android and chmod with witchcraft through adb to release all I2C tires.  In the process of busting, I had to play a little with the addresses on the bus, since some of them were already reserved and we received an attempt to communicate.  In the end, it turned out that there was no one else on the target bus. <br><br><div class="spoiler">  <b class="spoiler_title">Lyric</b> <div class="spoiler_text">  An interesting detail was the fact that not all versions of Android can be equally useful after rutting: in our case, the latest official version was Android 5.1.1.  After its installation and rutting, everything seemed to be without problems, only our program still had no access to the / dev folder.  Forcible change of access rights using adb shell and chmod did not give effect.  After some deliberation, we decided to roll back to Android 4.4.4.  Repeating the same rutting process immediately gave the program access to / dev.  It can also be noted that in adb shell the / dev folder on version 4.4.4 was readable without going to super user, while Android 5.1.1 does not.  Most likely, the reason lies in fairly large changes in OS security when moving from Android 4 to Android 5 and beyond (perhaps this is the third point of the <a href="https://source.android.com/security/enhancements/enhancements50.html">link</a> ). </div></div><br>  And what about GPIO? <br><br>  On the very first page of our scheme in the general overview, it is clear that there is a camera called ‚ÄúRear Camera module OV5650‚Äù. <br><br><img src="https://habrastorage.org/files/7e0/b83/b60/7e0b83b60c024da3a5b8e1019427ac28.png"><br><br>  It is also written there that it is directly connected to the tegra T30L (i.e., the main SoC).  Nearby there are lines I2C_CAM_ ... Let's look ... <br><br><img src="https://habrastorage.org/files/f97/e74/5ea/f97e745ea4f24c83b409efefefe0a76b.png"><br><br>  On page 9 is what we need.  Almost the entire page is devoted to the front and rear cameras.  There is also a mention that the camera has two pins CAM_RST_5M and PWDN_5M, which go to the SoC for GPIO_PBB0 and GPIO_PBB5, respectively.  It seems - this is what we need.  Just find how to solder there, so we continue to look ... <br><br><img src="https://habrastorage.org/files/92d/d1d/ef2/92dd1def24ad4a0b9189150c455cd483.png"><br><br>  Well that's all.  On this page, the description of the FFC connector, where the camera is turned on, including the required pins.  On our original tablet connector is not soldered.  But later we will find another tablet with a connector, so as not to suffer. <br><br>  Further, the track of the found pins will be resumed already in the platform code and it is written about this in the part about the driver ... <br><br>  <b>How to get to the debug UART in the audio output and find that it does not work</b> <br><br>  When you write drivers and any low-level software under Linux (highly), it is desirable to see the kernel / system boot log, since our driver is also loaded there.  And as soon as something goes wrong, everything stops and why it is not known. <br><br>  Therefore, having smoked the Internet, we found out that the Nexus devices have a debugging UART output via the audio connector.  And it works of the type itself without any program settings in the following way: <br><br><ul><li>  A comparator is installed in the audio jack on the MIC channel, which responds to a level greater than 3V. </li><li>  In normal mode, the voltage on the MIC is 1.8V-2.9V. </li><li>  As soon as the level is exceeded, the state is transmitted to the pin, which by interruption tells the core that the audio connector now steers the debug. </li><li>  After that, the left and right channels become RX and TX, respectively, although they remain at the level of 1.8V - you will need a converter. </li></ul><br><img src="https://habrastorage.org/files/ae2/6fb/6e9/ae26fb6e960e47a38db4a6bf634f0348.png"><br><img src="https://habrastorage.org/files/a92/5ac/66b/a925ac66b4a74b1487eaac7ac7d4f6c7.png"><br><br>  To celebrate, a USB-UART -&gt; Audio adapter was made.  We stuck it, turned it on in the Ubuntu minicom console, loaded the tablet and ... nothing.  At all.  That is, quite.  Further field searches showed only that one way or another, debug uart did not turn on, since the lines of the left and right channels did not reach the zero voltage level of RX / TX.  Also tried a lot of commands from fastboot, but nothing helped.  The only thing that calmed us at the end of this venture was only the information that <a href="http://www.abclinuxu.cz/blog/Lorris/2013/12/serial-console-on-google-nexus-5">another person</a> tried different Nexus `s, and on everyone except the exact same UART tablet it started, but on ours - not.  But it was interesting. <br><br>  An even more fundamental way was to connect the debug interface of the processor, but they didn‚Äôt go in this direction, although the layout of the device showed such a possibility. <br><br>  As a result, our salvation was the preliminary use of the Raspberry Pi for the Android receptacle.  There, the debug port worked, it allowed to catch all the errors, and then on Nexus it was clear what to change if the kernel does not boot.  Statistics showed that the most time delay was due to the unsoldered pins of the GPIO, as well as the undocumented tegra3 features in terms of permission to work with the GPIO. <br><br>  By the way, for debugging it is interesting to see the full log of the download, you can get it using adb bugreport. <br><br>  <b>How to write a simple kernel driver with I2C, GPIO, interrupts and background tasks</b> <br><br>  So, it was necessary to write the kernel driver, which will drive the device through I2C and GPIO, and also light up in the / dev folder with some original name, so that later the Android middleware can access this file / driver and read or write something. <br><br>  Some common features when writing a driver: <br><br><ul><li>  Drivers are loaded into the kernel by a chain ‚Äî top-level devices (platform, buses) load other devices (specific devices and algorithms for working with them). </li><li>  The chain and boot order are determined by the device tree or C by the boot code, if the device tree is disabled when building the kernel or is not supported due to the old kernel version.  Our case with tegra3 is the second. </li><li>  In order to pick up the client's i2c structure, through which I2C communication will work, you need to write the probe function, which will be called if the device is described as described in the platform bootstrap code and the list of registered drivers, which we will add using i2c_add_driver. </li></ul><br>  But first about the prerequisites for loading the driver.  those.  about platform initialization code. <br><br>  Nexus 7 2012 is built on a Tegra3 processor.  The kernel used on it is not new (3.1.h.h) and without device tree.  And this means that all the hardware is described by the C code and is located in / kernel / tegra / arch / arm / mach-tegra / <br><br>  The board-grouper-pinmux.c file describes the iron configurations of all SoC pins, and also contains general functions for their initialization in the closed part of the kernel from nVidia (all functions beginning with the word "tegra" are implemented in the closed part of the kernel, which is supplied in binary form ).  Let's see what we need to change there. <br><br><div class="spoiler">  <b class="spoiler_title">board-grouper-pinmux.c</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ... //      //   ,         , //    ,       /* We are disabling this code for now. */ #define GPIO_INIT_PIN_MODE(_gpio, _is_input, _value) \ { \ .gpio_nr = _gpio, \ .is_input = _is_input, \ .value = _value, \ } static struct gpio_init_pin_info init_gpio_mode_grouper_common[] = { GPIO_INIT_PIN_MODE(TEGRA_GPIO_PDD7, false, 0), GPIO_INIT_PIN_MODE(TEGRA_GPIO_PCC6, false, 0), GPIO_INIT_PIN_MODE(TEGRA_GPIO_PR0, false, 0), //    .   -     :) GPIO_INIT_PIN_MODE(TEGRA_GPIO_PBB0, true, 0), GPIO_INIT_PIN_MODE(TEGRA_GPIO_PBB5, false, 0), }; // static __initdata struct tegra_pingroup_config grouper_pinmux_common[] = { // ... /*         ,      GPIO_PBB0  GPIO_PBB5. O ,    ,  .     */ /* CAMERA */ DEFAULT_PINMUX(CAM_MCLK, VI_ALT2, PULL_DOWN, NORMAL, INPUT), DEFAULT_PINMUX(GPIO_PCC1, RSVD1, NORMAL, NORMAL, INPUT), //  //DEFAULT_PINMUX(GPIO_PBB0, RSVD1, NORMAL, NORMAL, INPUT), // :         ,     nIRQ DEFAULT_PINMUX(GPIO_PBB0, RSVD1, PULL_UP, NORMAL, INPUT), DEFAULT_PINMUX(GPIO_PBB3, VGP3, NORMAL, NORMAL, INPUT), //DEFAULT_PINMUX(GPIO_PBB5, VGP5, NORMAL, NORMAL, INPUT), //  // :          ,       DEFAULT_PINMUX(GPIO_PBB5, VGP5, PULL_DOWN, NORMAL, OUTPUT), // ... }; // ... //         //  ,       static void __init grouper_gpio_init_configure(void) { int len; int i; struct gpio_init_pin_info *pins_info; u32 project_info = grouper_get_project_id(); if (project_info == GROUPER_PROJECT_NAKASI_3G) { len = ARRAY_SIZE(init_gpio_mode_grouper3g); pins_info = init_gpio_mode_grouper3g; } else { //    -     3g,      3G  len = ARRAY_SIZE(init_gpio_mode_grouper_common); pins_info = init_gpio_mode_grouper_common; } for (i = 0; i &lt; len; ++i) { tegra_gpio_init_configure(pins_info-&gt;gpio_nr, pins_info-&gt;is_input, pins_info-&gt;value); pins_info++; } } //      ,   pinmux`     //  nVidia int __init grouper_pinmux_init(void) { struct board_info board_info; u32 project_info = grouper_get_project_id(); tegra_get_board_info(&amp;board_info); BUG_ON(board_info.board_id != BOARD_E1565); grouper_gpio_init_configure(); //   tegra_pinmux_config_table(grouper_pinmux_common, ARRAY_SIZE(grouper_pinmux_common)); tegra_drive_pinmux_config_table(grouper_drive_pinmux, ARRAY_SIZE(grouper_drive_pinmux)); if (project_info == GROUPER_PROJECT_NAKASI_3G) { tegra_pinmux_config_table(pinmux_grouper3g, ARRAY_SIZE(pinmux_grouper3g)); } tegra_pinmux_config_table(unused_pins_lowpower, ARRAY_SIZE(unused_pins_lowpower)); grouper_pinmux_audio_init(); return 0; } // ...</span></span></code> </pre> <br></div></div><br>  The board-grouper-sensors.c file contains the registration of all sorts of different devices and the most general level of function for them (for example, power management).  Here we need to add a structure to register our device with a driver that will be loaded as part of the kernel.  Something like this: <br><br><div class="spoiler">  <b class="spoiler_title">board-grouper-sensors.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ... //           //      GPIO  nIRQ //  ,          //     ,  ,    //  ,    GPIO  PWRD static const struct i2c_board_info tricky_sensor_board_info[] = { { I2C_BOARD_INFO("tricky",0x55), .irq = TEGRA_GPIO_TO_IRQ(TEGRA_GPIO_PBB0) }, }; //     2  GPIO (,  ). //        ,  //           //   linux/gpio  static int grouper_tricky_init(void) { //          tegra_gpio_enable, //        int ret = 0; ret = gpio_request(TEGRA_GPIO_PBB5, "tricky_npwd"); if (ret &lt; 0) { pr_err("Tricky: Error: cannot register GPIO_PWR_DOWN\n"); } else { ret = gpio_direction_output(TEGRA_GPIO_PBB5, true); if (ret &lt; 0) { pr_err("Tricky: Error: cannot set GPIO_PWR_DOWN as output\n"); } else { tegra_gpio_enable(TEGRA_GPIO_PBB5); } } ret = gpio_request(TEGRA_GPIO_PBB0, "tricky_nirq"); if (ret &lt; 0) { pr_err("Tricky: Error: cannot register GPIO_NIRQ\n"); return ret; } ret = gpio_direction_input(TEGRA_GPIO_PBB0); if (ret &lt; 0) { gpio_free(TEGRA_GPIO_PBB0); pr_err("Tricky: Error: cannot set GPIO_NIRQ as input\n"); } else { tegra_gpio_enable(TEGRA_GPIO_PBB0); } printk("%s: Tricky OK", __FUNCTION__); return ret; } // ... //         , //          int __init grouper_sensors_init(void) { int err; grouper_camera_init(); #ifdef CONFIG_VIDEO_OV2710 i2c_register_board_info(2, grouper_i2c2_board_info, ARRAY_SIZE(grouper_i2c2_board_info)); #endif /* Front Camera mi1040 + */ pr_info("mi1040 i2c_register_board_info"); i2c_register_board_info(2, front_sensor_i2c2_board_info, ARRAY_SIZE(front_sensor_i2c2_board_info)); err = grouper_nct1008_init(); if (err) printk("[Error] Thermal: Configure GPIO_PCC2 as an irq fail!"); i2c_register_board_info(4, grouper_i2c4_nct1008_board_info, ARRAY_SIZE(grouper_i2c4_nct1008_board_info)); mpuirq_init(); i2c_register_board_info(2, cardhu_i2c1_board_info_al3010, ARRAY_SIZE(cardhu_i2c1_board_info_al3010)); if (GROUPER_PROJECT_BACH == grouper_get_project_id()) { i2c_register_board_info(2, cap1106_i2c1_board_info, ARRAY_SIZE(cap1106_i2c1_board_info)); } //     grouper_tricky_init(); i2c_register_board_info(2/*  I2C ,    */, tricky_sensor_board_info, ARRAY_SIZE(tricky_sensor_board_info)); return 0; } // TBD (  )</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Driver part code with comments</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;linux/init.h&gt; // Macros used to mark up functions eg __init __exit #include &lt;linux/module.h&gt; // Core header for loading LKMs into the kernel #include &lt;linux/device.h&gt; // Header to support the kernel Driver Model #include &lt;linux/kernel.h&gt; // Contains types, macros, functions for the kernel #include &lt;linux/fs.h&gt; // Header for the Linux file system support #include &lt;linux/i2c.h&gt; // main sensor communication protocol #include &lt;linux/gpio.h&gt; // sensor`s wake/sleep and new data interrupts are processed via two pins #include &lt;linux/interrupt.h&gt; // Support GPIO IRQ handler #include &lt;asm/uaccess.h&gt; // copy_to_user and copy_from_user functions #include &lt;asm/io.h&gt; // Access to memset() #include &lt;linux/workqueue.h&gt; // Make IRQ event into deferred handler task #include &lt;linux/mutex.h&gt; // Sync data buffer usage between IRQ-work and outer read requests #include &lt;linux/delay.h&gt; // Access to mdelay //       /dev/tricky_temperature #define DEVICE_NAME "tricky_temperature" //    #define CLASS_NAME "tricky" // ...    ... //   MODULE_LICENSE("GPL"); MODULE_AUTHOR("Pavel Akimov"); MODULE_DESCRIPTION("Test Linux driver for tricky sensor"); ///&lt;     modinfo MODULE_VERSION("0.1"); //      ,     static int majorNumber; static struct class* trickyClass = NULL; static struct device* trickyDevice = NULL; // ...        ... //      static u8 sensor_data_buffer[I2C_DATA_SIZE] = { 0 }; //    I2C      struct i2c_client *tricky_i2c_client = NULL; //     static int dev_open(struct inode *, struct file *); static ssize_t dev_read(struct file *, char *, size_t, loff_t *); static ssize_t dev_ioctl(struct file *file, unsigned int ioctl_num, unsigned long ioctl_param); //  I2C     static int tricky_i2c_probe(struct i2c_client *client, const struct i2c_device_id *id); static int tricky_i2c_remove(struct i2c_client *i2c_client); //     static int set_sensor_power(u8 enabled); //    I2C static int read_raw_temperatures(void); //       static irq_handler_t tricky_data_irq_handler(unsigned int irq, void *dev_id, struct pt_regs *regs); //         static void read_data_work_handler(struct work_struct *w); //          static struct workqueue_struct *wq = NULL; static DECLARE_DELAYED_WORK(read_data_work, read_data_work_handler); static struct mutex read_data_mutex; //    static struct file_operations fops = { .open = dev_open, .read = dev_read, .unlocked_ioctl = dev_ioctl }; //   static const struct i2c_device_id tricky_i2c_id[] = { { CLASS_NAME, 0 }, { }, //    ,        }; MODULE_DEVICE_TABLE(i2c, tricky_i2c_id); //  ,       static struct i2c_driver tricky_i2c_driver = { .driver = { .owner = THIS_MODULE, .name = CLASS_NAME, }, .id_table = tricky_i2c_id, .probe = tricky_i2c_probe, .remove = tricky_i2c_remove }; //   i2c       i2c ,       static int tricky_i2c_probe(struct i2c_client *client, const struct i2c_device_id *id) { tricky_i2c_client = client; return 0; } // static int tricky_i2c_remove(struct i2c_client *i2c_client) { if (tricky_i2c_client != NULL) { i2c_unregister_device(tricky_i2c_client); tricky_i2c_client = NULL; } return 0; } //       static int __init tricky_temperature_init(void) { int err; // Try to dynamically allocate a major number for the device -- more difficult but worth it majorNumber = register_chrdev(0, DEVICE_NAME, &amp;fops); if (majorNumber&lt;0){ pr_err(KERN_ALERT "Tricky failed to register a major number\n"); return majorNumber; } printk(KERN_INFO "Tricky: registered correctly with major number %d\n", majorNumber); // Register the device class trickyClass = class_create(THIS_MODULE, CLASS_NAME); if (IS_ERR(trickyClass)){ // Check for error and clean up if there is pr_err(KERN_ALERT "Failed to register device class\n"); err = PTR_ERR(trickyClass); // Correct way to return an error on a pointer goto err_char_dev; } printk(KERN_INFO "Tricky: device class registered correctly\n"); // Register the device driver trickyDevice = device_create(trickyClass, NULL, MKDEV(majorNumber, 0), NULL, DEVICE_NAME); if (IS_ERR(trickyDevice)){ // Clean up if there is an error pr_err(KERN_ALERT "Failed to create the device\n"); err = PTR_ERR(trickyDevice); goto err_class; } printk(KERN_INFO "Tricky: device class created correctly\n"); // Made it! device was initialized //   I2 ,        //   (,   board grouper sensors)   probe err = i2c_add_driver(&amp;tricky_i2c_driver); if (err &lt; 0) { pr_err("Tricky: Error: %s: driver registration failed, error=%d\n", __func__, err); goto err_dev; } //     I2C ... //   IRQ   callback`     // ,         err = request_irq( i2c_client-&gt;irq, (irq_handler_t)tricky_data_irq_handler, IRQF_TRIGGER_FALLING, "tricky_gpio_handler", NULL); // no shared interrupt lines if (err &lt; 0) { pr_err("Tricky: Error: %s: cannot register GPIO_NIRQ irq handler: Error=%d\n", __func__, err); goto err_drv; } //           IRQ wq = create_singlethread_workqueue("tricky_work"); mutex_init(&amp;read_data_mutex); printk(KERN_INFO "Tricky: initialization completed\n"); return 0; err_irq: destroy_workqueue(wq); free_irq(i2c_client-&gt;irq, NULL); err_drv: i2c_del_driver(&amp;tricky_i2c_driver); err_dev: device_destroy(trickyClass, MKDEV(majorNumber, 0)); // remove the device class_unregister(trickyClass); // unregister the device class err_class: class_destroy(trickyClass); // remove the device class err_char_dev: unregister_chrdev(majorNumber, DEVICE_NAME); // unregister the major number return err; } //    static void __exit tricky_temperature_exit(void) { if (delayed_work_pending(&amp;read_data_work) != 0) cancel_delayed_work_sync(&amp;read_data_work); destroy_workqueue(wq); free_irq(i2c_client-&gt;irq, NULL); i2c_del_driver(&amp;tricky_i2c_driver); if (tricky_i2c_client != NULL) { i2c_unregister_device(tricky_i2c_client); tricky_i2c_client = NULL; } device_destroy(trickyClass, MKDEV(majorNumber, 0)); class_unregister(trickyClass); class_destroy(trickyClass); unregister_chrdev(majorNumber, DEVICE_NAME); printk(KERN_INFO "Tricky: Goodbye\n"); } static int dev_open( struct inode *node, struct file *filep) { printk(KERN_INFO "Tricky: Open the LKM!\n"); return 0; } static ssize_t dev_read( struct file *filep, char *buffer, size_t len, loff_t *offset) { int ret; // ,   (HAL) ,      if (!buffer || len != I2C_DATA_SIZE) { return -EINVAL; } mutex_lock(&amp;read_data_mutex); ret = copy_to_user(buffer, sensor_data_buffer, I2C_DATA_SIZE); mutex_unlock(&amp;read_data_mutex); if (ret != 0) { return -ENOMEM; } return 0; } static ssize_t dev_ioctl( struct file *file, unsigned int ioctl_num, unsigned long ioctl_param) { switch (ioctl_num) { case IOCTL_POWER: ret = set_sensor_power(ioctl_param != CMD_POWER_WAKEUP ? 1 : 0); if (ret &lt; 0) { return ret; } break; case ... // more commands default: pr_err(KERN_INFO "Tricky: invalid command type to apply\n"); return -EINVAL; } return 0; } static int set_sensor_power(u8 enabled) { gpio_set_value(GPIO_PWR_DOWN, enabled != 0); return 0; } //   I2C   :   (2 ) //       static int read_raw_temperatures(void) { int ret; struct i2c_msg write_message; struct i2c_msg read_message; write_message.addr = I2C_SLAVE_ADDRESS; write_message.flags = 0; // plain write write_message.buf = (char*)i2c_read_temperatures_address; write_message.len = sizeof(i2c_read_temperatures_address); memset(sensor_data_buffer, 0, sizeof(sensor_data_buffer)); read_message.addr = I2C_SLAVE_ADDRESS; read_message.flags = I2C_M_RD; // plain read read_message.buf = (char*)sensor_data_buffer; read_message.len = sizeof(sensor_data_buffer); // read out data ret = i2c_transfer(tricky_i2c_client-&gt;adapter, &amp;write_message, 1); if (ret &lt; 0) { pr_err(KERN_INFO "Tricky: Cannot write data address. Error=%d\n", ret); return ret; } ret = i2c_transfer(tricky_i2c_client-&gt;adapter, &amp;read_message, 1); if (ret &lt; 0) { pr_err(KERN_INFO "Tricky: Cannot read data from the sensor. Error=%d\n", ret); return ret; } return 0; } //       -  //     ,   I2C    ,   // I2C       //    ,   ,    , //      static irq_handler_t tricky_data_irq_handler(unsigned int irq, void *dev_id, struct pt_regs *regs) { //  ,     if (delayed_work_pending(&amp;read_data_work) == 0) queue_delayed_work(wq, &amp;read_data_work, msecs_to_jiffies(1)); return (irq_handler_t)IRQ_HANDLED; } //       , //         //     (  , ) static void read_data_work_handler(struct work_struct *w) { int ret; mutex_lock(&amp;read_data_mutex); ret = read_raw_temperatures(); mutex_unlock(&amp;read_data_mutex); if (ret &lt; 0) { printk(KERN_INFO "Tricky: read_data_work_handler. Ret = %d\n", ret); } } //   ,        module_init(tricky_temperature_init); module_exit(tricky_temperature_exit);</span></span></span></span></code> </pre><br></div></div><br>  Separately, it is necessary to mention the files for the assembly: KConfig and Makefile. <br><br>  In KConfig, we add the following paragraph, which by the name TRICKY_SENSOR (without the CONFIG_ prefix) created in the Makefile, will take it into account when building.  Also, our driver will be visible when using make menuconfig. <br><br><div class="spoiler">  <b class="spoiler_title">Kconfig</b> <div class="spoiler_text"><pre> <code class="hljs vhdl">menuconfig THERMAL tristate <span class="hljs-string"><span class="hljs-string">"Generic Thermal sysfs driver"</span></span> help <span class="hljs-keyword"><span class="hljs-keyword">Generic</span></span> Thermal Sysfs driver offers a <span class="hljs-keyword"><span class="hljs-keyword">generic</span></span> mechanism <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> thermal management. Usually it<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> made up <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> one <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> more thermal zone <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> cooling device. Each thermal zone contains its own temperature, trip points, cooling devices. <span class="hljs-keyword"><span class="hljs-keyword">All</span></span> platforms <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> ACPI thermal support can <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> this driver. <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> you want this support, you should say Y <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> M here. config THERMAL_HWMON bool depends <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> THERMAL depends <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> HWMON=y || HWMON=THERMAL <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> y config TRICKY_SENSOR <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> y bool prompt <span class="hljs-string"><span class="hljs-string">"Tricky temperature sensor support"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Makefile</b> <div class="spoiler_text"><pre> <code class="hljs mel">obj-$(CONFIG_THERMAL) += thermal_sys.o obj-$(CONFIG_TRICKY_SENSOR) += tricky_temperature.o</code> </pre><br></div></div><br>  As a result, we get the following files for the kernel: <br><br><pre> <code class="hljs swift">kernel/tegra/arch/arm/mach-tegra/board-grouper-pinmux.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> kernel/tegra/arch/arm/mach-tegra/board-grouper-sensors.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> kernel/tegra/drivers/thermal/tricky_sensor.<span class="hljs-built_in"><span class="hljs-built_in">c</span></span> kernel/tegra/drivers/thermal/<span class="hljs-type"><span class="hljs-type">KConfig</span></span> kernel/tegra/drivers/thermal/<span class="hljs-type"><span class="hljs-type">Makefile</span></span></code> </pre><br>  <b>How to make an abstraction of your piece of iron in Android middleware or use an existing one</b> <br><br>  Now move to a higher level.  The driver is written and now we are moving to the user space part of Android, where you need to somehow attach to the driver. <br><br>  In order to work with many implementations of the same type of peripherals in Android, there is a middleware layer (written in C / C ++) that contains various interfaces of iron abstractions (Hardware Abstraction Level - HAL).  And for all temperature magnetic, etc.  sensors there is a place.  But the limitation of this HAL is that its API implies only reading - which is reasonable in view of the many user programs that can simultaneously access these devices.  And if one changes the settings for themselves, then for the other it will be a setup.  All this is very well described <a href="https://source.android.com/devices/sensors/sensor-stack.html">here</a> . <br><br>  And specifically regarding the read-only mode of working with sensors, this quote from the link above: <br><br><blockquote>  It doesn‚Äôt have sampling frequency parameters.  For example, you can imagine the physical sensor and the low power modes.  It can only be used for an Android device;  there would be no  This is not an option. <br><br>  There is no mechanism for data transmission.  This can not be achieved. </blockquote><br>  Well, we really want to control our device (power switch and measurement mode, for example) and since our sensor is not officially documented and only our program will work with it, we will write our HAL.  Here the basic things are written in accessible English, so that it will be clear later what the data structures are and why. <br><br>  Let's create the module of piece of iron.  To do this, you need to come up with an ID and make it a structure containing hw_device_t with the description of the module, and our derived functions.  Google does not specify how exactly the implementation and interfaces should look at this level, so without looking at the big brother, you can begin to sow good. <br><br><div class="spoiler">  <b class="spoiler_title">sensor_tricky_temperature.h</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifndef</span></span></span><span class="hljs-meta"> ANDROID_TRICKY_INTERFACE_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> ANDROID_TRICKY_INTERFACE_H #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;stdint.h&gt; #include &lt;sys/cdefs.h&gt; #include &lt;sys/types.h&gt; #include &lt;hardware/hardware.h&gt; __BEGIN_DECLS #define TRICKY_HARDWARE_MODULE_ID "tricky" struct tricky_device_t { struct hw_device_t common; int (*read_sample)(unsigned short *psynchro, short *pobj_temp, short *pntc1_temp, short *pntc2_temp, short *pntc3_temp); int (*activate)(unsigned char enabled); int (*set_mode)(unsigned char is_continuous); }; __END_DECLS #endif // ANDROID_TRICKY_INTERFACE_H</span></span></span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">sensor_tricky_temperature.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;errno.h&gt; #include &lt;cutils/log.h&gt; #include &lt;cutils/sockets.h&gt; #include &lt;sys/types.h&gt; #include &lt;sys/stat.h&gt; #include &lt;fcntl.h&gt; #include &lt;linux/i2c.h&gt; #include &lt;hardware/sensor_tricky_temperature.h&gt; #define LOG_TAG "TRICKY" #define DEVICE_NAME "/dev/tricky_temperature" #define TRICKY_MODE_0 0 #define TRICKY_MODE_1 1 int fd = 0; int read_sample(unsigned short *psynchro, short *pobj_temp, short *pntc1_temp, short *pntc2_temp, short *pntc3_temp) { int ret = 0; unsigned char buffer[10]; ALOGD("HAL -- read_sample() called"); ret = read(fd, (char*)buffer, sizeof(buffer)); if (ret &lt; 0) { ALOGE("HAL -- cannot read raw temperature data"); return -1; } if (psynchro) *psynchro = (unsigned short)(buffer[3] &lt;&lt; 8 | buffer[2]); if (pobj_temp) *pobj_temp = (short)(buffer[1] &lt;&lt; 8 | buffer[0]); if (pntc1_temp) *pntc1_temp = (short)(buffer[5] &lt;&lt; 8 | buffer[4]); if (pntc2_temp) *pntc2_temp = (short)(buffer[7] &lt;&lt; 8 | buffer[6]); if (pntc3_temp) *pntc3_temp = (short)(buffer[9] &lt;&lt; 8 | buffer[8]); ALOGD("HAL - sample read OK"); return 0; } int activate(unsigned char enabled) { int ret = 0; ALOGD("HAL - activate(%d) called", enabled); ret = ioctl(fd, 0, enabled ? TRICKY_MODE_0 : TRICKY_MODE_1); if (ret &lt; 0) { ALOGE("HAL - cannot write activation state"); return -1; } ALOGD("HAL - activation state written OK"); return 0; } int set_mode(unsigned char is_continuous) { int ret; ALOGD("HAL -- set_mode(%d) called", is_continuous); ret = ioctl(fd, 1, is_continuous ? TRICKY_MODE_0 : TRICKY_MODE_1); if (ret &lt; 0) { ALOGE("HAL - cannot write mode state"); return -1; } ALOGD("HAL - mode state written OK"); return 0; } static int open_tricky(const struct hw_module_t* module, char const* name, struct hw_device_t** device) { int ret = 0; struct tricky_device_t *dev = malloc(sizeof(struct tricky_device_t)); if (dev == NULL) { ALOGE("HAL - cannot allocate memory for the device"); return -ENOMEM; } else { memset(dev, 0, sizeof(*dev)); } ALOGD("HAL - openHAL() called"); dev-&gt;common.tag = HARDWARE_DEVICE_TAG; dev-&gt;common.version = 0; dev-&gt;common.module = (struct hw_module_t*)module; dev-&gt;read_sample = read_sample; dev-&gt;activate = activate; dev-&gt;set_mode = set_mode; *device = (struct hw_device_t*) dev; fd = open(DEVICE_NAME, O_RDWR); if (fd &lt;= 0) { ALOGE("HAL - cannot open device driver"); return -1; } ALOGD("HAL - has been initialized"); return 0; } static struct hw_module_methods_t tricky_module_methods = { .open = open_tricky }; struct hw_module_t HAL_MODULE_INFO_SYM = { .tag = HARDWARE_MODULE_TAG, .version_major = 1, .version_minor = 0, .id = TRICKY_HARDWARE_MODULE_ID, .name = "Tricky HAL Module", .author = "Pavel Akimov", .methods = &amp;tricky_module_methods, };</span></span></span></span></code> </pre><br></div></div><br>  To build the module, you need an <a href="https://developer.android.com/ndk/guides/android_mk.html">Android.mk</a> file, where it says: <br><br><div class="spoiler">  <b class="spoiler_title">Android.mk</b> <div class="spoiler_text"><pre> <code class="hljs go">#     LOCAL_PATH := $(call my-dir) #         .mk ,   #        # , LOCAL_PATH   include $(CLEAR_VARS) LOCAL_PRELINK_MODULE := <span class="hljs-literal"><span class="hljs-literal">false</span></span> #  ,       LOCAL_MODULE_PATH := $(TARGET_OUT_SHARED_LIBRARIES)/hw #     LOCAL_SHARED_LIBRARIES := liblog libcutils libhardware #  ,   LOCAL_SRC_FILES := sensor_tricky_temperature.c #    LOCAL_MODULE := techartmsjdts.<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> LOCAL_MODULE_TAGS := debug include $(BUILD_SHARED_LIBRARY)</code> </pre><br></div></div><br>  And another Android.mk file is one level higher to enable the compiled library in libhardware.  Add by the name of the module ID. <br><br><div class="spoiler">  <b class="spoiler_title">Android.mk</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">hardware_modules := gralloc hwcomposer audio nfc nfc-nci local_time \ power usbaudio audio_remote_submix camera consumerir tricky <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(<span class="hljs-keyword"><span class="hljs-keyword">call</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span>-named-subdir-makefiles,$(hardware_modules))</code> </pre><br></div></div><br>  At the output of HAL, we have the following files <br><br><pre> <code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span>/libhardware/include/<span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span>/sensor_tricky_temperature.h <span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span>/libhardware/modules/Android.mk <span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span>/libhardware/modules/tricky/sensor_tricky_temperature.c <span class="hljs-keyword"><span class="hljs-keyword">hardware</span></span>/libhardware/modules/tricky/Android.mk</code> </pre><br>  <b>How to add your system service and where to add it so that it turns on and is found</b> <br><br>  Further it is necessary that someone called our HAL.  In other parts of OC, such things are done using system services and their managers, which are written in Java.  In order not to stand out from the series, we will write another one.  Our service will participate in the following files: <br><br><pre> <code class="hljs tex">frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">core</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">app</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ContextImpl</span></span></span></span>.java frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">core</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">content</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Context</span></span></span></span>.java frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">core</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hardware</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temperature</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ITrickyService</span></span></span></span>.aidl frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">core</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hardware</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temperature</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TrickyTemperatureData</span></span></span></span>.aidl frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">core</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hardware</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temperature</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TrickyTemperatureData</span></span></span></span>.java frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">core</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">hardware</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temperature</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TrickyManager</span></span></span></span>.java frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">com</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">temperature</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TrickyService</span></span></span></span>.java frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">com</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">android</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">server</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SystemServer</span></span></span></span>.java frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jni</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Android</span></span></span></span>.mk frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jni</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">com</span></span></span></span>_android_server_temperature_TrickyService.cpp frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">services</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jni</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">onload</span></span></span></span>.cpp frameworks<span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">base</span></span></span></span><span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Android</span></span></span></span>.mk</code> </pre><br>  As can be seen from the sources, we have not yet figured out the level of native, and you need to connect to the HAL module through JNI.  At the same time, let's write down our reference type, which will need to be determined via <a href="https://developer.android.com/guide/components/aidl.html">AIDL</a> , and then thrown from C ++ to Java. <br><br><div class="spoiler">  <b class="spoiler_title">The native code of the service</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   LOG_TAG         #define LOG_TAG "TRICKY" #include "jni.h" #include "JNIHelp.h" #include "android_runtime/AndroidRuntime.h" #include &lt;utils/misc.h&gt; #include &lt;utils/Log.h&gt; #include &lt;hardware/hardware.h&gt; #include &lt;hardware/sensor_tricky_temperature.h&gt; #include &lt;stdio.h&gt; // ,       ,   //    ,   Android namespace android { static jlong init_native(JNIEnv *env, jobject clazz) { int err; hw_module_t* module; tricky_device_t* dev = NULL; //   HAL //       ,  hw   //      ,    // HAL   ".default" -      (   //    - HAL,   ) err = hw_get_module(TRICKY_HARDWARE_MODULE_ID, (hw_module_t const**)&amp;module); if (err == 0) { err = module-&gt;methods-&gt;open(module, "", ((hw_device_t**) &amp;dev)); if (err != 0) { ALOGE("init_native: cannot open device module: %d", err); return -1; } } else { ALOGE("init_native: cannot get device module: %d", err); return 0; } ALOGD("init_native: start ok"); //      Java         return (jlong)dev; } //       static void finalize_native(JNIEnv *env, jobject clazz, jlong ptr) { tricky_device_t* dev = (tricky_device_t*)ptr; if (dev == NULL) { ALOGE("finalize_native: invalid device pointer"); return; } free(dev); ALOGD("finalize_native: finalized ok"); } //     HAL //     C++    TrickyTemperatureData static jobject read_sample_native(JNIEnv *env, jobject clazz, jlong ptr) { tricky_device_t* dev = (tricky_device_t*)ptr; int ret = 0; unsigned short synchro = 0; short obj_temp = 0; short ntc1_temp = 0; short ntc2_temp = 0; short ntc3_temp = 0; if (dev == NULL) { ALOGE("read_sample_native: invalid device pointer"); return (jobject)NULL; } ret = dev-&gt;read_sample(&amp;synchro, &amp;obj_temp, &amp;ntc1_temp, &amp;ntc2_temp, &amp;ntc3_temp); if (ret &lt; 0) { ALOGE("read_sample_native: Cannot read TrickyTemperatureData"); return (jobject)NULL; } //  ,     // android.hardware.temperature.TrickyTemperatureData jclass c = env-&gt;FindClass("android/hardware/temperature/TrickyTemperatureData"); if (c == 0) { ALOGE("read_sample_native: Find Class TrickyTemperatureData Failed"); return (jobject)NULL; } //   ( ) jmethodID cnstrctr = env-&gt;GetMethodID(c, "&lt;init&gt;", "()V"); if (cnstrctr == 0) { ALOGE("read_sample_native: Find constructor TrickyTemperatureData Failed"); return (jobject)NULL; } //  ID . , ,   ,    getter`  setter` jfieldID synchroField = env-&gt;GetFieldID(c, "synchro", "I"); jfieldID objTempField = env-&gt;GetFieldID(c, "objectTemperature", "I"); jfieldID ntc1TempField = env-&gt;GetFieldID(c, "ntc1Temperature", "I"); jfieldID ntc2TempField = env-&gt;GetFieldID(c, "ntc2Temperature", "I"); jfieldID ntc3TempField = env-&gt;GetFieldID(c, "ntc3Temperature", "I"); if (synchroField == 0 || objTempField == 0 || ntc1TempField == 0 || ntc2TempField == 0 || ntc3TempField == 0) { ALOGE("read_sample_native: cannot get fields of resulting object"); return (jobject)NULL; } //       jobject jdtsData = env-&gt;NewObject(c, cnstrctr); env-&gt;SetIntField(jdtsData, synchroField, (jint)synchro); env-&gt;SetIntField(jdtsData, objTempField, (jint)obj_temp); env-&gt;SetIntField(jdtsData, ntc1TempField, (jint)ntc1_temp); env-&gt;SetIntField(jdtsData, ntc2TempField, (jint)ntc2_temp); env-&gt;SetIntField(jdtsData, ntc3TempField, (jint)ntc3_temp); ALOGD("read_sample_native: read ok"); return jdtsData; } //     //          JNI static JNINativeMethod method_table[] = { { "init_native", "()J", (void*)init_native }, { "finalize_native", "(J)V", (void*)finalize_native }, { "read_sample_native", "(J)Landroid/hardware/temperature/TrickyTemperatureData;", (void*)read_sample_native }, { "activate_native", "(JZ)Z", (void*)activate_native }, { "set_mode_native", "(JZ)Z", (void*)set_mode_native}, }; //           onload.cpp, //     system server  int register_android_server_JdtsService(JNIEnv *env) { ALOGD("register_android_server_JdtsService"); return jniRegisterNativeMethods( env, "com/android/server/temperature/JdtsService", method_table, NELEM(method_table)); }; };</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Next, all the JNI parts of the services that need it are loaded into onload.cpp. </font><font style="vertical-align: inherit;">Including ours.</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">onload.cpp</font></font></b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ... #include "JNIHelp.h" #include "jni.h" #include "utils/Log.h" #include "utils/misc.h" namespace android { // ... int register_android_server_JdtsService(JNIEnv* env); }; using namespace android; extern "C" jint JNI_OnLoad(JavaVM* vm, void* /* reserved */) { JNIEnv* env = NULL; jint result = -1; if (vm-&gt;GetEnv((void**) &amp;env, JNI_VERSION_1_4) != JNI_OK) { ALOGE("GetEnv failed!"); return result; } ALOG_ASSERT(env, "Could not retrieve the env!"); // ... register_android_server_JdtsService(env); return JNI_VERSION_1_4; }</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Traditional Android.mk contains information for assembling all the parts, and our JNI piece is also there. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Our reference type must be created using AIDL, since this language is a means of interprocess data transfer to Android, and not only in it. </font><font style="vertical-align: inherit;">Also, in order to send it, it must be Parcelable, as shown in the listing below:</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TrickyTemperatureData.aidl</font></font></b> <div class="spoiler_text"><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">package</span></span> android.hardware.temperature; <span class="hljs-attribute"><span class="hljs-attribute">parcelable</span></span> TrickyTemperatureData;</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">TrickyTemperatureData.java</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> android.hardware.temperature; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Parcel; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Parcelable; <span class="hljs-comment"><span class="hljs-comment">/** {</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@hide</span></span></span><span class="hljs-comment">} */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TrickyTemperatureData</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Parcelable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> synchro; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> objectTemperature; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ntc1Temperature; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ntc2Temperature; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ntc3Temperature; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Parcelable.Creator&lt;TrickyTemperatureData&gt; CREATOR = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Parcelable.Creator&lt;TrickyTemperatureData&gt;() { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> TrickyTemperatureData </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFromParcel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel in)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TrickyTemperatureData(in); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TrickyTemperatureData[] newArray(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> size) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TrickyTemperatureData[size]; } }; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TrickyTemperatureData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TrickyTemperatureData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel in)</span></span></span><span class="hljs-function"> </span></span>{ readFromParcel(in); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writeToParcel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel out, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> flags)</span></span></span><span class="hljs-function"> </span></span>{ out.writeInt(synchro); out.writeInt(objectTemperature); out.writeInt(ntc1Temperature); out.writeInt(ntc2Temperature); out.writeInt(ntc3Temperature); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">readFromParcel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Parcel in)</span></span></span><span class="hljs-function"> </span></span>{ synchro = in.readInt(); objectTemperature = in.readInt(); ntc1Temperature = in.readInt(); ntc2Temperature = in.readInt(); ntc3Temperature = in.readInt(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">describeContents</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }</code> </pre><br></div></div><br>         ,     ,     ,    . <br><br>       ,         context.getSytemService. ,       <a href="https://habrahabr.ru/users/hide/" class="user_link">hide</a> ,    ,   ,         API,  . <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// frameworks\base\core\java\android\content\Context.java /** * @hide */ public static final String TRICKY_SERVICE = "android.service.tricky.ITrickyService";</span></span></code> </pre><br>   ,     ServiceManager  SystemServer  . <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// frameworks\base\services\java\com\android\server\SystemServer.java // initAndLoop ... try { Slog.e(TAG, "Tricky Service"); trickyService = new TrickyService(context); ServiceManager.addService(Context.TRICKY_SERVICE, trickyService); } catch (Throwable e) { Slog.e(TAG, "Failure starting TrickyService", e); }</span></span></code> </pre><br>       ,      context (   ). <br><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//frameworks\base\core\java\android\app\ContextImpl.java registerService(TRICKY_SERVICE, new ServiceFetcher() { public Object createService(ContextImpl ctx) { IBinder iBinder = ServiceManager.getService(Context.TRICKY_SERVICE); return new TrickyManager(ITrickyService.Stub.asInterface(iBinder)); }});</span></span></code> </pre><br>  registerService   Android 4.4.4 : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> sNextPerContextServiceCacheIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">// ..   fetcher     map private static void registerService(String serviceName, ServiceFetcher fetcher) { if (!(fetcher instanceof StaticServiceFetcher)) { fetcher.mContextCacheIndex = sNextPerContextServiceCacheIndex++; } SYSTEM_SERVICE_MAP.put(serviceName, fetcher); } // ,   getSystemService      // ... @Override public Object getSystemService(String name) { ServiceFetcher fetcher = SYSTEM_SERVICE_MAP.get(name); return fetcher == null ? null : fetcher.getService(this); }</span></span></code> </pre><br> <b>   SEAndroid/SELinux   </b> <br><br>       ,          ,       root,   ,         ,       - ,  ,  .         sepolicy. <br><br> -   init,        . <br><br><pre> <code class="hljs kotlin">#(device/asus/grouper/<span class="hljs-keyword"><span class="hljs-keyword">init</span></span>.grouper.rc) # ... on post-fs-<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> # ... # tricky temperature sensor #  /     system #    root`      chmod <span class="hljs-number"><span class="hljs-number">0660</span></span> /sys/<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tricky</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tricky_temperature</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chown</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">system</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">system</span></span></span><span class="hljs-class"> /</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sys</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tricky</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tricky_temperature</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dev</span></span></span></span></code> </pre><br>          ueventd. <br><br><pre> <code class="hljs pgsql"># device/asus/grouper/ueventd.grouper.rc /dev/tricky_temperature <span class="hljs-number"><span class="hljs-number">0660</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-keyword"><span class="hljs-keyword">system</span></span></code> </pre><br>   ‚Ä¶    SELinux ,         (      ),   ,        ,    .  ,  ,    <a href="https://android.googlesource.com/device/generic/brillo/%2B/master/sepolicy">Brillo</a> .  ,      ,    : <br><br><div class="spoiler"> <b class="spoiler_title">     </b> <div class="spoiler_text"><pre> <code class="hljs mel">##################################### #     ,        #              . #  ,     . # (te_macros) # tricky_service_domain(domain) # Allow a base set of permissions common across Android daemons. define(<span class="hljs-string"><span class="hljs-string">`tricky_service_domain', `</span></span> init_daemon_domain($1) # Allow using binder and performing IPC to <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> services. binder_use($1) binder_service($1) # Allow access to files <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>. # Fixes denials like: # avc: denied { read } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> pid=<span class="hljs-number"><span class="hljs-number">1267</span></span> comm=<span class="hljs-string"><span class="hljs-string">"peripheralman"</span></span> name=<span class="hljs-string"><span class="hljs-string">"misc"</span></span> dev=<span class="hljs-string"><span class="hljs-string">"proc"</span></span> # ino=<span class="hljs-number"><span class="hljs-number">4026531967</span></span> scontext=u:r:peripheralman:s0 # tcontext=u:object_r:<span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>:s0 tclass=<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> permissive=<span class="hljs-number"><span class="hljs-number">0</span></span> allow $1 <span class="hljs-keyword"><span class="hljs-keyword">proc</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">file</span></span> r_file_perms; allow $1 tricky_service:service_manager find; # Cut down on spam. dontaudit $1 kernel:<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> module_request; <span class="hljs-string"><span class="hljs-string">') ##################################### #         ,       , #    # (tricky_service.te) type tricky_service, domain; type tricky_service_exec, exec_type, file_type; tricky_service_domain(tricky_service) ##################################### # ,      system manager # (service.te) type tricky_service, service_manager_type; #    ,          # "tricky_service"   . #    SELinux    https://source.android.com/security/selinux/ ##################################### # (service_contexts) android.service.jdtstemperature.IJdstsService u:object_r:tricky_service:s0 ##################################### #   .             #    .      # (device.te) type tricky_device, dev_type, mlstrustedobject; ##################################### #        # (file_contexts) /dev/tricky_temperature u:object_r:tricky_device:s0 ##################################### #         ( ,   , #          "bootanim"     #  ) #(bootanim.te) allow bootanim tricky_device:chr_file rw_file_perms; ##################################### # , ,        SystemServer  system apps # (system_server.te) allow system_server tricky_device:chr_file rw_file_perms; ##################################### # (system_app.te) allow system_app tricky_device:chr_file rw_file_perms;</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here we created a new domain for our service, defined our device and showed that our service has read and write rights to our driver. Of course, it was not the first time to write this. After all this, the boot system finally got rid of messages about the blocked service, and in adb shell it became clear that the driver was recorded in the user name system and open to the world. </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">How to check - we will write simple</font></font></b> <br><br>    - ,     . , ,   adb shell   logcat,    -   ,     OC    . , .   ,   .     packages/apps/TrickyDemo,    build/target/product/core.mk     . <br><br><div class="spoiler"> <b class="spoiler_title">  internal application</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.android.trickydemo; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.app.Activity; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.os.Bundle; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.util.Log; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.CompoundButton; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.ImageView; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.Switch; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.widget.TextView; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> android.hardware.temperature.*; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Activity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String TAG = <span class="hljs-string"><span class="hljs-string">"TrickyDemo"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> POLLING_PERIOD_MS = <span class="hljs-number"><span class="hljs-number">200</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TrickyManager mServiceManager = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TrickyTemperatureData mSensorData = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GaugeView mGaugeObj; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GaugeView mGaugeNtc1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GaugeView mGaugeNtc2; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> GaugeView mGaugeNtc3; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView mTextSynchro; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ImageView mIrqImage; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView mTextObj; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView mTextNtc1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView mTextNtc2; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TextView mTextNtc3; <span class="hljs-comment"><span class="hljs-comment">// all temperatures are .2 points precision values in degrees Celsius final private Object mDataSync = new Object(); private boolean mMeasModeUpdateRequired; // set up when user switches between measurement modes and queues I2C expander command // to switch the mode private boolean mIsContinuousMode; // continuous mode (power is always on, no control) // burst mode (every cycle power on, read and power off required) private boolean mPowerState; private boolean mPowerUpdateRequired; private Thread mCommThread = null; private boolean mIsRunning = true; // the communication thread goes on unless onDestroy method is called @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); // enforce the sensor to switch into continuous mode on startup mPowerUpdateRequired = true; mPowerState = true; mMeasModeUpdateRequired = true; mIsContinuousMode = true; mIrqImage = (ImageView) findViewById(R.id.image_led_irq); mGaugeObj = (GaugeView) findViewById(R.id.gauge_view_obj); mGaugeNtc1 = (GaugeView) findViewById(R.id.gauge_view_ntc1); mGaugeNtc2 = (GaugeView) findViewById(R.id.gauge_view_ntc2); mGaugeNtc3 = (GaugeView) findViewById(R.id.gauge_view_ntc3); mTextSynchro = (TextView) findViewById(R.id.text_synchro); mTextObj = (TextView) findViewById(R.id.text_obj); mTextNtc1 = (TextView) findViewById(R.id.text_ntc1); mTextNtc2 = (TextView) findViewById(R.id.text_ntc2); mTextNtc3 = (TextView) findViewById(R.id.text_ntc3); Switch switch_mode = (Switch) findViewById(R.id.switch1); switch_mode.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() { @Override public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) { synchronized (mDataSync) { mIsContinuousMode = isChecked; mMeasModeUpdateRequired = true; } } }); Switch switch_power = (Switch) findViewById(R.id.switch_power); switch_power.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() { @Override public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) { synchronized (mDataSync) { mPowerState = isChecked; mPowerUpdateRequired = true; } } }); switch_power.setChecked(true); // power is on by default mServiceManager = (TrickyManager) getSystemService(TRICKY_SERVICE); mCommThread = new Thread() { @Override public void run() { while(mIsRunning) { synchronized (mDataSync) { if (mPowerUpdateRequired) { if (mServiceManager.activate(mPowerState)) { mPowerUpdateRequired = false; } else { Log.w(TAG, "Cannot update power state"); } } if (mMeasModeUpdateRequired) { if (mServiceManager.setMode(mIsContinuousMode)) { mMeasModeUpdateRequired = false; } else { Log.w(TAG, "Cannot update measurement mode"); } } } mSensorData = mServiceManager.readSample(); if (mSensorData != null) { updateUI(); } else { updateNonIRQUI(); } try { Thread.sleep(POLLING_PERIOD_MS); } catch (InterruptedException e) { e.printStackTrace(); } } } }; mCommThread.setUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() { @Override public void uncaughtException(Thread t, Throwable e) { e.printStackTrace(); } }); mCommThread.start(); } @Override protected void onDestroy() { super.onDestroy(); try { mCommThread.join(POLLING_PERIOD_MS * 2); } catch (InterruptedException e) { e.printStackTrace(); } } private void updateUI() { runOnUiThread(new Runnable() { public void run() { float obj_temp = mSensorData.objectTemperature / 100.F; float ntc1_temp = mSensorData.ntc1Temperature / 100.F; float ntc2_temp = mSensorData.ntc2Temperature / 100.F; float ntc3_temp = mSensorData.ntc3Temperature / 100.F; String s_obj = String.format("%.2f ¬∞C", obj_temp); String s_ntc1 = String.format("%.2f ¬∞C", ntc1_temp); String s_ntc2 = String.format("%.2f ¬∞C", ntc2_temp); String s_ntc3 = String.format("%.2f ¬∞C", ntc3_temp); String s_synchro = String.format("Synchro = %d", mSensorData.synchro); mGaugeObj.setTargetValue(obj_temp); mTextObj.setText(s_obj); mGaugeNtc1.setTargetValue(ntc1_temp); mTextNtc1.setText(s_ntc1); mGaugeNtc2.setTargetValue(ntc2_temp); mTextNtc2.setText(s_ntc2); mGaugeNtc3.setTargetValue(ntc3_temp); mTextNtc3.setText(s_ntc3); mTextSynchro.setText(s_synchro); mIrqImage.setImageDrawable(getResources().getDrawable(R.drawable.led_green_hi)); Log.d(TAG, s_synchro + "Obj = " + s_obj + " NTC1 = " + s_ntc1 + " NTC2 = " + s_ntc2 + " NTC3 = " + s_ntc3); } }); } private void updateNonIRQUI() { runOnUiThread(new Runnable() { public void run() { mIrqImage.setImageDrawable(getResources().getDrawable(R.drawable.led_green_md)); } }); } }</span></span></code> </pre> <br></div></div><br>       Android Studio (    sdk ‚Äî    4.4.4),     .       Android.mk,     . <br><br><pre> <code class="hljs ruby">LOCAL_PATH <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(call my-dir) <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(CLEAR_VARS) LOCAL_MODULE_TAGS <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= optional LOCAL_SRC_FILES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(call all-java-files-under, src) LOCAL_RESOURCE_FILES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= $(addprefix $(LOCAL_PATH)/, res) LOCAL_PACKAGE_NAME <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= TrickyDemo LOCAL_CERTIFICATE <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= platform LOCAL_STATIC_JAVA_LIBRARIES <span class="hljs-symbol"><span class="hljs-symbol">:</span></span>= android-support-core-utils-api24 <span class="hljs-keyword"><span class="hljs-keyword">include</span></span> $(BUILD_PACKAGE)</code> </pre> <br>          -  ,   out/target/common/obj/SHARED_LIBRARIES    . <br><br> <b>   </b> <br><br>      . ,    : <br><br> HW: Nexus 7 (2012 grouper) <br> OS: Android Kitkat 4.4.4 KTU84P <br> Kernel: tegra3_android_defconfig 3.1.10-gle42d16 <br><br>   . <br>    : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">git</span></span> clone https://android.googlesource.com/kernel/tegra.git -b android-tegra3-grouper-<span class="hljs-number"><span class="hljs-number">3</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>-kitkat-mr2</code> </pre> <br>       : <br><br><pre> <code class="hljs ruby">mkdir arm-eabi-<span class="hljs-number"><span class="hljs-number">4.6</span></span> cd arm-eabi-<span class="hljs-number"><span class="hljs-number">4.6</span></span> git init git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/android.googlesource.com/platform</span></span><span class="hljs-regexp"><span class="hljs-regexp">/prebuilts/gcc</span></span><span class="hljs-regexp"><span class="hljs-regexp">/linux-x86/arm</span></span><span class="hljs-regexp"><span class="hljs-regexp">/arm-eabi-4.6/</span></span></code> </pre> <br>    (    ): <br><br><pre> <code class="hljs xml">ARCH=arm SUBARCH=arm CROSS_COMPILE=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path_to_arm_eabi-4.6</span></span></span><span class="hljs-tag">&gt;</span></span>/arm-eabi-4.6/bin/arm-eabi- make tegra3_android_defconfig ARCH=arm SUBARCH=arm CROSS_COMPILE=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path_to_arm_eabi-4.6</span></span></span><span class="hljs-tag">&gt;</span></span>/arm-eabi-4.6/bin/arm-eabi- make menuconfig ARCH=arm SUBARCH=arm CROSS_COMPILE=<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">path_to_arm_eabi-4.6</span></span></span><span class="hljs-tag">&gt;</span></span>/arm-eabi-4.6/bin/arm-eabi- make -j4 zImage</code> </pre> <br>      make menuconfig   device drivers      Tricky temperature sensor (     menuconfig ‚Äî  ).   .       kernel/tegra/arch/arm/boot/zImage. <br><br>  Android.   Android OS       ,    ,      ( <a href="http://source.android.com/source/requirements.html"> </a> ).   ,    Ubuntu 14.04 LTS x64 (  Windows   ,  ). <br><br>       <a href="http://source.android.com/source/initializing.html"></a> ,      . ,  ,          Java ( Android 7  OpenJDK Java 8,  Nexus 7  Android 4.x  Oracle Java 6). <br><br>      Android   <a href="http://source.android.com/source/requirements.html"></a> . <br><br>       <a href="https://gerrit.googlesource.com/git-repo/">Repo</a> ‚Äî   Git,      git- (  <a href="https://source.android.com/source/downloading"></a> ).   Repo         : <br><br><pre> <code class="hljs swift">repo <span class="hljs-keyword"><span class="hljs-keyword">init</span></span> -u https:<span class="hljs-comment"><span class="hljs-comment">//android.googlesource.com/platform/manifest -b android-4.4.4_r2 cd .repo repo sync</span></span></code> </pre> <br>    ,      50. <br><br>       (     Android OS)   4.4.4 KTU84P   Nexus`: <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asus-grouper-ktu84p-b12ce5f7.tgz https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/broadcom-grouper-ktu84p-646d5a68.tgz https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/elan-grouper-ktu84p-742223b3.tgz https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/invensense-grouper-ktu84p-724c855a.tgz https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/nvidia-grouper-ktu84p-e6d581dc.tgz https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/nxp-grouper-ktu84p-27abae08.tgz https:/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/dl.google.com/dl</span></span><span class="hljs-regexp"><span class="hljs-regexp">/android/aosp</span></span><span class="hljs-regexp"><span class="hljs-regexp">/widevine-grouper-ktu84p-57b01f77.tgz</span></span></code> </pre> <br>     : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">tar</span></span> -xvf asus-grouper-ktu84p-b12ce5f7.tgz tar -xvf broadcom-grouper-ktu84p-646d5a68.tgz tar -xvf elan-grouper-ktu84p-742223b3.tgz tar -xvf invensense-grouper-ktu84p-724c855a.tgz tar -xvf nvidia-grouper-ktu84p-e6d581dc.tgz tar -xvf nxp-grouper-ktu84p-27abae08.tgz tar -xvf widevine-grouper-ktu84p-57b01f77.tgz rm <span class="hljs-regexp"><span class="hljs-regexp">*.tgz</span></span> ./extract-asus-grouper.sh ./extract-broadcom-grouper.sh ./extract-elan-grouper.sh ./extract-invensense-grouper.sh ./extract-nvidia-grouper.sh ./extract-nxp-grouper.sh ./extract-widevine-grouper.sh</code> </pre> <br>   : <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> nexus <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> nexus make clobber (     ) . build/envsetup.sh lunch aosp_grouper-userdebug make -j4</code> </pre> <br>     : <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">make</span></span> clobber</code> </pre> <br>         out/target/product/grouper (system.img, recovery.img, ramdisk.img, userdata.img). Apk-    out/target/product/grouper/obj/APPS/Jdts160demo_intermediates/package.apk. <br><br>      fastboot.  .zip-  ,     FLASH  (   boot.img, system.img, recovery.img, userdata.img, ramdisk.img),    android-info.txt  : <br><br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">require</span></span> board=grouper <span class="hljs-keyword"><span class="hljs-keyword">require</span></span> version-bootloader=<span class="hljs-number"><span class="hljs-number">4.23</span></span></code> </pre> <br>       ,     Factory image  <a href=""></a>    flash_all.sh  .           . <br><br>   boot.img    abootimg: <br><br><pre> <code class="hljs pgsql">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install abootimg abootimg <span class="hljs-comment"><span class="hljs-comment">--create boot.img -k zImage -r ramdisk.img</span></span></code> </pre> <br>    abootimg     ,  ..  ,      ,    . <br><br>    fastboot.  Options: <br><br><blockquote> adb reboot bootloader (  ,   usb   adb) <br>  ,  ,     . </blockquote><br>   fastboot (usb   usb debugging ). <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">fastboot</span></span> devices</code> </pre> <br>    .    ,    : <br><br><pre> <code class="hljs sql">fastboot oem <span class="hljs-keyword"><span class="hljs-keyword">unlock</span></span> fastboot erase boot fastboot erase <span class="hljs-keyword"><span class="hljs-keyword">cache</span></span> fastboot erase <span class="hljs-keyword"><span class="hljs-keyword">recovery</span></span> fastboot erase <span class="hljs-keyword"><span class="hljs-keyword">system</span></span> fastboot erase userdata fastboot <span class="hljs-number"><span class="hljs-number">-2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> image.zip</code> </pre> <br> <b> ,     -  </b> <br><br>   ,                    ,    .                     .   : <br><br><ul><li>        devices/asus/grouper/...,   overlays,        ,     .       ,       ,    ,   -  . <br><br></li><li>    audio-jack    .      <a href="http://www.pabr.org/consolejack/consolejack.en.html"></a> ,     ,  -    .  Namely: <br><br><ul><li>    uart-1 &amp; uart-4  debug,    pinmux  GPIO    not_used/disabled. </li><li> Google   usb-uart FTDI       ,       50,    . </li><li>  make menuconfig   uart      uart`.   ,       . </li><li>   fastboot  bootloader   command line   . , ,    . </li></ul><br></li><li>       ,        .    system </li></ul></div><p>Source: <a href="https://habr.com/ru/post/326640/">https://habr.com/ru/post/326640/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../326626/index.html">Own cryptocurrency on ethereum</a></li>
<li><a href="../326628/index.html">SDAccel - first acquaintance</a></li>
<li><a href="../326632/index.html">Under the hood of the development environment. Basic models</a></li>
<li><a href="../326634/index.html">Bash on Windows: Practical Experiments in Crossing Hedgehogs and Snacks</a></li>
<li><a href="../326636/index.html">Moving XenForo Forum to the modern platform</a></li>
<li><a href="../326642/index.html">Recipe interface</a></li>
<li><a href="../326644/index.html">Scientists from ITMO University have proposed a new system for the transmission of energy over a distance</a></li>
<li><a href="../326646/index.html">Simplify converters for WPF</a></li>
<li><a href="../326648/index.html">St. Petersburg homeless - in Prague. Continuing the history of self-taught developer</a></li>
<li><a href="../326650/index.html">Introduction to machine learning with tensorflow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>