<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Blackjack leakage protection with counters</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Greetings. There is such a thing - skidrok \ neptune \ avkvastorozh - the system overlapping the water supply, if there is no controlled leakage. The ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Blackjack leakage protection with counters</h1><div class="post__text post__text-html js-mediator-article">  Greetings.  There is such a thing - skidrok \ neptune \ avkvastorozh - the system overlapping the water supply, if there is no controlled leakage.  The principle is simple - water sensor + automatic + a couple of taps with electric drives.  But the devil, as usual, is in the details: how are the taps arranged, how the leakage sensors are arranged, and why one costs 50 rubles, and the other 500r.  A whole kilogram of breading bread will be put on the whole thing, packaging will be torn out, etc. <br><br>  In the story I will go through the bricks of the system, what guided the choice.  The whole system is built on factory sensors and a homemade controller based on Particle (ex.Spark) Photon (such esp8266 which has a cloudy IDE for wiring out of the box), the base of the device stm controller + wifi module from the brodkom.  All this is tied to an openhab server on the Orange Pi One. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/715/6ee/aa2/7156eeaa28b44479a5d5aff2e63ff89c.png" width="600"></div><br><a name="habracut"></a><br>  Why not a complete system? 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      - Because I can myself and this is a thrill <br>  - In ready-made systems, integration with external systems is lame. <br>  - Ready systems do not have auxiliary functions - taking into account meter readings, water temperature sensors, notification of water shutdowns and other pedestrian erotic fantasies. <br><br><h3>  Nachem with taps </h3><br>  Chose stupidly in the forehead for torque.  For some time he lived in the suburbs, where the quality of water (as probably everywhere in the castle) leaves much to be desired.  So ball valves for 1/2 inches if the year does not touch - turn very hard.  And on the heated towel rail 1 inch, I don‚Äôt even try to move it - only if I strengthen the shoulder with an adjustable wrench, and here I can break something.  The problem is in calcium deposits, ‚Äúovergrown‚Äù with the same word. <br><br>  Correspondingly, the choice fell on the professional series from the hydrolock - 21N * m of torque does not feel like an advertisement chatter, the crane is simply huge - estimate the place of its installation before purchase. <br><br><img src="https://habrastorage.org/files/758/e07/18c/758e0718cc9a46e09306bac214db8cf1.jpg"><br><br>  The crane is sealed, around the perimeter of the rubber seal, the entrance under the screw seal. <br>  Remove the cover. <br><br><img src="https://habrastorage.org/files/f9d/aa4/a25/f9daa4a251e140c3bbe4b049a5af7f46.jpg"><br><br>  Before us is the top of the board and the stepper motor.  It eats all this from 12 volts.  Closing the control cable to ground puts the valve in the closed position.  On the board we see a simple PIC 12f629 controller.  Lived, the controller in the drive of the crane. <br><br>  The back of the board is the most interesting. <br><br><img src="https://habrastorage.org/files/c14/e08/f2e/c14e08f2e4224088a534e1811fa3729a.jpg"><br><br>  L293 driver shagovika and photopairs (emitter + photodetector).  She looks at the main drive gear, which is painted into parts - white and black, closed / open. <br><br><img src="https://habrastorage.org/files/a14/cec/177/a14cec1771ef4d52bc15c83e9183124e.jpg"><br><br>  The crane rotates all the time in one direction, the logic of the controller is simple - we twist the shaft until we switch to the desired color.  Rotation of the crane in one direction, it is less wear, and the contactless method of determining the position - less chance of souring \ failure variable resistor or limit switch. <br><br>  For installation, you can unscrew the valve from the drive - held on 2 nuts.  Between the drive and the crane heat-insulating laying. <br><br><img src="https://habrastorage.org/files/bf7/37c/1f7/bf737c1f7a144c72baba7a17fdc94615.jpg"><br><br>  I had a repair a year and a half ago.  The crane bought about three years ago - to disassemble, to look inside, to buy more and to wind during repair.  Yeah, now ... the maximum that I managed to do in this hellish circus was to lay a mud trap in the water distribution assembly with the prospect of replacing it with a faucet. <br>  And only a year and a half later, I bought a second crane and screwed them up. <br><br>  As a result, we observe a strange and rare phenomenon (read by Drozdov‚Äôs voice) - all information from the manufacturer‚Äôs website has been confirmed.  Moreover, the description is peculiar, as if the techies were writing, and then the marketing was polished for the people, but still few would understand all the chips.  Not enough section on the site - for integrators with technical details inside.  Even at the expense of increased torque at the start, they did not lie - the crane at the start started up with a 1.5A engine and after 2-3 seconds it began to fade in normal mode (current 0.7 A).  It takes 25-30 seconds to close. <br><br>  Even from experience: at the expense of torque - it is redundant for Moscow time, here the water is quite OK, for a year and a half in a 100 micron filter a pair of scales and no overgrowth.  For a large torque, you have to pay with price, opening time, and space in the cabinet.  I think here the usual drives enough from the Hidrolok Ultimate, Neptune or Aquastorozha.  For the last two I can‚Äôt vouch - I didn‚Äôt understand it, about 5 years ago they had partially plastic gears, now they seem to have fixed it. <br><br>  There is still a winner skirok with direct connection of sensors to the drive - this is if you do not need all that I did.  There, the power is autonomous from 4 batteries, and the base seems to be from the ultimate drive.  In general, it is potentially interesting for the self-made controller - power is 5 volts, it is not necessary to fence two buses for 5 and 12 volts and you can throw an optocoupler. <br><br><h3>  Leakage sensors </h3><br>  I bought the sensors of the same WSU counterparts - universal.  They have two open "open collector" outlets, one pulls on the ground only if there is water, the second one - if the water is dropped, it pulls on the ground all the time until the power is cut.  Only the first output I use, the rest of the logic in the controller, but it seems that this output can be useful for some more kondovyh systems of distribution control. <br><br>  The wires in the kit are three meters somewhere.  The color of the wires - Ad_i_Israel.  Check out this quote: <br><br><blockquote>  <i>red (brown) wire (Vcc) powered from +5 to +30 volts.</i> <i><br></i>  <i>black (white) wire (OUT2)</i> <i><br></i>  <i>green wire (OUT1)</i> <i><br></i>  <i>yellow wire (GND)</i> </blockquote><br>  Is that what prevented white / black earth from doing so?  On the drive of the crane, too, by the way, the wires are color-coded with no logic.  The first sensor is in the kitchen, under the sink next to the dishwasher. <br><br><img src="https://habrastorage.org/files/2ea/407/a25/2ea407a255b8420e9b1d6c26772e2709.jpg"><br><br>  Second in the bathroom in a special drainage ditch.  When did the screed - did not bring it to the wall.  It turned out a sort of sump for collecting water from the bathroom and toilet. <br><br><img src="https://habrastorage.org/files/51d/715/898/51d71589848d4a77a59f8caf0dbf2041.jpg"><br><br>  From operating experience - I already had one false triggering of the sensor in the dishwasher.  Judging by the log for one polling cycle (500ms), there was a closure, modified code - the state change now occurs at 10 consecutive identical values ‚Äã‚Äãfrom the sensor. <br><br>  The sensor contacts are gilded.  Comrade similar sensors for several years, oxidation is not observed. <br><br><h3>  Pressure Sensors </h3><br>  Almost - show meters.  Accuracy + - 0.5 ATM completely suited me.  Based on the sensor comes a warning about turning off the water.  I bought on Ali <a href="https://www.aliexpress.com/item/Pressure-Sensor-Transmitter-DC-5V-G1-4-0-1-2-MPa-0-174-PSI-For-Water/1669537885.html">here</a> . <br><br><h3>  Temperature sensors </h3><br>  Why not add it?  From useful - can once a year notify about turning off the hot water.  Used commonplace ds18b20. <br><br><h3>  Counters </h3><br>  The most common Itelma, once in 10 liters, close the contacts.  On the controller side, the output is pulled to + 3.3v, the meter pulls it to the ground. <br><br><h3>  Controller </h3><br><img src="https://habrastorage.org/files/318/4e6/d7a/3184e6d7ad9c4eab99d9962410c7918c.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">Inside</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/a83/72d/117/a8372d1170ca43f8b92925fa76a240f8.jpg"><br><img src="https://habrastorage.org/files/f7b/e62/ee8/f7be62ee80a54ff2a0ed60ad17467a8b.jpg"><br></div></div><br>  Based on Particle Photon, more <a href="https://www.particle.io/">here</a> .  They have a version with 2G or 3G module (Electron).  The first firmware was a complete slag, blinking OK with diodes, but as soon as you start to hard-fake, playing with i2c and interruptions can lose wifi.  Now you can live.  In principle, you can throw the pressure sensors out of the circuit and stir everything up on the ESP8266 - dare.  First of all, photon should be tied to the particle account (done via the App on a mobile phone or via the Particle CLI console - I use only the second method) and register a wifi network.  After binding, a controller appears <a href="https://build.particle.io/build">here</a> in the device section and its connection status to the cloud. <br><br><img src="https://habrastorage.org/files/71d/c17/687/71dc17687ccb4a289d0a0dd2296fdfca.png"><br><br>  All my nodes connect to the cloud only to update the firmware.  Not that I'm paranoid - just working with the cloud is eating not the rich resources of the controller.  IDE supports work with libraries, literally a dozen are supported by the counter, the rest are supported by the community.  According to my observation, everything common has been ported for a long time, another trick - at once in the IDE, how many projects use the library. <br><br><div class="spoiler">  <b class="spoiler_title">Firmware source code</b> <div class="spoiler_text"><pre><code class="hljs pgsql">// This #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> was automatically added <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the Particle IDE. #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "Adafruit_SSD1306/Adafruit_SSD1306.h" // This #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> was automatically added <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the Particle IDE. #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "MQTT/MQTT.h" // This #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> <span class="hljs-keyword"><span class="hljs-keyword">statement</span></span> was automatically added <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the Particle IDE. #<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> "OneWire/OneWire.h" SYSTEM_THREAD(ENABLED); SYSTEM_MODE(MANUAL); STARTUP(WiFi.selectAntenna(ANT_EXTERNAL)); STARTUP(<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.enableFeature(FEATURE_RETAINED_MEMORY)); struct counter_struct { <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; byte state; <span class="hljs-type"><span class="hljs-type">int</span></span> pin; }; struct valve_struct { byte state; <span class="hljs-type"><span class="hljs-type">int</span></span> pin; }; struct sensor_struct { <span class="hljs-type"><span class="hljs-type">int</span></span> timeout; byte state; <span class="hljs-type"><span class="hljs-type">int</span></span> pin; }; unsigned long currentMillis = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned long previous_conected = <span class="hljs-number"><span class="hljs-number">100000</span></span>; //  unsigned long previous_wifi_uptime = <span class="hljs-number"><span class="hljs-number">100000</span></span>; //  unsigned long previous_counter_read = <span class="hljs-number"><span class="hljs-number">0</span></span>; //  unsigned long wifi_uptime; unsigned long start_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>; unsigned long read_temp_timer = <span class="hljs-number"><span class="hljs-number">0</span></span>; byte display_timeout = <span class="hljs-number"><span class="hljs-number">0</span></span>; //<span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> onewire OneWire ds0 = OneWire(D2); OneWire ds1 = OneWire(D3); byte addr0[<span class="hljs-number"><span class="hljs-number">8</span></span>]; byte addr1[<span class="hljs-number"><span class="hljs-number">8</span></span>]; <span class="hljs-type"><span class="hljs-type">bool</span></span> presense0 = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-type"><span class="hljs-type">bool</span></span> presense1 = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; byte data[<span class="hljs-number"><span class="hljs-number">12</span></span>]; #define OLED_RESET A7 Adafruit_SSD1306 display(OLED_RESET); //valve control retained valve_struct valve[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, D4}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, D5} }; //counter control retained counter_struct counter[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A0}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, A1} }; <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> pressure[<span class="hljs-number"><span class="hljs-number">2</span></span>] = {A2, A3}; #define SENSOR_TIMEOUT <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> sensor_struct sensor[<span class="hljs-number"><span class="hljs-number">2</span></span>] = { {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D6}, {<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, D7} }; <span class="hljs-type"><span class="hljs-type">void</span></span> callback(<span class="hljs-type"><span class="hljs-type">char</span></span>* topic, byte* payload, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> length); byte <span class="hljs-keyword"><span class="hljs-keyword">server</span></span>[] = { <span class="hljs-number"><span class="hljs-number">192</span></span>,<span class="hljs-number"><span class="hljs-number">168</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span>}; MQTT client(<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>, <span class="hljs-number"><span class="hljs-number">1883</span></span>, callback); <span class="hljs-type"><span class="hljs-type">bool</span></span> publish_message(const <span class="hljs-type"><span class="hljs-type">char</span></span>* t, const <span class="hljs-type"><span class="hljs-type">char</span></span>* p, <span class="hljs-type"><span class="hljs-type">bool</span></span> retain) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (uint8_t*)p, sizeof(p), retain); } <span class="hljs-type"><span class="hljs-type">bool</span></span> publish_message(const <span class="hljs-type"><span class="hljs-type">char</span></span>* t, <span class="hljs-type"><span class="hljs-type">int</span></span> p, <span class="hljs-type"><span class="hljs-type">bool</span></span> retain) { <span class="hljs-type"><span class="hljs-type">char</span></span> buf_d[<span class="hljs-number"><span class="hljs-number">12</span></span>]; <span class="hljs-type"><span class="hljs-type">int</span></span> n = sprintf(buf_d,"%d",p); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (uint8_t*)buf_d, n, retain); } <span class="hljs-type"><span class="hljs-type">bool</span></span> publish_message(const <span class="hljs-type"><span class="hljs-type">char</span></span>* t, <span class="hljs-type"><span class="hljs-type">float</span></span> p, <span class="hljs-type"><span class="hljs-type">bool</span></span> retain) { //<span class="hljs-type"><span class="hljs-type">char</span></span> buf_f[<span class="hljs-number"><span class="hljs-number">18</span></span>]; String s(p, <span class="hljs-number"><span class="hljs-number">4</span></span>); // dtostrf(p, <span class="hljs-number"><span class="hljs-number">9</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>, buf_f); //<span class="hljs-type"><span class="hljs-type">int</span></span> n = sprintf(buf_f,"%f",p); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> client.publish(t, (uint8_t*)s.c_str(), s.length(), retain); } // recieve message <span class="hljs-type"><span class="hljs-type">void</span></span> callback(<span class="hljs-type"><span class="hljs-type">char</span></span>* topic, byte* payload, unsigned <span class="hljs-type"><span class="hljs-type">int</span></span> length) { <span class="hljs-type"><span class="hljs-type">char</span></span> p[length + <span class="hljs-number"><span class="hljs-number">1</span></span>]; memcpy(p, payload, length); p[length] = <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; String message(p); String t(topic); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.equals("home/water_count/spark/set")) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (message.equalsIgnoreCase("1")) { Particle.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(Particle.connected, <span class="hljs-number"><span class="hljs-number">10000</span></span>)) {publish_message("home/water_count/spark", <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {Particle.disconnect(); publish_message("home/water_count/spark", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Particle.disconnect(); publish_message("home/water_count/spark", <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith("home/water_count/valve/")) { <span class="hljs-type"><span class="hljs-type">int</span></span> m = message.toInt(); <span class="hljs-type"><span class="hljs-type">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>).toInt(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt; <span class="hljs-number"><span class="hljs-number">2</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) { set_valve(x, m); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { publish_message("home/water_count/valve/" + t.substring(<span class="hljs-number"><span class="hljs-number">23</span></span>,<span class="hljs-number"><span class="hljs-number">24</span></span>), valve[x].state , <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (t.startsWith("home/water_count/counter/")) { <span class="hljs-type"><span class="hljs-type">float</span></span> m = message.toFloat(); <span class="hljs-type"><span class="hljs-type">int</span></span> x = t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>).toInt(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (m &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; m &lt;= <span class="hljs-number"><span class="hljs-number">999999</span></span> &amp;&amp; x &gt; <span class="hljs-number"><span class="hljs-number">-1</span></span> &amp;&amp; x &lt;<span class="hljs-number"><span class="hljs-number">2</span></span>) { counter[x].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = m; } publish_message("home/water_count/counter/" + t.substring(<span class="hljs-number"><span class="hljs-number">25</span></span>,<span class="hljs-number"><span class="hljs-number">26</span></span>), counter[x].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> , <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } } <span class="hljs-type"><span class="hljs-type">void</span></span> setup() { //<span class="hljs-type"><span class="hljs-type">Serial</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(<span class="hljs-number"><span class="hljs-number">9600</span></span>); WiFi.<span class="hljs-keyword"><span class="hljs-keyword">on</span></span>(); WiFi.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (waitFor(WiFi.ready, <span class="hljs-number"><span class="hljs-number">5000</span></span>)) {mqtt_connect();} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) { pinMode(valve[i].pin, OUTPUT); digitalWrite(valve[i].pin, valve[i].state); pinMode(counter[i].pin, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span>); pinMode(sensor[i].pin, <span class="hljs-keyword"><span class="hljs-keyword">INPUT</span></span>); counter[i].state = digitalRead(counter[i].pin); pinMode(pressure[i], AN_INPUT); } pinMode(A4, INPUT_PULLUP); display.<span class="hljs-keyword"><span class="hljs-keyword">begin</span></span>(SSD1306_SWITCHCAPVCC, <span class="hljs-number"><span class="hljs-number">0x3C</span></span>); // initialize <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the I2C addr <span class="hljs-number"><span class="hljs-number">0x3C</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the <span class="hljs-number"><span class="hljs-number">128</span></span>x64) display.clearDisplay(); // clears the screen <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> buffer //Particle.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>(); } <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>() { currentMillis = millis(); //       MQTT  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_conected &gt;= <span class="hljs-number"><span class="hljs-number">30000</span></span> || previous_conected &gt; currentMillis) { previous_conected = currentMillis; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client.isConnected() &amp; wifi_uptime &gt; <span class="hljs-number"><span class="hljs-number">60</span></span>) { mqtt_connect(); } publish_message("home/water_count/rssi", WiFi.RSSI(), <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_wifi_uptime &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span> || previous_wifi_uptime &gt; currentMillis) { previous_wifi_uptime = currentMillis; WiFi.ready() ? wifi_uptime++ : wifi_uptime = <span class="hljs-number"><span class="hljs-number">0</span></span>; //<span class="hljs-keyword"><span class="hljs-keyword">work</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> button <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> display <span class="hljs-type"><span class="hljs-type">int</span></span> fg = digitalRead(A4); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { display_timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) { display.clearDisplay(); display.display(); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fg == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (display_timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) { display.clearDisplay(); // clears the screen <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> buffer display.setTextSize(<span class="hljs-number"><span class="hljs-number">2</span></span>); display.setTextColor(WHITE); display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); display.print("C="); display.println(counter[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">16</span></span>); display.print("H="); display.println(counter[<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>); display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">32</span></span>); display.print("Valve="); display.print(valve[<span class="hljs-number"><span class="hljs-number">0</span></span>].state); display.print("|"); display.println(valve[<span class="hljs-number"><span class="hljs-number">1</span></span>].state); display.setCursor(<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">48</span></span>); display.print("Sensor="); display.print(sensor[<span class="hljs-number"><span class="hljs-number">0</span></span>].state); display.print("|"); display.println(sensor[<span class="hljs-number"><span class="hljs-number">1</span></span>].state); display.display(); } display_timeout = <span class="hljs-number"><span class="hljs-number">10</span></span>; } } //counter <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - previous_counter_read &gt;= <span class="hljs-number"><span class="hljs-number">500</span></span> || previous_counter_read &gt; currentMillis) { previous_counter_read = currentMillis; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) { byte count_state = digitalRead(counter[i].pin); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state != counter[i].state) { counter[i].state = count_state; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count_state == <span class="hljs-number"><span class="hljs-number">0</span></span>) { counter[i].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> += <span class="hljs-number"><span class="hljs-number">0.01</span></span>; <span class="hljs-type"><span class="hljs-type">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; sprintf(buf18,"home/water_count/counter/%d", i); publish_message(buf18 , counter[i].<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } } //     byte sensor_state = digitalRead(sensor[i].pin); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor_state != sensor[i].state) // { sensor[i].state = sensor_state; sensor[i].timeout = SENSOR_TIMEOUT; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { sensor[i].timeout -= <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].timeout == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-type"><span class="hljs-type">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; sprintf(buf18,"home/water_count/sensor/%d", i); publish_message(buf18 , sensor[i].state, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor[i].state == <span class="hljs-number"><span class="hljs-number">0</span></span>) { set_valve(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); //<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> valve set_valve(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); //<span class="hljs-keyword"><span class="hljs-keyword">close</span></span> <span class="hljs-keyword"><span class="hljs-keyword">both</span></span> valve } } } } } // <span class="hljs-keyword"><span class="hljs-keyword">temp</span></span> onewire <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - start_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">299000</span></span> || start_temp_timer &gt; currentMillis) { //  start_temp_timer = currentMillis; presense0 = start_temp0(); presense1 = start_temp1(); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentMillis - read_temp_timer &gt;= <span class="hljs-number"><span class="hljs-number">300000</span></span> || read_temp_timer &gt; currentMillis) {//  read_temp_timer = currentMillis; start_temp_timer = currentMillis; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense0) read_temp0(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (presense1) read_temp1(); //preasure calc <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> send <span class="hljs-type"><span class="hljs-type">char</span></span> buf18[<span class="hljs-number"><span class="hljs-number">30</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>; i++) { sprintf(buf18,"home/water_count/pressure/%d", i); <span class="hljs-type"><span class="hljs-type">float</span></span> read_val = analogRead(pressure[i]); <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = (read_val - <span class="hljs-number"><span class="hljs-number">600.0</span></span>) / <span class="hljs-number"><span class="hljs-number">300.0</span></span> ; publish_message(buf18 , <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); } } //Particle.process(); client.<span class="hljs-keyword"><span class="hljs-keyword">loop</span></span>(); } <span class="hljs-type"><span class="hljs-type">void</span></span> mqtt_connect() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.<span class="hljs-keyword"><span class="hljs-keyword">connect</span></span>("water_count")) { //  spark     client.subscribe("home/water_count/spark/set"); publish_message("home/water_count/spark", Particle.connected() ? <span class="hljs-number"><span class="hljs-number">1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); client.subscribe("home/water_count/valve/+/set"); client.subscribe("home/water_count/counter/+/set"); } } <span class="hljs-type"><span class="hljs-type">bool</span></span> start_temp0() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds0.<span class="hljs-keyword"><span class="hljs-keyword">search</span></span>(addr0)) { ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;} ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr0, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr0[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;} ds0.<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>(); ds0.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(addr0); ds0.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-type"><span class="hljs-type">bool</span></span> start_temp1() { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( !ds1.<span class="hljs-keyword"><span class="hljs-keyword">search</span></span>(addr1)) { ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;} ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (OneWire::crc8(addr1, <span class="hljs-number"><span class="hljs-number">7</span></span>) != addr1[<span class="hljs-number"><span class="hljs-number">7</span></span>]) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>;} ds1.<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>(); ds1.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(addr1); ds1.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">0x44</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-type"><span class="hljs-type">bool</span></span> read_temp0() { //delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ds0.<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>(); ds0.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(addr0); ds0.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) { data[i] = ds0.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } int16_t raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-type"><span class="hljs-type">float</span></span> celsius = (<span class="hljs-type"><span class="hljs-type">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; publish_message("home/water_count/temp/0", celsius, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); //<span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(celsius); ds0.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-type"><span class="hljs-type">bool</span></span> read_temp1() { //delay(<span class="hljs-number"><span class="hljs-number">1000</span></span>); ds1.<span class="hljs-keyword"><span class="hljs-keyword">reset</span></span>(); ds1.<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>(addr1); ds1.<span class="hljs-keyword"><span class="hljs-keyword">write</span></span>(<span class="hljs-number"><span class="hljs-number">0xBE</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">9</span></span>; i++) { data[i] = ds1.<span class="hljs-keyword"><span class="hljs-keyword">read</span></span>(); } int16_t raw = (data[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | data[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-type"><span class="hljs-type">float</span></span> celsius = (<span class="hljs-type"><span class="hljs-type">float</span></span>)raw * <span class="hljs-number"><span class="hljs-number">0.0625</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (celsius &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> || celsius &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; publish_message("home/water_count/temp/1", celsius, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); //<span class="hljs-type"><span class="hljs-type">Serial</span></span>.println(celsius); ds1.reset_search(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-type"><span class="hljs-type">void</span></span> set_valve(<span class="hljs-type"><span class="hljs-type">int</span></span> vlv, byte state) { valve[vlv].state = state; digitalWrite(valve[vlv].pin, state); <span class="hljs-type"><span class="hljs-type">char</span></span> buf26[<span class="hljs-number"><span class="hljs-number">26</span></span>]; sprintf(buf26,"home/water_count/valve/%d", vlv); publish_message(buf26 , state , <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); }</code> </pre> <br></div></div><br>  Through MQTT we connect to the broker.  We monitor sensors and a helmet in the corresponding branches of mqtt events and values.  For example home / water_count / valve / 0 is a cold water drive.  home / water_count / counter / 0 - cold water meter readings. <br><br>  We subscribe to commands to change the status of the drive and set the current value of the meter (cold and hot water): <br><br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/valve/+/set"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.subscribe(<span class="hljs-string"><span class="hljs-string">"home/water_count/counter/+/set"</span></span>);</code> </pre> <br>  There is one button on the device - by pressing we turn on the screen, we draw the current readings of counters, sensors and taps.  OLED screen, quickly fade if done on all the time. <br><br><pre> <code class="hljs lisp">STARTUP(<span class="hljs-name"><span class="hljs-name">System</span></span>.enableFeature(<span class="hljs-name"><span class="hljs-name">FEATURE_RETAINED_MEMORY</span></span>))<span class="hljs-comment"><span class="hljs-comment">;</span></span></code> </pre> <br>  This is an interesting software and hardware feature of the stm controller; in the reference Particle it is called BackupSRAM.  Photon has a vbat pin - it's not battery power and not charging.  As long as there is voltage on this leg, the contents of 4kbyte SRAM are maintained when the controller is completely de-energized.  This eliminates the problem of EEPROM wear. <br><br>  In the code, variables that need to be driven into this memory are declared with the indication: retained.  In hardware, I implemented a 1.5F feed from a supercapacitor.  According to the datasheet, the memory will die at 1.6v, according to my poster experiments on the protoboard, it will come in 2 weeks with about my capacitor.  The logic of closing the taps when the sensors are triggered is ‚Äúautonomous‚Äù and does not depend on the connection to openhab.  There is a 3-way direct drive control switch - automatics, OFF (open taps), Close (close). <br><br>  The circuit board below: <br><br><img src="https://habrastorage.org/files/1a8/f4c/63d/1a8f4c63dba34f4e9905b703fabad0fd.png"><br><br>  The Eagle project together with custom libs can be downloaded <a href="https://yadi.sk/d/Lr7qIrxezNn7p">here</a> . <br><br>  The fee was made LUT, in the tracks is not small. <br><br><div class="spoiler">  <b class="spoiler_title">Water bath LUT's best friend</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/351/e37/1c3/351e371c3caf487d9f14f839f89402be.jpg"><br></div></div><br>  Power Supply.  We need 12 and 5 volts.  The donor is searched on ebay on the line: "hard drive power adapter 5v 12v", such as <a href="http://www.ebay.com/itm/36cm-Cable-12V-5V-AC-Power-Supply-HDD-HARD-DISK-DRIVE-IDE-Adapter-Converter-/161563404216">this</a> . <br><br><h3>  Housing </h3><br>  Printed with PLA plastic on a 3d printer (Tarantula Tevo).  Nozzle 0.4mm, layer 0.25mm.  The cover is also the base for mounting the controller board.  Base with power supply is attached to the wall.  The base with the lid is not fastened with screws, the lid tension is enough (like that of the grandmother of the lid on the jars of jam) and the layered structure of the walls works. <br><br>  3D model in the <a href="https://yadi.sk/d/lLUBQ8oQzP24r">archive</a> . <br><br><img src="https://habrastorage.org/files/945/110/37d/94511037d3734ad1a573e84e5fc426ef.png"><br><br><img src="https://habrastorage.org/files/5aa/546/c0b/5aa546c0b6dd41d58fd6b33bde08df74.png"><br><br>  Here's how it all looks mounted on the water distribution. <br><br><img src="https://habrastorage.org/files/cfb/293/f66/cfb293f66c3f4bb9ad2f46e812418918.jpg"><br><br><h3>  Openhab </h3><br>  Deployed to Orange Pi One under Armbian. <br><br><div class="spoiler">  <b class="spoiler_title">Config Item</b> <div class="spoiler_text"><pre> <code class="hljs javascript">  -    ,  . Number watercount_temp1 <span class="hljs-string"><span class="hljs-string">"T cool [%.1f ¬∞C]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp1:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_temp2 <span class="hljs-string"><span class="hljs-string">"T hot [%.1f ¬∞C]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/temp2:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_count0 <span class="hljs-string"><span class="hljs-string">"Count cool [%.2f ¬≥]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/0:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_count1 <span class="hljs-string"><span class="hljs-string">"Count hot [%.2f ¬≥]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/counter/1:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_pressure0 <span class="hljs-string"><span class="hljs-string">"P cool [%.2f .]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/0:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_pressure1 <span class="hljs-string"><span class="hljs-string">"P hot [%.2f .]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/pressure/1:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_sensor0 <span class="hljs-string"><span class="hljs-string">"Sensor0 is [MAP(water_sensor.map):%s]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/0:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_sensor1 <span class="hljs-string"><span class="hljs-string">"Sensor1 is [MAP(water_sensor.map):%s]"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/sensor/1:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_valve0 <span class="hljs-string"><span class="hljs-string">"Valve cool"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/0:state:default], &gt;[mqtt_bro:home/water_count/valve/0/set:command:*:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_valve1 <span class="hljs-string"><span class="hljs-string">"Valve hot"</span></span> (gWaterCount) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/valve/1:state:default], &gt;[mqtt_bro:home/water_count/valve/1/set:command:*:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">String</span></span> watercount_sendStr <span class="hljs-string"><span class="hljs-string">"LastVol:[%s]"</span></span> (gWaterCount) <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_sendCool <span class="hljs-string"><span class="hljs-string">"Send cool [%.2f ¬≥]"</span></span> (gWaterCount) <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_sendHot <span class="hljs-string"><span class="hljs-string">"Send hot [%.2f ¬≥]"</span></span> (gWaterCount) <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_sendSwitch <span class="hljs-string"><span class="hljs-string">"Autosend"</span></span> (gWaterCount) <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_rssi <span class="hljs-string"><span class="hljs-string">"WaterCount [%d dB]"</span></span> (gSpark_RSSI) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/rssi:state:default]"</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">Number</span></span> watercount_spark_state <span class="hljs-string"><span class="hljs-string">"WaterCount Spark"</span></span> (gSpark) { mqtt=<span class="hljs-string"><span class="hljs-string">"&lt;[mqtt_bro:home/water_count/spark:state:default], &gt;[mqtt_bro:home/water_count/spark/set:command:*:default]"</span></span> }</code> </pre> <br></div></div><br>  You need a small transformation rule for leakage sensor readings. <br><br><div class="spoiler">  <b class="spoiler_title">Transform configs</b> <div class="spoiler_text">  <b>transform \ water_sensor.map</b> <br>  1 = dry <br>  0 = wet <br>  undefined = undefined <br></div></div><br>  We create a page to manage: <br><br><div class="spoiler">  <b class="spoiler_title">Sitemap configs</b> <div class="spoiler_text">  <b>Sitemap</b> <br>  Text label = "Water Treatment" icon = "water" <br>  { <br>  Frame <br>  { <br>  Text item = watercount_temp1 <br>  Text item = watercount_count0 <br>  Text item = watercount_pressure0 <br>  Switch item = watercount_valve0 mappings = [1 = "Close", 0 = "Open"] <br>  } <br>  Frame <br>  { <br>  Text item = watercount_temp2 <br>  Text item = watercount_count1 <br>  Text item = watercount_pressure1 <br>  Switch item = watercount_valve1 mappings = [1 = "Close", 0 = "Open"] <br>  } <br>  Frame <br>  { <br>  Text item = watercount_sensor0 <br>  Text item = watercount_sensor1 <br>  } <br>  Frame <br>  { <br>  Switch item = watercount_sendSwitch mappings = [0 = "OFF", 1 = "ON"] <br>  Text item = watercount_sendStr <br>  Text item = watercount_sendCool <br>  Text item = watercount_sendHot <br>  } <br>  } <br></div></div><br>  And processing rules: <br><br><div class="spoiler">  <b class="spoiler_title">Rules configs</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor0" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Item watercount_sensor0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendTelegram("****_bot", "Sensor0 was wet less than 5 seconds") } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendTelegram("****_bot", "Sensor0 become dry") } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sendTelegram("****_bot", "Sensor0 was dry less than 5 seconds"); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendTelegram("****_bot", "Sensor0 become wet! Valves will be closed!") } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_sensor1" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Item watercount_sensor1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendTelegram("****_bot", "Sensor1 was wet less than 5 seconds") } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendTelegram("****_bot", "Sensor1 become dry") } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_sensor1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) == <span class="hljs-number"><span class="hljs-number">0</span></span>) { sendTelegram("****_bot", "Sensor1 was dry less than 5 seconds"); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendTelegram("****_bot", "Sensor1 become wet! Valves will be closed!") } } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_temp2" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Item watercount_temp2 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_temp2.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">37</span></span> ) { sendTelegram("****_bot", String::format("Hot water temp drop to %s", watercount_temp2.state.toString)); } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure0" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Item watercount_pressure0 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendTelegram("****_bot", String::format("Cool pressure drop to %s", watercount_pressure0.state.toString)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure0.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendTelegram("****_bot", String::format("Cool pressure rise to %s", watercount_pressure0.state.toString)); } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Check watercount_pressure1" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> Item watercount_pressure1 received <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendTelegram("****_bot", String::format("Hot pressure drop to %s", watercount_pressure1.state.toString)); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((watercount_pressure1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &gt; <span class="hljs-number"><span class="hljs-number">1</span></span> &amp;&amp; (watercount_pressure1.historicState(now.minusSeconds(<span class="hljs-number"><span class="hljs-number">3</span></span>)).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType) &lt;= <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendTelegram("****_bot", String::format("Hot pressure rise to %s", watercount_pressure1.state.toString)); } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Generate send string counters" //every <span class="hljs-number"><span class="hljs-number">24</span></span> day <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> mounth <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">00.01</span></span> minutes <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 1 24 1/1 ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaCool = (watercount_count0.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() var <span class="hljs-type"><span class="hljs-type">float</span></span> deltaHot = (watercount_count1.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() - (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (deltaCool &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; deltaHot &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { watercount_sendStr.postUpdate(String::format(" %.2f / %.2f 3", deltaCool, deltaHot)) watercount_sendCool.state = watercount_count0.state watercount_sendHot.state = watercount_count1.state sendTelegram("****_bot", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3. %s", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), watercount_sendStr.state.toString())) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { watercount_sendSwitch.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>) sendTelegram("****_bot", "Current counters value less than sended last time. Turn off autosend.") } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Send string counters" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 23 24 1/1 ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_sendSwitch.state == <span class="hljs-number"><span class="hljs-number">1</span></span>) { sendMail("uk@uk.ru", " 23,  5, . 23", String::format(" 23,  5, . 23.  ‚Ññ2560097 (.) = %.2f 3. C ‚Ññ2538996 (.) = %.2f 3", (watercount_sendCool.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue(), (watercount_sendHot.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType).floatValue())); sendTelegram("****_bot", "Send email with watercount values"); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendTelegram("****_bot", "Can't send email with watercount values - autosend is OFF."); } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Rotate valves" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 05 25 1/1 ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (watercount_valve0.state == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; watercount_valve1.state == <span class="hljs-number"><span class="hljs-number">0</span></span>) { watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">1</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) watercount_valve0.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) watercount_valve1.postUpdate(<span class="hljs-number"><span class="hljs-number">0</span></span>) sendTelegram("****_bot", "Valves was rotated."); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sendTelegram("****_bot", "Can't rotate valves, it's closed."); } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br></div></div><br>  To send messages, I do not use the built-in functionality of the android openhab application, as well as integrating with their cloud.  I like the Telegram bot.  How to configure and enable bots can be found on the <a href="https://github.com/openhab/openhab/wiki/Actions">wiki</a> .  To send emails from the gmail mailbox, if you have two-factor authentication, you need to enable a one-time password for the email application and set this particular password in the openhab config. <br><br>  Walk by the rules. <br><br>  <i>Check watercount_sensor</i> - the controller sends new leakage sensor values ‚Äã‚Äãonly when changing the value or if there was a false positive (less than 10 cycles).  We analyze the incoming and historical significance, form informational messages.  There is a nuance - an attempt to get prevoiusItem constantly gives the current value, did not find a solution - I take the value "-3 sec", if someone overcame - write to comments or in a personal. <br><br>  <i>Check watercount_temp2</i> - we check, if it is less than 37, it means that the hot water has become cold, it is necessary to turn on the flow-through heater upon arrival. <br><br>  <i>Check watercount_pressure</i> - we analyze the current and previous value, react with a message to drop below 1 atm and to rise above it. <br><br>  <i>Generate send string counters</i> - starts on cron on the 24th day of each month at 1 am.  We check that the values ‚Äã‚Äãare now higher than those sent last time.  If less - turn off auto send and create an alert.  If OK - remember the values ‚Äã‚Äãof the counters to be sent to the Criminal Code, send the future letter body to the telegrams.  At the same time in watercount_sendStr we save how much we have consumed over the past month. <br><br>  <i>Generate send string counters</i> - starts on cron on the 24th at 23.00.  Checks if auto-send is on, if on - a counter of the value of the counters is sent to the control company mail.  It turns out that I have 24 numbers all day, something to fix or just cut down auto-send if an error has arrived in the telegrams. <br><br>  <b>Update by comment</b> .  <i>Rotate valves</i> - a rule for closing / opening the tap once a month against boiling.  On the 25th at 5 am, in order not to get to the work of the dishwasher or the washer, but even if it gets in, it is not critical, the overlap of the water will be about 3-4 seconds. <br><br>  <b>And only here begins the smart home ...</b> <br>  Combining systems in a single point (openhab) allows you to build logic that is not accessible to a set of autonomous systems.  For example: an event of an increase in the water meter came - the security system is active, the entrance door locks are closed, the electricity consumption of the dishwasher and the washer is less than 5 W - it means that there is a leakage past the sensors.  We form a team to close the cranes, send a message to the bot in Telegram.  But this is like a thread later. </div><p>Source: <a href="https://habr.com/ru/post/399459/">https://habr.com/ru/post/399459/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../399449/index.html">DNA is only half the chromosome volume. Everything else is a shell of unknown functionality.</a></li>
<li><a href="../399451/index.html">Why we do not have infant memories</a></li>
<li><a href="../399453/index.html">Five forms of blockchain money available now.</a></li>
<li><a href="../399455/index.html">Not only home appliances: What else is there in Audiomania for music lovers, amateurs and musicians</a></li>
<li><a href="../399457/index.html">Russian FinTech Meetup # 2: Trading in the Era of Modern Digital Technologies</a></li>
<li><a href="../399461/index.html">Artificial intelligence will help people get rid of phobias and fears</a></li>
<li><a href="../399463/index.html">Multicopters have learned how to sit down on the roofs of moving cars</a></li>
<li><a href="../399465/index.html">Kak2tak.tk: it means the idea was not so bad ...</a></li>
<li><a href="../399469/index.html">The Pix2pix Neural Network realistically colors pencil sketches and black and white photos</a></li>
<li><a href="../399471/index.html">Space Housing, Part 5: How we will live on Mercury (or not)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>