<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to fill an MS SQL database with heterogeneous random data or 17 hours of waiting</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, 
 The developer often has the task of conducting a test of the database on large amounts of data, but where can we get this very data? After...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to fill an MS SQL database with heterogeneous random data or 17 hours of waiting</h1><div class="post__text post__text-html js-mediator-article">  Good day, <br>  The developer often has the task of conducting a test of the database on large amounts of data, but where can we get this very data?  After all, everyone knows that the structure of the database can reach over 50 tables that you do not really want to fill with your hands.  And if you think about foreign keys and composite primary keys whose values ‚Äã‚Äãare associated with other tables, then the head starts to heat up proportionally to the old AMD with the cooling turned off. <br>  On the Internet, there are many solutions for filling a database with random values ‚Äã‚Äãusing .NET, C ++, Java, etc.  This article will highlight the topic of filling a database with random values ‚Äã‚Äãwith T-SQL using MS SQL Server. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  A few days ago I received the task of filling a database running with MS SQL Server with random data.  Moreover, the entire implementation should be performed only by means of T-SQL.  After a long search for such solutions on resources, I came to the conclusion that I would have to do it myself and set to work.  Not being <s>(until recently)</s> an expert on T-SQL, but having only a set of knowledge from the course ‚ÄúDatabase‚Äù of the university, the implementation turned out to be very ‚Äúcrutch‚Äù and slow (the main problem), but it works. <br><br>  The main purpose of this article is to discuss with the habr community the possibility to optimize the solution, or its Ctrl + A and Shift + Del with reference to the ready-made implementation. <br><br>  And so, what was at the entrance: <br><ul><li>  A database with a number of related tables; </li><li>  All primary keys (further PK) - auto increments; </li><li>  There are tables containing a composite PK consisting of foreign keys (further FK). </li></ul><br>  What with all this had to be done: <br><ul><li>  Generate random data depending on the type of attribute (column); </li><li>  Skip autoincrement filling. </li><li>  Fill FK child tables with random PK parent tables. </li></ul><br><h3>  Implementation </h3><br>  The whole implementation received a view of each other's calling procedures: <br><ul><li>  randomString - generation of a random string of characters of a given length .; </li><li>  randomInt - generation of a random number from the specified range; </li><li>  generateDataByType - gets the type of the attribute (column) of the table and calls the desired procedure for generating random values. </li><li>  insertRandomData - the main procedure, asking for input only the name of the table and the number of records that you want to add </li></ul><br>  I propose to dwell on each procedure in detail.  (it is assumed that the reader, <s>unlike the author</s> , is familiar with the basics of SQL) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">randomString</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[randomString] @inputSize <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @outputRandomString <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-comment"><span class="hljs-comment">--        . END;</span></span></code> </pre> <br></div></div><br>  I used one of the first implementation options I got from the MS SQL forum.  The procedure receives the length of the string as input, and the output produces a string of random characters of the NVARCHAR (MAX) type of the required size.  In this case, the implementation is not critical, since it does not have significant time costs for large amounts of data.  We go further. <br><br><div class="spoiler">  <b class="spoiler_title">randomInt</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[randomInt] @inputSize <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, @outputInteger <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">output</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @TEMP <span class="hljs-built_in"><span class="hljs-built_in">bigint</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @TEMP = <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(<span class="hljs-string"><span class="hljs-string">'999999999999999999'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,@inputSize) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @outputInteger = (<span class="hljs-keyword"><span class="hljs-keyword">ABS</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">CHECKSUM</span></span>(NewId())) % @TEMP) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span></code> </pre><br></div></div><br>  The function is small and not very beautiful (especially the place with SUBSTRING), but it completely suited me with its speed, so for now we leave it and move on. <br><br><div class="spoiler">  <b class="spoiler_title">generateDataByType</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[generateDataByType] @tableName <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">40</span></span>), <span class="hljs-comment"><span class="hljs-comment">--  ,      @inputColumName nvarchar(40), --  ,      @inputType nvarchar(10), @inputSize int, @outputString nvarchar(max) output --  AS BEGIN DECLARE @isFK bit = 0; DECLARE @FKName NVARCHAR(MAX); DECLARE @ParentTable NVARCHAR(MAX); -- @tableName     FK (ccu.table_name)     (references_table)           DECLARE columnsCursor1 CURSOR FOR SELECT kcu.column_name, ccu.table_name AS references_table FROM information_schema.table_constraints tc INNER JOIN information_schema.key_column_usage kcu ON tc.constraint_catalog = kcu.constraint_catalog AND tc.constraint_schema = kcu.constraint_schema AND tc.constraint_name = kcu.constraint_name INNER JOIN information_schema.referential_constraints rc ON tc.constraint_catalog = rc.constraint_catalog AND tc.constraint_schema = rc.constraint_schema AND tc.constraint_name = rc.constraint_name AND tc.constraint_type = 'FOREIGN KEY' INNER JOIN information_schema.constraint_column_usage ccu ON rc.unique_constraint_catalog = ccu.constraint_catalog AND rc.unique_constraint_schema = ccu.constraint_schema AND rc.unique_constraint_name = ccu.constraint_name WHERE tc.table_name = @tableName OPEN columnsCursor1; FETCH NEXT FROM columnsCursor1 INTO @FKName,@ParentTable --     WHILE @@FETCH_STATUS = 0 BEGIN -- ,        @inputColumName       IF (@inputColumName = @FKName) BEGIN SET @isFK = 1; --   true -   FK         . DECLARE @selectedPK NVARCHAR(MAX); DECLARE @params NVARCHAR(MAX); --           ,         SET @selectedPK = N'SELECT TOP 1 @outputString =' + @FKName + ' FROM ' + @ParentTable + ' ORDER BY NEWID(); '; SET @params = N'@FKName NVARCHAR(MAX), @ParentTable NVARCHAR(MAX), @outputString NVARCHAR(MAX) OUTPUT'; EXEC sp_executesql @selectedPK , @params, @FKName = @FKName, @ParentTable = @ParentTable, @outputString = @outputString OUTPUT; END FETCH NEXT FROM columnsCursor1 INTO @FKName,@ParentTable END; CLOSE columnsCursor1; DEALLOCATE columnsCursor1; --          . IF (@isFK &lt;&gt; 1) BEGIN IF (@inputType = 'nvarchar') BEGIN EXECUTE randomString @inputSize, @outputRandomString = @outputString OUTPUT ; END ELSE --          . END</span></span></code> </pre><br></div></div><br>  And so, without reaching the "main" procedure, we get <b>huge</b> time costs when filling in the foreign key of the table with data from the found parent table.  If this search is noticed by substituting random numbers in a given range, productivity increases dramatically.  Perhaps it's a SELECT from the system table and random sorting.  For comparison: writing 1 million rows to a table without FK takes about 20 minutes, writing 1 million rows to a table with FK takes more than 17 hours.  <i>For reference, writing one million lines of pure INSERT into one field takes 6-10 seconds.</i> <br>  At the moment, I could not think of anything more optimal, which was the impetus for writing this article, but about this in conclusion. <br><br><div class="spoiler">  <b class="spoiler_title">insertRandomData</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> [dbo].[insertRandomData] @childTableName <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>), @insertRowCount <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @i <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-comment"><span class="hljs-comment">/*  */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @columnName <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @columnType <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @columnLenght <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @columnUniq <span class="hljs-built_in"><span class="hljs-built_in">INT</span></span>; <span class="hljs-comment"><span class="hljs-comment">/*      */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @insertQuery <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @insertColumnsQuery <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @insertValuesQuery <span class="hljs-built_in"><span class="hljs-built_in">VARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @params <span class="hljs-keyword"><span class="hljs-keyword">NVARCHAR</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @insertColumnsQuery = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @insertValuesQuery = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHILE</span></span> (@i &lt; @insertRowCount) <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> columnsCursor <span class="hljs-keyword"><span class="hljs-keyword">CURSOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-comment"><span class="hljs-comment">----------        @childTableName    ----- SELECT all_columns.column_id, all_columns.name, systypes.name, all_columns.max_length FROM SYS.all_objects join SYS.all_columns on all_columns.object_id = all_objects.object_id join SYS.systypes on all_columns.system_type_id = systypes.xtype WHERE all_objects.name like @childTableName and all_objects.type = 'U' AND systypes.name &lt;&gt; 'sysname'/*-     2   ( )*/ ORDER BY all_columns.column_id; OPEN columnsCursor; --  ,   ID- (   ) FETCH NEXT FROM columnsCursor INTO @columnUniq, @columnName, @columnType, @columnLenght; FETCH NEXT FROM columnsCursor INTO @columnUniq, @columnName, @columnType, @columnLenght; DECLARE @tempLenght INT = 0; WHILE @@FETCH_STATUS = 0 BEGIN /*   (   -1   30) , -1   MAX  ,         30 . */ IF(@columnLenght &gt;= 0) BEGIN SET @tempLenght = @columnLenght; END ELSE BEGIN SET @tempLenght = 30; END --    INSERT,   . SET @insertColumnsQuery = @insertColumnsQuery + @columnName + ', '; DECLARE @TEMPValues nvarchar(MAX) = '' ---  generateStringByType,    TEMPValues--- EXECUTE generateDataByType @childTableName, @columnName, @columnType, @tempLenght, @outputString = @TEMPValues OUTPUT --     INSERT,  . SET @insertValuesQuery = @insertValuesQuery +'''' + @TEMPValues + ''',' FETCH NEXT FROM columnsCursor INTO @columnUniq, @columnName, @columnType, @columnLenght; END; --         INSERT SET @insertColumnsQuery = SUBSTRING(@insertColumnsQuery, 1, LEN(@insertColumnsQuery)-1); SET @insertValuesQuery = SUBSTRING(@insertValuesQuery,1, LEN(@insertValuesQuery)-1); --       . SET @insertQuery = N'INSERT INTO ' + @childTableName + N' (' + @insertColumnsQuery + N') VALUES (' + @insertValuesQuery + ') ;'; EXEC(@insertQuery); --  </span></span></code> </pre><br></div></div><br>  This procedure is ‚Äúrelatively‚Äù not time-consuming, although it climbs into the system tables to get the structure of the incoming table, but contains several obvious weak points.  For example, a jump through the first element of the table in the hope that it is PK. <br><br><h3>  Conclusion </h3><br>  The above can be useful for someone, for which the author sincerely hopes, since he could not find such solutions.  But the decision presented to the community is not optimal in terms of time and requires major changes.  I hope that everyone who is interested will help me bring it to mind (if that makes sense) or point a different way. </div><p>Source: <a href="https://habr.com/ru/post/220185/">https://habr.com/ru/post/220185/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220173/index.html">Blogger Template Designer</a></li>
<li><a href="../220177/index.html">Cyclical and temporary shutdown of event receivers in SharePoint</a></li>
<li><a href="../220179/index.html">PRT Transport Management System</a></li>
<li><a href="../220181/index.html">Installing and configuring the LAMP web server for PHP development</a></li>
<li><a href="../220183/index.html">HTML in Unity3D or how to cross a hedgehog with a snake</a></li>
<li><a href="../220187/index.html">Import data into online stores: an algorithm that will make your life easier</a></li>
<li><a href="../220189/index.html">Positive Technologies invites students to the All-Russian Information Security Olympiad</a></li>
<li><a href="../220191/index.html">Security Studies in Studios / Agencies</a></li>
<li><a href="../220193/index.html">Live again!</a></li>
<li><a href="../220199/index.html">C ++ User Group, meeting in Nizhny Novgorod</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>