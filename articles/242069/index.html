<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Binary Serialization in Unity 3D / Visual Studio Application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of developing a plug-in for Unity 3D, it was necessary to make storage of a relatively large amount of data. In my case, this is the st...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Binary Serialization in Unity 3D / Visual Studio Application</h1><div class="post__text post__text-html js-mediator-article">  In the process of developing a plug-in for Unity 3D, it was necessary to make storage of a relatively large amount of data.  In my case, this is the storage of node data for visual programming (also applicable to the save game implementation).  The storage method must meet the specified requirements: <br><br><ul><li>  High processing speed; </li><li>  High level of data compression; </li><li>  The ability to store their classes and structures; </li><li>  Reading / writing in Unity, as well as in a separate program (Visual Studio Application, C #); </li><li>  Work with old versions of the saved data (when changing the structure); </li><li>  Should not require the presence of additionally installed packages and other software from users; </li><li>  Work on mobile devices; </li><li>  Language: C #. </li></ul><br>  As a result, I stopped at binary serialization.  This method meets all specified requirements, but makes it impossible to view and edit already serialized data in a text editor.  But this is not a problem, since the program for editing is intended for this. <br><a name="habracut"></a><br><h3>  Program </h3><br>  The first task was to do serialization and de-serialization of data in the program.  I wrote a simple program that will edit and serialize the data of the nodes in the custom Nodes class as (ID, Object) in the Dictionary &lt;short, data&gt; collection.  There will be a lot of objects, so the node ID will be stored in a 16-bit short data type. <br>  Class Nodes, to begin with will be the easiest.  Mark it as Serializable. <br><br><pre><code class="hljs pgsql">[<span class="hljs-keyword"><span class="hljs-keyword">Serializable</span></span>()] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NodesV1 { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">Name</span></span>;//  <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">Text</span></span>;// }</code> </pre> <br><img src="https://habrastorage.org/files/fb2/296/f1f/fb2296f1feb441bb961eae3340214c19.jpg"><br>  (program code at the end of the article) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The newly created node should be added to the first free position in the collection, for this I used the code: <br><br><pre> <code class="hljs pgsql">short CalcNewItemIndex() { short <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> = <span class="hljs-number"><span class="hljs-number">-1</span></span>; //  <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Nodes.Name.ContainsKey(++<span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>)); //      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span>; //    }</code> </pre><br><h3>  Serialization </h3><br>  Two steps that need to be performed at this stage are to force the serializer to work with our NodesV1 class and take into account that the data structure of the serializable / deserialized object will change (it will change more than once during the development process). <br><br>  The second step is not necessary, but if you change the structure, deserialize the file with the previous structure does not work (but in some cases, if you add new data to the end, then the old file usually passes without problems). <br><br>  First you need a class that will work on serialization / deserialization, in it we will force the serializer to work with our class. <br><div class="spoiler">  <b class="spoiler_title">Serialization / deserialization class code</b> <div class="spoiler_text"><pre> <code class="hljs haskell"> public <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">SaveLoad_Data</span></span> { <span class="hljs-type"><span class="hljs-type">BinaryFormatter</span></span> bformatter = new <span class="hljs-type"><span class="hljs-type">BinaryFormatter</span></span>(); public void <span class="hljs-type"><span class="hljs-type">Save</span></span>(object <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">, string filepath)//  { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Stream</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Open</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath</span></span></span><span class="hljs-class"> + ".</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">", </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FileMode</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Create</span></span></span><span class="hljs-class">);//  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BinaryFormatter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BinaryFormatter</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Binder</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassBinder</span></span></span><span class="hljs-class">();//      </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">);//</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Close</span></span></span><span class="hljs-class">();//  } public object </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Load</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath</span></span></span><span class="hljs-class">)//  { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReadAllBytes</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath</span></span></span><span class="hljs-class"> + ".</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">");//   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MemoryStream</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MemoryStream(data)</span></span></span><span class="hljs-class">;//     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Binder</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassBinder</span></span></span><span class="hljs-class">();//  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodesV1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_NodesV1</span></span></span><span class="hljs-class"> = (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodesV1</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deserialize(stream)</span></span></span><span class="hljs-class">;// </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Close</span></span></span><span class="hljs-class">();//  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_NodesV1</span></span></span><span class="hljs-class">;//  } } public sealed class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassBinder</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SerializationBinder</span></span></span><span class="hljs-class"> // { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BindToType</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assemblyName</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeName</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsNullOrEmpty(assemblyName)</span></span></span><span class="hljs-class"> &amp;&amp; !</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsNullOrEmpty(typeName)</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeToDeserialize</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assemblyName</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Assembly</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetExecutingAssembly</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FullName</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeToDeserialize</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetType</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Format</span></span></span><span class="hljs-class">("{0}, {1}", typeName, assemblyName)); return typeToDeserialize; } return null; } }</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Starting serialization / deserialization</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">NodesV1 Nodes;//   ,    private <span class="hljs-type"><span class="hljs-type">void</span></span> Form1_Load(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e) //   { Nodes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NodesV1();//   ,       //  Nodes.Name = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt;(); Nodes.Text = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt;(); } private <span class="hljs-type"><span class="hljs-type">void</span></span> button1_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e)// { SaveLoad_Data _SaveNodes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveLoad_Data();//     _SaveNodes.Save(Nodes, @"C:\UnityProjects\Blueprint_Editor_Plugin\Assets\Resources\HabrSerialisText");// } private <span class="hljs-type"><span class="hljs-type">void</span></span> button2_Click(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> sender, EventArgs e)// { SaveLoad_Data _LoadNodes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveLoad_Data();//     Nodes = (NodesV1)_LoadNodes.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(@"C:\UnityProjects\Blueprint_Editor_Plugin\Assets\Resources\HabrSerialisText"); // }</code> </pre><br></div></div><br>  We will save the file to the Unity project folder: Assets \ Resources.  It is from the Resources folder that it will work correctly on Unity reading a file on mobile devices, etc. <br><br>  Now step two, resolve the issue with the deserializer version.  In the first two bytes of the binary file, we will write the version of the serializer.  During deserialization, we read the version, remove the two bytes and start the corresponding version deserializer.  The serializer version will be determined by the numbers at the end of the class name (NodesV1 - version ‚Äù1‚Äù). <br><br>  Add a version check: <br><br><pre> <code class="hljs haskell"> public <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-type"><span class="hljs-type">SaveLoad_Data</span></span> { <span class="hljs-type"><span class="hljs-type">BinaryFormatter</span></span> bformatter = new <span class="hljs-type"><span class="hljs-type">BinaryFormatter</span></span>(); public void <span class="hljs-type"><span class="hljs-type">Save</span></span>(object <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">, string filepath)//  { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Version</span></span></span><span class="hljs-class">;//   </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BinaryFormatter</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BinaryFormatter</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Binder</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassBinder</span></span></span><span class="hljs-class">();//        </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MemoryStream</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">streamReader</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MemoryStream</span></span></span><span class="hljs-class">(); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Serialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">streamReader</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">);//</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">C</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Version</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Convert</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToInt32</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetType</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToString</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Replace</span></span></span><span class="hljs-class">("</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">HabrSerialis</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodesV</span></span></span><span class="hljs-class">", ""));//       </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arr</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">streamReader</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToArray</span></span></span><span class="hljs-class">();//   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versionBytes</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitConverter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetBytes(Version)</span></span></span><span class="hljs-class">;//    </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arr</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class"> + 4]; // // ,       . </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> - 4  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Array</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Copy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arr</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">, 4, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arr</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">);//  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Array</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Copy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versionBytes</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versionBytes</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class">);//  </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WriteAllBytes</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath</span></span></span><span class="hljs-class"> + ".</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">", </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">);//   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">streamReader</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Close</span></span></span><span class="hljs-class">();//  } public object </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Load</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath</span></span></span><span class="hljs-class">)//  { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">back</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">File</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ReadAllBytes</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filepath</span></span></span><span class="hljs-class"> + ".</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">txt</span></span></span><span class="hljs-class">");//   </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versionBack</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BitConverter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ToInt32</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">back</span></span></span><span class="hljs-class">, 0);//  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">byte</span></span></span><span class="hljs-class">[</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">back</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class"> - 4]; //     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Array</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Copy</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">back</span></span></span><span class="hljs-class">, 4, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, 0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">back</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Length</span></span></span><span class="hljs-class"> - 4);//       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MemoryStream</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">MemoryStream(data)</span></span></span><span class="hljs-class">;//     </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Binder</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassBinder</span></span></span><span class="hljs-class">();//  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">versionBack</span></span></span><span class="hljs-class"> == 1)//   1 { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodesV1</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_NodesV1</span></span></span><span class="hljs-class"> = (</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">NodesV1</span></span></span><span class="hljs-class">)</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bformatter</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Deserialize(stream)</span></span></span><span class="hljs-class">;//   1 </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Close</span></span></span><span class="hljs-class">();//  </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_NodesV1</span></span></span><span class="hljs-class">; } return null; } } public sealed class </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassBinder</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SerializationBinder</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">override</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">BindToType</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assemblyName</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeName</span></span></span><span class="hljs-class">) { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">if</span></span></span><span class="hljs-class"> (!</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsNullOrEmpty(assemblyName)</span></span></span><span class="hljs-class"> &amp;&amp; !</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">string</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IsNullOrEmpty(typeName)</span></span></span><span class="hljs-class">) { </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeToDeserialize</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">null</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">assemblyName</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Assembly</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetExecutingAssembly</span></span></span><span class="hljs-class">().</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FullName</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">typeToDeserialize</span></span></span><span class="hljs-class"> = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Type</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">GetType</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">String</span></span></span><span class="hljs-class">.</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Format</span></span></span><span class="hljs-class">("{0}, {1}", typeName, assemblyName)); return typeToDeserialize; } return null; } }</span></span></code> </pre><br><br>  Now we will create several nodes in the program and start the serialization.  We still need the resulting file. <br>  Now check if it works.  Suppose our structure has changed, we have added the Permission (Perm) variable.  Create a class with a new structure: <br><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">Serializable()</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NodesV2</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Name; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; Text; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt; Perm; }</code> </pre><br>  We change the NodesV1 class to NodesV2 in the program code.  At startup, we also initialize a new variable: <br><br><pre> <code class="hljs cs">Nodes.Perm = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">short</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;();</code> </pre><br>  Now the fun part.  In the file with the old data structure, there is no Perm variable, and we need to deserialize according to the old structure and return it to the new one. <br><br>  In each case, there will be its own handling of this situation, but I will simply create this collection with false values. <br><br>  Let's change the version verification code in the deserializer: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (versionBack == <span class="hljs-number"><span class="hljs-number">1</span></span>)//  <span class="hljs-number"><span class="hljs-number">1</span></span> { NodesV1 _NodesV1 = (NodesV1)bformatter.Deserialize(stream);//   <span class="hljs-number"><span class="hljs-number">1</span></span> stream.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>();//  NodesV2 NodeV2ret = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NodesV2();//      NodeV2ret.Name = _NodesV1.Name; //    NodeV2ret.Text = _NodesV1.Text; //    NodeV2ret.Perm = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;(); //     <span class="hljs-number"><span class="hljs-number">1</span></span>  Perm <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (KeyValuePair&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> NodeV2ret.Name) { NodeV2ret.Perm.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>.Key, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);//  <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NodeV2ret; // } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (versionBack == <span class="hljs-number"><span class="hljs-number">2</span></span>)//  <span class="hljs-number"><span class="hljs-number">2</span></span> -   (   )  { NodesV2 _NodesV2 = (NodesV2)bformatter.Deserialize(stream);//   stream.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>();//  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _NodesV2; }</code> </pre><br>  After the changes, the deserialization of the file with the old structure is successful. <br><br><h3>  Unity </h3><br>  Create a C # script that deserializes the binary and will display the name and text of the node in the GUI.  You can also change this data and serialize it back. <br><div class="spoiler">  <b class="spoiler_title">Unity script code</b> <div class="spoiler_text"><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UnityEngine; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.Serialization.Formatters.Binary; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Runtime.Serialization; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Reflection; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> HabrSerialis : MonoBehaviour { NodesV2 Nodes; SaveLoad_Data _LoadNodes; <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>() { Nodes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NodesV2(); _LoadNodes = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> SaveLoad_Data(); Nodes = (NodesV2)_LoadNodes.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>("HabrSerialisText"); } <span class="hljs-type"><span class="hljs-type">float</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>; <span class="hljs-type"><span class="hljs-type">void</span></span> OnGUI() { <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (short i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; Nodes.Name.Count; i++) { Nodes.Name[i] = GUI.TextField(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rect(<span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>), Nodes.Name[i]); Nodes.Text[i] = GUI.TextArea(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rect(<span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span>, <span class="hljs-number"><span class="hljs-number">130</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">200</span></span>), Nodes.Text[i]); <span class="hljs-keyword"><span class="hljs-keyword">Offset</span></span> += <span class="hljs-number"><span class="hljs-number">120</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (GUI.Button(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Rect(<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-number"><span class="hljs-number">70</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>), "Save")) { _LoadNodes.Save(Nodes, "HabrSerialisText"); } } } [<span class="hljs-keyword"><span class="hljs-keyword">Serializable</span></span>()] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NodesV1 { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">Name</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">Text</span></span>; } [<span class="hljs-keyword"><span class="hljs-keyword">Serializable</span></span>()] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> NodesV2 { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">Name</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">Text</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt; Perm; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> SaveLoad_Data { private <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>; BinaryFormatter bformatter = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BinaryFormatter(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">void</span></span> Save(<span class="hljs-keyword"><span class="hljs-keyword">object</span></span> data, string filepath)//  { BinaryFormatter bformatter = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> BinaryFormatter(); bformatter.Binder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ClassBinder();//        MemoryStream streamReader = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MemoryStream(); bformatter.Serialize(streamReader, data);//C Version = Convert.ToInt32(data.GetType().ToString().Replace("NodesV", ""));//       byte[] arr = streamReader.ToArray(); byte[] versionBytes = BitConverter.GetBytes(<span class="hljs-keyword"><span class="hljs-keyword">Version</span></span>);//    byte[] result = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[arr.Length + <span class="hljs-number"><span class="hljs-number">4</span></span>]; // // ,       . <span class="hljs-type"><span class="hljs-type">int</span></span> - <span class="hljs-number"><span class="hljs-number">4</span></span>  <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>(arr, <span class="hljs-number"><span class="hljs-number">0</span></span>, result, <span class="hljs-number"><span class="hljs-number">4</span></span>, arr.Length);//  <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>(versionBytes, <span class="hljs-number"><span class="hljs-number">0</span></span>, result, <span class="hljs-number"><span class="hljs-number">0</span></span>, versionBytes.Length);//  File.WriteAllBytes("Assets/Resources/" + filepath + ".txt", result);//   streamReader.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>();//  } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(string filepath)//  { TextAsset asset = Resources.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span>(filepath) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TextAsset;//     byte[] back = asset.bytes; <span class="hljs-type"><span class="hljs-type">int</span></span> versionBack = BitConverter.ToInt32(back, <span class="hljs-number"><span class="hljs-number">0</span></span>);//  byte[] data = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> byte[back.Length - <span class="hljs-number"><span class="hljs-number">4</span></span>]; //     <span class="hljs-keyword"><span class="hljs-keyword">Array</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Copy</span></span>(back, <span class="hljs-number"><span class="hljs-number">4</span></span>, data, <span class="hljs-number"><span class="hljs-number">0</span></span>, back.Length - <span class="hljs-number"><span class="hljs-number">4</span></span>);//       Stream stream = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> MemoryStream(data);//     bformatter.Binder = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ClassBinder();//  //////////////////////////////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (versionBack == <span class="hljs-number"><span class="hljs-number">1</span></span>)//  <span class="hljs-number"><span class="hljs-number">1</span></span> { NodesV1 _NodesV1 = (NodesV1)bformatter.Deserialize(stream);//   <span class="hljs-number"><span class="hljs-number">1</span></span> stream.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>();//  NodesV2 NodeV2ret = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> NodesV2();//     NodeV2ret.Name = _NodesV1.Name; //    NodeV2ret.Text = _NodesV1.Text; //    NodeV2ret.Perm = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>&lt;short, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;(); //     <span class="hljs-number"><span class="hljs-number">1</span></span>  Perm <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (KeyValuePair&lt;short, string&gt; <span class="hljs-type"><span class="hljs-type">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> NodeV2ret.Name) { NodeV2ret.Perm.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(<span class="hljs-type"><span class="hljs-type">name</span></span>.Key, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);//  } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> NodeV2ret;//  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (versionBack == <span class="hljs-number"><span class="hljs-number">2</span></span>)//  <span class="hljs-number"><span class="hljs-number">2</span></span> -   (   )  { NodesV2 _NodesV2 = (NodesV2)bformatter.Deserialize(stream);//   stream.<span class="hljs-keyword"><span class="hljs-keyword">Close</span></span>();//  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _NodesV2; } ////////////////////////////////////////////////////////////// <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> sealed <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ClassBinder : SerializationBinder { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> BindToType(string assemblyName, string typeName) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!string.IsNullOrEmpty(assemblyName) &amp;&amp; !string.IsNullOrEmpty(typeName)) { <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> typeToDeserialize = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; assemblyName = Assembly.GetExecutingAssembly().FullName; typeToDeserialize = <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>.GetType(String.Format("{0}, {1}", typeName, assemblyName)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> typeToDeserialize; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br></div></div><br>  As you can see, the class code that handles the serialization is the same, only instead: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] back = File.ReadAllBytes(filepath + <span class="hljs-string"><span class="hljs-string">".txt"</span></span>);</code> </pre><br>  we will use: <br><pre> <code class="hljs cs">TextAsset asset = Resources.Load(filepath) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> TextAsset; <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] back = asset.bytes;</code> </pre><br>  If the script is not planned to run on mobile devices (or similar), you can not touch anything, just correct the path: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] back = File.ReadAllBytes(<span class="hljs-string"><span class="hljs-string">"Assets/Resources/"</span></span> + filepath + <span class="hljs-string"><span class="hljs-string">".txt"</span></span>);</code> </pre><br>  After saving the objects with the Save button, you need to collapse and expand Unity so that the updated binary file is imported and updated. <br><div class="spoiler">  <b class="spoiler_title">Source code of the program</b> <div class="spoiler_text"><pre> <code class="hljs ruby">using System; using System.Collections.Generic; using System.ComponentModel; using System.Data; using System.Drawing; using System.Linq; using System.Text; using System.Windows.Forms; using System.IO; using System.Runtime.Serialization.Formatters.Binary; using System.Runtime.Serialization; using System.Reflection; namespace HabrSerialis { public partial <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Form1</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Form</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">public</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Form1</span></span></span><span class="hljs-class">() { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InitializeComponent</span></span></span><span class="hljs-class">();</span></span> } /<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> short _SelectedNodeID = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   NodesV2 Nodes;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>   ,    private void Form1_Load(object sender, EventArgs e) /<span class="hljs-regexp"><span class="hljs-regexp">/   { Nodes = new NodesV2();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   ,       /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ Nodes.Name = new Dictionary&lt;short, string&gt;(); Nodes.Text = new Dictionary&lt;short, string&gt;(); Nodes.Perm = new Dictionary&lt;short, bool&gt;(); } private void button1_Click(object sender, EventArgs e)/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ { SaveLoad_Data _SaveNodes = new SaveLoad_Data();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    _SaveNodes.Save(Nodes, @"C:\UnityProjects\Blueprint_Editor_Plugin\Assets\Resources\HabrSerialisText"); } private void button2_Click(object sender, EventArgs e)/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ { SaveLoad_Data _LoadNodes = new SaveLoad_Data(); Nodes = (NodesV2)_LoadNodes.Load(@"C:\UnityProjects\Blueprint_Editor_Plugin\Assets\Resources\HabrSerialisText"); UpdateList();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> private void listBox1_SelectedIndexChanged(object sender, EventArgs e) /<span class="hljs-regexp"><span class="hljs-regexp">/    { _SelectedNodeID = (short)listBox1.SelectedIndex; if (Nodes.Name.ContainsKey(_SelectedNodeID))/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    { textBox1.Text = Nodes.Name[_SelectedNodeID];/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      1 textBox2.Text = Nodes.Text[_SelectedNodeID];/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      2 } } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> private void button3_Click(object sender, EventArgs e)/<span class="hljs-regexp"><span class="hljs-regexp">/   () { short _NewNodeID = CalcNewItemIndex(); Nodes.Name.Add(_NewNodeID, "New Node name");/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    Nodes.Text.Add(_NewNodeID, "New Node Text");/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   Nodes.Perm.Add(_NewNodeID, false);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   UpdateList();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   listBox1.SelectedIndex = _NewNodeID; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> private void textBox2_TextChanged(object sender, EventArgs e) { Nodes.Text[_SelectedNodeID] = textBox2.Text;<span class="hljs-regexp"><span class="hljs-regexp">//</span></span>      } /<span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> private void textBox1_TextChanged(object sender, EventArgs e)/<span class="hljs-regexp"><span class="hljs-regexp">/  { Nodes.Name[_SelectedNodeID] = textBox1.Text;/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    listBox1.Items[_SelectedNodeID] = "ID: " + _SelectedNodeID + " " + textBox1.Text;/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/      } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> short CalcNewItemIndex()/<span class="hljs-regexp"><span class="hljs-regexp">/     { short Index = -1; while (Nodes.Name.ContainsKey(++Index)); return Index; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span> void UpdateList()/<span class="hljs-regexp"><span class="hljs-regexp">/   { listBox1.Items.Clear(); foreach (KeyValuePair&lt;short, string&gt; node in Nodes.Name) { listBox1.Items.Add("ID: " + node.Key + " " + node.Value); } } } } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ [Serializable()] public class NodesV1 { public Dictionary&lt;short, string&gt; Name; public Dictionary&lt;short, string&gt; Text; } [Serializable()] public class NodesV2 { public Dictionary&lt;short, string&gt; Name; public Dictionary&lt;short, string&gt; Text; public Dictionary&lt;short, bool&gt; Perm; } public class SaveLoad_Data { private int Version; BinaryFormatter bformatter = new BinaryFormatter(); public void Save(object data, string filepath) { BinaryFormatter bformatter = new BinaryFormatter(); bformatter.Binder = new ClassBinder();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/        MemoryStream streamReader = new MemoryStream(); bformatter.Serialize(streamReader, data);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/C Version = Convert.ToInt32(data.GetType().ToString().Replace("NodesV", ""));/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       byte[] arr = streamReader.ToArray(); byte[] versionBytes = BitConverter.GetBytes(Version);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    byte[] result = new byte[arr.Length + 4]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ ,       . int - 4  Array.Copy(arr, 0, result, 4, arr.Length);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  Array.Copy(versionBytes, 0, result, 0, versionBytes.Length);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  File.WriteAllBytes(filepath + ".txt", result);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   streamReader.Close();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  } public object Load(string filepath) { byte[] back = File.ReadAllBytes(filepath + ".txt");/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   int versionBack = BitConverter.ToInt32(back, 0);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  byte[] data = new byte[back.Length - 4]; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     Array.Copy(back, 4, data, 0, back.Length - 4);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/       MemoryStream stream = new MemoryStream(data);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     bformatter.Binder = new ClassBinder();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ if (versionBack == 1)/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  1 { NodesV1 _NodesV1 = (NodesV1)bformatter.Deserialize(stream);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   1 stream.Close();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  NodesV2 NodeV2ret = new NodesV2();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     NodeV2ret.Name = _NodesV1.Name; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    NodeV2ret.Text = _NodesV1.Text; /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/    NodeV2ret.Perm = new Dictionary&lt;short, bool&gt;(); /</span></span><span class="hljs-regexp"><span class="hljs-regexp">/     1  Perm foreach (KeyValuePair&lt;short, string&gt; name in NodeV2ret.Name) { NodeV2ret.Perm.Add(name.Key, false);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  } return NodeV2ret; } else if (versionBack == 2)/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  2 -   (   )  { NodesV2 _NodesV2 = (NodesV2)bformatter.Deserialize(stream);/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/   stream.Close();/</span></span><span class="hljs-regexp"><span class="hljs-regexp">/  return _NodesV2; } /</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">//</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ return null; } } public sealed class ClassBinder : SerializationBinder { public override Type BindToType(string assemblyName, string typeName) { if (!string.IsNullOrEmpty(assemblyName) &amp;&amp; !string.IsNullOrEmpty(typeName)) { Type typeToDeserialize = null; assemblyName = Assembly.GetExecutingAssembly().FullName; typeToDeserialize = Type.GetType(String.Format("{0}, {1}", typeName, assemblyName)); return typeToDeserialize; } return null; } }</span></span></code> </pre><br></div></div><br>  Now you can change and save the binary file in the program and in the unit: <br><br><img src="https://habrastorage.org/files/d1c/3e5/8ec/d1c3e58eca734077af671a0d7c1db284.jpg"></div><p>Source: <a href="https://habr.com/ru/post/242069/">https://habr.com/ru/post/242069/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242057/index.html">How to increase the conversion rate of a landing page using the psychology of desire</a></li>
<li><a href="../242061/index.html">SSL Certification Centers on Innovations with SHA-2</a></li>
<li><a href="../242063/index.html">The White House is thinking about choosing a new data center for its infrastructure</a></li>
<li><a href="../242065/index.html">Organization of cellular communication in the subway - the experience of St. Petersburg</a></li>
<li><a href="../242067/index.html">Localized date formatting in Laravel</a></li>
<li><a href="../242071/index.html">Runet in pictures XVIII. Bank cards in Russia and the world</a></li>
<li><a href="../242073/index.html">Command infrastructure for the user to invoke actions in the MVVM pattern</a></li>
<li><a href="../242075/index.html">How to deploy web sites in Microsoft Azure?</a></li>
<li><a href="../242077/index.html">Query Builder library for working with SphinxQL</a></li>
<li><a href="../242079/index.html">Professional Invisibility: A fun way to get covered with moss from boredom</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>