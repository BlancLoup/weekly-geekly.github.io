<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We write a web service for 1 evening</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prehistory 
 I recently ordered one thing from England to me in my native St. Petersburg. The package was shipped by EMS. And what was my surprise whe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We write a web service for 1 evening</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prehistory </h4><br>  I recently ordered one thing from England to me in my native St. Petersburg.  The package was shipped by EMS.  And what was my surprise when I discovered that I could not track the status of the parcel automatically by the track number (departure identifier) ‚Äã‚Äãissued to me.  Possessing a very impatient character, I literally every morning began by checking the status of my package.  And he was even more upset when he realized that she was still there, where she was 5 days ago.  After some thought, I decided that this was a terrible omission, and decided to rectify the situation on my own. <br><a name="habracut"></a><br><br><h4>  Build a bike </h4><br>  Yes, dear friend, such services already exist, and probably even work, but it's always so nice to do something with your own hands.  Moreover, registration is required on all these services, and nowadays it is an unforgivable pleasure to get one more account on the site, which is needed once a year. <br><br>  Here are examples of existing services: <br>  <a href="http://gdeposylka.ru/">gdeposylka.ru</a> - after registration they promise e-mail notifications, for a fee they will even send sms <br>  <a href="http://post-tracker.ru/">post-tracker.ru</a> - here, too, promise automatic notifications after registration 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Let's start </h4><br>  Well, the first thing I did, of course, was choosing a domain name, I needed something so cool, sonorous, I stopped at: <a href="http://trackmypost.ru/">trackmypost.ru</a> <br><br>  In my opinion fully reflects the idea of ‚Äã‚Äãthe project. <br><br>  Next, it was necessary to find a platform, I needed a normal virtual machine with root access and the ability to gather everything together for myself, and my choice fell on <a href="http://hetzner.de/">hetzner.de</a> . <br><br>  The result is a pleasant part of creating a service: I have a cool domain and a ‚Äúmachine‚Äù.  It remains to write the service itself. <br>  First, let's deploy nginx, php-cli, php-fpm, mysql, ssmtp and postfix.  CLI will do the dirtiest work, out of it will work 2 of our "demon".  In fact, this is just 2 scripts starting <b>at a crown every minute</b> .  The first will actually track mailings, and the second will send mail notifications. <br><br>  Speaking of architecture, why I divided these 2 scripts: I do not know how many letters will be there in the queue, how postfix will work, etc.  Therefore, in order to protect against the hang of the entire service, I divided 2 logical operations: tracking and sending notifications.  By the way, with this option it is much more convenient to collect statistics and generally monitor what is happening on the service. <br><br><h4>  Data </h4><br>  It's time to think about where and how to store data.  The simplest storage is mysql.  I will not paint all the fields, I‚Äôll just mark the key points, of course, for the task table for tracking (let's call it tasks), we will need the last_state field (the last status of the package) and bounce (the number of unsuccessful attempts to find the track on sites) and bounce_date (the date of the last unsuccessful attempt to find the track). <br><br><h4>  Tracking </h4><br><h5>  General </h5><br>  The first script, let's call it tracker.php, makes requests to emspost.ru and russianpost.ru servers in order to check the status of the notification. <br><br>  If the servers are answered, <b>but the track number is not found on them</b> , then increase the bounce field of the current task by 1 and set bounce_date equal to the value of the current date.  bounce_date allows you to forget about this task today. <br>  For bounce, I implemented this logic: <br><ul><li>  bounce == 1 I am sending a letter asking if the person in the track number was wrong. </li><li>  bounce == 7 I am sending a letter that the track has not been found for 7 days already. </li><li>  bounce == 14 I am sending a letter stating that the track has not been found for 14 days. </li><li>  bounce == 21 I am sending a letter saying that the track was not found for 21 days in a row and delete the task.  The patience ended. </li></ul><br><br>  If the track is found on one of the sites and the current status! = Last_state send a notification about the status change. <br><br>  If the new status is ‚ÄúHanding to the addressee‚Äù, then we‚Äôve finished tracking the track. <br><br><h5>  Trekking queue </h5><br>  I needed to implement a simple and uniform queue for tracking, and I did this: each time the script is run, only one track number is selected and processed in tracker.php.  After processing, this track is recorded in the file last_track.txt.  At the next launch, the script selects id&gt; ID values ‚Äã‚Äãfrom last_track.txt.  When it comes to the last one starts from the beginning. <br>  In this way: <br><ul><li>  1. The service never idle (since tracker.php works every minute, if there are only 2 tracks in the database, each of them will be checked 30 times per hour, if 4 tracks, every 15 times per hour, etc.) </li><li>  2. The load on the service and on the mail sites is always evenly insignificant, because more than 1 track numbers per minute is never checked </li></ul><br><h4>  Mailing </h4><br>  With mail, everything is quite simple.  In fact, tracker.php itself does not call the mail () function, it only adds the letter to the mysql mails label.  Which is already raking the second script launched according to crown: mailer.php. <br><br>  For each launch, he simply chooses the next, not sent letter, and tries to send it.  If the mail () function returns true, it is marked as sent.  If false and postfix broke, then the same email will try to leave again in a minute. <br><br><h4>  Afterword </h4><br>  I only needed FPM for processing the form of adding a track and issuing statistics. <br><br>  When writing a class for socket requests, do not forget to set the timeout for reading and writing, in php this is done something like this: <br><br>  fputs ($ fp, $ data); <br>  $ result = ''; <br>  while (! feof ($ fp) &amp;&amp; (! $ info ['timed_out'])) { <br>  $ result. = fgets ($ fp, 128); <br>  $ info = stream_get_meta_data ($ fp); <br>  } <br>  fclose ($ fp); <br><br>  Because, for example, the site of the Russian Post is sinning by not closing the connection even with Connection: close. <br><br>  As usual, do not forget to disable keep-alive in nginx by setting it to 0 seconds. <br><br>  You can leave your questions and comments right here, or on the project website: <a href="http://trackmypost.ru/">trackmypost.ru</a> =) </div><p>Source: <a href="https://habr.com/ru/post/130989/">https://habr.com/ru/post/130989/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../130981/index.html">ASUS showed the first Zenbook</a></li>
<li><a href="../130982/index.html">Identify P2P- "pirates" by their activity on Skype</a></li>
<li><a href="../130983/index.html">Cancel DST for Exchange Servers</a></li>
<li><a href="../130985/index.html">Offline bitcoin coins</a></li>
<li><a href="../130987/index.html">Deploying OS Images with FOG</a></li>
<li><a href="../130992/index.html">Operator (+) no longer works in Google search</a></li>
<li><a href="../130993/index.html">Change the default country in Google Apps for Domains</a></li>
<li><a href="../130998/index.html">11/11/11 Kyiv IT Quest - Specialized autoquest for those who work in the IT industry</a></li>
<li><a href="../130999/index.html">All lie or why in MySQL it is better not to use partitions</a></li>
<li><a href="../131000/index.html">The Fed will track the mood on the Internet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>