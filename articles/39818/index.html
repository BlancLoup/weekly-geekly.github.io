<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MySQL Performance real life Tips and Tricks. Part 3-rd.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to continue the cycle of notes on this topic. In this article, I wanted to give a special place to MySQL query profiling. Describe the tools...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MySQL Performance real life Tips and Tricks. Part 3-rd.</h1><div class="post__text post__text-html js-mediator-article">  I decided to continue the cycle of notes on this topic.  In this article, I wanted to give a special place to MySQL query profiling.  Describe the tools that MySQL provides for profiling, and what needs to be done to identify the bottlenecks of the query. <br><br>  Also, after the publication of the first two articles, I received a couple of reviews and questions related to the database design / indexing / querying.  He tried to answer many questions.  I will share with some of them in this article. <br><br><a name="habracut"></a><br><h4>  Query profiling </h4><br>  Let's start with the standard query profiling tools using MySQL. <br><ol><li>  <b>EXPLAIN</b> </li><li>  <b>SHOW STATUS</b> </li><li>  <b>PROFILING</b> </li></ol><br><h5>  EXPLAIN </h5><br>  Using the EXPLAIN command, MySQL shows an <b>approximate</b> execution plan of the query (The description of all returned fields by the EXPLAIN command can be viewed at - <a href="http://dev.mysql.com/doc/refman/5.0/en/using-explain.html">dev.mysql.com/doc/refman/5.0/en/using-explain.html</a> ).  In fact, in this definition, the keyword is <b>indicative</b> , since  EXPLAIN can be wrong :-) The reason for these errors is that the generation of the execution plan is part of the execution of the query (query execution), sometimes the construction of the execution plan occurs dynamically depending on the data.  Using the EXPLAIN command, MySQL tries to simulate the execution of a query, but does not ‚Äútouch‚Äù the data, and therefore does not have access to this dynamic component.  MySQL does this assessment mainly relying on index statistics.  Which, in turn, should always be kept up to date, and depending on the intensity of database requests to add / change / delete data, perform with a certain periodicity on a cron (say, every night) perform queries - ANALYZE TABLE (rebuilds the index tree, not allowing it to be listed in the list, this can happen if we, say, insert ordered data, then the effectiveness of the record search operation will not be O (logn), but O (n). I also note that you should not always run ANALYZE TABLE on production server, because  MySQL locks the tables MyISAM (read lock), InnoDB (write lock), OPTIMIZE TABLE (defragmentation of the data file. Useful for large deletion of records from the table). <br>  Also EXPLAIN gives far from all the information to assess the speed of the query.  For example, if temporary tables are used during the query, MySQL will not show whether it is in-memory or in-disk temporary tables.  Also, MySQL on the display will not show the cost of writing operations or performing functions used in the query. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also in this paragraph I wanted to note the main thing - that the <b>query performance depends on the number of records that were checked (investigated) by MySQL, and not on the number of records returned by the query.</b> <br><br><h5>  SHOW STATUS </h5><br>  MySQL has long provided monitoring of system variables by means of the command - SHOW STATUS.  Earlier (up to version 4.1.), This command showed the status of global variables, but since version 4.1.  it became possible to show the state of session variables - SHOW SESSION STATUS.  (The manual for this command is <a href="http://dev.mysql.com/doc/refman/5.0/en/show-status.html">dev.mysql.com/doc/refman/5.0/en/show-status.html</a> ) <br>  Let me just say that this command, unlike EXPLAIN, which is based on heuristic estimates, shows directly WHAT happened after the execution of the query, i.e.  the number of records that MySQL physically accessed (moreover, through this command you can find out how many of them were received from memory, and how many by accessing the disk) I also want to note that this number is not an estimated result, but a real number (actually MySQL incrementing a variable all the time when referring to each next line).  In general, I will say that SHOW STATUS returns a huge amount of statistics, I will not naturally describe it all.  I will show the main points that should be noted during its (statistics) analysis. <br><br>  In order to get statistics on the query of interest to us, you first need to run the command: <br><br>  FLUSH STATUS - this command will reset (reset) all session variables, global variables will not be affected. <br><br>  After that we fulfill the request that interests us. <br><br>  SELECT bla-bla-bla FROM test_table as tt WHERE tt.bla = 'test' LIMIT 10 <br><br>  mysql&gt; SHOW STATUS LIKE 'Key_read%'; <br>  + -------------------- + ---------- + <br>  |  Variable_name |  Value | <br>  + -------------------- + ---------- + <br>  |  Key_read_requests |  96882 | <br>  |  Key_reads |  36200 | <br>  + -------------------- + ---------- + <br><br>  What can give such information?  And what decisions to make, based on this information? <br><br>  Now we will try to analyze the obtained values ‚Äã‚Äãand make a decision on optimization, based on these statistics. <br><ul><li>  <b>Key_read_requests</b> - The number of requests to read index blocks from the cache. </li><li>  <b>Key_reads</b> - The number of physical reading of index blocks from disk.  If the number of Key_reads is large, then your key_buffer_size is probably quite small and requires an increase.  The cache miss ratio can be calculated as Key_reads / Key_read_requests. </li></ul><br>  In this case, we see that more than a third of the index blocks are read from the disk, and not from the cache =&gt; respectively, an adequate measure for optimization will be an increase in this parameter (key_buffer_size). <br>  But you should also take into account the following: <b>key_buffer_size</b> is one of the most important configuration parameters, especially if you use MyISAM tables.  Then the value of this parameter should be approximately 25-30% of the amount of free RAM.  But you should also pay attention that this parameter is not unnecessarily large (for example, if the total size of the .MYI index files is 1GB and key_buffer_size = 4GB, in this case you just waste memory).  You should also pay attention to the fact that the maximum value of this parameter is 4GB (as of MySQL 5.0.52, values ‚Äã‚Äãof 4GB are allowed for 64-bit platforms (except 64-). bit of windows for a small number of minutes with a warning). If you want to see how much money you can allocate, it will give you the amount of memory that you can allocate as much as you can. .ys.mysql.com/doc/refman/5.0/en/server-system-variables <a href="http://dev.mysql.com/doc/refman/5.0/en/server-system-variables.html">. html</a> ).  But even if you do not use MyISAM tables, the value of key_buffer_size should still be set to 32-64MB, since  it will be used by indexes for temporary tables (MyISAM) <br><br>  So, what other useful statistics can be obtained by more complex queries, for example, on this: <br><br><blockquote>  <font color="black">FLUSH STATUS;</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">SQL_NO_CACHE fe.username, <font color="#0000ff">COUNT</font> (*) <font color="#0000ff">as</font> ` <font color="#0000ff">count`</font></font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">`tx_images` <font color="#0000ff">as</font> ti</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">INNER</font> <font color="#0000ff">JOIN</font></font> <font color="black"><br></font>  <font color="black">`fe_users` <font color="#0000ff">as</font> fe</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">ON</font> ti.cruser_id = fe.uid</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font></font> <font color="black"><br></font>  <font color="black">fe.uid</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font></font> <font color="black"><br></font>  <font color="black">` <font color="#0000ff">count`</font> <font color="#0000ff">desc</font> ;</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  |  Variable_name |  Value | <br>  + ------------------------ + ------- + <br>  |  Select_full_join |  0 | <br>  |  Select_full_range_join |  0 | <br>  |  Select_range |  0 | <br>  |  Select_range_check |  0 | <br>  |  Select_scan |  2 | <br>  + ------------------------ + ------- + <br><ul><li>  <b>Select_scan</b> - <b>This</b> is a <b>list</b> of the first table. </li></ul><br>  The last field shows that MySQL did the FULL TABLE SCAN, in fact, this information is confirmed by EXPLAIN, the Extra field, which contains Using temporary;  Using filesort. <br>  If our query contains several tables that are glued together during a query, then other values ‚Äã‚Äãin this list may not be null. <br><br>  mysql&gt; SHOW SESSION STATUS LIKE 'Sort%'; <br>  + ------------------- + ------- + <br>  |  Variable_name |  Value | <br>  + ------------------- + ------- + <br>  |  Sort_merge_passes |  0 | <br>  |  Sort_range |  0 | <br>  |  Sort_rows |  598 | <br>  |  Sort_scan |  1 | <br>  + ------------------- + ------- + <br>  4 rows in set (0.00 sec) <br><br>  Again, the ghost has a description of these fields from the manual. <br><ul><li>  <b>Sort_rows</b> - The number of sorted rows. </li><li>  <b>Sort_scan</b> - The number of sorts that were done by scanning the table. </li></ul><br><br>  It is also useful to know whether temporary (temporary) tables were created that were used during the execution of a query on disk or in memory. <br><br>  mysql&gt; SHOW SESSION STATUS LIKE 'Created%'; <br>  + ------------------------- + ------- + <br>  |  Variable_name |  Value | <br>  + ------------------------- + ------- + <br>  |  Created_tmp_disk_tables |  0 | <br>  |  Created_tmp_files |  0 | <br>  |  Created_tmp_tables |  3 | <br>  + ------------------------- + ------- + <br>  3 rows in set (0.00 sec) <br><br>  Here MySQL shows that inmemori tables were used, only for some reason it shows that 3 were created :-) In fact, only one is created for this query. <br><br>  Here I will make a small lyrical digression. <br>  After the publication of the first two articles, I received a couple of letters with questions and suggestions.  So, as I understand it, quite a common mistake are flaws in terms of architectural solutions, which pull a very poor performance in sampling requests. <br>  For example, if you have a table containing some articles / news, etc.  and has approximately the following structure. <br><br><blockquote>  <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> `tx_articles` (</font> <font color="black"><br></font>  <font color="black">`uid` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> auto_increment,</font> <font color="black"><br></font>  <font color="black">`pid` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`tstamp` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`crdate` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`cruser_id` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`deleted` tinyint (4) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`hidden` tinyint (4) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`headline` <font color="#0000ff">varchar</font> (70) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">''</font> ,</font> <font color="black"><br></font>  <font color="black">`bodytext` text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ,</font> <font color="black"><br></font>  <font color="black">`type` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`citycat_id` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black"> ªeditable` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`confirm` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`confirm_code` <font color="#0000ff">varchar</font> (64) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">''</font> ,</font> <font color="black"><br></font>  <font color="black"> ªeditorspick` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black">`newspaper_id` <font color="#0000ff">int</font> (11) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">'0'</font> ,</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (`uid`),</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">KEY</font> `parent` (` pid`),</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">KEY</font> `citycat_id` (` citycat_id`, `tstamp`)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">KEY</font> `newspaper_id` (` newspaper_id`)</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">KEY</font> `tstamp` (` tstamp`)</font> <font color="black"><br></font>  <font color="black">) ENGINE = MyISAM <font color="#0000ff">DEFAULT</font> CHARSET = latin1</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  It is also assumed that the lion's part of the sample requests will be addressed to this table.  Moreover, as a rule, such a table may contain a sufficiently large number of columns, some of which, as in the case above, have the TEXT or BLOB data type (`bodytext` text NOT NULL), as well as variable length fields (VARCHAR).  All this complicates the work of MySQL especially in the operations of sorting / grouping records.  Because  Imagine that each record has an average length of 1Kb, and when MySQL will sort / group such records, the server will simply ‚Äúchoke‚Äù turning over such large amounts of data each time. <br>  And this is not all the disadvantages of this approach.  <b>You should pay special attention to this</b> - MySQL for temporary table uses a HEAP engine that works only with fields of fixed length, i.e.  varchar it makes char-ohm (maximum length specified when declaring varchar).  This is done, as you understand, for a quick search for records.  But he does not know how to work with the TEXT and BLOB fields, so he will convert the table type to MyISAM and the data will be on the disk, and this is very slow. <br>  Therefore, such an architecture should be avoided on large bases with a large number of hits and requiring quick response time. <br><br>  What is proposed to do?  In some cases, it may be useful to use covering indexes and self-join, this example was described in my first article ( <a href="http://habrahabr.ru/blogs/mysql/38907/">http://habrahabr.ru/blogs/mysql/38907/</a> ), so I will not repeat ... I will not repeat ...: - ) <br><br>  More correct, in terms of the architectural approach, in this case is the selection of variable-length fields, which as a rule do not participate in WHERE conditions (TEXT, BLOB, depending on the task condition, this can be VARCHAR) into a separate table.  Accordingly, the basic conditions for the sample, as a rule, on index fields with a fixed length, we perform on one table, also perform LIMIT on it and only after that we paste together, add additional fields, in my example it will be ‚Äúbodytext‚Äù from another table.  In this case, such gluing will be performed by PRIMARY KEY. <br><br><h5>  PROFILING </h5><br>  Since version 5.0.37, MySQL includes the ability to profile queries.  This utility writes statistics on the execution of queries in the service database information_schema <br><br>  In order for MySQL to start recording statistics on a query, set the variable profiling value to 1 <br><br><blockquote>  <font color="black">mysql&gt; <font color="#0000ff">set</font> profiling = 1;</font> <font color="black"><br></font>  <font color="black">Query OK, 0 <font color="#0000ff">rows</font> affected (0.00 sec)</font> <font color="black"><br></font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  After that, execute the SQL query (s) we are interested in. <br><br>  Next, perform the following query <br><br><blockquote>  <font color="black">mysql&gt; show profiles;</font> <font color="black"><br></font>  <font color="black">+ ---------- + ------------ + ------------------------- ---------------------- +</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black">Query_ID |</font>  <font color="black">Duration |</font>  <font color="black">Query |</font> <font color="black"><br></font>  <font color="black">+ ---------- + ------------ + ------------------------- ---------------------- +</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black">0 |</font>  <font color="black">0.00005100 |</font>  <font color="black"><font color="#0000ff">set</font> profiling = 1 |</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black">1 |</font>  <font color="black">0.80246730 |</font>  <font color="black"><font color="#0000ff">SELECT</font> SQL_NO_CACHE fe.username, <font color="#0000ff">COUNT</font> (*) <font color="#0000ff">as</font> `count` <font color="#0000ff">FROM</font> `tx_images` <font color="#0000ff">as</font> ti <font color="#0000ff">INNER</font> JOIN` fe_users` <font color="#0000ff">as</font> fe <font color="#0000ff">ON</font> ti.cruser_id = fe.uid <font color="#0000ff">GROUP</font> <font color="#0000ff">BY</font> fe.uid <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> `count` <font color="#0000ff">desc</font> |</font> <font color="black"><br></font>  <font color="black">+ ---------- + ------------ + ------------------------- ---------------------- +</font> <font color="black"><br></font>  <font color="black">2 <font color="#0000ff">rows</font> <font color="#0000ff">in</font> <font color="#0000ff">set</font> (0.00 sec)</font> <font color="black"><br></font>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  As I said earlier, these statistics are recorded in the database - information_schema, the table is profiling, so we can get statistics on the execution of the query by making a query to this table. <br><br><blockquote>  <font color="black">mysql&gt; <font color="#0000ff">select</font> <font color="#0000ff">sum</font> (duration) <font color="#0000ff">from</font> information_schema.profiling <font color="#0000ff">where</font> query_id = 1;</font> <font color="black"><br></font>  <font color="black">+ --------------- +</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black"><font color="#0000ff">sum</font> (duration) |</font> <font color="black"><br></font>  <font color="black">+ --------------- +</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black">0.80246730 |</font> <font color="black"><br></font>  <font color="black">+ --------------- +</font> <font color="black"><br></font>  <font color="black">1 <font color="#0000ff">row</font> <font color="#0000ff">in</font> <font color="#0000ff">set</font> (0.00 sec)</font> <font color="black"><br></font>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  Then you can see the statistics of all stages of the query, this is done with the help of the command <br><br>  mysql&gt; show profile for query 1; <br>  + -------------------- + ------------ + <br>  |  Status |  Duration | <br>  + -------------------- + ------------ + <br>  |  (initialization) |  0.00007300 | <br>  |  Opening tables |  0.00005100 | <br>  |  System lock |  0.00000600 | <br>  |  Table lock |  0.00002000 | <br>  |  init |  0.00002200 | <br>  |  optimizing |  0.00003400 | <br>  |  statistics |  0.00010600 | <br>  |  preparing |  0.00014800 | <br>  |  executing |  0.50000700 | <br>  |  Sending data |  0.30226800 | <br>  |  end |  0.00000700 | <br>  |  query end |  0.00000500 | <br>  |  freeing items |  0.00001300 | <br>  |  closing tables |  0.00000700 | <br>  |  logging slow query |  0.00000400 | <br>  + -------------------- + ------------ + <br>  15 rows in set (0.00 sec) <br><br>  Also, using profiling, you can view statistics not only on SELECT queries.  You can view statistics even for queries that change the structure of ALTER TABLE tables and change / delete data.  Accordingly, the stage of execution of these requests will be different. <br><br>  Also, this type of profiling allows you to monitor CPU usage during each stage of the request execution, SWAP, etc. <br><br><h5>  Slow query log </h5><br><br>  A very useful tool for finding bottlenecks and slow queries to the database is logging slow queries, namely the directive <i>--log-slow-queries</i> when starting MySQL.  Before MySQL version <b>5.1.21</b> , the minimum value of the <b>long_query_time</b> parameter <b>is</b> 1, the default value is 10. This value should be of the integer type.  Those.  if the query execution time exceeds the value of this parameter in seconds, then it is recorded in the log.  It should also be noted that if the request goes into the slow query log, this does not mean that it is a bad request, maybe it waited a long time until lock was released.  Also a useful parameter is logging queries that do not use indexes - <i>log-queries-not-using-indexes</i> . <br>  This is very useful information, but if we have a large project and a loaded base, we need means of monitoring and visualizing such statistics.  I personally use <a href="http://www.webyog.com/en/">MONyog</a> <br><br><h5>  editorial responses :-) </h5><br><br>  Terer will answer a couple of questions that I did not have time to answer: <br>  During the discussion of the second article, I was in the comments ( <a href="http://habrahabr.ru/blogs/mysql/39260/">http://habrahabr.ru/blogs/mysql/39260/#comment_941339</a> ) arguing with the habrachelean <a href="https://habrahabr.ru/users/juks/" class="user_link">juks</a> about the relevance of using <i>force index</i> in queries. <br><br>  Consider, for example, such a table structure. <br><br><blockquote>  <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> `some_table`</font> <font color="black"><br></font>  <font color="black">(</font> <font color="black"><br></font>  <font color="black">`id` <font color="#0000ff">INT</font> (10) UNSIGNED <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> AUTO_INCREMENT,</font> <font color="black"><br></font>  <font color="black">`field1` <font color="#0000ff">INT</font> (10) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ,</font> <font color="black"><br></font>  <font color="black">`field2` <font color="#0000ff">VARCHAR</font> (50) <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">default</font> <font color="#A31515">''</font> ,</font> <font color="black"><br></font>  <font color="black">`field3` <font color="#0000ff">TIMESTAMP</font> ,</font> <font color="black"><br></font>  <font color="black">`field4` <font color="#0000ff">VARCHAR</font> (255) <font color="#0000ff">default</font> <font color="#A31515">''</font> ,</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">PRIMARY</font> <font color="#0000ff">KEY</font> (`id`),</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">KEY</font> fields1_2 (field1, field2 (8)),</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">KEY</font> fields2_3 (field1, field3)</font> <font color="black"><br></font>  <font color="black">) ENGINE = InnoDB <font color="#0000ff">DEFAULT</font> CHARSET = "UTF8";</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  After that, fill it with data, for this we need, for example, such a script in PHP <br><br><blockquote>  <font color="black">&lt;? php</font> <font color="black"><br></font>  <font color="black">set_time_limit (0);</font> <font color="black"><br><br></font>  <font color="black">mysql_connect ( <font color="#A31515">"127.0.0.1"</font> , <font color="#A31515">"root"</font> , <font color="#A31515">"root_password"</font> );</font> <font color="black"><br></font>  <font color="black">mysql_select_db ( <font color="#A31515">"database_name"</font> );</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">function</font> random_string () {</font> <font color="black"><br></font>  <font color="black">$ <font color="#0000ff">string</font> = <font color="#A31515">"ABCDEFGHIKJLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"</font> ;</font> <font color="black"><br></font>  <font color="black">$ len = strlen ($ <font color="#0000ff">string</font> );</font> <font color="black"><br></font>  <font color="black">$ <font color="#0000ff">return</font> = <font color="#A31515">''</font> ;</font> <font color="black"><br></font>  <font color="black">$ length = rand (10, 50);</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">for</font> ($ i = 0; $ i &lt;$ length; $ i ++) {</font> <font color="black"><br></font>  <font color="black">$ <font color="#0000ff">return</font> . = $ <font color="#0000ff">string</font> {rand (0, $ len)};</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> $ <font color="#0000ff">return</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">$ names = array ( <font color="#A31515">"maghamed"</font> , <font color="#A31515">"maghamed1"</font> , <font color="#A31515">"maghamed2"</font> , <font color="#A31515">"maghamed3"</font> , <font color="#A31515">"maghamed4"</font> );</font> <font color="black"><br><br></font>  <font color="black">mysql_query ( <font color="#A31515">"ALTER TABLE` some_table` DISABLE KEYS "</font> );</font>  <font color="black"><font color="#008000">// stop updating non-unique indexes</font></font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">for</font> ($ i = 0; $ i &lt;10,000,000; $ i ++) {</font> <font color="black"><br></font>  <font color="black">$ a = $ i% 1000;</font> <font color="black"><br></font>  <font color="black">$ b = rand (0, 4);</font> <font color="black"><br></font>  <font color="black">$ b = $ names [$ b];</font> <font color="black"><br></font>  <font color="black">$ c = random_string ();</font> <font color="black"><br></font>  <font color="black">$ sql = <font color="#A31515">"INSERT INTO` some_table` SET field1 = $ {a}, field2 = '$ {b}', field4 = '$ {c}' "</font> ;</font> <font color="black"><br></font>  <font color="black">mysql_query ($ sql) or die ( <font color="#A31515">‚ÄúInvalid query:‚Äû</font> . mysql_error ());</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">mysql_query ( <font color="#A31515">‚ÄúALTER TABLE` some_table` ENABLE KEYS ‚Äù</font> );</font> <font color="black"><br></font>  <font color="black">?&gt;</font> <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  The code in this script is intuitive.  I‚Äôll only pay attention to ‚ÄúALTER TABLE` some_table` DISABLE KEYS ‚Äùbefore inserting a large number of records, and‚Äú ALTER TABLE `some_table` ENABLE KEYS‚Äù <br>  after insertion.  These directives will significantly speed up the script and will be generally useful in similar situations.  ‚ÄúALTER TABLE ... DISABLE KEYS‚Äù stops updating non-unique indexes (in our case, ‚Äúfields1_2‚Äù, ‚Äúfields2_3‚Äù) when inserting new records.  MySQL uses a special algorithm that is much faster than updating indexes after inserting each record, so disabling indexes before large data insertion should give significant acceleration. <br><br>  And such a request to this table: <br><br><blockquote>  <font color="black">mysql&gt; EXPLAIN</font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">-&gt; *</font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">-&gt; `some_table`</font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">-&gt; field1 = 50 <font color="#0000ff">AND</font></font> <font color="black"><br></font>  <font color="black">-&gt; field2 = <font color="#A31515">'maghamed'</font></font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font></font> <font color="black"><br></font>  <font color="black">-&gt; field3 <font color="#0000ff">DESC</font></font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">LIMIT</font> 100</font> <font color="black"><br></font>  <font color="black">-&gt; \ G</font> <font color="black"><br></font>  <font color="black">*************************** 1. <font color="#0000ff">row</font> ******************** *******</font> <font color="black"><br></font>  <font color="black">id: 1</font> <font color="black"><br></font>  <font color="black">select_type: SIMPLE</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">table</font> : some_table</font> <font color="black"><br></font>  <font color="black">type: <font color="#0000ff">ref</font></font> <font color="black"><br></font>  <font color="black">possible_keys: fields1_2, fields2_3</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">key</font> : fields1_2</font> <font color="black"><br></font>  <font color="black">key_len: 30</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">ref</font> : const, const</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">rows</font> : 3042</font> <font color="black"><br></font>  <font color="black">Extra: <font color="#0000ff">Using</font> <font color="#0000ff">where</font> ;</font>  <font color="black"><font color="#0000ff">Using</font> filesort</font> <font color="black"><br></font>  <font color="black">1 <font color="#0000ff">row</font> <font color="#0000ff">in</font> <font color="#0000ff">set</font> (0.05 sec)</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  As you can see, MySQL in this case prefers to use the ‚Äúfields1_2‚Äù index, which facilitates quick lookups, but the sorting is performed without an index, the Extra - Using where field;  Using filesort tells us this. <br><br>  In this case, we can force MySQL to choose an index at which the query will be executed faster. <br><br><blockquote>  <font color="black">mysql&gt; explain</font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">SELECT</font></font> <font color="black"><br></font>  <font color="black">-&gt; *</font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">FROM</font></font> <font color="black"><br></font>  <font color="black">-&gt; `some_table`</font> <font color="black"><br></font>  <font color="black">-&gt; FORCE <font color="#0000ff">INDEX</font> (`fields2_3`)</font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">WHERE</font></font> <font color="black"><br></font>  <font color="black">-&gt; field1 = 50 <font color="#0000ff">AND</font></font> <font color="black"><br></font>  <font color="black">-&gt; field2 = <font color="#A31515">'maghamed'</font></font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font></font> <font color="black"><br></font>  <font color="black">-&gt; field3 <font color="#0000ff">DESC</font></font> <font color="black"><br></font>  <font color="black">-&gt; <font color="#0000ff">LIMIT</font> 100;</font> <font color="black"><br></font>  <font color="black">+ ---- + ------------- + ------------ + ------ + ---------- ----- + ----------- + --------- + ------- + ------ + ------- ------ +</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black">id |</font>  <font color="black">select_type |</font>  <font color="black"><font color="#0000ff">table</font> |</font>  <font color="black">type |</font>  <font color="black">possible_keys |</font>  <font color="black"><font color="#0000ff">key</font> |</font>  <font color="black">key_len |</font>  <font color="black"><font color="#0000ff">ref</font> |</font>  <font color="black"><font color="#0000ff">rows</font> |</font>  <font color="black">Extra |</font> <font color="black"><br></font>  <font color="black">+ ---- + ------------- + ------------ + ------ + ---------- ----- + ----------- + --------- + ------- + ------ + ------- ------ +</font> <font color="black"><br></font>  <font color="black">|</font>  <font color="black">1 |</font>  <font color="black">SIMPLE |</font>  <font color="black">some_table |</font>  <font color="black"><font color="#0000ff">ref</font> |</font>  <font color="black">fields2_3 |</font>  <font color="black">fields2_3 |</font>  <font color="black">4 |</font>  <font color="black">const |</font>  <font color="black">1928 |</font>  <font color="black"><font color="#0000ff">Using</font> <font color="#0000ff">where</font> |</font> <font color="black"><br></font>  <font color="black">+ ---- + ------------- + ------------ + ------ + ---------- ----- + ----------- + --------- + ------- + ------ + ------- ------ +</font> <font color="black"><br></font>  <font color="black">1 <font color="#0000ff">row</font> <font color="#0000ff">in</font> <font color="#0000ff">set</font> (0.03 sec)</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  * Let me say that MySQL can make a choice in favor of the index `fields2_3` and without <i>FORCE INDEX</i> it depends on the version of MySQL and the relevance of the statistics for the indices.  Therefore, it is important to keep the indexes current (ANALYZE TABLE `some_table`).  You shouldn‚Äôt force MySQL to choose between fast search, or sorting by index in this case, since  Both variants will be executed more slowly than the variant in which we have a composite index for 3 fields. <br><br>  First, remove the old index: <br><br><blockquote>  <font color="black"><font color="#0000ff">DROP</font> <font color="#0000ff">INDEX</font> `fields1_2` ON` some_table`</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br>  And add a new one. <br><br><blockquote>  <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">INDEX</font> `fields1_2_3` ON` some_table` (field1, field2 (8), `field3`);</font> <br>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br><br><hr><br><br>  Also after the first article where it was proposed to use the construction - GROUP BY BINARY crc32 (tag_text) for a quick grouping (GROUP BY) of the results, I received quite a lot of question, and doubts about this variant, since  extra time is spent on performing <i>crc32</i> , and many believe it will be ineffective, some suggested using MD5 instead of CRC32 to reduce the number of possible matches between the results of the function at different values. <br><br>  I will answer all such doubts with such a small benchmark. <br><br><blockquote>  <font color="black"><font color="#0000ff">SET</font> @ <font color="#0000ff">input</font> : = <font color="#A31515">'hello world'</font> ;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">SELECT</font> BENCHMARK (1000000, CRC32 (@ <font color="#0000ff">input</font> ));</font>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  1 row in set (0.22 sec) <br><br><blockquote>  <font color="black"><font color="#0000ff">SET</font> @ <font color="#0000ff">input</font> : = <font color="#A31515">'hello world'</font> ;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">SELECT</font> BENCHMARK (1000000, MD5 (@ <font color="#0000ff">input</font> ));</font>  <font color="gray">* This source code was highlighted with <a href="http://source.virtser.net/"><font color="gray">Source Code Highlighter</font></a> .</font> </blockquote><br>  1 row in set (6.02 sec) <br><br>  As you can see function CRC32 runs very quickly. <br>  * BENCHMARK - performs the specified f-iy CRC32 or MD5 in this case, the specified number of times 1 000 000 <br><br>  On this I will finish the third article, and so it was longer than planned.  I will try to answer all the questions. <br>  If the community is still not tired of my articles, then in the next article on this topic I wanted to talk about the problem of scale-ing large tables and other tastes of MySQL :-) </div><p>Source: <a href="https://habr.com/ru/post/39818/">https://habr.com/ru/post/39818/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../398169/index.html">Physicists have created the world's first "crystal of time"</a></li>
<li><a href="../398171/index.html">Speedran Legend of Zelda by manipulating the memory of the game</a></li>
<li><a href="../398173/index.html">SHENZHEN I / O - a new microcontroller programming simulator</a></li>
<li><a href="../398175/index.html">75,000 futures</a></li>
<li><a href="../398177/index.html">Rework a budget microphone for professional use.</a></li>
<li><a href="../398181/index.html">Adafruit and Russia - why buying without an intermediary is impossible</a></li>
<li><a href="../398183/index.html">Boeing is sure that it will overtake Ilona Mask on the road to Mars</a></li>
<li><a href="../398185/index.html">NASA has allowed private companies to attach modules to the ISS</a></li>
<li><a href="../398187/index.html">Bare Diggers - Superheroes in the Animal World</a></li>
<li><a href="../39819/index.html">Belarusian google</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>