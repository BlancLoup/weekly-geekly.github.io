<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using blocks in iOS. Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of our tutorial, we used Storyboard to customize the view. In the second and final part, we finally got to the blocks themselves. We...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using blocks in iOS. Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/post/309780/">first part of</a> our tutorial, we used Storyboard to customize the view.  In the second and final part, we finally got to the blocks themselves.  We‚Äôll talk about what blocks represent by themselves, what their syntax is, how to use them, and touch on a bunch of examples.  It will show how to use blocks with NSArray, UIView animations, Grand Central Dispatch, and much more. <br><a name="habracut"></a><br><h2>  Introduction </h2><br>  Blocks were first introduced in iOS 4.0 and Mac OSX 10.6 to simplify the code.  They can help reduce it, reduce dependence on delegates, and write clean, readable code.  But, despite the obvious advantages, many developers do not use blocks because of an incomplete understanding of the principle of their operation. <br>  Let's look at all the ‚Äúwhat, where, when, and why‚Äù blocks. <br><br><h3>  What are these "Blocks" and why are they so important? </h3><br>  On the inside, a block is a piece of code that may be called at some point in the future.  A block is a <a href="https://ru.wikipedia.org/wiki/%25D0%25A4%25D1%2583%25D0%25BD%25D0%25BA%25D1%2586%25D0%25B8%25D0%25B8_%25D0%25BF%25D0%25B5%25D1%2580%25D0%25B2%25D0%25BE%25D0%25B3%25D0%25BE_%25D0%25BA%25D0%25BB%25D0%25B0%25D1%2581%25D1%2581%25D0%25B0">first-class function</a> , so it can be said that blocks are ordinary Objective-C objects.  And objects can be passed as parameters, returned from functions and methods, and assigned to variables.  Blocks are often called closures in languages ‚Äã‚Äãsuch as Python, Ruby and Lisp, because after the declaration they encapsulate their state.  The block creates a constant copy of any local variable to which it refers. <br><br>  When you need to call the execution of some code that would later return something to you, you would probably use delegates or NSNotificationCenter, not blocks.  And it would have worked perfectly, but pieces of code would be scattered everywhere - the task starts from one point, and the result is processed in another. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Blocks are better because they keep the task in one place, which we'll see soon. <br><br><h3>  Who are the blocks for? </h3><br>  For you!  But seriously, blocks are for everyone and everyone uses blocks.  Blocks are the future, so you can explore them right now.  Many methods of embedded frameworks are rewritten or supplemented with blocks based on existing functionality. <br><br><h3>  How to use blocks? </h3><br>  This picture, from the iOS Developer Library, well explains the syntax for blocks. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/752/801/3ab/7528013ab4ac4451ac504f434dc446e5.jpg"></div><br>  The format of the block description is: <br><br><pre><code class="objectivec hljs">return_type (^block_name)(param_type, param_type, ...)</code> </pre> <br>  If you have already programmed in any other C language, this construction is quite familiar to you except for this symbol ^.  ^ and means block.  If you understand that ^ means ‚ÄúI am a block‚Äù - congratulations - you have just understood the most difficult thing about blocks.  ;] <br><br>  Note that the names for the parameters are not currently required, but you can turn them on if you wish. <br><br>  Below is a sample ad block. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (^add)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)</code> </pre><br>  Further, the block description. <br><br><pre> <code class="objectivec hljs">^return_type(param_type param_name, param_type param_name, ...) { ... <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> return_type; }</code> </pre><br>  Actually, this is how a block is created.  Notice that the block description is different from its declaration.  It starts with a ^ and is followed by parameters that can be named and that must match the type and order of the parameters in the block declaration.  Next comes the code itself. <br><br>  In the block definition, the return type is optional, it can be identified from the code.  If there are multiple return values, they must be of the same type. <br><br>  Sample block description: <br><br><pre> <code class="objectivec hljs">^(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> number1, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> number2){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number1+number2 }</code> </pre><br>  If you combine the description and block declaration, you get the following code: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> (^add)(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) = ^(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> number1, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> number2){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number1+number2; }</code> </pre><br>  You can also use blocks in this way: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> resultFromBlock = add(<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>);</code> </pre><br>  Now let's look at a couple of examples of using blocks as opposed to the same code without blocks. <br><br><h3>  Example: NSArray </h3><br>  Let's see how the blocks change the principle of performing some operations on an array.  For starters, here is the usual code for a loop: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> stop; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span> ; i &lt; [theArray count] ; i++) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"The object at index %d is %@"</span></span>,i,[theArray objectAtIndex:i]); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stop) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }</code> </pre><br>  You may not give the value of the "stop" variable.  But everything will become clear after you see the implementation of this method using a block.  The block method contains the ‚Äústop‚Äù variable, which allows you to stop the loop at any time, and therefore we simply duplicate this feature here for code similarity. <br><br>  Now let's take a look at the same code using fast-enumeration. <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> stop; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> idx = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> theArray) { <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"The object at index %d is %@"</span></span>,idx,obj); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (stop) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; idx++; }</code> </pre> <br>  And now with the block: <br><br><pre> <code class="objectivec hljs">[theArray enumerateObjectsUsingBlock:^(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> obj, <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> idx, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> *stop){ <span class="hljs-built_in"><span class="hljs-built_in">NSLog</span></span>(<span class="hljs-string"><span class="hljs-string">@"The object at index %d is %@"</span></span>,idx,obj); }];</code> </pre><br>  In the code above, you may be wondering what the ‚Äústop‚Äù variable is.  It is simply a variable to which YES can be assigned inside the block to stop the process.  This parameter is defined as part of the block that will be used in the <b>enumerateObjectsUsingBlock</b> method. <br><br>  The above code is trivial, and it‚Äôs quite difficult to see the advantages of the blocks in it.  But there are two things that I would like to point out: <br><br><ul><li>  <b>Simplicity</b>  Using blocks, we can access the object, the index of the object in the array and the stop variable without writing code.  This leads to a decrease in the code, which in turn reduces the number of errors. </li><li>  <b>Speed</b>  The block method has a slight speed advantage over the fast listing method.  In our case, this advantage may be too small to mention, but in more complex cases it becomes significant. </li></ul><br><h3>  Example: UIView animations </h3><br>  Let's take a look at a simple animation that operates on a single UIView.  It changes the <b>alpha</b> parameter to 0 and moves the view down and to the right by 50 points, then removes the UIView from the superview.  Simple, isn't it?  Code without blocks: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)removeAnimationView:(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)sender { [animatingView removeFromSuperview]; } - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidAppear:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)animated { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> viewDidAppear:animated]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> beginAnimations:<span class="hljs-string"><span class="hljs-string">@"Example"</span></span> context:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> setAnimationDuration:<span class="hljs-number"><span class="hljs-number">5.0</span></span>]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> setAnimationDidStopSelector:<span class="hljs-keyword"><span class="hljs-keyword">@selector</span></span>(removeAnimationView)]; [animatingView setAlpha:<span class="hljs-number"><span class="hljs-number">0</span></span>]; [animatingView setCenter:<span class="hljs-built_in"><span class="hljs-built_in">CGPointMake</span></span>(animatingView.center.x+<span class="hljs-number"><span class="hljs-number">50.0</span></span>, animatingView.center.y+<span class="hljs-number"><span class="hljs-number">50.0</span></span>)]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> commitAnimations]; }</code> </pre><br>  Block method: <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidAppear:(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)animated { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> viewDidAppear:animated]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> animateWithDuration:<span class="hljs-number"><span class="hljs-number">5.0</span></span> animations:^{ [animatingView setAlpha:<span class="hljs-number"><span class="hljs-number">0</span></span>]; [animatingView setCenter:<span class="hljs-built_in"><span class="hljs-built_in">CGPointMake</span></span>(animatingView.center.x+<span class="hljs-number"><span class="hljs-number">50.0</span></span>, animatingView.center.y+<span class="hljs-number"><span class="hljs-number">50.0</span></span>)]; } completion:^(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> finished) { [animatingView removeFromSuperview]; }]; }</code> </pre><br>  If you look closely at these two methods, you can see three advantages of the block method: <br><br><ul><li>  <b>Simplifies the code</b> .  With a block, we do not need to define an absolutely separate method to complete the callback, or to <b>begin beginAnimations</b> / <b>commitAnimations</b> . </li><li>  <b>All code lies in one place</b> .  Using a block, you do not need to start the animation in one place, and the callback method in another.  All the code associated with the animation is in one place, which makes it easier to write and read. </li><li>  <b>So says Apple</b> .  Apple rewrote existing functionality that did not use blocks, so Apple officially recommends switching to block-based methods, if possible. </li></ul><br><br><h3>  When to use blocks? </h3><br>  I think the best advice is to use blocks where they are needed.  You may want to continue using old methods to maintain backward compatibility, or simply because you are more familiar with them.  But every time you approach a decision point like this, consider whether blocks can make your code easier for you, and whether you should use methods with a block approach. <br><br>  Of course, over time, you may notice that you have become increasingly in need of blocks simply because most frameworks are written and rewritten using blocks.  So start using blocks now to meet them fully in the future. <br><br><h2>  Returning to iOS Diner: setting up model classes </h2><br>  We continue from the same place where we stopped <a href="https://habrahabr.ru/post/309780/">in the first part</a> .  If you have not read the first part, or just want to refresh everything in memory, you can download the project <a href="">here</a> . <br><br>  Open a project in Xcode and switch to <b>Project Navigator</b> .  Right-click the <b>iOSDiner</b> folder and select <b>New Group</b> .  Let's call it "Models". <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/e5a/8ba/d74/e5a8bad7415b421181c7bebab460c17e.png"></div><br>  Now right-click on the created <b>Models</b> folder and select the <b>New File ‚Üí Objective-C class</b> (or Cocoa Touch Class).  Let's call it ‚ÄúIODItem‚Äù and choose <b>NSObject</b> as the parent class. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5cb/dc2/b86/5cbdc2b863144331bff103d249ab4798.png"></div><br>  Repeat the above steps to create an <b>IODOrder</b> class. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/89b/fbb/3ce/89bfbb3ce927459bb88569b9f1727ee6.png"></div><br>  Now we have all the necessary classes.  It's code time. <br><br><h2>  IODItem setting </h2><br>  Open <b>IODItem.h</b> .  First of all, you need to add the <b>NSCopying</b> protocol to the <b>class</b> .  Protocols <br>  are a kind of "agreement" about the methods that the class will implement.  If a protocol is declared in a class, then in the same class it is necessary to define mandatory, or optional methods that are described in the protocol.  The protocol declaration is as follows: <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IODItem</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSCopying</span></span></span><span class="hljs-class">&gt;</span></span></code> </pre><br>  Next, add properties for the object.  Each object will have a name, a price, and a name for the image file.  <b>IODItem.h</b> will look like this: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface IODItem : NSObject </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;NSCopying&gt;</span></span></span><span class="hljs-meta"> @property (nonatomic,strong) NSString* name; @property (nonatomic,strong) float price; @property (nonatomic,strong) NSString* pictureFile; @end</span></span></code> </pre><br>  Now let's switch to <b>IODItem.m</b> .  Here we see a warning. <br><br><img src="https://habrastorage.org/files/b68/771/4d6/b687714d6a704375a832b4a2318dd58a.png"><br><br>  This warning refers to the <b>NSCopying</b> protocol that we added earlier.  Remember that protocols can describe required methods?  So <b>NSCopying</b> needs to determine <code>‚Äî (id)copyWithZone:(NSZone *)zone</code> .  Until this method is added, the class will be considered incomplete.  Add the <b>following</b> to <b>IODItem.m</b> before <b>@end</b> : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)copyWithZone:(<span class="hljs-built_in"><span class="hljs-built_in">NSZone</span></span> *)zone { IODItem *newItem = [[IODItem alloc] init]; newItem.name = _name; newItem.price = _price; newItem.pictureFile = _pictureFile; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> newItem; }</code> </pre><br>  That's all, the warning has disappeared.  This code creates a new IODItem object, copies the properties of an already existing object, and returns this new instance. <br><br>  Additionally, an initialization method is required.  It allows you to easily and quickly set the default values ‚Äã‚Äãof properties when an object is initialized.  Write in <b>IODItem.m</b> : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)initWithName:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)name andPrice:(<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> *)price andPictureFile:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *)pictureFile { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> init]) { _name = name; _price = price; _pictureFile = pictureFile; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>; }</code> </pre><br>  Return to <b>IODItem.h</b> and add the prototype of the method before the end of the file (@end): <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)initWithName:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)inName andPrice:(<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)inPrice andPictureFile:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)inPictureFile;</code> </pre><br><h2>  Configure IODOrder </h2><br>  Next, <b>let's</b> work on another class - <b>IODOrder</b> .  This class will be an order and operations associated with it - adding an object, deleting, calculating the total order value and displaying the contents of the order on the screen. <br><br>  Open <b>IODOrder.h</b> and add an import header file in front of the <a href="https://habrahabr.ru/users/interface/" class="user_link">interface</a> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IODItem.h"</span></span></span></span></code> </pre><br>  And under the <a href="https://habrahabr.ru/users/interface/" class="user_link">interface,</a> write the property: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span>* orderItems;</code> </pre><br>  This is a dictionary in which objects selected by the user will be stored. <br><br><h2>  ViewController setup </h2><br>  Switch to <b>ViewController.m</b> , add properties: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ViewController.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IODOrder.h"</span></span></span><span class="hljs-meta"> @interface ViewController () @property (assign, nonatomic) NSInteger currentItemIndex; @property (strong, nonatomic) NSMutableArray *inventory; @property (strong, nonatomic) IODOrder *order;</span></span></code> </pre><br>  The <b>currentItemIndex</b> property will remember the index of the object being viewed in inventory.  The meaning of <b>inventory is</b> easy to explain - this is an array of IODItem-elements that we get from a web service.  <b>order</b> is an object of class <b>IODOrder</b> , which stores objects selected by the user. <br><br>  Further, in the <b>viewDidLoad</b> method, <b>you</b> need to reset <b>currentItemIndex</b> and <b>order</b> . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)viewDidLoad { [<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> viewDidLoad]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order = [[IODOrder alloc] init]; }</code> </pre><br>  Now the beginning of <b>ViewController.m</b> looks like this: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ViewController.h"</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IODOrder.h"</span></span></span><span class="hljs-meta"> @interface ViewController () @property (assign, nonatomic) NSInteger currentItemIndex; @property (strong, nonatomic) NSMutableArray *inventory; @property (strong, nonatomic) IODOrder *order; @end @implementation ViewController - (void)viewDidLoad { [super viewDidLoad]; self.currentItemIndex = 0; self.order = [[IODOrder alloc] init]; }</span></span></code> </pre> <br>  Build the project.  There should be no warnings. <br><br><h2>  We load inventory </h2><br>  The class method <b>retrieveInventoryItems</b> , which we will now add, will load and process the inventory loaded from the web service. <br><br>  <b>Note</b>  Class methods begin with ‚Äú+‚Äù, and class instance methods begin with ‚Äú-‚Äù. <br><br>  In <b>IODItem.m,</b> immediately after the <b>#import</b> directives, add the following: <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#define INVENTORY_ADDRESS @</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"http://adamburkepile.com/inventory/"</span></span></span></span></code> </pre><br>  <b>Note</b>  Change the address if you hosted the web service yourself. <br><br>  Next, add the <b>retrieveInventoryItems</b> method. <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)retrieveInventoryItems { <span class="hljs-comment"><span class="hljs-comment">// 1 ‚Äî   NSMutableArray *inventory = [[NSMutableArray alloc] init]; NSError *error = nil; // 2 ‚Äî     NSArray *jsonInventory = [NSJSONSerialization JSONObjectWithData:[NSData dataWithContentsOfURL:[NSURL URLWithString:INVENTORY_ADDRESS]] options:kNilOptions error:&amp;error]; // 3 ‚Äî     [jsonInventory enumerateObjectsUsingBlock:^(id _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) { NSDictionary *item = obj; [inventory addObject:[[IODItem alloc] initWithName:item[@"Name"] andPrice:item[@"Price"] andPictureFile:item[@"Image"]]]; }]; // 4 ‚Äî    return [inventory copy]; }</span></span></code> </pre><br>  And here is our first unit.  Let's take a closer look at the code. <br><br><ol><li>  First, we declared an array in which we will store the objects to return, and a pointer to a possible error. <br><br></li><li>  We use an <b>NSData</b> object to load data from a web server, and then pass this NSData object to a <b>JSON</b> service to decode the source data in Objective-C types (NSArray, NSDictionary, NSString, NSNumber, etc.). <br><br></li><li>  Next, we need the <b>enumerateObjectsUsingBlock:</b> method, which we discussed earlier, to "convert" objects from an <b>NSDictionary</b> to an <b>IODItem</b> .  We call this method for the <b>jsonInventory</b> array, and <b>iterate</b> through it using a block that passes the array element as an <b>NSDictionary</b> to the initialization method of the IODItem object.  It then adds this new object to the returned array. <br><br></li><li>  Finally, an array of inventory is returned.  Notice that we are returning a copy of the array, not the array itself, because we do not want to return its variable version.  The <b>copy</b> method creates an immutable copy. </li></ol><br>  Now open <b>IODItem.h</b> and add the prototype of the method: <br><br><pre> <code class="objectivec hljs">+ (<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>*)retrieveInventoryItems;</code> </pre><br><h2>  Dispatch Queue and Grand Central Dispatch </h2><br>  Another thing you need to know is the <b>dispatch queue</b> .  Switch to <b>ViewController.m</b> and add a property. <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">@property</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">strong</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">nonatomic</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">dispatch_queue_t</span></span> queue;</code> </pre><br>  At the end of the <b>ViewDidLoad</b> method, write the line: <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.queue = dispatch_queue_create(<span class="hljs-string"><span class="hljs-string">"com.adamburkepile.queue"</span></span>,<span class="hljs-literal"><span class="hljs-literal">nil</span></span>);</code> </pre><br>  The first parameter to the <b>dispatch_queue_create</b> method is the name of the queue.  Call it what you will, but this name must be unique.  Therefore, Apple recommends a reverse DNS style for this name. <br><br>  Now let's use this queue.  Let's write in <b>viewDidAppear</b> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.text = <span class="hljs-string"><span class="hljs-string">@"Loading inventory..."</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory = [[IODItem retrieveInventoryItems] mutableCopy]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.text = <span class="hljs-string"><span class="hljs-string">@"Inventory Loaded\n\nHow can I help you?"</span></span>;</code> </pre><br>  Run the project.  Something is wrong, right?  We use the <b>retrieveInventoryItems</b> method, which is defined in <b>IODItem</b> to call the web service, return the inventory objects and put them into an array. <br><br>  Remember the five-second delay in the PHP script <a href="https://habrahabr.ru/post/309780/">from the last part</a> ?  But when we run the program, we do not see ‚ÄúLoading inventory ...‚Äù, then we wait five seconds, and we see ‚ÄúInventory Loaded‚Äù. <br><br>  The problem is this: a web service call blocks and ‚Äúfreezes‚Äù the main queue, and does not allow it to change the label's text.  If only we had a separate queue that could be used for such operations, without referring to the main line ... Stop!  We already have it.  This is where the <b>Grand Central Dispatch</b> and blocks can help us quite easily.  With <b>Grand Central Dispatch,</b> we can put data processing in a different queue without blocking the main one.  <b>Replace the</b> last two lines in <b>viewDidAppear</b> with the following: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.queue, ^{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory = [[IODItem retrieveInventoryItems] mutableCopy]; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.text = <span class="hljs-string"><span class="hljs-string">@"Inventory Loaded\n\nHow can I help you?"</span></span>; }); });</code> </pre><br>  Notice that here we use two different blocks that do not return anything and have no parameters. <br>  Run the project again.  Now it works as it should. <br><br>  You did not wonder why we call <b>dispatch_async</b> to assign the text to the label?  When you put the text in the label, you update the UI element, and everything that relates to the UI should be processed in the main queue.  Therefore, we call <b>dispatch_async</b> again, but only take the main queue and execute the block in it. <br>  This method is quite common when the operation takes a lot of time and the UI elements need to be updated. <br><br>  <b>Grand Central Dispatch</b> is a rather complex system, the role of which cannot be understood in this simple lesson.  If you are interested, read <a href="http://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial)">Multithreading and Grand Central Dispatch on iOS for Beginners</a> . <br><br><h2>  Additional methods </h2><br>  We use a web service to load and store inventory.  Now we need three helper methods that will display the stored inventory to the user. <br><br>  The first method, <b>findKeyForOrderItem:,</b> we will add to <b>IODOrder.m</b> .  It will be useful to access the object from the dictionary. <br><br><pre> <code class="objectivec hljs">- (IODItem *)findKeyForOrderItem:(IODItem *)searchItem { <span class="hljs-comment"><span class="hljs-comment">//1 -     NSIndexSet *indexes = [[self.orderItems allKeys] indexesOfObjectsPassingTest:^BOOL(id _Nonnull obj, NSUInteger idx, BOOL * _Nonnull stop) { IODItem *key = obj; return ([searchItem.name isEqualToString:key.name] &amp;&amp; searchItem.price == key.price); }]; //2 -     if([indexes count] &gt;=1) { IODItem *key = [self.orderItems allKeys][[indexes firstIndex]]; return key; } //3 -     return nil; }</span></span></code> </pre><br>  Let's see what this method does.  But before doing this, I must explain why it is needed at all.  The <b>IODOrder</b> object contains an <b>orderItems</b> dictionary (key-value pairs).  The key is an <b>IODItem</b> , and the value is an <b>NSNumber</b> , which indicates how many such <b>IODItem has</b> been ordered. <br><br>  In theory, everything is fine, but a peculiar quirk of the <b>NSDictionary</b> class is that when you want to assign an object as a key, it does not assign this object, but creates its copy and uses it as a key.  This means that the object that you use as a key must comply with the <b>NSCopying</b> protocol (this is why we in <b>IODItem</b> declared the <b>NSCopying</b> protocol). <br><br>  The key in the <b>orderItems</b> dictionary and <b>IODItem</b> in the <b>inventory</b> array are not the same object (although they have the same properties), so we cannot do a simple search by key.  Instead, we will have to compare the name and price of each object to determine their coincidence.  The above method does this: compares the properties of the keys to find the one you need. <br><br>  This is what the code does: <br><br><ol><li>  We <b>iterate</b> through the <b>orderItems</b> dictionary keys using the <b>indexesOfObjectsPassingTest</b> method <b>:</b> to find the name and price matches ‚Äî another example of a block.  Notice the <b>bool</b> after ^.  This is the type of return value.  This method processes an array, using a block to compare two objects, returns the indices of all the objects that pass the test described in the block. </li><li>  Here we take the first index from the returned </li><li>  3. Return nil if the matching key was not found. </li></ol><br>  Do not forget to add a prototype method in IODOrder.h. <br><br><pre> <code class="objectivec hljs">- (IODItem*)findKeyForOrderItem:(IODItem*)searchItem;</code> </pre><br>  Navigate to <b>ViewController.m</b> and add the following method: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)updateCurrentInventoryItem { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex &gt;=<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex &lt; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory count]) { IODItem* currentItem = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibCurrentItemLabel.text = currentItem.name; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibCurrentItemLabel.adjustsFontSizeToFitWidth = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibCurrentItemImageView.image = [<span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> imageNamed:[currentItem pictureFile]]; } }</code> </pre><br>  Using <b>currentItemIndex</b> and the <b>inventory</b> array, this method displays the name and image for each inventory item. <br><br>  We register one more method: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)updateInventoryButtons { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory || ![<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory count]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibAddItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibRemoveItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibNextItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibPreviousItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibTotalOrderButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibPreviousItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibPreviousItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex &gt;= [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory count]<span class="hljs-number"><span class="hljs-number">-1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibNextItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibNextItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } IODItem* currentItem = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentItem) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibAddItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibAddItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order findKeyForOrderItem:currentItem]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibRemoveItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibRemoveItemButton.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order.orderItems count]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibTotalOrderButton.enabled = <span class="hljs-literal"><span class="hljs-literal">NO</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibTotalOrderButton.enabled = <span class="hljs-literal"><span class="hljs-literal">YES</span></span>; } } }</code> </pre><br>  This method is the longest of the three helper methods, but rather simple.  It checks the program status and determines whether to make one or another button active. <br><br>  For example, if <b>currentItemIndex</b> is zero, <b>ibPreviousItemButton</b> should not be active, because there are no items before the first one.  If there are no elements in <b>orderItems</b> , then the <b>ibTotalOrderButton</b> button <b>should</b> not be active, because there is no order for which to calculate the amount. <br><br>  So, with these three methods you can now create magic.  Let's go back to <b>viewDidAppear</b> in <b>ViewController.m</b> and add at the very beginning: <br><br><pre> <code class="objectivec hljs">[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons];</code> </pre><br>  Then replace the block with this one: <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(queue, ^{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory = [[IODItem retrieveInventoryItems] mutableCopy]; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.text = <span class="hljs-string"><span class="hljs-string">@"Inventory Loaded\n\nHow can I help you?"</span></span>; }); });</code> </pre><br>  Build and run. <br><br>  Oh, and here is the hamburger.  But we want to see the rest of the food, so let's make the buttons work. <br><br>  The <b>ibaLoadNextItem:</b> and <b>ibaLoadPreviousItem methods:</b> we already have <b>ViewController.m</b> .  Add some code. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaLoadPreviousItem:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex--; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; } - (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaLoadNextItem:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex++; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; }</code> </pre><br>  Thanks to those helper methods, switching between objects with changing <b>currentItemIndex</b> and updating the UI has become very easy.  Compile and run.  Now you can see all the menus. <br><br><h2>  We delete and add an object. </h2><br>  We have a menu, but there is no waiter to take an order.  In other words, the add and remove buttons do not work.  Well, the time has come. <br><br>  We need another helper method in the <b>IODOrder</b> class.  In I <b>ODOrder.m</b> we write the following: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> *)orderItems{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_orderItems) { _orderItems = [[<span class="hljs-built_in"><span class="hljs-built_in">NSMutableDictionary</span></span> alloc] init]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _orderItems; }</code> </pre><br>  This is a simple getter method for the <b>orderItems</b> property.  If <b>there is</b> already something in <b>orderItems</b> , the method will return an object.  And if not, it will create a new dictionary and assign it to <b>orderItems</b> , and then return it. <br><br>  Next, <b>let's</b> work on the <b>orderDescription</b> method.  This method will give us lines for output to the chalk board.  In <b>IODOrder.m</b> we write: <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)orderDescription { <span class="hljs-comment"><span class="hljs-comment">// 1 -   NSMutableString* orderDescription = [[NSMutableString alloc] init]; // 2 -     NSArray* keys = [[self.orderItems allKeys] sortedArrayUsingComparator:^NSComparisonResult(id obj1, id obj2) { IODItem* item1 = (IODItem*)obj1; IODItem* item2 = (IODItem*)obj2; return [item1.name compare:item2.name]; }]; // 3 -          [keys enumerateObjectsUsingBlock:^(id obj, NSUInteger idx, BOOL *stop) { IODItem* item = (IODItem*)obj; NSNumber* quantity = (NSNumber*)[self.orderItems objectForKey:item]; [orderDescription appendFormat:@"%@ x%@\n", item.name, quantity]; }]; // 4 -      return [orderDescription copy]; }</span></span></code> </pre><br>  A bit of explanation: <br><br><ol><li>     .       . </li><li>         orderItems    <b>sortedArrayUsingComparator:</b>     . </li><li>            <b>enumerateObjectsUsingBlock:</b> .     <b>IODItem</b> ,   (),     <b>orderDescription</b> . </li><li> ,   <b>orderDescription</b> ,     . </li></ol><br>   <b>IODOrder.h</b>      . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)updateCurrentInventoryItem; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)updateInventoryButtons;</code> </pre><br> ,         ,   <b>ViewController.m</b>     . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)updateOrderBoard { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order.orderItems count]) { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.text = <span class="hljs-string"><span class="hljs-string">@"No Items. Please order something!"</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.text = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order orderDescription]; } }</code> </pre><br>       .   ,   ¬´No Items. Please order something!¬ª.  ,   <b>orderDescription</b>    <b>IODOrder</b>      . <br><br>          .     <b>viewDidAppear</b> : <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.queue, ^{ <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory = [[IODItem retrieveInventoryItems] mutableCopy]; <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_main_queue(), ^{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateOrderBoard]; <span class="hljs-comment"><span class="hljs-comment">//&lt;----   [self updateInventoryButtons]; [self updateCurrentInventoryItem]; self.ibChalkboardLabel.text = @"Inventory Loaded\n\nHow can I help you?"; }); });</span></span></code> </pre><br>  ,     ,          ,      . <br><br>       .   <b>IODOrder.m</b> . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addItemToOrder:(IODItem*)inItem { <span class="hljs-comment"><span class="hljs-comment">// 1 -     IODItem* key = [self findKeyForOrderItem:inItem]; // 2 -     -  if (!key) { [self.orderItems setObject:[NSNumber numberWithInt:1] forKey:inItem]; } else { // 3 -   -   NSNumber* quantity = self.orderItems[key]; int intQuantity = [quantity intValue]; intQuantity++; // 4 -      [self.orderItems removeObjectForKey:key]; [self.orderItems setObject:[NSNumber numberWithInt:intQuantity] forKey:key]; } }</span></span></code> </pre><br> : <br><br><ol><li>         <b>orderItem</b> .  , ,    ,    <b>nil</b> . </li><li>       ,    ,  1. </li><li>     ,         1. </li><li> ,          . </li></ol><br>  <b>removeItemFromOrder:</b>   ,   <b>addItemToOrder:</b> .  <b>IODOrder.m</b> : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)removeItemFromOrder:(IODItem*)inItem { <span class="hljs-comment"><span class="hljs-comment">// 1 -     IODItem* key = [self findKeyForOrderItem:inItem]; // 2 -  ,     if (key) { // 3 -  ,     NSNumber* quantity = self.orderItems[key]; int intQuantity = [quantity intValue]; intQuantity--; // 4 -   [[self orderItems] removeObjectForKey:key]; // 5 -           0 if (intQuantity) [[self orderItems] setObject:[NSNumber numberWithInt:intQuantity] forKey:key]; } }</span></span></code> </pre><br> ,         - ,      .   ,    ,   1,         ,    0. <br><br>   <b>IODOrder.h</b>   : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)addItemToOrder:(IODItem*)inItem; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)removeItemFromOrder:(IODItem*)inItem;</code> </pre><br>   ViewController.m         : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaRemoveItem:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { IODItem* currentItem = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order removeItemFromOrder:currentItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateOrderBoard]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; } - (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaAddItem:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { IODItem* currentItem = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order addItemToOrder:currentItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateOrderBoard]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; }</code> </pre><br> ,        ‚Äî      ,    <b>addItemToOrder:</b>  <b>removeItemFromOrder:</b> ,   UI. <br><br>    .      ,   . <br><br><h2> UIAnimation </h2><br>     .  <b>ibaRemoveItem:</b>  <b>ibaAddItemMethod:</b> <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaRemoveItem:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { IODItem* currentItem = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory objectAtIndex:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order removeItemFromOrder:currentItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateOrderBoard]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span>* removeItemDisplay = [[<span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> alloc] initWithFrame:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibCurrentItemImageView.frame]; removeItemDisplay.center = <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.center; removeItemDisplay.text = <span class="hljs-string"><span class="hljs-string">@"-1"</span></span>; removeItemDisplay.textAlignment = <span class="hljs-built_in"><span class="hljs-built_in">NSTextAlignmentCenter</span></span>; removeItemDisplay.textColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> redColor]; removeItemDisplay.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; removeItemDisplay.font = [<span class="hljs-built_in"><span class="hljs-built_in">UIFont</span></span> boldSystemFontOfSize:<span class="hljs-number"><span class="hljs-number">32.0</span></span>]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> view] addSubview:removeItemDisplay]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> animateWithDuration:<span class="hljs-number"><span class="hljs-number">1.0</span></span> animations:^{ removeItemDisplay.center = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibCurrentItemImageView center]; removeItemDisplay.alpha = <span class="hljs-number"><span class="hljs-number">0.0</span></span>; } completion:^(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> finished) { [removeItemDisplay removeFromSuperview]; }]; } - (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaAddItem:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { IODItem* currentItem = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.inventory objectAtIndex:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.currentItemIndex]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order addItemToOrder:currentItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateOrderBoard]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateCurrentInventoryItem]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> updateInventoryButtons]; <span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span>* addItemDisplay = [[<span class="hljs-built_in"><span class="hljs-built_in">UILabel</span></span> alloc] initWithFrame:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibCurrentItemImageView.frame]; addItemDisplay.text = <span class="hljs-string"><span class="hljs-string">@"+1"</span></span>; addItemDisplay.textColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> whiteColor]; addItemDisplay.backgroundColor = [<span class="hljs-built_in"><span class="hljs-built_in">UIColor</span></span> clearColor]; addItemDisplay.textAlignment = <span class="hljs-built_in"><span class="hljs-built_in">NSTextAlignmentCenter</span></span>; addItemDisplay.font = [<span class="hljs-built_in"><span class="hljs-built_in">UIFont</span></span> boldSystemFontOfSize:<span class="hljs-number"><span class="hljs-number">32.0</span></span>]; [[<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> view] addSubview:addItemDisplay]; [<span class="hljs-built_in"><span class="hljs-built_in">UIView</span></span> animateWithDuration:<span class="hljs-number"><span class="hljs-number">1.0</span></span> animations:^{ [addItemDisplay setCenter:<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.ibChalkboardLabel.center]; [addItemDisplay setAlpha:<span class="hljs-number"><span class="hljs-number">0.0</span></span>]; } completion:^(<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> finished) { [addItemDisplay removeFromSuperview]; }]; }</code> </pre> <br>  ,   .    UILabel    .  ‚Äî ,    .     UIView-  ,      . <br><br>  .            . <br><br><h2>   (Total) </h2><br>  ,      <b>IODOrder.m</b> ‚Äî    . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)totalOrder { <span class="hljs-comment"><span class="hljs-comment">// 1 -       __block float total = 0.0; // 2 -    float (^itemTotal)(float,int) = ^float(float price, int quantity) { return price * quantity; }; // 3 -       [self.orderItems enumerateKeysAndObjectsUsingBlock:^(id key, id obj, BOOL *stop) { IODItem* item = (IODItem*)key; NSNumber* quantity = (NSNumber*)obj; int intQuantity = [quantity intValue]; total += itemTotal([item.price floatValue], intQuantity); }]; // 4 -   return total; }</span></span></code> </pre><br>   : <br><br><ol><li>    ,    .    <b>__block</b> .       .     <b>__block</b> , ,    ,          .  ,        .              . </li><li>    ,      ,    . </li><li>      <b>enumerateKeysAndObjectsUsingBlock:</b>      <b>orderItems</b>         ,         (      <b>__block</b>    ‚Äî     ). </li><li>    . </li></ol><br>   <b>IODOrder.h</b>   . <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)totalOrder;</code> </pre><br> ,    ‚Äî     .       <b>totalOrder</b> ,          <b>Total</b> .   <b>ibaCalculateTotal</b> : <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">IBAction</span></span>)ibaCalculateTotal:(<span class="hljs-built_in"><span class="hljs-built_in">UIButton</span></span> *)sender { <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> total = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>.order totalOrder]; <span class="hljs-built_in"><span class="hljs-built_in">UIAlertController</span></span> *alert = [<span class="hljs-built_in"><span class="hljs-built_in">UIAlertController</span></span> alertControllerWithTitle:<span class="hljs-string"><span class="hljs-string">@"Total"</span></span> message:[<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"$%0.2f"</span></span>,total] preferredStyle:<span class="hljs-built_in"><span class="hljs-built_in">UIAlertControllerStyleAlert</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">UIAlertAction</span></span> *cancelButton = [<span class="hljs-built_in"><span class="hljs-built_in">UIAlertAction</span></span> actionWithTitle:<span class="hljs-string"><span class="hljs-string">@"Close"</span></span> style:<span class="hljs-built_in"><span class="hljs-built_in">UIAlertActionStyleDefault</span></span> handler:^(<span class="hljs-built_in"><span class="hljs-built_in">UIAlertAction</span></span> * action) { [alert dismissViewControllerAnimated:<span class="hljs-literal"><span class="hljs-literal">YES</span></span> completion:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; }]; [alert addAction:cancelButton]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> presentViewController:alert animated:<span class="hljs-literal"><span class="hljs-literal">YES</span></span> completion:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; }</code> </pre> <br>          . <br><br>  That's all!  . <br><br><img src="https://habrastorage.org/files/8ab/734/643/8ab7346431134d6a85961480978c20b5.png"><br><br><h2>    </h2><br>   ,   ,   . <br><br><h3> NSArray </h3><br><ul><li> <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSArray_Class/index.html">enumerateObjectsUsingBlock</a> ‚Äî ,        . </li><li> <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSArray_Class/index.html">enumerateObjectsAtIndexes:usingBlock:</a> ‚Äî  ,   <b>enumerateObjectsUsingBlock</b> ,       . </li><li> <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSArray_Class/index.html">indexesOfObjectsPassingTest:</a> ‚Äî     ,   ,  .      . </li></ul><br><h3> NSDictionary </h3><br><ul><li> <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSDictionary_Class/index.html">enumerateKeysAndObjectsUsingBlock:</a> ‚Äî   . </li><li> <a href="https://developer.apple.com/library/ios/documentation/Cocoa/Reference/Foundation/Classes/NSDictionary_Class/index.html">keysOfEntriesPassingTest:</a> ‚Äî   ,    ,  . </li></ul><br><br><h3> UIView </h3><br><ul><li> <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html">animateWithDuration:animations:</a> ‚Äî   UIAnimation,    . </li><li> <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIView_Class/index.html">animateWithDuration:completion:</a> ‚Äî   UIAnimation.         . </li></ul><br><h3> Grand Central Dispatch </h3><br><ul><li> <a href="https://developer.apple.com/library/ios/documentation/Performance/Reference/GCD_libdispatch_Ref/index.html">dispatch_async</a> ‚Äî     GCD . </li></ul><br><h2>     </h2><br>        . <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//  ,    - (void)doMathWithBlock:(int (^)(int, int))mathBlock { self.label.text = [NSString stringWithFormat:@"%d", mathBlock(3, 5)]; } //     - (IBAction)buttonTapped:(id)sender { [self doMathWithBlock:^(int a, int b) { return a + b; }]; }</span></span></code> </pre><br>    ‚Äî   Objective-C,         .  ,           (  , ). <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//   @property (strong) int (^mathBlock)(int, int); //       - (void)doMathWithBlock:(int (^)(int, int))mathBlock { self.mathBlock = mathBlock; } //     - (IBAction)buttonTapped:(id)sender { [self doMathWithBlock:^(int a, int b) { return a + b; }]; } // ... - (IBAction)button2Tapped:(id)sender { self.label.text = [NSString stringWithFormat:@"%d", self.mathBlock(3, 5)]; } }</span></span></code> </pre><br> ,   ,  <b>typedef</b> . <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">//typedef   typedef int (^MathBlock)(int, int); //  ,  typedef @property (strong) MathBlock mathBlock; //     - (void)doMathWithBlock:(MathBlock) mathBlock { self.mathBlock = mathBlock; } //     - (IBAction)buttonTapped:(id)sender { [self doMathWithBlock:^(int a, int b) { return a + b; }]; } // ... - (IBAction)button2Tapped:(id)sender { self.label.text = [NSString stringWithFormat:@"%d", self.mathBlock(3, 5)]; }</span></span></code> </pre> <br><h2>    </h2><br>  .    ,   , Xcode     ,       . <br><br> , : <br><br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> * array; [array <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span></code> </pre> <br>    <b>enumerateObjectsUsingBlock</b> ‚Äî  <b>Enter</b>  .   <b>Enter</b>    .   : <br><br><pre> <code class="objectivec hljs">[array enumerateObjectsUsingBlock:^(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> obj, <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> idx, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> *stop) { code }</code> </pre><br>      <b>code</b> ,   ,   ‚Äî  ,    . <br><br><pre> <code class="objectivec hljs">[array enumerateObjectsUsingBlock:^(<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> obj, <span class="hljs-built_in"><span class="hljs-built_in">NSUInteger</span></span> idx, <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> *stop) { <span class="hljs-comment"><span class="hljs-comment">// Do something }];</span></span></code> </pre><br><h2>   ? </h2><br>     <a href=""></a> .     git,    <a href="https://github.com/acburk/iOSDiner"></a>     . ,              ,          . <br><br>        ‚Äî    .       ,    . <br><br>       : <br><br><ol><li> <a href="http://developer.apple.com/library/IOS/">Apple: Getting Started With Blocks</a> </li><li> <a href="https://developer.apple.com/library/ios/documentation/General/Conceptual/ConcurrencyProgrammingGuide/Introduction/Introduction.html">Apple: Concurrency Programming</a> </li><li> <a href="https://www.raywenderlich.com/4295/multithreading-and-grand-central-dispatch-on-ios-for-beginners-tutorial)">GCD Tutorial</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/309846/">https://habr.com/ru/post/309846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309834/index.html">Understanding Go: the encoding package</a></li>
<li><a href="../309836/index.html">Setting and using speed limit for Open vSwitch with DPDK</a></li>
<li><a href="../309840/index.html">Android Dev: continued podcasts about professional development for Android</a></li>
<li><a href="../309842/index.html">Exit "in the field": How we made a mobile application to increase the efficiency of field workers</a></li>
<li><a href="../309844/index.html">How to render the frame of the new Doom</a></li>
<li><a href="../309848/index.html">Three JavaScript performance principles that make Bluebird fast</a></li>
<li><a href="../309850/index.html">1C, .Net Core. Dynamic compilation of a wrapper class for receiving events of a .Net object in 1C</a></li>
<li><a href="../309852/index.html">DevFest season 2016 in 10 cities of Russia</a></li>
<li><a href="../309854/index.html">Five kinds of game crafting systems</a></li>
<li><a href="../309856/index.html">We are recruiting a technical support team: instructions for use</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>