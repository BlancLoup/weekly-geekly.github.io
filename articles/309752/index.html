<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refactoring sequential checks in Mockito using fluent interfaces</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Static methods have one powerful, but at the same time highly undesirable feature: they can be called from any place in the code, without really being...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refactoring sequential checks in Mockito using fluent interfaces</h1><div class="post__text post__text-html js-mediator-article"><p> Static methods have one powerful, but at the same time highly undesirable feature: they can be called from any place in the code, without really being able to regulate the order of their call.  Often such control is very important, but sometimes the order does not make very much sense.  For example, checks in unit tests can often not be done in a very strict order.  And in order to ensure that all checks are completed in the tested unit, the same <code>verifyNoMoreInteractions(...)</code> static method <code>verifyNoMoreInteractions(...)</code> .  Sometimes you can mistakenly call such a method even before the last <code>verify(...)</code> and then with chagrin observe the "red" test.  But what if to shift the care of the procedure for performing checks on the compiler itself? </p><br><a name="habracut"></a><br><p>  Suppose a test module has the following test: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractStructuredLoggingTest</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IStructuredLogger mockStructuredLogger = mock(IStructuredLogger.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> T unit; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull IStructuredLogger logger)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> IStructuredLogger </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMockStructuredLogger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mockStructuredLogger; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">final</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> unit; } <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initializeMockStructuredLogger</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  . `selfAnswer()` --   ,      fluent- when(mockStructuredLogger.begin()).thenAnswer(selfAnswer()); when(mockStructuredLogger.put(any(LogEntryKey.class), any(Object.class))).thenAnswer(selfAnswer()); when(mockStructuredLogger.log(any(Scope.class), any(Severity.class), any(String.class))).thenAnswer(selfAnswer()); when(mockStructuredLogger.end()).thenAnswer(selfAnswer()); //      (  , ).     --    . unit = createUnit(mockStructuredLogger); } @After public void resetMockStructuredLogger() { try { // ,        verifyNoMoreInteractions(mockStructuredLogger); } finally { //   ,   ,     ... reset(mockStructuredLogger); } } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdministratorServiceStructuredLoggingTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractStructuredLoggingTest</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAdministratorService</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String USERNAME = <span class="hljs-string"><span class="hljs-string">"john.doe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PASSWORD = <span class="hljs-string"><span class="hljs-string">"opZK2lkXa"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String FIRST_NAME = <span class="hljs-string"><span class="hljs-string">"john"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String LAST_NAME = <span class="hljs-string"><span class="hljs-string">"doe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String EMAIL = <span class="hljs-string"><span class="hljs-string">"john.doe@acme.com"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> IAdministratorService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IStructuredLogger logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createAdministratorService(logger); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> T unit = getUnit(); unit.create(USERNAME, PASSWORD, FIRST_NAME, LAST_NAME, EMAIL); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IStructuredLogger mockStructuredLogger = getMockStructuredLogger(); verify(mockStructuredLogger).put(eq(OPERATION_CALLER_CLASS), any(IAdministratorService.class)); verify(mockStructuredLogger).put(eq(OPERATION_CALLER_METHOD), any(Method.class)); verify(mockStructuredLogger).put(eq(OPERATION_TYPE), eq(CREATE)); verify(mockStructuredLogger).put(eq(OPERATION_OBJECT_TYPE), eq(ADMINISTRATOR)); verify(mockStructuredLogger).put(eq(VALUE_ADMINISTRATOR_NAME), eq(USERNAME)); verify(mockStructuredLogger).put(eq(VALUE_FIRST_NAME), eq(FIRST_NAME)); verify(mockStructuredLogger).put(eq(VALUE_LAST_NAME), eq(LAST_NAME)); verify(mockStructuredLogger).put(eq(VALUE_EMAIL), eq(EMAIL)); verify(mockStructuredLogger).log(eq(APP_DEV), eq(INFO), any(String.class)); verifyNoMoreInteractions(mockStructuredLogger); } }</code> </pre> <br><p>  It‚Äôs easy to guess exactly what this test is testing: it checks whether the tested method of the unit has called all the important methods of the structured logger.  Since at the end of the test there is also called <code>verifyNoMockInteractions(...)</code> , it is guaranteed that the mock has no methods left for which no checks have been written.  By the way, the interface of the structured logger is extremely simple, but I will bring it here in a somewhat truncated form, because the code is taken from a real project. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStructuredLogger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     ,   ,          . @Nonnull IStructuredLogger begin() throws IllegalStateException; //  ,    . // key --  (enum)     (OPERATION_CALLER_CLASS, VALUE_FIRST_NAME  ..) // value --   @Nonnull IStructuredLogger put(@Nonnull LogEntryKey key, @Nullable Object value) throws IllegalStateException; //    . // scope --    (, APP_DEV --         ) // severity --     ,    ,     (ERROR, INFO  ..) // message --  ,      @Nonnull IStructuredLogger log(@Nonnull Scope scope, @Nonnull Severity severity, @Nonnull String message) throws IllegalStateException; //   begin() @Nonnull IStructuredLogger end() throws IllegalStateException; }</span></span></code> </pre> <br><p>  As mentioned above, the static methods with which the test is littered do not guarantee that all types of checks will be implemented.  And, for sure, such a test will end with an error.  By types of checks in this test, I mean the ability to determine: </p><br><ul><li>  what class is attached to the event in the log; </li><li>  what action was performed and on what kind of objects; </li><li>  what arguments for the action was filled in the event log; </li><li>  which journals were physically involved in the journaling process; </li><li>  the structured logger in the unit method was no longer used for anything. </li></ul><br><p>  In fact, there is a finite set of requirements that could be made to execute in a certain order. <br>  To solve this problem, you can consider options using <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25B0%25D1%2582%25D0%25B5%25D0%25B3%25D0%25B8%25D1%258F_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">the strategy template</a> , where there would be a certain interface with methods for each type of check, and each method would be responsible for its own aspect of logging.  Or, for example, a <a href="https://ru.wikipedia.org/wiki/%25D0%25A8%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">template method</a> .  But it is obvious that such approaches would be very cumbersome, unreliable in terms of guaranteeing the separation of aspects according to their respective methods.  Yes, and readability would have to sacrifice, which certainly would not want to do. </p><br><p>  Five years ago, I remember, I came across an article on the Internet describing the implementation <a href="https://ru.wikipedia.org/wiki/%25D0%25A1%25D1%2582%25D1%2580%25D0%25BE%25D0%25B8%25D1%2582%25D0%25B5%25D0%25BB%25D1%258C_(%25D1%2588%25D0%25B0%25D0%25B1%25D0%25BB%25D0%25BE%25D0%25BD_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B5%25D0%25BA%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F)">of a builder pattern</a> , which, using some not entirely obvious techniques, ensured that the creation of a complex object would be carried out in the correct order.  The following is meant: for a certain object-builder, you can first call only the <code>setFoo()</code> method, and only then <code>setBar()</code> followed by <code>build()</code> .  And in no way in another order, because the compiler keeps an eye on the order! </p><br><p>  A similar approach, but with a different implementation, can be used to simplify the writing of tests according to the rules described above strictly in the same order, without using the template method.  Given the somehow formalized features of testing in this case, you can create a set of such interfaces, which will deal with the coupling of such transitions.  And for convenience, you can use a <a href="https://ru.wikipedia.org/wiki/Fluent_interface">fluid interface</a> that allows you to build an elegant chain of checks. </p><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// ,  ,          @FunctionalInterface public interface IOperationCallerVerificationStep { // unitMatcherSupplier --   // methodMatcherSupplier --  ,      //    ,      --      @Nonnull IOperationTypeVerificationStep withOperationCaller( @Nonnull Supplier&lt;?&gt; unitMatcherSupplier, @Nonnull Supplier&lt;Method&gt; methodMatcherSupplier ); //   ,      ,     .   //  ,       -.      //  (,        ,   [APT](http://docs.oracle.com/javase/7/docs/technotes/guides/apt/))   //   .   ,     __ //    Method,        . @Nonnull default IOperationTypeVerificationStep withOperationCaller( @Nonnull final Supplier&lt;?&gt; unitMatcherSupplier ) { return withOperationCaller(unitMatcherSupplier, () -&gt; any(Method.class)); } }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// ,        @FunctionalInterface public interface IOperationTypeVerificationStep { // operationTypeMatcherSupplier --    // objectTypeMatcherSupplier --   ,     @Nonnull IValueVerificationStep withOperationType( @Nonnull Supplier&lt;OperationType&gt; operationTypeMatcherSupplier, @Nonnull Supplier&lt;ObjectType&gt; objectTypeMatcherSupplier ); }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">// ,     (.., ,     ) public interface IValueVerificationStep { // logEntryKeyMatcherSupplier --       // valueMatcherSupplier --   // ,        ,      //  -- ..,      ,     //   . @Nonnull IValueVerificationStep withValue( @Nonnull Supplier&lt;LogEntryKey&gt; logEntryKeyMatcherSupplier, @Nonnull Supplier&lt;?&gt; valueMatcherSupplier ); //   .    ,      . @Nonnull ILogVerificationStep then(); }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  , ,           @FunctionalInterface public interface ILogVerificationStep { // scopeMatcherSupplier --   // severityMatcherSupplier --    // messageMatcherSupplier --   //   ,       void withLog( @Nonnull Supplier&lt;Scope&gt; scopeMatcherSupplier, @Nonnull Supplier&lt;Severity&gt; severityMatcherSupplier, @Nonnull Supplier&lt;String&gt; messageMatcherSupplier ); //       default void withLog( @Nonnull final Supplier&lt;Scope&gt; scopeMatcherSupplier, @Nonnull final Supplier&lt;Severity&gt; severityMatcherSupplier ) { withLog(scopeMatcherSupplier, severityMatcherSupplier, () -&gt; any(String.class)); } //   ,          ( APP,  DEV) default void withLog( @Nonnull final Supplier&lt;Severity&gt; severityMatcherSupplier ) { withLog(() -&gt; eq(APP_DEV), severityMatcherSupplier, () -&gt; any(String.class)); } }</span></span></code> </pre> <br><p>  Almost all interfaces turned out to be annotated as <code>@FunctionalInterface</code> , although this is not a necessity.  However, the variadic interface has two methods, since you need to somehow report the completion of the verification of the logging of the operation arguments.  So, the original test code can now take the following form: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractStructuredLoggingTest</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> IStructuredLogger mockStructuredLogger = mock(IStructuredLogger.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> T unit; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull IStructuredLogger logger)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// -!    ,          /*protected final IStructuredLogger getMockStructuredLogger() { return mockStructuredLogger; }*/ protected final T getUnit() { return unit; } @Before public void initializeMockStructuredLogger() { when(mockStructuredLogger.begin()).thenAnswer(selfAnswer()); when(mockStructuredLogger.put(any(LogEntryKey.class), any(Object.class))).thenAnswer(selfAnswer()); when(mockStructuredLogger.log(any(Scope.class), any(Severity.class), any(String.class))).thenAnswer(selfAnswer()); when(mockStructuredLogger.end()).thenAnswer(selfAnswer()); unit = createUnit(mockStructuredLogger); } @After public void resetMockStructuredLogger() { try { verifyNoMoreInteractions(mockStructuredLogger); } finally { reset(mockStructuredLogger); } } // ,      .       . //    ,      .    //  -.       ,   verify(...), //     .    verifyNoMoreInteractions  , //        . protected final IOperationCallerVerificationStep verifyLog() { return (unitMatcherSupplier, methodMatcherSupplier) -&gt; { verify(mockStructuredLogger).put(eq(OPERATION_CALLER_CLASS), unitMatcherSupplier.get()); verify(mockStructuredLogger).put(eq(OPERATION_CALLER_METHOD), methodMatcherSupplier.get()); return (IOperationTypeVerificationStep) (operationTypeMatcherSupplier, objectTypeMatcherSupplier) -&gt; { verify(mockStructuredLogger).put(eq(OPERATION_TYPE), operationTypeMatcherSupplier.get()); verify(mockStructuredLogger).put(eq(OPERATION_OBJECT_TYPE), objectTypeMatcherSupplier.get()); return new IValueVerificationStep() { @Nonnull @Override public IValueVerificationStep withValue(@Nonnull final Supplier&lt;LogEntryKey&gt; logEntryKeyMatcherSupplier, @Nonnull final Supplier&lt;?&gt; valueMatcherSupplier) { verify(mockStructuredLogger).put(logEntryKeyMatcherSupplier.get(), valueMatcherSupplier.get()); return this; } @Nonnull @Override public ILogVerificationStep then() { return (scopeMatcherSupplier, severityMatcherSupplier, messageMatcherSupplier) -&gt; verify(mockStructuredLogger).log(scopeMatcherSupplier.get(), severityMatcherSupplier.get(), messageMatcherSupplier.get()); } }; }; }; } }</span></span></code> </pre> <br><p>  And, actually, the simplification itself, for the sake of which the basic functionality of the tests was complicated: </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AdministratorServiceStructuredLoggingTest</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractStructuredLoggingTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String USERNAME = <span class="hljs-string"><span class="hljs-string">"usr"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String PASSWORD = <span class="hljs-string"><span class="hljs-string">"qwerty"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String FIRST_NAME = <span class="hljs-string"><span class="hljs-string">"john"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String LAST_NAME = <span class="hljs-string"><span class="hljs-string">"doe"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String EMAIL = <span class="hljs-string"><span class="hljs-string">"usr@mail.com"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Nonnull</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> IAdministratorService </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(@Nonnull </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> IStructuredLogger logger)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createAdministratorService(logger); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> T unit = getUnit(); unit.create(USERNAME, PASSWORD, FIRST_NAME, LAST_NAME, EMAIL); verifyLog() .withOperationCaller(() -&gt; any(IAdministratorService.class)) .withOperationType(() -&gt; eq(CREATE), () -&gt; eq(ADMINISTRATOR)) .withValue(() -&gt; eq(VALUE_ADMINISTRATOR_NAME), () -&gt; eq(USERNAME)) .withValue(() -&gt; eq(VALUE_FIRST_NAME), () -&gt; eq(FIRST_NAME)) .withValue(() -&gt; eq(VALUE_LAST_NAME), () -&gt; eq(LAST_NAME)) .withValue(() -&gt; eq(VALUE_EMAIL), () -&gt; eq(EMAIL)) .then() .withLog(() -&gt; eq(INFO)); } }</code> </pre> <br><p>  As for me, the code has become more reliable and very beautiful.  Yes, and more convenient too.  And most importantly - any smart IDE when you click on a dot itself tells you what the next step should be.  Thus, both the compiler and IDE add a little more confidence in how well the test is written.  By the way, why are <code>Supplier</code> and lambda expressions used?  The fact is that the Mockito checks whether stubs are transmitted directly to moki, and if not, throws an exception.  In fact, here, as far as I know, the rules are a bit more complicated, and, for example, Mockito ignores anonymous classes.  And because of this fact, there is a small loophole: Mockito does not track the transfer of matchrs through <code>return</code> , which opens the way to the use of lambda.  This complicates the code and readability a bit, but lambdas do a pretty good job of it. </p><br><p>  The result was the following result: </p><br><ul><li>  tests of the same type; </li><li>  each next step in the test formally describes its next step, which is perfectly complemented by support from the compiler and IDE, which is unattainable in the case of using static methods (at least in the initial version of the test); </li><li>  The initialization of tests and their subsequent verification is performed by an abstract test, and a specific test simply describes the checks, even without actually interacting with the original unit. </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/309752/">https://habr.com/ru/post/309752/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../309742/index.html">UX-strategy in practice. Part 4 - From Design Team to Design Culture</a></li>
<li><a href="../309744/index.html">Little more: the problems of the children's Internet</a></li>
<li><a href="../309746/index.html">ESP32: Getting to know, writing and launching the first firmware</a></li>
<li><a href="../309748/index.html">A cool online business idea. How to make money on someone else's name, someone else's site, and even without a product</a></li>
<li><a href="../309750/index.html">Open platform for developers of open source projects</a></li>
<li><a href="../309754/index.html">Email Marketing: Recipe for Correct Plain-Text Letters</a></li>
<li><a href="../309756/index.html">Modest - development of an open-source HTML rendering engine on the ‚Äúbare‚Äù C</a></li>
<li><a href="../309758/index.html">Shared Folders in OpenVZ 7.0</a></li>
<li><a href="../309760/index.html">How does the Center for the operational management of the MTS mobile network. Answers to your questions</a></li>
<li><a href="../309762/index.html">Home word splitting algorithm (with pictures)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>