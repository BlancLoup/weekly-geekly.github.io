<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>ASP.NET MVC Lesson E. Testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The purpose of the lesson. Learn how to create tests for code. NUnit. The principle of TDD. Mock. Unit tests. Integrated Testing. Data generation 

 T...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>ASP.NET MVC Lesson E. Testing</h1><div class="post__text post__text-html js-mediator-article">  <b>The purpose of the lesson.</b>  Learn how to create tests for code.  NUnit.  The principle of TDD.  Mock.  Unit tests.  Integrated Testing.  Data generation <br><br><h5>  Testing, TDD principle, unit testing and more. </h5><br>  Testing for me personally is a topic of many thoughts.  Need or don't need tests?  But no one will argue that resources are needed for writing tests. <br>  Consider two cases: <br><ol><li>  We make the site, we show the customer, he sends a list of inaccuracies and additional requests, we cheerfully rule them and give the site to the customer, i.e.  lay out on his server.  No one goes to his server, the customer understands that the miracle did not happen and stops paying for hosting / domain.  The site is dying.  Do we need tests there? </li><li>  We make the site, show the customer, he sends the list of edits, we cheerfully edit them, launch the site.  Six months later, the site has 300 unique per day, and this number is growing day by day.  The customer constantly asks for new features, the old code begins to grow, and over time it is harder to maintain. </li></ol><br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      You see, the dilemma is such that the result of launching the site is unpredictable.  I also had it so that the site made on my knee started up quite cheerfully, and it happened that the customer paid for the cool work, but did not even accept it.  So, the tactics of behavior can be: <br><ul><li>  Write tests always.  We are a cool company, we cover 90% of the code with all sorts of tests, and we really do not care that we spend 100,500 times more time / money on this, because the result is completely predictable and we are handsome. </li><li>  Do not write tests ever.  We are a cool company, we work so perfectly that we can rebuild the entire project in our mind, and if our code is compiled, it means that it is fully working.  If something is not working, then this is probably hosting, or an error in the browser.  or such a feature. </li><li>  Write tests, but not always.  Here we must understand that whatever the site or project, it consists of a functional.  And this means that users should be provided with all sorts of opportunities, and the opportunities are important, I would even say critical, somehow register on the site, place an order, add news or a comment.  It is unpleasant when you want, but you can not register, because the site is necessary. </li><li>  What are tests used for?  This is like the principle of double entry in the accounting department.  Every action, every functional is checked not only by the performance of the site, but also by at least one more test.  When changing the code, unit tests indicate that they have gone wrong and highlight in red the places where the violation occurred.  But is it? </li></ul><br><br>  Consider the principle of TDD: <br><ol><li>  Read the task and write a test that falls. </li><li>  Write any code that allows you to pass this test and the rest of the tests </li><li>  Do refactoring, i.e.  remove duplicate code if necessary, but so that all tests pass </li></ol><br><br>  For example, the following correction was given: <br><br>  We decided to add a tag field to the blog.  Since we already have many blog entries, we decided to make this field optional.  Since there is already an existing code, they did not use scaffolding.  Manually checked the creation of a record - everything is ok.  Run tests - everything is ok.  But forgot to add a change to the field in UpdatePost (cache.Tags = instance.Tags;).  When you change the old record, we add tags that are not actually saved.  In this case, the tests were a great success.  Life is pain! <br><br>  Well, as you can see, we have violated the basic principle of TDD - first write a test that collapses, and then write the code that processes it.  But (!) There is a second trick - we wrote a test that checks the creation of a blog entry with a tag.  Of course, this was not compiled right away (i.e., the test did not pass), but we added something like ‚Äúthrow new NotImplementedException ()‚Äù to the ModelView.  Everything compiled, the test is lit in red, we add this field with a tag, removing the exception, the test passes.  All other tests also pass.  The principles are respected, but the error remains. <br><br>  What can I say, for every principle there is a situation where it will not work.  Those.  there is no such thing - they turned off their brains and drove them.  One thing is for sure, and this is the main conclusion from these arguments: <br>  tests should be written quickly <br>  So what tasks we solve mainly on the site: <br><ul><li>  Adding information </li><li>  Verification of information </li><li>  Change information </li><li>  Deleting information </li><li>  Action rights check </li><li>  Issuance of information </li></ul><br><br>  These are the main actions.  How, for example, passes the registration: <br><ul><li>  Showing fields to fill </li><li>  When you click on "Register" check data </li><li>  If everything is successful, then we give the page ‚ÄúWell done‚Äù, if not everything is good, then we issue a warning and allow the error to be corrected </li><li>  If everything is good, then we have a record in the database. </li><li>  And we send a letter with activation </li></ul><br><br>  Let's create for all this unit tests: <br><ul><li>  What we show him fields to fill in (i.e., pass an empty object of the RegisterUserView class) </li><li>  That we have attributes and all that, we check that we really check what we can write to the database </li><li>  What we give out exactly "Good for you" page </li><li>  That a record appears, there were two records, and there were three records </li><li>  What we are trying to send something, find the template and call MailNotify. </li></ul><br>  Let's start, perhaps. <br><br><h5>  Install NUnit </h5><br>  Follow the link <a href="http://sourceforge.net/projects/nunit/">http://sourceforge.net/projects/nunit/</a> and install NUnit.  Also in VS we install the NUnit Test Adapter (well, to run the tests directly in VS). <br><br><img src="https://habrastorage.org/storage2/47d/077/030/47d077030a2a58e2dd6bea550a66884a.jpg"><br>  Create a daddy of type Solution Folder Test and add the LessonProject.UnitTest project to it and install NUnit there: <br><pre><code class="bash hljs">Install-Package NUnit</code> </pre> <br><br>  Create a UserControllerTest class in (/Test/Default/UserContoller.cs): <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">TestFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UserControllerTest</span></span> { }</code> </pre><br><br>  So, the principle of writing method method names Method_Scenario_ExpectedBehavior: <br><ul><li>  Method - the method [or property] that we are testing. </li><li>  Scenario - the script we are testing </li><li>  ExpectedBehavior - expected behavior </li></ul><br><br>  For example, we check the first thing that we return View with the class UserView for registration: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Register_GetView_ItsOkViewModelIsUserView</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"=====INIT======"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserController(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"======ACT======"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = controller.Register(); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"====ASSERT====="</span></span>); Assert.IsInstanceOf&lt;ViewResult&gt;(result); Assert.IsInstanceOf&lt;UserView&gt;(((ViewResult)result).Model); }</code> </pre><br><br>  So, all tests are divided into 3 parts Init-&gt; Act-&gt; Assert: <br><ul><li>  Init - initialization, we get our UserController </li><li>  Act - action, we run our controller.Register </li><li>  Assert - check that everything is true. </li></ul><br><br>  Open the Test Explorer tab: <br><img src="https://habrastorage.org/storage2/4d4/145/82d/4d414582db14c662abd0b32458f7249f.jpg"><br><br>  If the NUnit adapter was installed correctly, then we will see our test method. <br>  We start.  The test is passed, you can go to open the champagne.  Stoop.  This is only the easiest part, but what about the part where we save something.  In this case, we do not have a DB, our Repositary is null, zero, nothing. <br>  We now study the class and methods for initialization (documentation).  <b>SetUpFixture</b> - a class labeled with this attribute means that it has methods that perform initialization before tests and sweep after tests.  This refers to the same namespace. <br><ul><li>  The Setup method marked with this attribute is invoked before all test methods are executed.  If it is in a class with the TestFixture attribute, then it is called before executing methods of only this class. </li><li>  TearDown - the method marked with this attribute is called after the execution of all tests.  If it is in a class with the TestFixture attribute, then it is called after the execution of all methods. </li></ul><br><br>  Create the UnitTestSetupFixture.cs class (/Setup/UnitTestSetupFixture.cs): <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">SetUpFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">UnitTestSetupFixture</span></span> { [SetUp] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Setup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"==============="</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"=====START====="</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"==============="</span></span>); } [TearDown] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TearDown</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"==============="</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"=====BYE!======"</span></span>); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"==============="</span></span>); } }</code> </pre><br><br>  Run and get: <br> <code>=============== <br> =====START===== <br> =============== <br> =====INIT====== <br> ======ACT====== <br> ====ASSERT===== <br> <br> =============== <br> =====BYE!====== <br> =============== <br></code> <br><br><h5>  Mock </h5><br>  So, Mock is a parody object.  Those.  for example, not a database, but something similar to a database.  Mirage, in general.  There is a Stub - a stub.  Example stub method: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetRandom</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>; }</code> </pre><br><br>  But we will use mock: <br><pre> <code class="bash hljs">Install-Package Moq</code> </pre><br><br>  Determine what kind of environment we have, so that we initialize Mock objects for it.  In principle, this is all that we once carried to the Ninject Kernel: <br><ul><li>  Irepository </li><li>  Iconfig </li><li>  IMapper </li><li>  IAuthentication </li></ul><br><br>  And here I will make a small note.  We cannot render Config to mirages.  Not in terms of what is completely impossible, but in terms of what is a bad idea.  For example, we changed the letter pattern so that string.Format () throws a FormatException error.  And in the test everything is fine, the test passes perfectly.  And what is he responsible for after that?  Never.  So the original configuration file should be used.  Let's leave it for later. <br><br>  Regarding, iMapper - there is no need for this, we can safely use CommonMapper. <br>  But first, let's initiate IKernel to work in test mode.  In App_Start / NinjectWebCommon.cs, in the RegisterServices method, we specify how the interfaces should be implemented, and call it in bootstrapper.Initialize (CreateKernel).  In the future, we turn on the receipt of the service via DependencyResolver.GetService ().  So create a NinjectDependencyResolver (/Tools/NinjectDependencyResolver.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NinjectDependencyResolver</span></span> : <span class="hljs-title"><span class="hljs-title">IDependencyResolver</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IKernel _kernel; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NinjectDependencyResolver</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IKernel kernel</span></span></span><span class="hljs-function">)</span></span> { _kernel = kernel; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type serviceType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _kernel.TryGet(serviceType); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Type serviceType</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _kernel.GetAll(serviceType); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); } } }</code> </pre><br><br>  Add a method to SetUp (/Setup/UnitTestSetupFixture.cs): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">SetUp</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Setup</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitKernel(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> IKernel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitKernel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> kernel = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StandardKernel(); DependencyResolver.SetResolver(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NinjectDependencyResolver(kernel)); InitRepository(kernel); <span class="hljs-comment"><span class="hljs-comment">//  return kernel; }</span></span></code> </pre><br><br>  Create a MockRepository <br>  (/Mock/Repository/MockRepository.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockRepository</span></span> : <span class="hljs-title"><span class="hljs-title">Mock</span></span>&lt;<span class="hljs-title"><span class="hljs-title">IRepository</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MockRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MockBehavior mockBehavior = MockBehavior.Strict</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mockBehavior</span></span></span><span class="hljs-function">)</span></span> { GenerateRoles(); GenerateLanguages(); GenerateUsers(); } }</code> </pre><br>  (/Mock/Repository/Entity/Language.cs) <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">LessonProject.UnitTest.Mock</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Language&gt; Languages { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateLanguages</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Languages = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Language&gt;(); Languages.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Language() { ID = <span class="hljs-number"><span class="hljs-number">1</span></span>, Code = <span class="hljs-string"><span class="hljs-string">"en"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"English"</span></span> }); Languages.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Language() { ID = <span class="hljs-number"><span class="hljs-number">2</span></span>, Code = <span class="hljs-string"><span class="hljs-string">"ru"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">""</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.Languages).Returns(Languages.AsQueryable()); } } }</code> </pre><br><br>  (/Mock/Repository/Entity/Role.cs) <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Role&gt; Roles { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateRoles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Roles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Role&gt;(); Roles.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Role() { ID = <span class="hljs-number"><span class="hljs-number">1</span></span>, Code = <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, Name = <span class="hljs-string"><span class="hljs-string">"Administrator"</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.Roles).Returns(Roles.AsQueryable()); } }</code> </pre><br><br>  (/Mock/Repository/Entity/User.cs) <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockRepository</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;User&gt; Users { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenerateUsers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Users = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;User&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> admin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User() { ID = <span class="hljs-number"><span class="hljs-number">1</span></span>, ActivatedDate = DateTime.Now, ActivatedLink = <span class="hljs-string"><span class="hljs-string">""</span></span>, Email = <span class="hljs-string"><span class="hljs-string">"admin"</span></span>, FirstName = <span class="hljs-string"><span class="hljs-string">""</span></span>, LastName = <span class="hljs-string"><span class="hljs-string">""</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"password"</span></span>, LastVisitDate = DateTime.Now, }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> role = Roles.First(p =&gt; p.Code == <span class="hljs-string"><span class="hljs-string">"admin"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> userRole = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserRole() { User = admin, UserID = admin.ID, Role = role, RoleID = role.ID }; admin.UserRoles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> EntitySet&lt;UserRole&gt;() { userRole }; Users.Add(admin); Users.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> User() { ID = <span class="hljs-number"><span class="hljs-number">2</span></span>, ActivatedDate = DateTime.Now, ActivatedLink = <span class="hljs-string"><span class="hljs-string">""</span></span>, Email = <span class="hljs-string"><span class="hljs-string">"chernikov@gmail.com"</span></span>, FirstName = <span class="hljs-string"><span class="hljs-string">"Andrey"</span></span>, LastName = <span class="hljs-string"><span class="hljs-string">"Chernikov"</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"password2"</span></span>, LastVisitDate = DateTime.Now }); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.Users).Returns(Users.AsQueryable()); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.GetUser(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())).Returns((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> email) =&gt; Users.FirstOrDefault(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, email, <span class="hljs-number"><span class="hljs-number">0</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.Login(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(), It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())).Returns((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> email, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> password) =&gt; Users.FirstOrDefault(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Email, email, <span class="hljs-number"><span class="hljs-number">0</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>)); } }</code> </pre><br><br>  Consider how the mock works.  He has such a good method, like Setup (again, a complete setup!) That works like this: <br> <code>this.Setup(   ).Returns(    );</code> <br> <br>  For example: <br> <code>this.Setup(p =&gt; p.WillYou()).Returns(true);</code> <br> <br>  Let us consider in more detail what other options might be: <br><ul><li>  Methods <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mock&lt;IFoo&gt;(); mock.Setup(foo =&gt; foo.DoSomething(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>)).Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br><br><ul><li>  out parameter <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> outString = <span class="hljs-string"><span class="hljs-string">"ack"</span></span>; mock.Setup(foo =&gt; foo.TryParse(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> outString)).Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br></li><li>  reference parameter <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Bar(); mock.Setup(foo =&gt; foo.Submit(<span class="hljs-keyword"><span class="hljs-keyword">ref</span></span> instance)).Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br></li><li>  dependence on input parameter and return value (several parameters are possible) <br><pre> <code class="cs hljs">mock.Setup(x =&gt; x.DoSomething(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())) .Returns((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s) =&gt; s.ToLower());</code> </pre><br></li><li>  throw an exception <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.DoSomething(<span class="hljs-string"><span class="hljs-string">"reset"</span></span>)).Throws&lt;InvalidOperationException&gt;(); mock.Setup(foo =&gt; foo.DoSomething(<span class="hljs-string"><span class="hljs-string">""</span></span>)).Throws(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentException(<span class="hljs-string"><span class="hljs-string">"command"</span></span>);</code> </pre><br></li><li>  returns different values ‚Äã‚Äãfor (???) and using callback <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Mock&lt;IFoo&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> calls = <span class="hljs-number"><span class="hljs-number">0</span></span>; mock.Setup(foo =&gt; foo.GetCountThing()) .Returns(() =&gt; calls) .Callback(() =&gt; calls++);</code> </pre><br></li></ul><br></li><li>  Match the arguments <br><ul><li>  any value <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.DoSomething(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())).Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br></li><li>  condition via Func &lt;bool, T&gt; <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.Add(It.Is&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(i =&gt; i % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>))).Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br></li><li>  being in range <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.Add(It.IsInRange&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>, Range.Inclusive))).Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br></li><li>  Regex expression <br><pre> <code class="cs hljs">mock.Setup(x =&gt; x.DoSomething(It.IsRegex(<span class="hljs-string"><span class="hljs-string">"[ad]+"</span></span>, RegexOptions.IgnoreCase))).Returns(<span class="hljs-string"><span class="hljs-string">"foo"</span></span>);</code> </pre><br></li></ul><br></li><li>  Properties <br><ul><li>  Any property <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.Name).Returns(<span class="hljs-string"><span class="hljs-string">"bar"</span></span>);</code> </pre><br></li><li>  Any hierarchy property <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.Bar.Baz.Name).Returns(<span class="hljs-string"><span class="hljs-string">"baz"</span></span>);</code> </pre><br></li></ul><br></li><li>  Callbacks <br><ul><li>  No parameters <br><pre> <code class="cs hljs">mock.Setup(foo =&gt; foo.Execute(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>)) .Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Callback(() =&gt; calls++);</code> </pre><br></li><li>  With parameter <br><pre> <code class="cs hljs"> mock.Setup(foo =&gt; foo.Execute(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())) .Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Callback((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> s) =&gt; calls.Add(s));</code> </pre><br></li><li>  With a parameter, a slightly different syntax <br><pre> <code class="cs hljs"> mock.Setup(foo =&gt; foo.Execute(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())) .Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(s =&gt; calls.Add(s));</code> </pre><br>  Several parameters <br><pre> <code class="cs hljs"> mock.Setup(foo =&gt; foo.Execute(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(), It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;())) .Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;((i, s) =&gt; calls.Add(s));</code> </pre><br><br>  Before and after the call <br><pre> <code class="cs hljs"> mock.Setup(foo =&gt; foo.Execute(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>)) .Callback(() =&gt; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Before returns"</span></span>)) .Returns(<span class="hljs-literal"><span class="hljs-literal">true</span></span>) .Callback(() =&gt; Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"After returns"</span></span>));</code> </pre><br><br></li></ul><br>  Check (Mock object saves the number of calls to its parameters, thus we can also check whether the code was executed correctly) <br><ul><li>  Normal verification that the Execute method was called with the ‚Äúping‚Äù parameter <br><pre> <code class="cs hljs">mock.Verify(foo =&gt; foo.Execute(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>));</code> </pre><br></li><li>  With the addition of your own error message <br><pre> <code class="cs hljs"> mock.Verify(foo =&gt; foo.Execute(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>), <span class="hljs-string"><span class="hljs-string">"When doing operation X, the service should be pinged always"</span></span>);</code> </pre><br></li><li>  Shouldn't have been called once <br><pre> <code class="cs hljs">mock.Verify(foo =&gt; foo.Execute(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>), Times.Never());</code> </pre><br></li><li>  At least once had to be called <br><pre> <code class="cs hljs">mock.Verify(foo =&gt; foo.Execute(<span class="hljs-string"><span class="hljs-string">"ping"</span></span>), Times.AtLeastOnce()); mock.VerifyGet(foo =&gt; foo.Name);</code> </pre><br><br></li><li>  The setter for the property should have been called. <br><pre> <code class="cs hljs"> mock.VerifySet(foo =&gt; foo.Name);</code> </pre><br></li><li>  Should have called a setter with the value ‚Äúfoo‚Äù <br><pre> <code class="cs hljs"> mock.VerifySet(foo =&gt; foo.Name = <span class="hljs-string"><span class="hljs-string">"foo"</span></span>);</code> </pre><br></li><li>  The setter should have been called with a value in the specified range. <br><pre> <code class="cs hljs">mock.VerifySet(foo =&gt; foo.Value = It.IsInRange(<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>, Range.Inclusive));</code> </pre><br></li></ul><br><br>  Well, this is enough for us, the rest can be read here: <br>  <a href="https://code.google.com/p/moq/wiki/QuickStart">https://code.google.com/p/moq/wiki/QuickStart</a> <br><br>  Go back to UnitTestSetupFixture.cs (/Setup/UnitTestSetupFixture.cs) and initialize the config: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StandardKernel kernel</span></span></span><span class="hljs-function">)</span></span> { kernel.Bind&lt;MockRepository&gt;().To&lt;MockRepository&gt;().InThreadScope(); kernel.Bind&lt;IRepository&gt;().ToMethod(p =&gt; kernel.Get&lt;MockRepository&gt;().Object); }</code> </pre><br>  Let's check some of our output, for example the class / Default / Controllers / UserController: cs: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index_GetPageableDataOfUsers_CountOfUsersIsTwo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//init var controller = DependencyResolver.Current.GetService&lt;Areas.Default.Controllers.UserController&gt;(); //act var result = controller.Index(); Assert.IsInstanceOf&lt;ViewResult&gt;(result); Assert.IsInstanceOf&lt;PageableData&lt;User&gt;&gt;(((ViewResult)result).Model); var count = ((PageableData&lt;User&gt;)((ViewResult)result).Model).List.Count(); Assert.AreEqual(2, count); }</span></span></code> </pre><br><br>  In BaseController.cs (/LessonProject/Controllers/BaseController.cs), remove the <code>Inject</code> attributes from the <code>Auth</code> and <code>Config</code> properties (otherwise, the highlighted line will not be able to initialize the controller and return null).  By the way about the highlighted line.  We do exactly this initialization so that all Inject-Attribute properties are initialized.  We start, and, true, count == 2. Great, the MockRepository works.  Bring back the attributes of the <code>Inject</code> . <br>  By the way, tests do not usually run in debug mode, to run Debug you need to do this: <br><img src="https://habrastorage.org/storage2/0e0/2d5/c47/0e02d5c475cb3416b0794e6c1cc3b600.jpg"><br><br>  Now let's work with Config.  It'll be cool! <br><br><h5>  Testconfig </h5><br>  What we need to do.  We need: <br><ul><li>  Take the Web.Config from the LessonProject project (in some clever way) </li><li>  And on its basis to create a class that will implement the IConfig interface </li><li>  Well, hook on Ninject Kernel </li><li>  And you can use. </li></ul><br><br>  Let's start.  In order to take Web.Config - we need to copy it to our folder.  Let's call it Sandbox.  Now let's copy, put on the pre-build Event in Project Properties: <br><img src="https://habrastorage.org/storage2/607/fce/2d1/607fce2d13b279516dfd0be33240f601.jpg"><br><br><pre> <code class="bash hljs">xcopy $(SolutionDir)LessonProject\Web.config $(ProjectDir)Sandbox\ /y</code> </pre><br><br>  Every time we start a build, we copy Web.config (and, if necessary, overwrite) to our Sandbox. <br>  Let's create TestConfig.cs and transfer our file to the constructor (/Tools/TestConfig.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TestConfig</span></span> : <span class="hljs-title"><span class="hljs-title">IConfig</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Configuration configuration; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> configPath</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configFileMap = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExeConfigurationFileMap(); configFileMap.ExeConfigFilename = configPath; configuration = ConfigurationManager.OpenMappedExeConfiguration(configFileMap, ConfigurationUserLevel.None); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ConnectionStrings</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configuration.ConnectionStrings.ConnectionStrings[connectionString].ConnectionString; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Lang { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configuration.AppSettings.Settings[<span class="hljs-string"><span class="hljs-string">"Lang"</span></span>].Value; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> EnableMail { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>.Parse(configuration.AppSettings.Settings[<span class="hljs-string"><span class="hljs-string">"EnableMail"</span></span>].Value); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;IconSize&gt; IconSizes { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { IconSizesConfigSection configInfo = (IconSizesConfigSection)configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"iconConfig"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (configInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configInfo.IconSizes.OfType&lt;IconSize&gt;().AsQueryable&lt;IconSize&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;MimeType&gt; MimeTypes { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { MimeTypesConfigSection configInfo = (MimeTypesConfigSection)configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"mimeConfig"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configInfo.MimeTypes.OfType&lt;MimeType&gt;().AsQueryable&lt;MimeType&gt;(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IQueryable&lt;MailTemplate&gt; MailTemplates { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { MailTemplateConfigSection configInfo = (MailTemplateConfigSection)configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"mailTemplatesConfig"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> configInfo.MailTemplates.OfType&lt;MailTemplate&gt;().AsQueryable&lt;MailTemplate&gt;(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MailSetting MailSetting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (MailSetting)configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"mailConfig"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> SmsSetting SmsSetting { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (SmsSetting)configuration.GetSection(<span class="hljs-string"><span class="hljs-string">"smsConfig"</span></span>); } } }</code> </pre><br><br>  And initialize in UnitTestSetupFixture.cs (/Setup/UnitTestSetupFixture.cs): <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitConfig</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StandardKernel kernel</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fullPath = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(Sandbox + <span class="hljs-string"><span class="hljs-string">"/Web.config"</span></span>).FullName; kernel.Bind&lt;IConfig&gt;().ToMethod(c =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TestConfig(fullPath)); }</code> </pre><br><br>  Let's create a simple test for data verification in the config file: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailTemplateTest</span></span> { [Test] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MailTemplates_ExistRegisterTemplate_Exist</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = DependencyResolver.Current.GetService&lt;IConfig&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> template = config.MailTemplates.FirstOrDefault(p =&gt; p.Name.StartsWith(<span class="hljs-string"><span class="hljs-string">"Register"</span></span>)); Assert.IsNotNull(template); } }</code> </pre><br><br>  Launch, check, voila!  We proceed to the implementation of IAuthentication. <br><br><h5>  Authentication </h5><br>  In a web application, when we are already executing the code in the controller, we already have some predefined context, the environment, formed by the http request.  Those.  these are parameters, cookies, browser data, screen resolution, and operating system.  In general, this is all - HttpContext.  It should be understood that when we authorize, we put some data in cookies, and then we get them all.  Actually, for this we will create a special interface IAuthCookieProvider, which will be the type to write cookies <br>  IAuthCookieProvider.cs (LessonProject / Global / Auth / IAuthCookieProvider): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAuthCookieProvider</span></span> { <span class="hljs-function"><span class="hljs-function">HttpCookie </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cookieName</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpCookie cookie</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><br>  And implement it for HttpAuthCookieProvider.cs (/Global/Auth/HttpAuthCookieProvider.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">HttpContextCookieProvider</span></span> : <span class="hljs-title"><span class="hljs-title">IAuthCookieProvider</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HttpContextCookieProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpContext HttpContext</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.HttpContext = HttpContext; } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> HttpContext HttpContext { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpCookie </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cookieName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpContext.Request.Cookies.Get(cookieName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpCookie cookie</span></span></span><span class="hljs-function">)</span></span> { HttpContext.Response.Cookies.Set(cookie); } }</code> </pre><br><br>  And now we use this implementation for working with Cookies in CustomAuthentication (/Global/Auth/CustomAuthentication.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IAuthCookieProvider AuthCookieProvider { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; }</code> </pre><br><br>  and instead of HttpContext.Request.Cookies.Get, use GetCookie () and <br>  HttpContext.Response.Cookies.Set - respectively SetCookie (). <br>  Modify and in IAuthencation.cs (/Global/Auth/IAuthencation.cs): <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAuthentication</span></span> { <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment">  (       ) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> IAuthCookieProvider AuthCookieProvider { get; set; }</span></span></code> </pre><br><br>  And in AuthHttpModule.cs (/Global/Auth/AuthHttpModule.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth = DependencyResolver.Current.GetService&lt;IAuthentication&gt;(); auth.AuthCookieProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpContextCookieProvider(context);</code> </pre><br><br><h5>  Mockhttpcontext </h5><br>  Now create Mock objects for the HttpContext in LessonProject.UnitTest: <br><br><pre> <code class="cs hljs">MockHttpContext.cs  (/Mock/HttpContext.cs): <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockHttpContext</span></span> : <span class="hljs-title"><span class="hljs-title">Mock</span></span>&lt;<span class="hljs-title"><span class="hljs-title">HttpContextBase</span></span>&gt; { [Inject] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HttpCookieCollection Cookies { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MockHttpCachePolicy Cache { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MockHttpBrowserCapabilities Browser { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MockHttpSessionState SessionState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MockHttpServerUtility ServerUtility { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MockHttpResponse Response { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> MockHttpRequest Request { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MockHttpContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MockBehavior mockBehavior = MockBehavior.Strict</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">this</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span><span class="hljs-function"><span class="hljs-params">, mockBehavior</span></span></span><span class="hljs-function">)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MockHttpContext</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IAuthentication auth, MockBehavior mockBehavior = MockBehavior.Strict</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mockBehavior</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//request Browser = new MockHttpBrowserCapabilities(mockBehavior); Browser.Setup(b =&gt; b.IsMobileDevice).Returns(false); Request = new MockHttpRequest(mockBehavior); Request.Setup(r =&gt; r.Cookies).Returns(Cookies); Request.Setup(r =&gt; r.ValidateInput()); Request.Setup(r =&gt; r.UserAgent).Returns("Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11"); Request.Setup(r =&gt; r.Browser).Returns(Browser.Object); this.Setup(p =&gt; p.Request).Returns(Request.Object); //response Cache = new MockHttpCachePolicy(MockBehavior.Loose); Response = new MockHttpResponse(mockBehavior); Response.Setup(r =&gt; r.Cookies).Returns(Cookies); Response.Setup(r =&gt; r.Cache).Returns(Cache.Object); this.Setup(p =&gt; p.Response).Returns(Response.Object); //user if (auth != null) { this.Setup(p =&gt; p.User).Returns(() =&gt; auth.CurrentUser); } else { this.Setup(p =&gt; p.User).Returns(new UserProvider("", null)); } //Session State SessionState = new MockHttpSessionState(); this.Setup(p =&gt; p.Session).Returns(SessionState.Object); //Server Utility ServerUtility = new MockHttpServerUtility(mockBehavior); this.Setup(p =&gt; p.Server).Returns(ServerUtility.Object); //Items var items = new ListDictionary(); this.Setup(p =&gt; p.Items).Returns(items); } }</span></span></code> </pre><br><br>  In addition, we also create the following classes: <br><ul><li>  MockHttpCachePolicy </li><li>  MockHttpBrowserCapabilities </li><li>  MockHttpSessionState </li><li>  MockHttpServerUtility </li><li>  Mockhttpresponse </li><li>  MockhttpRequest </li></ul><br><br>  All these mock objects are quite trivial, except for MockSessionState, where session storage is stored (/Mock/Http/MockHttpSessionState.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockHttpSessionState</span></span> : <span class="hljs-title"><span class="hljs-title">Mock</span></span>&lt;<span class="hljs-title"><span class="hljs-title">HttpSessionStateBase</span></span>&gt; { Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; sessionStorage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MockHttpSessionState</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MockBehavior mockBehavior = MockBehavior.Strict</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mockBehavior</span></span></span><span class="hljs-function">)</span></span> { sessionStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p[It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;()]).Returns((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> index) =&gt; sessionStorage[index]); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.Add(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(), It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;())).Callback&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;((name, obj) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sessionStorage.ContainsKey(name)) { sessionStorage.Add(name, obj); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { sessionStorage[name] = obj; } }); } }</code> </pre><br><br>  Create FakeAuthCookieProvider.cs (/Fake/FakeAuthCookieProvider.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FakeAuthCookieProvider</span></span> : <span class="hljs-title"><span class="hljs-title">IAuthCookieProvider</span></span> { [Inject] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> HttpCookieCollection Cookies { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> HttpCookie </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> cookieName</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Cookies.Get(cookieName); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCookie</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">HttpCookie cookie</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Cookies.Get(cookie.Name) != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { Cookies.Remove(cookie.Name); } Cookies.Add(cookie); } }</code> </pre><br><br>  Whew!  Initialize this into UnitTestSetupFixture.cs (/Setup/UnitTestSetupFixture.cs): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitAuth</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StandardKernel kernel</span></span></span><span class="hljs-function">)</span></span> { kernel.Bind&lt;HttpCookieCollection&gt;().To&lt;HttpCookieCollection&gt;(); kernel.Bind&lt;IAuthCookieProvider&gt;().To&lt;FakeAuthCookieProvider&gt;().InSingletonScope(); kernel.Bind&lt;IAuthentication&gt;().ToMethod&lt;CustomAuthentication&gt;(c =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CustomAuthentication(); auth.AuthCookieProvider = kernel.Get&lt;IAuthCookieProvider&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> auth; }); }</code> </pre><br><br>  Note that Bind happens on SingletonScope (), i.e.  once logged in to some test, we will use the same authorization in subsequent tests. <br><br>  Compile and try to fly with it all.  Now the magic begins ... <br><br><h5>  Validation validation </h5><br>  If we just call something like: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> registerUser = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserView() { Email = <span class="hljs-string"><span class="hljs-string">"user@sample.com"</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"123456"</span></span>, ConfirmPassword = <span class="hljs-string"><span class="hljs-string">"1234567"</span></span>, AvatarPath = <span class="hljs-string"><span class="hljs-string">"/file/no-image.jpg"</span></span>, BirthdateDay = <span class="hljs-number"><span class="hljs-number">1</span></span>, BirthdateMonth = <span class="hljs-number"><span class="hljs-number">12</span></span>, BirthdateYear = <span class="hljs-number"><span class="hljs-number">1987</span></span>, Captcha = <span class="hljs-string"><span class="hljs-string">"1234"</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = controller.Register(registerUser);</code> </pre><br><br>  That, firstly, no implicit validation will be performed, and secondly, we have a session there and we have not initialized it, it is null and everything is an error.  So validation checks (the one in the attributes) will be arranged through a separate class.  Let's call it Validator Validatorovich (/Tools/Validator.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ValidatorException</span></span> : <span class="hljs-title"><span class="hljs-title">Exception</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ValidationAttribute Attribute { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ValidatorException</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ValidationException ex, ValidationAttribute attribute</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">attribute.GetType(</span></span></span><span class="hljs-function">).Name, ex)</span></span> { Attribute = attribute; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Validator</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> ValidateObject&lt;T&gt;(T obj) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = <span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(T); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> meta = type.GetCustomAttributes(<span class="hljs-literal"><span class="hljs-literal">false</span></span>).OfType&lt;MetadataTypeAttribute&gt;().FirstOrDefault(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (meta != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { type = meta.MetadataClassType; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeAttributes = type.GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ValidationAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>).OfType&lt;ValidationAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validationContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationContext(obj); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attribute <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> typeAttributes) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { attribute.Validate(obj, validationContext); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidatorException(ex, attribute); } } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propertyInfo = type.GetProperties(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> propertyInfo) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attributes = info.GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ValidationAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>).OfType&lt;ValidationAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attribute <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objPropInfo = obj.GetType().GetProperty(info.Name); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { attribute.Validate(objPropInfo.GetValue(obj, <span class="hljs-literal"><span class="hljs-literal">null</span></span>), validationContext); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidatorException(ex, attribute); } } } } }</code> </pre><br><br>  So, what is happening here.  First, we get all the attributes of class T, which are of type ValidationAttribute: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> typeAttributes = type.GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ValidationAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>).OfType&lt;ValidationAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> validationContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidationContext(obj); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attribute <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> typeAttributes) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { attribute.Validate(obj, validationContext); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidatorException(ex, attribute); } }</code> </pre><br><br>  Then similarly for each property: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> propertyInfo = type.GetProperties(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> propertyInfo) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attributes = info.GetCustomAttributes(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span>(ValidationAttribute), <span class="hljs-literal"><span class="hljs-literal">true</span></span>).OfType&lt;ValidationAttribute&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> attribute <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> objPropInfo = obj.GetType().GetProperty(info.Name); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { attribute.Validate(objPropInfo.GetValue(obj, <span class="hljs-literal"><span class="hljs-literal">null</span></span>), validationContext); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ValidationException ex) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ValidatorException(ex, attribute); } } }</code> </pre><br><br>  If validation fails, an exception occurs, and we wrap it in a ValidatorException, passing also the attribute on which the exception occurred. <br>  Now about the captcha and Session.  We need to pass the context to the controller (MockHttpContext): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = DependencyResolver.Current.GetService&lt;Areas.Default.Controllers.UserController&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockHttpContext().Object; ControllerContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControllerContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestContext(httpContext, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteData()), controller); controller.ControllerContext = context; controller.Session.Add(CaptchaImage.CaptchaValueKey, <span class="hljs-string"><span class="hljs-string">"1111"</span></span>);</code> </pre><br><br>  And now all together: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index_RegisterUserWithDifferentPassword_ExceptionCompare</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//init var controller = DependencyResolver.Current.GetService&lt;Areas.Default.Controllers.UserController&gt;(); var httpContext = new MockHttpContext().Object; ControllerContext context = new ControllerContext(new RequestContext(httpContext, new RouteData()), controller); controller.ControllerContext = context; //act var registerUserView = new UserView() { Email = "user@sample.com", Password = "123456", ConfirmPassword = "1234567", AvatarPath = "/file/no-image.jpg", BirthdateDay = 1, BirthdateMonth = 12, BirthdateYear = 1987, Captcha = "1111" }; try { Validator.ValidateObject&lt;UserView&gt;(registerUserView); } catch (Exception ex) { Assert.IsInstanceOf&lt;ValidatorException&gt;(ex); Assert.IsInstanceOf&lt;System.ComponentModel.DataAnnotations.CompareAttribute&gt;(((ValidatorException)ex).Attribute); } }</span></span></code> </pre><br><br>  Run, and everything turned out.  But captcha is checked directly in the controller method.  Especially for captcha: <br><pre> <code class="cs hljs"> [<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index_RegisterUserWithWrongCaptcha_ModelStateWithError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//init var controller = DependencyResolver.Current.GetService&lt;Areas.Default.Controllers.UserController&gt;(); var httpContext = new MockHttpContext().Object; ControllerContext context = new ControllerContext(new RequestContext(httpContext, new RouteData()), controller); controller.ControllerContext = context; controller.Session.Add(CaptchaImage.CaptchaValueKey, "2222"); //act var registerUserView = new UserView() { Email = "user@sample.com", Password = "123456", ConfirmPassword = "1234567", AvatarPath = "/file/no-image.jpg", BirthdateDay = 1, BirthdateMonth = 12, BirthdateYear = 1987, Captcha = "1111" }; var result = controller.Register(registerUserView); Assert.AreEqual("    ", controller.ModelState["Captcha"].Errors[0].ErrorMessage); }</span></span></code> </pre><br><br>  Cool! <br><br><h5>  Authorization check </h5><br><br>  For example, we have to check that if I enter not under the administrator, then the authorized part (the controller marked with the attribute [Authorize (Roles = ‚Äúadmin‚Äù)]) - will not be allowed to the ordinary user.  There is a great way to check it out.  Pay attention to the ControllerActionInvoker class and inherit it for calls (/Fake/FakeControllerActionInvoker.cs + FakeValueProvider.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FakeValueProvider</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; Values { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FakeValueProvider</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Values = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>[<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> index] { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Values.ContainsKey(index)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Values[index]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Values.ContainsKey(index)) { Values[index] = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Values.Add(index, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); } } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FakeControllerActionInvoker</span></span>&lt;<span class="hljs-title"><span class="hljs-title">TExpectedResult</span></span>&gt; : <span class="hljs-title"><span class="hljs-title">ControllerActionInvoker</span></span> <span class="hljs-title"><span class="hljs-title">where</span></span> <span class="hljs-title"><span class="hljs-title">TExpectedResult</span></span> : <span class="hljs-title"><span class="hljs-title">ActionResult</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> FakeValueProvider FakeValueProvider { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FakeControllerActionInvoker</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { FakeValueProvider = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FakeValueProvider(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FakeControllerActionInvoker</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">FakeValueProvider fakeValueProvider</span></span></span><span class="hljs-function">)</span></span> { FakeValueProvider = fakeValueProvider; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> ActionExecutedContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeActionMethodWithFilters</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ControllerContext controllerContext, IList&lt;IActionFilter&gt; filters, ActionDescriptor actionDescriptor, IDictionary&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; parameters</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">base</span></span>.InvokeActionMethodWithFilters(controllerContext, filters, actionDescriptor, parameters); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetParameterValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ControllerContext controllerContext, ParameterDescriptor parameterDescriptor</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> obj = FakeValueProvider[parameterDescriptor.ParameterName]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (obj != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> obj; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> parameterDescriptor.DefaultValue; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeActionResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ControllerContext controllerContext, ActionResult actionResult</span></span></span><span class="hljs-function">)</span></span> { Assert.IsInstanceOf&lt;TExpectedResult&gt;(actionResult); } }</code> </pre><br><br>  In essence, this is the "caller" of the controller's action methods, where the Generic class is the expected result class.  In case of non-authorization, it will be HttpUnauthorizedResult.  Let's make a test (/Test/Admin/HomeControllerTest.cs): <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AdminHomeControllerTest</span></span> { [Test] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index_NotAuthorizeGetDefaultView_RedirectToLoginPage</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth = DependencyResolver.Current.GetService&lt;IAuthentication&gt;(); auth.Login(<span class="hljs-string"><span class="hljs-string">"chernikov@gmail.com"</span></span>, <span class="hljs-string"><span class="hljs-string">"password2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockHttpContext(auth).Object; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = DependencyResolver.Current.GetService&lt;Areas.Admin.Controllers.HomeController&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> route = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteData(); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"controller"</span></span>, <span class="hljs-string"><span class="hljs-string">"Home"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, <span class="hljs-string"><span class="hljs-string">"Index"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"area"</span></span>, <span class="hljs-string"><span class="hljs-string">"Admin"</span></span>); ControllerContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControllerContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestContext(httpContext, route), controller); controller.ControllerContext = context; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controllerActionInvoker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FakeControllerActionInvoker&lt;HttpUnauthorizedResult&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = controllerActionInvoker.InvokeAction(controller.ControllerContext, <span class="hljs-string"><span class="hljs-string">"Index"</span></span>); } }</code> </pre><br><br>  ,  . ,      admin     ViewResult: <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index_AdminAuthorize_GetViewResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> auth = DependencyResolver.Current.GetService&lt;IAuthentication&gt;(); auth.Login(<span class="hljs-string"><span class="hljs-string">"admin"</span></span>, <span class="hljs-string"><span class="hljs-string">"password"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockHttpContext(auth).Object; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = DependencyResolver.Current.GetService&lt;Areas.Admin.Controllers.HomeController&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> route = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteData(); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"controller"</span></span>, <span class="hljs-string"><span class="hljs-string">"Home"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, <span class="hljs-string"><span class="hljs-string">"Index"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"area"</span></span>, <span class="hljs-string"><span class="hljs-string">"Admin"</span></span>); ControllerContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControllerContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestContext(httpContext, route), controller); controller.ControllerContext = context; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controllerActionInvoker = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FakeControllerActionInvoker&lt;ViewResult&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = controllerActionInvoker.InvokeAction(controller.ControllerContext, <span class="hljs-string"><span class="hljs-string">"Index"</span></span>); }</code> </pre><br><br>   . . <br><br>      ,   .     ,    ,   .     .      ? ,   ,    ,    . ,    Mock-  , , ,       ,      ?   ,  -       ?    NerdDinner     . <br><br>  IRepository,  SqlRepository,  MockRepository.      SqlRepository ‚Äì     .       .  What to do?    TDD? <br><br><h5>   </h5><br>    ,          SqlRepository.     Web.config   (   ),  ,    ,     ,   . <br>   LessonProject.IntegrationTest   Test. <br>  Ninject, Moq  NUnit: <br><pre> <code class="bash hljs">Install-Package Ninject Install-Package Moq Install-Package NUnit</code> </pre><br><br>     Sandbox   Setup  UnitTestSetupFixture (/Setup/IntegrationTestSetupFixture.cs)     : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">SetUpFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">IntegrationTestSetupFixture</span></span> : <span class="hljs-title"><span class="hljs-title">UnitTestSetupFixture</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">FileListRestore</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> LogicalName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Type { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> NameDb = <span class="hljs-string"><span class="hljs-string">"LessonProject"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TestDbName; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CopyDb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StandardKernel kernel, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> FileInfo sandboxFile, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">out</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> connectionString</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = kernel.Get&lt;IConfig&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataContext(config.ConnectionStrings(<span class="hljs-string"><span class="hljs-string">"ConnectionString"</span></span>)); TestDbName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}_{1}"</span></span>, NameDb, DateTime.Now.ToString(<span class="hljs-string"><span class="hljs-string">"yyyyMMdd_HHmmss"</span></span>)); Console.WriteLine(<span class="hljs-string"><span class="hljs-string">"Create DB = "</span></span> + TestDbName); sandboxFile = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInfo(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}\\{1}.bak"</span></span>, Sandbox, TestDbName)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sandboxDir = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DirectoryInfo(Sandbox); <span class="hljs-comment"><span class="hljs-comment">//backupFile var textBackUp = string.Format(@"-- Backup the database BACKUP DATABASE [{0}] TO DISK = '{1}' WITH COPY_ONLY", NameDb, sandboxFile.FullName); db.ExecuteCommand(textBackUp); var restoreFileList = string.Format("RESTORE FILELISTONLY FROM DISK = '{0}'", sandboxFile.FullName); var fileListRestores = db.ExecuteQuery&lt;FileListRestore&gt;(restoreFileList).ToList(); var logicalDbName = fileListRestores.FirstOrDefault(p =&gt; p.Type == "D"); var logicalLogDbName = fileListRestores.FirstOrDefault(p =&gt; p.Type == "L"); var restoreDb = string.Format("RESTORE DATABASE [{0}] FROM DISK = '{1}' WITH FILE = 1, MOVE N'{2}' TO N'{4}\\{0}.mdf', MOVE N'{3}' TO N'{4}\\{0}.ldf', NOUNLOAD, STATS = 10", TestDbName, sandboxFile.FullName, logicalDbName.LogicalName, logicalLogDbName.LogicalName, sandboxDir.FullName); db.ExecuteCommand(restoreDb); connectionString = config.ConnectionStrings("ConnectionString").Replace(NameDb, TestDbName); } }</span></span></code> </pre><br><br>  In order: <br>   <br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = kernel.Get&lt;IConfig&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataContext(config.ConnectionStrings(<span class="hljs-string"><span class="hljs-string">"ConnectionString"</span></span>));</code> </pre><br><br> ‚Äî    . <br><pre> <code class="cs hljs">TestDbName = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"{0}_{1}"</span></span>, NameDb, DateTime.Now.ToString(<span class="hljs-string"><span class="hljs-string">"yyyyMMdd_HHmmss"</span></span>));</code> </pre><br>    . <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//backupFile var textBackUp = string.Format(@"-- Backup the database BACKUP DATABASE [{0}] TO DISK = '{1}' WITH COPY_ONLY", NameDb, sandboxFile.FullName); db.ExecuteCommand(textBackUp);</span></span></code> </pre><br> ‚Äî      Sandbox. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> restoreFileList = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"RESTORE FILELISTONLY FROM DISK = '{0}'"</span></span>, sandboxFile.FullName); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fileListRestores = db.ExecuteQuery&lt;FileListRestore&gt;(restoreFileList).ToList(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logicalDbName = fileListRestores.FirstOrDefault(p =&gt; p.Type == <span class="hljs-string"><span class="hljs-string">"D"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> logicalLogDbName = fileListRestores.FirstOrDefault(p =&gt; p.Type == <span class="hljs-string"><span class="hljs-string">"L"</span></span>);</code> </pre><br> ‚Äî       ,     FIleListRestore. <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> restoreDb = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">"RESTORE DATABASE [{0}] FROM DISK = '{1}' WITH FILE = 1, MOVE N'{2}' TO N'{4}\\{0}.mdf', MOVE N'{3}' TO N'{4}\\{0}.ldf', NOUNLOAD, STATS = 10"</span></span>, TestDbName, sandboxFile.FullName, logicalDbName.LogicalName, logicalLogDbName.LogicalName, sandboxDir.FullName); db.ExecuteCommand(restoreDb);</code> </pre><br> ‚Äî      (TestDbName) <br><br><pre> <code class="cs hljs"> connectionString = config.ConnectionStrings(<span class="hljs-string"><span class="hljs-string">"ConnectionString"</span></span>).Replace(NameDb, TestDbName);</code> </pre><br> ‚Äî  connectionString. <br><br>      IRepository  SqlRepository: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitRepository</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StandardKernel kernel</span></span></span><span class="hljs-function">)</span></span> { FileInfo sandboxFile; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> connectionString; CopyDb(kernel, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> sandboxFile, <span class="hljs-keyword"><span class="hljs-keyword">out</span></span> connectionString); kernel.Bind&lt;webTemplateDbDataContext&gt;().ToMethod(c =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> webTemplateDbDataContext(connectionString)); kernel.Bind&lt;IRepository&gt;().To&lt;SqlRepository&gt;().InTransientScope(); sandboxFile.Delete(); }</code> </pre><br><br> ,    sandboxFile ‚Äì   ,  connectionString ‚Äì     (  ).   ,    SqlRepository,     .        .      . <br>      ,    : <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveDb</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = DependencyResolver.Current.GetService&lt;IConfig&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataContext(config.ConnectionStrings(<span class="hljs-string"><span class="hljs-string">"ConnectionString"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> textCloseConnectionTestDb = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">@"ALTER DATABASE [{0}] SET SINGLE_USER WITH ROLLBACK IMMEDIATE"</span></span>, TestDbName); db.ExecuteCommand(textCloseConnectionTestDb); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> textDropTestDb = <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Format(<span class="hljs-string"><span class="hljs-string">@"DROP DATABASE [{0}]"</span></span>, TestDbName); db.ExecuteCommand(textDropTestDb); }</code> </pre><br><br>  TestDbName,   (   ),    . <br>     Web.config: <br><pre> <code class="bash hljs">xcopy $(SolutionDir)LessonProject\Web.config $(ProjectDir)Sandbox\ /y</code> </pre><br><br>  ,     . ,       ,     .    .    ‚Äì     : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">TestFixture</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">DefaultUserControllerTest</span></span> { [Test] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateUser_CreateNormalUser_CountPlusOne</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = DependencyResolver.Current.GetService&lt;IRepository&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = DependencyResolver.Current.GetService&lt;LessonProject.Areas.Default.Controllers.UserController&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countBefore = repository.Users.Count(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockHttpContext().Object; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> route = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteData(); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"controller"</span></span>, <span class="hljs-string"><span class="hljs-string">"User"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, <span class="hljs-string"><span class="hljs-string">"Register"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"area"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span>); ControllerContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControllerContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestContext(httpContext, route), controller); controller.ControllerContext = context; controller.Session.Add(CaptchaImage.CaptchaValueKey, <span class="hljs-string"><span class="hljs-string">"1111"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> registerUserView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserView() { ID = <span class="hljs-number"><span class="hljs-number">0</span></span>, Email = <span class="hljs-string"><span class="hljs-string">"rollinx@gmail.com"</span></span>, Password = <span class="hljs-string"><span class="hljs-string">"123456"</span></span>, ConfirmPassword = <span class="hljs-string"><span class="hljs-string">"123456"</span></span>, Captcha = <span class="hljs-string"><span class="hljs-string">"1111"</span></span>, BirthdateDay = <span class="hljs-number"><span class="hljs-number">13</span></span>, BirthdateMonth = <span class="hljs-number"><span class="hljs-number">9</span></span>, BirthdateYear = <span class="hljs-number"><span class="hljs-number">1970</span></span> }; Validator.ValidateObject&lt;UserView&gt;(registerUserView); controller.Register(registerUserView); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> countAfter = repository.Users.Count(); Assert.AreEqual(countBefore + <span class="hljs-number"><span class="hljs-number">1</span></span>, countAfter); } }</code> </pre><br><br> ,        email. <br> , .  Works.  Kayf!  ,   .   - ‚Äì      ,   ‚Äì   . , , ,  MailNotify      .      : <br> /LessonProject/Tools/Mail/IMailSender.cs: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMailSender</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> body, MailAddress mailAddress = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span>; }</code> </pre><br><br> /LessonProject/Tools/Mail/MailSender.cs: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MailSender</span></span> : <span class="hljs-title"><span class="hljs-title">IMailSender</span></span> { [Inject] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IConfig Config { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendMail</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> subject, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> body, MailAddress mailAddress = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Config.EnableMail) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mailAddress == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { mailAddress = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailAddress(Config.MailSetting.SmtpReply, Config.MailSetting.SmtpUser); } MailMessage message = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailMessage( mailAddress, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MailAddress(email)) { Subject = subject, BodyEncoding = Encoding.UTF8, Body = body, IsBodyHtml = <span class="hljs-literal"><span class="hljs-literal">true</span></span>, SubjectEncoding = Encoding.UTF8 }; SmtpClient client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SmtpClient { Host = Config.MailSetting.SmtpServer, Port = Config.MailSetting.SmtpPort, UseDefaultCredentials = <span class="hljs-literal"><span class="hljs-literal">false</span></span>, EnableSsl = Config.MailSetting.EnableSsl, Credentials = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NetworkCredential(Config.MailSetting.SmtpUserName, Config.MailSetting.SmtpPassword), DeliveryMethod = SmtpDeliveryMethod.Network }; client.Send(message); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { logger.Debug(<span class="hljs-string"><span class="hljs-string">"Email : {0} {1} \t Subject: {2} {3} Body: {4}"</span></span>, email, Environment.NewLine, subject, Environment.NewLine, body); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { logger.Error(<span class="hljs-string"><span class="hljs-string">"Mail send exception"</span></span>, ex.Message); } } }</code> </pre><br><br> /LessonProject/Tools/Mail/NotifyMail.cs: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">NotifyMail</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> NLog.Logger logger = NLog.LogManager.GetCurrentClassLogger(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig _config; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IConfig Config { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_config == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _config = (DependencyResolver.Current).GetService&lt;IConfig&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _config; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IMailSender _mailSender; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IMailSender MailSender { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_mailSender == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { _mailSender = (DependencyResolver.Current).GetService&lt;IMailSender&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _mailSender; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SendNotify</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> templateName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; subject, Func&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt; body</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> template = Config.MailTemplates.FirstOrDefault(p =&gt; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Compare(p.Name, templateName, <span class="hljs-literal"><span class="hljs-literal">true</span></span>) == <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (template == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { logger.Error(<span class="hljs-string"><span class="hljs-string">"Can't find template ("</span></span> + templateName + <span class="hljs-string"><span class="hljs-string">")"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { MailSender.SendMail(email, subject.Invoke(template.Subject), body.Invoke(template.Template)); } } }</code> </pre><br><br> /LessonProject/App_Start/NinjectWebCommon.cs: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RegisterServices</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IKernel kernel</span></span></span><span class="hljs-function">)</span></span> {‚Ä¶ kernel.Bind&lt;IMailSender&gt;().To&lt;MailSender&gt;(); }</code> </pre><br><br>    LessonProject.UnitTest  MockMailSender (/Mock/Mail/MockMailSender.cs): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MockMailSender</span></span> : <span class="hljs-title"><span class="hljs-title">Mock</span></span>&lt;<span class="hljs-title"><span class="hljs-title">IMailSender</span></span>&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MockMailSender</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">MockBehavior mockBehavior = MockBehavior.Strict</span></span></span><span class="hljs-function">) : </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">mockBehavior</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Setup(p =&gt; p.SendMail(It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(), It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(), It.IsAny&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(), It.IsAny&lt;MailAddress&gt;())) .Callback((<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> email, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> subject, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> body, MailAddress address) =&gt; Console.WriteLine(String.Format(<span class="hljs-string"><span class="hljs-string">"Send mock email to: {0}, subject {1}"</span></span>, email, subject))); } }</code> </pre><br><br>  UnitTestSetupFixture.cs (/LessonProject.UnitTest/Setup/UnitTestSetupFixture.cs): <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> IKernel </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InitKernel</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ‚Ä¶ kernel.Bind&lt;MockMailSender&gt;().To&lt;MockMailSender&gt;(); kernel.Bind&lt;IMailSender&gt;().ToMethod(p =&gt; kernel.Get&lt;MockMailSender&gt;().Object); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> kernel; }</code> </pre><br><br> ,  ,       . <br><pre> <code class="bash hljs">=============== =====START===== =============== Create DB = LessonProject_20130314_104218 Send mock email to: chernikov@googlemail.com, subject   =============== =====BYE!====== ===============</code> </pre><br><br><h5>   </h5><br>   ,          . ()  GenerateData    Test,       ,   .   .   ‚Äì   ,      . ,        ( ,       ,    ). <br><br>       ¬´ ¬ª,        ,        ,       . <br>  100      : <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">Test</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateUser_Create100Users_NoAssert</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> repository = DependencyResolver.Current.GetService&lt;IRepository&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> controller = DependencyResolver.Current.GetService&lt;LessonProject.Areas.Default.Controllers.UserController&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> httpContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MockHttpContext().Object; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> route = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RouteData(); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"controller"</span></span>, <span class="hljs-string"><span class="hljs-string">"User"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"action"</span></span>, <span class="hljs-string"><span class="hljs-string">"Register"</span></span>); route.Values.Add(<span class="hljs-string"><span class="hljs-string">"area"</span></span>, <span class="hljs-string"><span class="hljs-string">"Default"</span></span>); ControllerContext context = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ControllerContext(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestContext(httpContext, route), controller); controller.ControllerContext = context; controller.Session.Add(CaptchaImage.CaptchaValueKey, <span class="hljs-string"><span class="hljs-string">"1111"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rand = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Random((<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)DateTime.Now.Ticks); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> registerUserView = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserView() { ID = <span class="hljs-number"><span class="hljs-number">0</span></span>, Email = Email.GetRandom(Name.GetRandom(), Surname.GetRandom()), Password = <span class="hljs-string"><span class="hljs-string">"123456"</span></span>, ConfirmPassword = <span class="hljs-string"><span class="hljs-string">"123456"</span></span>, Captcha = <span class="hljs-string"><span class="hljs-string">"1111"</span></span>, BirthdateDay = rand.Next(<span class="hljs-number"><span class="hljs-number">28</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>, BirthdateMonth = rand.Next(<span class="hljs-number"><span class="hljs-number">12</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>, BirthdateYear = <span class="hljs-number"><span class="hljs-number">1970</span></span> + rand.Next(<span class="hljs-number"><span class="hljs-number">20</span></span>) }; controller.Register(registerUserView); } }</code> </pre><br><br>  IntegrationTestSetupFixture.cs      (/Setup/IntegrationTestSetupFixture.cs): <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> removeDbAfter = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre><br><br>  Web.config     : <br><pre> <code class="cs hljs">&lt;<span class="hljs-keyword"><span class="hljs-keyword">add</span></span> name=<span class="hljs-string"><span class="hljs-string">"ConnectionString"</span></span> connectionString=<span class="hljs-string"><span class="hljs-string">"Data Source=SATURN-PC;Initial Catalog=LessonProject_20130314_111020;Integrated Security=True;Pooling=False"</span></span> providerName=<span class="hljs-string"><span class="hljs-string">"System.Data.SqlClient"</span></span> /&gt;</code> </pre><br>   : <br><img src="http://habrastorage.org/storage2/bff/a18/263/bffa182638e5c499ceed9499c5da1a0c.jpg"><br><br><h5>  Total </h5><br>     : <br><ul><li>  TDD      </li><li> NUnit      </li><li> Mock      </li><li> Unit-          </li><li> Integration-,       </li></ul><br><br>  ‚Äì    ,        (  ).          , , ,    TDD          .   ‚Äì     ,  ,     ‚Ä¶ <br>      ,   ,   ,    .  JQuery    2011    qUnit,      . <br><br>  All sources are located at <a href="https://bitbucket.org/chernikov/lessons">https://bitbucket.org/chernikov/lessons</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/176137/">https://habr.com/ru/post/176137/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176123/index.html">PureBasic programming language</a></li>
<li><a href="../176125/index.html">Star Trek: 1971 text game</a></li>
<li><a href="../176127/index.html">Big Data Week in Moscow. April 25-27</a></li>
<li><a href="../176131/index.html">Basics of security of the Android operating system. Native user space, part 1</a></li>
<li><a href="../176135/index.html">Announced a new version of Google Play (Google Play 4.0)</a></li>
<li><a href="../176139/index.html">ASP.NET MVC Lesson F. Work as it is</a></li>
<li><a href="../176141/index.html">Smart alarm clock on .NET</a></li>
<li><a href="../176143/index.html">Asynchronous patterns in Knockout.JS</a></li>
<li><a href="../176145/index.html">Ukraine‚Äôs first full-cycle business incubator Happy Farm conducts a second set of startups</a></li>
<li><a href="../176147/index.html">Simultaneous work of php 5.2 and php 5.3 on Ubuntu 12.04</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>