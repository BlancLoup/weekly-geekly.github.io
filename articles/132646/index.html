<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Design patterns for Android development. Part 4 - Saving data. Domain Model, Repository, Singleton and BDD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At once I want to say that in the article I will not describe how to work with Data Provider. This can be found in the documentation and in numerous a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Design patterns for Android development. Part 4 - Saving data. Domain Model, Repository, Singleton and BDD</h1><div class="post__text post__text-html js-mediator-article">  At once I want to say that in the article I will not describe how to work with Data Provider.  This can be found in the documentation and in numerous articles on the Internet. <br>  Here I will talk about the Domain Model, Singleton, Repository design patterns, the Behavior Driven Development (BDD) approach and how I used them in my program. <br><br>  The Domain Model pattern is used in cases where development is conducted from the subject area, in such cases there is an understandable subject area and its terms are simply embodied in bytes. <br><br>  For example, in my program, the subject area consists of schedule data specified in the form of several alarms; for an alarm clock, you can set the days of the week and the time, as well as the sign ‚Äúalarm is on‚Äù.  There are also several algorithms, for example, to get an alarm clock, which will work next and the date and time of its activation.  Since the alarm clock can be dormant, it turns out that one alarm clock has several triggers with different actions: the first one is activated, the drowsiness, and the last drowsiness, when the snooze button is no longer available.  Therefore, there is an algorithm for teaching the nearest absolute time and action. <br>  There are also algorithms for creating a new alarm clock and editing / deleting existing ones. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      That is, in my data domain there is data in the form of several alarms and several algorithms that implement the logic of the data domain. <br><br>  Why I decided to use this design pattern at all.  Alternatively, I could make a separate class that creates / edits alarm clocks and stores them in a database, and the algorithms for calculating the nearest alarm clock could be done in another class. <br><br>  First, in terms of the subject area, we work with one list of alarms, add new alarms to it and ask what alarm is next.  That is, it looks comfortable in terms of encapsulating data and algorithms.  This model is more convenient for human perception. <br><br>  Secondly, in that case, when I test a model, I can test the usual user behavior.  For example, create an alarm clock, set a schedule for it, check that the model gives the correct next time, then I add a new alarm clock, and disable the old one and check that this time the next time is the right one. <br><br>  This approach is called Behavior Driven Development.  Its advantage is that I can test the model in terms of the subject area, that is, in the unit tests, I simulate the usual user behavior.  Due to the fact that this is implemented through the unit test mechanism, before each release I can get rid of these tests and be sure that my program normally handles the main actions of the user. <br><br>  If I used a separate class to edit / save alarms and a separate class to calculate the nearest alarm, I would certainly test them separately, but I could not check them together and I could not check the basic actions of the user. <br><a name="habracut"></a><br><br><h4>  Model and its interfaces </h4><br>  When implementing the domain, I implemented a model in the form of a class AlarmListModel, which stores alarms and implements these algorithms.  I want to emphasize that the model knows nothing about saving to the database.  The model is maintained by the repository, which I will discuss below. <br><br>  The model has a list of alarms, which is used when calculating the next alarm clock or when editing.  That is, the model stores both data and implements algorithms.  It is obvious that in the class ‚Äúalarm clock‚Äù it is impossible to implement these algorithms, because the one who calculates the time of the next trigger must know about all the alarms turned on, and the ‚Äúalarm clock‚Äù object knows only about itself.  Therefore, my alarm clock is a simple structure with data and without any algorithms. <br><br>  The model implements two interfaces. <br>  IAlarmListModel - implements methods related to the subject area, for example, create a new alarm clock and find out the time of the next trigger. <br>  IListModelData - the interface that is used by the repository to save the model in the database or vice versa to read from the database. <br><br>  I want to note that my repository reads all the data entirely, read the schedules of all the alarms from the database.  This is due to the fact that there are not so many alarm clocks so that I can climb into the database for each one, as well as the fact that in order to calculate the next alarm clock, I need all the alarms turned on, and to display in the list I need all the alarms at all. <br><br>  Below are the main sources of the model and interfaces: <br><br><pre><code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IAlarmListModel</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-function">IDisplayAlarm </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNextDisplayAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Date curTime)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">IDisplayAlarm </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDisplayAlarm iDisplayAlarm)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDisplayAlarm iDisplayAlarm)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IDisplayAlarm item)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">takeAlarmForEdit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> alarmID)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">IDisplayAlarm </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getEditingAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveEditingAlarm</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> stayEditing)</span></span></span></span>; }</code> </pre> <br><br>  The takeAlarmForEdit () and saveEditingAlarm () methods are needed to clone the alarm for editing and be able to discard the changes made by the user if he clicked Cancel.  These methods do not save anything to the database, only to the internal list of alarms. <br><br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IListModelData</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">ArrayList&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getItemList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">ArrayList&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDeletedItemList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre> <br><br>  This interface uses a repository to access the internal alarm lists in the model.  As you can see, there is a list of remote alarms.  This includes alarms that the user has decided to delete, then the repository scans this list and removes alarms from the database. <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AlarmListModel implements IAlarmListModel, IListModelData&lt;AlarmItem&gt; { private ArrayList&lt;AlarmItem&gt; alarmArray = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;AlarmItem&gt;(); private ArrayList&lt;AlarmItem&gt; alarmArrayDeleted = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArrayList&lt;AlarmItem&gt;(); @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized IDisplayAlarm getNextDisplayAlarm(<span class="hljs-type"><span class="hljs-type">Date</span></span> curTime) { // ,      . } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized AlarmItem createAlarm() { AlarmItem alarm = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> AlarmItem(); alarm.setId(<span class="hljs-number"><span class="hljs-number">0</span></span>); //  ,      , //  ID     alarm.setState(EntityState.ADDED); alarm.setName("New alarm");// alarm.setIssue(<span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>);//<span class="hljs-number"><span class="hljs-number">8</span></span>    alarm.setEnable(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>);//  //    // <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> ,      alarm.setDay(Calendar.MONDAY, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); alarm.setDay(Calendar.TUESDAY, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); alarm.setDay(Calendar.WEDNESDAY,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); alarm.setDay(Calendar.THURSDAY, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); alarm.setDay(Calendar.FRIDAY, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); alarm.setDay(Calendar.SATURDAY, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); alarm.setDay(Calendar.SUNDAY, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alarm; } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> addAlarm(IDisplayAlarm item) { AlarmItem alarm = (AlarmItem)item; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(item.getId() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { ex = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("    "); } alarm.setState(EntityState.ADDED); alarmArray.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(alarm); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> updateAlarm(IDisplayAlarm item) { AlarmItem alarm = (AlarmItem)item; alarmArray.<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(getPositionByID(item.getId()), alarm); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> deleteAlarm(IDisplayAlarm item) { AlarmItem alarm = (AlarmItem)item; alarmArray.remove(alarm); alarm.setState(EntityState.DELETED); alarmArrayDeleted.<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(alarm); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> takeAlarmForEdit(<span class="hljs-type"><span class="hljs-type">int</span></span> alarmID) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(alarmID &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) editAlarm = ((AlarmItem)getDisplayAlarmByID(alarmID)).clone(); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> editAlarm = createAlarm(); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized AlarmItem getEditingAlarm() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> editAlarm; } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> saveEditingAlarm(<span class="hljs-type"><span class="hljs-type">boolean</span></span> stayEditing) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(editAlarm == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(editAlarm.getId() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) updateAlarm(editAlarm); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> addAlarm(editAlarm); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!stayEditing)editAlarm = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized ArrayList&lt;AlarmItem&gt; getItemList() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alarmArray; } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized ArrayList&lt;AlarmItem&gt; getDeletedItemList() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> alarmArrayDeleted; } }</code> </pre> <br><br>  So, let's see what is inside our model.  Why all methods are marked as synchronized, read the section on the repository. <br><br>  The createAlarm () method is needed for the model to be a factory for alarms.  I want to note that the factory does not add the created object to the internal list of budilics for this there is a method addAlarm () <br><br>  The addAlarm (), updateAlarm (), deleteAlarm () methods are needed to work with the internal list of alarms.  As you have noticed, the AlarmItem class has methods for monitoring status, these states indicate the status of the record relative to the database: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">enum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">EntityState</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-type"><span class="hljs-type">ADDED</span></span>, <span class="hljs-type"><span class="hljs-type">NOT_CHANGED</span></span>, <span class="hljs-type"><span class="hljs-type">CHANGED</span></span>, <span class="hljs-type"><span class="hljs-type">DELETED</span></span> }</code> </pre> <br><br>  This is a standard technique used in ORM engines to synchronize with the database in order to reduce the number of calls to the database and make changes only for changed records. <br>  As you understand, the AlarmItem class in all its setters sets the status that the record has changed.  The repository analyzes these states in order to decide what needs to be updated in the database and what is not. <br><br>  I want to note that in the addAlarm method I use one trick.  If I have an exception when an incorrect alarm clock is added to the collection, then I do not throw an exception, but I silently store this exception in the field: <br><br><pre> <code class="hljs pgsql">ex = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("    ");</code> </pre> <br><br>  This field is checked in my tests.  After the test is executed, this field must be null, otherwise the test is not passed.  Of course, it would be possible to use Assert or fully throw an exception, but there are situations when an exception cannot be thrown.  For example, if your class implements the interface and you have an exception in the method, and the interface cannot exclude the exception from this method.  In order to catch this exception, I place it in the field of the class under test and check it at the end of the test. <br>  I think there is a more elegant solution to this problem, but I have not yet found it. <br><br>  Methods takeAlarmForEdit (), getEditingAlarm (), saveEditingAlarm () are mainly needed for the alarm editing form.  As I said, they are needed to clone an alarm, change it and, if necessary, discard changes. <br><br><h4>  Meet the repository </h4><br>  The repository has only two methods, save and read the model: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IAlarmRepository</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">load</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre> <br><br>  As you can see there is no mention of the model.  The model I have implemented as a Singleton template, that is, the entire program has only one instance of the model and if one part of the program, for example, UI, changes something in the model, then another part, for example, a server or repository, reading data from the same instance models will immediately receive the latest changes.  It is very convenient when you need to transfer the only existing object between parts of the application. <br><br>  The Singleton template has a number of flaws, for which it even anathematized and called antipattern.  Usually, Singleton is implemented through a static class, which leads to the fact that it cannot be imitated in tests and also to the fact that if a class uses Singleton, then this is not visible from the declaration of the class itself. <br>  There is also a problem in that you need to be sure that the Singleton is always in the correct state, if to transfer a Singleton from one state to another requires two calls, then another Singleton call can be inserted between them and catch a Singleton in the wrong state, which can lead to the wrong result. <br><br>  So I solved the problem with the static class due to the fact that I use RoboGuice, which in this case is a model factory.  Also, using RoboGuice allows you to show that the class uses Singleton and through RoboGuice I can replace Singleton with simulations in tests. <br><br>  The problem of the correct state is solved by the fact that all changes with the model are made in one method call and all methods are marked as synchronized, so that the model does not have two calls at the same time. <br><br>  In this form, Singleton is very useful :).  My model is loaded from the database once and therefore, when the program is running, it is not necessary to spend resources on loading the model in each activity, be it form or service.  Just do not think how to transfer data from one activity to another.  For example, in the editing activity, I transmit only the ID, which in the model I find the alarm clock I need. <br><br>  So learn to cook singleton properly. <br><br>  Here is the repository code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> AlarmRepository implements IAlarmRepository { // Singleton . //,   Singleton   RoboGuice @Inject private IAlarmListModel alarmListModel; @Inject Context context; @Inject <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> AlarmRepository() { db = (<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DBHelper(context)).getWritableDatabase(); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">load</span></span>() { IListModelData&lt;AlarmItem&gt; res = (IListModelData&lt;AlarmItem&gt;)alarmListModel; res.getItemList().clear(); res.getDeletedItemList().clear(); <span class="hljs-keyword"><span class="hljs-keyword">Cursor</span></span> c = db.query(DBHelper.<span class="hljs-built_in"><span class="hljs-built_in">TABLE_NAME</span></span>, projection, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, DBHelper.A_ID); c.moveToNext(); AlarmItem alarm = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!c.isAfterLast()) { alarm = cvToAlarm(c); res.getItemList().<span class="hljs-keyword"><span class="hljs-keyword">add</span></span>(alarm); c.moveToNext(); } c.<span class="hljs-keyword"><span class="hljs-keyword">close</span></span>(); alarmListModel.setLoaded(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } @Override <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> synchronized <span class="hljs-type"><span class="hljs-type">void</span></span> save() { IListModelData&lt;AlarmItem&gt; model = (IListModelData&lt;AlarmItem&gt;)alarmListModel; ContentValues v = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(AlarmItem item : model.getItemList()) { switch(item.getState()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHANGED: v = alarmToCV(item); <span class="hljs-type"><span class="hljs-type">int</span></span> retVal = db.<span class="hljs-keyword"><span class="hljs-keyword">update</span></span>(DBHelper.<span class="hljs-built_in"><span class="hljs-built_in">TABLE_NAME</span></span>, v, DBHelper.A_ID + "=" + item.getId(), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ADDED: v = alarmToCV(item); <span class="hljs-type"><span class="hljs-type">int</span></span> id = (<span class="hljs-type"><span class="hljs-type">int</span></span>)db.<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>(DBHelper.<span class="hljs-built_in"><span class="hljs-built_in">TABLE_NAME</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, v); item.setId(id); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DELETED: ex = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("      DELETED   "); break; } item.setState(EntityState.NOT_CHANGED); } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(AlarmItem item : model.getDeletedItemList()) switch(item.getState()) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> CHANGED: ex = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("      CHANGED   "); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ADDED: ex = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>("      ADDED   "); break; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> DELETED: <span class="hljs-type"><span class="hljs-type">int</span></span> retVal = db.<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>(DBHelper.<span class="hljs-built_in"><span class="hljs-built_in">TABLE_NAME</span></span>, DBHelper.A_ID + "=" + item.getId(), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); break; } model.getDeletedItemList().clear(); } }</code> </pre> <br><br>  I did not show the cvToAlarm () and alarmToCV () methods in them just a lot of lines with the mapping of the alarm fields into the fields of the database table and back, which I don‚Äôt want to clutter up with the article. <br><br>  Once again I will say that I will not consider here how to work with Conten providers.  Therefore, what do db.update () and db.insert () mean in the SDK. <br><br>  Here I will talk about the design pattern "Repository".  As you understand by the secondary features as a declaration of synchronized methods, I also have a repository Singleton. <br><br>  The repository is needed only to save the model in the repository.  The storage can be a file, database or service on the Internet.  As a result, the storage method can be separated from the model and even replaced, if necessary. <br>  Since the repository uses the interface, in tests it can be easily replaced by imitation.  As a result, you can do not only simple unit tests, when only one class is tested, and all dependent parts are replaced by simulations, but also to carry out functional tests.  In functional tests, several classes are tested at once.  As a rule, they take Presenter, model and other auxiliary classes that are needed, and everything below Presenter is replaced by imitation.  It turns out that you can test the supplements using the BDD technique to make sure that the user's main actions are processed normally. <br><br>  As you can see, the load () method reads the entire table of alarms and shifts them to the model.  And the save () method looks at what should be saved in the model and saves only the changed data. <br><br>  PS <br>  Since the article and it turned out great, I did not show tests for the model and the repository.  There is nothing fundamentally new in comparison with Presenter testing.  We also do an instance of the test class in the test, replace the dependencies with imitations via RoboGuice and test the resulting carcass. <br><br><h4>  Read in other articles. </h4><br>  - <a href="http://habrahabr.ru/blogs/android_development/131369/">Introduction</a> <br>  - <a href="http://habrahabr.ru/blogs/android_development/131446/">MVP and Unit tests.</a>  <a href="http://habrahabr.ru/blogs/android_development/131446/">Jedi Way</a> <br>  - <a href="http://habrahabr.ru/blogs/android_development/131652/">User Interface, Testing, AndroidMock</a> <br>  - Saving data.  Domain Model, Repository, Singleton and BDD <br>  - Server side implementation, RoboGuice, testing <br>  - Small tasks, settings, logging, ProGuard </div><p>Source: <a href="https://habr.com/ru/post/132646/">https://habr.com/ru/post/132646/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132641/index.html">Install asterisk 1.6 from freepbx to centos 5.7 in amazon ec2</a></li>
<li><a href="../132642/index.html">My open source bike</a></li>
<li><a href="../132643/index.html">Mobile base station at KAMAZ</a></li>
<li><a href="../132644/index.html">InstaCSS: Convenient CSS Reference</a></li>
<li><a href="../132645/index.html">Flash / Flex and Silverlight go away. When do I need to go to HTML5?</a></li>
<li><a href="../132648/index.html">Want to build a successful software business?</a></li>
<li><a href="../132650/index.html">We invite you to a series of Windows Phone 7 Student Camps in different cities of Russia</a></li>
<li><a href="../132651/index.html">Proactive approach</a></li>
<li><a href="../132652/index.html">Decoding Siri</a></li>
<li><a href="../132653/index.html">Error time zone for Ukraine in the calendar. Do not miss the meeting!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>