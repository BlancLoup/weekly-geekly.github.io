<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>More to the question of sets</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Alice: Why is this place a VERY strange place? 
 Dodo: But because all the other places are not so strange. There must be at least one VERY strange pl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>More to the question of sets</h1><div class="post__text post__text-html js-mediator-article"><h4>  Alice: Why is this place a VERY strange place? <br>  Dodo: But because all the other places are not so strange.  There must be at least one VERY strange place. <br></h4><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/a3/su/r9/a3sur97xweoxvwbgqe_fvjetcai.jpeg"></div><br>  So, we will consider the text of the BitSet template class in order to adapt it to the requirements of the MC, the main directions of optimization were defined earlier.  You can, of course, write your own class from scratch, but let's not neglect the opportunity to familiarize yourself with good solutions, because the library STL (not to be confused with spl) has long been known and used everywhere.  First we need to find the source code, after a short journey through Internet, I simply opened the directory with my MinGW and found the required file, which I intend to discuss further. <br><a name="habracut"></a><br>  At the beginning we see a little more than a page with copyright and license text, as well as various warnings - well, you can skip this, this is for lawyers.  Next come the inclusions and I express my gratitude to the authors - each one is accompanied by a comment, that we want to get from each file - everyone would do that, the work of <s>Indiana Jones the</s> researcher would be simpler.  Next come the defains, I‚Äôm not a fan of the purity of the code and will not argue - let them be and immediately see the definition of the number of bits in the storage unit, which is unsigned long.  Continuing on the slippery path of the Define, I‚Äôm looking for my own definition of the storage unit, which is equal to uint8_fast, although I understand that this will not be enough.  By the way, I immediately bring one more gratitude to the authors for the style - at the end of the module they clean up after themselves, destroying internal defines - no longer hoped that I would see such a thing in modern production. <br><br>  But then light neponyatki begin further - first define the template support structure struct _Base_bitset (why exactly the structure, not the class, since they are interchangeable), which define the type for data storage and it is again specified directly - change it to your own.  Next, we define two instantiations of this auxiliary structure - for one storage unit (well, this is understandable, to increase the code efficiency) and for a degenerate example without storage at all (probably, for error handling), until we touch this code. <br><br>  Next, we find the main class class bitset (now it is a class), derived from the template structure (yes, in C, you can, it‚Äôs not clear why you should do this, but you can), in which the storage type is again determined and again changed to your own.  But here I wondered - why didn‚Äôt the type inherit from the parent structure and discovered with amazement (yes, with amazement, the template classes are not what I do in everyday life) that the inheritance of the template classes is somewhat different from the ordinary ones.  That is, inheritance is just the same and all the entities of the parent are available in the child (I hope no one will take me for a gender chauvinist) class, but they must be specified with their full name.  Well, it can still be understood, otherwise the compiler will not guess which of the instantiated options to apply, but if you use the types defined in the class, you must also add the keyword typename.  Absolutely not an obvious solution, especially I was pleased with the compiler diagnostics, which means ‚Äúmaybe you meant the type from the parent class‚Äù - yes, thank you, captain, it was I who meant it, glad that we understand each other, but it doesn't get easier for me.  However, such a diagnosis takes place in the old version of GCC, in the current message it becomes more understandable ‚Äúyou may have forgotten the keyword typename‚Äù.  Understanding compiler diagnostic messages for template classes is generally a topic for a single song, and this song is anything but joyful. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, if we don‚Äôt want to constantly use the construction in the child class <br><br><pre><code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Base_bitset&lt;Nb&gt;::_WordT</code> </pre> <br>  (and we don't want, nig?) then we have three ways <br><br>  1) trivial <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> _WordT typename _Base_bitset</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;_Nb&gt;::_WordT</span></span></span></span></code> </pre> <br>  2) obvious - type definition at the global level and I liked it more <br><br>  3) for lovers of strange <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Base_bitset&lt;_Nb&gt;::_WordT _WordT;</code> </pre> <br>  (a persistent feeling of a magnificent chrome-plated crutch).  Personally, in all three cases, I am not satisfied with the direct indication of the parent class, because the implementation should not take into account the chain of inheritance, but maybe I don‚Äôt understand something. <br><br>  There is also a method 4) <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> _WordT = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::_Base_bitset&lt;Nb&gt;::_WordT;</code> </pre> <br>  but in my version of the compiler it does not work, so there is none. <br><br>  A note in the margin (PNP) - in a wonderful book ‚ÄúC ++ for real programmers‚Äù (I uploaded it by mistake in due time, having decided that it was devoted to C ++ in real-time systems) about the language said ‚ÄúIts elegance is not in simplicity (the words C ++ and simplicity cut the ears with their apparent contradiction), and in its potential possibilities.  Behind every ugly problem hides some kind of clever idiom, an elegant language trick, thanks to which the problem melts right before our eyes. ‚ÄùSince the book is really wonderful, it means that the quotation is correct (I understand that there is a certain logical stretch), but personally I Unfortunately, I see the problem, but with a smart idiom tension. <br><br>  Despite the remaining feeling of slight bewilderment, the problem is solved and you can enjoy the result - but it was not there.  When you change the size of the test set from 15 to 5, a compilation error suddenly occurred.  No, everything is clear, the unmodified instantiation with the parameter of template 1 worked, but from the outside it looks very strange - we change the constant and the program stops compiling. <br><br>  You can, of course, modify this implementation and the other, but this approach looks like a gross violation of the DRY principle.  There are possible solutions and there are more than one of them 1) the obvious - again define and 2) trivial - again the definition of the type at the global level, but in this case it gets out of the module, which, however, it does in the implementation in question, protruding from the basic structure it‚Äôs just not necessary to write a qualifier. <br><br>  Therefore, I tend to option 3) the base class to determine the type and inherit all instantiations from it.  And the entities of the parent class are protected, again, so that they do not stick out.  Next, I find a funny property, probably, C ++ must be praised for flexibility - for the variant with no storage, the type is not needed, and the language allows using the implementation without inheritance, although this is not particularly necessary in this particular case.  Immediately I discover another drawback of the library - in all three variants, the operations of calculating the number of the storage unit are set each time <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> _S_whichword</code> </pre> <br>  and the bit masks in it are _S_maskbit and they are completely identical - we also put them into the base class.  At the same time, the ‚Äúdead‚Äù code is found - the _S_whichbyte method, I don‚Äôt even know what to do - on the one hand, the rules of good tone require its removal, on the other hand, in the case of a template, this does not affect the resulting code.  I will use the rule - ‚Äúif you don‚Äôt understand something, don‚Äôt touch it‚Äù and leave this method. <br><br>  In principle, the modifications in terms of storage type are complete and testing can begin.  And immediately I discover a lack of implementation - for the MSP430 architecture, for some reason, two-byte words are allocated instead of bytes.  Of course, not double words, as before, but still we are fighting for minimal (in all senses) code.  It turns out that the compiler is confident that in this architecture the type uint_fast8_t has a size of 2, although the system of commands contains operations on bytes and the compiler itself uses them completely.  The idea of ‚Äã‚Äãusing this type is compromised and you have to set the data type uint8_t directly.  Well, if there is an architecture in which the work with the bytes is implemented unsuccessfully and the size of the uint_fast8_t type is different from 1 (none of those found in the compiler), it will have to suffer for the speed of all the others. <br><br>  Testing of the corrected version shows its correct operation on various architectures and with different parameters, but there is still the question of calculating bit masks for MCs without developed shifts, in our case it is MSP430 and AVR.  In principle, you can simply make a bitmask reading out of an array the method for all cases, regardless of the MK architecture.  The solution is quite working, developed architects with indexing are fine, but there will still be a loss in time compared to fast shifts, and I wouldn‚Äôt like to point fingers in my direction with the words ‚Äúthe class will be faster, he said, we optimize he said. <br><br>  Therefore, we need a different implementation for our two weak architectures, which differ from all other sizes in the size of the uint_fast16_t type - it is 2 versus 4, or 8 for 64 bit versions.  A conditional compilation does not help us, and setting a condition in the hope of optimization is not the way of a samurai, there are patterns.  I am trying to create a template class method, but partial specialization is not available for it - it turns out that this is how it should be, and even find an article that says why this is a good solution.  Honestly, I did not understand why this decision is good, most likely, it is due to religious considerations.  However, we were not asked, and what remains to be done - you can make a friendly template function (it turned out that it is impossible, and for the same reason - partial specialization is prohibited), there is another solution that looks funny - partial specialization of the method outside the class body.  You can even create a separate template function and access it from the class methods, I don‚Äôt know which way is more correct, I chose this one.  Yes, it does not have access to the internal entities of the class, but in this particular case it is not necessary, what to do if necessary, I do not know yet, ‚Äúwe will solve problems as they arise.‚Äù <br><br>  Now we have everything we need, we put the tested fragments together and we get the code that solves the initially set optimization problem.  At the same time, we made the code more compact (and therefore more understandable, although the latter is controversial), removed numerous repetitions and eliminated redundant entities sticking out.  The only thing that is not fixed is the confusion of structures and classes, but I don‚Äôt understand the reasons for this implementation, therefore, just in case, I will not touch this part. <br><br>  A separate post will be devoted to the implementation of the second variant of the set, and without that something has happened a lot. </div><p>Source: <a href="https://habr.com/ru/post/450176/">https://habr.com/ru/post/450176/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../450166/index.html">We invite developers to Think Developers Workshop</a></li>
<li><a href="../450168/index.html">Internet history: core network</a></li>
<li><a href="../45017/index.html">Netbeans 6.5</a></li>
<li><a href="../450170/index.html">AR, robotics and cataracts: how we went to the Russian-German programming school</a></li>
<li><a href="../450172/index.html">Timer in iOS</a></li>
<li><a href="../450180/index.html">6 useful tools to start a startup in the US</a></li>
<li><a href="../450182/index.html">Billing modeling in a cloud reporting provider</a></li>
<li><a href="../450188/index.html">How to accomplish 70 tasks in a day: life in task trackers is a good life</a></li>
<li><a href="../450192/index.html">Progressive scale of taxation</a></li>
<li><a href="../450194/index.html">Oops, I did it again: debug common javascript errors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>