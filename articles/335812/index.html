<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Simple Java code breaking the Scala type inference system</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Simple Java code: a generic interface, a class that implements it, and a method that accepts its instance: 


//Gen.java: public interface Gen<A> { A ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Simple Java code breaking the Scala type inference system</h1><div class="post__text post__text-html js-mediator-article"><p>  Simple Java code: a generic interface, a class that implements it, and a method that accepts its instance: </p><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//Gen.java: public interface Gen&lt;A&gt; { A value(); } //GenInt.java: public class GenInt implements Gen&lt;Integer&gt; { private final int i; public GenInt(int i) { this.i = i; } @Override public Integer value() { return i; } } //GenTest.java: public class GenTest { public static &lt;A extends Gen&lt;T&gt;, T&gt; T test(A a) { return a.value(); } public static void main(String[] argv) { GenInt g = new GenInt(42); Integer i = test(g); } }</span></span></code> </pre> <br><p>  It compiles and even starts.  What do you think will happen if you want to call the <code>test</code> method from Scala? </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestFail</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> genInt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">GenInt</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> i = <span class="hljs-type"><span class="hljs-type">GenTest</span></span>.test(genInt) }</code> </pre> <a name="habracut"></a><br><p>  We are trying to compile and see that everything is bad: </p><br><pre> <code class="hljs vhdl"><span class="hljs-literal"><span class="hljs-literal">Error</span></span>:(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">11</span></span>) inferred <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> arguments [GenInt,Nothing] do <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> conform <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> method test<span class="hljs-symbol"><span class="hljs-symbol">'s</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">parameter</span></span> bounds [A &lt;: Gen[T],T] GenTest.test(genInt) <span class="hljs-literal"><span class="hljs-literal">Error</span></span>:(<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">16</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> mismatch; found : GenInt required: A GenTest.test(genInt)</code> </pre> <br><p>  This is how the powerful Scala type system breaks down about the generic method that normally digests Java. </p><br><h2 id="chto-zhe-proizoshlo">  What happened? </h2><br><p>  Unlike Java, Scala does not know how to display typical parameters from parent classes.  Maybe due to the fact that Java was not Nothing?  If you know, please tell us. </p><br><p>  <strong>UPD:</strong> <a href="https://habrahabr.ru/users/darkdimius/" class="user_link">darkdimius</a> in the comments hinted (for which he thanks) that Scala uses the declaration-site variance in the type inference system, while in java it uses the use-site variance, that is, Scala tries to display typical parameters from the ad, and not from call  I also rejoiced that the original example works in Dotty. </p><br><blockquote>  If you mix the two types in the system is very risky, and in the type inference system (inferece) - even more so. </blockquote><br><h2 id="kak-s-etim-zhit-dalshe">  How to live with this? </h2><br><p>  Of course, in such cases we can always explicitly specify typical parameters when calling the method: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestExplicit</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> genInt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">GenInt</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>) <span class="hljs-type"><span class="hljs-type">GenTest</span></span>.test[<span class="hljs-type"><span class="hljs-type">GenInt</span></span>, <span class="hljs-type"><span class="hljs-type">Integer</span></span>](genInt) }</code> </pre> <br><p>  But, you see, this is still a bit not what we wanted. </p><br><p>  And why does the parent class <code>Gen[T]</code> not suit us?  First, it does not match the boundaries of the type that the argument supports, since it is not a subtype of itself.  Secondly, at the same time we will lose the original type <code>A</code> , and we may need it. </p><br><h3 id="workaround">  Workaround </h3><br><p>  We are helped by dependent types. </p><br><p>  We will keep the class type of the successor <code>Gen[T]</code> as dependent in the wrapper <code>GenS[T]</code> . </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">trait</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenS</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">] </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Gen</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELF</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">&lt;</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">GenS</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">SELF</span></span> } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenIntS</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">i: </span></span><span class="hljs-type"><span class="hljs-class"><span class="hljs-params"><span class="hljs-type">Int</span></span></span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenInt</span></span></span><span class="hljs-class">(</span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">i</span></span></span><span class="hljs-class">) </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenS</span></span></span><span class="hljs-class">[</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Integer</span></span></span><span class="hljs-class">] </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SELF</span></span></span><span class="hljs-class"> </span></span>= <span class="hljs-type"><span class="hljs-type">GenIntS</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">self</span></span></span></span>: <span class="hljs-type"><span class="hljs-type">SELF</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-comment"><span class="hljs-comment">//       }</span></span></code> </pre> <br><p>  Now we can safely receive objects of the heirs of the <code>GenS[T]</code> trait under its parent type, without fear of losing the original type, because it is statically preserved. </p><br><p>  For this we will <code>GenTest.test</code> wrapper for the <code>GenTest.test</code> method in which we will help the compiler to infer types: </p><br><pre> <code class="scala hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">object</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TestWrapped</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">App</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>](g: <span class="hljs-type"><span class="hljs-type">GenS</span></span>[<span class="hljs-type"><span class="hljs-type">T</span></span>]): <span class="hljs-type"><span class="hljs-type">T</span></span> = { <span class="hljs-type"><span class="hljs-type">GenTest</span></span>.test[g.<span class="hljs-type"><span class="hljs-type">SELF</span></span>, <span class="hljs-type"><span class="hljs-type">T</span></span>](g.self) } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> v = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-type"><span class="hljs-type">GenIntS</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">val</span></span> i = test(v) }</code> </pre> <br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  The described approach is not perfect, it requires writing wrappers for classes, nevertheless it avoids explicitly specifying all typical parameters for each call, and can help when writing Scala wrappers for Java libraries. </p><br><p>  It is also worth noting that there will be difficulties with it when the generic interface is not directly derived from the arguments, for example, when the method takes the type <code>Class[A]</code> , which we can no longer decorate so easily, and will have to resort to other tricks. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/335812/">https://habr.com/ru/post/335812/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335800/index.html">The Great Silk Road: from tablets from China to a nanny-robot from Moscow region</a></li>
<li><a href="../335804/index.html">Random forest vs neural network: who will better cope with the task of recognizing gender in speech (part 2)</a></li>
<li><a href="../335806/index.html">Guide to localizing applications for the Chinese market. Part 1</a></li>
<li><a href="../335808/index.html">BIM: how we build builders in construction</a></li>
<li><a href="../335810/index.html">We break and restore the Chinese IP camera</a></li>
<li><a href="../335814/index.html">Kubernetes success stories in production. Part 3: GitHub</a></li>
<li><a href="../335816/index.html">Computer networks for dummies</a></li>
<li><a href="../335818/index.html">Yamichat - customizable chat bot and online consultant in one platform</a></li>
<li><a href="../335820/index.html">Modern methods of web application security research</a></li>
<li><a href="../335824/index.html">The second edition of the book "Learning Python. Game programming, data visualization, web applications</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>