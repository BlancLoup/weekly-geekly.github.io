<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OpenWRT + OpenVPN for Asterisk. Budget way to organize a VPN network</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is another article about the MR3020 router, OpenWRT and OpenVPN. As a bonus, I post the ready firmware for this router with the OpenVPN installed...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OpenWRT + OpenVPN for Asterisk. Budget way to organize a VPN network</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/ee5/77e/032/ee577e0321d346d992a9f75139666636.jpg" alt="image" align="left">  This is another article about the MR3020 router, OpenWRT and OpenVPN.  As a bonus, I post the ready firmware for this router with the OpenVPN installed, the text editor Nano and wget.  The firmware is turned off all unnecessary, including the web interface, ipv6 and WiFi. <br><a name="habracut"></a><br>  Working with the router is possible only through telnet and SSH.  I will not write how to raise the OpenVPN server, a lot of articles about this, <a href="http://icluzo.livejournal.com/10616.html">this article</a> helped me personally. <br><br><h4>  Prehistory </h4><br>  To organize the telephone network I needed to organize a VPN.  OpenVPN was chosen for this purpose. <br>  Since the budget was limited, it was decided to put on points, and, by the way, there were three of them.  Cheapest routers with OpenWRT support. <br><br>  TP-Link MR3020 was purchased for the test, and after successful testing, a couple more of these babies were purchased. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Although the router has only one LAN port, it turned out to be very convenient to connect it at the points.  There is no need to put a VoIP-gateway and a router in close proximity to each other.  The prepared router connects to any free network port at a remote point, the Voip gateway can also be connected to any free network port by specifying the IP address of our router to the gateway.  Naturally, both of them should be on the same network as the Internet gateway. <br><br><h4>  Configure the router </h4><br>  If the MR3020 is fresh, then go to the web interface and upload the <a href="">firmware</a> through the appropriate menu.  If the router already has OpenWRT, then we act as follows: <br><br>  We go to the router via telnet or SSH and execute: <br><br><pre><code class="html hljs xml">cd /tmp/ &amp;&amp; wget http://alians-it.pro/images/files/openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-factory.bin &amp;&amp; mtd -r write openwrt-ar71xx-generic-tl-mr3020-v1-squashfs-factory.bin firmware</code> </pre> <br>  If there is no internet, then in any way we upload the firmware to the router, for example, via SSH (scp) or, as I do: install a web server on your computer, put the firmware in the www directory and also download the firmware via wget, but your computer. <br><br>  If you have done something wrong or have forgotten the address of the router, you can put it into ‚Äúemergency mode‚Äù: Turn off / turn on the router;  wait until the LED under the WPS / RESET button flashes approximately once per second (WPS / RESET is on for 3 seconds, then goes off for 3 seconds), immediately press this button and wait until it starts blinking very quickly, release the button .  Everything, the router is available through telnet at 192.168.1.1.  Configure the network and reflash. <br><br>  After successful firmware, we go to the router via telnet at 192.168.1.1 and set the password for root: <br><br><pre> <code class="bash hljs">passwd</code> </pre><br>  Enter the password twice, and reboot the router: <br><br><pre> <code class="bash hljs">reboot</code> </pre><br>  After the reboot, the router will only be available via ssh, the root login is the password you specified. <br><br><h4>  Network configuration: </h4><br><pre> <code class="bash hljs">nano /etc/config/network</code> </pre><br><div class="spoiler">  <b class="spoiler_title">We bring the file to the following form:</b> <div class="spoiler_text"><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'loopback'</span></span> option ifname <span class="hljs-string"><span class="hljs-string">'lo'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'static'</span></span> option ipaddr <span class="hljs-string"><span class="hljs-string">'127.0.0.1'</span></span> option netmask <span class="hljs-string"><span class="hljs-string">'255.0.0.0'</span></span> config globals <span class="hljs-string"><span class="hljs-string">'globals'</span></span> option ula_prefix <span class="hljs-string"><span class="hljs-string">'fd69:9e94:7464::/48'</span></span> config interface <span class="hljs-string"><span class="hljs-string">'lan'</span></span> option ifname <span class="hljs-string"><span class="hljs-string">'eth0'</span></span> option force_link <span class="hljs-string"><span class="hljs-string">'1'</span></span> option <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> <span class="hljs-string"><span class="hljs-string">'bridge'</span></span> option proto <span class="hljs-string"><span class="hljs-string">'static'</span></span> option netmask <span class="hljs-string"><span class="hljs-string">'255.255.255.0'</span></span> option ip6assign <span class="hljs-string"><span class="hljs-string">'60'</span></span> option ipaddr <span class="hljs-string"><span class="hljs-string">'192.168.1.11'</span></span> option gateway <span class="hljs-string"><span class="hljs-string">'192.168.1.10'</span></span> option dns <span class="hljs-string"><span class="hljs-string">'8.8.8.8'</span></span> option delegate <span class="hljs-string"><span class="hljs-string">'0'</span></span></code> </pre><br></div></div><br>  You need to edit the section: <br><br><pre> <code class="bash hljs">config interface <span class="hljs-string"><span class="hljs-string">'lan'</span></span></code> </pre><br>  Where 192.168.1.10 is the address of the Internet gateway in the network of the remote point, and 192.168.1.11 is any free address that our router will have.  If you have free address 192.168.1.1, then add only <pre> <code class="bash hljs">option gateway <span class="hljs-string"><span class="hljs-string">'192.168.1.10'</span></span> option dns <span class="hljs-string"><span class="hljs-string">'8.8.8.8'</span></span></code> </pre>  . <br>  DNS optional. <br><br><h4>  OpenVPN setup: </h4><br>  We move and copy the keys and certificates to the / etc / openvpn / folder.  For convenience, I add everything to the archive and download at once: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /etc/openvpn/ &amp;&amp; wget http://192.168.1.5/client_Sushi_Terra.tar.gz &amp;&amp; tar xzvf client_Sushi_Terra.tar.gz</code> </pre><br>  As you guessed, 192.168.1.5 is the address of my work computer with the installed web server, and client_Sushi_Terra is the name of the remote point that was created when generating certificates and keys on the OpenVPN server. <br><br>  Editing client configuration: <br><br><pre> <code class="bash hljs">nano /etc/openvpn/client.conf</code> </pre><br><div class="spoiler">  <b class="spoiler_title">It was</b> <div class="spoiler_text">  client <br>  port port <br>  remote ip-adres <br>  proto udp <br>  dev tun <br>  ca /etc/openvpn/ca.crt <br>  cert /etc/openvpn/client_Sushi_Terra.crt <br>  key /etc/openvpn/client_Sushi_Terra.key <br>  #cipher BF-CBC <br>  #auth MD5 <br>  pull # <br>  comp-lzo <br>  persist-key <br>  persist tun <br>  verb 3 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">It became</b> <div class="spoiler_text">  client <br>  port 7193 <br>  remote 37.193.254.254 <br>  proto udp <br>  dev tun <br>  ca /etc/openvpn/ca.crt <br>  cert /etc/openvpn/client_Sushi_Terra.crt <br>  key /etc/openvpn/client_Sushi_Terra.key <br>  #cipher BF-CBC <br>  #auth MD5 <br>  pull # <br>  comp-lzo <br>  persist-key <br>  persist tun <br>  verb 3 <br></div></div><br>  Where <b>port 7193 and remote 37.193.254.254</b> is the port and address of the OpenVPN server. <br>  We also configure maskvarding on port tun0 after successful start of OpenVPN: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">'iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE'</span></span> &gt;&gt; /etc/init.d/openvpn</code> </pre><br>  Restart the router again: <br><br><pre> <code class="bash hljs">reboot</code> </pre><br>  Now the router will be available at 192.168.1.11. <br><br>  If everything is correct, a new tun0 interface will appear. <br><br><h4>  Setting the fire wall: </h4><br>  Open the / etc / config / firewall file for editing: <br><br><div class="spoiler">  <b class="spoiler_title">nano / etc / config / firewall</b> <div class="spoiler_text"><pre> <code class="bash hljs">config defaults option syn_flood <span class="hljs-string"><span class="hljs-string">'1'</span></span> option output <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> option forward <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> option input <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> <span class="hljs-comment"><span class="hljs-comment">#'DROP' config include option path '/etc/firewall.user' config rule option target 'ACCEPT' option name 'ssh' option proto 'tcp' option src '*' option src_port '22' option dest_port '22'</span></span></code> </pre><br></div></div><br>  And replace: <br><br><pre> <code class="bash hljs">option input <span class="hljs-string"><span class="hljs-string">'ACCEPT'</span></span> <span class="hljs-comment"><span class="hljs-comment">#'DROP'</span></span></code> </pre><br>  On: <br><br><pre> <code class="bash hljs">option input <span class="hljs-string"><span class="hljs-string">'DROP'</span></span></code> </pre><br>  Now the router will be available only on port 22, although otherwise it will not be able to reach it.  You can specify an ip-address instead of "*", and this will be the only address from which you can enter the router via ssh. <br><br><h4>  Setting up a VoIP gateway </h4><br>  Network configuration: specify the IP address of our router as the Internet gateway: <br><br><img src="https://habrastorage.org/files/d95/7c7/4e4/d957c74e4d1343ec8f702460c1d180b7.gif" alt="image"><br><br>  I have OpenVPN raised on the same server as Asterisk, so I specify the address of the OpenVPN server as the sip proxy. <br><br>  If Asterisk is installed on a separate server, then it is necessary in the configuration of the OpenVPN server to allow clients to see each other and transfer routes to clients to each remote point. <br><br>  SIP configuration: specify as sip proxy: the address of the Asterisk server. <br><br><img src="https://habrastorage.org/files/11c/91e/51a/11c91e51a3dd45ce9c6b3b5ba29569fd.gif" alt="image"><br><br>  If you specify the gateway to our router on any other device, then the entire OpenVPN network and all subnets of remote points will also be available to it, if, of course, this is allowed and configured on the OpenVPN server itself. <br><br>  I would also add that I recommend setting up a firewall on both the server with Asterisk and the server with OpenVPN - as if the internal network, including VPN, is as aggressive as the public Internet. </div><p>Source: <a href="https://habr.com/ru/post/253331/">https://habr.com/ru/post/253331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253319/index.html">Introduction to what3words API: Basic Procedures and Samples</a></li>
<li><a href="../253321/index.html">We write ARP Spoofer for Android. Development of Root tools for Android</a></li>
<li><a href="../253323/index.html">Creating a custom matcher for unit testing in Jasmine 2.0</a></li>
<li><a href="../253327/index.html">Google will increase the security of its Android app store</a></li>
<li><a href="../253329/index.html">JetBrains at RubyConfBy in Minsk on March 22</a></li>
<li><a href="../253333/index.html">Corporate Laboratories PENTESTIT - practical training in the field of information security</a></li>
<li><a href="../253335/index.html">Your wi-fi will tell me where you live, where you work and where you travel</a></li>
<li><a href="../253337/index.html">We play the sapper in Photoshop</a></li>
<li><a href="../253341/index.html">Why is WPF alive?</a></li>
<li><a href="../253343/index.html">Most Elite IP Addresses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>