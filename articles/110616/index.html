<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Linux is under load. High performance shaper</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last article, we looked at some aspects of tuning a Linux router that is designed to work under high load conditions: Linux under load. Router,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Linux is under load. High performance shaper</h1><div class="post__text post__text-html js-mediator-article">  In the last article, we looked at some aspects of tuning a Linux router that is designed to work under high load conditions: Linux under load.  Router, NAT-server Now it‚Äôs about the shapers. <br><a name="habracut"></a><br>  Limiting the speed of passing traffic (shaping) is a fairly resource-intensive task.  Therefore, in the presence of at least several hundred subscribers in the network, and in the presence of large volumes of passing traffic, the question of optimizing the shapers is particularly acute. <br><br>  Consider the shaper running Linux: this OS has shown the best performance results under high load conditions. <br><br><h4>  Short introduction </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Shaper is the discipline of serving packet queues.  Discipline can be with classes and without them.  With classes - it means that traffic can be ‚Äústitched‚Äù in accordance with a particular class. <br><br>  What traffic is shaped by which class - determines the filter. <br><br>  Simply put, we have two trees: a tree of filters and a tree of classes.  Filters spread traffic to classes according to certain criteria.  In classes, traffic is prioritized or shaped according to the parameters specified in the classes. <br><br><h4>  With and without hashes </h4><br><br>  Like any tree, the filter tree becomes too resource-consuming when it reaches a certain threshold. <br><br>  When a packet from some IP address falls on the filter tree, it begins to be compared with the criteria of each filter.  If it matches, the packet is sent to the appropriate class.  Those.  For each incoming packet, a sequential check is performed to see if each filter in the tree meets the criteria until a match occurs. <br><br>  For example, for the network on the 24th mask, we will have an average of 128 steps for each packet when searching for the required class. <br><br>  This is insignificant with small volumes of traffic and with a small number of subscribers.  When there are tens of thousands of subscribers, and gigabits go to the Internet, this approach becomes simply impossible - the shaping server will simply not cope with the load. <br><br>  If the entire tree is a sequence of checks for an IP address, it will be much more efficient to use hashes.  A hash is a table of correspondences of some ‚Äúvalues‚Äù to certain ‚Äúkeys‚Äù.  In our case, the key is the IP address, and the value is the filter that sends the packet to its class. <br><br>  Thus, by the key (IP-address) we quickly find the filter for the packet, in 1 step. <br><br>  Actually, a lot has already been written about the use of hashes of articles - this is not ‚Äúsomething military‚Äù.  You can refer to the <a href="http://lartc.org/howto/lartc.adv-filter.hashing.html">source</a> . <br><br><h4>  The script to build the shaper </h4><br><br>  To make life easier when building shapers, the <a href="http://vcalinus.gemenii.ro/%3Fp%3D9">Fast U32 hashing filter generator</a> can be such a C program written by a Romanian (?) Sysadmin. <br><br>  At the input it is given the following parameters: <br><br><ul><li>  prefix.in - a list of prefixes and corresponding classes in the format &lt;prefix&gt; &lt;class&gt; </li><li>  u32filters.out - output file, filters will be saved here </li><li>  interface - the name of the interface on which the shaper will be built </li><li>  src / dst - flow direction (inbound or outbound) </li><li>  batch - if this parameter is specified, the output file will be generated suitable for running tc ‚Äìb </li></ul><br><br>  Detailed examples can be found on the project page above. <br><br>  Strictly speaking, you do not need to particularly delve into the essence of the work of this program - in this case you will not have to deal with it. <br><br>  For convenience, I wrote a small script that builds tables of prefixes and classes on the basis of a given configuration, runs the above-mentioned program for building filters with the necessary parameters, builds a ready-made configuration of the shaper from all the available stuff and runs it through tc ‚Äìb. <br><br>  All that is required is to specify some configuration parameters in the file. <br><br><h4>  Script configuration </h4><br><br>  The folder of the script has the following folders and files: <br><br><ul><li>  data - the intermediate results of the script will be located here, as well as the final configuration of the shaper: _classes - ready configuration of the shaper, _filters - filters with hashes, _prefixes - table of correspondences of prefixes to classes, _speeds - correspondence of classes to speeds </li><li>  lib - necessary for the library to work </li><li>  log - event logging during script operation </li><li>  pid - here lies the pid of the process to prevent simultaneous running of multiple copies of the script </li><li>  config - the main script configuration file </li><li>  networks - the list of networks to which it is necessary to build shapers. </li><li>  prefixtree.c - source filter builder with hashes </li><li>  shaper.php - the shaper script itself </li></ul><br><br>  All script configuration is in the config file.  To configure, it is necessary to change the following parameters for yourself: <br><br><ul><li>  At the beginning of the config, the parameters for connecting to the database for retrieving IP addresses and speed parameters </li><li>  DEV - the interface on which to build the shaper </li><li>  DIR - traffic flow direction in relation to subscribers: can be in or out (incoming and outgoing respectively) </li></ul><br><br>  The rest is not necessary to change. <br><br>  In the networks file, you can describe the networks for which you want to build shapers.  If the file is empty, the shapers will be built for all subscribers. <br><br>  Subscriber IP addresses are selected from the database in MySQL. <br><br>  Shapers table: <br><br><ul><li>  shaper_id - unique caller ID </li><li>  id - the shaper ID </li></ul><br><br>  Table cl_status: <br><br><ul><li>  ip - subscriber IP address </li><li>  shaper_id - unique caller ID </li><li>  status - subscriber status (3 - on) </li><li>  sin - incoming speed </li><li>  sout - outgoing speed </li></ul><br><br>  Most likely, it will be easier to adapt the request to select the IP addresses of subscribers for your specific database, rather than vice versa.  To do this, correct the request in the 70th line of the shaper.php file. <br><br><h4>  Compiling prefixrtee.c </h4><br><br>  For the script to work, it is necessary to compile the attached prefixtree.c file. <br><br>  This is done by the command: gcc prefixtree.c ‚Äìo prefixtree <br><br>  I want to note that along with this script a slightly revised version of the prefixtree is attached, adapted for such use. <br><br><h4>  Running script </h4><br><br>  After you have made the appropriate changes in the config, sorted out the selects in shaper.php, compiled prefixtree.c, made (if necessary) the necessary networks in networks ‚Äî you can run the script. <br><br>  Starting should be done as root, and it simply consists in: <br><br>  / usr / bin / php ‚Äìq shaper.php <br><br>  After this script: <br><br><ul><li>  read config </li><li>  read networks </li><li>  make the necessary sample from the database for each IP (based on networks) </li><li>  will create a data / _prefixes file </li><li>  will create a data / _speeds file </li><li>  runs the prefixtree for execution, which will create the data / _filters file </li><li>  will create a data / _classes file </li><li>  will launch tc ‚Äìb data / _classes </li></ul><br><br>  As a result, a shaper will be built and launched on the specified interface according to the specified parameters for the specified IP addresses. <br><br>  If the subscriber has several IP addresses, one class will be built with the specified speed parameter and all subscriber IP addresses will be sent to this class.  Thus, if the subscriber has several IPs, one ‚Äúchannel‚Äù of a given speed will be created, which will be divided between his IP. <br><br>  The resulting configuration of the shaper will be in the data / _classes - this is a ready-made config file that you can feed tc from the batch (-b) options. <br><br><h4>  Logs </h4><br><br>  All stages of the script are reflected in the logs - the log folder. <br><br><h4>  Statistics </h4><br><br>  Such shaper successfully serves more than 5 thousand subscribers. <br><br><h4>  Notes </h4><br><br>  Specific bandwidth values ‚Äã‚Äãand htb parameters in the shaper.php file will need to be corrected in each specific case. <br><br><h4>  Download script </h4><br><br>  Since there is too much code to bring it all here, you can download the script on its <a href="http://storinka.com.ua/projects/">home page.</a> </div><p>Source: <a href="https://habr.com/ru/post/110616/">https://habr.com/ru/post/110616/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../110609/index.html">The world's largest Android-based phone - the 42-inch Nexus S</a></li>
<li><a href="../110610/index.html">Arduino Ethernet Thermometer</a></li>
<li><a href="../110611/index.html">I blinded him from what was</a></li>
<li><a href="../110612/index.html">Xmas Time: nice girl draws time</a></li>
<li><a href="../110614/index.html">60 million tabs on good deeds</a></li>
<li><a href="../110617/index.html">We use Javascript engine from IE9 without IE9</a></li>
<li><a href="../110619/index.html">LibreOffice 3.3 RC2</a></li>
<li><a href="../110620/index.html">No FBI backdoors found in OpenBSD</a></li>
<li><a href="../110622/index.html">TOP 11 best trailers of the year</a></li>
<li><a href="../110626/index.html">A small review of the tablet ViewSonic G Tablet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>