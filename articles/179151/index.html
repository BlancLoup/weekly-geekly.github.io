<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Nexenta operating experience, or 2 months later</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of months ago we launched a storage system based on Nexenta for mass virtualization needs. We put it under a good load and not everything wen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Nexenta operating experience, or 2 months later</h1><div class="post__text post__text-html js-mediator-article">  A couple of months ago we launched a storage system based on Nexenta for mass virtualization needs.  We put it under a good load and not everything went like clockwork and a book.  Who are interested in the shocking details and operating experience, please under the cat. <br><a name="habracut"></a><br><br>  I remind you, Nexenta is such a commercial software for storage systems, based on ZFS / OpenSolaris.  It knows a lot of things, but we need to feed our virtualization nodes under KVM and Hyper-V / Windows 2008 HA Cluster via iSCSI - with deduplication, cache, and all the other gingerbread. <br>  The car was assembled fit, 36 discs of 300Gb SAS 15K, found 300Gb SDD Intel 710 series (nowhere better) and so on. <br><br>  We have collected the server, set Nexent.  Its official partners delivered us Nexents, certified engineers.  It all started, earned.  Solemnly included deduplication, rejoiced.  Have adjusted bakap. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We began to move virtual machines there from the Hyper-V / Windows 2008 R2 cluster.  And I have to say a lot of them, quite a few hundred, and their size is not small - 20GB on average.  There are 5 GB, and there are 200. <br><br>  We have divided the cluster, the old one was in the old data center, and we have already assembled a new cluster in the new one.  Therefore, they migrated not by LAN, but through VLAN over several hundred megabits ‚Äî the migration of VMs with a 200GB disk was delayed for several hours. <br><br>  Everything would be fine, but we caught the first joint in a week - as we migrated <b>to Nexent, the memory for the deduplication table ran out.</b>  I must say that in Nexent, the deduplication table refers to the disk pool, and not to a specific volume.  If the memory runs out, it does not mean that the smart system will disable the fashion feature in advance.  A smart system will go into a stupor with performance degradation by an order of two.  Those.  if earlier you were chasing the VM body at a speed of 80-90MB / s through a gigabit port, now it will be 3-4MB / s and 200-300 IOPS at all. <br><br>  As it turns out, for each FS block in the Nexente pool, you need approximately 500 bytes in memory for the deduplication table.  If we have 128GB of memory in the system, Nexenta can store information about 256,000,000 blocks: <br>  <b>the maximum size of the occupied pool on 4K blocks is 1TB, on 16K blocks 4Tb, on 32K blocks 8Tb and on 64K blocks 16Tb.</b>  Write it down with a red marker on the wall!  Go abroad and goodbye premium =) <br><br>  If you <b>didn‚Äôt set the block size right at the beginning, nothing will help</b> except migrating to a new volume with the correct size.  If you turn off deduplication, nothing happens.  The deduplication table has nowhere to go, including from memory.  All that can be done is to create another new volume without deduplication and copy the old one there.  Yes, if you have the DD table overflowed for this moment, it will be copied at about 3-4 GB per minute.  In our case, the volume was about 4TB in size, the migration (zfs send / zfs receive) took about 16 hours.  Then we erased a volume with deduplication, after a couple of hours the car felt so much better that we could start everything up. <br><br>  Please note that we had free space on volumes - we could do it.  But if there is not enough space for migration inside the repository due to lack of disks or license restrictions, then welcome to the world of wonders and adventures.  iSCSI in this situation barely works and constantly falls off from Windows on timeouts, Linux stoically transfers the brakes.  A block device will have to be mounted and many hours will be trying to merge content from there, another option is to finish the memory into the server with Nexenta (to give up the mother, as a rule), so that she would come to her senses ... <br><br>  More about <b>deduplication at the block level</b> .  It does not work, forget it.  Holding on the array with blocks (sic!) 4Kb hundreds of client VMs .vhd assembled from 3-4 templates, we expected it to be like in the book about NetApp, coefficient 8-10.  This did not work out, the dedup ratio was about 2-3.  Those.  the inclusion of basic compression leads to a similar result - 40%.  To achieve coefficients of 8-10, you should probably use offline deduplication with a creeping block.  It's like in the storage pools of the new Windows 2012 or ONTAP. <br><br>  Further more.  Turn off deduplication, everything started.  Volumes are large, 7TB each.  We continue the migration of VM Hyper-V from the old cluster to the new one, we notice on MRTG - the write speed is reduced.  Not immediately, slowly.  During the day of migration at a speed of 50-60MB / s two times. <br><br>  Why?  Here comes the second joint, not described in the marketing materials immediately.  <b>It is worth ZFS pool filled as it is radically degraded in performance</b> .  More than 30% of the free space is not evident (but it can be seen on the graph), from 30 to 10% everything works three times slower, and if the space becomes less than 10%, everything works an order of magnitude slower. <br><br>  Moral, <b>watch the place</b> .  If there is no space on the pool, it will be a catastrophe - it will be necessary to expand the pool abnormally by pushing disks / shelves / licenses or migrating data to neighboring storage systems / local disks of nodes.  Nexenta feels in good health, if she has more than 30% free space, plan this when calculating servers. <br><br>  But this is not the most unpleasant.  The most unpleasant thing is when Hyper-V loses the quorum disk or the entire Cluster Shared Volumes on 4TB feeding three large nodes and it is impossible to mount it on one of the nodes by any means.  How to achieve such a magical result: put a hundred VMs on one CSV volume under Windows, start them and start migrating a few more VMs to this volume.  At first, everything is cheerfully copied, then the copying process stops, and then CSV falls off at your place.  Yes, on the whole cluster.  In this case, the target will be visible, but you can not mount a volume from them. <br><br>  In some cases, it turns out to be mounted back, and in some cases, after daily communication with MS support, Nexenta can be mounted on one of the nodes of the former cluster on which the .vhd files are located - without configurations.  Then you will be able to copy them at the above speed to the good old hard drives of the node and then start one at a time there, starting them in Hyper-V with handles. <br><br>  This applies only to Hyper-V / Windows 2008 R2 and does not apply to KVM.  This does not apply to Starwind - it works smoothly in this mode.  Our opinion is that iSCSI Winds 2008 and Nexent are not quite compatible with each other, massive parallel recording / reading leads to locks, timeouts and malfunctions.  Nobody told us anything intelligible in support of both companies.  The forums say that some patches help Windows in some cases, that the type of LUN should be changed, etc. <br><br>  Further, the <b>upgrade of the system on Nexent requires its reboot.</b>  If there is no high-availability storage cluster, prepare to announce technical work or migrate all VMs to neighboring storage sites.  Keep this in mind, the changelog between the versions of Nexents is huge. <br>  Further, the Nexenta disk pool should ideally consist of identical disks assembled into the same raid group.  You will not be able to further expand these groups or change the type of raid in them. <br><br>  In general, about these impressions of the Nexenta after 2 months of work.  Now we have Linux virtualization rather smoothly and quickly working with Nexenta, Windows 2012 Cluster working with Starwind and we are testing Storage Pools SMB 3.0 speed and mechanism for using them to organize high-availability CSV.  Yes, offline deduplication works there and we see good odds, but this is a topic for another article. <br><br>  For general performance reasons and IO pattern.  For VPS tasks, SAS disks in the pool are not needed; 12 SATA disks of 1TB each would be enough for us.  We planned that everything will be with deduplication, but it did not.  If they knew beforehand, they would save money.  The disk monitor is convenient there, you can immediately see from it how many operations a disk has.  The SSD in the cache should be server class, it has a constant serious load on both reading and writing. <br><br>  And how do you operate Nexent under load with volumes of tens of TB?  Without load, everything is beautiful. </div><p>Source: <a href="https://habr.com/ru/post/179151/">https://habr.com/ru/post/179151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../179135/index.html">India launches tracking system for all calls, SMS and Internet activity</a></li>
<li><a href="../179141/index.html">Why is the work not an apartment?</a></li>
<li><a href="../179143/index.html">Away Builder. Or our proud Varyag does not surrender to the enemy.</a></li>
<li><a href="../179145/index.html">Boris is a small but reliable REPL for php</a></li>
<li><a href="../179149/index.html">MikroTik - quick setup of the access point</a></li>
<li><a href="../179153/index.html">Features of c ++ tuples implementation</a></li>
<li><a href="../179155/index.html">A little more about migrations. PHP version</a></li>
<li><a href="../179159/index.html">xdebug in the hands of the administrator</a></li>
<li><a href="../179161/index.html">Diablo III's economy has been destroyed by integer overflow</a></li>
<li><a href="../179163/index.html">DevConf contest - dedicated to the Victory Day!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>