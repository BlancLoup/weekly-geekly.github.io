<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Modern CMake: 10 tips for improving build scripts</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CMake is a build system for C / C ++, which is becoming more popular every year. It almost became the default solution for new projects. However, many...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Modern CMake: 10 tips for improving build scripts</h1><div class="post__text post__text-html js-mediator-article"><p>  CMake is a build system for C / C ++, which is becoming more popular every year.  It almost became the default solution for new projects.  However, many examples of performing a CMake task contain archaic, unreliable, bloated actions.  We will find out how to write build scripts on CMake more concisely. </p><a name="habracut"></a><br><blockquote>  If you want to try out the tips in action, take an example on github and examine it as you read the article: <a href="https://github.com/sergey-shambir/modern-cmake-sample">https://github.com/sergey-shambir/modern-cmake-sample</a> </blockquote><br><h2 id="sovet-1-ukazyvayte-vysokuyu-minimalnuyu-versiyu-cmake">  Tip # 1: Specify a high minimum version of CMake </h2><br><p>  The advice does not apply to those who write public libraries, because compatibility with the old development environment is important to them.  And if you are writing a project with a closed code or a highly specialized open source software, then you can ask all developers to install the latest version of CMake.  Without this, many article tips will not work!  At the time of this writing, we have CMake 3.8. </p><br><pre><code class="bash hljs">cmake_minimum_required(VERSION 3.8 FATAL_ERROR)</code> </pre> <br><h2 id="sovet-2-ne-vyzyvayte-ni-make-ni-make-install">  Advice ‚Ññ2: do not call neither make, nor make install </h2><br><p>  Modern CMake can call the build system itself.  <a href="https://cmake.org/cmake/help/latest/manual/cmake.1.html">In CMake,</a> this is called the Build Tool Mode. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    myproj  myproj-build mkdir ../myproj-build &amp;&amp; cd ../myproj-build #       ../myproj cmake -DCMAKE_BUILD_TYPE=Release ../myproj #      cmake --build . #  ,   '-j4'   . cmake --build . -- -j4</span></span></code> </pre> <br><p>  If you generate a Visual Studio project, you can also build it from the command line, including building a specific project in a specific configuration: </p><br><pre> <code class="bash hljs">cmake --build . \ --target myapp \ --config Release \ --clean-first</code> </pre> <br><blockquote>  On Linux, do not use make install, otherwise you will clog your system.  There is a separate article about this. <a href="https://habrahabr.ru/post/130868/">I want to take and shoot, or an educational program about why you should not use make install</a> </blockquote><br><h2 id="sovet-3-ispolzuyte-neskolko-cmakeliststxt">  Tip number 3: use several CMakeLists.txt </h2><br><p>  CMakeLists.txt nesting is normal.  If your project is divided into 3 libraries, 3 test suites and 2 applications, then why not add <code>CMakeLists.txt</code> for each of them?  Then you need to create another central <code>CMakeLists.txt</code> , and execute <a href="https://cmake.org/cmake/help/latest/command/add_subdirectory.html">add_subdirectory</a> in it.  So the central CMakeLists might look like: </p><br><pre> <code class="bash hljs">cmake_minimum_required(VERSION 3.8 FATAL_ERROR) project(opengl-samples) <span class="hljs-comment"><span class="hljs-comment"># :    CMakeLists  #    ,   add_subdirectory include(scripts/functions.cmake) add_subdirectory(libs/libmath) add_subdirectory(libs/libplatform) add_subdirectory(libs/libshade) #  enable_testing    BUILD_TESTING, #   BUILD_TESTING=ON. #  `cmake -DBUILD_TESTING=OFF projectdir`   , #     . enable_testing() if(BUILD_TESTING) add_subdirectory(tests) endif() # .. ..</span></span></code> </pre> <br><h2 id="sovet-4-ne-zasoryayte-globalnuyu-oblast-vidimosti">  Advice ‚Ññ4: do not litter the global scope </h2><br><p>  Do not start global variables unless absolutely necessary.  Do not use <code>link_directories()</code> , <code>include_directories()</code> , <code>add_definitions()</code> , <code>add_compile_options()</code> and other similar instructions. </p><br><ul><li>  Use <a href="https://cmake.org/cmake/help/latest/command/target_link_libraries.html">target_link_libraries</a> to add static and dynamic internal and external libraries that target depends on. </li><li>  Use <a href="https://cmake.org/cmake/help/latest/command/target_include_directories.html">target_include_directories</a> instead of include_directories to add search paths for headers that target depends on. </li><li>  Use <a href="https://cmake.org/cmake/help/latest/command/target_compile_definitions.html">target_compile_definitions</a> instead of add_definitions to add macros with which the target is going </li><li>  Use <a href="https://cmake.org/cmake/help/latest/command/target_compile_options.html">target_compile_options</a> to add specific compiler flags with which the target is going </li></ul><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  - add_library(mylibrary \ ColorDialog.h ColorDialog.cpp \ ColorPanel.h ColorPanel.cpp) # !  -   ! #       /usr/include/wx-3.0 #   find_package     . target_include_directories(mylibrary /usr/include/wx-3.0)</span></span></code> </pre> <br><blockquote>  It is worth noting that <code>target_link_libraries</code> can add library header search paths if the library is in your project and header search paths have been attached to it through the <code>target_include_directories(libfoo PUBLIC ...)</code> construct. </blockquote><p>  There is an example of a dependency diagram taken from the <a href="https://docs.google.com/presentation/d/18fY0zDtJCMUW5WdY2ZOfKtvb7lXEbBPFe_I6MNJC0Qw">Modern CMake / an Introduction</a> presentation for Tobias Becker: </p><br><p><img src="https://habrastorage.org/web/e75/f27/3e0/e75f273e01f24136b52ff164d138aafe.png" alt="Scheme"></p><br><h2 id="sovet-5-vklyuchite-nakonec-c17-ili-c14">  Tip # 5: finally turn on C ++ 17 or C ++ 14! </h2><br><p>  In recent years, the C ++ standard has been updated frequently: we have received tremendous changes in C ++ 11, C ++ 14, C ++ 17.  Try to abandon older compilers whenever possible.  For example, for Linux, nothing prevents you from installing the latest version of Clang and libc ++ and starting to build all projects with a static C ++ runtime layout. </p><br><p>  The best way to enable C ++ 17 without playing with compilation flags is to tell CMake that you need it. </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  :     cxx_std_17 target_compile_features(${TARGET} PUBLIC cxx_std_17) #  :     set_target_properties(${TARGET} PROPERTIES CXX_STANDARD 17 CXX_STANDARD_REQUIRED YES CXX_EXTENSIONS NO )</span></span></code> </pre> <br><p>  With the help <code>target_compile_features</code> you can demand not C ++ 17 or C ++ 14, but certain features from the compiler.  A complete list of well-known CMake compiler features can be <a href="https://cmake.org/cmake/help/latest/prop_gbl/CMAKE_CXX_KNOWN_FEATURES.html">found in the documentation</a> . </p><br><h2 id="sovet-6-ispolzuyte-funkcii">  Tip # 6: Use Functions </h2><br><p>  In CMake, you can declare your own functional macros and your own functions.  There is only one difference between them: the variables set inside the function are local. </p><br><p>  It is convenient to write functions to solve current problems of customization of the assembly, or to simplify the addition of a set of assembly goals.  The example below was written for more correct inclusion of C ++ 17 due to the fact that </p><br><ul><li>  CMake 3.8 does not yet know how to pass the <code>/std:c++latest</code> flag to Visual Studio to enable C ++ 17 </li><li>  when using <code>std::experimental::filesystem</code> in Clang / libc ++, you need to indicate to the linker that you need to link the project with <code>libc++experimental.a</code> , because <code>libc++.a</code> does not have the filesystem module yet;  also need to link with pthread, since the implementation of thread / mutex, etc.  based on pthread </li></ul><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    CMake     C++17   . #    . function(custom_enable_cxx17 TARGET) #  C++17 ,  CMake . target_compile_features(${TARGET} PUBLIC cxx_std_17) #   C++latest  Visual Studio if (CMAKE_CXX_COMPILER_ID STREQUAL "MSVC") set_target_properties(${TARGET} PROPERTIES COMPILE_FLAGS "/std:c++latest") #    libc++, libc++experimental  pthread  Clang elseif (CMAKE_CXX_COMPILER_ID MATCHES "Clang") set_target_properties(${TARGET} PROPERTIES COMPILE_FLAGS "-stdlib=libc++ -pthread") target_link_libraries(${TARGET} c++experimental pthread) endif() endfunction(custom_enable_cxx17)</span></span></code> </pre> <br><p>  Each function is essentially a hack created to redefine CMake or its behavior.  For other developers, the meaning of this hack is unclear.  Therefore, try to add a comment to each instruction in the function explaining its purpose and meaning. </p><br><blockquote>  In large open source projects, such as KDE, the use of its functions can be a bad taste.  You may consider other options: write the build script explicitly according to the principle "Explicit is better then implicit", or even suggest adding your function to the upstream of the CMake project. </blockquote><br><h2 id="sovet-7-spornyy-ne-perechislyayte-ishodnye-fayly-po-odnomu">  Tip number 7 (controversial): do not list the source files one by one </h2><br><p>  My colleague is developing a small 3D rendering engine for rendering scenes with models and animations via OpenGL, GLES, DirectX and Vulkan.  Once we discussed this project with him, and it turned out that he uses Visual Studio to build for all platforms (Windows, Linux, Android)!  He is unhappy that Microsoft rarely updates the Android NDK, but does not want to refuse to build via MSBuild for one simple reason. </p><br><p>  He does not want to accompany the list of files for assembly in two assembly systems. </p><br><p>  Once I was porting a game from iOS to Android, and we supported two build systems using a script that read the XCode project and automatically added to the list of files in <code>Android.mk</code> .  If you use CMake, then you do not even need to write a script. </p><br><p>  CMake has the <code>aux_source_directory</code> function, but it has a flaw: headers are not added to the list and do not appear in any generated project for the IDE. </p><br><ul><li>  <code>file(GLOB ...)</code> comes to the rescue, scanning files by mask </li><li>  In order not to litter the global scope with new variables, create the function <code>custom_add_executable_from_dir(name)</code> </li><li>  so that the function placed in a separate file uses the path to the current CMakeLists.txt as a starting point, we will use the variable <code>CMAKE_CURRENT_SOURCE_DIR</code> </li></ul><br><pre> <code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(custom_add_executable_from_dir TARGET) <span class="hljs-comment"><span class="hljs-comment">#      file(GLOB TARGET_SRC "CMAKE_CURRENT_SOURCE_DIR/*.cpp" #    add_executable(${TARGET} ${TARGET_SRC}) endfunction()</span></span></code> </pre> <br><p>  You can add the function <code>custom_add_library_from_dir</code> for library purposes in the same way. </p><br><p>  If you are a fan of manual work or create a public library, then maybe you should add files one by one.  In this case, use <code>target_sources</code> to add platform-specific files: </p><br><pre> <code class="hljs lisp">add_library(<span class="hljs-name"><span class="hljs-name">libfoo</span></span> Foo.h Foo_common.cpp) if(<span class="hljs-name"><span class="hljs-name">WIN32</span></span>) target_sources(<span class="hljs-name"><span class="hljs-name">libfoo</span></span> Foo_win32.cpp) endif(<span class="hljs-name"><span class="hljs-name">WIN32</span></span>)</code> </pre> <br><h2 id="sovet-8-ne-zapuskayte-utility-bash-zapuskayte-cmake--e">  Tip # 8: Don't run bash utilities, run cmake -E </h2><br><p>  Surely, for the sake of automation, you wanted to call the Bash command from cmake to create a directory, unpack the archive or calculate the md5 amount.  But invoking command line utilities can deprive the project of cross-platform.  A more portable method is to invoke the <code>cmake -E </code> using the <a href="https://cmake.org/cmake/help/latest/manual/cmake.1.html">Command-Line Tool Mode</a> . </p><br><h2 id="sovet-9-ostavlyayte-bolshe-gibkosti-polzovatelyam-svoih-bibliotek">  Tip # 9: Leave more flexibility to users of your libraries. </h2><br><p>  Advice applies to you if you are writing publicly available libraries.  In this case, you should simplify the following scenarios: </p><br><ul><li>  the programmer wants to add your library as a submodule and enable your <code>CMakeLists.txt</code> via <code>add_subdirectory</code> </li><li>  the programmer wants to customize the build of your library;  the most popular ones are completely static or dynamic layout, build with tests and examples, or just libraries </li></ul><br><p>  When adding a library, create another unique synonym: </p><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta">#  - add_library(foo ${FOO_SRC}) #  ,      add_library(MyOrg::foo ALIAS foo)</span></span></code> </pre> <br><p>  Leave library users the right to use the <code>BUILD_SHARED_LIBS</code> option to choose between <code>BUILD_SHARED_LIBS</code> static and dynamic library versions. </p><br><p>  When setting up the layout, search headers and compilation flags for libraries, use the keywords PUBLIC, PRIVATE, INTERFACE to allow goals, depending on your library, to inherit the necessary settings: </p><br><ul><li>  PUBLIC means that a library-dependent project also needs these options. </li><li>  PRIVATE means that options are needed only to build the library. </li><li>  INTERFACE means that options are not needed for the build, but are needed to use the library. </li></ul><br><pre> <code class="hljs lisp">target_link_libraries(<span class="hljs-name"><span class="hljs-name">foobarapp</span></span> PUBLIC MyOrg:<span class="hljs-symbol"><span class="hljs-symbol">:libfoo</span></span> PRIVATE MyOrg:<span class="hljs-symbol"><span class="hljs-symbol">:libbar</span></span> )</code> </pre> <br><h2 id="sovet-10-registriruyte-avtotesty-v-ctest">  Tip number 10: register autotests in CTest </h2><br><p>  The CTest subsystem does not force you to use any special libraries for testing instead of the usual Boost.Test, Catch or Google Tests.  It only registers autotests so that CMake can run all tests or selected tests with one <code>ctest</code> command. </p><br><p>  To enable CTest support throughout the project, there is an <code>enable_testing</code> instruction </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  enable_testing    BUILD_TESTING, #   BUILD_TESTING=ON. #  `cmake -DBUILD_TESTING=OFF projectdir`   , #     . enable_testing() if(BUILD_TESTING) add_subdirectory(tests/libhellotest) add_subdirectory(tests/libgoodbyetest) endif()</span></span></code> </pre> <br><p>  For the executable file with the test to be registered in CTest, you need to call the instruction <code>add_test</code> . </p><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    -      add_executable(${TARGET} ${TARGET_SRC}) #     CMake   . #     ,       . add_test(${TARGET} ${TARGET})</span></span></code> </pre> <br><h2 id="chto-eschyo-pochitat">  What else to read? </h2><br><p>  If you set up CMake and CTest for your OpenSource project, then you can connect continuous integration: <a href="https://habrahabr.ru/post/329264/">Continuous Integration (CI) for GitHub C / C ++ projects with CMake build</a> </p><br><p>  Before creating the article, several English-language sources were read, tried and rethought: </p><br><ul><li>  Presentation <a href="https://docs.google.com/presentation/d/18fY0zDtJCMUW5WdY2ZOfKtvb7lXEbBPFe_I6MNJC0Qw/edit">Modern CMake / an Introduction</a> from one of the C ++ and OpenSource conferences </li><li>  <a href="https://www.slideshare.net/DanielPfeifer1/cmake-48475415">CMake - Introduction and best practices</a> from one of the C ++ meeting in Munich </li><li>  Post <a href="https://schneide.wordpress.com/2016/04/08/modern-cmake-with-target_link_libraries/">Modern CMake with target_link_libraries</a> </li><li>  post <a href="https://crascit.com/2015/03/28/enabling-cxx11-in-cmake/">Enabling C ++ 11 And Later In CMake</a> </li></ul><br><p>  Some tips from these sources are not reflected in the article.  Therefore, after reading them, you will definitely become deeper into CMake. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/330902/">https://habr.com/ru/post/330902/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330890/index.html">GeekUniversity opens a set of students at the Faculty of Java-development</a></li>
<li><a href="../330892/index.html">Potentially dangerous algorithms</a></li>
<li><a href="../330894/index.html">[Translation of the article] The best IT conferences for participation in June - August 2017</a></li>
<li><a href="../330898/index.html">Service statistics collection with Flussonic</a></li>
<li><a href="../330900/index.html">Two years with Dart: how we write in a language that is ‚Äúburied‚Äù every year (part 2)</a></li>
<li><a href="../330904/index.html">Speakers #ITsubbotnik - how technology will change the world in five years</a></li>
<li><a href="../330906/index.html">Daniel Story Comics</a></li>
<li><a href="../330910/index.html">Russian Minesweeper - multiplayer version of the game "Sapper"</a></li>
<li><a href="../330914/index.html">Entertainment for intellectuals: playing ‚ÄúWhat? Where? It depends?</a></li>
<li><a href="../330916/index.html">Cloud Expo Asia Hong Kong - report from the largest IT exhibition in Asia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>