<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CISCO ACE. Part 2: balancing remote servers and applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of CISCO ACE - application balancing, we plunged into the world of application balancing and network resources. We got acquainted wi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CISCO ACE. Part 2: balancing remote servers and applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/fe6/3e3/3f5/fe63e33f5d273cb989b46155681839d3.jpg"><br><br>  In the first part of <a href="http://habrahabr.ru/post/143564/">CISCO ACE - application balancing,</a> we plunged into the world of application balancing and network resources.  We got acquainted with the characteristics, purpose and capabilities of the family of such devices.  We considered the main implementation scenarios and the advantages that the use of balancers brings to us. <br><br>  Probably many people caught themselves thinking that it was very expensive and did not see the benefits that the industrial balancer could provide to them.  In the post I will pay attention to this particular moment and try to show that the service can be used by the majority. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  In the first part, we looked at the case of balancing applications (balancing between servers) that are directly in the same data center.  You can even say - in one L2 domain.  Suppose that you are interested in the described benefits and want to get this service.  In most public data centers, such equipment is not available, since the user needs to provide a server for 50-100 dollars per month.  No one will let you into your corporate data center (not only the moment of physical location, but also the existing information security policy is taken into account). <br><br>  The reasons given are not the same.  If your project grows, then a good option is to place an additional server in another data center to increase service availability.  And in the case of the increasing popularity of information raiding, the option is even necessary.  Is this service for you?  Yes, you can also use the existing functionality. <br><br>  So, let us dwell on the fact that CISCO ACE (or any other decent balancer) is able to distribute the load not only between directly connected servers, but also between remote resources.  This mode is called Routed One-Arm-Mode (or On-a-Stick). <br><br>  The architecture of this mode is nothing special, just instead of Destination NAT (for farm hosts), the balancer produces additional Source NAT.  Well, all other functions have not been canceled.  I propose to consider an example demonstrating the possibilities. <br><br><img src="https://habrastorage.org/storage2/785/388/1b9/7853881b949220c2fac41aec79a777fb.jpg"><br><br>  In this case, all your traffic is sent to a virtual address (VIP).  This address is assigned to the balancer.  Processing requests, it redirects them to remote servers.  All servers belong to the same structural group - the server farm.  We will make a small adjustment.  In many ways, it will repeat the structure discussed in the first article. <br><br>  <b>1. Create a server</b> <br>  In our case there are three servers, with the addresses specified in the topology: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span></code> </pre> <code>rserver host SERVER-1 description SERVER-1 ip address 1.1.1.1 inservice <br> rserver host SERVER-2 description SERVER-2 ip address 2.2.2.2 inservice <br> rserver host SERVER-3 description SERVER-3 ip address 3.3.3.3 inservice</code> <pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span></code> </pre> <code>rserver host SERVER-1 description SERVER-1 ip address 1.1.1.1 inservice <br> rserver host SERVER-2 description SERVER-2 ip address 2.2.2.2 inservice <br> rserver host SERVER-3 description SERVER-3 ip address 3.3.3.3 inservice</code> <pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 1<span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 2<span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.2</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rserver</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">description</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">SERVER-3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 3<span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.3</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">inservice</span></span></code> </pre> <br><br>  <b>2. We describe the rules for determining the availability of services (let there be a WEB server)</b> <br><br><pre> <code class="hljs pgsql">probe http HTTP_PROBE <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> passdetect <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> passdetect count <span class="hljs-number"><span class="hljs-number">2</span></span> request <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> head url /<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html expect status <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">210</span></span> <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> "LoadBalance" <br> probe icmp ICMP_PROBE <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> passdetect <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> passdetect count <span class="hljs-number"><span class="hljs-number">4</span></span> receive <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <code>probe http HTTP_PROBE interval 5 passdetect interval 10 passdetect count 2 request method head url /index.html expect status 200 210 header User-Agent header-value "LoadBalance" <br> probe icmp ICMP_PROBE interval 10 passdetect interval 60 passdetect count 4 receive 1</code> <pre> <code class="hljs pgsql">probe http HTTP_PROBE <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> passdetect <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> passdetect count <span class="hljs-number"><span class="hljs-number">2</span></span> request <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> head url /<span class="hljs-keyword"><span class="hljs-keyword">index</span></span>.html expect status <span class="hljs-number"><span class="hljs-number">200</span></span> <span class="hljs-number"><span class="hljs-number">210</span></span> <span class="hljs-keyword"><span class="hljs-keyword">header</span></span> <span class="hljs-keyword"><span class="hljs-keyword">User</span></span>-Agent <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> "LoadBalance" <br> probe icmp ICMP_PROBE <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> passdetect <span class="hljs-type"><span class="hljs-type">interval</span></span> <span class="hljs-number"><span class="hljs-number">60</span></span> passdetect count <span class="hljs-number"><span class="hljs-number">4</span></span> receive <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><br>  What parameters and for what are intended - described in the <a href="http://habrahabr.ru/post/143564/">first article</a> . <br><br>  <b>3. Unite the device in the farm</b> <br><br><pre> <code class="hljs pgsql">serverfarm host FARM probe HTTP_PROBE probe ICMP_PROBE rserver <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span><span class="hljs-number"><span class="hljs-number">-1</span></span> inservice rserver <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span><span class="hljs-number"><span class="hljs-number">-2</span></span> inservice rserver <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span><span class="hljs-number"><span class="hljs-number">-3</span></span> inservice</code> </pre> <br><br>  <b>4. Create a virtual address and describe the balancing policy</b> <br>  Since the servers will receive requests directly from the balancer, the customer addresses for them will remain a mystery.  You guessed what to do, add the X-Forwarded-For header. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span>-map match-<span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>-VIP <span class="hljs-number"><span class="hljs-number">2</span></span> match virtual-address <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <br> <br> <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>-map <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> loadbalance first-match LB-<span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> serverfarm FARM <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>-http X-Forwarded-<span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> "%is"</code> </pre> <code>class-map match-all SERVER-VIP 2 match virtual-address 10.10.10.5 any <br> <br> policy-map type loadbalance first-match LB-POLICY class class-default serverfarm FARM insert-http X-Forwarded-For header-value "%is"</code> <pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span>-map match-<span class="hljs-keyword"><span class="hljs-keyword">all</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>-VIP <span class="hljs-number"><span class="hljs-number">2</span></span> match virtual-address <span class="hljs-number"><span class="hljs-number">10.10</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">any</span></span> <br> <br> <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>-map <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> loadbalance first-match LB-<span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> serverfarm FARM <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span>-http X-Forwarded-<span class="hljs-keyword"><span class="hljs-keyword">For</span></span> <span class="hljs-keyword"><span class="hljs-keyword">header</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">value</span></span> "%is"</code> </pre> <br><br>  Here we have indicated that we will balance in the farm FARM. <br><br>  <b>5. Create a policy for the interface that will receive incoming traffic.</b> <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">policy</span></span>-map multi-match FARM-<span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SERVER</span></span>-VIP loadbalance vip inservice loadbalance <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> LB-<span class="hljs-keyword"><span class="hljs-keyword">POLICY</span></span> loadbalance vip icmp-reply nat dynamic <span class="hljs-number"><span class="hljs-number">10</span></span> vlan <span class="hljs-number"><span class="hljs-number">100</span></span></code> </pre> <br><br>  Pay attention to the last line of the policy.  It tells the balancer how to translate the sender‚Äôs address, that is, its own address. <br><br>  Well, the interface configuration itself.  Let it be Interface Vlan 100. <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">interface</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">vlan</span></span> 100 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">address</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">service-policy</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">input</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">FARM-POLICY</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">nat-pool</span></span> 10 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.11</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">netmask</span></span> 255<span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.255</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">no</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">shutdown</span></span> <br> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ip</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">route</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 0<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.10</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> <code>interface vlan 100 ip address 10.10.10.10 255.255.255.0 service-policy input FARM-POLICY nat-pool 10 10.10.10.11 10.10.10.11 netmask 255.255.255.255 pat no shutdown <br> ip route 0.0.0.0 0.0.0.0 10.10.10.1</code> <br> <br>  <b>6. What we get as a result?</b> <br>  6.1.  DNS record: domain.org IN A 10.10.10.5. <br>  6.2.  Clients send requests to the balancer. <br>  6.3.  The balancer distributes requests between active servers, changing the destination address to the real server address, and the source address to the one specified in the configuration (10.10.10.11). <br>  6.4.  Servers receive all requests from 10.10.10.11, but have the header X-Forwarded-For.  Server answer balancer. <br>  6.5.  The balancer returns the received answers to customers of the resource. <br><br>  On the client side, you must provide a list of server addresses and make changes to the DNS.  Naturally, the number of functioning servers may increase or decrease.  In general, the functional does not suffer. <br><br><h1>  This functionality has one interesting feature that can be used favorably. </h1><br><br>  We considered the case when ACE has one interface.  Let's look at the option with two interfaces.  Moreover, with one interface it is connected to one provider, the second to another.  Or you have your own AS, a couple of prefixes, connection to two providers (you will understand why there are so many conditions) and you can make so that the traffic in one subnet comes through one provider, the second through the other.  (Some interesting aspects of BGP traffic control are discussed in <a href="http://habrahabr.ru/post/144059/">BGP: some features of traffic behavior</a> ). <br><br><img src="https://habrastorage.org/storage2/998/4b4/b3d/9984b4b3d9be3f66da92f65a1d36d9f2.jpg"><br><br>  Let's take a look at what happens in this situation. <br><br>  1. Clients access the virtual address (thanks to a DNS entry). <br>  2. Traffic passes through the provider ‚Ññ1 and loads its channel. <br>  3. On the way from provider # 1 to the balancer, we can ‚Äúclear‚Äù the traffic.  Thanks to the behavioral and signature analysis, cut off DDoS and all kinds of scanning / invasion. <br>  4. The balancer forwards requests to servers using provider # 2.  His channel (ISP-2) remains unloaded by DDoS. <br>  5. The server processes only legitimate requests and sends the answers to the balancer, and returns them to clients. <br><br>  Naturally, the scheme provides for the availability of DDoS protection equipment (Arbor Peakflow, CISCO Detector / Guard).  Also, good IPS does not hurt. <br><br>  Such a protection against DDoS on-demand.  If necessary, or on an ongoing basis, the client only needs to make changes in the DNS. <br><br>  To implement the scheme, it is necessary to make small additional settings of the balancer.  In the event of an attack, the channel with the provider ‚Ññ1 is exposed to loading.  The channel with the provider number 2 remains "clean."  Subtleties and features of traffic control is a separate topic, the idea was to demonstrate how this can be implemented. <br><br>  Successes! </div><p>Source: <a href="https://habr.com/ru/post/144417/">https://habr.com/ru/post/144417/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../144410/index.html">What old games do you think are old school?</a></li>
<li><a href="../144411/index.html">QScintilla: highlight syntax in application</a></li>
<li><a href="../144412/index.html">Test Driven Design - the first implementation experience</a></li>
<li><a href="../144414/index.html">OutWiker. Open Source program for storing notes</a></li>
<li><a href="../144416/index.html">Argparse - Parsing arguments and command line parameters with ease</a></li>
<li><a href="../144418/index.html">Data exchange between a web application and MantisBT</a></li>
<li><a href="../144419/index.html">Python binding for libsass. Exclusively for Habr</a></li>
<li><a href="../144420/index.html">Take Python with you</a></li>
<li><a href="../144421/index.html">Since when do you manage to enter the habr-captcha?</a></li>
<li><a href="../144422/index.html">Court decision: Google does not violate Oracle patents</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>