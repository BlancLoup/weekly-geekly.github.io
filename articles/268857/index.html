<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I monitored Avito by SMS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As is known, goods of very good quality periodically appear at Avito and at the same time are very cheap. But they rarely appear, hang there a little ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I monitored Avito by SMS</h1><div class="post__text post__text-html js-mediator-article">  As is known, goods of very good quality periodically appear at Avito and at the same time are very cheap.  But they rarely appear, hang there a little and disappear quickly. <br><br>  Therefore, I had an idea: isn‚Äôt it possible to search for a service that checks ads every few minutes, and if there is something interesting for me, notifies about it?  In this case, it is best to notify via SMS, and then I do not always check the mail promptly. <br><br>  Google provided several such services, "only" from 3 rubles per SMS or from 4 rubles per day. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the end, I decided to write such a service myself, but more on that later ... <br><a name="habracut"></a><br>  For interest, I registered on one of the services.  Yesterday, he checked links every 15 minutes, and if anything changed, he sent notifications to the post office.  About SMS on their website it was casually mentioned that mail mail.ru is able to send text messages.  In fact, it turned out that mail.ru can only send to a megaphone, and I don‚Äôt even have it at all ... And if you need to beeline-mts, then please, the service will help you with pleasure, for a separate coin. <br><br>  I also note that I have been a user of a very convenient and free service <a href="http://habrahabr.ru/post/147583/">for a long time</a> , <a href="http://habrahabr.ru/post/147583/">about which they wrote a long time ago on Habr√©</a> , and which allows you to send an email with a specific topic to a specific box, and the content of the letter will come to me in the form of SMS.  I wanted to specify my_box@sms.ru for service letters, but did not understand how to change the subject of the letter, without which you will not receive SMS. <br><br>  In addition, today the demo period of the Glyce is over, and the frequency of checking is 720 minutes. <br><br>  In general, having thought that to pay for, I apologize, the ‚Äúservice‚Äù of such a level is the same as paying the air for <s>Windows</s> , I decided that it was easiest to spend 3 hours of my valuable time and build such a service myself, since the parsing of the Avito page is trivial and , as follows, I took exactly 1 line of code. <br><br>  I used VPS hosting for this script.  WEB-hosting is also suitable, subject to the presence of a pearl on it, access to the "outside" and the scheduler.  In extreme cases, any computer included in the Internet will work.  I think many have something like that. <br><br><h3>  What is the script written on? </h3><br>  I decided to write it on a pearl, and although I know a pearl rather mediocre, for scripts of this kind it fits best.  There, where it was laziness to deal with the pearl, I didn‚Äôt really strain, I called the shell commands through the system.  Nevertheless, it turned out, in my opinion, quite decently and even not ashamed to show my creation to the public. <br><br><h3>  The logic of the work, briefly </h3><br>  - Run the script every xxx minutes; <br>  - Download the page using wget; <br>  - We store the page downloaded last time, comparing it with the newly downloaded one, if some ads have changed / new ones appeared - send an SMS about it. <br><br>  Infa taken out of ads is: <br><br>  1. ad URL (which I use as a unique ad identifier); <br>  2. Name; <br>  3. Price. <br><br>  At the same time, it is foreseen: if a failure occurs at one of the downloads of the page, the old list will remain, and the page will simply be downloaded the next time, then SMS will be sent about the changes, if they occurred. <br><br><h3>  More details </h3><br>  Before use, check the paths and names for mailer and wget, make sure you have them and work.  In particular, in my centos mailer is called mutt, mail or sendmail is more common with the same syntax.  Maybe you need to replace wget with / usr / local / bin / wget, etc. <br><br>  You should also set your mailbox and the phone to which you want to receive notifications. <br><br>  Run the script with the command: ./avito.pl url_pages_with_advertisements. <br><br>  I note that the URL of the page should be in the form of a "list with a photo."  In other words, there should not be any &amp; view = list or &amp; view = gallery in urla. <br><br>  Example url: <a href="https://www.avito.ru/moskva%3Fq%3D%25D1%2580%25D0%25B5%25D0%25B7%25D0%25B8%25D0%25BD%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9%2B%25D1%2581%25D0%25BB%25D0%25BE%25D0%25BD">www.avito.ru/moskva?q=%D1%80%D0%B5%D0%B7%D0%B8%D0%BD%D0%BE%D0%B2%D1%8B%D0%B9+% D1% 81% D0% BB% D0% BE% D0% BD</a> <br><br>  The page is downloaded to a file with the name obtained from the URL, with the replacement of all left characters with underscores, like this: <br><br>  https ___ www.avito.ru_moskva_q__D1_80_D0_B5_D0_B7_D0_B8_D0_BD_D0_BE_D0_B2_D1_8B_D0_B9__D1_81_D0_BB_D0_BE_D0_BD <br><br>  It should be unique, supported in Linux and in Windows and at the same time be sufficiently readable. <br><br>  If there is already such a file, the script tries to pull ads out of it.  If no ads are found in the file, the script calls wget, while overwriting the file.  If ads are found, the file is saved with a -1 suffix: <br><br>  https___ www.avito.ru_moskva_q__D1_80_D0_B5_D0_B7_D0_B8_D0_BD_D0_BE_D0_B2_D1_8B_D0_B9__D1_81_D0_BB_D0_BE_D0_BD-1 <br><br>  Next, the page is downloaded again, it checks the following situations: <br><br>  1. If the ads in the new downloaded page are not found, the script simply ends - the old page remains with the suffix -1.  This is in case, if suddenly the network disappeared or hung up - the previous list of ads will not be lost. <br>  2. If the script is launched for the first time (the previously downloaded page was not found), then the info will come simply about the number of available ads: <br><blockquote>  Found 25 items, page <a href="https://www.avito.ru/moskva%3Fq%3D%25D1%2580%25D0%25B5%25D0%25B7%25D0%25B8%25D0%25BD%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9%2B%25D1%2581%25D0%25BB%25D0%25BE%25D0%25BD">www.avito.ru/moskva?q=%D1%80%D0%B5%D0%B7%D0%B8%D0%BD%D0%BE%D0%B2%D1%8B%D0% B9 +% D1% 81% D0% BB% D0% BE% D0% BD</a> monitoring started </blockquote><br>  If this message has arrived, then the system has started, it is mainly a check that everything worked. <br><br>  Since SMS should be shorter, the better, all messages are very concise. <br><br>  3. If there is a new announcement, then info about this will be added to the text of the future SMS.  Then for all ads info will come in the form of one SMS. <br>  4. If the price or the name of the product has changed, then infa will come in the form: old price -&gt; new price: name link.  Or new link name. <br><br>  I don‚Äôt know if the name can change, but it was not a pity to make an extra check. <br><br>  5. The console displays a separate text list of what was found.  This is done more for debugging, because today the parser is working, and tomorrow, when they change the markup, it will stop.  Will have to change the parsing. <br><br><h3>  About parsing and nuances </h3><br>  Actually, the whole parsing is in this line: <br><br><pre><code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($text=~<span class="hljs-regexp"><span class="hljs-regexp">/&lt;div class=\"description\"&gt; &lt;h3 class=\"title\"&gt; &lt;a href=\"(.*?)\".*?&gt;\n(.*?)\n.*?&lt;div class=\"about\"&gt;\n\s*(\S*)/gs</span></span>)</code> </pre> <br>  Although, the price also contains a space in the form of nbsp, which I cut out with another regexp: <br><br><pre> <code class="perl hljs">$price=~<span class="hljs-regexp"><span class="hljs-regexp">s/&amp;nbsp;//g</span></span></code> </pre><br>  So parsing, formally speaking, is still not in one, but in two lines. <br><br>  g is a global search modifier that allows you to thrust a search inside the while condition, each time issuing the next declaration; <br>  s - allows you to search in several lines within one regexp (on Avito, the URL, name and price are located on 4 lines, but this is now, until they have changed the layout). <br><br>  Also note that for a multiline file reading at the beginning of the script is assigned: <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">undef</span></span> $/;</code> </pre><br>  This is for my $ text =;  I read the entire file in myself. <br><br>  Another caveat: I insert clickable URLs into all sms.  I have a normal smartphone, which allows you to poke the url inside the sms and get to the right page is very convenient.  So, for some reason, sms.ru spoils such an innocent character as underscore.  Replacing it with% C2% A7.  I can‚Äôt affect it, but I can replace it with an underscore code, which is normal, while the URL becomes clickable for sms.ru, remaining the same for regular mail: $ text = ~ s / _ /% 5F / g; <br><br><h3>  Add a task to the scheduler </h3><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#crontab -e */20 * * * * cd /scripts/avito &amp;&amp; ./avito.pl 'https://www.avito.ru/moskva?q=%D1%80%D0%B5%D0%B7%D0%B8%D0%BD%D0%BE%D0%B2%D1%8B%D0%B9+%D1%81%D0%BB%D0%BE%D0%BD'</span></span></code> </pre><br>  Every 20 minutes, call the script, checking the page.  Do not forget to screen URL with single quotes. <br><br>  Such tasks can be set as many as you want, they will all work independently of each other. <br><br><h3>  What I have not done for the industrial version and that it would be easy to finish </h3><br>  1. Web muzzle to add / remove users and tasks.  Storage of urls, periodicity, mailbox and telephone of users on sms.ru in the mysql database.  The script would be called every minute, check what url to run and send SMS not to my hard-coded number, but to the one specified by the user. <br><br>  Then it would be possible to rip off users for 8 rubles a day or something like that.  Maybe do?  Do you want to pay for such a thing? <br><br>  2. Filter prices.  Ignore the price above or below the set.  It becomes elementary, with another <code>if: next if($page_new{"price"}{$uri}&gt;$max_price or $page_new{"price"}{$uri}&lt;$min_price)</code> .  Just did not have to. <br><br>  3. By analogy with Avito, add Automotive News, irr, etc.  sites. <br><br>  It‚Äôs also elementary, just behind that <code>while(...){...}</code> add a few more <code>while</code> - to each site one by one.  The main thing is that inside them fill <code>$page{"name"}{$uri}  $page{"price"}{$uri}</code> . <br><br>  For each site, your <code>while</code> will work, the rest just return an empty result. <br><br><h3>  Well, actually the script code </h3><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; undef $/; my $url=$ARGV[0]; my $mailer="mutt"; my $wget="wget"; if($url eq ""){ print "Usage: avito.pl &lt;https://www.avito.ru/...url&gt;"; exit; } my $filename=$url; $filename=~s#[^A-Za-z0-9\.]#_#g; $url=~m#(^.*?://.*?)/#; my $site=$1; print "site:".$site."\n"; sub sendsms { my $text=shift; $text=~s/_/%5F/g; $text=~s/&amp;/%26/g; system("echo '$text' | $mailer -s 79xxxxxxxxx xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx\@sms.ru"); } sub parse_page { open(MYFILE,"&lt;".shift); my $text=&lt;MYFILE&gt;; close(MYFILE); my %page; while($text=~/&lt;div class=\"description\"&gt; &lt;h3 class=\"title\"&gt; &lt;a href=\"(.*?)\".*?&gt;\n(.*?)\n.*?&lt;div class=\"about\"&gt;\n\s*(\S*)/gs) { my $uri=$1; my $name=$2; my $price=$3; $uri=~s/^\s+|\s+$//g; $name=~s/^\s+|\s+$//g; $price=~s/^\s+|\s+$//g; $price=~s/&amp;nbsp;//g; $page{"name"}{$uri}=$name; $page{"price"}{$uri}=$price; } return %page; } my %page_old=parse_page($filename); if(scalar keys %{$page_old{"name"}}&gt;0){ system("cp $filename ${filename}-1"); } else{ %page_old=parse_page("${filename}-1"); } system("$wget '$url' -O $filename"); my %page_new=parse_page($filename); if(scalar keys %{$page_old{"name"}}&gt;0){ # already have previous successful search if(scalar keys %{$page_new{"name"}}&gt;0){ # both searches have been successful my $smstext=""; foreach my $uri(keys %{$page_new{"name"}}) { if(!defined($page_old{"price"}{$uri})){ $smstext.="New: ".$page_new{"price"}{$uri}." ".$page_new{"name"}{$uri}." $site$uri\n "; } elsif($page_new{"price"}{$uri} ne $page_old{"price"}{$uri}){ $smstext.="Price ".$page_old{"price"}{$uri}." -&gt; ".$page_new{"price"}{$uri}." ".$page_new{"name"}{$uri}." $site$uri\n"; } if(!defined($page_old{"name"}{$uri})){ # already done for price } elsif($page_new{"name"}{$uri} ne $page_old{"name"}{$uri}){ $smstext.="Name changed from ".$page_old{"name"}{$uri}." to ".$page_new{"name"}{$uri}." for $site$uri\n"; } } if($smstext ne ""){ sendsms($smstext); } } else{ # previous search is successful, but current one is failed # do nothing, probably a temporary problem } } else{ # is new search if(scalar keys %{$page_new{"name"}}&lt;=0){ # both this and previous have been failed sendsms("Error, nothing found for page '$url'"); } else{ # successful search and items found sendsms("Found ".(scalar keys %{$page_new{"name"}})." items, page '$url' monitoring started"); } } foreach my $uri(keys %{$page_new{"name"}}) { print "uri: $uri, name: ".$page_new{"name"}{$uri}.", price: ".$page_new{"price"}{$uri}."\n"; if($page_new{"price"}{$uri} eq $page_old{"price"}{$uri}){print "old price the same\n";} else{print "old price = ".$page_old{"price"}{$uri}."\n";} if($page_new{"name"}{$uri} eq $page_old{"name"}{$uri}){print "old name the same\n";} else{print "old name = ".$page_old{"name"}{$uri}."\n";} }</span></span></code> </pre></div><p>Source: <a href="https://habr.com/ru/post/268857/">https://habr.com/ru/post/268857/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268845/index.html">Why do I need a free code and how to earn on it</a></li>
<li><a href="../268849/index.html">Rust hit the TIOBE index</a></li>
<li><a href="../268851/index.html">Using readable and writable images in OpenCL 2.0</a></li>
<li><a href="../268853/index.html">Office as Platform Release 7 - Manage Office 365 and SharePoint Online via PowerShell</a></li>
<li><a href="../268855/index.html">Introducing 3CX Phone System v14 SP1 with many new features.</a></li>
<li><a href="../268859/index.html">The nuances of ESXi, FlexFabric, 10 Gbit and NFS bundles</a></li>
<li><a href="../268863/index.html">Google Cloud Endpoints in Java: A Guide. part 1</a></li>
<li><a href="../268865/index.html">How business works with IaaS</a></li>
<li><a href="../268867/index.html">New GUI for Postgresql</a></li>
<li><a href="../268871/index.html">Composer - the right way</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>