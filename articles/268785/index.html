<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing a white certificate on a Microsoft VDI farm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many companies use VDI infrastructure to organize remote work with unmanaged company personal stations. When publishing a VDI farm on the Internet, ex...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing a white certificate on a Microsoft VDI farm</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/942/794/c56/942794c567424d558c4d56867f5fdc6b.jpg"><br><br>  Many companies use VDI infrastructure to organize remote work with unmanaged company personal stations.  When publishing a VDI farm on the Internet, external users are faced with the problem of mistrust of the certificate that was issued by the corporate certificate authority.  In consequence of this, security warnings appear when setting up a remote connection. <br><a name="habracut"></a><br><div style="text-align:center;"><img src="https://habrastorage.org/files/577/f70/24c/577f7024c434477f85c630203b4ab3c6.jpg" alt="image"></div><br><br>  In this case, the warning appears twice: the first time the Connection Broker server is not trusted, and the second is the virtual machine of the VDI farm. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Many system administrators come out of this situation either by prompting users to ignore this message by checking the ‚ÄúDo not ask again‚Äù box, or by installing the root certificate in the trusted user‚Äôs remote computer and publishing the corporate CA CRL.  However, these methods do not work if the user connects every time from different places, or connects to different virtual machines. <br><br>  To solve this problem, you must use the "white" certificate issued by a trusted Certificate Authority for the VDI farm.  The name of this external certificate and the names of the VDI computers must match. <br><br><h4>  <b>SOLUTION TO THE PROBLEM</b> </h4><br>  First we need a wildcard certificate of the type * .yourcompany.com, purchased from a trusted certificate authority. <br><br><h5>  <b>Adding a new DNS Suffix in the domain:</b> </h5><br>  Add a new Active Directory Integrated zone yourcompany.com to the DNS on the domain controller, which will serve internal requests for new server names and virtual machines of the VDI farm. <br><br>  To maintain an additional domain suffix in the domain, it is necessary to make changes to the msDS-AllowedDNSSuffixes attribute at the domain level.  You must add the internal and external domain names as attribute values, for example, yourcompany.local and yourcompany.com.  At the domain level, we create a new group policy to specify the DNS suffixes that will be added to the short machine names for DNS queries. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/bf4/41c/fdf/bf441cfdfa6f47298ddc23d7edb1db13.jpg" alt="image"></div><br><br>  The following policy must be enabled and comma-separated values ‚Äã‚Äãof the internal domain name and external domain name: Computer Configuration \ Policies \ Administrative Templates \ Network \ DNS Client \ DNS suffix search list. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/f34/a8c/8e2/f34a8c8e295d4507b243f876f01b4e9b.jpg" alt="image"></div><br><br><h5>  <b>Installing the certificate on the RD server</b> </h5><br>  Before creating a VDI farm, you must change the DNS suffix of the planned RD servers to an external domain name.  To do this, go to the properties of the computer and choose to change the name of the computer.  In the window for changing the computer name, click the More ... button and specify a new primary DNS suffix for the computer - yourcompany.com. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/891/6d5/574/8916d557452c41ef84827bd8b7ba5b18.jpg" alt="image"></div><br>  Next, create a new VDI farm based on selected Microsoft Windows Server 2012 R2 servers.  Information on this procedure can be easily found on the net. <br><br>  After the pfx certificate file is in your hands, you can start installing it on a new VDI farm.  On the RD Connection Broker server, go to Server Manager -&gt; Remote Desktop Services -&gt; Overview.  In the Deployment Overview field in the TASKS drop-down list, select Edit Deployment Properties. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/08f/476/4c1/08f4764c18814a438388deee4dc196f1.jpg" alt="image"></div><br><br>  Open the Certificates tab and install the required certificate * .yourcompany.com for all farm services.  Adding is done one by one.  Select the existing certificate, specify its path on the file system and password. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/174/bfb/967/174bfb967345415a9aab5f4e47197f8b.jpg" alt="image"></div><br><br>  After that, these certificates will be installed on the VDI servers, but not on the virtual machines.  In the registry on the Connection Broker server, the SSLCertificateSHA1Hash REG_BINARY parameter appears with the thumbprint value of the certificate at the following address: <br>  <i>HKEY_LOCAL_MACHINE \ SYSTEM \ CurrentControlSet \ Control \ Terminal Server \ WinStations \ RDP-Tcp.</i> <br><br>  This parameter is responsible for selecting the certificate that will be used when setting up the RDP session.  This option will need to be installed on client machines. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/008/88f/215/00888f2156404c8e98873def7cb7ab97.jpg" alt="image"></div><br><br><h5>  <b>Installing a certificate on virtual machines</b> </h5><br>  To use a white certificate on virtual machines, you must: <br><br><ul><li>  Install the certificate on all machines in the personal certificate store of the computer. </li><li>  Set permissions to read the certificate key for the Network Service of each machine. </li><li>  Have SSLCertificateSHA1Hash REG_BINARY parameter with thumbprint certificate value. </li><li>  Virtual machine names must match the certificate name, i.e.  have yourcompany.com suffix </li></ul><br>  Let's create a new group policy at the level of the Organizational Unit, dedicated to computer accounts of virtual machines of the VDI farm. <br><br>  This policy must run Startup Script ExportVDICert.bat on virtual machines. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cac/498/6d5/cac4986d5e694d43b58b0055d4ef2d7b.jpg" alt="image"></div><br><br>  The specified script uses the certutil and FindPrivateKey utilities from Microsoft.  Certutil is a built-in utility, FindPrivateKey is provided as a Samle tool for developers and can be compiled independently.  The script must be located inside the policy. <br><br>  The certificate and utility FindPrivateKey must be placed in a network folder, from where the script will pick up files for installation.  Script text: <br><br><pre><code class="hljs dos">certutil -f -p "&lt;certificate password&gt;" -importpfx "&lt;<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> to pfx&gt;" NoExport c: <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> "c:\TempCertSecurity" <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> "c:\TempCertSecurity" <span class="hljs-built_in"><span class="hljs-built_in">xcopy</span></span> "&lt;<span class="hljs-built_in"><span class="hljs-built_in">Path</span></span> to FindPrivateKey.exe&gt;" "c:\TempCertSecurity" FindPrivateKey.exe My LocalMachine -t "&lt;thumbprint of certificate&gt;" -a &gt; tmp.txt <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> /p myvar= &lt; tmp.txt <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> tmp.txt <span class="hljs-built_in"><span class="hljs-built_in">del</span></span> FindPrivateKey.exe <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> \ <span class="hljs-built_in"><span class="hljs-built_in">rd</span></span> "c:\TempCertSecurity" <span class="hljs-built_in"><span class="hljs-built_in">cacls</span></span>.exe <span class="hljs-variable"><span class="hljs-variable">%myvar%</span></span> /E /G "NETWORK SERVICE":R"</code> </pre> <br>  Using this script after rebooting the virtual machine, a new certificate will be installed and rights will be configured for it. <br><br>  The next part of the policy concerns setting the SSLCertificateSHA1Hash parameter.  The required key is configured via Preferences \ Windows Settings \ Registry <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/368/137/0c4/3681370c4ad040b39e3fa201e486a9d2.jpg" alt="image"></div><br><br>  To centrally change the Primary DNS suffix of virtual machines in a policy, you must enable Primary DNS suffix and set it as the external domain name of yourcompany.com. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/512/8e5/aac/5128e5aac54244f5b4b832c54ffec890.jpg" alt="image"></div><br><br>  After rebooting, the machine will receive a new FQDN corresponding to the white certificate.  After performing these operations, users will no longer see annoying security warnings. </div><p>Source: <a href="https://habr.com/ru/post/268785/">https://habr.com/ru/post/268785/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../268769/index.html">MiML2</a></li>
<li><a href="../268771/index.html">Using web fonts, the best way (for 2015)</a></li>
<li><a href="../268773/index.html">Imitation of the radio using Freeswitch and a little about voip-conference</a></li>
<li><a href="../268777/index.html">DevTips: Web Developer Tips (17-32)</a></li>
<li><a href="../268781/index.html">Multithreading in Unity by means of reactive extensions</a></li>
<li><a href="../268787/index.html">Features of software and hardware firewalls</a></li>
<li><a href="../268789/index.html">HackedSim. Call from any number - fiction or reality?</a></li>
<li><a href="../268791/index.html">How to create a cross-platform Half-Life or "Headcrabs inside your watch"</a></li>
<li><a href="../268793/index.html">We return the auto-login to the Wi-Fi network of the Moscow metro in Android</a></li>
<li><a href="../268795/index.html">Introduction to arrow functions in javascript ES6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>