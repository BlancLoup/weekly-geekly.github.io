<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Downloading tracks from Autotravel.ru</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like many travel enthusiasts, I find the coordinates of the sights of cities on the site autotravel.ru (hereinafter referred to as the site). To fit m...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Downloading tracks from Autotravel.ru</h1><div class="post__text post__text-html js-mediator-article">  Like many travel enthusiasts, I find the coordinates of the sights of cities on the site <a href="http://autotravel.ru/index.php">autotravel.ru</a> (hereinafter <a href="http://autotravel.ru/index.php">referred</a> to as the site).  To fit my needs I wrote a small utility for downloading files with sights for subsequent uploading to the navigator.  The program is extremely simple, but it works exactly as I needed.  In addition, the simplest way to save load time and traffic is caching. <br><br>  The program, which I called AtTrackDownloader, is written in Python 3 using Beautiful Soup, a library for parsing HTML files.  PyQt is used for the GUI, simply because I am familiar with Qt. <br><a name="habracut"></a><br>  The core of the program is the autotravel class.  It makes no sense to completely describe its methods (especially at the end I will give a link to the git repository).  Sign for the main logic. <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__load_towns_page</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, letter)</span></span></span><span class="hljs-function">:</span></span> url = AutoTravelHttp + <span class="hljs-string"><span class="hljs-string">'/towns.php'</span></span> params = {<span class="hljs-string"><span class="hljs-string">'l'</span></span> : letter.encode(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>)} req = urllib2.Request(url, urllib.parse.urlencode(params).encode(<span class="hljs-string"><span class="hljs-string">'cp1251'</span></span>)) response = urllib2.urlopen(req) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> response.read().decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>)</code> </pre> <br>  The __load_towns_page method loads the contents of the site page for cities starting with the letter.  More precisely, it was a few months ago, but some time ago they changed the addresses of the pages and instead of the letter there is indicated 'a' + number_ of the letter.  For example: A - 'a01', B - 'a02', ..., I - 'a30'. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Accordingly, to load cities into all letters, this method is called in a loop from the __ load_all_towns method.  The resulting webpage text is passed to the __load_towns_from_url method: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__load_towns_from_url</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, html_src)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> html_src.splitlines(): soup = BeautifulSoup(line, <span class="hljs-string"><span class="hljs-string">'html.parser'</span></span>) area = soup.find(<span class="hljs-string"><span class="hljs-string">'font'</span></span>, {<span class="hljs-string"><span class="hljs-string">'class'</span></span> : <span class="hljs-string"><span class="hljs-string">'travell0'</span></span>}) town= soup.find(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, {<span class="hljs-string"><span class="hljs-string">'class'</span></span>, <span class="hljs-string"><span class="hljs-string">'travell5'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> town == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: town = soup.find(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, {<span class="hljs-string"><span class="hljs-string">'class'</span></span>, <span class="hljs-string"><span class="hljs-string">'travell5c'</span></span>}) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> town == <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span> town_name = town.get_text().strip() area_name = area.get_text().strip()[<span class="hljs-number"><span class="hljs-number">1</span></span>:<span class="hljs-number"><span class="hljs-number">-1</span></span>] town_href = town.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> {<span class="hljs-string"><span class="hljs-string">'area'</span></span> : area_name, <span class="hljs-string"><span class="hljs-string">'town'</span></span> : town_name, <span class="hljs-string"><span class="hljs-string">'href'</span></span> : town_href}</code> </pre><br>  In this method, all the main work on parsing cities goes.  Dismantled cities are entered into the list of dictionaries with the keys 'area' - region or country, 'town' - the name of the city, 'href' - a short reference to the city (relative to the site). <br><br>  Thus, all cities are loaded from the site into memory.  It takes about 10 seconds on my computer.  Naturally, this is bad, so the idea of ‚Äã‚Äãa cache of loaded cities arose.  Python allows you to serialize the list in one line, unlike other languages ‚Äã‚ÄãI know, which is great.  The method of saving cities to a cache file is as follows: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__save_to_cache</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'attd.cache'</span></span>, <span class="hljs-string"><span class="hljs-string">'wb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: pickle.dump(data, f)</code> </pre><br>  Loading from the cache is performed in the class constructor: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> open(<span class="hljs-string"><span class="hljs-string">'attd.cache'</span></span>, <span class="hljs-string"><span class="hljs-string">'rb'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> f: self.__all_towns = pickle.load(f) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> FileNotFoundError: self.__all_towns = list(self.__load_all_towns()) self.__save_to_cache(self.__all_towns)</code> </pre><br>  As a result, we get a ten-second delay only at the first start. <br><br>  Getting links to track files is implemented in the get_towns_track_links method, which takes the address of the page with the city: <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_towns_track_links</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, href)</span></span></span><span class="hljs-function">:</span></span> req = urllib2.Request(href) response = urllib2.urlopen(req) soup = BeautifulSoup(response.read().decode(<span class="hljs-string"><span class="hljs-string">'utf-8'</span></span>), <span class="hljs-string"><span class="hljs-string">'html.parser'</span></span>) r = {} <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> link <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> soup.findAll(<span class="hljs-string"><span class="hljs-string">'a'</span></span>, {<span class="hljs-string"><span class="hljs-string">'class'</span></span> : <span class="hljs-string"><span class="hljs-string">'travell5m'</span></span>}): <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> link.get_text() == <span class="hljs-string"><span class="hljs-string">'GPX'</span></span>: r[<span class="hljs-string"><span class="hljs-string">'gpx'</span></span>] = AutoTravelHttp + link.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> link.get_text() == <span class="hljs-string"><span class="hljs-string">'KML'</span></span>: r[<span class="hljs-string"><span class="hljs-string">'kml'</span></span>] = AutoTravelHttp + link.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> link.get_text() == <span class="hljs-string"><span class="hljs-string">'WPT'</span></span>: r[<span class="hljs-string"><span class="hljs-string">'wpt'</span></span>] = AutoTravelHttp + link.get(<span class="hljs-string"><span class="hljs-string">'href'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> r</code> </pre><br>  Since, theoretically (and earlier such cases were), there may not be any track format on the pages of the city, the available track types and links to them are recorded in the dictionary.  This is then used to filter files in the file save dialog. <br><br>  I see no point in describing the creation of an interface - it‚Äôs still easier for anyone who is interested in going to the repository.  And for those who are not interested, I provide a screenshot: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/947/705/5c0/9477055c0fa8272b423ab85bb21212b0.png" alt="image"><br><br>  Full source codes are on <a href="https://github.com/leremin/AtTrackDownloader">Github</a> . </div><p>Source: <a href="https://habr.com/ru/post/271231/">https://habr.com/ru/post/271231/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271221/index.html">How to make the test environment as close as possible to the combat</a></li>
<li><a href="../271223/index.html">We connect GNS3 topology to Cisco dCloud</a></li>
<li><a href="../271225/index.html">Your Joomla site incorrectly gives page 404</a></li>
<li><a href="../271227/index.html">PaaS vs Licenses. Four noble truths of IT infrastructure</a></li>
<li><a href="../271229/index.html">HP P2000 MSA G3 Performance Testing</a></li>
<li><a href="../271233/index.html">We pick up an audio stream from Twilio via SIP and send it to RTMP CDN for further distribution</a></li>
<li><a href="../271235/index.html">How we tested the Russian workflow system on the Scala-R convergent platform</a></li>
<li><a href="../271237/index.html">Features of creating a turnkey web project from Startup Makers</a></li>
<li><a href="../271239/index.html">Testing a web service on Go</a></li>
<li><a href="../271241/index.html">Forecasting in the gaming industry. Part 3: Forecasts for the forecast industry</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>