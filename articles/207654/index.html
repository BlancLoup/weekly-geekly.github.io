<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Trivial encryption in malicious files</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hey. This is again Alexey Malanov from Kaspersky Lab. Last time I talked about the experience of hiring virus analysts , and today I‚Äôll tell you about...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Trivial encryption in malicious files</h1><div class="post__text post__text-html js-mediator-article">  Hey.  This is again Alexey Malanov from Kaspersky Lab.  Last time I talked about the <a href="http://habrahabr.ru/company/kaspersky/blog/203228/">experience of hiring virus analysts</a> , and today I‚Äôll tell you about what virus writers are doing, so that their work is not noticed, and what we are doing, so that their work will be in vain. <br><br>  Generally speaking, the attacker writes a malicious program, almost always knowing in advance that it will sooner or later fall on the "operating table" of virus analytics.  And all the information from the malware can be used against the author.  Why should he hide?  Well, firstly your identity.  Sometimes you encounter lines in the malware, such as C: \ Users \ Vasiliy Ivanov \ Documents \ Visual Studio 2005 \ earnings \ trojan \ Release \ trojan.pdb.  Secondly, quite a lot of information facilitating the analysis of the malware.  Let's look at some tricks of virus writers, and find out why they are useless. <br><a name="habracut"></a><br><h4>  What hide: </h4><br><h5>  Internet links </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/7b1/86d/94f/7b186d94fadf27c2abba4b2e29501fae.png" alt="image"><br><br>  Instances of <a href="http://www.securelist.com/ru/threats/detect/trojan-programs%3Fbehavior%3D27">Trojan-Downloader</a> primarily download / update other malware from one or several links.  Obviously, if the links are stored explicitly, then the auto-processing system of any anti-virus company will easily extract them, add them to the list for periodic downloads, and ban access to these resources.  The meaning of Trojan-Downloader disappears completely.  Other classes of malware also tend to download new versions of their modules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Components </h5><br>  Malware is now complex, multicomponent.  One module is responsible for updating, the second is the driver-rootkit, the third provides for collecting passwords, the fourth is responsible for receiving commands from the control center and sending the results.  In general, very often it all turns into one ‚Äúinstaller‚Äù.  This may be a special third-party "developer" <a href="http://www.securelist.com/ru/threats/detect/trojan-programs%3Fbehavior%3D29">Trojan-Dropper</a> , or simply another component of the same author.  Just as with URLs, if the internal PE-EXE modules are not hidden more reliably, automatic tools will easily pull them out, and all files will be sent for auto-analysis and auto-detection.  Moreover, if at least one of the modules is recognized as malicious, then the entire bundle will definitely not require manual analysis, and everything will be successfully detected. <br><br><h5>  Passwords </h5><br>  You will not believe it, but the authors even sew up their passwords in malicious files.  Not often, of course, but it happens.  For example, if Trojan-Spy takes a lot of screenshots (or even shoots a victim‚Äôs video camera), then the usual way to deliver the material to the author is uploading to FTP.  The virus writer creates one account with read and write access.  And so that no one extra wanders into his FTP, sets a password that fits into the malware code.  As a result, it‚Äôs not anyone who wanders there, but a specific independent researcher, erases everything stolen and leaves a little note to the unfortunate author.  I note that this is <a href="http://www.zakonrf.info/uk/272/">‚Äúunlawful access to computer information,‚Äù</a> but the criminal will not run to write a statement. <br><br>  Another example is a mailbox password.  The author needs to send passwords collected from the victim.  But the mail service on which he has registered the box does not allow sending letters to incomprehensible people and requires authentication when sending.  It is clear that the "serious" Malvarschiki are not so wrong, especially those who are aimed at stealing banking information.  Others, on the contrary, sometimes intentionally expect that their code will be viewed by the analyst.  Now, almost everything goes to automatics, but 10 years ago, when I analyzed the files myself, I encountered such an appeal to a virus analyst inside a sample: ‚ÄúThis is <a href="">Pinch</a> , which nobody detects, and I would like it to remain so.  You do not need to do anything.  Thank." <br><br><h4>  Trivial encryption: </h4><br>  Hence the conclusion: virus writers have something to hide inside their creations, and they try to do it.  If you know perfectly well what <a href="http://ru.wikipedia.org/wiki/Xor">XOR</a> , <a href="http://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B8%25D1%2582%25D0%25BE%25D0%25B2%25D1%258B%25D0%25B9_%25D1%2581%25D0%25B4%25D0%25B2%25D0%25B8%25D0%25B3">ROL</a> bit operations are and understand how you <a href="http://kriptografea.narod.ru/XOR.html">can convert data</a> with them, you can skip this entire section. <br><br>  Suppose you have the string https: //secret.url, and you want to hide it in the code from your eyes.  In this case, the decryption algorithm and the key will also be in the same code, because you yourself will need this line.  Perhaps the simplest way is the following. <br><br><h5>  Not </h5><br><img src="https://habrastorage.org/getpro/habr/post_images/836/985/d51/836985d5178fbc00835867a3970f7fe9.png" alt="image"><br><br>  Let's represent a string in the form of a chain of bits 110100001110100 ... Replace each bit with the opposite one 001011110001011 ... Get the string " <b>CLLP‚îº‚ï®‚ï®MJNL‚ï§KNU</b> ".  Now, the naked eye does not recognize this line.  But you can programmatically.  Let's apply the operation NOT to the whole file: what was encrypted will be decrypted back.  And what is not - is encrypted.  In the resulting file, the URL is visible to the automatics and eyes. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/738/8b7/5ec/7388b75ec4fb43f247fc55b3de8b8033.png" alt="image"><br><br><h5>  Xor </h5><br>  Slightly complicate.  When encrypting, you can not invert every bit, but, for example, every fourth (so that no one guessed).  Such an inversion of some bits is also called an XOR operation.  The <b>a: = a XOR key</b> is written, where <b>a</b> is the byte to be converted, and <b>key</b> is the key in which it is written, which bits we change. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6f/19c/505/e6f19c505ead45a8cbb7f1edf9066ed0.png" alt="image"><br><br>  In this case, the operation NOT is equivalent to <b>a: = a XOR FF</b> .  Hexadecimal FF is equal to binary 11111111 - we invert each bit. <br><br>  To decrypt, you need to "poxorize" the data again with the same key.  To make sure that this is exactly the original, I propose to the curious reader myself.  Do not forget that, unlike the previous method, in this you will have to store the key in the program if you want to decrypt your data during execution.  And the analyst will also have to search / search through the key to decrypt the string.  There is, however, another way, but more on that below. <br><br><h5>  Other methods </h5><br>  What else can be done: <br><ol><li>  Apply to each byte operation ADD, that is, add a certain number - the key </li><li>  Change the key from byte to byte.  For example, the first byte is ‚ÄúXori‚Äù with key 71, the second is from 73, the third is from 75, etc.  Then the key can no longer be simply bruised, it will have to bruise 2 keys, which is 256 times longer </li><li>  You can increase the length of the key.  For example, the first DWORD ‚ÄúXorit‚Äù with a four-byte key, the second DWORD ‚ÄúXorit‚Äù with it, etc.  Then for decryption without a key, you will have to go through 4 billion options.  And if you (or the tweaker program) do not know where exactly the information you are looking for is located in the file, you will have to do this for each byte (the size of the malware is usually several hundred kilobytes) </li><li>  You can apply the cyclic shift operation ROL for each byte.  But it is only with 1-7 bits that makes it possible to ‚Äúroll‚Äù with byte encryption.  By cyclically shifting byte by 8 bits, we get the same byte. </li><li>  You can "Ksorit" twice.  One malware encrypted string.  It seemed to him that this was not enough; he once again ‚Äúpoked‚Äù her with the same key.  Guess what came out of it. </li><li>  The line can be written backwards. </li><li>  The line can be written through bytes.  For ASCII characters, you get Unicode. </li><li>  The line can be shifted to the floor of the alphabet, that is, a-&gt; n, b-&gt; o, ..., z-&gt; m, 0-&gt; 5, 1-&gt; 6 ... </li><li>  Write the characters in hex, that is 687474703A2F2F </li><li>  Place string on stack <br>  ... <br>  push 'w //:' <br>  push 'ptth' </li><li>  Etc </li></ol><br>  All the indicated methods, obviously, can be combined for greater conspiracy :) <br><br><h4>  Decryption: </h4><br>  Denote the task.  There is a 1 MB file.  Inside, in an unknown place, one of the methods described above is encrypted with a string starting with <b>http: //</b> .  Key unknown.  You need to write a program that will process the file and, without an epic search, extract this line.  Something else can be encrypted, for example, the MZ-PE header of the internal file, but with the condition: you know exactly what you are looking for.  And then it is not very grateful to look for unknown garbage, which is encrypted by an unknown, in an unknown place. <br><br>  A small digression.  The LC now uses such methods of autoanalysis, which do not care what is encrypted, and how.  At least, even a very robust algorithm (as opposed to those described).  If the data is used by the program itself, they will still be retrieved by us.  Below I will only demonstrate that the described encryption methods will not protect the virus writer and will not be difficult even for an amateur analyst.  No revelations.  Watch your hands. <br><br><h5>  Xor </h5><br>  Do you remember the url to which the NOT operation was applied?  " <b>CLLP‚îº‚ï®‚ï®</b> ".  Seeing these letters again, you always guess that this is an url.  And here is the line poked up with the key F0: " <b>SHDDA</b> ".  Or with 0F: " <b>g {{‚åÇ5</b> ".  Notice that the second and third, as well as the last and penultimate characters are equal.  The ‚Äúuseful‚Äù property of the described byte transformations is that they translate equal bytes into equal ones.  But XOR has another useful property - the operation is reversible.  That is, from <b>'' = 'h' XOR key</b> <br>  it follows that <b>key = 'w' xor 'h'</b> .  And this means that if there is a <b>YCUKENG</b> sequence, then <b>key: = 'TH' XOR 'h'</b> .  Further we check that <br>  <b>'C' == 't' XOR key</b> <br>  <b>'K' == 'p' XOR key</b> <br>  <b>'E' == ':' XOR key ...</b> <br>  If so, then we found the URL and know the key. <br><br><h5>  Add </h5><br>  Similarly, if <b>'TH' = 'h' + key</b> , then <b>key = 'TH' - 'h'</b> .  And we check that the rest of the urla is really an urla. <br><br>  But what to do if the attacker linearly changed the key from byte to byte? <br>  <b>'TH' = 'h' + key</b> <br>  <b>'N' = 't' + (key + d)</b> <br>  <b>'U' = 't' + (key + 2d)</b> <br>  <b>'K' = 'p' + (key + 3d) ...</b> <br><br>  All the same: <br>  <b>key = 'TH' - 'h'</b> <br>  <b>key + d = 'n' - 't'</b> <br><br>  If the author used a four-byte key: <br>  <b>'YTsUK' = 'http' XOR key32</b> <br><br>  Then we can still calculate the key and even validate it on the remaining three known bytes.  But if the key is the length of the required string itself, then the described approach does not work.  For some reason, the Malvarians do anything, but not something that would actually help them. <br><br><h5>  Combining </h5><br>  For example, they combine methods.  They will record the url backwards, even through a byte, and then another with a variable key.  Yes, some automation can be confusing.  In fact, this does not prevent successfully detecting such files.  And as soon as the virus analyst parses the malware, it will add the Reverse (Unicode (LinearXor (stream))) method to the decoder, after which all old and new versions are decoded automatically. <br><br><h5>  Water marks </h5><br>  Another application of the described encryption methods: watermarks in the program.  Suppose you are an honest programmer and give a copy of the program to customers Vasily and Georgy.  No, better to Edward and Gregory.  And you want to know, and not whether one of them puts the program in public access.  In the source code you can write: <br>  <b>#pragma data_seg (". text")</b> <b><br></b>  <b>extern char WATERMARK [] = "uQPW‚ñ∫‚ñÄ} _ ‚ñ≤ WTW ‚ñ∫";</b>  <b>// "Copy of Edward" XOR FF</b> <br><br>  After compilation, the encrypted line will be in the executable file, but it is not easy to find it.  After all, it is not known what to look for and where. <br><br>  However, as we have just found out, if a copy of Edward does get into public access, then Gregory will have two versions of the program, and he will easily find the difference in them and solve the cipher.  It will only get worse for you, Gregory will be able to forge other people's copies. <br><br><h4>  Conclusion: </h4><br>  Here in general, that's all.  We met with some trivial encryption methods and found out why they are useless.  If you have any questions and comments - great, really looking forward.  If the material seemed too simple to you, then here is a vital example from the field of virus analysis on the same topic. <br><br>  <i>The virus (infector) builds its body into the infected file.</i>  <i>His body is constantly, but it is his xorit on DWORDs with pseudo-random numbers like this:</i> <i><br></i>  <i>srand (key);</i> <i><br></i>  <i>crypted [0] = body [0] XOR rand ();</i> <i><br></i>  <i>crypted [1] = body [1] XOR rand ();</i> <i><br></i>  <i>...</i> <i><br><br></i>  <i>The body decoder with the key ‚Äúsmeared‚Äù by the victim's code (entry-point obscuring), so you will have to detect the encrypted body.</i>  <i>For example, you can assume that the body of the virus is the notepad.exe code section.</i> <i><br><br></i>  <i>It is known that the <a href="http://ru.wikipedia.org/wiki/%25D0%259B%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BE%25D0%25BD%25D0%25B3%25D1%2580%25D1%2583%25D1%258D%25D0%25BD%25D1%2582%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BE%25D0%25B4">most popular compiler algorithm is</a> used as a generator of pseudo-random numbers:</i> <br><br><pre><code class="hljs mel"><span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> * <span class="hljs-number"><span class="hljs-number">1103515245</span></span> + <span class="hljs-number"><span class="hljs-number">12345</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> % ((unsigned <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)RAND_MAX + <span class="hljs-number"><span class="hljs-number">1</span></span>));</code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Show all</b> <div class="spoiler_text"><pre> <code class="hljs mel"><span class="hljs-comment"><span class="hljs-comment">/* * This file is part of the libpayload project. * * It was originally taken from the OpenBSD project. * * Copyright (c) 1990 The Regents of the University of California. * All rights reserved. * * Redistribution and use in source and binary forms, with or without * modification, are permitted provided that the following conditions * are met: * 1. Redistributions of source code must retain the above copyright * notice, this list of conditions and the following disclaimer. * 2. Redistributions in binary form must reproduce the above copyright * notice, this list of conditions and the following disclaimer in the * documentation and/or other materials provided with the distribution. * 3. Neither the name of the University nor the names of its contributors * may be used to endorse or promote products derived from this software * without specific prior written permission. * * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE * ARE DISCLAIMED. IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF * SUCH DAMAGE. */</span></span> #include &lt;libpayload.h&gt; static unsigned <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> next = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> rand_r(unsigned <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> *<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span>) { *<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> = *<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> * <span class="hljs-number"><span class="hljs-number">1103515245</span></span> + <span class="hljs-number"><span class="hljs-number">12345</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (*<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> % ((unsigned <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)RAND_MAX + <span class="hljs-number"><span class="hljs-number">1</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rand</span></span>(void) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (rand_r(&amp;next)); } void srand(unsigned <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span>) { next = <span class="hljs-keyword"><span class="hljs-keyword">seed</span></span>; }</code> </pre><br></div></div><br><br>  Is it possible to quickly detect this virus programmatically <s>in the mind</s> ? </div><p>Source: <a href="https://habr.com/ru/post/207654/">https://habr.com/ru/post/207654/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../207644/index.html">10 facts about Python Meetup</a></li>
<li><a href="../207646/index.html">WDS and unattended installation of Windows 7</a></li>
<li><a href="../207648/index.html">Let the computer make the decision or write the AI ‚Äã‚Äãto play together.</a></li>
<li><a href="../207650/index.html">Jekyll Practical Guide</a></li>
<li><a href="../207652/index.html">Team Programming Psychology</a></li>
<li><a href="../207656/index.html">Color alphabet</a></li>
<li><a href="../207658/index.html">Curiosity received the third software update, NASA pays maximum attention to damaged rover wheels</a></li>
<li><a href="../207662/index.html">Simple interpreter from scratch in Python # 4</a></li>
<li><a href="../207668/index.html">Cordova for Ubuntu</a></li>
<li><a href="../207670/index.html">Google has opposed the patent troll representing the interests of Apple and Microsoft</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>