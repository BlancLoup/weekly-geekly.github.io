<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chef Patterns and Antipatterns</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Preface from the translator 
 One day, my colleague threw me a link to a source article. At first I did not take it seriously. But then, stepping on a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chef Patterns and Antipatterns</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/6e9/83e/870/6e983e870b8df177b0b0784a3d812f6d.jpg" align="right"><br><h4>  Preface from the translator </h4><br>  One day, my colleague threw me a link to a source article.  At first I did not take it seriously.  But then, stepping on a bunch of rakes and stuffing a few of his cones, I realized what was going on. <br><br>  Under the cut you will find some typical errors.  At the same time, the correct approaches to writing and using the infrastructure code for Chef will be shown, which help to avoid problems in the future. <br><br>  The article will be useful for both experienced "chefs" and for beginners. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Antipattern: changing (forking) the community cookbooks </h4><br>  I did that, probably you too.  It all starts quite innocently and does not bode well for anything bad.  You add a couple of attributes, change <code>metadata.rb</code> .  Soon you need to add your recipe, and maybe even <a href="http://docs.opscode.com/lwrp.html">LWRP</a> .  Now you have porridge from your changes and community code, especially if cookbook is in active development on GitHub.  Sooner or later you will have to correct conflicts.  It will be difficult to isolate logical errors if both the original cookbook and your changes are almost the same.  And how will you now version this "Frankenstein"?  Use the same version as upstream?  In short, this is an anti-pattern, which is then difficult to fix. <br><br>  The only exception to the rule of ‚Äúdo not forcay the cookbook community‚Äù is if you are going to bring your changes back to the community.  Then you need to create a ficher branch in git and send a pull request.  This should be a living branch only until the changes merge with the main branch. <br><br><h4>  Pattern: Create your own wrapper (wrapper-cookbook) with your attributes and recipes </h4><br>  Instead of forking the Kukbuk community, it is better to use it "as is" with the Kukbuk wrapper.  In this kukbuk-wrapper in metadata.rb, you need to register a dependency on this kukbook and use <code>include_recipe</code> to run recipes from the kukbook community.  Need to change default attributes?  Then you need to rewrite them in a wrapper book. <br><br>  Gem <a href="https://github.com/bryanwb/chef-rewind">Chef-Rewind</a> can help with this pattern. <br><br><h4>  Antipattern: Using Attributes in Roles </h4><br>  Listing attributes in roles is a dangerous antipattern that can break your production.  Imagine the following scenario.  You have a <code>web_server</code> role with attributes for the names and settings of the two sites that need to be installed on this server.  Now imagine that you need to separate these sites into two roles, <code>app_server</code> and <code>blog_server</code> .  So how are you going to test it on the dev environment?  You can take a chance and hope that everything will be OK or overwrite the attributes in Chef Environments (first on dev, then qa, etc.) and not forget to clean them after they get to production.  Not the best option. <br><br>  It is better to use the attributes in the kukbuk-wrapper. <br><br><h4>  Pattern: Setting Your Attributes in a Kukbuk-Wrapper </h4><br>  Roles do not know how to version Chef, but kukbuki - yes.  By setting the necessary attributes in the wrapper and specifying the correct version of the cookbook in Chef Environment, you can push the changes from dev to production. <br><br>  Ideally, this should be part of the CI process with tests and the gradual advancement of changes automatically.  But this is another story. <br><br><h4>  Antipattern: Setting a start list (run list) in the role </h4><br>  Chef roles seem ideal for storing a list of recipes to run.  However, this approach suffers from the same drawbacks as the previous antipattern.  If you add or remove a recipe from the list of <code>run_list</code> in a role, these changes will be applied to all servers with this role, including production servers. <br><br>  So do not need to: <br><pre> <code class="ruby hljs">name <span class="hljs-string"><span class="hljs-string">"web_server"</span></span> description <span class="hljs-string"><span class="hljs-string">"Role for web servers"</span></span> run_list( <span class="hljs-string"><span class="hljs-string">"recipe[base_server::disk_configuration]"</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe[base_server::dhcp_reservation]"</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe[base_server::pagefile]"</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe[utility::install_tools]"</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe[web_server::web_sites]"</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe[base_server::ssl_certs]"</span></span> )</code> </pre><br><br><h4>  Pattern: Specify the run list in the recipe default in the cookbook e created specifically for this (so-called role-cookbook or application-cookbook) </h4><br>  Keep as a minimum list of recipes.  A complete list of recipes should be stored in the application-cookbook.  For example, the web_server role might look like this: <br><pre> <code class="ruby hljs">name <span class="hljs-string"><span class="hljs-string">"web_server"</span></span> description <span class="hljs-string"><span class="hljs-string">"Role for web servers"</span></span> run_list( <span class="hljs-string"><span class="hljs-string">"role[base]"</span></span>, <span class="hljs-string"><span class="hljs-string">"recipe{web_server]"</span></span> )</code> </pre><br>  The recipe for your application-cookbook default will look something like this: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># web_server cookbook recipes/default.rb include_recipe "base_server::disk_configuration", include_recipe "base_server::dhcp_reservation", include_recipe "base_server::pagefile", include_recipe "utility::install_tools", include_recipe "web_server::web_sites", include_recipe "base_server::ssl_certs"</span></span></code> </pre><br><br>  Again, this is so that you can easily manage the versions of the cookbooks and test changes to version 2.1.0 on the dev environment, while the production will have stable 1.5.0. <br><br><h4>  Conclusion </h4><br>  By following the above patterns, you will save a lot of time and effort.  You will not need to do complicated murgi, since all changes are stored in a wrapper cookbook. <br><br>  By setting the necessary attributes and <code>run_list</code> in the cookbooks, and not in the roles, you will not get problems with versioning and isolation of environments. </div><p>Source: <a href="https://habr.com/ru/post/209232/">https://habr.com/ru/post/209232/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209220/index.html">What unites NASA, Oculus Rift and Kinect 2?</a></li>
<li><a href="../209224/index.html">Happy Birthday, Wikipedia!</a></li>
<li><a href="../209226/index.html">How to move from java to scala in your project</a></li>
<li><a href="../209228/index.html">Creating a client MVC application using RequireJS</a></li>
<li><a href="../209230/index.html">HuGu - the collective player of Vkontakte music on node.js</a></li>
<li><a href="../209234/index.html">GreenCubes: from Minecraft to MMORPG for 4 (?) Years</a></li>
<li><a href="../209236/index.html">AWS Test Drive - Amazon's Sandbox</a></li>
<li><a href="../209238/index.html">Test Kitchen for beginners</a></li>
<li><a href="../209242/index.html">Imperceptible complexity of rocket technology. Part 2: Solid fuel engines</a></li>
<li><a href="../209244/index.html">Unity of form and content</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>