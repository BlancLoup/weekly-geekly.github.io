<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SQL Server Integration Services (SSIS) for Beginners - Part 3</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Part 1 
 ‚Üí Part 2 

 In this part I will talk about working with parameters and variables inside an SSIS package. We learn how to set and monitor th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SQL Server Integration Services (SSIS) for Beginners - Part 3</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/128/5b7/4dc/1285b74dc03b4bd48c84d1894b2c5812.png"></div><br>  ‚Üí <a href="https://habrahabr.ru/post/330618/">Part 1</a> <br>  ‚Üí <a href="https://habrahabr.ru/post/330702/">Part 2</a> <br><br>  In this part I will talk about working with parameters and variables inside an SSIS package.  We learn how to set and monitor the values ‚Äã‚Äãof variables during the execution of a package. <br><br>  We will also consider calling one package from another using the ‚ÄúExecute Package Task‚Äù and some additional components and solutions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>There will also be a lot of pictures.</b> <br><a name="habracut"></a><br><h2>  Continuing with SSIS </h2><br>  Create in three demonstration bases a new table <b>ProductResidues</b> , which will contain information about the balances for each day: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_SourceA <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ProductResidues( ResidueDate <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ProductID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ResidueAmount <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_ProductResidues PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(ResidueDate,ProductID), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_ProductResidues_ProductID <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(ProductID) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> Products(<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_SourceB <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ProductResidues( ResidueDate <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ProductID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ResidueAmount <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_ProductResidues PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(ResidueDate,ProductID), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_ProductResidues_ProductID <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(ProductID) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> Products(<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_Target <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> ProductResidues( ResidueDate <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ProductID <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ResidueAmount <span class="hljs-built_in"><span class="hljs-built_in">decimal</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_ProductResidues PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(ResidueDate,ProductID), <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> FK_ProductResidues_ProductID <span class="hljs-keyword"><span class="hljs-keyword">FOREIGN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(ProductID) <span class="hljs-keyword"><span class="hljs-keyword">REFERENCES</span></span> Products(<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  And we will fill the tables in the sources with test data, alternately running the following script on the DemoSSIS_SourceA and DemoSSIS_SourceB databases: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_SourceA <span class="hljs-comment"><span class="hljs-comment">--USE DemoSSIS_SourceB GO DECLARE @MinDate date=DATEADD(MONTH,-2,GETDATE()) DECLARE @MaxDate date=GETDATE() ;WITH dayCTE AS( SELECT CAST(@MinDate AS date) ResidueDate,10000 ResidueAmount UNION ALL SELECT DATEADD(DAY,1,ResidueDate),ResidueAmount-1 FROM dayCTE WHERE ResidueDate&lt;@MaxDate ) INSERT ProductResidues(ResidueDate,ProductID,ResidueAmount) SELECT d.ResidueDate, p.ID, d.ResidueAmount FROM dayCTE d CROSS JOIN Products p OPTION(MAXRECURSION 0)</span></span></code> </pre><br>  Suppose that there are a lot of rows in the ProductResidues table, and in order not to reload all the information and simplify the integration procedure each time, we will load the following logic into the ProductResidues table in the DemoSSIS_Target database: <br><br><ol><li>  If there are no records in the receiving database, then we will load all the data; </li><li>  If there is data in the host database, we will delete the data for the week (last 7 days) from the last loaded date and load the data from the source starting from this date again. </li></ol><br>  The inconvenience of integrating tables of the ProductResidues type is that there are no fields in it that could be used to uniquely identify when a record appeared, there is no ID type identifier in it, there is no UpdateOn type field that contains the date / time of the last record update ( i.e., there‚Äôs nothing particularly to catch on), otherwise we, for example, could calculate for each source, according to the DemoSSIS_Target database, the last ID or the last UpdatedOn and download data from sources starting from these starting values.  In addition, it is not always possible to make changes in the structure of sources, adjusting them for themselves, because  these may be other people's bases to which we do not have full access. <br><br>  In our case, let‚Äôs still assume that users can change data retroactively and can even delete some lines previously loaded into the DemoSSIS_Target database from sources.  Therefore, the update is done here as if overlapped, the data of the last week is completely overwritten.  Here, the week is taken conditionally, about this minimum period, for example, we could agree with the customer (he could confirm that the data usually change maximum within a week).  Of course, this is not the most reliable way, and sometimes there may be discrepancies, for example, in the case when the user changed the data a month ago and it is worthwhile to provide for the possibility of reloading the data from an earlier date, we will do it with the help of a parameter that specifies us a number of days ago. <br><br>  Create a new SSIS package and name it " <b>LoadResidues.dtsx</b> ". <br><br>  Using the context menu, we will display the input area for package variables (this can also be done using the ‚ÄúSSIS ‚Üí Variables‚Äù menu): <br><br><img src="https://habrastorage.org/web/257/437/f46/257437f4656c4768a0b4e2935000f883.png"><br><br>  In this package, by clicking on the ‚ÄúAdd Variable‚Äù button, we will create a DateFime variable LoadFromDate: <br><br><img src="https://habrastorage.org/web/b0b/ba1/05a/b0bba105a4d549bd8e99df5c3e6b9105.png"><br><br>  By default, the variable is assigned the current date / time value, since  we will redefine the value inside the package, it does not matter to us. <br><blockquote>  You should also pay attention to Expression - if you write an expression in this field, then the variable will work as a formula and we will not be able to change its value using the assignment.  Each time a variable is accessed, its value will be calculated according to the specified expression. </blockquote><br>  Variable values ‚Äã‚Äãcan be set using the ‚ÄúExpression Task‚Äù component.  Let's look at how this is done.  Create an ‚ÄúExpression Task‚Äù element: <br><br><img src="https://habrastorage.org/web/582/8f4/9c5/5828f49c572e443d80ddb076e20d8cf9.png"><br><br>  Double-click to open the editor of this element: <br><br><img src="https://habrastorage.org/web/2ee/84c/c1e/2ee84cc1ec4f40628a8214813cbb62a6.png"><br><br>  Let's write the following expression: <br><br><pre> <code class="hljs pgsql">@[<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>::LoadFromDate] = (DT_DATE) (DT_DBDATE) GETDATE()</code> </pre> <br>  A double type conversion was also applied here to get rid of the time component and leave only the date. <br><br>  Let's also see how to track the value of a variable during the execution of a package. <br><br>  Create a breakpoint on the Expression Task element: <br><br><img src="https://habrastorage.org/web/362/d22/909/362d229099e541e0a56dbd4a3e253b98.png"><br><br>  We point out that the point should trigger at the end of the execution of this block: <br><br><img src="https://habrastorage.org/web/4ee/6a9/fad/4ee6a9fada7b4ba3bca58cfd331f0112.png"><br><br>  Run the package for execution ( <b>F5</b> ) and after stopping at our point, go to the ‚Äú <b>Locals</b> ‚Äù tab: <br><br><img src="https://habrastorage.org/web/9ca/bca/3c0/9cabca3c002947c392cafa683a7da68b.png"><br><br>  Open the <b>Variables</b> list and find our variable in it: <br><br><img src="https://habrastorage.org/web/8a3/a69/30c/8a3a6930cae147c3841e0a86e23312fc.png"><br><br>  For interest, we can change the expression of the ‚ÄúExpression Task‚Äù element to the following: <br><br><pre> <code class="hljs pgsql">@[<span class="hljs-keyword"><span class="hljs-keyword">User</span></span>::LoadFromDate] = (DT_DATE) (DT_DBDATE) DATEADD("DAY", <span class="hljs-number"><span class="hljs-number">-7</span></span>, GETDATE())</code> </pre> <br>  and also experiment: <br><br><img src="https://habrastorage.org/web/7fa/656/9cd/7fa6569cd69f4167a7c23a495b529af0.png"><br><br>  The breakpoint is removed in the same way it was set.  Or you can delete all the breakpoints at once, if there were several: <br><br><img src="https://habrastorage.org/web/40f/560/351/40f56035194e4b9396daefd36f335a4e.png"><br><br>  <b>Create a parameter that will be responsible for the number of days ago.</b> <br><br>  The parameter can be created as global for the whole project: <br><br><img src="https://habrastorage.org/web/fd8/5c7/d66/fd85c7d664014284915d5053bac3d438.png"><br><br>  And local, within a specific package: <br><br><img src="https://habrastorage.org/web/cbc/47b/451/cbc47b451e57432cb40ae8449a007b5c.png"><br><br>  The parameter may be mandatory for the task - the Required flag is responsible for this.  If this flag is set, then when creating a task or when calling a package from another package, it will be necessary to determine the input value of the parameter (we will look at this later). <br><blockquote>  Unlike variables, the value of parameters cannot be changed using the ‚ÄúExpression Task‚Äù. </blockquote><br>  Save the settings and go back to the Expression Task editor: <br><br><img src="https://habrastorage.org/web/591/e2a/741/591e2a741012455697b2d18d44712897.png"><br><br>  For example, I changed the expression to the following: <br><br><pre> <code class="hljs mel">@[User::LoadFromDate] = (DT_DATE) (DT_DBDATE) DATEADD(<span class="hljs-string"><span class="hljs-string">"DAY"</span></span>, - @[$Package::DateOffset] , GETDATE())</code> </pre> <br>  <b>I think this is the essence of the parameters and variables is clear, and we can continue.</b> <br><br>  <b>After we play around with the ‚ÄúExpression Task‚Äù we will remove it.</b> <br><br>  Create the "Execute SQL Task": <br><br><img src="https://habrastorage.org/web/6db/53a/e73/6db53ae73ccf424483570c0d6869cb30.png"><br><br>  Configure it as follows: <br><br><img src="https://habrastorage.org/web/ae8/d83/618/ae8d83618bb34952b00d308dc436f09e.png"><br><br>  Let's write the following query in SQLStatement: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span>,-?,<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(ResidueDate)),<span class="hljs-string"><span class="hljs-string">'19000101'</span></span>) FromDate <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ProductResidues</code> </pre><br>  Since  This query returns one row, set <b>ResultSet = ‚ÄúSingle Row‚Äù</b> and below, on the ‚Äú <b>Result Set</b> ‚Äù tab, save the result to the value of the <b>LoadFromDate</b> variable. <br><br>  On the ‚Äú <b>Parameter Mapping</b> ‚Äù tab, we will set the parameter values ‚Äã‚Äãthat are indicated in the request with a question mark ( <b>?</b> ): <br><br><img src="https://habrastorage.org/web/f12/c31/c77/f12c31c77c8f4298a65ed6ff96dbd6d8.png"><br><br>  <b>Parameters are numbered starting from zero.</b> <br><blockquote>  It is worth noting that if you create a connection using a different type of provider, for example, ‚ÄúADO‚Äù or ‚ÄúADO.Net‚Äù, then instead of questions we can use named parameters like @ParamName and as ‚ÄúParameter Name‚Äù we could also specify @ParamName, not his number.  But alas, we will not be able to use the type of connection with another provider in all cases. </blockquote><br>  Now on the tab ‚ÄúResult Set‚Äù we indicate in which variable to write the result of the query: <br><br><img src="https://habrastorage.org/web/c3c/f20/39a/c3cf2039a1e343fab1d83d7728053e36.png"><br><br>  Here we can also set a breakpoint on this component to ‚Äú <b>Break when the container receives the OnPostExecute event</b> ‚Äù and run the package for execution: <br><br><img src="https://habrastorage.org/web/b9a/b48/c9c/b9ab48c9c0844969a6ae52a4e618dd15.png"><br><br>  Here, for the convenience of monitoring the variable value, I registered the name of the variable in ‚Äú <b>Watch</b> ‚Äù in order not to look for it in the ‚ÄúLocals‚Äù block. <br><br>  As you can see, everything is correct in the LoadFromDate variable, the date ‚Äú01/01/1900‚Äù was recorded, because  There are no rows in the ProductResidues table on Target yet. <br><br>  <b>Rename for clarity, "Execute SQL Task" in "Set LoadFromDate".</b> <br><br>  Create another ‚ÄúExecute SQL Task‚Äù element and call it ‚ÄúDelete Old Rows‚Äù: <br><br><img src="https://habrastorage.org/web/cde/6ef/667/cde6ef667cd7428facd2f16225932093.png"><br><br>  Configure it as follows: <br><br><img src="https://habrastorage.org/web/e1a/6c2/32b/e1a6c232b957465b8617d4998207a8bf.png"><br><br>  SQLStatement contains the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> ProductResidues <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ResidueDate&gt;=?</code> </pre><br>  And set the value of the parameter on the ‚ÄúParameters Mapping‚Äù tab: <br><br><img src="https://habrastorage.org/web/e31/3f6/708/e313f6708fda49c1901df588345d5d5e.png"><br><br>  <b>All, the removal of old data for the specified end period we have implemented.</b> <br><br>  Now we will do part of the corresponding download of fresh data.  To do this, use the ‚ÄúData Flow Task‚Äù component: <br><br><img src="https://habrastorage.org/web/a8a/c58/05f/a8ac5805fbd74615a9381d5aceb5435a.png"><br><br>  Go to the area of ‚Äã‚Äãthis component and create the ‚ÄúSource Assistant‚Äù: <br><br><img src="https://habrastorage.org/web/868/40a/0cd/86840a0cd37747588307b3f842c79f35.png"><br><br>  Configure it as follows: <br><br><img src="https://habrastorage.org/web/c1d/646/efe/c1d646efeacd47188dccac560c15f8fd.png"><br><br>  Clicking on the button "Parameters ..." we will set the value of the parameter: <br><br><img src="https://habrastorage.org/web/848/139/327/84813932749b4e54b12c14ef10133291.png"><br><br>  To record new data, use the familiar component ‚ÄúDestination Assistant‚Äù: <br><br><img src="https://habrastorage.org/web/aab/54d/884/aab54d8845fc49d4804133f928dac051.png"><br><br>  Stretch the arrow from the Source Assistant and configure it: <br><br><img src="https://habrastorage.org/web/d11/5e3/fdf/d115e3fdf43f4bd4816ca4e89fe10cf8.png"><br><br><img src="https://habrastorage.org/web/93e/a9c/005/93ea9c005ec24ad6a883f3b12cfbfaea.png"><br><br><img src="https://habrastorage.org/web/5be/ee3/2f9/5beee32f91a34f529cf2e586294942c2.png"><br><br>  All, the package for transferring data from the SourceA source is ready, we can run it for execution: <br><br><img src="https://habrastorage.org/web/517/e7f/5d3/517e7f5d3b2b44fd934b417c4697b26b.png"><br><br>  Run again: <br><br><img src="https://habrastorage.org/web/44a/978/2c7/44a9782c791b4ddbad3f46d2e987b20c.png"><br><br>  As you can see, when you restart, the data for the specified period is deleted and filled.  Well, everything seems to work as we wanted.  Just in case, check that the recipient's data are equal in number to the source: <br><br><img src="https://habrastorage.org/web/0c5/e7c/99e/0c5e7c99e1ee4caf9b0c7773fa85cb5c.png"><br><br>  <b>Reaching here, I realized that I made a mistake.</b>  <b>Who understood what was happening, well done!</b> <br><br>  But maybe this is good, because  The example turned out not so overloaded. <br><br>  The mistake is that I forgot to take into account that when integrating the data of the Products table, we have formed our own identifiers in the Target (the ID field with the IDENTITY flag)! <br><br>  Let's redo everything to be correct.  It's okay to repeat, but better remember. <br><br>  <b>Let's go a little ahead and add another parameter to the package, which we will call SourceID:</b> <br><img src="https://habrastorage.org/web/354/21a/332/35421a332f8c4d9d9164392eedf39388.png"><br><br>  Migrate "Set LoadFromDate": <br><br><img src="https://habrastorage.org/web/9e8/b85/7fa/9e8b857fa3804379ab42befd154c2e78.png"><br><br>  In SQLStatement we will write a new query, taking into account the SourceID: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ISNULL</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DATEADD</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">DAY</span></span>,-?,<span class="hljs-keyword"><span class="hljs-keyword">MAX</span></span>(res.ResidueDate)),<span class="hljs-string"><span class="hljs-string">'19000101'</span></span>) FromDate <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ProductResidues res <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Products prod <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> res.ProductID=prod.ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> prod.SourceID=?</code> </pre><br>  Set the second parameter: <br><br><img src="https://habrastorage.org/web/bd6/7f5/6aa/bd67f56aa35945379c287c5b55faa78d.png"><br><br>  Now, reconfigure the ‚ÄúDelete Old Rows‚Äù in the same way that SourceID is taken into account: <br><br><img src="https://habrastorage.org/web/0e1/8b3/4ff/0e18b34ffd9f4bf0a0b32fb1a43bd507.png"><br><br>  In SQLStatement we will write a new query from the SourceID accounts: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> res <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ProductResidues res <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Products prod <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> res.ProductID=prod.ID <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ResidueDate&gt;=? <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> prod.SourceID=?</code> </pre><br>  Set the second parameter: <br><br><img src="https://habrastorage.org/web/a05/5f8/373/a055f83733864fd19a23d0143b9d6789.png"><br><br>  Now go to the ‚ÄúData Flow Task‚Äù, delete the chain and add ‚ÄúDerived Column‚Äù: <br><br><img src="https://habrastorage.org/web/a2a/ef1/426/a2aef14262ce4a87a86f2235ffbf6320.png"><br><br>  Configure it as follows: <br><br><img src="https://habrastorage.org/web/755/ece/89a/755ece89a85c4a25ac31dd7b1b1423f4.png"><br><br>  Here I deliberately left the ‚ÄúUnicode string‚Äù type, and did not do the conversion as in the first part.  <b>Let's take a look at the ‚ÄúData Conversion‚Äù component:</b> <br><br><img src="https://habrastorage.org/web/876/1c9/76e/8761c976e0364d1eb073276abf4f6bc4.png"><br><br>  Configure it: <br><br><img src="https://habrastorage.org/web/823/c9b/3f5/823c9b3f506746108993faa728212c93.png"><br><br>  Now, using Lookup, we will make a comparison and obtain the product identifiers we need: <br><br><img src="https://habrastorage.org/web/438/6d3/9b5/4386d39b57784430aa36704a3040b2ba.png"><br><br>  Configure it: <br><br><img src="https://habrastorage.org/web/b3a/2c8/66a/b3a2c866af21434c8942fd439f6e6722.png"><br><br><img src="https://habrastorage.org/web/fd2/543/94d/fd254394dcd74ddcafed42e5a12411f2.png"><br><br><img src="https://habrastorage.org/web/673/20e/d21/67320ed217a44c539be536a33034e522.png"><br><br>  Now we will stretch the blue arrow from Lookup to ‚ÄúOLE DB Destination‚Äù: <br><br><img src="https://habrastorage.org/web/1d8/180/661/1d81806611e64cf1bcfd7d9f1eb15ea3.png"><br><br>  Choose the stream "Lookup Match Output": <br><br><img src="https://habrastorage.org/web/a32/745/8a4/a327458a465f451fbf5c522106f0deb0.png"><br><br>  Set up "OLE DB Destination", you need to rebuild the Mappings: <br><br><img src="https://habrastorage.org/web/0c8/dda/dd8/0c8ddadd86634e7ea32c75a43b44595c.png"><br><br>  Everything, let's clean the table from incorrectly loaded data: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">TRUNCATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> DemoSSIS_Target.dbo.ProductResidues</code> </pre><br>  And run the package for execution: <br><br><img src="https://habrastorage.org/web/564/464/9d1/5644649d1a4a45bdb5f93d8564f19f89.png"><br><br>  Once again: <br><br><img src="https://habrastorage.org/web/931/917/849/93191784900b422b9629001d4c9fa4e6.png"><br><br>  It looks like the truth.  You can independently check whether product IDs are correct. <br><br>  Since the structure of DemoSSIS_SourceA and DemoSSIS_SourceB is the same and we need to do for DemoSSIS_SourceB, the same is true, we can create two steps for the LoadResidues.dtsx package when creating a task, in the first step, configure the connection to the DemoSSIS_SourceA database, and in the second step DemoSSIS_SourceB. <br><br>  Compile and redesign the SSIS project: <br><br><img src="https://habrastorage.org/web/ca9/4c8/8be/ca94c88be1bd45589c8b7afeb5595d6f.png"><br><br><img src="https://habrastorage.org/web/648/086/03b/64808603b7734fe8a54dad1eb2bdec6e.png"><br><br><img src="https://habrastorage.org/web/a44/806/8f7/a448068f710c4888a194fdc6b73a8c13.png"><br><br>  Let's now create a new task in SQL Agent: <br><br><img src="https://habrastorage.org/web/7ba/050/b30/7ba050b303f84572b232a892f73aefb2.png"><br><br>  On the Steps tab, create step 1 to load products: <br><br><img src="https://habrastorage.org/web/e29/5d6/f8b/e295d6f8b53e46cb87bad12311b526ca.png"><br><br>  Create step 2 to load the residues from SourceA: <br><br><img src="https://habrastorage.org/web/2fc/a61/9dd/2fca619ddf464c4bb3dfb6a34215ebcb.png"><br><br>  On the Configuration tab we can see our parameters: <br><br><img src="https://habrastorage.org/web/d59/aec/a57/d59aeca579224adc9116ec66ec001925.png"><br><br>  Here we are required to enter SourceID, because  we specified it as Required.  Let's set it: <br><br><img src="https://habrastorage.org/web/4b6/b77/604/4b6b77604dd044269fbccaf026f81423.png"><br><br>  <b>The ‚ÄúConnection Managers‚Äù tab data will not be changed for this step.</b> <br><br>  Create step 3 to load the balances from SourceB: <br><br><img src="https://habrastorage.org/web/e52/92e/96a/e5292e96a8d9406a88d7c99d8ef66ca9.png"><br><br>  Set the SourceID parameter: <br><br><img src="https://habrastorage.org/web/3c9/573/52f/3c957352ffc043ea807ddadb224e333e.png"><br><br>  And we will modify the data of SourceA so that it refers to the base DemoSSIS_SourceB: <br><br><img src="https://habrastorage.org/web/e5c/bdb/c5a/e5cbdbc5a6c14f128baa84c3c4e4580f.png"><br><br>  In this case, it was enough for me to change the ConnectionString and InitialCatalog, now they point to DemoSSIS_SourceB. <br><br>  <b>As a result, we should get the following - three steps:</b> <br><br><img src="https://habrastorage.org/web/469/34c/c43/46934cc43df74aef9db79a44b47edbaf.png"><br><br>  Run this task for execution: <br><br><img src="https://habrastorage.org/web/123/dee/cbf/123deecbf5eb4a47a45a6fe6103b9c95.png"><br><br>  Run the query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_Target <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> prod.SourceID,<span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ProductResidues res <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> Products prod <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> res.ProductID=prod.ID <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> prod.SourceID</code> </pre><br>  And make sure that everything worked as it should: <br><br><img src="https://habrastorage.org/web/155/2a6/9d0/1552a69d01094677a23e9b0db9bb1e0b.png"><br><br>  <b>Now let's assume that the bases DemoSSIS_SourceA and DemoSSIS_SourceB are located on the same instance of SQL Server.</b>  Let's redo the ‚ÄúOLE DB Source‚Äù: <br><br><img src="https://habrastorage.org/web/1ed/391/05e/1ed39105ebff412ebbba6bf72f90fc77.png"><br><br><img src="https://habrastorage.org/web/bbd/42d/be3/bbd42dbe389347a3a3e77fa92b1564fe.png"><br><br>  Command text: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> @SourceID <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>)=? <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>(@SourceID=<span class="hljs-string"><span class="hljs-string">'A'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_SourceA <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_SourceB <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> ResidueDate, ProductID, ResidueAmount <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ProductResidues <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ResidueDate&gt;=?</code> </pre><br>  Set the parameters: <br><br><img src="https://habrastorage.org/web/cc6/8a2/e78/cc68a2e78b4443089b9105e20394e846.png"><br><br>  <b>Now, our package, depending on the value of the SourceID parameter, will take data either from SourceA or from SourceB.</b> <br><br>  For the test, you can change the value of the SourceB parameter to ‚ÄúB‚Äù and run the project for execution: <br><br><img src="https://habrastorage.org/web/4eb/f22/d00/4ebf22d005ea4dfc8c6409b22fff042b.png"><br><br><img src="https://habrastorage.org/web/a4a/3c6/7d9/a4a3c67d936346edbb754e7a8514a0f0.png"><br><br>  Let's now create a new package ‚Äú <b>LoadAll.dtsx</b> ‚Äù and create in it the ‚ÄúExecute Package Task‚Äù (rename it to ‚ÄúLoad Products‚Äù): <br><br><img src="https://habrastorage.org/web/f6e/722/00d/f6e72200dd6440ed97584c559078b871.png"><br><br>  Set up "Load Products": <br><br><img src="https://habrastorage.org/web/ea0/3b0/7d8/ea03b07d87cc4c5bb1c6d997eb0fbd27.png"><br><br>  Create in the new package 2 parameters: <br><br><img src="https://habrastorage.org/web/dff/d99/fc5/dffd99fc5fbf4aabaa529a1de1b389f2.png"><br><br>  In the ‚ÄúControl Flow‚Äù area we will create 2 more components of the ‚ÄúExecute Package Task‚Äù which we will call ‚ÄúLoad Resudues A‚Äù and ‚ÄúLoad Resudues B‚Äù: <br><br><img src="https://habrastorage.org/web/4d9/259/a78/4d9259a78151431b9587834a56816ef9.png"><br><br>  Configure them by setting the name of the package ‚ÄúLoadResidues.dtsx‚Äù for both: <br><br><img src="https://habrastorage.org/web/c6c/d44/525/c6cd445254c2456e8dcd96c3109095c8.png"><br><br>  Set the required SourceID parameter for "Load Resudues A": <br><br><img src="https://habrastorage.org/web/949/10d/683/94910d683fe54c3c8b9d83648626058e.png"><br><br>  Set the required SourceID parameter for "Load Resudues B": <br><br><img src="https://habrastorage.org/web/80c/e7b/763/80ce7b763adc45ae867348a7c2d2691a.png"><br><br>  Please note that the arrows also have their own properties, for example, we can change the Value property to Completion, which means that the next step will be performed even if an error occurs at the ‚ÄúLoad Resudues A‚Äù step: <br><br><img src="https://habrastorage.org/web/ff7/54c/4e1/ff754c4e1ebf4d72ad023ea1501f8aaa.png"><br><br>  Everything, we can run the package for execution: <br><br><img src="https://habrastorage.org/web/187/888/9e2/1878889e230d4a75a904b4cc98a22806.png"><br><br>  I think that explaining what happened here makes no sense. <br><br>  <b>Sometimes parameters for a particular package are conveniently stored in an auxiliary table and read them from there into package variables, for example, using the global search variable System :: PackageName for searching.</b>  <b>To demonstrate, let's redo our package this way.</b> <br><br>  Create a table with parameters: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> DemoSSIS_Target <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> IntegrationPackageParams( PackageName <span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>(<span class="hljs-number"><span class="hljs-number">128</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DateOffset <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> PK_IntegrationPackageParams PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span>(PackageName) ) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> IntegrationPackageParams(PackageName,DateOffset)<span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (N<span class="hljs-string"><span class="hljs-string">'LoadResidues'</span></span>,<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Remove the DateOffset parameter from the LoadResidues.dtsx package: <br><br><img src="https://habrastorage.org/web/150/e21/15d/150e2115dac64fd4bca6e6ef938cb88e.png"><br><br>  <b>Create a DateOffset variable in the package:</b> <br><br><img src="https://habrastorage.org/web/744/ebe/8a9/744ebe8a903f437e933fef0da9cb9eae.png"><br><br>  In the ‚ÄúControl Flow‚Äù area, add another ‚ÄúExecute SQL Task‚Äù element and rename it ‚ÄúLoad Params‚Äù: <br><br><img src="https://habrastorage.org/web/a09/83e/871/a0983e8712874a1cb8250602086155bb.png"><br><br>  Configure it: <br><br><img src="https://habrastorage.org/web/e79/ae3/ef7/e79ae3ef738c40fa818ad0fff2b95238.png"><br><br>  We will write the following query in SQLStatement: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> DateOffset <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> IntegrationPackageParams <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> PackageName=?</code> </pre><br>  <b>Set the request parameter using the system variable "System :: PackageName":</b> <br><br><img src="https://habrastorage.org/web/d19/a93/662/d19a936621124001aff9645604278d34.png"><br><br>  It remains to reset the result of the query to a variable: <br><br><img src="https://habrastorage.org/web/c91/7e3/e90/c917e3e9094e46ceb3c67e22c075b03b.png"><br><br>  It now remains to reconfigure Set LoadFromDate so that it now uses the variable: <br><br><img src="https://habrastorage.org/web/7e8/6c2/bf5/7e86c2bf5d6d4ebbba2ddfbd8276cab5.png"><br><br><img src="https://habrastorage.org/web/515/3b9/755/5153b9755d624056b26cd16074b4d81d.png"><br><br>  Everything, we can test the new version of the package. <br><br>  <b>So we got to the finish.</b>  <b>My congratulations!</b> <br><br><h2>  Conclusion on the third part </h2><br>  Dear readers, this part will be final. <br><br>  In this series of articles, I have tried to think over examples in such a way as to make them as short as possible and, in turn, cover as many useful and important details as possible. <br><br>  I think, having mastered this, then you can easily master the work with the other components of SSIS.  In these articles I reviewed only the most important components (most often used in my practice), but knowing only this you can do a lot.  If necessary, study other components yourself, first of all, I would recommend to see the following: <br><br><ul><li>  container components (Sequence Container, For Loop Container, Foreach Loop Container); </li><li>  ‚ÄúMerge Join‚Äù, which allows you to perform JOIN, LEFT JOIN, FULL JOIN operations on the SSIS side (this requires pre-sorting two sets with ‚ÄúSort‚Äù); </li><li>  "Conditional Split", which allows you to split one stream into several, depending on the conditions; </li><li>  Also consider the ‚ÄúEvent Handlers‚Äù tab, which allows you to create additional areas for a specific kind of package event. </li></ul><br>  There is a lot of material available on this topic, use MSDN, Youtube and other sources. <br><br>  I did not try to make a detailed tutorial (I think all this is already there), but I tried to make such material that will allow beginners to create everything from scratch step by step and do everything with their own hands to see the whole picture, and then having the basis to go further on their own.  I really hope that I did it and the material will be useful in this particular way. <br><br>  I am very glad that I had the strength to carry out my plans and describe everything as I wanted, even it turned out to do more, because of the mistakes made in this part, unexpected plot twists occurred, but this way I think it became even more interesting.  ;) <br><br>  Thanks for attention!  Good luck! <br><br>  And maybe see you in new articles ... </div><p>Source: <a href="https://habr.com/ru/post/330840/">https://habr.com/ru/post/330840/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330830/index.html">Android Architecture Components in conjunction with Data Binding</a></li>
<li><a href="../330832/index.html">Two years with Dart: how we write in a language that is ‚Äúburied‚Äù every year (part 1)</a></li>
<li><a href="../330834/index.html">Design as a world language of the 21st century</a></li>
<li><a href="../330836/index.html">Technology and non-IT: how and why S / 4HANA is used in wholesale</a></li>
<li><a href="../330838/index.html">Attention, Habrahabr: IBM opens free access to a large number of its resources</a></li>
<li><a href="../330842/index.html">Hacking Age of Mythology: Turning off the Fog of War</a></li>
<li><a href="../330844/index.html">We write a simple driver under Windows to lock USB devices.</a></li>
<li><a href="../330846/index.html">May the Code Review with you</a></li>
<li><a href="../330848/index.html">Top 15 Free Unity Assets for a Beginner 2D Developer</a></li>
<li><a href="../330850/index.html">Microsoft at CodeFest 2017 - report, slides and video reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>