<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Incoding Rapid Development Framework (part 2 CQRS)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Pre story 
 My previous article was an introduction to the Incoding Framework, which began with IML (our flagship feature). IML pushed us to develop t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Incoding Rapid Development Framework (part 2 CQRS)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cfd/554/dad/cfd554dadc064d62a451ba5e1b4842a0.png" alt="image"><br><br><h4>  Pre story </h4><br>  My previous <a href="http://habrahabr.ru/post/209734/">article</a> was an introduction to the Incoding Framework, which began with IML (our flagship feature).  IML pushed us to develop the project more than a set of utilities (this kind of goodness is completely in any development team) used in the company's projects, but this does not mean that other components are not worked out, but instead are ‚Äúpolished‚Äù with no less detail and I will try to prove it to you . <br><br><h4>  Silver bullet? </h4><br>  Previously, I have always been a supporter of the fact that every solution has its drawbacks and advantages, but the CQRS in my opinion surpasses the N-Layer, and also has no "contraindications" or "side effects", which makes it a candidate for the first cartridge, But first things first. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Has anyone heard of CQRS? </h4><br>  For those who are already using CQRS, the first sections may not be interesting, so before putting the label ‚Äúbicycle‚Äù, I suggest that you familiarize yourself with the killing feature section, which can convince you otherwise.  Those who use N-Layer architecture should think about switching to CQRS and in order to back up my proposal I will describe our way to CQRS <br><a name="habracut"></a><br><br><h4>  Oh, how convenient a lot of abstractions (opinion from the past) </h4><br>  When we were just starting to develop the application, we chose N-Layer as the server-side architecture, which divides the application into multiple layers, thereby allowing to design different parts of the project independently of each other, but in the end we got the following problems: <br><ul><li>  ‚ÄúSwelling‚Äù of the source code, the problem most often occurs due to the addition of connecting layers such as the facade layer, communication layer, etc. </li><li>  Hiding parts behind multiple levels of layers. </li></ul><br>  <i>Note: the idea of ‚Äã‚Äãthe N-Layer is also related to the substitution dll of a certain layer, but this extremely rarely claimed task is much easier solved through IoC.</i> <br><br>  The main source of "evil" in the N-Layer is most often the service layer, which is designed to hide the details of the business processes and application logic by aggregating similar tasks into one class, which over time turns it into a GOD object and leads to problems: <br><ul><li>  Support and extend closely related methods </li><li>  It's hard to cover a large object with tests. </li></ul><br><br>  If not to be given in subtleties, then conditionally alteration on the CQRS will be to divide large objects into small <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IUserService</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Delete</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-function">List&lt;User&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Fetch</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Criteries criteries</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  After decomposition, we get two Command (AddUser, DeleteUser) and query (FetchUser), which increases the number of classes, but allows us to get rid of the few related methods in the class. <br>  ‚ÄúNow, even more classes need to be written!‚Äù - this is the first question asked by the ‚Äútrue‚Äù N-Layer developers, but as a counterargument, we can single out what we get atomic (no dependencies between objects) of tasks, and this is worth it: <br><ol><li>  Fewer conflicts in VCS (Version Controler System) </li><li>  Search by class is easier than by method. </li><li>  You no longer need to separate the UserService by partial, because it‚Äôs difficult to navigate in one)) </li><li>  The issue on the bugtracker is formed from Command and Query </li><li>  Sprint for agile is formed from Command and Query </li><li>  Testing of small objects </li></ol><br><br><h4>  Our implementation </h4><br>  For the impatient, who wants to immediately ‚Äúfeel‚Äù the code, you can download the source code (ibid example is the Incoding CQRS + MVD bundle) from <a href="https://github.com/IncodingSoftware/CQRS">GitHub</a> , we will consider them as an example. <br>  <i>note: to start a project, you need to create an empty database and specify its ConnectionString in the web.config (main key)</i> <br><br><h5>  Dispatcher </h5><br>  The key element that performs <b>Message</b> ( <b>Command</b> or <b>Query</b> ) in a single transaction (Unit Of Work). <br>  <b>Controller</b> - in the framework of the asp.net mvc (console, wpf, owin and etc) system to use the dispatcher, you need to get an instance of it from IoC and then two methods are available: <br><ul><li>  Push - executes command </li><li>  Query - performs query </li></ul><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Test</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dispatcher = IoCFactory.Instance.TryResolve&lt;IDispatcher&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> id = dispatcher.Query(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetIdQuery()); dispatcher.Push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeleteEntityByIdCommand(id)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> something ActionResult; }</code> </pre><br><br>  <b>Unit Of Work</b> - if you look at the implementation of any <a href="">Command</a> , you can see that the main code is contained in the overloaded Execute method, which can be called without Dispatcher participation, but then the connection to the database and the transaction will not be opened. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DeactivateEntityCommand().Execute(); <span class="hljs-comment"><span class="hljs-comment">// without transaction and connection dispatcher.Push(new DeactivateEntityCommand()); // open transaction and connection</span></span></code> </pre><br><br><h5>  Message </h5><br>  CommandBase and QueryBase are children of Message, but their behavior differs in the type of Isolation Level with which the Unit Of Work is created. <br><ul><li>  Command - ReadCommitted </li><li>  Query - ReadUncommitted (read only) </li></ul><br>  <i>note: the restriction may seem tough, but if for some reason you need to save (delete, insert) data in Query, you should revise your script by splitting into smaller tasks.</i> <br><br>  Message has two main tools: <br>  <b>Repository</b> - database interface, supports all CRUD scripts <br><div class="spoiler">  <b class="spoiler_title">Examples</b> <div class="spoiler_text"><h6>  Create </h6><br><pre> <code class="cs hljs">Repository.Save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> entity())</code> </pre><br><h6>  Read </h6><br><pre> <code class="cs hljs">Repository.GetById&lt;TEntity&gt;(id); Repository.Query(whereSpecification: spec, orderSpecification:spec, paginatedSpecification:spec)</code> </pre><br>  <i>Note: Query (Paginated) is the most extensive method of the Repository, which with the help of the specification to the query describes the data to be obtained.</i> <br><h6>  Update </h6><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> entityFromDb = Repository.GetById&lt;TEntity&gt;(id); entityFromDb.Title = <span class="hljs-string"><span class="hljs-string">"New title"</span></span>; <span class="hljs-comment"><span class="hljs-comment">// tracking</span></span></code> </pre><br>  <i>note: if provider ORM does not support tracking, then you need to call the Repository.SaveOrUpdate (entity) method</i> <br><h6>  Delete </h6><br><pre> <code class="cs hljs">Repository.Delete&lt;TEntity&gt;(id);</code> </pre><br></div></div><br><br>  <b>Event Broker</b> - communication between Command, which allows you to aggregate re-occurring "pieces" of code and encapsulate in events and subscribers. <br><br>  <b>Task:</b> audit of some actions <br>  <b>Problem: the</b> code for saving Audit will be the same and you will have to repeat it in each Command. <br>  <b>Solution in the Service Layer:</b> you can select the base class ServiceWithAuditBase, but it will be difficult to maintain with increasing complexity of the audit, and inheritance always leads to complication. <br>  <b>Solution with subscribers</b> <br>  Event code <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OnAuditEvent</span></span> : <span class="hljs-title"><span class="hljs-title">IEvent</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Message { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  <i>note: condition for Event to implement IEvent</i> <br>  Subscriber code <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AuditSubscriber</span></span> : <span class="hljs-title"><span class="hljs-title">IEventSubscriber</span></span>&lt;<span class="hljs-title"><span class="hljs-title">OnAuditEvent</span></span>&gt; { <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> IRepository repository; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AuditSubscriber</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IRepository repository</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository = repository; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Subscribe</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OnAuditEvent @</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">event</span></span></span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.repository.Save(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Audit { Message = @<span class="hljs-keyword"><span class="hljs-keyword">event</span></span>.Message }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Dispose</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } }</code> </pre><br>  <i>Note: Subscriber is created through IoCFactory and therefore you can inject in ctor (constructor) or use IoCFactory.Instance.TryResolve ()</i> <i><br></i>  <i>Command Code</i> <i><br></i> <pre> <i><code class="cs hljs">EventBroker.Publish(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OnAuditEvent { Message = <span class="hljs-string"><span class="hljs-string">"New product {0} by {1}"</span></span>.F(Title, Price) });</code></i> </pre> <i><br><br></i> <h5>  <i>Query</i> </h5> <i><br></i>  <i>To create a custom Query, you need to inherit QueryBase, where you specify the expected data return and override the ExecuteResult method</i> <i><br></i> <pre> <i><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GetProductsQuery</span></span> : <span class="hljs-title"><span class="hljs-title">QueryBase</span></span>&lt;<span class="hljs-title"><span class="hljs-title">List</span></span>&lt;<span class="hljs-title"><span class="hljs-title">GetProductsQuery</span></span>.<span class="hljs-title"><span class="hljs-title">Response</span></span>&gt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Response</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Title { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Title { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>? From { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span>? To { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> List&lt;Response&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ExecuteResult</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Repository.Query(whereSpecification: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductByTitleWhere(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Title) .And(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductBetweenPriceWhere(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.From, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.To))) .Select(product =&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Response { Title = product.Title, Price = product.Price.ToString(<span class="hljs-string"><span class="hljs-string">"C"</span></span>) }) .ToList(); } }</code></i> </pre> <i><br></i>  <i>It can be noted that the nested class is used as the Result, but why not ...</i> <i><br></i>  <i><b>Return immediately an object from the database (Entity)</b> - this method has a problem associated with the work area of ‚Äã‚Äãthe session connecting to the database, consider with an example.</i> <i><br></i> <div class="spoiler">  <i><b class="spoiler_title">Example</b></i> <div class="spoiler_text">  <i>Query code</i> <i><br></i> <pre> <i><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Repository.Query&lt;Product&gt;();</code></i> </pre> <i><br></i>  <i>Controller Code</i> <i><br></i> <pre> <i><code class="cs hljs">dispatcher.Query(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GetProductsQuery()) .Select(r=&gt; <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Amount = r.Orders.Sum(r=&gt;r.Price))</code></i> </pre> <i><br></i>  <i>The error will be in the runtime, if you do not turn off Lazy Load (relevant only for OLAP objects) at the ORM mapping level, because after the Query is completed, the session is closed, and when you access the Orders field, a query is sent to the database.</i> <i><br></i> </div></div> <i><br></i>  <i><b>ViewModel</b> is the same as the nested class, but with the ability to reuse in other Query, which is an extremely rare scenario.</i> <i><br><br></i> <h5>  <i>Command</i> </h5> <i><br></i>  <i>Our first implementations of Command for CQRS were with the description (AddUserCommand) from the executor (UserCommandHandler), which made the development process more complicated, so these parts were later combined.</i> <i><br></i>  <i><i>note: the main reason for separation was the support of the DTO (Data Transfer Object) model for SOAP systems, but with the advent of asp.net mvc, it just became irrelevant</i></i> <i><br><br></i>  <i>To create a custom Command, you need to inherit CommandBase and override the Execute method.</i> <i><br></i> <pre> <i><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AddProductCommand</span></span> : <span class="hljs-title"><span class="hljs-title">CommandBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Title { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Execute</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> product = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product { Title = Title, Price = Price } Repository.Save(product); Result = product.Id; } }</code></i> </pre> <i><br></i>  <i><i>note: there are scenarios where the Command should return data, then you can set Result in the Command method</i></i> <i><br><br></i> <h4>  <i>Killing feature</i> </h4> <i><br></i> <h5>  <i>Composite</i> </h5> <i><br></i>  <i>CQRS helps to break up complex tasks into smaller ones, but the problem of a general transaction occurs.</i> <i><br></i>  <i><b>Task</b> : save the object in 3 stages</i> <i><br></i>  <i><b>Solution</b> : divided into three commands (Step1Command, Step2Command, Step3Command)</i> <i><br></i>  <i><b>Condition</b> : Transaction</i> <i><br></i> <pre> <i><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Step1Command step1,Step2Command step2,Step3Command step3</span></span></span><span class="hljs-function">)</span></span> { dispatcher.Push(composite =&gt; { composite.Quote(step1); composite.Quote(step2); composite.Quote(step3); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IncodingResult.Success(); }</code></i> </pre> <i><br></i>  <i>In addition to grouping the Command in one package, Composite allows you to manipulate the results of execution.</i>  <i>Let us complicate the task and set a condition for Step1 to transmit the Id of a new element after Step 1 and Step 2 and 3.</i> <i><br></i> <pre> <i><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Step1Command step1,Step2Command step2,Step3Command step3</span></span></span><span class="hljs-function">)</span></span> { dispatcher.Push(composite =&gt; { composite.Quote(step1,<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageExecuteSetting { OnAfter = () =&gt; { step2.Id = step1.Result; step3.Id = step1.Result; } }); composite.Quote(step2); composite.Quote(step3);}); }</code></i> </pre> <i><br><br></i> <h5>  <i>‚ÄúHot‚Äù change connection string</i> </h5> <i><br></i>  <i>If the application receives the connection string not at the start, but during the operation, for example, after logging into the system, the third-party service provides the address for the current session, then you should be able to change the path specified earlier.</i> <i><br></i> <pre> <i><code class="cs hljs">dispatcher.Query(query, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageExecuteSetting { Connection = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlConnection(currentConnectionString) });</code></i> </pre> <i><br></i> <h5>  <i>Inherited system</i> </h5> <i><br></i>  <i>Wrapping over the ‚Äúold ‚Ä≥ base is not a problem in the Incoding Framework.</i>  <i>There are tools that allow you to avoid creating additional infrastructure for working with different configurations and develop Command and Query without taking this detail into account.</i> <i><br></i> <pre> <i><code class="cs hljs">dispatcher.Query(query, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageExecuteSetting { DataBaseInstance = <span class="hljs-string"><span class="hljs-string">"Instance 2"</span></span> });</code></i> </pre> <i><br></i>  <i><i>note: each key has its own ORM configuration</i></i> <i><br><br></i> <h4>  <i>Conclusion</i> </h4> <i><br></i>  <i>The article focuses primarily on the review of the implementation of Incoding CQRS, so the review of the CQRS methodology itself is brief, and it is already well described in other sources.</i>  <i>Incoding CQRS is one of the parts of our framework, but it is completely self-contained and is used without other components (IML, MVD, Unit Test).</i> <i><br><br></i>  <i>In the comments to the first article about IML, there were questions about the possibility of using alternative (OWIN) platforms for asp.net mvc, so I‚Äôll immediately notice that Incoding CQRS was used in WPF projects, and as for IML, this month will be an article about integration .</i> <i><br><br></i>  <i><b>PS</b> Glad to hear feedback and comments, as well as questions on the work of the framework.</i>  <i>The next green hero Incoding MVD who fights against copy &amp; paste will be in a couple of weeks)))</i> </div><p>Source: <a href="https://habr.com/ru/post/211206/">https://habr.com/ru/post/211206/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211194/index.html">An example of optimizing computing on CUDA</a></li>
<li><a href="../211198/index.html">Post news with a picture in the Vkontakte group (Perl)</a></li>
<li><a href="../211200/index.html">The problem of glass balls - the solution in general</a></li>
<li><a href="../211202/index.html">Unity3D multiplayer basics</a></li>
<li><a href="../211204/index.html">Qwt and Qt Creator. Quick and easy. Part 1: Data Visualizer</a></li>
<li><a href="../211208/index.html">Evolution in data center networks. Software defined SDN</a></li>
<li><a href="../211210/index.html">Browser Development - Functional Level</a></li>
<li><a href="../211214/index.html">Cybersquatting in new zones will not be a problem</a></li>
<li><a href="../211216/index.html">iOS leaves your phone number hostage</a></li>
<li><a href="../211218/index.html">Replication of data from MySQL to MongoDB</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>