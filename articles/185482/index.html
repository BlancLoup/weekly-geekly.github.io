<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Realistic Canvas Smoke</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 On the Internet there are several articles about how to make a smoke effect, but the scripts are too "heavy", and for me personally not...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Realistic Canvas Smoke</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  On the Internet there are several articles about how to make a smoke effect, but the scripts are too "heavy", and for me personally not entirely clear.  So I decided to simplify the task for those who are interested in implementing this effect in their projects. <br>  I will not write a lot, mostly code with detailed comments. <br><a name="habracut"></a><br><h4>  So, the page layout: </h4><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>smoke<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">bgcolor</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"#000"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"info"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"color: #fff"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"canvas"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500px"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"500px"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">canvas</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> ... </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  This is all clear.  There is a Canvas, a div for displaying the number of particles, and a body with a black background - on a white background the effect is not so beautiful. <br><br><h4>  Script in pieces: </h4><br>  First we need to find the necessary elements on the page, and write a convenient function for obtaining random values. <br><pre> <code class="javascript hljs">info = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'info'</span></span>); canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'canvas'</span></span>); ctx = canvas.getContext(<span class="hljs-string"><span class="hljs-string">'2d'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">random</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">min,max</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.random() * (max - min) + min; }</code> </pre><br>  After that you need to create an array of particles, the function of adding particles (in my code, my hand does not rise to write that this is a constructor =).  Actually, the particles have the following properties: <br><ul><li>  number </li><li>  transparency </li><li>  radius </li><li>  angle </li><li>  x-coordinate </li><li>  y-coordinate </li><li>  self draw function </li></ul><br>  Also to each of these properties there is a value that changes this property (sorry for the tautology). <br>  Each particle is nothing but an object, and each object is an element of the particles array. <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addParticle</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ particles.push({ <span class="hljs-attr"><span class="hljs-attr">num</span></span>: particles.length, <span class="hljs-comment"><span class="hljs-comment">// op: random(0,0.5), // dop: random(0.002,0.008), //   r: random(3,10), // dr: random(0.5,1.5), //   a: random(0,180), // da: random(-3,3), //   x: random(249,251), //- dx: random(-0.2,0.2), //    y: random(349,351), //- dy: random(0.5,1), //    draw: /*       */ }); }</span></span></code> </pre><br>  With the code above, I think everything is clear.  Now the most interesting thing is drawing. <br>  The technology is as follows: each particle independently calculates all its new parameters (coordinates, radius, etc.).  After that, the canvas transparency changes (ctx.globalAlpha = ...).  Further, for optimization, there is a check on how much time has passed from the previous rendering, and if this time is shorter than the frame time, then the drawing is performed, otherwise, only the parameters are calculated, so that with a large load the particles do not stand still.  That is, it turns out such a samopisnaya frame skipping system.  Well, the drawing itself, which includes changes in the initial coordinates for the correct rotation of the particle (ctx.translate), directly rotates the canvas around the X and Y coordinates (ctx.rotate (angle in radians)), and draws (ctx.drawImage).  I draw attention to centering the image relative to the coordinates, drawing it needs to be ‚Äúminus half the radius‚Äù, as well as remember to convert degrees to radians (angle * Math.PI / 180). <br><pre> <code class="javascript hljs">draw: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">timer</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.op -= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.dop; <span class="hljs-comment"><span class="hljs-comment">//   if(this.op &gt; 0){ //   0,       ,     ? this.r += this.dr; //  this.a -= this.da; //  ( !) this.x -= this.dx; // - this.y -= this.dy; // - ctx.globalAlpha = this.op; //   if(window.performance.now() - time &lt; 28){ //    "",      ,      ctx.save(); //   ctx.translate(this.x,this.y); //   ctx.rotate(this.a*Math.PI/180); //  ctx.drawImage(img,-this.r/2,-this.r/2,this.r,this.r); //  ctx.restore(); //    } } }</span></span></code> </pre><br>  I hope that in this piece of code everything is explained very clearly. <br>  The next piece is the run function for all particles.  At the beginning, the call time is set (window.performance.now ()), then a new particle is added using the function described above, the canvas is cleaned, and the particle ‚Äúruns‚Äù on each particle in the loop.  At the same time, to automatically control the number of particles, we will delete the element of the array (particle) if the particle parameters are the same as when drawing it will not be visible (zero transparency, going beyond the limits of the canvas).  The function is recursive and calls itself after all the renders.  You ask why I do not use requestAnimationFrame?  and I will answer that the smoke effect itself is used by me in an online game (almost added), and when using requestAnimationFrame, the function stops being called when switching to another browser tab, and accordingly all calculations cease to be performed, which is specifically for my game not allowed (all maps about the game until I will not open =).  Actually code: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">draw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ time = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.performance.now(); <span class="hljs-comment"><span class="hljs-comment">//   addParticle(); //  info.innerHTML = particles.length; //  div   canvas.width = canvas.width; //  for(var i = 0; i &lt; particles.length; i++){ //   ,      if(particles[i].op &lt;= 0 || particles[i].x &lt; -100 || particles[i].x &gt; 600 || particles[i].y &lt; -100){ particles[i].op = 0; particles[i] = null; delete particles[i]; particles.splice(i,1); } particles[i].draw(); //    .       else,         ,      "" } setTimeout(draw, 30); //... }</span></span></code> </pre><br>  Here the writing of the code is over.  It remains only to initialize the image and perform the first call of the ‚Äúparticle run‚Äù function.  By the way, here's the picture: <br><img src="http://habrastorage.org/getpro/habr/post_images/74c/778/0d1/74c7780d1114a418f21a7e9d3a1bc633.png" alt="image"><br>  And here is the code: <br><pre> <code class="javascript hljs">img = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Image(); img.src = <span class="hljs-string"><span class="hljs-string">'smoke.png'</span></span>; img.onload = draw();</code> </pre><br>  <a href="http://orange-maker.ru/smoke">Live link</a> - by reference for clarity in various browsers changed window.performance.now () to Date.now ().  It should now work on large devices. <br>  PS Honestly I say - checked the work only in Chrome, if where it does not work - write. <br>  Sources - F12. <br>  I am waiting for adequate criticism of what is good and what is bad for you, but I hope each line is clear and correct.  See you again! </div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/185482/">https://habr.com/ru/post/185482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../185468/index.html">Digium G400 and G800 Gateways (E1 PRI)</a></li>
<li><a href="../185470/index.html">Workflow in the workflow balloon: standard and not very</a></li>
<li><a href="../185472/index.html">GlobalsDB is a universal NoSQL database. Part 2</a></li>
<li><a href="../185474/index.html">Ubisoft account leakage</a></li>
<li><a href="../185478/index.html">Students of SPbNIU ITMO became winners of the 37th Student World Programming Championship</a></li>
<li><a href="../185484/index.html">Gibson Cache Server</a></li>
<li><a href="../185488/index.html">Price of difficulty</a></li>
<li><a href="../185490/index.html">How to make a presentation using web technologies?</a></li>
<li><a href="../185492/index.html">A little about UEFI and Secure Boot</a></li>
<li><a href="../185496/index.html">Drawings in SVG format. Part 4. - Draft Standard</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>