<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Record and video processing on Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing Android applications related to video recording and processing is quite a challenge. Using standard tools, such as MediaRecorder, is not parti...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Record and video processing on Android</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/e60/8a4/9e1/e608a49e1ebd4d95b28c87fd1cb1e153.jpg"><br><br>  Writing Android applications related to video recording and processing is quite a challenge.  Using standard tools, such as MediaRecorder, is not particularly difficult, but if you try to do something that goes beyond the ordinary, real ‚Äúfun‚Äù begins. <br><a name="habracut"></a><br><h4>  What's wrong with the video on Android </h4><br>  The functionality for working with video in Android up to version 4.3 is very poor: it is possible to record video from a camera using <a href="http://developer.android.com/reference/android/hardware/Camera.html">Camera</a> and <a href="http://developer.android.com/reference/android/media/MediaRecorder.html">MediaRecorder</a> , apply standard camera color filters (sepia, black and white, etc.) and that‚Äôs probably all. <br><br>  Starting from version 4.1, it became possible to use the <a href="http://developer.android.com/reference/android/media/MediaCodec.html">MediaCodec</a> class, which gives access to low-level codecs and the <a href="http://developer.android.com/reference/android/media/MediaExtractor.html">MediaExtractor</a> class, which allows you to extract encoded media data from a source. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/519/390/7c4/5193907c46d1431e86e04818359aac89.jpg"><br></div></div><br>  In Android 4.3, the <a href="http://developer.android.com/reference/android/media/MediaMuxer.html">MediaMuxer</a> class has <a href="http://developer.android.com/reference/android/media/MediaMuxer.html">appeared</a> , which can record several video and audio streams into one file. <br><br><div class="spoiler">  <b class="spoiler_title">Scheme</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c5a/43a/d51/c5a43ad5155e46c6aac634ea7d8b5688.jpg"><br></div></div><br>  Here we already have more opportunities for creativity: the functionality allows not only to encode and decode video streams, but also to perform some video processing when recording. <br><br>  In the <a href="https://yalantis.com/blog/video-recording-app-development-how-we-built-instagram-for-videos/">project</a> I was working on, there were several application requirements: <br><br><ul><li>  Record multiple chunks of video for a total of up to 15 seconds </li><li>  "Bonding" recorded chunks into one file </li><li>  ‚ÄúFast Motion‚Äù - the effect of accelerated shooting (time-lapse) </li><li>  ‚ÄúSlow Motion‚Äù - slow motion effect </li><li>  ‚ÄúStop Motion‚Äù - recording of very short videos (consisting of a couple of frames), almost a photo in video format </li><li>  Crop video and overlay watermark (watermark) for download in the social.  network </li><li>  Overlay music on video </li><li>  Reverse video </li></ul><br><h4>  Instruments </h4><br>  Initially, the video was recorded using MediaRecorder.  This method is the easiest, has long been used, has many examples and is supported by all versions of Android.  But it defies customization.  In addition, recording starts when using MediaRecorder with a delay of about 700 milliseconds.  For recording small pieces of video, an almost second delay is unacceptable. <br><br>  Therefore, it was decided to increase the minimum compatible version of Android 4.3 and use MediaCodec and MediaMuxer to record video.  This solution eliminated the delay in initializing the recording.  For rendering and modification of frames captured from the camera, OpenGL was used in conjunction with shaders. <br><br>  The examples were taken from Google.  The project is called <a href="https://github.com/google/grafika">Grafika</a> and is a compilation of examples of <s>crutches</s> that can help you figure out how to use video recording and processing tools. <br>  For post-video processing was used <a href="https://www.ffmpeg.org/ffmpeg.html">FFmpeg</a> .  The main difficulty with ffmpeg is building the necessary modules and connecting to your project.  This is a long process requiring certain skills, so we used the <a href="http://androidwarzone.blogspot.com/2011/12/ffmpeg4android.html">ready-made assembly for Android</a> .  The peculiarity of working with the majority of such ffmpeg assemblies is such that it should be used as an executable command line file: pass a string command with input parameters and parameters that should be applied to the final video.  The lack of debugging, and indeed to find out what the error is, if something went wrong, is also very depressing.  The only source of information is the log file, which is recorded while ffmpeg is running.  Therefore, at first, it takes a lot of time to figure out how this or that team works, how to make composite commands that will perform several actions at once, etc. <br><br><h4>  Slow motion </h4><br>  From the implementation of Slow Motion at the moment refused, because the hardware support for recording video with a sufficient frame rate from the vast majority of Android devices do not.  There is also no normal possibility to ‚Äúactivate‚Äù this function even on the small fraction of devices on which there is hardware support. <br><br>  You can make a software slow-mo, for this there are options: <br><br><ul><li>  Duplicate frames when recording, or extend their duration (the time that the frame is shown). </li><li>  Record a video and then process - again - duplicating or extending each frame. </li></ul><br>  But the result is quite low quality: <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9217a8YxmFw%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhgVOfqMlJeLQdftW3CqvO8-8cihyA" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Fast motion </h4><br>  But with the recording of time-lapse video problems do not arise.  When recording with the MediaRecorder, you can set the frame rate, say, 10 (the standard frame rate for video recording is 30), and every third frame will be recorded.  As a result, the video will be accelerated 3 times. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareMediaRecorder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (camera == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } camera.unlock(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mediaRecorder == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mediaRecorder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MediaRecorder(); mediaRecorder.setCamera(camera); } mediaRecorder.setVideoSource(MediaRecorder.VideoSource.CAMERA); mediaRecorder.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4); CamcorderProfile profile = getCamcorderProfile(cameraId); mediaRecorder.setCaptureRate(<span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-comment"><span class="hljs-comment">//         mediaRecorder.setVideoSize(profile.videoFrameWidth, profile.videoFrameHeight); mediaRecorder.setVideoFrameRate(30); mediaRecorder.setVideoEncodingBitRate(profile.videoBitRate); mediaRecorder.setOutputFile(createVideoFile().getPath()); mediaRecorder.setPreviewDisplay(cameraPreview.getHolder().getSurface()); mediaRecorder.setVideoEncoder(MediaRecorder.VideoEncoder.H264); try { mediaRecorder.prepare(); } catch (Exception e) { releaseMediaRecorder(); return false; } return true; }</span></span></code> </pre> <br></div></div><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/YA4ylL8r2LU%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjXWIf0NQg_7uC1CCoS0i_V77neEQ" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Stop motion </h4><br>  For instant recording of several frames, the standard version with MediaRecorder is not suitable due to the long delay before recording starts.  But using MediaCodec and MediaMuxer solves the performance problem. <br><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/P7dvoDmrFiA%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhr8tg_zsSz8xQNd2HHawe4Kk3M3Q" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Pasting recorded pieces into one file </h4><br>  This is one of the main features of the application.  As a result, after recording several chunks, the user must receive one solid video file. <br><br>  Initially, ffmpeg was used for this, but we had to abandon this idea, because ffmpeg stuck video with transcoding, and the process was quite long (on Nexus 5, glued together 7-8 chunks in one 15-second video took more than 15 seconds, and for 100 chunks time increased to a minute or more).  If you use a higher bit rate or codecs that give better results at the same bit rate, the process took even longer. <br><br>  Therefore, the <a href="https://github.com/sannies/mp4parser">mp4parser</a> library is now used, which, in essence, pulls encoded data from container files, creates a new container, and adds the data one after another into a new container.  Then he writes the information into the container's hider and that's it, we get a solid video at the output.  The only limitation in this approach is that all chunks must be encoded with the same parameters (codec type, resolution, aspect ratio, etc.).  This approach is otrabatyvet in 1-4 seconds, depending on the number of chunks. <br><br><div class="spoiler">  <b class="spoiler_title">An example of using with mp4parser'a for pasting several video files into one</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">merge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;File&gt; parts, File outFile)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Movie finalMovie = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Movie(); Track[] tracks = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Track[parts.size()]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; parts.size(); i++) { Movie movie = MovieCreator.build(parts.get(i).getPath()); tracks[i] = movie.getTracks().get(<span class="hljs-number"><span class="hljs-number">0</span></span>); } finalMovie.addTrack(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AppendTrack(tracks)); FileOutputStream fos = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(outFile); BasicContainer container = (BasicContainer) <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DefaultMp4Builder().build(finalMovie); container.writeContainer(fos.getChannel()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { Log.e(TAG, <span class="hljs-string"><span class="hljs-string">"Merge failed"</span></span>, e); } }</code> </pre><br></div></div><br><h4>  Overlaying music on video, framing video and overlaying a watermark </h4><br>  Here you can not do ffmpeg.  For example, here‚Äôs a command that applies a sound track to the video: <br><br><pre> <code class="bash hljs">ffmpeg -y -ss 00:00:00.00 -t 00:00:02.88 -i input.mp4 -ss 00:00:00.00 -t 00:00:02.88 -i tune.mp3 -map 0:v:0 -map 1:a:0 -vcodec copy -r 30 -b:v 2100k -acodec aac -strict experimental -b:a 48k -ar 44100 output.mp4</code> </pre><br>  <b>-ss 00: 00: 00.00</b> - the time from which to start processing in this case <br>  <b>-t 00: 00: 02.88</b> - the time at which you need to continue processing the input file <br>  <b>-i input.mp4</b> - input video file <br>  <b>-i tune.mp3</b> - audio input file <br>  <b>-map</b> - video channel and audio channel mapping <br>  <b>-vcodec</b> - install the video codec (in this case, the same codec is used to encode the video) <br>  <b>-r</b> - set frame rate <br>  <b>-b: v</b> - set the bitrate for the video channel <br>  <b>-acodec</b> - install audio codec (in this case, we use AAC encoding) <br>  <b>-ar</b> - audio channel sample-rate <br>  <b>-b: a</b> - audio channel bit rate <br><br>  Team to apply watermarks and crop video: <br><br><pre> <code class="bash hljs">ffmpeg -y -i input.mp4 -strict experimental -r 30 -vf movie=watermark.png, scale=1280*0.1094:720*0.1028 [watermark]; [<span class="hljs-keyword"><span class="hljs-keyword">in</span></span>][watermark] overlay=main_w-overlay_w:main_h-overlay_h, crop=in_w:in_w:0:in_h*in_h/2 [out] -b:v 2100k -vcodec mpeg4 -acodec copy output.mp4</code> </pre><br>  <b>movie = watermark.png</b> - set the path to the watermark <br>  <b>scale = 1280 * 0.1094: 720 * 0.1028</b> - we specify the size <br>  <b>[in] [watermark] overlay = main_w-overlay_w: main_h-overlay_h, crop = in_w: in_w: 0: in_h * in_h / 2 [out]</b> - impose a watermark and trim the video. <br><br><h4>  Reverse video </h4><br>  To create a reverse video, you need to perform several manipulations: <br><br><ul><li>  Extract all frames from the video file, write them to the internal storage (for example, in jpg files) </li><li>  Rename frames to reverse their order. </li><li>  Collect from video files </li></ul><br>  The solution does not look elegant or productive, but there are no alternatives. <br><br>  An example of a command to split a video into files with frames: <br><br><pre> <code class="bash hljs">ffmpeg -y -i input.mp4 -strict experimental -r 30 -qscale 1 -f image2 -vcodec mjpeg %03d.jpg</code> </pre><br>  After that, you need to rename the frame files so that they are in reverse order (ie, the first frame will be the last, the last - the first, the second frame - the last but one, the last but one - the second, etc.) <br><br>  Then, using the following command, you can collect video from frames: <br><br><pre> <code class="bash hljs">ffmpeg -y -f image2 -i %03d.jpg -r 30 -vcodec mpeg4 -b:v 2100k output.mp4</code> </pre><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/WMlkrgCwgbA%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhjFgSD8MYGg1-pphT95T7ILr3Ogig" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Video gif </h4><br>  Also, one of the application functionals is the creation of short videos consisting of several frames, which, if looped, creates the effect of gifs.  This topic is now in demand: Instagram even recently launched Boomerang, a special application for creating such ‚Äúgifs.‚Äù <br><br>  The process is quite simple - we take 8 photos with an equal period of time (in our case, 125 milliseconds), then duplicate all the frames in the reverse order, with the exception of the first and last, in order to achieve a smooth reverse effect, and collect the frames in the video. <br><br>  For example, using ffmpeg: <br><br><pre> <code class="bash hljs">ffmpeg -y -f image2 -i %02d.jpg -r 15 -filter:v setpts=2.5*PTS -vcodec libx264 output.mp4</code> </pre><br>  <b>-f</b> - format of incoming files <br>  <b>-i% 02d.jpg</b> - input files with dynamic name format (01.jpg, 02.jpg, etc.) <br>  <b>-filter: v setpts = 2.5 * PTS</b> extend the duration of each frame 2.5 times <br><br>  At the moment, to optimize the UX (so that the user does not wait for long video processing), we create the video file itself at the stage of saving and sharing the video.  Prior to this, work happens with photos that are loaded into RAM and are drawn on Canvas'e <a href="http://developer.android.com/reference/android/view/TextureView.html">TextureView</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Drawing process</b> <div class="spoiler_text"><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawGif</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> startTime)</span></span></span><span class="hljs-function"> </span></span>{ Canvas canvas = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentFrame &gt;= gif.getFramesCount()) { currentFrame = <span class="hljs-number"><span class="hljs-number">0</span></span>; } Bitmap bitmap = gif.getFrame(currentFrame++); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { handler.notifyError(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> startTime; } destRect(frameRect, bitmap.getWidth(), bitmap.getHeight()); canvas = lockCanvas(); canvas.drawBitmap(bitmap, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, frameRect, framePaint); handler.notifyFrameAvailable(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (showFps) { canvas.drawBitmap(overlayBitmap, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); frameCounter++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((System.currentTimeMillis() - startTime) &gt;= <span class="hljs-number"><span class="hljs-number">1000</span></span>) { makeFpsOverlay(String.valueOf(frameCounter) + <span class="hljs-string"><span class="hljs-string">"fps"</span></span>); frameCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; startTime = System.currentTimeMillis(); } } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Timber.e(e, <span class="hljs-string"><span class="hljs-string">"drawGif failed"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (canvas != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { unlockCanvasAndPost(canvas); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> startTime; }</code> </pre><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GifViewThread</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Thread</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> startTime = System.currentTimeMillis(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isPlaying()) { gif.initFrames(); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { Timber.e(e, <span class="hljs-string"><span class="hljs-string">"initFrames failed"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Timber.d(<span class="hljs-string"><span class="hljs-string">"Loading bitmaps in "</span></span> + (System.currentTimeMillis() - startTime) + <span class="hljs-string"><span class="hljs-string">"ms"</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> drawTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (running) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (paused) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Thread.sleep(<span class="hljs-number"><span class="hljs-number">10</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (InterruptedException ignored) {} <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (surfaceDone &amp;&amp; (System.currentTimeMillis() - drawTime) &gt; FRAME_RATE_BOUND) { startTime = drawGif(startTime); drawTime = System.currentTimeMillis(); } } } }</code> </pre><br></div></div><br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/ZiHdOYAk15U%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700248,15700253&amp;usg=ALkJrhhK9HV6nQBFy0Gti8y3zr4A4q7C9g" frameborder="0" allowfullscreen=""></iframe><br><br><h4>  Conclusion </h4><br>  In general, working with video on the Android platform is still a pain.  It takes a lot of time to implement more or less advanced applications, the <s>crutches of</s> non-standard solutions and, most likely, the deepening in JNI.  Worst of all, on the iOS platform, a lot of things work out of the box or with much less labor.  In future plans, I would like to make my ffmpeg assembly and use it at the JNI level, which will increase productivity, flexibility in use, as well as reduce the overall weight of the library (since not all modules are needed in the project). </div><p>Source: <a href="https://habr.com/ru/post/272705/">https://habr.com/ru/post/272705/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../272693/index.html">Microsoft fixed a dangerous vulnerability in Windows Server</a></li>
<li><a href="../272695/index.html">As I have been rewriting my cryptocurrency with PHP for Go for 8 months. Part 1</a></li>
<li><a href="../272697/index.html">Optimizing hyperparameters in Vowpal Wabbit with the new vw-hyperopt module</a></li>
<li><a href="../272701/index.html">How to graze cats. The history of building a system of control and accounting of working time for an IT company</a></li>
<li><a href="../272703/index.html">The WikiLeaks Revolution: The Digest of Mishaps</a></li>
<li><a href="../272707/index.html">Bit magic: getting the next lexicographic combination</a></li>
<li><a href="../272709/index.html">Site navigation - burping a bygone era</a></li>
<li><a href="../272711/index.html">Simple metasearch algorithm in Python</a></li>
<li><a href="../272713/index.html">Monte Carlo simulation in Mathcad Express</a></li>
<li><a href="../272715/index.html">Speak at CodeFest</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>