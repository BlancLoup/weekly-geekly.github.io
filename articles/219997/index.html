<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Serialization of objects in MultiCAD.NET. Management of compatibility of drawings and proxies</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When creating custom objects on the traditional C ++ API (NRX in nanoCAD, ObjectARX in AutoCAD), it is necessary to explicitly describe the recording ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Serialization of objects in MultiCAD.NET. Management of compatibility of drawings and proxies</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/904/65c/074/90465c0741968fcc051896b8faa92dff.png"><br>  When creating custom objects on the traditional C ++ API (NRX in nanoCAD, ObjectARX in AutoCAD), it is necessary to explicitly describe the recording (serialization) and reading (deserialization) of each field to ensure the objects are stored and read from the drawing file.  The MultiCAD.NET API uses a more familiar .NET to developers a descriptive approach based on standard .NET serialization. <br><br>  The use of serialization, insensitive to the version of objects (Version Tolerance Serialization), provides developers with a more flexible mechanism for managing the compatibility of objects of different versions than the traditional C ++ API, which provides for reading previous versions, but reading files "from the future" is impossible. <br><br>  In MultiCAD.NET, when describing new versions of objects, you can specify that the newly added fields are optional, and then the drawing saved in the format of the new version of the application will be read in the previous version.  Of course, the traditional approach remained unchanged, leading to the creation of proxy objects (cached graphics of objects) when the drawing was loaded into the previous version of the application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Under the cat, we will discuss how to achieve compatibility of the two versions of the object, as well as how to ensure the traditional level of compatibility when new versions of the application read old drawings, but not vice versa. <br><a name="habracut"></a><br><br>  Let's look at how MultiCAD.NET uses both of these approaches (VTS and the proxy object mechanism) to organize the management of object compatibility.  As a visual example, consider the two versions of the cross tag user object. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/86f/237/1c2/86f2371c2a47ccdadbda3bcd45bd854e.png"><br><br><h4>  Creating a class for experiments </h4><br>  We described the basics of creating custom primitives in MultiCAD.NET in one of the previous <a href="http://habrahabr.ru/company/nanosoft/blog/184482/">articles</a> , so we will not dwell on this, but go straight to the description of the ‚ÄúCross Mark‚Äù user primitive: <br><br><pre><code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CustomEntity(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"1C925FA1-842B-49CD-924F-4ABF9717DB62"</span></span></span><span class="hljs-meta">, 1, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Crossmark"</span></span></span><span class="hljs-meta">, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Crossmark Sample Entity"</span></span></span><span class="hljs-meta">)</span></span>] [Serializable] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CrossMark</span></span> : <span class="hljs-title"><span class="hljs-title">McCustomBase</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Point3d pnt1; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Point3d pnt2; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Point3d pnt3; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Point3d pnt4; }</code> </pre> <br>  The full application code is available <a href="">here</a> .  After compiling the application and launching it with <i>the crossmark</i> command <i>based</i> on the result of user input, the following primitive will be added to the drawing: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/85e/f56/2ca/85ef562ca28884c62e9bba69cbd7440c.gif" alt="image"><br><br>  Save the resulting .dwg file.  Now we will slightly change our class, adding additional functionality to it. <br><br><h4>  The second version of the class and ensuring interversion compatibility of objects </h4><br>  In the second version of the class, we will change the geometry of our primitive by adding a circle to the center of the cross mark.  As an additional field, add the radius of this circle, supplying it with the <code>[OptionalField]</code> attribute to mark it as optional if the earlier version of the object is deserialized.  We also indicate the new version number using the <code>VersionAdded</code> property: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">OptionalField(VersionAdded = 2)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> radius = <span class="hljs-number"><span class="hljs-number">-1</span></span>;</code> </pre><br>  Initialize a new variable in the constructor and add a public property to access this field: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CrossMark</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ... radius = <span class="hljs-number"><span class="hljs-number">10</span></span>; } [Category(<span class="hljs-string"><span class="hljs-string">"Circular component"</span></span>)] [DisplayName(<span class="hljs-string"><span class="hljs-string">"Circle radius"</span></span>)] [Description(<span class="hljs-string"><span class="hljs-string">"Radius of circular component of the cross mark"</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> Radius { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> radius; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { radius = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre><br>  In order to initiate the added field after deserializing an object with a correct value, the <code>OnDeserialized</code> method with the <code>[OnDeserialized]</code> attribute will be used: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">OnDeserialized</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDeserialized</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">StreamingContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (radius == <span class="hljs-number"><span class="hljs-number">-1</span></span>) { radius = <span class="hljs-number"><span class="hljs-number">10</span></span>; } }</code> </pre><br><br>  Now applications that work with newer versions of the type can also accept objects of older versions.  In addition, VTS also solves the problem of backward compatibility: applications that work with old versions of objects can accept new versions: the ‚Äúredundant‚Äù fields are simply ignored and the deserialization is successful. <br><br>  Thus, we ensured full compatibility of our class versions.  It remains only to add a circle drawing to the <code>OnDraw()</code> method: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnDraw</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">GeometryBuilder dc</span></span></span><span class="hljs-function">)</span></span> { ... dc.DrawCircle(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point3d(pnt1.X + <span class="hljs-number"><span class="hljs-number">25</span></span>, pnt1.Y, pnt1.Z), radius); }</code> </pre><br>  The full code of the second version of the application is also available in the <a href="">archive</a> .  We compile the project, run nanoCAD, load the built assembly, and launch the new version of the application with the same <i>‚Äúcrossmark‚Äù</i> command.  After specifying the insertion point, we obtain the .dwg file with the updated version of our primitive: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/653/6ca/b6a/6536cab6a1e8d33ef94d49be74c66f27.gif" alt="image"><br><br>  We also save the resulting file. <br><br><h5>  results </h5><br>  And now we will be convinced of full compatibility of both versions. <br><br>  Run nanoCAD, load the second version of the assembly and open the first version of the file.  The file will be successfully opened and the primitive saved in the first version is waiting for us on the screen.  As soon as any action is taken that leads to object redrawing (for example, moving) the object will be redrawn in the new version taking into account the serialization constructor's work: the cross mark will be drawn with a circle of a given radius.  The <i>REGENOBJ</i> command can also be used for <i>this</i> . <br>  Close the file.  Download the first version of the application and open the second version of the file.  The file will also successfully load and the second version object will initially be drawn, as it was saved in the file.  After redrawing, the cross mark will be displayed in the form that was defined in the first version. <br><br><h4>  The traditional approach.  Top down compatibility </h4><br>  The VTS mechanism, which ensures compatibility from the bottom up, is not always applicable, since not all the data in new versions of objects can be considered insignificant.  In order to ensure compatibility from top to bottom, when creating a new version of an object, you need to use the following attribute: <br><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">CustomEntity(guid, majorVersion, databaseName, localName)</span></span>]</code> </pre><br>  Here, the <code>majorVersion</code> property specifies the main version of the object, within which full compatibility will be ensured.  If new objects are created with a <code>majorVersion</code> whose value is greater than the previous one, then an attempt to open such objects with an older version of the code will result in the return code <code>eMakeMeProxy</code> .  In this case, the objects in the drawing will be represented as proxy objects, which excludes the possibility of changing and editing them. <br><br><h4>  Conclusion </h4><br>  In this article, we looked at an example of creating two versions of a user object and the process of managing compatibility between versions in the simplest case ‚Äî adding additional data fields to a new version.  We will discuss the compatibility of versions of user objects with more serious changes, such as deleting, renaming fields, or changing their types in one of the following articles. <br><br>  Discussion of the article is also available on our forum: <a href="http://forum.nanocad.ru/index.php%3Fshowtopic%3D6515">forum.nanocad.ru/index.php?showtopic=6515</a> . <br>  Translation of the article into English: <a href="http://developer.nanocad.com/blog/2014/11/25/serializing-objects-in-multicad-net-managing-drawings-compatibility-and-proxy-objects/">Serializing objects in MultiCAD.NET.</a>  <a href="http://developer.nanocad.com/blog/2014/11/25/serializing-objects-in-multicad-net-managing-drawings-compatibility-and-proxy-objects/">Managing drawings compatibility and proxy objects</a> . </div><p>Source: <a href="https://habr.com/ru/post/219997/">https://habr.com/ru/post/219997/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../219987/index.html">The first launch of the SpaceX Falcon-9 rocket with folding supports for landing was successful</a></li>
<li><a href="../219989/index.html">History of checkers (in illustrations)</a></li>
<li><a href="../219991/index.html">Telepresence Tod Bot - go for coffee without getting up from the table</a></li>
<li><a href="../219993/index.html">Encoding of binary data into a string with an arbitrary length alphabet (BaseN)</a></li>
<li><a href="../219995/index.html">jWidget - object-oriented JavaScript MV * framework</a></li>
<li><a href="../219999/index.html">Arbitrary order of template initialization list</a></li>
<li><a href="../220001/index.html">Kenju fork Kendo UI Web (GPL3)</a></li>
<li><a href="../220003/index.html">How browsers implement digital certificate revocation</a></li>
<li><a href="../220005/index.html">Some interesting and useful things for web developer # 16</a></li>
<li><a href="../220007/index.html">Zalman ZM-VE400 Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>