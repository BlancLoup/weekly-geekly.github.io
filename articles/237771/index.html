<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A little bit about WebKit internals</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I set myself with the task, get acquainted with how the basis of all modern browsers works in one form or another - WebKit, how the resource loading p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A little bit about WebKit internals</h1><div class="post__text post__text-html js-mediator-article">  I set myself with the task, get acquainted with how the basis of all modern browsers works in one form or another - WebKit, how the resource loading process takes place, and what can be done with this all.  Documentation on the issue, in principle, is enough: <br><br>  * structured, but not covering, and the 10th part of <a href="https://developer.apple.com/library/mac/documentation/Cocoa/Conceptual/DisplayWebContent/DisplayWebContent.html">Apple</a> ; <br>  * <a href="http://trac.webkit.org/wiki">scattered articles on the wiki</a> , different in the degree of detail and degree of coverage. <br><br>  The purpose of this article is not a general view of the system from above, but just a point and detailed analysis of one of the processes occurring in the system.  Which, in my opinion, sometimes gives a better idea of ‚Äã‚Äãthe system as a whole than an abstract look.  Or maybe it will just be a small brick that the developer will need to compile information about the system from a scattered mosaic of information. <br><a name="habracut"></a><br><h5>  Structure </h5><br><ul><li>  WebKit1 - external api, de facto for each port; </li><li>  WebKit2 - its new version, I did not work with it; </li><li>  JavascriptCore - JavaScript engine; </li><li>  WTF - Web Template Framework; </li><li>  ThirdParty - a set of third-party libraries, in particular leveldb; </li><li>  WebCore is the basic functionality of WebKit.  Just about him and most of the text.  All the functionality is loaded into the WebCore namespace.  Consists of subprojects: <br><ul><li>  loader - WebCore :: FrameLoader, WebCore :: DocumentLoader, WebCore :: DocumentWriter is from there, in general, everything related to communication Document &lt;-&gt; the outside world is there; </li><li>  dom - Document Object Model.  WebCore :: Document; </li><li>  html - WebCore :: HTMLDocument is the heir of WebCore :: Document, WebCore :: PluginDocument, WebCore :: HTMLElement, its heirs are WebCore :: HTMLAnchorElement, and so on.  The implementation of the HTML document model. <br></li><li>  page - WebCore :: Frame, WebCore :: History, WebCore :: ContextMenu - everything related to the UI or simply to high-level communication (Browser history, for example); </li><li>  platform - Specific functional implementations for different ports; </li><li>  rendering, css, svg, storage, plugins, inspector - the names speak for themselves.  Details are not considered. </li></ul><br></li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Document loading process, <i>loader</i> </h5><br>  <b>programm1.c</b> <br><pre><code class="hljs xml">mainWidget = new QWebView(parent); // mainWidget-&gt;setHtml("<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>HEIL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>"); mainWidget-&gt;page()-&gt;mainFrame()-&gt;setHtml( "<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>HEIL<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>",QUrl() );</code> </pre> <br><br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">QWebFrame</span></span>::setHtml() ‚Üí <span class="hljs-type"><span class="hljs-type">QWebFrameAdapter</span></span>::setHtml // qt/qtwebkit/<span class="hljs-type"><span class="hljs-type">Source</span></span>/<span class="hljs-type"><span class="hljs-type">WebKit</span></span>/qt/<span class="hljs-type"><span class="hljs-type">WebCoreSupport</span></span>/<span class="hljs-type"><span class="hljs-type">QWebFrameAdapter</span></span>.cpp:<span class="hljs-number"><span class="hljs-number">284</span></span> ... ‚Üí <span class="hljs-type"><span class="hljs-type">WebCore</span></span>::<span class="hljs-type"><span class="hljs-type">FrameLoader</span></span>::load // frame-&gt;loader()-&gt;load(<span class="hljs-type"><span class="hljs-type">WebCore</span></span>::<span class="hljs-type"><span class="hljs-type">FrameLoadRequest</span></span>(frame, request, substituteData)); // <span class="hljs-string"><span class="hljs-string">"request"</span></span> description <span class="hljs-type"><span class="hljs-type">WebCore</span></span>::<span class="hljs-type"><span class="hljs-type">FrameLoadRequest</span></span>( <span class="hljs-type"><span class="hljs-type">WebCore</span></span>::<span class="hljs-type"><span class="hljs-type">Frame</span></span> <span class="hljs-type"><span class="hljs-type">WebCore</span></span>::<span class="hljs-type"><span class="hljs-type">ResourceRequest</span></span> // <span class="hljs-type"><span class="hljs-type">Request</span></span> <span class="hljs-type"><span class="hljs-type">Description</span></span> -   <span class="hljs-type"><span class="hljs-type">WebCore</span></span>::<span class="hljs-type"><span class="hljs-type">SubstituteData</span></span> // <span class="hljs-type"><span class="hljs-type">Data</span></span> description - qt/qtwebkit/<span class="hljs-type"><span class="hljs-type">Source</span></span>/<span class="hljs-type"><span class="hljs-type">WebCore</span></span>/loader/<span class="hljs-type"><span class="hljs-type">SubstituteData</span></span>.h // <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> - </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WTF</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RefPtr</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WebCore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SharedBuffer</span></span></span><span class="hljs-class">&gt; // mime-</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> - "text/html" // encoding - "utf-8" // failingURL ) ) ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoaderClientQt</span></span></span><span class="hljs-class">::createDocumentLoader() // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RefPtr</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">&gt; loader = m_client-&gt;createDocumentLoader(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">request</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">substitute_data</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WebCore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoaderClient</span></span></span><span class="hljs-class">() ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoader</span></span></span><span class="hljs-class">::load(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">newDocumentLoader</span></span></span><span class="hljs-class">) // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoader</span></span></span><span class="hljs-class">::load(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">()) newDocumentLoader.m_frame = 0 ; ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoader</span></span></span><span class="hljs-class">::loadWithDocumentLoader(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">newDocumentLoader</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, 0) ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoader</span></span></span><span class="hljs-class">::loadWithDocumentLoader(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loader</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoadType</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PassRefPtr</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FormState</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prpFormState</span></span></span><span class="hljs-class">) ... setPolicyDocumentLoader(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">loader</span></span></span><span class="hljs-class">); //       m_frame  loader. ‚Üí loader‚ÜísetFrame(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_frame</span></span></span><span class="hljs-class">); ‚Üí m_writer.setFrame(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">frame</span></span></span><span class="hljs-class">); ... // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Check</span></span></span><span class="hljs-class"> policies and with callback jump to callContinueLoadAfterNavigationPolicy via static jumper </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoader</span></span></span><span class="hljs-class">::callContinueLoadAfterNavigationPolicy(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceRequest</span></span></span><span class="hljs-class">&amp;, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PassRefPtr</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FormState</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">formState</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bool</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shouldContinue</span></span></span><span class="hljs-class"> ) ‚Üí //   : m_policyDocumentLoader.get()-&gt;substituteData().content()-&gt;</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(); setProvisionalDocumentLoader(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_policyDocumentLoader</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">()); // m_provisionalDocumentLoader = m_policyDocumentLoader.get(); </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoader</span></span></span><span class="hljs-class">::continueLoadAfterWillSubmitForm // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">RefPtr</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">&gt; m_provisionalDocumentLoader; m_provisionalDocumentLoader‚ÜístartLoadingMainResource // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::m_mainResource - </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CachedResourceHandle</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CachedRawResource</span></span></span><span class="hljs-class">&gt; // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceRequest</span></span></span><span class="hljs-class"> m_request; //    m_substituteData.content()-&gt;</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">() ‚Üí handleSubstituteDataLoadSoon ‚Üí handleSubstituteDataLoadNow </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">WebCore</span></span></span><span class="hljs-class">::</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceResponse</span></span></span><span class="hljs-class"> response(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">url</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_substituteData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mimeType</span></span></span><span class="hljs-class">(), m_substituteData.content()‚Üísize(), m_substituteData.textEncoding(), ""); ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::responseReceived(0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">) // responseReceived(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CachedResource</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">resource</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ResourceResponse</span></span></span><span class="hljs-class">&amp; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">response</span></span></span><span class="hljs-class">) m_response = response; // m_m_identifierForLoadWithoutResourceLoader=1 // notifier()       </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">View</span></span></span><span class="hljs-class"> . ‚Üí frameLoader()‚Üínotifier()‚ÜídispatchDidReceiveResponse(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_identifierForLoadWithoutResourceLoader</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_response</span></span></span><span class="hljs-class">, 0); ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::continueAfterContentPolicy(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PolicyUse</span></span></span><span class="hljs-class">); // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PolicyUse</span></span></span><span class="hljs-class"> is enum val enum </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PolicyAction</span></span></span><span class="hljs-class"> {</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PolicyUse</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PolicyDownload</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PolicyIgnore</span></span></span><span class="hljs-class">}; // m_response.isHTTP()=0 isLoadingMainResource()=1 isStopping()=0 ... ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::dataReceived(0, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_substituteData</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class">()‚Üí</span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class">(), m_substituteData.content()‚Üísize()); ‚Üí frameLoader()‚Üínotifier()‚ÜídispatchDidReceiveData(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">m_identifierForLoadWithoutResourceLoader</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">, -1); ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::commitLoad(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">) // </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> ‚Äì our html </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> ‚Üí frameLoader‚Üíclient()‚ÜícommittedLoad(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">this</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">); // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoaderClient</span></span></span><span class="hljs-class">::committedLoad ‚Üí </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">FrameLoaderClientQt</span></span></span><span class="hljs-class">::committedLoad ‚Üí void </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentLoader</span></span></span><span class="hljs-class">::commitData(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bytes</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size_t</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">) // loader-&gt;commitData(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">) ‚Äì     </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentWriter</span></span></span><span class="hljs-class">,  documentLoader   m_frame. m_writer.begin(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">documentURL</span></span></span><span class="hljs-class">(), false); m_writer.setDocumentWasLoadedAsPartOfNavigation(); ‚Üí void m_writer.addData(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bytes</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">length</span></span></span><span class="hljs-class">); // </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DocumentWriter</span></span></span><span class="hljs-class">::addData ... ‚Üí finishLoading(0)</span></span></code> </pre><br><br>  The callstack above is a chain of calls from setHtml to communication with the Document.  If you are interested in the process of placing the policy and various types of data download, then you need to dig there.  I threw out part of the transitions, leaving in my opinion only those that reflect any meaningful operation. <br>  The process that interests us in the callstack above is the start of writing to the document and what is needed for that.  By looking at exactly how DocumentWriter prepares in DocumentLoader :: commitData, you can ‚Äúsimplify‚Äù programm1.cpp (not in the sense of code, but in the sense of approaching it ‚Äúto the ground‚Äù). <br><br>  <b>programm2.c</b> <br><br><pre> <code class="hljs php"> QWebPage *page = mainWidget-&gt;page(); QWebFrame *qtWebFrame = mainWidget-&gt;page()-&gt;mainFrame(); QWebFramePrivate *qtWebFramePrivate = qtWebFrame-&gt;d; WebCore::Frame *frame = qtWebFramePrivate-&gt;frame; WebCore::DocumentWriter m_writer(frame); m_writer.setFrame(frame); m_writer.begin(url, <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>); m_writer.setDocumentWasLoadedAsPartOfNavigation(); m_writer.setEncoding(<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); m_writer.addData(html ,strlen(html) ); m_writer.end();</code> </pre><br><br>  In the same way, you need to go down below - before parsing (the WebCore :: DocumentParser family of classes).  Writer cannot get rid of the interlayer completely: the appendBytes call contains a writer, plus the Writer is responsible for creating the decoding interface and communicating with the <code>View: DocumentWriter::reportDataReceived</code> - <code>m_frame-&gt;document()-&gt;recalcStyle(Node::Force).</code> <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">void</span></span> DecodedDataDocumentParser::appendBytes(DocumentWriter* writer, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* data, <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> length) { ... String decoded = writer-&gt;createDecoderIfNeeded()-&gt;decode(data, length); ... writer-&gt;reportDataReceived(); ... }</code> </pre><br><br>  Introducing initialization steps from DocumentWriter :: begin, we get programm3.cpp: <br><br>  <b>programm3.cpp</b> <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> *html = <span class="hljs-string"><span class="hljs-string">"&lt;html&gt;&lt;body&gt;HEIL&lt;b&gt;IGO&lt;/b&gt;&lt;script&gt;document.write(1234);&lt;/script&gt;&lt;/body&gt;&lt;/html&gt;"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> htmlen = <span class="hljs-built_in"><span class="hljs-built_in">strlen</span></span>(html); RefPtr&lt;WebCore::Document&gt; document = WebCore::DOMImplementation::createDocument(<span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, frame, url, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); document-&gt;createDOMWindow(); frame-&gt;setDocument(document); document-&gt;implicitOpen(); frame-&gt;script()-&gt;updatePlatformScriptObjects(); RefPtr&lt;WebCore::DocumentParser&gt; parser = document-&gt;parser(); WebCore::<span class="hljs-function"><span class="hljs-function">DocumentWriter </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">writer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(frame)</span></span></span></span>; m_parser-&gt;appendBytes(&amp;writer,html ,htmlen); m_parser-&gt;finish();</code> </pre><br><br><h5>  PS </h5><br>  On this my journey to WebKit is suspended.  I hope that for someone this text will lower the point of entry into the project. <br><br>  The last section contains recipes for quickly deploying an environment for experimentation. <br><br><h6>  Compilation </h6><br>  The basis was the <i>qt-everywhere-opensource-src-5.3.1</i> package.  From there it is not necessary to take everything - it is enough qtbase i qtwebkit.  When building, I ran into the following problem: a static build with the -debug ( <i>./configure -static -debug</i> ) flag enabled creates sub-libraries that I did not manage to link to the working example on an 8GB machine.  Well, even if you wait, linking is an option, waiting for a few minutes of recompiling the simplest examples is not very suitable.  Without symbol info, linking takes a couple of seconds, <i>libWebkit.a</i> ~ 54Mb itself. <br><br>  There is another problem with the shared library: qt - does not export the webkita API, but hides it behind its own.  It is treated with " <i>-fvisibility = default</i> " instead of <i>hidden</i> .  For a hack, this is enough - there are no overlapping names in the library, for a normal project, it is necessary to long and <i>tediously rewrite</i> definitions of exported functions using <i>WTF_EXPORT</i> directives.  About <a href="https://trac.webkit.org/wiki/ExportingSymbols">exporting there is information here</a> , but it did not help me. <br><br>  It is also necessary to disclose access to <i>WebCore to the</i> world from <i>QWebFrame</i> ( <i>qtwebkit / Source / WebKit / qt / WidgetApi / qwebframe.h</i> ) - the implementation is hidden behind the private variable <code>QWebFramePrivate* QWebFrame::d</code> - it should be made public.  Then to WebCore :: Frame it will be possible to reach through <br> <code>WebCore::Frame *frame = [ QWebView ]-&gt;page()-&gt;mainFrame()-&gt;d-&gt;frame; <br></code> <br><br>  For tests, I, nevertheless, recommend a dynamic build, otherwise neither gdb nor just linking will give you any pleasure.  Here are my approximate settings: <br><br>  <i>cd ./qtbase</i> <i><br></i>  <i>./configure -opensource -confirm-license -release -nomake tools -nomake examples -no-compile-examples -no-opengl -no-openvg -no-egl -no-eglfs -no-sql-sqlite2 -D QT_NO_GRAPHICSVIEW -D QT_NO_GRAPHICSEFFECT -D QT_NO_STYLESHEET -D QT_NO_STYLE_CDE -D QT_NO_STYLE_CLEANLOOKS-how-itable (de). -no-kms -no-libudev -no-linuxfb -no-mtdev -no-nis -no-pulseaudio -no-sm -no-xinerama -no-xinput2 -no-xkb -no-xrender -openssl -openssl-linked -icu -fontconfig -system-freetype -system-libpng -system-libjpeg -system-zlib -qt-pcre -qt-harfbuzz -qt-sql-sqlite -qt-xcb -debug</i> <i><br></i>  <i>make -j 8</i> <i><br><br></i>  <i>cd ../qtwebkit</i> <i><br></i>  <i>../qtbase/bin/qmake WEBKIT_CONFIG- = use_glib \ use_gstreamer \ use_gstreamer010 \ use_native_fullscreen_video \ legacy_web_audio \ web_audio \ video \ gamepad -o Makefile.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore.Target WebKit.WebCore</i> <i><br><br></i>  <i># remove -fvisibility = default from received make, this can also be done with an option.</i> <i><br><br></i>  <i>make -f Makefile.WebCore.Target -j 8</i> <i><br></i> <br><br>  It remains to pick up all the libraries from <code>../lib/</code> and you can link the project.  The minimum required was: <br><br><pre> <code class="bash hljs">libQt5Core.so libQt5Gui.so libQt5PrintSupport.so libQt5WebKit.so libQt5WebKitWidgets.so libQt5Widgets.so libQt5Newtork.so libQt5Core.so.5 libQt5Gui.so.5 libQt5PrintSupport.so.5 libQt5WebKit.so.5 libQt5WebKitWidgets.so.5 libQt5Widgets.so.5 libQt5Network.so.5</code> </pre><br><br><h6>  Build issues </h6><br>  If you saw: <br> <code>This application failed to start because it could not find or load the Qt platform plugin "xcb".</code> <br>  So for a static build, you forgot: <br> <code>Q_IMPORT_PLUGIN(QXcbIntegrationPlugin) <br></code> <br>  And for dynamic, either <i>libxcb.so is</i> lost, or if you have <i>built qtbase</i> with the <i>-qt-xcb key,</i> you need to create a ./platforms folder with the <i>qt / qtbase / plugins / platforms</i> in the project (just one <i>libqxcb.so</i> file is <i>enough</i> ). <br><br>  When compiling the test module, you need to <s>disable the inline functions ( <i>-fno-inline-small-functions</i> ) or</s> take the entire list of defines with which the library was compiled, otherwise, since you use the same includes as the compiled WebKit, you will have to keep track of all get into the headline.  In WebCore :: Document, my client code due to this error for the m_parser variable lost 8 bytes in offset, and they appeared ‚Äî errors ‚Äî in a wide variety of places. </div><p>Source: <a href="https://habr.com/ru/post/237771/">https://habr.com/ru/post/237771/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../237761/index.html">NeuroSky: a generator of software and hardware neurostartaps</a></li>
<li><a href="../237763/index.html">NASA Solve website and a contest of ideas for turning ballast in descent vehicles into payload</a></li>
<li><a href="../237765/index.html">Overview of decentralized technology. Part 1</a></li>
<li><a href="../237767/index.html">Six steps to prepare data for analytic CRM</a></li>
<li><a href="../237769/index.html">Prospects and difficulties of Mesh-networks in the market of mobile applications</a></li>
<li><a href="../237773/index.html">Implementing a client-server web-based application using OWIN</a></li>
<li><a href="../237775/index.html">The main question of life, the universe and all that, or Time to start</a></li>
<li><a href="../237779/index.html">What to do with a dusty GPU if you are a pentester. Part 1: Legacy ATI / AMD RADEON</a></li>
<li><a href="../237783/index.html">Error teams in the accelerator: how to attract the next round of investment</a></li>
<li><a href="../237785/index.html">Technology categorization: MP3 and iPod</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>