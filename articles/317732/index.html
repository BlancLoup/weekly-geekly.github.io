<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Chatbot on the basis of a recurrent neural network do-it-yourself for 1 evening / $ 6 and ~ 100 lines of code</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I want to show how easy it is today to use neural networks. Around me, quite a few people are obsessed with the idea that only a resea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Chatbot on the basis of a recurrent neural network do-it-yourself for 1 evening / $ 6 and ~ 100 lines of code</h1><div class="post__text post__text-html js-mediator-article">  In this article I want to show how easy it is today to use neural networks.  Around me, quite a few people are obsessed with the idea that only a researcher can use neurons.  And in order to get at least some exhaust, you need to have at least a Ph.D.  And let's take a real example to see how it really is, to take a chatbot from scratch in one evening.  Yes, not just anyhow than the most that the tube <a href="https://www.tensorflow.org/">TensorFlow</a> .  At the same time, I tried to describe everything so simply that it would be understandable even to a novice programmer!  Let's hit the road! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9c1/388/17d/9c138817dc622c1faf4d7742ab9ebb5f.png" alt="image"><br><a name="habracut"></a><br><h2>  The steps to go on our thorny path </h2><br><ol><li>  It is necessary to find an implementation of a neuronny network that can be used for our purpose. </li><li>  Prepare data (corpus) that can be used for training. </li><li>  To train a model. </li></ol><br>  Special thanks to my patrons who made this article possible: <br>  Aleksandr Shepeliev, Sergei Ten, Alexey Polietaiev, Nikita Penzin, Karnaukhov Andrey, Matveev Evgeny, Anton Potemkin.  You too can be one of them <a href="https://www.patreon.com/b0noi">here</a> . <br><br><h3>  A neuron implementation that can be used for our purpose. </h3><br>  TensorFlow includes an implementation of the <a href="https://github.com/tensorflow/tensorflow/tree/r0.11/tensorflow/models/rnn/translate">RNN (Recurrent Neural Network), which is used to train the translation model for English / French language pairs</a> .  It is this implementation that we will use to train our chat bot. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Probably, someone might ask: ‚ÄúWhy the hell are we looking at learning the translation model, if we do a chat bot?‚Äù.  But this may seem strange only at the first stage.  Think for a second what is a ‚Äútranslation‚Äù?  Translation can be presented as a process in two stages: <br><br><ol><li>  Create a language-independent representation of the incoming message. </li><li>  Displaying the information received in the first step in the target language. </li></ol><br>  Now think about it, but what if we train the same RNN model, but instead of Eng / Fre couples, we will substitute Eng / Eng dialogs from movies?  In theory, we can get a chat bot that is able to answer simple single-line questions (without the ability to memorize the context of the dialogue).  This should be quite sufficient for our first bot.  Plus, this approach is very simple.  Well, in the future, we can, starting from our first implementation, make the chat bot more reasonable. <br><br>  Later we will learn how to train more complex networks that are more suitable for chat bots (for example <a href="http://www.wildml.com/2016/07/deep-learning-for-chatbots-2-retrieval-based-model-tensorflow/">retrieval-based models</a> ). <br><br>  For the impatient: the picture at the beginning of the article is actually an example of a conversation with a bot after only 50 thousand educational iterations.  As you can see, the bot is able to give more or less informative answers to some questions.  The quality of the bot improves with the number of iterations of training.  For example, here‚Äôs how stupid he answered after the first 200 iterations: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/938/1fd/372/9381fd372e016feb35fe566252772d4e.png" alt="image"><br><br>  This simple approach also allows us to create bots with different characters.  For example, it would be possible to teach him on the dialogues from the saga ‚ÄúStar Wars‚Äù or ‚ÄúLord of the Rings‚Äù.  Moreover, if a bot has a sufficiently large corpus of dialogue of the same hero (for example, all the Chandler dialogues from the film ‚ÄúFriends‚Äù), then you can create a bot of this hero. <br><br><h3>  Data preparation (corpus) for training </h3><br>  To train our first bot, we will use the corpus of conversations from the movies ‚Äú <a href="https://www.cs.cornell.edu/~cristian/Cornell_Movie-Dialogs_Corpus.html">Cornell Movie Dialogs Corpus</a> ‚Äù.  To use it, we need to convert the dialogues into the type necessary for learning.  <a href="https://github.com/b0noI/dialog_converter">For this, I prepared a small script</a> . <br><br>  I would strongly recommend that you read the README file in order to understand more about the corpus and what this script does, and only then continue reading the article.  However, if you just need commands that you can blindly copy and execute to get the data ready for learning, here they are: <br><br><pre><code class="hljs erlang-repl">tmp# git clone https://github.com/b0noI/dialog_converter.git Cloning into <span class="hljs-string"><span class="hljs-string">'dialog_converter'</span></span>‚Ä¶ remote: Counting objects: <span class="hljs-number"><span class="hljs-number">59</span></span>, done. remote: Compressing objects: <span class="hljs-number"><span class="hljs-number">100</span></span><span class="hljs-comment"><span class="hljs-comment">% (49/49), done. remote: Total 59 (delta 33), reused 20 (delta 9), pack-reused 0 Unpacking objects: 100% (59/59), done. Checking connectivity‚Ä¶ done. tmp# cd dialog_converter dialog_converter git:(master)# python converter.py dialog_converter git:(master)# ls LICENSE README.md converter.py movie_lines.txt train.a train.b</span></span></code> </pre> <br>  By the end of the run, you will have 2 files that you can use for further study: train.a and train.b <br><br><h3>  Model training </h3><br>  This is the most exciting part.  In order to train the model, we must: <br><ol><li>  Find a machine with a powerful and supported TensorFlow (which is very important) video card (read: NVIDIA). </li><li>  Modify the original ‚Äútranslate‚Äù script, which is used to train the Eng / Fre. Translation model. </li><li>  Prepare the machine for training. </li><li>  Start learning. </li><li>  Wait. </li><li>  Wait. </li><li>  Wait. </li><li>  I'm serious ... You have to wait. </li><li>  Profit. </li></ol><br><h4>  In search of <s>Atlantis</s> learning machines </h4><br>  In order to make this process as simple as possible, I will use the compiled AMI - ‚Äú <a href="https://aws.amazon.com/marketplace/pp/B01EYKBEQ0/">Bitfusion TensorFlow AMI</a> ‚Äù, which will be used with AWS.  It has a pre-installed TensorFlow, which was compiled with GPU support.  At the time of writing, Bitfusion AMI included TensorFlow version 0.11. <br><br>  The process of creating an EC2 instance from an AMI image is fairly simple and is beyond the scope of this article.  However, it is worth paying attention to two important details that are related to the process: the <a href="https://aws.amazon.com/ec2/instance-types/">type of the instance</a> and the size of the SSD.  For the type I would recommend to use: p2.xlarge is the cheapest type that has an NVIDIA GPU with enough video memory (12 Gbps).  As for the size of the SSD - I would recommend allocating at least 100GB. <br><br><h4>  Now we need to change the original ‚Äútranslate‚Äù script. </h4><br>  At this stage, I hope I can assume that you have ssh access to the machine where you will train TensorFlow. <br><br>  First, let's discuss why we need to modify the source script at all.  The fact is that the script itself does not allow overriding the source of data that is used to train the model.  To fix this, I created a <a href="https://github.com/tensorflow/models/issues/748">feature-request</a> .  And I will try to prepare the implementation soon, but at the moment, you can participate by adding +1 to the ‚Äúrequest‚Äù. <br><br>  In any case, do not be afraid - the <a href="https://github.com/b0noI/tensorflow/commit/fb1cebc00a21b0512aa0df48334a3b19ba676296">modification is very simple</a> .  But even such a small modification I have already done for you and created a <a href="">repository containing the modified code</a> .  It remains only to do the following: <br><br>  Rename the files ‚Äútrain.a‚Äù and ‚Äútrain.b‚Äù to ‚Äútrain.en‚Äù and ‚Äútrain.fr‚Äù, respectively.  This is necessary because the training script still believes that he is learning to translate from English to French. <br><br>  Both files must be uploaded to remote hosts ‚Äî this can be done using the rsync command: <br><br><pre> <code class="hljs mel">‚ûú train# REMOTE_IP=... ‚ûú train# <span class="hljs-keyword"><span class="hljs-keyword">ls</span></span> train.en train.fr ‚ûú train rsync -r . ubuntu@$REMOTE_IP:/home/ubuntu/train</code> </pre> <br>  Now let's connect to a remote host and start a tmux session.  If you don‚Äôt know what tmux is, you can simply connect via SSH: <br><br><pre> <code class="hljs coffeescript">‚ûú train ssh ubuntu@$REMOTE_IP <span class="hljs-number"><span class="hljs-number">53</span></span> packages can be updated. <span class="hljs-number"><span class="hljs-number">42</span></span> updates are security updates. <span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span> <span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span><span class="hljs-comment"><span class="hljs-comment">######</span></span> ____ _ _ __ _ _ | __ )(_) |_ / _|_ _ ___(_) ___ _ __ (_) ___ | _ \| | __| |_| | | / __| |/ _ \| <span class="hljs-string"><span class="hljs-string">'_ \ | |/ _ \ | |_) | | |_| _| |_| \__ \ | (_) | | | |_| | (_) | |____/|_|\__|_| \__,_|___/_|\___/|_| |_(_)_|\___/ Welcome to Bitfusion Ubuntu 14 Tensorflow - Ubuntu 14.04 LTS (GNU/Linux 3.13.0-101-generic x86_64) This AMI is brought to you by Bitfusion.io http://www.bitfusion.io Please email all feedback and support requests to: support@bitfusion.io We would love to hear from you! Contact us with any feedback or a feature request at the email above. ######################################################################################################################## ######################################################################################################################## ######################################################################################################################## Please review the README located at /home/ubuntu/README for more details on how to use this AMI Last login: Sat Dec 10 16:39:26 2016 from 99-46-141-149.lightspeed.sntcca.sbcglobal.net ubuntu@tf:~$ cd train/ ubuntu@tf:~/train$ ls train.en train.fr</span></span></code> </pre> <br>  Let's check that TensorFlow is installed and it uses the GPU: <br><br><pre> <code class="python hljs">ubuntu@tf:~/train$ python Python <span class="hljs-number"><span class="hljs-number">2.7</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span> (default, Jun <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">58</span></span>:<span class="hljs-number"><span class="hljs-number">13</span></span>) [GCC <span class="hljs-number"><span class="hljs-number">4.8</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>] on linux2 Type <span class="hljs-string"><span class="hljs-string">"help"</span></span>, <span class="hljs-string"><span class="hljs-string">"copyright"</span></span>, <span class="hljs-string"><span class="hljs-string">"credits"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-string"><span class="hljs-string">"license"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more information. &gt;&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tensorflow <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> tf I tensorflow/stream_executor/dso_loader.cc:<span class="hljs-number"><span class="hljs-number">111</span></span>] successfully opened CUDA library libcublas.so<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> locally I tensorflow/stream_executor/dso_loader.cc:<span class="hljs-number"><span class="hljs-number">111</span></span>] successfully opened CUDA library libcudnn.so<span class="hljs-number"><span class="hljs-number">.5</span></span> locally I tensorflow/stream_executor/dso_loader.cc:<span class="hljs-number"><span class="hljs-number">111</span></span>] successfully opened CUDA library libcufft.so<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> locally I tensorflow/stream_executor/dso_loader.cc:<span class="hljs-number"><span class="hljs-number">111</span></span>] successfully opened CUDA library libcuda.so<span class="hljs-number"><span class="hljs-number">.1</span></span> locally I tensorflow/stream_executor/dso_loader.cc:<span class="hljs-number"><span class="hljs-number">111</span></span>] successfully opened CUDA library libcurand.so<span class="hljs-number"><span class="hljs-number">.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> locally &gt;&gt;&gt; print(tf.__version__) <span class="hljs-number"><span class="hljs-number">0.11</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span></code> </pre> <br>  As you can see, TF version 0.11 is installed and it uses the CUDA library.  Now let's bow the training script: <br><br><pre> <code class="hljs ruby">ubuntu@tf<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span>$ mkdir src/ ubuntu@tf<span class="hljs-symbol"><span class="hljs-symbol">:~</span></span>$ cd src/ ubuntu@tf<span class="hljs-symbol"><span class="hljs-symbol">:~/src</span></span>$ git clone <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/b</span></span>0noI/tensorflow.git Cloning into <span class="hljs-string"><span class="hljs-string">'tensorflow'</span></span>... <span class="hljs-symbol"><span class="hljs-symbol">remote:</span></span> Counting <span class="hljs-symbol"><span class="hljs-symbol">objects:</span></span> <span class="hljs-number"><span class="hljs-number">117802</span></span>, done. <span class="hljs-symbol"><span class="hljs-symbol">remote:</span></span> Compressing <span class="hljs-symbol"><span class="hljs-symbol">objects:</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% (<span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">10</span></span>), done. <span class="hljs-symbol"><span class="hljs-symbol">remote:</span></span> Total <span class="hljs-number"><span class="hljs-number">117802</span></span> (delta <span class="hljs-number"><span class="hljs-number">0</span></span>), reused <span class="hljs-number"><span class="hljs-number">0</span></span> (delta <span class="hljs-number"><span class="hljs-number">0</span></span>), pack-reused <span class="hljs-number"><span class="hljs-number">117792</span></span> Receiving <span class="hljs-symbol"><span class="hljs-symbol">objects:</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span>% (<span class="hljs-number"><span class="hljs-number">117802</span></span>/<span class="hljs-number"><span class="hljs-number">117802</span></span>), <span class="hljs-number"><span class="hljs-number">83.51</span></span> MiB <span class="hljs-params"><span class="hljs-params">| 19.32 MiB/s, done. Resolving deltas: 100% (88565/88565), done. Checking connectivity... done. ubuntu@tf:~/src$ cd tensorflow/ ubuntu@tf:~/src/tensorflow$ git checkout -b r0.11 origin/r0.11 Branch r0.11 set up to track remote branch r0.11 from origin. Switched to a new branch 'r0.11'</span></span></code> </pre> <br>  <b>Note that we need the r0.11 branch.</b>  First of all, this thread is consistent with the version of the locally installed TensorFlow.  Secondly, I did not transfer my changes to other branches, therefore, if necessary, I will have to do this with your own hands. <br><br>  Congratulations!  You have reached the stage of learning.  Feel free to run this very training: <br><br><pre> <code class="hljs ruby">ubuntu@tf<span class="hljs-symbol"><span class="hljs-symbol">:~/src/tensorflow</span></span>$ cd tensorflow/models/rnn/translate/ ubuntu@tf<span class="hljs-symbol"><span class="hljs-symbol">:~/src/tensorflow/tensorflow/models/rnn/translate</span></span>$ python ./translate.py --en_vocab_size=<span class="hljs-number"><span class="hljs-number">40000</span></span> --fr_vocab_size=<span class="hljs-number"><span class="hljs-number">40000</span></span> --data_dir=<span class="hljs-regexp"><span class="hljs-regexp">/home/ubuntu</span></span><span class="hljs-regexp"><span class="hljs-regexp">/train --train_dir=/home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/ubuntu/train</span></span> ... Tokenizing data <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> /home/ubuntu/train/train.en tokenizing line <span class="hljs-number"><span class="hljs-number">100000</span></span> ... global step <span class="hljs-number"><span class="hljs-number">200</span></span> learning rate <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">5000</span></span> step-time <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">72</span></span> perplexity <span class="hljs-number"><span class="hljs-number">31051.66</span></span> <span class="hljs-symbol"><span class="hljs-symbol">eval:</span></span> bucket <span class="hljs-number"><span class="hljs-number">0</span></span> perplexity <span class="hljs-number"><span class="hljs-number">173.09</span></span> <span class="hljs-symbol"><span class="hljs-symbol">eval:</span></span> bucket <span class="hljs-number"><span class="hljs-number">1</span></span> perplexity <span class="hljs-number"><span class="hljs-number">181.45</span></span> <span class="hljs-symbol"><span class="hljs-symbol">eval:</span></span> bucket <span class="hljs-number"><span class="hljs-number">2</span></span> perplexity <span class="hljs-number"><span class="hljs-number">398.51</span></span> <span class="hljs-symbol"><span class="hljs-symbol">eval:</span></span> bucket <span class="hljs-number"><span class="hljs-number">3</span></span> perplexity <span class="hljs-number"><span class="hljs-number">547.47</span></span></code> </pre> <br>  Let's discuss some of the keys that we use: <br><br><ul><li>  <i>en_vocab_size</i> - how many unique words will <i>learn the</i> ‚ÄúEnglish language‚Äù model.  If the number of unique words from the source data exceeds the size of the dictionary, all words that are not in the dictionary will be marked as ‚ÄúUNK‚Äù (code: 3).  But I do not recommend making the dictionary more than necessary;  but it should not be less; </li><li>  <i>fr_vocab_size</i> - the same, but for a different part of the data (for ‚ÄúFrench‚Äù); </li><li>  <i>data_dir</i> - directory with source data.  Here the script will look for the files ‚Äútrain.en‚Äù and ‚Äútrain.fr‚Äù; </li><li>  <i>train_dir</i> - directory in which the script will record the intermediate result of training. </li></ul><br><h4>  Let's make sure the training goes on and everything goes according to plan. </h4><br>  You have successfully started learning.  But let's confirm that the process continues and everything is in order.  We don‚Äôt want to find out after 6 hours that something was done wrong at the very beginning.  Gleb and I have already somehow taught something half-sensible =) <br><br>  First of all, we can confirm that the learning process ‚Äúbit off‚Äù the memory of the GPU: <br><pre> <code class="hljs ruby">$ watch -n <span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">5</span></span> nvidia-smi</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/719/aaf/408/719aaf4089e169f28b68224f3f6722f0.png" alt="image"><br><br>  As you can see, I didn‚Äôt get sick so much, almost all the memory on the GPU is occupied.  This is a good sign.  And do not be afraid that your process is about to ‚Äúkick back‚Äù with an OutOfMemory error.  Just during the launch of TF, it takes up all the memory on the GPU that it can reach. <br><br>  Then you can check the folder ‚Äútrain‚Äù - it should contain several new files: <br><br><pre> <code class="hljs smalltalk">~<span class="hljs-string"><span class="hljs-string">$ </span></span>cd train ~/train<span class="hljs-string"><span class="hljs-string">$ </span></span>ls train.fr train.ids40000.fr dev.ids40000.en dev.ids40000.fr train.en train.ids40000.en vocab40000.fr</code> </pre> <br>  Here it is important to look into the files vocab4000. * And train.ids40000. *.  There should be atmospheric and soulful, look here: <br><br><pre> <code class="hljs vbscript">~/train$less vocab40000.en _PAD _GO _EOS _UNK . <span class="hljs-comment"><span class="hljs-comment">' , I ? you the to s a t it of You ! that ...</span></span></code> </pre> <br>  Each line in the file is a unique word that was found in the source data.  Each word in the source data will be replaced by a number that represents the line number from this file.  You can immediately notice that there are some technical words: PAD (0), GO (1), EOS (2), UNK (3).  Probably the most important of them for us is ‚ÄúUNK‚Äù, since the number of words marked with this code (3) will give us some idea of ‚Äã‚Äãhow correctly we choose the size of our dictionary. <br>  Now let's look at train.ids40000.en: <br><br><pre> <code class="hljs smalltalk">~/train<span class="hljs-string"><span class="hljs-string">$ </span></span>less train.ids40000.en <span class="hljs-number"><span class="hljs-number">1181</span></span> <span class="hljs-number"><span class="hljs-number">21483</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1726</span></span> <span class="hljs-number"><span class="hljs-number">22480</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">251</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">61</span></span> <span class="hljs-number"><span class="hljs-number">88</span></span> <span class="hljs-number"><span class="hljs-number">7765</span></span> <span class="hljs-number"><span class="hljs-number">7151</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">27</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">125</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">24950</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2206</span></span> <span class="hljs-number"><span class="hljs-number">4081</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">1663</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">4444</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">562</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">85</span></span> <span class="hljs-number"><span class="hljs-number">2435</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">2277</span></span> <span class="hljs-number"><span class="hljs-number">10289</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">275</span></span> <span class="hljs-number"><span class="hljs-number">107</span></span> <span class="hljs-number"><span class="hljs-number">475</span></span> <span class="hljs-number"><span class="hljs-number">155</span></span> <span class="hljs-number"><span class="hljs-number">223</span></span> <span class="hljs-number"><span class="hljs-number">12428</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">79</span></span> <span class="hljs-number"><span class="hljs-number">38</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">110</span></span> <span class="hljs-number"><span class="hljs-number">3799</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">767</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">7248</span></span> <span class="hljs-number"><span class="hljs-number">2055</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">142</span></span> <span class="hljs-number"><span class="hljs-number">62</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">1643</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">145</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">19218</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">999</span></span> <span class="hljs-number"><span class="hljs-number">35578</span></span> <span class="hljs-number"><span class="hljs-number">17507</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">132</span></span> <span class="hljs-number"><span class="hljs-number">21483</span></span> <span class="hljs-number"><span class="hljs-number">2235</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">4112</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">144</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-number"><span class="hljs-number">83</span></span> <span class="hljs-number"><span class="hljs-number">257</span></span> <span class="hljs-number"><span class="hljs-number">37</span></span> <span class="hljs-number"><span class="hljs-number">788</span></span> <span class="hljs-number"><span class="hljs-number">21</span></span> <span class="hljs-number"><span class="hljs-number">296</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">72</span></span> <span class="hljs-number"><span class="hljs-number">115</span></span> <span class="hljs-number"><span class="hljs-number">1521</span></span> <span class="hljs-number"><span class="hljs-number">315</span></span> <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">16856</span></span> <span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">9963</span></span> <span class="hljs-number"><span class="hljs-number">348</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">68</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-number"><span class="hljs-number">77</span></span> <span class="hljs-number"><span class="hljs-number">1375</span></span> <span class="hljs-number"><span class="hljs-number">218</span></span> <span class="hljs-number"><span class="hljs-number">7831</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">275</span></span> <span class="hljs-number"><span class="hljs-number">11947</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-number"><span class="hljs-number">84</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">2135</span></span> <span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">5011</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">93</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-number"><span class="hljs-number">359</span></span> <span class="hljs-number"><span class="hljs-number">6370</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">139</span></span> <span class="hljs-number"><span class="hljs-number">31044</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-number"><span class="hljs-number">49</span></span> <span class="hljs-number"><span class="hljs-number">125</span></span> <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-number"><span class="hljs-number">131</span></span> <span class="hljs-number"><span class="hljs-number">350</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">371</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">38279</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-number"><span class="hljs-number">22</span></span> <span class="hljs-number"><span class="hljs-number">316</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">3055</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">323</span></span> <span class="hljs-number"><span class="hljs-number">19212</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">562</span></span> <span class="hljs-number"><span class="hljs-number">21166</span></span> <span class="hljs-number"><span class="hljs-number">208</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">63</span></span> <span class="hljs-number"><span class="hljs-number">9666</span></span> <span class="hljs-number"><span class="hljs-number">14410</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">13262</span></span> <span class="hljs-number"><span class="hljs-number">69</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">59</span></span> <span class="hljs-number"><span class="hljs-number">155</span></span> <span class="hljs-number"><span class="hljs-number">3799</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">1527</span></span> <span class="hljs-number"><span class="hljs-number">4079</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">123</span></span> <span class="hljs-number"><span class="hljs-number">89</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2706</span></span> <span class="hljs-number"><span class="hljs-number">16</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-number"><span class="hljs-number">2938</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-number"><span class="hljs-number">66</span></span> <span class="hljs-number"><span class="hljs-number">21386</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-number"><span class="hljs-number">116</span></span> <span class="hljs-number"><span class="hljs-number">8</span></span> ...</code> </pre> <br>  I think you already guessed that this is data from input.en, but with all the words replaced with codes according to the dictionary.  Now we can check how many words are marked as ‚Äúunknowns‚Äù (UNK / 3): <br><br><pre> <code class="hljs smalltalk">~/train<span class="hljs-string"><span class="hljs-string">$ </span></span>grep -o <span class="hljs-string"><span class="hljs-string">' 3 '</span></span> train.ids40000.en | wc -l <span class="hljs-number"><span class="hljs-number">7977</span></span></code> </pre> <br>  You can try in subsequent experiments to increase the size of the dictionary from 40k to 45k, or even up to 50k.  But, we will continue the ‚Äúas is‚Äù process and will not interrupt it. <br><br><h2>  6 hours later ... ‚ÄúIt came to life!‚Äù </h2><br>  After waiting enough time, you can stupidly kill the learning process.  Do not worry, the process saves the result every 200 steps of training (this number can be changed).  I would recommend for training either to choose the period of time that you are willing to wait (it may depend on the amount you are willing to pay for the rental car), or the number of steps that you want the training process to complete. <br><br>  The last and most important thing for which we arranged this whole mess - this is to start a chat.  To do this, we just need to add one key to the team that was used for training: <br><br><pre> <code class="bash hljs">~/src/tensorflow/tensorflow/models/rnn/translate$ python ./translate.py --en_vocab_size=40000 --fr_vocab_size=40000 --data_dir=/home/ubuntu/train --train_dir=/home/ubuntu/train --decode ... Reading model parameters from /home/ubuntu/data/translate.ckpt-54400 &gt; Hello! Hello . &gt; Hi are you? Now , okay . &gt; What is your name? My name is Sir Sir . &gt; Really? Yeah . &gt; what about the real name? N . . . real real . &gt; are you a live? Yes . &gt; <span class="hljs-built_in"><span class="hljs-built_in">where</span></span> are you? I <span class="hljs-string"><span class="hljs-string">' m here . &gt; where is here? I don '</span></span> t know . &gt; can I <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> you to get here? Yeah , to I ve <span class="hljs-string"><span class="hljs-string">' t feeling nothing to me .</span></span></code> </pre> <br><h2>  This is just the beginning!  Here are a couple of ideas for improving the bot. </h2><br>  To help a project or simply create a bot with character, you can: <br><ul><li>  implement logic that finds the ideal size for EN / FR dictionaries; </li><li>  publish train.en / train.fr somewhere so that other people do not create them from scratch; </li><li>  to train the bot master Yoda (or Darth Vader); </li><li>  to train a bot who will speak like in the universe of the ‚ÄúLord of the Rings‚Äù; </li><li>  train a bot who will speak like people from the StarWars of the universe; </li><li>  train the bot on its dialogues so that it speaks like you! </li></ul></div><p>Source: <a href="https://habr.com/ru/post/317732/">https://habr.com/ru/post/317732/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../317722/index.html">Instructions: How to choose the right indicators for monitoring and optimization, so that IT businesses grow faster</a></li>
<li><a href="../317724/index.html">How Discord processes more than 1,000,000 push requests per minute with Elixir GenStage</a></li>
<li><a href="../317726/index.html">Splitting text into sentences using Tomita Parser</a></li>
<li><a href="../317728/index.html">Button or link?</a></li>
<li><a href="../317730/index.html">How IT professionals work. Maxim Zelinsky, Sberbank-Technology</a></li>
<li><a href="../317736/index.html">New promising sites for HTML5 games</a></li>
<li><a href="../317738/index.html">Development for Sailfish OS: working with notifications on the example of a note taking application</a></li>
<li><a href="../317740/index.html">On the MegaFon Card - technical details</a></li>
<li><a href="../317742/index.html">Working with Aerospike on scala using macro magic</a></li>
<li><a href="../317744/index.html">How to make a successful holiday mailing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>