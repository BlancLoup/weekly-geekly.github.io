<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Proxygen - HTTP framework for C ++ from Facebook</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Proxygen is a collection of libraries for using HTTP in C ++, including, among other things, a very easy to use HTTP server. In addition to the classi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Proxygen - HTTP framework for C ++ from Facebook</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/23f/925/138/23f92513861243c6bae3bdab64b0bb94.png" align="right">  <a href="https://github.com/facebook/proxygen">Proxygen</a> is a collection of libraries for using HTTP in C ++, including, among other things, a very easy to use HTTP server.  In addition to the classic HTTP / 1.1 framework, Proxygen supports <a href="http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3">SPDY / 3</a> and <a href="http://www.chromium.org/spdy/spdy-protocol/spdy-protocol-draft3-1">SPDY / 3.1</a> .  HTTP / 2 will also be fully supported soon. <br><br>  Proxygen was not intended as a replacement for Apache or nginx - these projects are focused on creating sufficiently flexible and configurable web servers, which allow, through fine tuning, to achieve maximum performance.  The task of Proxygen is to work quite well on the default settings, giving the programmer an easy-to-use web server and web client that easily integrates into existing projects.  We want to help people build web services in C ++ with less cost and we believe that Proxygen is a great framework for this.  You can read the documentation on it and connect to the development on <a href="https://github.com/facebook/proxygen">Github</a> . <br><br><a name="habracut"></a><br><h4>  Prehistory </h4><br>  Proxygen started as a project to create a custom high-performance reverse proxy with load balancing about four years ago.  We planned that Proxygen will become a library for generating proxy servers (you probably already guessed it from the very name Proxygen).  But since then, he has seriously evolved.  We realize that there are already a decent number of programs that solve such problems (Apache, nginx, HAProxy, Varnish, etc), however, we decided to go our own way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Why did we create our own HTTP stack? </h5><br><h6>  <b>Integration</b> </h6><br>  Being able to quickly and easily integrate into your existing Facebook infrastructure was critical.  For example, the ability to administer our HTTP infrastructure with tools like <a href="https://code.facebook.com/projects/1410559149202582/fbthrift/">Thrift</a> makes it easy to integrate with existing systems.  The ability to easily monitor and measure Proxygen performance using systems such as <a href="http://strataconf.com/stratany2012/public/schedule/detail/25540">ODS</a> (our internal monitoring tool) allows you to quickly respond to new data and modify the product.  Creating our own HTTP stack allowed us to more closely interact with the systems and components we need. <br><br><h6>  <b>Reuse code</b> </h6><br>  We wanted to create a foundation for building network components for all our projects.  Currently, more than a dozen of our internal systems are built using Proxygen, including parts of systems such as <a href="https://code.facebook.com/posts/685565858139515/needle-in-a-haystack-efficient-storage-of-billions-of-photos/">Haystack</a> , <a href="https://code.facebook.com/projects/564433143613123/hhvm/">HHVM</a> , our HTTP traffic balancers, some parts of our mobile infrastructure.  Proxygen is a platform where we can, for example, work on support for the HTTP / 2 protocol and as soon as it is fully ready - get its support in all our products. <br><br><h6>  <b>Scalability</b> </h6><br>  We honestly tried to take existing products and scale them across our entire infrastructure.  With some it even worked, some options worked for a long time.  But at some point, the product used was no longer able to keep up with the growth of our capacities. <br><br><h6>  <b>Functional</b> </h6><br>  Some number of features at the time of writing Proxygen was absent in other similar projects (and in some is not yet).  Some of these features are very useful for us: SPDY, WebSockets, HTTP / 1.1 (keep-alive), TLS-false start, some features of load distribution.  Building our own HTTP stack unleashed our hands in terms of implementing this functionality. <br><br>  Initially launched in 2011 by several of our engineers, who were striving to make the use of the HTTP protocol more efficient, Proxygen was developed by a team of 3-4 main developers and a dozen internal contributors.  Milestones of the project: <br><br><ul><li>  2011 - Begin development of Proxygen.  In the same year, the project began to process part of the actual Facebook traffic. </li><li>  2012 - Adding SPDY / 2 support. </li><li>  2013 - Launch of SPDY / 3 production, starting work on SPDY / 3.1 </li><li>  2014 - Launching into SPDY / 3.1 production, starting work on HTTP / 2 </li></ul><br><br>  There are a number of important points in the development, but we think that the <a href="https://github.com/facebook/proxygen">code</a> will tell this story better than us. <br><br>  At the moment we have several years of experience using Proxygen.  The library has already processed trillions of HTTP (S) and SPDY requests.  We believe that we have already reached the stage when this project is not ashamed to share with the community. <br><br><h4>  Architecture </h4><br>  The core of the HTTP layer is divided into four abstractions: session, codec, transaction, and handler.  A session is created for each connection.  Each session has a codec that is responsible for serializing and deserializing frames into HTTP messages.  A session is responsible for sending each message from the codec to a specific transaction.  The library user is responsible for writing handlers for messages coming into the transaction.  This design allows us to support new multiplexing protocols such as SPDY and HTTP / 2. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9be/087/083/9be087083c39d172b05d75b9403807d3.png" alt="image"><br><br>  Proxygen actively uses the capabilities of the latest C ++ standard and depends on <a href="https://code.facebook.com/projects/1410559149202582/fbthrift/">Thrift</a> and <a href="https://code.facebook.com/projects/527543867323997/folly/">Folly</a> .  We used move semantics to avoid the cost of copying large objects like body buffers and request and response headers.  In addition, using non-blocking I / O and linux epoll under the hood, we created a server that is efficient both in terms of memory usage and CPU time. <br><br><h4>  HTTP server </h4><br>  The example of the server that we <a href="https://github.com/facebook/proxygen/blob/master/proxygen/">included in the release</a> is a good starting point if you want to start with a simple, out-of-the-box, asynchronous backbone of the server. <br><br><div class="spoiler">  <b class="spoiler_title">EchoServer.cpp</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2014, Facebook, Inc. * All rights reserved. * * This source code is licensed under the BSD-style license found in the * LICENSE file in the root directory of this source tree. An additional grant * of patent rights can be found in the PATENTS file in the same directory. * */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EchoHandler.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EchoStats.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"proxygen/httpserver/HTTPServer.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"proxygen/httpserver/RequestHandlerFactory.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;folly/Portability.h&gt; #include &lt;folly/Memory.h&gt; #include &lt;folly/io/async/EventBaseManager.h&gt; #include &lt;unistd.h&gt; using namespace EchoService; using namespace proxygen; using folly::EventBase; using folly::EventBaseManager; using folly::SocketAddress; using Protocol = HTTPServer::Protocol; DEFINE_int32(http_port, 11000, "Port to listen on with HTTP protocol"); DEFINE_int32(spdy_port, 11001, "Port to listen on with SPDY protocol"); DEFINE_int32(thrift_port, 10000, "Port to listen on for thrift"); DEFINE_string(ip, "localhost", "IP/Hostname to bind to"); DEFINE_int32(threads, 0, "Number of threads to listen on. Numbers &lt;= 0 " "will use the number of cores on this machine."); class EchoHandlerFactory : public RequestHandlerFactory { public: void onServerStart() noexcept override { stats_.reset(new EchoStats); } void onServerStop() noexcept override { stats_.reset(); } RequestHandler* onRequest(RequestHandler*, HTTPMessage*) noexcept override { return new EchoHandler(stats_.get()); } private: folly::ThreadLocalPtr&lt;EchoStats&gt; stats_; }; int main(int argc, char* argv[]) { gflags::ParseCommandLineFlags(&amp;argc, &amp;argv, true); google::InitGoogleLogging(argv[0]); google::InstallFailureSignalHandler(); std::vector&lt;HTTPServer::IPConfig&gt; IPs = { {SocketAddress(FLAGS_ip, FLAGS_http_port, true), Protocol::HTTP}, {SocketAddress(FLAGS_ip, FLAGS_spdy_port, true), Protocol::SPDY}, }; if (FLAGS_threads &lt;= 0) { FLAGS_threads = sysconf(_SC_NPROCESSORS_ONLN); CHECK(FLAGS_threads &gt; 0); } HTTPServerOptions options; options.threads = static_cast&lt;size_t&gt;(FLAGS_threads); options.idleTimeout = std::chrono::milliseconds(60000); options.shutdownOn = {SIGINT, SIGTERM}; options.handlerFactories = RequestHandlerChain() .addThen&lt;EchoHandlerFactory&gt;() .build(); HTTPServer server(std::move(options)); server.bind(IPs); // Start HTTPServer mainloop in a separate thread std::thread t([&amp;] () { server.start(); }); t.join(); return 0; }</span></span></span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">EchoHandler.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">/* * Copyright (c) 2014, Facebook, Inc. * All rights reserved. * * This source code is licensed under the BSD-style license found in the * LICENSE file in the root directory of this source tree. An additional grant * of patent rights can be found in the PATENTS file in the same directory. * */</span></span> <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EchoHandler.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"EchoStats.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"proxygen/httpserver/RequestHandler.h"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"proxygen/httpserver/ResponseBuilder.h"</span></span></span><span class="hljs-meta"> using namespace proxygen; namespace EchoService { EchoHandler::EchoHandler(EchoStats* stats): stats_(stats) { } void EchoHandler::onRequest(std::unique_ptr</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;HTTPMessage&gt; headers) noexcept { stats_-&gt;recordRequest(); } void EchoHandler::onBody(std::unique_ptr&lt;folly::IOBuf&gt; body) noexcept { if (body_) { body_-&gt;prependChain(std::move(body)); } else { body_ = std::move(body); } } void EchoHandler::onEOM() noexcept { ResponseBuilder(downstream_) .status(200, "OK") .header("Request-Number", folly::to&lt;std::string&gt;(stats_-&gt;getRequestCount())) .body(std::move(body_)) .sendWithEOM(); } void EchoHandler::onUpgrade(UpgradeProtocol protocol) noexcept { // handler doesn't support upgrades } void EchoHandler::requestComplete() noexcept { delete this; } void EchoHandler::onError(ProxygenError err) noexcept { delete this; } }</span></span></span></span></code> </pre><br></div></div><br>  We conducted a benchmark of our echo server on a computer with 32 Intel¬Æ Xeon¬Æ CPU E5-2670 @ 2.60GHz logical cores and 16 GiB memory, varying the number of worker threads from one to eight.  We ran the client on the same machine in order to avoid network delays and this is what we got: <br><br>  # Client Settings: <br>  # For each server workflow, 2 clients <br>  # 400 simultaneously open connections <br>  # 100 connection requests <br>  # 60 seconds testing <br>  # The results indicate the average value of the results of 10 tests <br>  # simple GET, 245 bytes of request headers, 600 bytes of response (without saving to disk) <br>  # SPDY / 3.1 allows up to 10 concurrent connection requests <br><br><img src="https://habrastorage.org/getpro/habr/post_images/150/8bc/f9e/1508bcf9e28b6d214e877f857374d157.png" alt="image"><br><br>  Although the echo server itself is a rather primitive thing compared to a real web server, this benchmark still shows how efficiently Proxygen works with SPDY and HTTP / 2.  The Proxygen HTTP server is easy to use and immediately works quite productively, although we focused more on ease of use than on the maximum possible speed.  For example, <a href="httpserver/filters">the filter model</a> in the server gives you the opportunity to process some common data blocks using the algorithms defined for them, moreover, in such a way that each individual code block of the algorithm is easily testable to a unit.  On the other hand, the need for memory allocation associated with this filter model is not ideal for high-performance applications. <br><br><h4>  Influence </h4><br>  Proxygen allows us to quickly implement the necessary functionality, release it in production and immediately get the result.  For example, we were interested in evaluating the <a href="http2-spec/compression.html">HPACK</a> request header compression format, but unfortunately we didn‚Äôt have any HTTP / 2 clients or servers, and indeed the HTTP / 2 specification itself is still in development.  Proxygen allowed us to implement HPACK, try using it on top of SPDY and roll out the release simultaneously to our servers and mobile clients.  The ability to quickly experiment with real traffic in the HPACK format gave us the opportunity to understand its real performance and evaluate the benefits of its use. <br><br><h4>  Open source code </h4><br>  The Proxygen codebase is in a state of active development and will continue to evolve.  If you like the HTTP protocol, high-performance network code, modern C ++, we will be happy to work with you!  Please feel free to send pull requests to <a href="https://github.com/facebook/proxygen">Github</a> . <br><br>  We are actively involved in the development of open source projects and are always looking for the opportunity to share our code with the community.  The network infrastructure development team has already laid out <a href="https://code.facebook.com/projects/1410559149202582/fbthrift/">Thrift</a> and <a href="https://code.facebook.com/projects/676603015770415/">Proxygen</a> in open <a href="https://code.facebook.com/projects/676603015770415/">source</a> - two important network components of Facebook.  We hope that they will find their use in other projects. <br><br>  <i>Thanks to all the engineers who contributed to the development of this project: Ajit Banerjee, David Gadling, Claudiu Gheorghe, Rajat Goel, Peter Griess, Martin Lau, Adam Lazur, Noam Lerner, Xu Ning, Brian Pane, Praveen Kumar Woo xie.</i> </div><p>Source: <a href="https://habr.com/ru/post/243181/">https://habr.com/ru/post/243181/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../24317/index.html">French hacker banker out of jail, has already found a new job in IT</a></li>
<li><a href="../243171/index.html">And a few words about SandCastle, TFS and magic ...</a></li>
<li><a href="../243173/index.html">Uptime your sites now in PDF</a></li>
<li><a href="../243175/index.html">A full-fledged Minecraft processor: how does it work, how to program on it and what is it for?</a></li>
<li><a href="../24318/index.html">IE8 Beta 1 vs. Firefox 3 Beta 4: Who is Faster?</a></li>
<li><a href="../243183/index.html">Under what OS and what are you programming?</a></li>
<li><a href="../243187/index.html">Russian SQL language documentation for Firebird 2.5 DBMS</a></li>
<li><a href="../24319/index.html">Homer Simpson</a></li>
<li><a href="../243191/index.html">SMM? Thanks but no thanks</a></li>
<li><a href="../243193/index.html">Payler - LIVE!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>