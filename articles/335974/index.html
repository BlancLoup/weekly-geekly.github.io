<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Labyrinth generation by Eller algorithm in Unity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 

 Today I would like to talk about how to generate mazes using the Eller algorithm, and how to make a beautiful 3D visualization in Unity, so ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Labyrinth generation by Eller algorithm in Unity</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br><br>  Today I would like to talk about how to generate mazes using the Eller algorithm, and how to make a beautiful 3D visualization in Unity, so that you can use it in your games later.  Also tell a little about how you can customize post processing inside this solution.  And traditionally link GitHub with the generator itself. <br><br><img src="https://habrastorage.org/web/3cb/b95/9d0/3cbb959d056b4e229807d351c611c03e.png"><br><a name="habracut"></a><br>  Eller's algorithm is a rather popular algorithm for generating ‚Äúideal‚Äù (there is only one way between two points) mazes, since it is one of the fastest and generates ‚Äúinteresting‚Äù mazes.  ‚ÄúInteresting‚Äù they are obtained due to the fact that this algorithm is not based on the search for a spanning tree in a graph, as a result of which it generates fractal structures less frequently.  Including one of the advantages of the algorithm is that it allows you to generate mazes of infinite size in linear time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The algorithm is based on the fact that we combine the cells of the maze into different sets, and in the last step of the algorithm we combine them into one common set.  Cells are in one set - if from one cell you can walk to another.  Initially, all the walls of the maze are raised, so that all cells are in different sets. <br><br>  I saw many different descriptions of the algorithm itself (even in Habr√©), so I won‚Äôt do it again, but I‚Äôll write a brief description of my implementation. <br><br>  The algorithm itself consists of 3 basic steps. <br><br>  <b>In the loop:</b> <br><br>  1. We process the string, randomly combining the cells in the string belonging to different sets. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">W4Maze maze, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowNum</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; maze.ColumnCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cell = maze.GetCell(i, rowNum); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nextCell = maze.GetCell(i + <span class="hljs-number"><span class="hljs-number">1</span></span>, rowNum); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cell.Set != nextCell.Set) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (UnityEngine.Random.Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { RemoveHorizonWallBetweenCells( maze, cell, nextCell, rowNum); } } } }</code> </pre> </div></div><br>  2. Pass by the same line and randomly combine the cells from the line above with our line (with some restrictions) <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateVerticalConnections</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> W4Maze maze, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowNum</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> removeVertical = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> isAddedVertical = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; maze.ColumnCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { W4Cell cell = maze.GetCell(i, rowNum); W4Cell nextCell = maze.GetCell(i + <span class="hljs-number"><span class="hljs-number">1</span></span>, rowNum); W4Cell topCell = maze.GetCell(i, rowNum + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cell.Set != nextCell.Set) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isAddedVertical) { RemoveVerticalWall(cell, topCell); } isAddedVertical = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { removeVertical = Random.Range(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (removeVertical) { RemoveVerticalWall(cell, topCell); isAddedVertical = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } } } CheckLastVertical(maze, rowNum, isAddedVertical); }</code> </pre> </div></div><br>  <b>The final step:</b> <br><br>  We process the last row by combining cells from different sets. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateLastRow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">W4Maze maze</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = maze.RowCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; maze.ColumnCount - <span class="hljs-number"><span class="hljs-number">1</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cell = maze.GetCell(i, y); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nextCell = maze.GetCell(i + <span class="hljs-number"><span class="hljs-number">1</span></span>, y); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cell.Set != nextCell.Set) { RemoveHorizonWallBetweenCells( maze, cell, nextCell, y); } } }</code> </pre> <br></div></div><br>  In general, this is the algorithm. <br><br>  Labyrinth need to store something.  In my decision there are 2 structures for storing labyrinths. <br><br>  W4Maze - which in essence is an array of cells of 16 types according to the number of raised walls.  The W4Cell cell itself contains just 4 bool fields that tell you which walls are raised.  This structure is convenient for maze generation by the Eller algorithm and convenient for serialization. <br><br>  But on the other hand, it is completely inconvenient for generating walls.  The idea is that the walls of the labyrinth should have a thickness, in order to implement a similar algorithm, it is graph structures that are convenient.  For this, the MazeGraph structure was introduced and the conversion from W4Maze to it was implemented.  In addition, for convenience, it was created 2 lists - paths and walls.  As a result, having written a simple visualization with the help of Gizmos, we get such a maze.  Yellow is the wall, and green is the way. <br><br><img src="https://habrastorage.org/web/eb7/f13/ce4/eb7f13ce4f6c410fa25031e56424b6a9.png"><br><br>  In general, this is not bad, but there are too many unnecessary nodes in the walls and paths, which will be inconvenient in the future to generate three-dimensional visualization, so that we simplify them.  This will allow to generate less meshes and avoid lighting artifacts at the junctions. <br><br><div class="spoiler">  <b class="spoiler_title">For example, the code for the walls</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProcessWallEdges</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; _WallEdges.Count; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = i + <span class="hljs-number"><span class="hljs-number">1</span></span>; j &lt; _WallEdges.Count; j++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> edge1 = _WallEdges[i]; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> edge2 = _WallEdges[j]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Mathf.Abs(edge1.Normal.x) == Mathf.Abs(edge2.Normal.x) &amp;&amp; Mathf.Abs(edge1.Normal.y) == Mathf.Abs(edge2.Normal.y)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Edge.IsCanMerge(edge1, edge2)) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> edge = Edge.Merge(edge1, edge2); _WallEdges.Remove(edge1); _WallEdges.Remove(edge2); _WallEdges.Remove(edge); _WallEdges.Insert(i, edge); j = i; } } } } }</code> </pre> </div></div><br><img src="https://habrastorage.org/web/8d7/6cf/31c/8d76cf31c5c24ff0b2de210aa2860347.png"><br><br>  The rest is a matter of technology.  I have written my own tool for generating planes of the MeshTools class with the simplest triangulation (since we know the order of adding points). In general, unit Quads could be used, but in any case it would be necessary to recalculate the uv coordinates in order to The tiling of the material on all the walls was the same and in this case one material could be used.  More details can be viewed at the <a href="https://github.com/Nox7atra/Eller-maze-generator-Unity">link to GitHub</a> . <br><br><img src="https://habrastorage.org/web/30f/dff/9a7/30fdff9a760a4d0c897adfa9679befc9.png"><br><br>  So, the maze is built, correctly exposed uv-shki.  Now I want to show the simplest example of the possibility of post processing using the example of automatic light placement.  For this, I created the LightPlacer class and here we will again need the W4Maze maze.  Algorithm post processing is quite simple.  We simply set the illumination levels, translate the cell type to int, and decide whether to set the light source or not. <br><br><div class="spoiler">  <b class="spoiler_title">And again the code</b> <div class="spoiler_text"><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> GameObject </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetUpLights</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> W4Maze maze, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height</span></span></span><span class="hljs-function">)</span></span> { GameObject lights = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GameObject(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; maze.ColumnCount; i++) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; maze.RowCount; j++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cell = maze.GetCell(i, j); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(cell.ToInt() &lt; (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) _LightLevel) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lightGo = CreatePointLight(); lightGo.transform.position = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Vector3( i , height * <span class="hljs-number"><span class="hljs-number">0.9f</span></span>, j); } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lights; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> LightLevel : <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> { Low = <span class="hljs-number"><span class="hljs-number">3</span></span>, Medium = <span class="hljs-number"><span class="hljs-number">5</span></span>, High = <span class="hljs-number"><span class="hljs-number">10</span></span>, VeryHigh = <span class="hljs-number"><span class="hljs-number">16</span></span> }</code> </pre> </div></div><br>  And here is our final labyrinth! <br><br><img src="https://habrastorage.org/web/ff5/23c/f74/ff523cf746af474abd2fd1503316f24f.png"><br><br>  With the help of such post processing, you can arrange decals, enemies, traps, and anything else. <br><br>  Thanks for attention!  Who would like to get acquainted with the decision details <a href="https://github.com/Nox7atra/Eller-maze-generator-Unity">link to GitHub</a> . <br><br>  If someone would be more interested in the topic of mesh generation, which is an important part of the solution, I can write about this in a separate article. </div><p>Source: <a href="https://habr.com/ru/post/335974/">https://habr.com/ru/post/335974/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335964/index.html">How cloud service Drimkas Cabinet copes with spontaneous loads</a></li>
<li><a href="../335966/index.html">Celesta and Flute: Creating Business Logic in the Java Ecosystem</a></li>
<li><a href="../335968/index.html">Cloning the Lode Runner game from the first PC in the USSR "BK-0010" plus a few words about the programming of games in the late 80s</a></li>
<li><a href="../335970/index.html">We break haks completely. We read machine codes as an open book.</a></li>
<li><a href="../335972/index.html">Game model of behavior in the market of two competing firms in Python</a></li>
<li><a href="../335976/index.html">About website rejuvenation - decision criteria</a></li>
<li><a href="../335980/index.html">Configuring the automatic assembly of the project Unity3d in Gitlab CI</a></li>
<li><a href="../335982/index.html">How to create a map with the voices of fans for the Olympics. Lecture in Yandex</a></li>
<li><a href="../335986/index.html">One secure password for all occasions</a></li>
<li><a href="../335988/index.html">Replace and Conquer - the SOLID approach to developing reusable components on the web</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>