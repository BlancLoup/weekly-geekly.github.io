<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of storing PHP sessions in memcached</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article addresses one of the problems of storing PHP sessions in memcached: the absence of their blocking. 
 Introduction  It's no secret that on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of storing PHP sessions in memcached</h1><div class="post__text post__text-html js-mediator-article">  This article addresses one of the problems of storing <nobr>PHP sessions</nobr> in memcached: the absence of their blocking. <br><h4>  Introduction </h4>  It's no secret that one of the most popular ways to improve site performance is to use memcached.  This was repeatedly said and cited numerous examples.  The easiest way to do this is to use memcached to store <acronym>PHP</acronym> sessions.  To do this, there is no need to rewrite all the code, just a few simple steps.  I will not tell why it is necessary to store sessions in memcached.  I will talk about why storing sessions in memcached is dangerous. <br><a name="habracut"></a><br><h4>  Query Counter or "Who is to blame?" </h4>  Suppose we need to calculate the number of user‚Äôs navigation through the site (in practice, this can be anything from storing the user‚Äôs travel history through the site to purchases in the <nobr>online store‚Äôs</nobr> cart).  Consider an example consisting of 2 files: counter.php and frameset.php: <br><br><h5>  counter.php </h5><blockquote>  <font color="black">&lt;?</font>  <font color="black"><nobr>php</nobr></font> <font color="black"><br><br></font>  <font color="black"><font color="#008000">//ini_set('session.save_handler ',' memcache ');</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">//ini_set('session.save_path ',' tcp: // localhost: 11211 ');</font></font> <font color="black">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    </font>  <font color="black">session_start ();</font> <font color="black"><br><br></font>  <font color="black">$ _SESSION [ <font color="#A31515">'habra_counter'</font> ] = isset ($ _ SESSION [ <font color="#A31515">'habra_counter'</font> ])?</font>  <font color="black">$ _SESSION [ <font color="#A31515">'habra_counter'</font> ]: 0;</font> <font color="black"><br><br></font>  <font color="black">usleep (1,000,000);</font>  <font color="black"><font color="#008000">// Useful work</font></font> <font color="black"><br><br></font>  <font color="black">$ _SESSION [ <font color="#A31515">'habra_counter'</font> ] ++;</font>  <font color="black"><font color="#008000">// counter</font></font> <font color="black"><br><br></font>  <font color="black">usleep (1,000,000);</font>  <font color="black"><font color="#008000">// Useful work</font></font> <font color="black"><br><br></font>  <font color="black">echo <font color="#A31515">'Page count'</font> .</font>  <font color="black">$ _SESSION [ <font color="#A31515">'habra_counter'</font> ];</font> <font color="black"><br><br></font>  <font color="black">?&gt;</font> <font color="black"><br></font> </blockquote><br><h5>  frameset.php </h5><blockquote>  <font color="black">&lt;?</font>  <font color="black"><nobr>php</nobr> session_start ();</font>  <font color="black"><font color="#008000">// this is so that the cook got up?&gt;</font></font> <font color="black"><br></font>  <font color="black">&lt;form action = <font color="#A31515">""</font> method = <font color="#A31515">"post"</font> onsubmit = <font color="#A31515">"work (); return false;"</font></font>  <font color="black">&gt;</font> <font color="black"><br></font>  <font color="black">&lt;input type = <font color="#A31515">"submit"</font> name = <font color="#A31515">"submit"</font> <font color="#0000ff">value</font> = <font color="#A31515">"Work"</font> /&gt;</font> <font color="black"><br></font>  <font color="black">&lt;/ form&gt;</font> <font color="black"><br><br></font>  <font color="black">&lt;iframe src = <font color="#A31515">""</font> name = <font color="#A31515">"iframe1"</font> id = <font color="#A31515">"idframe1"</font> &gt; &lt;/ iframe&gt;</font> <font color="black"><br></font>  <font color="black">&lt;iframe src = <font color="#A31515">""</font> name = <font color="#A31515">"iframe2"</font> id = <font color="#A31515">"idframe2"</font> &gt; &lt;/ iframe&gt;</font> <font color="black"><br><br></font>  <font color="black">&lt;script&gt;</font> <font color="black"><br></font>  <font color="black">function work () {</font> <font color="black"><br></font>  <font color="black">document.getElementById ( <font color="#A31515">'idframe1'</font> ) .src = <font color="#A31515">'counter.php?</font></font>  <font color="black"><font color="#A31515">f = 1 '</font> + <font color="#2B91AF">Math</font> .random ();</font> <font color="black"><br></font>  <font color="black">document.getElementById ( <font color="#A31515">'idframe2'</font> ) .src = <font color="#A31515">'counter.php?</font></font>  <font color="black"><font color="#A31515">f = 1 '</font> + <font color="#2B91AF">Math</font> .random ();</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">&lt;/ script&gt;</font> </blockquote><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c8e/9c9/287/c8e9c928747e392a68d2e90cdcdd30af.jpg"><br>  <a href="http://foldo.ru/developer/habrahabr/standard-session/frameset.php">http://foldo.ru/developer/habrahabr/standard-session/frameset.php</a> <br><br>  Open frameset.php in the browser and see: each request to counter.php increases the counter in the session by one and the counter works correctly.  Now let's look at the same example, only with memcached sessions.  To do this, uncomment the 2 lines at the beginning of the script. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9dc/f86/b88/9dcf86b880daafaefe13514cae876d81.jpg"><br>  <a href="http://foldo.ru/developer/habrahabr/memcache-session/frameset.php">http://foldo.ru/developer/habrahabr/memcache-session/frameset.php</a> <br><br>  What do we see?  The counter does not work correctly.  Why?  Let's figure it out.  Consider what happens in reality.  If a session is stored in a file, when you call session_start, the file is opened, blocked, read, work with $ _SESSION is performed, after which the new value is written over the old one, the lock is removed from the file and the file is closed.  At the same time, the parallel thread honestly waits for the blocking to be released and only after that it works.  Unfortunately, at present there is no variable blocking in memcached, so it turns out that both streams read the same source data, process them and write them, and all changes of the first stream are irretrievably erased.  The table shows an approximate scheme of work for these two cases. <br><pre>  + - + ----------------------------------------- ++ --- ---------------------------------------- ++
 |  |  Sessions on the hard disk ||  Sessions in memcache ||
 + - + ------------------- + --------------------- ++ --- ------------------ + --------------------- ++
 |  |  Stream 1 |  Stream 2 ||  Stream 1 |  Stream 2 ||
 + - + ------------------- + --------------------- ++ --- ------------------ + --------------------- ++
 | 1 |  open file |  ||  connect memcache |  ||
 | 2 |  lock file |  open file ||  read memcache 5 |  connect memcache ||
 | 3 |  read file 5 |  lock file ||  work 5 + 1 |  read memcache 5 ||
 | 4 |  work 5 + 1 |  lock ||  write memcache 6 |  work 5 + 1 ||
 | 5 | |  write file 6 |  lock ||  close memcache |  write memcache 6 ||
 | 6 | |  unlock file |  lock ||  |  close memcache ||
 | 7 |  close file |  read file 6 ||  |  ||
 | 8 |  |  work 6 + 1 ||  |  ||
 | 9 | |  |  write file 7 ||  |  ||
 | 10 |  |  unlock file ||  |  ||
 | 11 |  |  close file ||  |  ||
 + - + ------------------- + --------------------- ++ --- ------------------ + --------------------- ++ </pre><br>  With the question "Who is to blame?" We figured out.  Let's summarize: <ol><li>  There is a possibility that with the active interaction of the client and the server, part of the data will be irretrievably lost; </li><li>  The transition to the storage of sessions in memcached may be simply impossible; </li><li>  Memcached allows you to reduce request processing time; </li><li>  In sessions, it is desirable to store only data that rarely changes (for example, a user profile); </li><li>  With an increase in the number of servers, memcahed can act as a single storage of sessions. </li></ol>  As you can see, the storage of sessions in memcached is not only flawed. <br><br><h4>  "What to do?" </h4>  We still have only one question - ‚ÄúWhat to do?‚Äù.  I will say right away that I do not have a ready-made solution, however there are two sketches on this subject.  Both sketches are based on the fact that memcached <nobr>still</nobr> has a way to organize a lock.  The lock is based on the Memcache class's add method.  About him in the documentation is written: <blockquote>  Returns TRUE on success or FALSE on failure.  Returns FALSE if such key already exist. </blockquote>  So, we can organize our own view lock: <br><blockquote>  <font color="black">function <font color="#0000ff">lock</font> ($ session_id, $ memcache)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black">$ max_iterations = 15;</font> <font color="black"><br></font>  <font color="black">$ iteration = 0;</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">while</font> (! $ memcache-&gt; add ( <font color="#A31515">'lock_'</font> . $ session_id, ...))</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black">$ iteration ++;</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">if</font> ($ iteration&gt; $ max_iterations) {</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">false</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font>  <font color="black">usleep (1000);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black"><font color="#0000ff">return</font> <font color="#0000ff">true</font> ;</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br><br></font>  <font color="black">function unlock ($ session_id, $ memcache)</font> <font color="black"><br></font>  <font color="black">{</font> <font color="black"><br></font>  <font color="black"><font color="#0000ff">return</font> $ memcache-&gt; del ( <font color="#A31515">'lock_'</font> . $ ession_id);</font> <font color="black"><br></font>  <font color="black">}</font> <font color="black"><br></font> </blockquote><br>  Using these two functions, we can write our <a href="http://ru2.php.net/manual/en/function.session-set-save-handler.php">session save handler</a> and use it, however, this will entail an additional load on the server and we will not receive any additional performance gain. <br><br>  I approached the question from the other side.  After analyzing my needs, I came to the conclusion that in reality I need to store only 2-3 groups of actively changing data.  In this case, the data often need to read, not write.  Therefore, I introduced the concept of subcession for myself.  Subsession (subsession) - a virtual object that is physically located outside the session.  Subsession is designed to store frequently changing data.  If a change in data is necessary, the subsession is blocked, read, modified, written and unlocked.  Here's how it looks from the outside: <br><blockquote>  <font color="black">$ <font color="#0000ff">this</font> -&gt; session-&gt; init_subsession ( <font color="#A31515">'fupload'</font> , $ <font color="#0000ff">this</font> -&gt; memc);</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// initialization of the subsession</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">/ * lock * /</font> $ <font color="#0000ff">this</font> -&gt; session-&gt; fupload-&gt; <font color="#0000ff">lock</font> ();</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// blocking the subsession</font></font> <font color="black"><br></font>  <font color="black">$ fupload = <font color="#0000ff">this</font> -&gt; session-&gt; fupload-&gt; <font color="#0000ff">get</font> ();</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// we get a subsession</font></font> <font color="black"><br><br></font>  <font color="black">$ fupload = is_array ($ fupload)?</font>  <font color="black">$ fupload: array ();</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// check for correctness</font></font> <font color="black"><br></font>  <font color="black">$ fupload [] = $ new_data;</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// add data</font></font> <font color="black"><br><br></font>  <font color="black">$ <font color="#0000ff">this</font> -&gt; session-&gt; fupload-&gt; <font color="#0000ff">set</font> ($ fupload);</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// record the session</font></font> <font color="black"><br></font>  <font color="black"><font color="#008000">/ * unlock * /</font> $ <font color="#0000ff">this</font> -&gt; session-&gt; fupload-&gt; unlock ();</font> <font color="black"><br></font>  <font color="black"><font color="#008000">// remove the lock</font></font> <font color="black"><br></font> </blockquote><br>  If you just need to get data from the subsession, you can not block.  So what does the subsession give me?  Most of the code is executed in unblocked mode, so no significant delays occur.  Reading data from a subsession also occurs in an unblocked form, so the lock does not work for the entire duration of the script, but only for short sections of it.  Yes, this somewhat complicates the code, but, in my opinion, the advantages are obvious. <br><br><h4>  findings </h4>  Session storage in memcached is great for multi-server systems.  In addition to a clear increase in performance, there is an additional increase (due to the absence of a lock).  The transition to the storage of sessions in memcached is very simple, but contains pitfalls.  At the design stage of the system, it is necessary to take into account the absence of a lock in memcached, and therefore it is necessary either to bypass this moment or implement the lock yourself. </div><p>Source: <a href="https://habr.com/ru/post/38261/">https://habr.com/ru/post/38261/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../38255/index.html">CSS creator Haakon Lee arrives in Russia</a></li>
<li><a href="../38257/index.html">Old firefox promo</a></li>
<li><a href="../38258/index.html">Samsung's stylish and expensive 1.8-inch drive</a></li>
<li><a href="../38259/index.html">Rumor: 01 Phone with 32 GB of memory and a projection keyboard will be presented in 24 days</a></li>
<li><a href="../38260/index.html">Has Yandex bot gone crazy?</a></li>
<li><a href="../38262/index.html">User motivation</a></li>
<li><a href="../38264/index.html">Javascripte rotating tag cloud</a></li>
<li><a href="../38265/index.html">Nvidia Unveils Details on Tegra Chip</a></li>
<li><a href="../38271/index.html">The state steals my money</a></li>
<li><a href="../38272/index.html">DinnerNow.net</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>