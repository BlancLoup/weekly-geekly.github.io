<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Object-Oriented Gin Installer Development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Link to the first part 
 Transactions. 
 Let me remind you that I was going to implement a transaction mechanism that allows you to roll back blocks o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Object-Oriented Gin Installer Development</h1><div class="post__text post__text-html js-mediator-article">  <a href="http://habrahabr.ru/blogs/refactoring/134439/">Link to the first part</a> <br><h4>  Transactions. </h4><br>  Let me remind you that I was going to implement a transaction mechanism that allows you to roll back blocks of operations when an error occurs inside a block protected by a transaction.  First, we must resolve the issue of responsibility for maintaining the state and for rolling back the operation.  I will say right away that the architecture that I will cite below loomed not immediately, but only after several attempts to design and implement the layout, until I succeeded in what I did. <br>  In order for the transaction architecture to be easily scalable, we will use inheritance as before.  At the same time, we will be responsible for maintaining the state and rolling back to the saved state on the command itself.  We take into account at the same time that not all commands are essentially transactional.  For example, reading from the registry cannot be part of a transaction, because it changes nothing in the system.  But writing to the registry is already part of the transaction.  And creating a file is part of a transaction. <br>  And therefore we will declare another abstract class TransactionalCommand, inherit it from the class Command. <br><a name="habracut"></a>  It will look like this: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionalCommand</span></span> : <span class="hljs-title"><span class="hljs-title">Command</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> TransactionStep </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context, Transaction transaction</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TransactionStep step</span></span></span><span class="hljs-function">)</span></span>; }</code> </pre> <br>  What happened?  We added an overload of the Do () method, assigning to it another argument of the Transaction type.  I will describe the Transaction class a little later, but I will say that in essence it is a transaction within which the command is executed.  The main purpose of the new Do (ExecutionContext, Transaction) method is as follows: <br><ol><li>  create a new transaction step TransactionStep, </li><li>  physically save (on disk, in the database, etc.) the state of the system, or rather those aspects of it that will change after the command is executed, </li><li>  call the Command class Do (ExecutionContext) method (that is, perform the initial non-transactional operation), </li><li>  return the TransactionStep created at the beginning. </li></ol><br>  We also added a Rollback () method that rolls back a transaction step. <br>  Thus, we assigned the responsibility for maintaining the state and rollback of the command to the command itself, which allows users to easily increase the array of transactional commands executed by the installer. <br>  The installer infrastructure should provide users with a structured repository for maintaining the state of the system before the transaction and the interface to access it.  In order to depend as little as possible on the installation of third-party components (such as databases, for example), I am going to present the state of the system as an arbitrary set of files stored in a specific subfolder of the installer's working folder.  Let the file structure look like this: <br> <code>%GIN_DIRECTORY%\packages\[PackageId]\transactions\[TransactionName]\steps\[StepNumber]\</code> <br>  Or in the form of a tree: <br><img src="https://habrastorage.org/getpro/habr/post_images/e9f/ecb/2eb/e9fecb2ebf964190a08a2bc845411c6f.jpg" alt="image"><br>  The infrastructure provides the user with paths to the [StepNumber] folders to save the state of the system before executing the command.  The infrastructure itself stores all other data in the appropriate folders of the tree, such as data about the transaction itself and its steps.  Of course, the infrastructure itself creates all this tree, saving the user from the routine work.  By user, I mean the developer of extensions for the installer. <br>  Here is the description of the TransactionStep class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">TransactionStep</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> STEPS_SUBFOLDER_NAME = <span class="hljs-string"><span class="hljs-string">@"steps"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> StepNumber { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TransactionName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TransactionalCommand Command { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetPath</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> transactionsPath = context.ExecutedPackage.TransactionsPath; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> transactionPath = Path.Combine(transactionsPath, TransactionName); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> stepsPath = Path.Combine(transactionPath, STEPS_SUBFOLDER_NAME); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> stepPath = Path.Combine(stepsPath, StepNumber.ToString()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!Directory.Exists(stepPath)) { Directory.CreateDirectory(stepPath); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> stepPath; } }</code> </pre><br>  As can be seen from the description of the class, the main purposes of the class are two: <br><ul><li>  creates a folder and returns the path to the folder to save the state of the system before performing the step </li><li>  Stores an instance of the corresponding command to enable rollback of a transaction step </li></ul><br>  From this class we will inherit subclasses of specific steps.  For example: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">SingleFileStep</span></span>: <span class="hljs-title"><span class="hljs-title">TransactionStep</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> OldFilePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  This subclass is suitable for any operations with a single file: file creation, file deletion, file modification.  This subclass provides the full path to the saved copy of the source file before it is modified. <br>  And now the Transaction class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Transaction</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> TransactionName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> TransactionState TransactionState { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;TransactionStep&gt; Steps { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Transaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Steps = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;TransactionStep&gt;(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> T CreateStep&lt;T&gt;(TransactionalCommand command) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: TransactionStep, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>() { T step = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> T(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> stepNumber = Steps.Count; step.StepNumber = stepNumber; step.Command = command; step.TransactionName = TransactionName; Steps.Add(step); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> step; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Save</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> transactionsPath = context.ExecutedPackage.TransactionsPath; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> transactionPath = Path.Combine(transactionsPath, TransactionName + <span class="hljs-string"><span class="hljs-string">@"\"</span></span>); Directory.CreateDirectory(transactionPath); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> dataFilePath = Path.Combine(transactionPath, <span class="hljs-string"><span class="hljs-string">@"data.xml"</span></span>); GinSerializer.Serialize(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, dataFilePath); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Steps.BackForEach(s =&gt; { s.Command.Rollback(s); }); } }</code> </pre><br>  As you can see, the main functions of the class are as follows: <br><ul><li>  adding a new step to the transaction and storing the sequence of the transaction steps </li><li>  save transaction to disk in the corresponding XML file </li><li>  roll back a transaction by performing a rollback on all steps of a transaction in the reverse order </li></ul><br>  The BackForEach method is an extension method that is rendered into a separate class in order not to clutter up the code of other classes.  Well, in general, I like to use extension methods and lambda expressions, please forgive me for this weakness. <br>  Consider now one of the classes by the successor of TransactionalCommand, in order to understand exactly how users should implement commands that support transactions. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CreateFile</span></span>: <span class="hljs-title"><span class="hljs-title">TransactionalCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> SourcePath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> DestPath { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { File.Copy(SourcePath, DestPath, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> TransactionStep </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context, Transaction transaction</span></span></span><span class="hljs-function">)</span></span> { SingleFileStep step = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (transaction != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { step = transaction.CreateStep&lt;SingleFileStep&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(DestPath)) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> rollbackFileName = Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"N"</span></span>) + <span class="hljs-string"><span class="hljs-string">".rlb"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> dataPath = step.GetPath(context); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> rollbackFilePath = Path.Combine(dataPath, rollbackFileName); step.OldFilePath = rollbackFilePath; File.Copy(DestPath, rollbackFilePath); } Do(context); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> step; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TransactionStep step</span></span></span><span class="hljs-function">)</span></span> { SingleFileStep currentStep = (SingleFileStep)step; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (File.Exists(currentStep.OldFilePath)) { File.Copy(currentStep.OldFilePath, DestPath, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { File.Delete(DestPath); } } }</code> </pre><br>  The Do () method with two arguments, in the framework of the transaction passed to it, creates a new transaction step using the CreateStep &lt;&gt; method, then checks whether the file already exists along the path where the installer should create a new file at the current step, and if the file is already there is, it copies it under a different name (although the name could not be changed) to the folder provided to it by the installer infrastructure (TransactionStep.GetPath), and only then it calls the Do () method inherited from the class of non-transactional Command commands, returning the result created at the beginning of the trance step  tion step. <br>  The Rollback method takes a transaction step as an argument, and checking its OldFilePath property either copies the old version of the file to the target folder, or deletes the file from the target folder. <br>  In the Transaction class code, you might notice the ExecutionContext.ExecutedPackage property, which represents a link to the executable within the context of the package.  This reference is initialized inside the Package class constructor.  Notice that the Package class has a property TransactionsPath, which indicates the path to the folder with the package transactions. <br><br>  So, we considered saving and rollback of one transaction step.  But in order to roll back the entire transaction, you need to perform the steps of the transaction in the reverse order.  And for the reason that we want to be able to roll back transactions previously saved to disk, we need to be able to load transactions from disk, since we already know how to save them to disk (see the Transaction.Save () method) <br>  To do this, we implement the LoadTransactions () method in the Package class.  Why in the class Package?  Because the main purpose of the Package class is to execute a package.  And transactions occur during the execution of a package, and are essentially a characteristic of an already executed package.  Thus, it will be logical to place the list of transactions in the Package class.  Here is the transaction loading code: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">LoadTransactions</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { _transactions = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Transaction&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (String.IsNullOrEmpty(TransactionsPath) || !Directory.Exists(TransactionsPath)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] transactionNames = Directory.GetDirectories(TransactionsPath); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> transactionNames) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> transactionPath = Path.Combine(TransactionsPath, name); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> dataFilePath = Path.Combine(transactionPath, TRANSACTIONS_DATA_FILENAME); Transaction transaction = GinSerializers.TransactionSerializer.Deserialize(dataFilePath); _transactions.Add(transaction); } }</code> </pre><br>  Everything is simple here: we get a list of all subfolders in the TransactionsPath folder (remember, this property appeared in the Package class not so long ago), the list of subfolder names will be a list of transaction names (remember the structure of the package file tree), and then for each name we form the full path to the transaction data.xml file and deserialize it into the next transaction.  In this case, the serializer will create a list of transaction nested steps, and commands nested in these steps, along with their Rollback () methods.  The LoadTransactions () method will be called in the Package class constructor.  In order not to disclose the internal structure of the transaction list to the clients of the Package class, we will add several methods to work with transactions to the interface of the Package class. <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> transactionName</span></span></span><span class="hljs-function">)</span></span> { Transaction transaction = GetTransactionByName(transactionName); transaction.Rollback(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Transaction transaction <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> _transactions) { transaction.Rollback(); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTransaction</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Transaction transaction</span></span></span><span class="hljs-function">)</span></span> { _transactions.Add(transaction); }</code> </pre><br><br>  We will understand now how to create transactions inside the package.  I would like to do this with the help of this pseudocode: <br><pre> <code class="cs hljs">PackageBody body = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PackageBody() { Command = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CommandSequence() { Commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Command[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TransactionContainer() { TransactionName = <span class="hljs-string"><span class="hljs-string">"myTransaction"</span></span>, Commands = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Command&gt;() { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFile() { SourcePath = <span class="hljs-string"><span class="hljs-string">@"D:\test\newfile.txt"</span></span>, DestPath = <span class="hljs-string"><span class="hljs-string">@"C:\test\folder1\file1.txt"</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFile() { SourcePath = <span class="hljs-string"><span class="hljs-string">@"D:\test\newfile.txt"</span></span>, DestPath = <span class="hljs-string"><span class="hljs-string">@"C:\test\folder1\file2.txt"</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThrowException() { Message = <span class="hljs-string"><span class="hljs-string">"Test exception"</span></span> }, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CreateFile() { SourcePath = <span class="hljs-string"><span class="hljs-string">@"D:\test\newfile.txt"</span></span>, DestPath = <span class="hljs-string"><span class="hljs-string">@"C:\test\folder1\file3.txt"</span></span> } } } } } }; PackageBuilder builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PackageBuilder(body); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> fileName = builder.GetResult(); Package pkg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Package(fileName); ExecutionContext ctx = pkg.Execute();</code> </pre><br>  As you can see, the structure of classes has changed significantly. <br><ol><li>  In the PackageBody class you can now pass a single command, in most cases it will be an instance of the CommandSequence command. </li><li>  To combine a sequence of commands into a transaction, use the TransactionContainer class, which is derived from Command.  It is similar to the CommandSequence, but it still has the optional TransactionName parameter. </li></ol><br>  Inside the TransactionContainer, I put in a few commands to create files, and in between them I threw in an exception throw.  The behavior of this package will be as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  The package will execute the first two CreateFile file creation commands. </li><li>  At the third ThrowException command, an exception will be thrown, and the package execution will stop, which means that the last CreateFile command will not be executed at all </li><li>  The batch will go to the transaction rollback procedure with the name myTransaction, rolling out the two CreateFile commands included in it. </li></ol><br>  Thus, the rollback of a transaction is not a rollback at all of all the package commands included in a transaction, but only a rollback of the executed transaction commands. <br>  Note also that the Package.Execute () method returns the context of the package to the user, for example, for informational purposes, so that you can see what the results of the executed commands are, the list of transactions and paths. <br>  The Execute () method of the Package class does a rather trivial job: <br><ol><li>  It creates on the disk all the folder structure necessary for the package to work (see the file tree structure of the package) </li><li>  Calls the Do () method of the Command of the PackageBody class. </li></ol><br>  Then the teams themselves begin their execution.  If it is a single command, then it is simply executed; if it is a CommandSequence, then it sequentially executes all the commands nested in it.  If this is a TransactionContainer, then it first creates a new transaction, and then sequentially executes the commands nested in it, passing them also the created transaction as an argument.  In this case, it is necessary to take into account the fact that both ordinary commands and commands supporting transactional execution can be nested in a transaction.  Accordingly, the TransactionContainer should monitor the parent type of the next executed command, calling their corresponding Do () overloaded method.  TransactionContainer executes a sequence of commands in a try catch finally container, and when an exception occurs in any of the nested commands, it must proceed to the rollback of the transaction by calling the Rollback () method of the current transaction.  At the end of the execution of a block of commands, it saves the transaction to disk for possible subsequent download and analysis of the transaction. <br>  The code of the Do () method of the TransactionContainer class in the first approximation looks like this: <br><pre> <code class="cs hljs">Transaction transaction = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Transaction() { TransactionName = TransactionName, TransactionState = TransactionState.Undefined }; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { context.Transactions.Add(transaction); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Command command <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Commands) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TransactionalCommand) { ((TransactionalCommand)command).Do(context, transaction); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { command.Do(context); } } transaction.TransactionState = TransactionState.Active; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> { transaction.Rollback(); } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { transaction.Save(context); }</code> </pre><br>  In this design step, the TransactionContainer installer is an ordered list of commands that are executed one after another as part of a single transaction.  But what if one of these teams is a container team, that is, a team in which one or several other teams are nested?  What if, for example, a ExecuteIf or CommandSequence command is executed within a transaction?  By themselves, ExecuteIf and CommandSequence do not support transactions, which means that if a transactional command is nested within them, then it will be executed outside the scope of the transaction, because Do (ExecutionContext) Do (ExecutionContext) methods will be executed with ExecuteIf and they are non-transactional .  This means that the teams nested in them will work outside the transaction, which is not a very good solution. <br>  Therefore, all container commands (ExecuteIf, ExecuteNotIf and CommandSequence, and any other container commands that the user adds to the installer) should be made transactional.  However, the container team itself will not add a step to a transaction, because it has nothing to report to the parent transaction ‚Äî the container command itself does not change anything in the system.  She will delegate responsibility for creating steps to her nested transactional teams.  That is, now any container team will be like this: <br><ul><li>  Empty Rollback Method (TransactionStep) </li><li>  The Do (ExecutionContext) method remains the same as before, that is, it simply executes a nested command or commands in accordance with the internal logic of the container command itself, calling it or them with the Do (ExecutionContext) method with one argument. </li><li>  The Do (ExecutionContext, Transaction) method with two arguments duplicates the internal logic of the Do (ExecutionContext) method, but at the same time checks from whom the nested command or commands are inherited, and if it is inherited from the TransactionalCommand, then it calls the Do (ExecutionContext, Transaction) method, and otherwise, the Do (ExecutionContext) method.  That is, the transactional check of the nested command has been transferred from the TransactionContainer class to the container class. </li><li>  Since the container command does not create its own step in the parent transaction, the Do (ExecutionContext, Transaction) method returns null. </li></ul><br>  The CommandSecquence and ExecuteIf classes, as described above, now look like this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CommandSequence</span></span>: <span class="hljs-title"><span class="hljs-title">TransactionalCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Command&gt; Commands; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Command command <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Commands) { command.Do(context); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> TransactionStep </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context, Transaction transaction</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (Command command <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Commands) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TransactionalCommand) { ((TransactionalCommand)command).Do(context, transaction); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { command.Do(context); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TransactionStep step</span></span></span><span class="hljs-function">)</span></span> { } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ExecuteIf</span></span> : <span class="hljs-title"><span class="hljs-title">TransactionalCommand</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ArgumentName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Command Command { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>)context.GetResult(ArgumentName)) { Command.Do(context); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> TransactionStep </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Do</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ExecutionContext context, Transactions.Transaction transaction</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((<span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>)context.GetResult(ArgumentName)) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Command <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> TransactionalCommand) { ((TransactionalCommand)Command).Do(context, transaction); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { Command.Do(context); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Rollback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TransactionStep step</span></span></span><span class="hljs-function">)</span></span> { } }</code> </pre><br>  Now we can create transactions containing commands of any level of nesting. <br><br>  <a href="http://habrahabr.ru/blogs/refactoring/134876/">Link to the third part</a> </div><p>Source: <a href="https://habr.com/ru/post/134512/">https://habr.com/ru/post/134512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134507/index.html">Wikipedia votes to temporarily disable the site in protest against SOPA</a></li>
<li><a href="../134508/index.html">New technology allows you to quickly embed new objects in images</a></li>
<li><a href="../134509/index.html">Installing Google Apps in the Android Emulator</a></li>
<li><a href="../134510/index.html">The company EZ-Robot offers designer robots</a></li>
<li><a href="../134511/index.html">Digitized drafts and notebooks of Newton</a></li>
<li><a href="../134515/index.html">Thesaurus Rutes: Structure and Applications - New Workshop in the ABBYY Open Series</a></li>
<li><a href="../134517/index.html">TOR: Negligence of leadership</a></li>
<li><a href="../134518/index.html">Critical error in the method of processing SMS messages in Windows Phone 7</a></li>
<li><a href="../134520/index.html">Co-ownership and domain management</a></li>
<li><a href="../134521/index.html">We decorate the desktop with random wallpapers with GoodFon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>