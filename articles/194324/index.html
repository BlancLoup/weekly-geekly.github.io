<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Determining the weights of the importance of users relative to each other based on their actions (Tarantool + Lua)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a system with many users. Each user of the system can perform actions in relation to each other. Based on these actions, the weight is calcul...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Determining the weights of the importance of users relative to each other based on their actions (Tarantool + Lua)</h1><div class="post__text post__text-html js-mediator-article">  There is a system with many users.  Each user of the system can perform actions in relation to each other.  Based on these actions, the weight is calculated.  It is necessary to be able for each user to get a list of other users of the system, sorted in descending order of weight.  The weights characteristics of an inactive user should not change. <br><br><img src="https://habrastorage.org/storage3/cb4/acd/6ba/cb4acd6ba37325003f11a9e6dd5da997.png"><br><br>  In my <a href="http://habrahabr.ru/company/mailru/blog/192076/">last article,</a> I described the basic concepts and means to start working with a tarantula.  In this article I will try to pay more attention to the use of stored procedures in the Tarantula on the example of one game task. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  For simplicity, let's imagine that a system is a game, and a user is a player. <br><br>  For example, you have an online game in which players can view each other's achievements, attack each other, send messages, transfer virtual money, trade, etc. For each player you need to be able to sort the rest of the players.  At the same time, the weight by which sorting takes place should depend not only on the activity, but also on what kind of activity was shown by the player.  For example, when viewing a profile, the weight does not increase much, but during a trade operation it is much more. <br><br>  A fairly standard statistical task in our difficult programmer everyday life.  In this article I will show how it can be implemented using Tarantool + Lua.  In my last article I told you how a tarantula is assembled and configured;  In this article I will dwell in greater detail not only on the scheme but also in detail about Lua and how to work with the good received from Perl. <br><br>  What we need to solve this problem: <br><br>  A table consisting of fields in which the identifier of the player to be sampled is to be stored, the identifier of the player that is in the selection, and weight.  In other words, this is a graph representation as an array of faces with a weight.  But, given that the weight can not only increase, but it must also be reduced from day to day, you will have to keep the date of the last update of the player‚Äôs weight.  Of course, the date can not be stored, but then you have to go over all the records every day and count all the weights.  Let's simplify the task a bit, since  we are not given a formula by which we need to calculate the weight reduction, let‚Äôs say that the weight is evenly reduced to zero within 30 days, provided that no action is taken on this player, but are made on other players.  Therefore, we will also need the date of the last action in relation to the player, and better already calculated coefficient, which is calculated once at the moment of active action.  The weight will be increased depending on the action produced in relation to the participant.  However, the task states that the weights should not change if the player was not at all active.  Actually, to implement this condition, we will need to keep the date of the last activity of the user. <br>  The participant weights schedule should look something like this: <br><br><img src="https://habrastorage.org/storage3/aec/323/60a/aec32360a27b6013caddf72da7072a3d.png"><br><br>  One of the significant places on the chart is 05.02. At this point, it can be seen that actions begin to take place only in relation to the player, whose weight chart is indicated in orange.  And at around 17.02 actions are not performed in relation to any user, so the weights remain at the same level. <br><br>  Total, we get 2 spaces.  The first of 5 fields: <br>  Player1 <br>  Player2 <br>  Weight <br>  Last updated date <br>  The ratio of weight loss per day <br>  The second of 2 fields: <br>  Player1 <br>  Last player activity date1 <br><br>  Now let's analyze what indexes we need: <br>  Once we go to choose the attitude of one player to all others, we need a non-unique index on the first record.  We also want to get a sorted list by weight, so we need a composite index for the 1 + 3 field.  And of course, you need to build a unique index of 1 + 2 fields for a point sample of one player relative to another, it will be primary.  With the second space everything is simpler, you need only one unique index by the first record. <br>  Tarantula configuration: <br><br><pre><code class="lua hljs">slab_alloc_arena = <span class="hljs-number"><span class="hljs-number">1</span></span> pid_file = <span class="hljs-string"><span class="hljs-string">"box.pid"</span></span> logger=<span class="hljs-string"><span class="hljs-string">"cat - &gt;&gt; Tarantool.log"</span></span> primary_port = <span class="hljs-number"><span class="hljs-number">33013</span></span> secondary_port = <span class="hljs-number"><span class="hljs-number">33014</span></span> admin_port = <span class="hljs-number"><span class="hljs-number">33015</span></span> rows_per_wal = <span class="hljs-number"><span class="hljs-number">5000000</span></span> #    space[<span class="hljs-number"><span class="hljs-number">0</span></span>].enabled = <span class="hljs-number"><span class="hljs-number">1</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"HASH"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].unique = <span class="hljs-number"><span class="hljs-number">1</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].fieldno = <span class="hljs-number"><span class="hljs-number">0</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"NUM"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">1</span></span>].fieldno = <span class="hljs-number"><span class="hljs-number">1</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"NUM"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"TREE"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">1</span></span>].unique = <span class="hljs-number"><span class="hljs-number">0</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">1</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].fieldno = <span class="hljs-number"><span class="hljs-number">0</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">1</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"NUM"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">2</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"TREE"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">2</span></span>].unique = <span class="hljs-number"><span class="hljs-number">0</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">2</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].fieldno = <span class="hljs-number"><span class="hljs-number">0</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">2</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"NUM"</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">2</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">1</span></span>].fieldno = <span class="hljs-number"><span class="hljs-number">2</span></span> space[<span class="hljs-number"><span class="hljs-number">0</span></span>].index[<span class="hljs-number"><span class="hljs-number">2</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">1</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"NUM"</span></span> space[<span class="hljs-number"><span class="hljs-number">1</span></span>].enabled = <span class="hljs-number"><span class="hljs-number">1</span></span> space[<span class="hljs-number"><span class="hljs-number">1</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"HASH"</span></span> space[<span class="hljs-number"><span class="hljs-number">1</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].unique = <span class="hljs-number"><span class="hljs-number">1</span></span> space[<span class="hljs-number"><span class="hljs-number">1</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].fieldno = <span class="hljs-number"><span class="hljs-number">0</span></span> space[<span class="hljs-number"><span class="hljs-number">1</span></span>].index[<span class="hljs-number"><span class="hljs-number">0</span></span>].key_field[<span class="hljs-number"><span class="hljs-number">0</span></span>].<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> = <span class="hljs-string"><span class="hljs-string">"NUM"</span></span></code> </pre> <br><br>  Tarantula is ready, you can initialize the storage: <br><br><pre> <code class="bash hljs">$ tarantool_box --init-storage tarantool/src/box/tarantool_box: space 0 successfully configured tarantool/src/box/tarantool_box: space 1 successfully configured tarantool/src/box/tarantool_box: creating `./00000000000000000001.snap.inprogress<span class="hljs-string"><span class="hljs-string">' tarantool/src/box/tarantool_box: saving snapshot `./00000000000000000001.snap'</span></span> tarantool/src/box/tarantool_box: <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br><br>  Storage is prepared, you can write Lua procedures. <br>  We need two procedures: <br><ol><li>  user action registration (increase_score) </li><li>  get sorted user list (get_top) </li></ol><br><br>  We implement them in the box_popular_user.lua file, we place the configuration variables in box_config_popular_user.lua <br>  Then to connect this plugin in init.lua you need to write 1 line: dofile ("box_popular_user.lua") <br><br>  So, now more about increase_score (). <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increase_score</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id, friend_id, action_type)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">--    local id = tonumber(user_id) local fid = tonumber(friend_id) if not id or not fid or not map_type_score[action_type] then return false end --     local dt = os.date('*t') local cd = box.time{year = dt.year; month=dt.month; day=dt.day} --     ,          local last_update = box.select('1', '0', id) if not last_update then last_update = box.insert('1',id,cd) end --        local difft = math.floor(( cd-box.unpack('i',last_update[1]) )/24/60/60) --    ,       if difft ~= 0 then if difft &gt; 1 then --      ,        ,        -- ,           ,     table.insert(updates_in_fibers,id,box.fiber.wrap(function() _move_last_update(id, cd, difft) end)) difft = difft-1 else difft = 0 end box.update('1',id,'=p',1,cd) end --       local tup = box.select('0','0', id, fid) --          _get_score_koef if not tup then --      ,   local s_k = _get_score_koef(nil, nil, map_type_score[action_type], nil, cd) tup = box.insert('0', id, fid, s_k[1], cd, s_k[2]) else --      local s_k = _get_score_koef(box.unpack('i', tup[3])+difft, box.unpack('i', tup[2]), map_type_score[action_type], box.unpack('i',tup[4]), cd) --       ,       ,       tup = box.update('0',{id;fid},'=p=p=p',2, s_k[1],3,cd,4,s_k[2]) end return tup end</span></span></code> </pre><br><br>  We can get caught by a very ‚Äúrich‚Äù player on relationships with other players in his list, who have not logged in for a long time, so we will update the date of the last weight conversion in relation to other players in a separate stream in order to respond faster.  And of course, let's not forget to protect ourselves from parallel tasks for the same user and we will not recalculate weights until all the dates are updated.  Actually, the function of updating dates: <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_move_last_update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id, cd, diff)</span></span></span></span> weights = box.space[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tup <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> weights.index[<span class="hljs-number"><span class="hljs-number">1</span></span>]:iterator(box.index.EQ, id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-comment"><span class="hljs-comment">--        if box.unpack('i',tup[3]) &lt; cd then weights:update({box.unpack('i',tup[1]); box.unpack('i',tup[2])},'=p', 3, box.unpack('i',tup[3])+diff) end end --     id    table.remove(updates_in_fibers, id) end</span></span></code> </pre><br><br>  Here we use update which gives control to another thread, than we will protect ourselves from the fact that until the dates are updated, no longer one client will receive a response. <br><br>  Now consider the weight recalculation function and its reduction factor. <br><br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_get_score_koef</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(last_update, last_score, add_score, koef, current_date)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> score = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> last_score <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-comment"><span class="hljs-comment">--        ,     ,            score = add_score else if current_date == last_update then --       ,          score = last_score + add_score else --      ,           local diff = (current_date-last_update)/24/60/60*koef if diff &gt; last_score then -- ,    ,  ,    -       diff = last_score end --      ,   score = last_score + add_score - diff end end if add_score then --   ,   ,        ,     koef = score/box_pu_default['score_day'] end return {score,koef}; end</span></span></code> </pre><br><br>  To improve performance, we change only those records that require it.  We act in the same way when selecting records, if the record needs to be updated, we will update it, if not, we will not.  The logic that determines the need to update the record is the same as in the weight change function.  But let's complicate our life and make it possible to select only specified users sorted in descending order. <br><br>  Consider the feature get users <br><pre> <code class="lua hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_top</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(user_id, count_users, ids)</span></span></span></span> <span class="hljs-comment"><span class="hljs-comment">--   ,          (   "box_config_popular_user.lua") local id = tonumber(user_id) if not id then return false end local cu if not count_users then cu = box_pu_default['count_users'] else cu = tonumber(count_users) end local id_users = {} local count = 0 --    id   ,   ,    -   -  ,    if ids then for id in string.gmatch(ids, "%d+") do id_users[tonumber(id)] = 1 count=count+1 end if(count &lt; cu) then cu = count end end --      local ret local last_update = box.select('1', '0', id) --  2                     for iter = 1, 2 do local need_update = {} ret = {} for v in box.space[0].index[2]:iterator(box.index.LE, id) do --         -  if not v or #ret == cu or box.unpack('i',v[0]) ~= id then break end --    ,    ,   if not ids or id_users[box.unpack('i',v[1])] == 1 then --                   --  ,         if not updates_in_fibers[id] and box.unpack('i', v[3]) ~= box.unpack('i', last_update[1]) then table.insert(need_update, v) else --        table.insert(ret, v) end end end local need_another_req = 0 for i = 1, #need_update do local v = need_update[i] local s_k = _get_score_koef(box.unpack('i', v[3]), box.unpack('i', v[2]), 0, box.unpack('i',v[4]), box.unpack('i', last_update[1])) --   ,      if s_k[1] == 0 then box.delete('0',{v[0],v[1]}) else --       ,    , ..     box.update('0',{v[0];v[1]},'=p=p=p',2, s_k[1],3,box.unpack('i', last_update[1]),4,s_k[2]) need_another_req = 1 end end if need_another_req == 0 then break end end return unpack(ret) end</span></span></code> </pre><br><br>  In the configuration file box_config_popular_user.lua put the following values: <br><br><pre> <code class="lua hljs">map_type_score={user_page=<span class="hljs-number"><span class="hljs-number">100</span></span>} <span class="hljs-comment"><span class="hljs-comment">--      increase_score,  ,  ,         increase_score box_pu_default={count_users=10;score_day=30} -- -    get_top  -        , .</span></span></code> </pre><br><br>  The first line in the box_popular_user.lua file is the config file: <br><pre> <code class="lua hljs"><span class="hljs-built_in"><span class="hljs-built_in">dofile</span></span>(<span class="hljs-string"><span class="hljs-string">"box_config_popular_user.lua"</span></span>)</code> </pre><br><br>  Actually, to install this plugin, you need to put these two files in the working directory.  Register the desired configuration values.  Write in init.lua line to connect the plugin.  Restart the tarantula and use.  And, of course, do not forget about the configuration of the spaces. <br><br>  Now look at this system in terms of use. <br><br>  Let's write the simplest test on perl, which synchronously feeds Tarantula data in a single stream based on some log. <br><br>  In the log there will be lines containing the name of the function to be pulled in the tarantula and a set of parameters to be transferred there.  This is a synthetic log file, but this one is needed not to load our script with additional work, we check the tarantula for consistency. <br><br>  To work with the tarantula, we need the DR :: Tarantool module, it can be installed from <a href="">pan</a> , you can install it through your favorite package manager yum, apt, ... <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> strict; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> DR::Tarantool <span class="hljs-string"><span class="hljs-string">':constant'</span></span>, <span class="hljs-string"><span class="hljs-string">'tarantool'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $client = tarantool <span class="hljs-string"><span class="hljs-string">host =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">port =&gt;</span></span> <span class="hljs-number"><span class="hljs-number">33013</span></span>, <span class="hljs-string"><span class="hljs-string">spaces =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">0 =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'user_score'</span></span>, <span class="hljs-string"><span class="hljs-string">default_type =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'NUM'</span></span>, <span class="hljs-string"><span class="hljs-string">fields =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">qw(id fid score last_update koef)</span></span>, ], <span class="hljs-string"><span class="hljs-string">indexes =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">0 =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'idx_id_fid'</span></span>, <span class="hljs-string"><span class="hljs-string">fields =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'fid'</span></span> ] }, <span class="hljs-string"><span class="hljs-string">1 =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'idx_id'</span></span>, <span class="hljs-string"><span class="hljs-string">fields =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> ] }, <span class="hljs-string"><span class="hljs-string">2 =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'idx_id_score'</span></span>, <span class="hljs-string"><span class="hljs-string">fields =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">'id'</span></span>, <span class="hljs-string"><span class="hljs-string">'score'</span></span> ] }, } }, <span class="hljs-string"><span class="hljs-string">1 =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'user_last_update'</span></span>, <span class="hljs-string"><span class="hljs-string">default_type =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'NUM'</span></span>, <span class="hljs-string"><span class="hljs-string">fields =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">qw(id last_update)</span></span>, ], <span class="hljs-string"><span class="hljs-string">indexes =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">0 =&gt;</span></span> { <span class="hljs-string"><span class="hljs-string">name =&gt;</span></span> <span class="hljs-string"><span class="hljs-string">'idx_id'</span></span>, <span class="hljs-string"><span class="hljs-string">fields =&gt;</span></span> [ <span class="hljs-string"><span class="hljs-string">'id'</span></span> ] }, } }, }; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(&lt;&gt;){ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $line = $_; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @params = <span class="hljs-keyword"><span class="hljs-keyword">split</span></span>( <span class="hljs-string"><span class="hljs-string">" "</span></span>, $line); $client-&gt;call_lua($params[<span class="hljs-number"><span class="hljs-number">0</span></span>], @params[<span class="hljs-number"><span class="hljs-number">1</span></span>..$#params],($params[<span class="hljs-number"><span class="hljs-number">0</span></span>] eq <span class="hljs-string"><span class="hljs-string">'increase_score'</span></span> ? (<span class="hljs-string"><span class="hljs-string">'user_page'</span></span>) : ()); };</code> </pre><br><br><img src="http://habrastorage.org/storage3/374/948/bf0/374948bf045aa7c6e76e465da080d300.png"><br><br>  Here is such a small script, in which most of it is a description of the spaces, can work with a tarantula.  In fact, the part that sent the data to graphite was thrown out of this script, since we are more interested in working with a tarantula.  Actually in one thread I received a total of about 3500 requests per second. <br>  However, the tarantula ate only about 17% of the CPU.  Let's try to run the script in 4 threads. <br><br><img src="http://habrastorage.org/storage3/18a/b4a/71c/18ab4a71c779d74166c719d5daefffac.png"><br><br>  Each of the scripts managed to feed the tarantula approximately 1050 records from the log per second, and all four simultaneously about 4200 records per second.  Tarantula while eating about 38% of the processor.  Not much gain.  Although our scripts that send data to the tarantula are also not rested against the processor. <br><br>  During the proceedings, what is the problem and where our system is blundering, I found that DR :: Tarantool also uses AnyEvent in synchronous mode and moreover, for each request that arrives, it generates a new AE :: io, which in turn causes a system select which, in my opinion, causes some delays.  More deeply, I decided not to dig, but just wrote another test program, but using <a href="https://github.com/Mons/Client-Tarantool">Client :: Tarantool</a> .  All I had to do was change the use and initialization of the client. <br><br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> Client::Tarantool; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $client = Client::Tarantool-&gt;new...</code> </pre><br><br>  And so we start and look at the graph: <br><br><img src="http://habrastorage.org/storage3/75c/977/7e5/75c9777e5b2dcdf6b34974a6fb650707.png"><br><br>  Initially, the new script worked in 1 thread, rested on 100% of the CPU, then it was launched in 3 threads, each of which also rested on 100% of the CPU and, what was very pleased, was that the number of requests to the tarantula grew!  Then they launched into 4 threads and then Tarantula ran into 100% CPU.  Total it turned out about 18-20K requests per second.  Further, for verification, the fifth process was also launched, and, as expected, the number of requests for each stream fell and evenly distributed, remaining at the level of 18-20K. <br><br>  This synchronous protocol does not use AnyEvent, it uses pure syswrite and sysread, which to some extent confirms the theory with timeouts when using ‚Äúextra‚Äù AE :: io. <br><br>  And now, finally, in order not to criticize AnyEvent at all, let's write an asynchronous test based on DR :: Tarantool :: AsyncClient. <br><br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/perl use strict; use DR::Tarantool::AsyncClient 'tarantool'; use AnyEvent; use AnyEvent::Handle; my $cv = condvar AnyEvent; my $counts = {}; my $hdl; my $w; my $client; #        my $done_sub = sub { $counts-&gt;{ae}--; $cv-&gt;send unless $counts-&gt;{ae}; }; #      my $read_line_sub = sub { my $line = shift; my @params = split( " ", $line); $counts-&gt;{ae}++; $counts-&gt;{$params[0]}++; $client-&gt;call_lua($params[0], [@params[1..$#params],($params[0] eq 'increase_score' ? ('user_page') : ())], $done_sub); }; my $limit_concur_req = 12000; #  -   DR::Tarantool::AsyncClient-&gt;connect( host =&gt; '127.0.0.1', port =&gt; 33013, spaces =&gt; { 0 =&gt; { name =&gt; 'user_score', default_type =&gt; 'NUM', fields =&gt; [ qw(id fid score last_update koef), ], indexes =&gt; { 0 =&gt; { name =&gt; 'idx_id_fid', fields =&gt; [ 'id', 'fid' ] }, 1 =&gt; { name =&gt; 'idx_id', fields =&gt; [ 'id' ] }, 2 =&gt; { name =&gt; 'idx_id_score', fields =&gt; [ 'id', 'score' ] }, } }, 1 =&gt; { name =&gt; 'user_last_update', default_type =&gt; 'NUM', fields =&gt; [ qw(id last_update), ], indexes =&gt; { 0 =&gt; { name =&gt; 'idx_id', fields =&gt; [ 'id' ] }, } }, }, sub { ($client) = @_; $counts-&gt;{ae}++; $hdl = new AnyEvent::Handle fh =&gt; \*STDIN, on_error =&gt; sub { #     my ($hdl, $fatal, $msg) = @_; AE::log error =&gt; $msg; $hdl-&gt;destroy; $cv-&gt;send; }, on_eof =&gt; $done_sub; my @start_request; #        @start_request = (line =&gt; sub { my ($hdl, $line) = @_; $line =~ s/[\r\n]//g; $read_line_sub-&gt;($line) if $line; #       -      $hdl-&gt;push_read (@start_request) if $counts-&gt;{ae} &lt; $limit_concur_req; }); $w = AnyEvent-&gt;timer (after =&gt; 0, interval =&gt; 1, cb =&gt; sub{ #             $limit_concur_req += 1000 if $counts-&gt;{ae} &lt; 1000; $hdl-&gt;push_read (@start_request) if $counts-&gt;{ae} &lt; $limit_concur_req; }); } ); $cv-&gt;recv;</span></span></code> </pre><br><br>  The script turned out to be more spreading and, perhaps, not very well read, but this largely depends on the habit of reading the event code. <br>  We run 4 such scripts in parallel on the same machine and on the same data in order to equalize the odds between tests. <br><br><img src="http://habrastorage.org/storage3/694/639/8cf/6946398cf260f01ff2aa203d5fb29aa0.png"><br><br>  And we get an increase in relation to the first synchronous test 7 times!  And almost 2 times in relation to the second test.  This is approximately 30,000 requests per second.  At the same time, the pearl barley scripts sending data to the tarantula work almost at the limit of 100% CPU <br><br>  Now we‚Äôll do the worst conditions for our algorithm, this is when all the players didn‚Äôt go in a few days, and then they all came back together, this shouldn‚Äôt be normal in normal life, so this test is synthetic, but it will show the lower bar for performance.  In order to understand the order of numbers, we have 14169698 records in the first space at the time of the test launch.  The largest number of relations of players 5000. <br><br><img src="http://habrastorage.org/storage3/7b4/17e/50a/7b417e50a872e82eebea04ea7caf4c60.png"><br><br>  Total, on average, we get about 20,000 requests per second, although the spread among the workers has become more, some of them get on players with a large number of connections, someone on players with a smaller number of connections. <br><br>  So, we have a box that can solve the problem with a capacity of 30,000 requests per second (20,000 in the pessimistic version), which, in general, will satisfy the needs of many projects. </div><p>Source: <a href="https://habr.com/ru/post/194324/">https://habr.com/ru/post/194324/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../194310/index.html">The Most Difficult Game</a></li>
<li><a href="../194312/index.html">Google vs. Death = Calico</a></li>
<li><a href="../194314/index.html">You understand Hadoop wrong</a></li>
<li><a href="../194316/index.html">USB condom. Malware via USB</a></li>
<li><a href="../194318/index.html">CyanogenMod installer will appear in Google Play, developers have received $ 7 million investment</a></li>
<li><a href="../194326/index.html">New Brief: Samsung announced the start of mass production of new 4-gigabit DDR4 memory</a></li>
<li><a href="../194332/index.html">TeamLab PM for iOS as the start of a series of mobile applications for business</a></li>
<li><a href="../194334/index.html">Sales of GTA 5 in the first 24 hours amounted to $ 800 million</a></li>
<li><a href="../194336/index.html">Microsoft buys almost all old mobile devices</a></li>
<li><a href="../194338/index.html">Neustar: the risk assessment of new gTLDs is greatly overestimated</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>