<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Symfony 2 internals in practice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The post is inspired by this issue. We will use standard symfony events to override the controller output. So, in general, it will all work: 


1. Cre...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Symfony 2 internals in practice</h1><div class="post__text post__text-html js-mediator-article">  The post is inspired by <a href="http://habrahabr.ru/qa/22083/">this</a> issue.  We will use standard symfony events to override the controller output.  So, in general, it will all work: <br><ol><li>  Create an Ajax annotation to handle the controller content type </li><li>  We will process this annotation through events </li><li>  We will override the content type in accordance with the selected type in the annotation </li></ol><br>  I'll warn you right away that the code does not pretend to be perfect, caching is not used (I will say more about it later), but I think the main idea will be clear.  You can also read more about Symfony2 Internals in the <a href="http://symfony.com/doc/current/book/internals.html">official documentation</a> . <br><a name="habracut"></a><br>  So let's break. <br>  First, let's define the annotation class: <br><pre><code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">SomeNamespace</span></span>\<span class="hljs-title"><span class="hljs-title">SomeBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Annotations</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@Annotation</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Ajax</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@contentType</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $contentType; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@parameters</span></span></span><span class="hljs-comment"> */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $parameters; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($data[<span class="hljs-string"><span class="hljs-string">'value'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;contentType = $data[<span class="hljs-string"><span class="hljs-string">'value'</span></span>]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($data[<span class="hljs-string"><span class="hljs-string">'parameters'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parameters = $data[<span class="hljs-string"><span class="hljs-string">'parameters'</span></span>]; } } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> array $contentType */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setContentType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($contentType)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;contentType = $contentType; } <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContentType</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;contentType; } }</code> </pre> <br>  This annotation determines the type of content returned by the controller. <br>  Next, create an event listener: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">SomeNamespace</span></span>\<span class="hljs-title"><span class="hljs-title">SomeBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Event</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpKernel</span></span>\<span class="hljs-title"><span class="hljs-title">Event</span></span>\<span class="hljs-title"><span class="hljs-title">KernelEvent</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpKernel</span></span>\<span class="hljs-title"><span class="hljs-title">Event</span></span>\<span class="hljs-title"><span class="hljs-title">GetResponseForControllerResultEvent</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Doctrine</span></span>\<span class="hljs-title"><span class="hljs-title">Common</span></span>\<span class="hljs-title"><span class="hljs-title">Annotations</span></span>\<span class="hljs-title"><span class="hljs-title">Reader</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">Symfony</span></span>\<span class="hljs-title"><span class="hljs-title">Component</span></span>\<span class="hljs-title"><span class="hljs-title">HttpFoundation</span></span>\<span class="hljs-title"><span class="hljs-title">Response</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Controller Event listener */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ControllerListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ServiceContainer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $container; <span class="hljs-comment"><span class="hljs-comment">/** * Parameters of Event Listener * * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $parameters; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> AnnotationsReader */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $annotationReader; <span class="hljs-comment"><span class="hljs-comment">//     -   Core/ContentTypes public function __construct($c, $a) { $this-&gt;container = $c; $this-&gt;annotationReader = $a; //@TODO   ,        . ,    -      ,   . $classes = array(); $namespace = 'SomeNamespace\SomeBundle'; $namespace = str_replace('\\', '/', $namespace); $dir = opendir('../src/' . $namespace . '/Core/ContentTypes'); while ($classes[] = str_replace('.php', '', readdir($dir))) { ; } foreach ($classes as $key =&gt; $class) { if ($class == '') { unset($classes[$key]); continue; } if ($class[0] == '.') { unset($classes[$key]); } } $this-&gt;parameters['contentTypes'] = $classes; } /** * Controller event listener * * @param \Symfony\Component\HttpKernel\Event\KernelEvent $event */ public function onKernelController(KernelEvent $event) {//      .     .    ,     ,    ,        $controller = $event-&gt;getController(); $object = new \ReflectionObject($controller[0]); $method = $object-&gt;getMethod($controller[1]); $annotations = $this-&gt;annotationReader-&gt;getMethodAnnotations($method); $response = new Response(); $this-&gt;parameters['attributes'] = $event-&gt;getRequest()-&gt;attributes; foreach ($annotations as $annotation) { if ($annotation instanceof \ITE\JSBundle\Annotations\Ajax) { $this-&gt;parameters['annotation'] = $annotation; } } $class = NULL; $params = array(); if (isset($this-&gt;parameters['annotation'])) { if (isset($this-&gt;parameters['annotation']-&gt;parameters)) { $params = $this-&gt;parameters['annotation']-&gt;parameters; } foreach ($this-&gt;parameters['contentTypes'] as $contentType) { $className = '\ITE\JSBundle\Core\ContentTypes\\' . $contentType; $name = $className::getName(); if ($name == $this-&gt;parameters['annotation']-&gt;contentType) { $class = $className; } } if (!$class) { throw new \ITE\JSBundle\Core\Exception\ContentTypeException( 'ContentType "' . $this-&gt;parameters['annotation']-&gt;contentType . '" is not found!'); } //  -    .     . $contentType = new $class($this-&gt;container, $params); $this-&gt;parameters['contentType'] = $contentType; $contentType-&gt;hookPre($event-&gt;getRequest()); } } /** * Controller Response listener * * @param $event */ public function onKernelResponse($event) {//       .     javascript  , ,    Symfony Profiler.        $response = $event-&gt;getResponse(); $response = $this-&gt;addJavascript($response); $event-&gt;setResponse($response); } /** * Controller Request listener * * @param $event */ public function onKernelRequest($event) { //    .      $this-&gt;generateRoutes(); } /** * Controller response listener * * @param GetResponseForControllerResultEvent $event */ public function onKernelView(GetResponseForControllerResultEvent $event) { //     .    onKernelResponse if (isset($this-&gt;parameters['contentType'])) { $contentType = $this-&gt;parameters['contentType']; $response = new Response; $response-&gt;setContent($contentType-&gt;encodeParameters($event-&gt;getControllerResult())); $response = $contentType-&gt;hookPost($response); $event-&gt;setResponse($response); } } /** * Generating route array and move to javascript file */ private function generateRoutes() { //  ,       $routeCollection = $this-&gt;container-&gt;get('router')-&gt;getRouteCollection(); $routes = array(); foreach ($routeCollection-&gt;all() as $route) { $r = array(); $defaults = $route-&gt;getDefaults(); try { $method = new \ReflectionMethod($defaults['_controller']); } catch (\Exception $e) { continue; } $ann = $this-&gt;annotationReader-&gt;getMethodAnnotations($method); foreach ($ann as $a) { if ($a instanceof \Sensio\Bundle\FrameworkExtraBundle\Configuration\Route) { $r[$a-&gt;getName()] = $route-&gt;getPattern(); } } $routes += $r; } $path = __FILE__; $path = str_replace('Event' . DIRECTORY_SEPARATOR . 'ControllerListener.php', '', $path); $path .= 'Resources' . DIRECTORY_SEPARATOR . 'js' . DIRECTORY_SEPARATOR . 'routing_template.js'; $content = file_get_contents($path); $route_string = json_encode($routes); $content = str_replace('__routes__', $route_string, $content); $kernel = $this-&gt;container-&gt;get('kernel'); $params = array( 'env' =&gt; $kernel-&gt;getEnvironment(), 'debug' =&gt; $kernel-&gt;isDebug(), 'name' =&gt; $kernel-&gt;getName(), 'startTime' =&gt; $kernel-&gt;getStartTime(), ); $content = str_replace('__params__', json_encode($params), $content); $path = str_replace('routing_template', 'routing', $path); file_put_contents($path, $content); } /** * Adding global Symfony javascript * * @param $response * * @return mixed */ private function addJavascript($response) {//       $content = $response-&gt;getContent(); $arr = explode('&lt;/head&gt;', $content); if (count($arr) == 1) { return $response; } $twig = $this-&gt;container-&gt;get('templating'); $c = $twig-&gt;render('SomeNamespaceSomeBundle:Javascript:js.html.twig'); $content = $arr[0] . $c . "&lt;/head&gt;" . $arr[1]; $response-&gt;setContent($content); return $response; } }</span></span></code> </pre><br>  And register it in the system: <br><pre> <code class="hljs kotlin">#SomeBundle\Resources\config\services.yml services: my.ajax.listener: <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">"SomeNamespace\SomeBundle\Event\ControllerListener" tags: [{name: kernel.event_listener</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">event: kernel.response</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">method: onKernelResponse</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">priority: -128}</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">{name: kernel.event_listener</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">event: kernel.request</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">method: onKernelRequest}</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">{name: kernel.event_listener</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">event: kernel.view</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">method: onKernelView</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">priority: -128}</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">{name: kernel.event_listener</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">event: kernel.controller</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">method: onKernelController}] arguments: [@service_container</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">@annotation_reader]</span></span></span></span></code> </pre><br>  Notice another argument: priority.  It sets the priority of the event.  To give an example, Drupal comes to my mind.  This is an analogue of the weight of the module, only the opposite.  In Drupal, the more weight, the later the hook will be called.  And in symfony, the higher the priority, the earlier the event will be called. <br><br>  So, how does the structure of each content-type look like: <br>  First, create an interface: <br><br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">SomeNamespace</span></span>\<span class="hljs-title"><span class="hljs-title">SomeBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentTypeInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Get the name of ContentType * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Encoder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encodeParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Decoder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Prepares request * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Request * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hookPre</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($request)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">/** * Changes response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@abstract</span></span></span><span class="hljs-comment"> * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> Response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hookPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($response)</span></span></span></span>; }</code> </pre><br>  And now I will tell in more detail: <br><ul><li>  encodeParameters - encodes the input data into the required content type (for example, for JSON it will be json_encode) </li><li>  decodeParameters - decodes the input data into the required content type (for example, for JSON it will be json_decode).  This can be useful if the data comes to you packed with the same content-type in one POST parameter. </li><li>  hookPre - called when a request is made to the controller, here the content type can do anything with the request object </li><li>  hookPost - called when the controller responds, here the content type can do anything with the response object </li></ul><br>  Next, we will create a class that will implement our interface, from which all content-types will be inherited: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">SomeNamespace</span></span>\<span class="hljs-title"><span class="hljs-title">SomeBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentTypeInterface</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> ServiceContainer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $container; <span class="hljs-comment"><span class="hljs-comment">/** * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> array parameters */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> $parameters; <span class="hljs-comment"><span class="hljs-comment">/** * Public constructor * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $container */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($container, $params = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;container = $container; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;parameters = $params; } <span class="hljs-comment"><span class="hljs-comment">/** * Get the name of ContentType * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">'contentType'</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Encoder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encodeParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $data; } <span class="hljs-comment"><span class="hljs-comment">/** * Decoder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $data; } <span class="hljs-comment"><span class="hljs-comment">/** * Prepares request * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hookPre</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($request)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-comment"><span class="hljs-comment">/** * Changes response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hookPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; } }</code> </pre><br>  As you can see, it implements the ContentTypeInterface interface. <br>  Now you can create your own content-types, for example, I will give my content-type json: <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">SomeNamespace</span></span>\<span class="hljs-title"><span class="hljs-title">SomeBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">ContentTypes</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">SomeNamespace</span></span>\<span class="hljs-title"><span class="hljs-title">SomeBundle</span></span>\<span class="hljs-title"><span class="hljs-title">Core</span></span>\<span class="hljs-title"><span class="hljs-title">ContentType</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSONContentType</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentType</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $params; <span class="hljs-comment"><span class="hljs-comment">/** * Get the name of ContentType * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"json"</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/** * Changes response * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hookPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($response)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $response; } <span class="hljs-comment"><span class="hljs-comment">/** * Encoder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">encodeParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json_encode($data); } <span class="hljs-comment"><span class="hljs-comment">/** * Decoder * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> $data * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@return</span></span></span><span class="hljs-comment"> mixed */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeParameters</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($data)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json_decode($data); } }</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And finally, here‚Äôs the javascript code that is used to generate routes and parameters: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//SomeBundle\Resources\js\routing_template.js (function(){if(typeof SF!='undefined'){SF.sSet('routes',__routes__);SF.parameters = __params__;}})();</span></span></code> </pre><br>  And also javascript which all this business saves and uses: <br><pre> <code class="javascript hljs">(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ SF = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ }; SF.prototype.fn = SF.prototype; SF = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SF(); SF.fn.Storage = {}; SF.fn.hasValue = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Storage[name] !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>; }; SF.fn.getValue = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">name</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.hasValue(name)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Storage[name]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; } }; SF.fn.getAllValues = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Storage }; SF.fn.loggingEnabled = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parameters.debug; }; SF.fn.messagingEnabled = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parameters.messaging !== <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.parameters.messaging; }; SF.fn.getMessages = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.framework || <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.framework.messaging === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span> ? { } : <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.framework.messaging; }; <span class="hljs-comment"><span class="hljs-comment">// framework SF.fn.getLocation = function (name) { if (this.hasLocation(name)) { return this.framework.ajax[name]; } else { return void 0; } }; SF.fn.hasLocation = function (name) { return this.framework !== null &amp;&amp; this.framework.ajax !== undefined &amp;&amp; this.framework.ajax[name] !== undefined; }; // Storage setter and getter SF.fn.sSet = function (key, val) { this.Storage[key] = val; }; SF.fn.sGet = function (key) { return this.Storage[key] ? this.Storage[key] : null; }; // log function with debug checking SF.fn.l = function (a, b) { if (!b) b = 'log'; if (this.parameters.debug) { switch (b) { case 'log': console.log('[SF]: ', a); break; case 'info': console.info('[SF]: ', a); break; case 'warning': console.warn('[SF]: ', a); break; case 'error': console.error('[SF]: ', a); break; } } }; // SF path function SF.fn.path = function (name, arguments) { if (this.Storage.routes[name]) { var path = this.Storage.routes[name]; for (var a in arguments) { path = path.replace('{' + a + '}', arguments[a]); } return path; } else { this.l('Route "' + name + '" is not found!', 'error'); return false; } }; })(window);</span></span></code> </pre><br>  Well, now, the most interesting is an example of work.  Create an action in the controller: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">//   use  ,  Symfony    /** * * @param key string * @Route("/ajax/{key}", name="JSBundle_ajax") * @Ajax("json") * @return array */ public function ajaxAction($key) { //do some work return array('a' =&gt; 'b', 'd' =&gt; 'c'); }</span></span></code> </pre><br>  The controller's response will be: <br><pre> <code class="hljs css">{ <span class="hljs-attribute"><span class="hljs-attribute">a</span></span>: <span class="hljs-string"><span class="hljs-string">"b"</span></span>, d: <span class="hljs-string"><span class="hljs-string">"c"</span></span> }</code> </pre><br>  Also, an example for javascript: <br><pre> <code class="javascript hljs">SF.l(SF.path(<span class="hljs-string"><span class="hljs-string">'JSBundle_ajax'</span></span>, {<span class="hljs-string"><span class="hljs-string">'key'</span></span>: <span class="hljs-string"><span class="hljs-string">'asd'</span></span>}));</code> </pre><br>  If debug is disabled in your symfony, then nothing will be printed to the console, otherwise it will print: <br>  / ajax / asd <br><br>  PS additions are welcome.  I will be glad to hear clever thoughts. </div><p>Source: <a href="https://habr.com/ru/post/149378/">https://habr.com/ru/post/149378/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../149372/index.html">How is food organized in your IT office?</a></li>
<li><a href="../149373/index.html">What if Google released their Bootstrap?</a></li>
<li><a href="../149374/index.html">Current questions about RFID</a></li>
<li><a href="../149375/index.html">MODx Revo: TinyMCE and Table Designer</a></li>
<li><a href="../149376/index.html">Resend form data when refreshing page</a></li>
<li><a href="../149379/index.html">Do people need a new project management system that will replace the existing ones?</a></li>
<li><a href="../149380/index.html">Who said ideas cost nothing?</a></li>
<li><a href="../149381/index.html">New features of Yandex.Disk API</a></li>
<li><a href="../149382/index.html">Simultaneously stretching rubber columns</a></li>
<li><a href="../149384/index.html">An unpleasant std :: list feature that not everyone knows</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>