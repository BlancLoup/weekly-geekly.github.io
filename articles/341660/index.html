<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Streaming and analyzing Java application logs in MS Azure using Log4j and Stream Analytics</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article I will show several working solutions for the problem of transferring and analyzing logs from Java applications to MS Azure. We will c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Streaming and analyzing Java application logs in MS Azure using Log4j and Stream Analytics</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article I will show several working solutions for the problem of transferring and analyzing logs from Java applications to MS Azure.  We will consider solutions for both windows and linux virtual machines that are both in the cloud and on-premise.  We will use <strong>log4j2</strong> as a logging subsystem for Java. </p><br><p>  For the analysis of logs we will use <strong>Azure Stream Analytics</strong> . </p><br><p><img src="https://habrastorage.org/webt/kk/jv/nw/kkjvnw7wg2cylewrbmcilkkcskq.jpeg"></p><a name="habracut"></a><br><p>  To understand what this article is all about, it is desirable to have basic knowledge of log4j2 and some Azure resources, namely stream analytics, event hub, blob storage. <br>  If you have a desire to refresh them (knowledge) - here are the links <br>  <a href="https://logging.apache.org/log4j/2.x/">Apache Log4j 2</a> <br>  <a href="https://docs.microsoft.com/en-us/azure/stream-analytics/">Azure Stream Analytics Documentation</a> <br>  <a href="https://docs.microsoft.com/en-us/azure/event-hubs/">Azure Event Hubs</a> <br>  <a href="https://docs.microsoft.com/en-us/azure/">Azure Storage</a> </p><br><h4 id="pochemu-java">  Why java? </h4><br><p>  Perhaps the idea of ‚Äã‚Äãhosting java applications in Azure VM may seem strange to someone, but according to data from the <a href="https://digest.colobridge.net/iaas">market analysis report IaaS 20011-2026 in Germany from Colorbridge Gmbh</a> , Azure IaaS use only slightly less than AWS.  Therefore, if you leave prejudices, such a question will be quite reasonable, and someone - even topical. </p><br><p>  Although Azure has been <a href="https://docs.microsoft.com/en-us/java/azure/java-sdk-azure-install">supporting Java for a</a> long time, especially at the PaaS level, providing an SDK for Java, hosting Java applications in the Web App, as well as SaaS software, which is popular in the java and opensource world.  But at the level of IaaS (in general, abstracted from the software itself), the specifics of working with Java is not very illuminated.  And it is, at least in the field of logging.  Try to fix it. </p><br><h4 id="pochemu-log4j">  Why log4j? </h4><br><p>  For java there are several subsystems for logging.  We will use log4j because </p><br><ul><li>  He is very popular </li><li>  Its configuration capabilities are enough to integrate with the Azure resources we need. </li><li>  All configuration can be done through an external configuration file. </li><li>  The configuration file with new settings can also be specified for an already assembled application ( <em>-Dlog4j.configurationFile = log4j2.xml</em> ), so all scripts in the article can be implemented without changing the application code at all. </li></ul><br><h4 id="na-chyom-ya-testiroval">  What I tested </h4><br><p>  As a test application, I took the most common <a href="https://spring.io/guides/gs/spring-boot/">springboot starter app</a> with the spring-boot-starter-log4j2 module but the latest version 2.0.0.M5, since  For one of the scripts, the latest version of log4j will be needed. </p><br><div class="spoiler">  <b class="spoiler_title">pom.xml</b> <div class="spoiler_text"><pre><code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span>4.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>com.example<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>log4j2-demo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>0.0.1-SNAPSHOT<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span>jar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>log4j2-demo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span>Demo project for Spring Boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">description</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parent</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-parent<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.0.0.M5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">relativePath</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">parent</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.build.sourceEncoding</span></span></span><span class="hljs-tag">&gt;</span></span>UTF-8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.build.sourceEncoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.reporting.outputEncoding</span></span></span><span class="hljs-tag">&gt;</span></span>UTF-8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.reporting.outputEncoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java.version</span></span></span><span class="hljs-tag">&gt;</span></span>1.8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">java.version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>sboot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>your custom repo<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://repo.spring.io/libs-milestone<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">repositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-web<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.0.0.M5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>test<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.0.0.M5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Exclude Spring Boot's Default Logging --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclusions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclusion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-logging<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclusion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">exclusions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!-- Add Log4j2 Dependency --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-starter-log4j2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.0.0.M5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pluginRepositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pluginRepository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span>sbootplug<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>https://repo.spring.io/libs-milestone<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span>false<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">enabled</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">snapshots</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pluginRepository</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pluginRepositories</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.springframework.boot<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>spring-boot-maven-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.0.0.M5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </div></div><br><p>  To test the ability to add streaming logging functionality for an already finished application, I set up experiments on a java minecraft server :) </p><br><h4 id="chto-dalshe">  What's next? </h4><br><p>  And then there will be several scenarios indicating the method of their implementation and their inherent limitations. </p><br><p>  The meaning of the scenarios is the organization of the pipeline for </p><br><ul><li>  collecting logs from java application </li><li>  transferring them to some storage in Azure (we will use either Blob Storage or EventHub) </li><li>  transferring them to Stream Analytics and primary analysis (mainly I will show how to get from Stream Analytics to the data transferred to log4j) <br>  but the step of data consumption (creating any dashboards, etc.) will not be covered in this article. </li></ul><br><h2 id="scenariy-1-universalnyy">  Scenario 1, Universal </h2><br><p><img src="https://habrastorage.org/webt/3-/c8/-8/3-c8-8nfr8equnvqhsdveugqr-u.jpeg"></p><br><p>  Features: Windows or Linux OS, VM in Azure or On-premise <br>  Limitations: need &lt;certain&gt; version of log4j2 </p><br><h4 id="algoritm-raboty">  Work algorithm: </h4><br><ul><li>  Logs using HTTP appender push directly to Azure in EventHub </li><li>  EventHub monitors the workflow of Stream Analytics and when messages appear, it starts to parse and analyze them in accordance with the specified request. </li></ul><br><h4 id="detali-realizacii">  Implementation details: </h4><br><p>  <strong>Log4j setup</strong> <br>  In the config log4j2 HTTP appender must be defined </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Http</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Http"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">url</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'https://&lt;event hubs namespace&gt;.servicebus.windows.net/&lt;event hub&gt;/messages?timeout=60&amp;amp;api-version=2014-01'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Authorization"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SharedAccessSignature sr=xxxsig=yyyse=zzzskn=&lt;event hub poicy&gt;"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Content-Type"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"application/atom+xml;type=entry;charset=utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Host"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;event hubs namespace&gt;.servicebus.windows.net"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">JsonLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">properties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Http</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <strong>A little more about Authorization header.</strong> <br>  In order to work with the REST API EventHub, authorization by so-called is required.  <a href="https://docs.microsoft.com/en-us/azure/service-bus-messaging/service-bus-sas">SaS token</a> .  This is essentially the hash of the resource and lifetime of the token. </p><br><p>  For the formation of the sas token, besides the event hub, the namespace and the event hub, you will also need to know the name and key of the policy hub with the right to send messages.  All information is on portal.azure.com. </p><br><p>  Microsoft provides <a href="https://docs.microsoft.com/en-us/rest/api/eventhub/generate-sas-token">code samples</a> for generating the Authorization header in various languages, incl.  in java. </p><br><p>  I use this <a href="https://jsfiddle.net/Dronopotamus/m1sLrouw/7/">html snippet</a> , which I found on the Internet and slightly modified - it generates an Authorization header for an EventHub with a lifetime of one year. </p><br><p>  <strong>Stream Analytics Setup</strong> <br>  In Stream Analytics Jobe configures input with EventHub with parameters <br>  Event serialization format = JSON, Encoding = UTF-8, Event compression type = None <br>  At the same time, access to the data that http appender log4j pushes is simple, directly through select * from (and this will not always be the case) <br><br><img src="https://habrastorage.org/webt/zs/6r/wo/zs6rwon-1alomby0zkeqdmxco7s.jpeg"><br></p><br>  To show the power of Stream Analytics just a little, please look at this request here. <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">errors</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> javahub <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span>=<span class="hljs-string"><span class="hljs-string">'FATAL'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">level</span></span>=<span class="hljs-string"><span class="hljs-string">'ERROR'</span></span> ), activity <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> System.TimeStamp <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> WindowEnd, <span class="hljs-keyword"><span class="hljs-keyword">level</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> javahub <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TumblingWindow( <span class="hljs-keyword"><span class="hljs-keyword">second</span></span> , <span class="hljs-number"><span class="hljs-number">10</span></span> ), <span class="hljs-keyword"><span class="hljs-keyword">level</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> pbierrors <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">errors</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> pbiactivity <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> activity;</code> </pre><br><p>  By this request we </p><br><ul><li>  Forward to pbierrors allput out all log messages with FATAL or ERROR level </li><li>  Every 10 seconds we send to pbiactivity output the number of messages received during these 10 seconds, grouped by log level </li></ul><br><p>  A couple of mouse clicks in power bi and we can monitor not only application errors, but also monitor the overall activity. </p><br><h2 id="scenariy-2-tolko-windows-byudzhetnyy">  Scenario 2, Windows only, budget </h2><br><p><img src="https://habrastorage.org/webt/ik/ry/gs/ikrygsiqcufy3qmlea_bog3bniw.jpeg"></p><br><p>  Features: No EventHub needed.  Smaller amount of traffic (logs are archived before transmission), do not bother with SaS tokens. <br>  Restrictions: VM only in Azure.  Logs arrive with a slight delay. </p><br><h4 id="algoritm-raboty-1">  Work algorithm </h4><br><ul><li>  Logs using RollingRandomAccessFile appender'a written to a file </li><li>  Upon reaching certain conditions (log4j triggers), the logs are archived in a separate folder </li><li>  The folder is monitored by the Azure Monitoring &amp; Diagnostics Extension for VM and, when a new file with the archive appears, shifts it to Blob storage in Azure </li><li>  Blob storage monitors Jobs Stream Analytics and when a new file with the archive appears it begins to parse and analyze it in accordance with the specified request </li></ul><br><h4 id="detali-realizacii-1">  Implementation details </h4><br><p>  <strong>Log4j setup</strong> <br>  Be sure to pay attention that </p><br><ul><li>  Archiving should be done NOT in the folder where the current logs are written </li><li>  Each file must have a header - a list of field names </li><li>  If there is a desire in the folder where the logs are archived, to unify the directory hierarchy - only the date (yyyy-MM-dd) (separators can be arbitrary) and \ or hour (HH) can be used as directory names (from dynamics) <br>  An example of determining the "correct" appender log4j <br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RollingRandomAccessFile</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'File'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fileName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"latest.log"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">filePattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"logs\%d{yyyy-MM-dd}\%d{HH}\%d{HH-mm-ss}-%i.log.gz"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatternLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pattern</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'%d{yyyy-MM-dd HH:mm:ss};%level;%msg%n'</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span>TS;LEVEL;MESSAGE%n<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">header</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">PatternLayout</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">CronTriggeringPolicy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">schedule</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'10 * * * * ?'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">evaluateOnStartup</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'true'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">SizeBasedTriggeringPolicy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">size</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'10 MB'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Policies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">DefaultRolloverStrategy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'100'</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RollingRandomAccessFile</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> </li></ul><br><p>  <strong>Configure the Azure Monitoring &amp; Diagnostics Extension for VM</strong> </p><br><ul><li>  create two config files (examples below) </li><li>  using <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli%3Fview%3Dazure-cli-latest">Azure CLI 2</a> run </li></ul><br><pre> <code class="bash hljs">az vm extension <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> --name IaaSDiagnostics \ --publisher <span class="hljs-string"><span class="hljs-string">"Microsoft.Azure.Diagnostics"</span></span> \ --resource-group &lt;group name&gt; \ --vm-name &lt;vm name&gt; \ --protected-settings <span class="hljs-string"><span class="hljs-string">"privateSettings.json"</span></span> \ --settings <span class="hljs-string"><span class="hljs-string">"publicSettings.json"</span></span> \ --version <span class="hljs-string"><span class="hljs-string">"1.11.1.0"</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">publicSettings.json</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"WadCfg"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"DiagnosticMonitorConfiguration"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"overallQuotaInMB"</span></span>: <span class="hljs-number"><span class="hljs-number">10000</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DiagnosticInfrastructureLogs"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"scheduledTransferLogLevelFilter"</span></span>: <span class="hljs-string"><span class="hljs-string">"Error"</span></span> }, <span class="hljs-attr"><span class="hljs-attr">"Directories"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"scheduledTransferPeriod"</span></span>: <span class="hljs-string"><span class="hljs-string">"PT1M"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"DataSources"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"containerName"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;blob container name in your storage account&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"Absolute"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"path"</span></span>: <span class="hljs-string"><span class="hljs-string">"C:\\&lt;folder&gt;\\&lt;to monitor&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"expandEnvironment"</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> } } ] } } }, <span class="hljs-attr"><span class="hljs-attr">"StorageAccount"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;your storage account name&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"StorageType"</span></span>: <span class="hljs-string"><span class="hljs-string">"Table"</span></span> }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">privateSettings.json</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"storageAccountName"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;your storage account name&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"storageAccountKey"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;storage account access key (use portal to obtain it)&gt;"</span></span> }</code> </pre> </div></div><br><p>  <strong>Stream Analytics Setup</strong> <br>  The input used is Blob storage with parameters: <br>  PathPattern - path to files with archived logs in Blob storage.  If you did a directory hierarchy (as in the example above), then it should also be taken into account. </p><br><p>  Example: WAD / be7f1c92-2841-4ea1-b9d8-ec83c211b8ea / IaaS / _minesrv / {date} / {time} / <br>  DateFormat must be set according to format format% d in log4j <br>  Event serialization format = CSV, Delimeter = semicolon, Encoding = UTF-8, Event compression type = GZIP </p><br><p>  Data access in Steam Analytics queries is also immediate. <br>  select * from returns a table with TS, LEVEL, MESSAGE fields (according to the header defined in log4j) <br></p><div class="spoiler">  <b class="spoiler_title">And one more query is more difficult.</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> SessionInfo <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TS, <span class="hljs-string"><span class="hljs-string">'START'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EVENT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(MESSAGE, <span class="hljs-number"><span class="hljs-number">0</span></span>, REGEXMATCH(MESSAGE, <span class="hljs-string"><span class="hljs-string">'[ ]*joined the game'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PLAYER <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> logslob <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> REGEXMATCH(MESSAGE, <span class="hljs-string"><span class="hljs-string">'joined the game'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TS, <span class="hljs-string"><span class="hljs-string">'END'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EVENT</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">SUBSTRING</span></span>(MESSAGE, <span class="hljs-number"><span class="hljs-number">0</span></span>, REGEXMATCH(MESSAGE, <span class="hljs-string"><span class="hljs-string">'[ ]*left the game'</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> PLAYER <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> logslob <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TS <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> REGEXMATCH(MESSAGE, <span class="hljs-string"><span class="hljs-string">'left the game'</span></span>) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> ), RawLogs <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> TS, <span class="hljs-keyword"><span class="hljs-keyword">LEVEL</span></span>, MESSAGE <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> logslob <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> TS ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> sbq <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> SessionInfo; <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> pbi <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> RawLogs;</code> </pre> </div></div><br><p>  Here we send all logs to RawLogs output, but in SessionInfo there are separate records about starting and stopping the session with the player's name - for subsequent notifications </p><br><h2 id="scenariy-3-tolko-linux">  Scenario 3, Linux only </h2><br><p><img src="https://habrastorage.org/webt/_5/3w/cr/_53wcre-iflnt3utpclomsksshq.jpeg"></p><br><p>  Features: The minimum configuration of Log4j (and the minimum requirements for the version of log4j) - just write to the file.  All new records in the file are processed (without delay) <br>  Restrictions: VM only in Azure, writing to a file only in json, more complex data access from stream analytics job </p><br><h4 id="algoritm-raboty-2">  Work algorithm: </h4><br><ul><li>  Logs using File appender'a written to a file </li><li>  The file monitors the Azure Linux Diagnostics Extension for VM and when new entries appear in the file, it pushes them into the EventHub </li><li>  EventHub monitors the workflow of Stream Analytics and when messages appear, it starts to parse and analyze them in accordance with the specified request. </li></ul><br><h4 id="detali-realizacii-2">  Implementation details </h4><br><p>  <strong>Log4j setup</strong> <br>  Logs should be written in json format and always - each object on one line of the file with logs <br>  Fortunately, with log4j, this can be configured simply </p><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">File</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"FileLog"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fileName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"app.log"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">JsonLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">properties</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">compact</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">eventEol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">File</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  <strong>Configure the Azure Linux Diagnostics Extension for VM</strong> </p><br><ul><li>  create two config files (examples below) </li><li>  using <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli%3Fview%3Dazure-cli-latest">Azure CLI 2</a> run </li></ul><br><pre> <code class="hljs cs">az vm extension <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> --name LinuxDiagnostic \ --publisher <span class="hljs-string"><span class="hljs-string">"Microsoft.Azure.Diagnostics"</span></span> \ --resource-<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> name&gt;\ --vm-name &lt;vm name&gt;\ --<span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>-settings <span class="hljs-string"><span class="hljs-string">"linux_privateSettings.json"</span></span> \ --settings <span class="hljs-string"><span class="hljs-string">"linux_publicSettings.json"</span></span> \ --version <span class="hljs-string"><span class="hljs-string">"3.0.109"</span></span></code> </pre> <br><ul><li>  in the configs we register the storage account, although it is not used to transfer logs.  It is needed only for diagnostic entries of the Linux Diagnostics Extension itself. </li><li>  we set up the sas token for the sotage account in the configurations (and not just the key, as in the case of the Diagnostics Extension for Windows), so you can generate it through the portal </li><li>  in the configs, we prescribe the sas token for the event hub - it hardly differs in format from what we generated for the first script (and is generated by the same code or <a href="https://jsfiddle.net/Dronopotamus/m1sLrouw/7/">snippet</a> ) </li></ul><br><div class="spoiler">  <b class="spoiler_title">linux_publicSettings.json</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">linux_publicSettings.json: { "StorageAccount": "&lt;your storage account&gt;", "sampleRateInSeconds": <span class="hljs-number"><span class="hljs-number">15</span></span>, "ladCfg": { "diagnosticMonitorConfiguration": { "metrics": { "metricAggregation": [ { "scheduledTransferPeriod": "PT1H" }, { "scheduledTransferPeriod": "PT1M" } ], "resourceId": "/subscriptions/&lt;subscription id&gt;/resourceGroups/&lt;resource group&gt;/providers/Microsoft.Compute/virtualMachines/&lt;vm name&gt;" } } }, "fileLogs": [ { "file": "/&lt;path&gt;/&lt;to&gt;/&lt;log file&gt;", "sinks": "LinuxEH" } ] }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">linux_privateSettings.json</b> <div class="spoiler_text"><pre> <code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"storageAccountName"</span></span> : <span class="hljs-string"><span class="hljs-string">"&lt;your storage account&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"storageAccountSasToken"</span></span>: <span class="hljs-string"><span class="hljs-string">"&lt;sas token for storage account - generate it on the portal&gt;"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sinksConfig"</span></span>: { <span class="hljs-attr"><span class="hljs-attr">"sink"</span></span>: [ { <span class="hljs-attr"><span class="hljs-attr">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"LinuxEH"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"EventHub"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"sasURL"</span></span>: <span class="hljs-string"><span class="hljs-string">"https://&lt;event hub namespace&gt;.servicebus.windows.net/&lt;event hub&gt;?sr=xxxxxx&amp;sig=yyyy&amp;se=zzzz&amp;skn=&lt;policy name&gt;"</span></span> } ] } }</code> </pre> </div></div><br><p>  <strong>Stream Analytics Setup</strong> <br>  In Stream Analytics Jobe configures input with EventHub with parameters <br>  Event serialization format = JSON, Encoding = UTF-8, Event compression type = None <br>  At the same time, access to logged data is not so easy.  If we just execute select * from, we will see something like this <br></p><p><img src="https://habrastorage.org/webt/sx/2q/or/sx2qor36fhtdwkeeelzq9zgm4xg.jpeg"></p><br><p>  those.  we need data hidden somewhere in the json object stored in the PROPERTIES field <br>  But this problem in stream analytics can be solved beautifully (yes, I really like this thing :)), for example with this query </p><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> UDF.to_json(properties.MSG) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> ehtest ) <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> obj.* <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">events</span></span></code> </pre> <br><p>  where UDF.to_json is the function we wrote about converting a string to a JSON object (yes, you can also write functions there, in javascript ...) </p><br><p><img src="https://habrastorage.org/webt/hf/r3/ym/hfr3ymvf8m1lzgohhgubsj-j2is.jpeg"></p><br><p>  As a result, we get easy access to log data. </p><br><p><img src="https://habrastorage.org/webt/gk/tz/vg/gktzvgffqauftpe7383quechs2y.jpeg"></p><br><h2 id="v-zaklyuchenie">  Finally </h2><br><p>  I hope this article will be useful to someone. <br>  She <em>has already</em> brought me great benefit, because  only through the implementation of practical cases can one really understand the possibilities and maturity of a particular technology. <br>  If suddenly I missed any scripts - please write about it in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/341660/">https://habr.com/ru/post/341660/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341648/index.html">Statistics identify software vulnerabilities in the framework of certification tests</a></li>
<li><a href="../341650/index.html">Orange Pi Zero WiFi Speaker / Player or Lost Time Story</a></li>
<li><a href="../341652/index.html">From user to CAD developers</a></li>
<li><a href="../341654/index.html">The cat died, the tail peeled off</a></li>
<li><a href="../341656/index.html">We invite to the conference FPConf 2017</a></li>
<li><a href="../341662/index.html">Report - overview of the capabilities and architecture of CppComet comets</a></li>
<li><a href="../341664/index.html">Crash browser warnings with pseudo-password fields</a></li>
<li><a href="../341666/index.html">Joker 2017 conference: amazing stories</a></li>
<li><a href="../341668/index.html">R, Asterisk and wardrobe</a></li>
<li><a href="../341670/index.html">Let's try to evaluate Kubernetes</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>