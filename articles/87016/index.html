<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creation of compact applications on VC ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Note: The author of the article is Alexey Fahrenheit Zakharenko. Good person and specialist. 

 With the exponential growth of memory and disk space, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creation of compact applications on VC ++</h1><div class="post__text post__text-html js-mediator-article">  <i>Note:</i> The author of the article is Alexey <a href="http://habrahabr.ru/users/fahrenheit/" class="user_link">Fahrenheit</a> Zakharenko.  Good person and specialist. <br><br>  With the exponential growth of memory and disk space, the creation of really small programs is rarely needed, but sometimes there are tasks when it is just a shame to lose a few hundred extra kilobytes on every small utility. <br>  This article tells you how to get really compact programs using actual development tools - Microsoft Visual Studio 2008. <br>  As an example, we port the 7-zip console archiver and evaluate the effect of this. <br><a name="habracut"></a><br><h1>  Problems and obvious solutions </h1><br>  The obvious decision about dynamic linking of the runtime library (CRT) is not appropriate, since the latest versions are not installed by default on Windows XP, which every self-respecting application should support now.  And the delivery of a CRT in the form of a DLL, of course, is not a panacea, since they have a significant (by the standards of this article) volume. <br>  Another solution is to use the standard library msvcrt.dll, different versions of which can be found in all current versions of Windows.  However, import libraries that allow you to connect this DLL are available only in Microsoft Visual Studio 6.0 - in subsequent editions, their own libraries are used for each new version (msvcr70.dll / msvcp70.dll, msvcr71.dll / msvcp71.dll, etc.). <br>  A simple attempt to take the import library for msvcrt.dll and connect it to a project that builds under VS2008 will only lead to success in the simplest case of Hello World type - since the release of Windows XP, significant changes have occurred in the runtime library - this is the emergence of the secure category crt ‚Äù, and changes in exception handling, and additional checks on runtime. <br><br><h1>  Solution to the problem </h1><br>  The solution to this problem is suggested by Koby Kahane in his article <a title="Dynamically linking with MSVCRT.DLL using Visual C ++ 2005" href="http://kobyk.wordpress.com/2007/07/20/dynamically-linking-with-msvcrtdll-using-visual-c-2005">Dynamically linking with MSVCRT.DLL using Visual C ++ 2005</a> . <br>  He conducted a study of the latest versions of the Windows Driver Kit (WDK) and found an interesting feature - many applications and examples that come with the WDK use exactly the CRT we need - msvcrt.dll.  In this case, the build environment in the WDK is up-to-date ‚Äî the compiler version of the last WDK is the same as the compiler version in VS2008SP1. <br>  A detailed study of project files shows that the solution lies in several object files that are connected to the project - msvcrt_win2000.obj, msvcrt_winxp.obj, msvcrt_win2003.obj.  They essentially contain the ‚Äúdifference‚Äù between the current CRT content and the one that is present in the corresponding Windows version name.  This explains the fact that the size of the object files for newer Windows is smaller than for older ones. <br>  So, to connect the classic msvcrt.dll, you must perform two simple steps: <br><ul><li>  Disable the connection of all standard libraries using the compiler key / NODEFAULTLIB or the project settings Linker -&gt; Input -&gt; Ignore All Default Libraries </li><li>  You must connect the import library msvcrt.lib, which can be found in the folder \ lib \ Crt \ i386 \ msvcrt.lib WDK and connect the object file corresponding to the minimum version of Windows on which the application should run.  Let this be for example \ lib \ Crt \ i386 \ msvcrt_winxp.obj. </li></ul><br>  Everything, the project can be collected and in the simplest case it will even compile and work correctly. <br>  For those who do not have a WDK, and do not want to download 600 MB for several megabytes of libraries, at the end of the article I gave a link to the archive, which contains the necessary files separately. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  Practice - pitfalls and nuances </h1><br>  So, now let's try to convert the project to use msvcrt.dll in it and see what happens. <br>  For example, take 7-zip - a fairly good open source archiver.  Its source code is available at 7-zip.org.  A little research shows that the project is currently being built using Microsoft Visual C ++ 6.0, which makes it fairly easy to port. <br>  Let's do this magical sequence of actions: <br><ul><li>  First, make sure that the project is properly built using Microsoft Visual C ++ 2008. To do this, run the makefile from the \ CPP \ 7zip \ folder (using nmake).  Hereinafter, all the folders are relative to the folder into which the project sources have been unzipped. </li><li>  Already at the initial assembly stage, we will receive a warning (which, in accordance with the project settings, is considered an error) C4996: 'wcscpy': This function or variable may be unsafe.  Consider using wcscpy_s instead. </li><li>  Well, let's make this minor fix.  In the file \ CPP \ Windows \ Security.cpp in line 125 we replace <br>  wcscpy (s, MY__SE_LOCK_MEMORY_NAME); <br>  on <br>  wcscpy_s (s, 128, MY__SE_LOCK_MEMORY_NAME); <br>  128 characters is the maximum size of the immediately declared buffer. </li><li>  Now the build process was successful.  At the output, the executable files for all components of the 7z archiver (console version, file manager, etc.) were obtained.  To test the build, copy the \ CPP \ 7zip \ UI \ Console \ O \ 7z.exe and \ CPP \ 7zip \ Bundles \ Format7zF \ O \ 7z.dll files into one folder and verify that the console archiver works.  Also, for successful launch you will need to put a manifest file next to it.  For this project, it is given in the accompanying files to the article. </li></ul><br>  Now the most interesting is how to make the application use classic run-time.  To do this, we make several magical passes, which are understandable to everyone who read the previous section: <br><ul><li>  In the file \ CPP \ Build.mak in the linker flags we replace the already irrelevant option -OPT: NOWIN98 with / NODEFAULTLIB (line 45) </li><li>  Now you need to add minimal effort to each project linking libraries Kernel32.lib uuid.lib.  I don‚Äôt want to edit the makefile of each project separately, therefore in the same \ CPP \ Build.mak we add the necessary libraries and modules for each project to the linker settings line.  Thus, we get the following settings: </li><li>  LFLAGS = $ (LFLAGS) .. \ .. \ msvcrt \ msvcrt_winxp.obj .. \ .. \ msvcrt \ msvcrt.lib Kernel32.lib uuid.lib -nologo -NODEFAULTLIB -OPT: REF -OPT: ICF </li><li>  Collect the result and check.  Under Win7 and virtual XP, everything works without problems, the archives created by our build successfully open the original 7zip. </li></ul><br>  Now let's check how such porting affected performance.  For comparison, take the original assembly, as well as our two assemblies - one will use MSVCR90.dll, the other - MSVCRT.dll. <br>  The table below shows the comparison of the obtained file sizes.  Porting to a new compiler automatically saved us about 10% of the size of the executable file. <br><table><tbody><tr><td></td><td>  MS VC 6.0 </td><td>  MS VC 9.0 </td><td>  MS VC 9.0 (msvcrt.dll) </td></tr><tr><td>  7z.exe </td><td>  150 016 bytes </td><td>  136,704 bytes </td><td>  138,240 bytes </td></tr><tr><td>  7z.dll </td><td>  726 016 bytes </td><td>  655 872 bytes </td><td>  657,920 bytes </td></tr></tbody></table><br>  To measure the speed, we will pack all the binary files obtained as a result of the project build (about 187 MB).  Each of the assemblies will conduct 10 packing cycles to reduce the impact of disk access and caching speed, and the data obtained will be averaged. <br><table><tbody><tr><td></td><td>  MS VC 6.0 </td><td>  MS VC 9.0 </td><td>  MS VC 9.0 (msvcrt.dll) </td></tr><tr><td>  Packing time </td><td>  122.86 seconds </td><td>  112.02 seconds </td><td>  113.73 seconds </td></tr></tbody></table><br>  As you can see, the transition to the updated compiler gave a real performance increase (close to 10%, which is not so bad for an application of this kind).  Also, the generated binary file has decreased by the same ~ 10%. <br>  There was no significant difference between using the classic VC90 runtime and msvcrt.dll. <br><br><h1>  Method limitations </h1><br>  However, a couple of potential disadvantages and limitations of this method should be noted. <br><br><h2>  There is no possibility to connect the msvcrtd.dll debugging runtime </h2><br>  Despite the fact that the import library for it is present in the WDK, it was not possible to find the .dll itself, and, according to Koby Kahane, Microsoft is not going to include it in future versions of the WDK. <br>  This greatly complicates debugging of applications and provokes the use of the method described in the article only before release, which, in turn, can lead to the appearance of hard-to-catch bugs in the final direct product release - because no one guarantees full runtime compatibility. <br><br><h2>  MFC, ATL </h2><br>  Dragging MFC or ATL to use the new-old runtime dynamically is quite a difficult task and goes beyond the scope of this article.  However, for applications that use these libraries, there are usually no strict requirements on the disk space. <br><br><h1>  Files </h1><br>  The archive attached to the article (1.8Mb) contains: <br><ol><li>  The 7z diff folder contains all changes to the 7zip project.  Unzip the 7z465.tar.bz2 downloaded from the site and roll the given patch over the project root folder. </li><li>  The msvcrt folder contains binary files from the WDK for porting a project for using msvcrt.dll </li><li>  The output folder contains all three builds of the console version of 7-zip for those who do not trust my test results and want to double-check them. </li></ol><br>  Download the file at: <a href="">http://download.zillya.com/attach/MsVCArticlesAttach.zip</a> <br><br>  <b>Upd</b> .  <a href="http://habrahabr.ru/users/cryptochild/" class="user_link">Cryptochild</a> helped with the invite, thanks! </div><p>Source: <a href="https://habr.com/ru/post/87016/">https://habr.com/ru/post/87016/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../87008/index.html">Are you a credit card or not a credit card? ..</a></li>
<li><a href="../87009/index.html">Writing Reversi game in Python + PyQt4</a></li>
<li><a href="../87010/index.html">From the creators of "Chip and Daily" on the screens of service services at a discount "DarBeri"</a></li>
<li><a href="../87013/index.html">Cycling routes appeared on Google Maps</a></li>
<li><a href="../87015/index.html">Reoptimization</a></li>
<li><a href="../87018/index.html">Improving the quality of search or the subjectivity of Yandex?</a></li>
<li><a href="../87021/index.html">Low cost writing board with marker (Glass WhiteBoard)</a></li>
<li><a href="../87023/index.html">Copyright Funeral</a></li>
<li><a href="../87024/index.html">What Sql Injection May Cause</a></li>
<li><a href="../87025/index.html">Zeus trojan first acquaintance</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>