<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Arduino -> FLProg -> RS-485 -> Modbus</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="FLProg version 1.9.1 has been released. I thought that the innovations in the program deserve coverage on Habr√©. I will also tell you a little theory ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Arduino -> FLProg -> RS-485 -> Modbus</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/776/b82/11c/776b8211c8bc4a6d9f959dc1dc7d8c9c.png"><br>  FLProg version 1.9.1 has been released.  I thought that the innovations in the program deserve coverage on Habr√©. I will also tell you a little theory about the Modbus protocol and the features of its implementation onboard the Arduino. <br><a name="habracut"></a><br>  <b>Modbus</b> is a client-server protocol. <br>  Widely used in industry. <br>  <b>Modbus</b> can be used to transmit data via serial communications RS-485, RS-422, RS-232, as well as TCP / IP networks. <br>  <b><i>While in the program FLProg data transfer is realized only via RS-485.</i></b> <br>  The RS-485 interface is based on the principle of differential (balanced) data transfer.  Its essence lies in the transmission of a single signal over two wires.  And one wire (conditionally A) is the original signal, and the other (conditionally B) - its inverse copy.  In other words, if on one wire "1", then on the other "0" and vice versa.  Thus, between two wires of a twisted pair there is always a potential difference: with ‚Äú1‚Äù it is positive, with ‚Äú0‚Äù it is negative. <br><img src="https://habrastorage.org/files/8dc/dd0/d65/8dcdd0d6528a4df7a824a64c7a3d51cf.png"><br>  It is this potential difference and the signal is transmitted.  This transmission method provides high immunity to common mode interference.  Common mode is called interference, acting on both wires of the line in the same way.  For example, an electromagnetic wave, passing through a section of the communication line, induces a potential in both wires.  If a signal is transmitted by a potential in one wire with respect to a common one, as in RS-232, then the tip on this wire may distort the signal of a relatively good absorbing tip of the common ("ground").  In addition, on the resistance of the long common wire will fall the potential difference of the earth - an additional source of distortion.  And with differential transmission, no distortion occurs.  In fact, if two wires run close to each other, and even intertwined, then the guidance on both wires is the same.  The potential in both equally loaded wires varies equally, while the informative potential difference remains unchanged. <br>  This is what a typical package looks like, from the Master to the Slave. <br><img src="https://habrastorage.org/files/473/9f6/6ce/4739f66ce94148819bb63d3f780a4379.png"><br>  This is what the Slave‚Äôs answer to the Lead <br><img src="https://habrastorage.org/files/a74/2dc/4eb/a742dc4eb4634f5a8f6b3d5fd92936c9.jpg"><br>  <b>ID</b> - Slave address.  It can have values ‚Äã‚Äãfrom 1 to 247. Address 0 is used for broadcast transmission, each device recognizes it, addresses in the range 248 ... 255 are reserved. <br>  <b><i>FLProg for the master (Master) supports 32 slave (Slave) devices due to the used UART -&gt; RS-485 converters.</i></b> <b><i><br></i></b> <br>  <b>Command (function code):</b> <br>  In this example, one, for reading 0x03. <br>  But in reality there are many more. <br>  All function codes are divided into: <br>  <b>- Public codes</b> described in the MODBUS-IDA standard.  Their list includes codes already assigned and used, as well as codes for future use; <br><div class="spoiler">  <b class="spoiler_title">List</b> <div class="spoiler_text">  0x02) - reading values ‚Äã‚Äãfrom several discrete inputs (Read Discrete Inputs). <br>  (0x03) - read values ‚Äã‚Äãfrom several storage registers (Read Holding Registers). <br>  (0x04) - reading values ‚Äã‚Äãfrom several input registers (Read Input Registers). <br>  (0x05) - write the value of one flag (Force Single Coil). <br>  (0x06) - write the value to one storage register (Preset Single Register). <br>  (0x07) - Read Status Signals (Read Exception Status) <br>  (0x0F) - write values ‚Äã‚Äãto several flag registers (Force Multiple Coils) <br>  (0x10) - write values ‚Äã‚Äãto several storage registers (Preset Multiple Registers) <br>  (0x16) - write to one storage register using the ‚ÄúAND‚Äù mask and the ‚ÄúOR‚Äù mask. <br>  (0x18) - Read data from the queue (Read FIFO Queue) <br>  (0x14) - Read from file (Read File Record) <br>  (0x15) - Write File (Write File Record) <br>  (0x08) - Diagnostics (Diagnostic) <br>  (0x0B) - Read Event Counter (Get Com Event Counter) <br>  (0x0C) - Read Event Log (Get Com Event Log) <br>  (0x11) - Reading Device Information (Report Slave ID) <br>  (0x2B) - Encapsulated Interface Transport <br></div></div><br>  <b>- User-Defined Function Codes</b> (65-72, 100-110) - codes that can be used by companies for their own functions, and are not described in the specification; <br>  <b>- Reserved Function Codes</b> (9, 10, 13, 14, 41, 42, 43, 90, 91, 125, 126 and 127) - codes that are not available for general use are reserved. <br>  <b>Error processing</b> <br>  The master sends a request to the Slave, in which in the field ‚Äúfunction code‚Äù indicates to him the necessary action. <br>  The data bytes contain the information necessary to perform this function. <br>  Slave, in case of successful execution of this function, repeats the function code in the response. <br>  If an error occurs, the function code in the response is modified - the most significant bit is set to 1. <br>  In bytes of data, the cause of the error is transmitted.  For example, when the Slave performed the function 0x0F, an error occurred, then it will answer the Leading field of the function to 0x8F. <br>  In addition to changing the function code, the Slave places a unique code in the data field that indicates the type and cause of the error. <br>  <b>The</b> Modbus specification defines two data types, one bit and 16 bit word.  The data is organized into four tables with 16-bit addressing cells, addressing in the tables starts from 0. Separate commands are used to access data from different tables. <br><table><tbody><tr><td>  Discrete inputs </td><td>  1 bit </td><td>  only reading </td></tr><tr><td>  Coils </td><td>  1 bit </td><td>  read and write </td></tr><tr><td>  Input Registers </td><td>  16 bits </td><td>  only reading </td></tr><tr><td>  Holding registers </td><td>  16 bits </td><td>  read and write </td></tr></tbody></table><br>  <b><i>The standard provides a separate table for each data type, but the implementation feature of the FLProg program is that all slave registers are stored in one array as overlapping tables, respectively, all commands from the master will refer to the same memory area.</i></b>  <b><i>The lead implementation only provides for working with the ‚ÄúHolding Registers‚Äù table.</i></b> <br><br>  Well, probably this is the end of the theory, and look at the specifics and iron. <br>  To create networks based on RS-485 it is advantageous to use such converters. <br><img src="https://habrastorage.org/files/f95/d34/c78/f95d34c78bf248bebfb13d5beb7a355c.jpg"><br>  They are inexpensive but fairly reliable.  Collected on the MAX485 chip. <br><img src="https://habrastorage.org/files/24f/b5f/f3b/24fb5ff3b4fa4b32a485a179956cedd8.jpg"><br>  Connection with Arduino are held according to the scheme <br><img src="https://habrastorage.org/files/1ba/c53/8a1/1bac538a192e43969d085850bfd45af1.jpg"><br>  To emulate the master and slave during the development of the protocol implementation, I used two very good free programs. <br><br>  <a href="http://qmodbus.sourceforge.net/">QModBus - Lead Simulator</a> <br><img src="https://habrastorage.org/files/68e/f70/1a9/68ef701a996b438f957f1697f2b6a2c7.PNG">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <a href="http://www.hmisys.com/">PeakHmiMBSerialSlave - Slave Simulator</a> <br><img src="https://habrastorage.org/files/3b3/385/fc3/3b3385fc3c014c65bf0328aee1b71d35.PNG"><br><br>  And finally, a video tutorial on creating a master and slave in the FLProg program. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/-OaeT96SOzk%3Ffeature%3Doembed&amp;xid=17259,15700002,15700022,15700186,15700191,15700248,15700253&amp;usg=ALkJrhgGOJ1d1fy6_yIAtO8PJs-pDPDgeA" frameborder="0" allowfullscreen=""></iframe><br><br>  Ps.  I thank the authors of the articles presented below, which helped me understand the Modbus protocol and implement this functionality. <br>  Sources: <br>  <a href="http://we.easyelectronics.ru/khomin/modbus-rtu-dlya-chaynikov.html">Modbus RTU for Dummies</a> <br>  <a href="http://habrahabr.ru/post/249043/">Arduino &amp; Modbus</a> </div><p>Source: <a href="https://habr.com/ru/post/262521/">https://habr.com/ru/post/262521/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262509/index.html">Let Docker roam around the cluster on the Raspberry Pi</a></li>
<li><a href="../262511/index.html">Hazardous 0day vulnerabilities discovered in Adobe Flash Player and Oracle Java</a></li>
<li><a href="../262515/index.html">Beginners Ethical Hacking Courses: A New Set</a></li>
<li><a href="../262517/index.html">What is under the hood of virtual disks? (on the example of VHD and VHDX)</a></li>
<li><a href="../262519/index.html">Another camera for FreeTrack</a></li>
<li><a href="../262523/index.html">Visual Studio Code - code editor for Linux, OS X and Windows</a></li>
<li><a href="../262525/index.html">How we ensured communication at the summits of the SCO and BRICS</a></li>
<li><a href="../262527/index.html">How to make Jenkins make your life easier and become happy</a></li>
<li><a href="../262529/index.html">Experience of development and design on AngularJS</a></li>
<li><a href="../262531/index.html">My system for testing and improving the quality of a GSM gateway, part one: functional and circuit level</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>