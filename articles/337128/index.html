<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bigdata stack eyes militant oracoloyd</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On Habr√© and other Internet sites, almost every day they post empty articles on bigdat, creating a persistent feeling among specialists that there is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bigdata stack eyes militant oracoloyd</h1><div class="post__text post__text-html js-mediator-article">  On Habr√© and other Internet sites, almost every day they post empty articles on bigdat, creating a persistent feeling among specialists that there is nothing besides marketing bigdatas.  In fact, there are enough interesting technologies under the hood of Hadoop, and here I want to slightly dilute the marketing, technical expertise with the experience of Oracle. <br><br>  First of all, it should be understood that one of the pillars of Hadoop's bigdats is not only batch processing and map-reduce, as many try to portray.  It can easily be processed from the opposite range of tasks: reading a stream of small messages, for example from IoT (spark to Hadoop, reading Kafka stream), while aggregating and detecting deviations on the go. <a name="habracut"></a>  These can be clouds of small requests for reporting systems from JOINs to parquet files via Impala.  All this is the same Hadoop ecosystem.  There are a lot of things, different degrees of maturity and requiring a different approach.  And believe me, no one really knows the most winning option.  Somewhere tasks go great on classic map-reduce and sufficient primitive parquet to hdfs, somewhere Spark with ordinary SQL JOINs almost on text files.  The largest distribution of Cloudera is now actively promoting something resembling the Kudu database, which can be used both in java style map-reduce, and under SQL in Impala. <br><br>  There is a lot of everything and almost all of this is combined with each other, and depending on the combination, the treatment approaches can be very, very different.  In principle, this vaguely resembles Oracle throwing in the late 90s, the beginnings of zero, when they started to shove all sorts of xml tables in the subd, java stored procedures and other strange things. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At first, having gotten into the project with Hadoop / map-reduce, it was completely unclear, due to which, with this approach, you can compete with full-fledged DBMS, because the entire map-reduce communication passes through scribbling hdfs.  First, the mapper reads everything, then he writes his output for the reduers to hdfs, then the redizers read and write again.  With oraklovymi representations of the beautiful it seemed it just will not fly.  But later there was an understanding of what. <br><br>  Approximately how Oracle does seemingly a lot of extra work, trying to increase parallel execution at the expense of ‚Äúextra‚Äù writing on the disks.  Oracle, for example, writes in the "extra" UNDO, which allows it to dissolve competing readers.  Writes locks in data blocks, which allows not to keep huge lists of locks in memory, transparently exchange information about locks between RAC cluster nodes.  Approximately in the same way, it‚Äôs worth looking at the extra scribbling of map-reduce.  All this "superfluous" as a result allows to perform much more tasks in parallel, against the background of Oracle. <br><br>  At the same time, I was immediately surprised by the size of the parquet files, the plates in Oracle without indexes of 80-100 GB, easily turn into 20-30 GB parquet.  As a result, map-reduce reads from disks at times less, loading at once a cloud of cluster cores, while Oracle should read more and place all calculations on a single user process.  This is a stone in the PL / SQL machine garden, although the SQL engine also has a lot of nuances on the topic of parallel reading. <br><br>  To understand what the implementation of logic in Hadoop looks like, I can illustrate one of the ‚ÄúFriday tasks‚Äù from the sql.ru oracle branch.  In principle, it all started with a battle on <a href="http://www.sql.ru/forum/actualutils.aspx%3Faction%3Dgotomsg%26tid%3D1219227%26msg%3D20604267">map-reduce vs Spark</a> . <br><br>  <a href="http://www.sql.ru/forum/1262544/pyatnichnaya-zadachka-smotrim-nazad%3Fmid%3D20551874">The problem is</a> this: <br><br><blockquote>  Write a request that for each adjusted value finds <br>  1) previous original (ordered by id) <br>  2) original with a shift that is set by a variable (the previous one is considered with a shift of 0) <br>  3) the number of previous original so that their amount does not exceed the specified limit <br><br>  var shift number <br>  var limit number <br>  exec: shift: = 2; <br><br>  PL / SQL procedure successfully completed. <br><br>  exec: limit: = 2000; <br><br>  PL / SQL procedure successfully completed. </blockquote><br>  In Oracle, the solution was proposed as follows: <br><br><pre><code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.id, <span class="hljs-number"><span class="hljs-number">2</span></span> t.type, <span class="hljs-number"><span class="hljs-number">3</span></span> t.value, <span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'adjusted'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> grp)) prev_o_value, <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'adjusted'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, shift_n)) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> grp)) prev_shift_n_o_value, <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'adjusted'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">count</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)) <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> orig_val_running_sum <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> <span class="hljs-keyword"><span class="hljs-keyword">between</span></span> <span class="hljs-number"><span class="hljs-number">2000</span></span> <span class="hljs-keyword"><span class="hljs-keyword">preceding</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">preceding</span></span>)) count_o <span class="hljs-number"><span class="hljs-number">8</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.*, <span class="hljs-number"><span class="hljs-number">9</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) - <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>) orig_val_running_sum, <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, lag(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>)) shift_n, <span class="hljs-number"><span class="hljs-number">11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">decode</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>, <span class="hljs-string"><span class="hljs-string">'original'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) grp <span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t) t <span class="hljs-number"><span class="hljs-number">13</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>; ID TYPE VALUE PREV_O_VALUE PREV_SHIFT_N_O_VALUE COUNT_O <span class="hljs-comment"><span class="hljs-comment">---------- ------------------------------ ---------- ------------ -------------------- ---------- 10 original 100 20 original 200 30 adjusted 300 200 2 40 original 400 50 adjusted 500 400 100 3 60 original 600 70 original 700 80 adjusted 800 700 400 5 90 adjusted 900 700 400 5 100 original 1000 110 adjusted 1100 1000 600 2 120 original 1200 130 adjusted 1300 1200 700 1 140 original 1400 150 adjusted 1500 1400 1000 1 15 rows selected.</span></span></code> </pre> <br>  In SparkSQL, the problem is solved without the third point. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.id, t.type, t.value, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'adjusted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'original'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span>, grp) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> prev_o_value, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'adjusted'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">max</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'original'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> shift_n <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span>, grp) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> prev_shift_n_o_value <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> t.*, <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'original'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> lag(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'original'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> shift_n, <span class="hljs-keyword"><span class="hljs-keyword">sum</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> = <span class="hljs-string"><span class="hljs-string">'original'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">over</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">partition</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">position</span></span> <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span>) grp <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t) t <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> +<span class="hljs-comment"><span class="hljs-comment">---+--------+-----+------------+--------------------+ |id |type |value|prev_o_value|prev_shift_n_o_value| +---+--------+-----+------------+--------------------+ |10 |original|100 |null |null | |20 |original|200 |null |null | |30 |adjusted|300 |200 |null | |40 |original|400 |null |null | |50 |adjusted|500 |400 |100 | |60 |original|600 |null |null | |70 |original|700 |null |null | |80 |adjusted|800 |700 |400 | |90 |adjusted|900 |700 |400 | |100|original|1000 |null |null | |110|adjusted|1100 |1000 |600 | |120|original|1200 |null |null | |130|adjusted|1300 |1200 |700 | |140|original|1400 |null |null | |150|adjusted|1500 |1400 |1000 | +---+--------+-----+------------+--------------------+</span></span></code> </pre><br>  As we see the decision on spark-sql almost does not differ from orakla.  But the map-reduce solution: <br><br>  Mapper <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParquetMapper</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Mapper</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LongWritable</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenericRecord</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AvroValue</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenericRecord</span></span></span><span class="hljs-class">&gt;&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Text outputKey = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Text(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AvroValue&lt;GenericRecord&gt; outputValue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AvroValue&lt;GenericRecord&gt;(); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(LongWritable key, GenericRecord value, Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, InterruptedException </span></span>{ outputKey.set(String.valueOf(value.get(<span class="hljs-string"><span class="hljs-string">"position"</span></span>))); outputValue.datum(value); context.write(outputKey, outputValue); } }</code> </pre><br>  Reducer <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParquetReducer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Reducer</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AvroValue</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GenericRecord</span></span></span><span class="hljs-class">&gt;, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Void</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Text</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> shift = <span class="hljs-number"><span class="hljs-number">2</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> TreeMap&lt;Integer, AbstractMap.SimpleEntry&lt;String, Integer&gt;&gt; rows = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TreeMap&lt;Integer,AbstractMap.SimpleEntry&lt;String, Integer&gt;&gt;(); List&lt;Integer&gt; queue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedList&lt;Integer&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String adj = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> lastValue = -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reduce</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Text key, Iterable&lt;AvroValue&lt;GenericRecord&gt;&gt; values, Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, InterruptedException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (AvroValue&lt;GenericRecord&gt; value : values) { rows.put((Integer) value.datum().get(<span class="hljs-string"><span class="hljs-string">"id"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AbstractMap.SimpleEntry(value.datum().get(<span class="hljs-string"><span class="hljs-string">"type"</span></span>), value.datum().get(<span class="hljs-string"><span class="hljs-string">"value"</span></span>))) ; } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(Map.Entry&lt;Integer, AbstractMap.SimpleEntry&lt;String, Integer&gt;&gt; entry : rows.entrySet()) { AbstractMap.SimpleEntry&lt;String, Integer&gt; rowData = entry.getValue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowData.getKey().equals(<span class="hljs-string"><span class="hljs-string">"original"</span></span>)) { lastValue = rowData.getValue() ; queue.add(lastValue) ; adj = <span class="hljs-string"><span class="hljs-string">""</span></span> ; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { adj = <span class="hljs-string"><span class="hljs-string">" "</span></span> + String.valueOf(lastValue); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (queue.size()- shift &gt;<span class="hljs-number"><span class="hljs-number">0</span></span>) { adj = adj + <span class="hljs-string"><span class="hljs-string">" "</span></span> + queue.get(queue.size()-shift).toString() ; } } Text output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Text(entry.getKey()+<span class="hljs-string"><span class="hljs-string">" "</span></span>+rowData.getKey() + <span class="hljs-string"><span class="hljs-string">" "</span></span> + rowData.getValue() + adj); context.write(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, output ); } } }</code> </pre><br>  Run <br><br> <code>[yarn@sandbox map-reduce]$ hadoop fs -cat /out/part-r-00000 <br> 10 original 100 <br> 20 original 200 <br> 30 adjusted 300 200 <br> 40 original 400 <br> 50 adjusted 500 400 200 <br> 60 original 600 <br> 70 original 700 <br> 80 adjusted 800 700 600 <br> 90 adjusted 900 700 600 <br> 100 original 1000 <br> 110 adjusted 1100 1000 700 <br> 120 original 1200 <br> 130 adjusted 1300 1200 1000 <br> 140 original 1400 <br> 150 adjusted 1500 1400 1200</code> <br> <br>  The result: the bigdat stack is huge, there are a lot of subsystems working in its paradigm, map-reduce is just one of the bolts, not the fact that now everyone needs it, in the light of the heyday of Spark fashion.  Butch processing is not the only paradigm implemented in bigdata, and Spark already allows you to write logic, including declarative SQL language.  Map-reduce is also quite beautiful for some tasks, while it easily solves tasks that only recently were able to be accessed by serious Oracle servers.  If you take a closer look at the code, you can see that Spark-sql still doesn‚Äôt implement item 3 of the task, but map-reduce code, although not declarative, came out quite elegant and easily extensible.  Item 3 of the task is easily added to the map-reduce code in a few minutes by the developer of average scall, while the accumulation of analytical functions in an Oracle solution will require serious preparation by the developer. </div><p>Source: <a href="https://habr.com/ru/post/337128/">https://habr.com/ru/post/337128/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337118/index.html">Avito Automation meetup - slides, video, reviews, photos</a></li>
<li><a href="../337120/index.html">Browser browser discord, or Corporate Infrastructure Weekdays</a></li>
<li><a href="../337122/index.html">QIWI Server Party: DevOps beer is not a hindrance</a></li>
<li><a href="../337124/index.html">Analyzing market requirements for data scientist</a></li>
<li><a href="../337126/index.html">Selenium for everyone: how we teach QA engineers to work with autotests</a></li>
<li><a href="../337130/index.html">Wi-Fi or iBeacon? Or it‚Äôs good when technology capabilities coincide with the desired result.</a></li>
<li><a href="../337134/index.html">You think it's time for you to implement CRM, and your company is not ready</a></li>
<li><a href="../337136/index.html">Step-by-Step Startup Plan</a></li>
<li><a href="../337138/index.html">syncProj - utility for generating Visual Studio C ++ projects</a></li>
<li><a href="../337140/index.html">A simple search script of possibly orphaned project files.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>