<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Code Reuse in Go with an Example</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúI'll go look for a ready-made solution on Google‚Äù 

 In the process of working on any software product, the developer may face the problem of borrowi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Code Reuse in Go with an Example</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/248/90d/75e/24890d75e350c3292be5a7a150c7ab15.png" alt="image">  <i>‚ÄúI'll go look for a ready-made solution on Google‚Äù</i> <br><br>  In the process of working on any software product, the developer may face the problem of borrowing someone else's code.  It happens all the time.  Every year, along with the development of social networks for developers, the process becomes more and more natural and smooth.  Forgot, how to get all the words out of the file?  No problem, go to Stack Overflow and get a ready-made snippet.  For particularly advanced cases, there is even a <a href="https://github.com/azac/sublime-howdoi-direct-paste">plug-in</a> for Sublime Text, which, according to the hotkey, searches for the selected text in SO and inserts a piece of code from the received answer directly into the editor.  This approach leads to a number of problems ... <br><a name="habracut"></a><br>  Although the example above is an extreme, as well as a reason for a good joke, there really is a problem.  The image to attract attention shows the result of sorting a float64 array using JavaScript.  I don‚Äôt want to think why it is sorted precisely as an array of strings; let's leave this question to JavaScript fans.  I needed a human sorting in a project on Go, so just like the hero above, my path went through Google. <br><br>  <font color="#2980b9">Disclaimer: A</font> post dedicated to the culture of development and clearly demonstrates some of the benefits of the approach with Go.  If you are negative about biased views, you should not read further. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  <font color="#2980b9">Unexpected trip</font> </h4><br>  The first link for the query <i>"human sort strings"</i> came across <a href="http://www.codinghorror.com/blog/2007/12/sorting-for-humans-natural-sort-order.html">an article from 2007</a> written by @CodingHorror (Jeff Atwood).  Man dear, does not advise the bad.  These links still remain relevant, for example, <a href="http://www.davekoelle.com/alphanum.html">here is</a> a whole bunch of implementations for any language. <br><br>  Jeff's favorite for Python looks like this: <br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> re <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sort_nicely</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( l )</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Sort the given list in the way that humans expect. """</span></span> convert = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> text: int(text) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> text.isdigit() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> text alphanum_key = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> key: [ convert(c) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> c <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> re.split(<span class="hljs-string"><span class="hljs-string">'([0-9]+)'</span></span>, key) ] l.sort( key=alphanum_key )</code> </pre> <br><br>  <font color="#2980b9">Okay, what to do about it?</font>  <font color="#2980b9">How do people usually act?</font>  There are simply no options - you take and copy this piece of code into your project, directly in place.  10 projects - 10 places.  Slightly more rational people bring to the file library various utility rooms, each with its own library. <br>  Every next developer dealing with your code stumbles over this site because: <br><br><ol><li>  <i>"The way that humans expect"</i> , - and how do they expect? </li><li>  How does sorting by <code>alphanum_key</code> work at all?  Need to think... </li><li>  <i>(after 2 hours of experiments and reading the documentation)</i> Damn, but after all on <code>['01', '001', '01', '001']</code> nifiga does not work, because by the specification of <code>sort</code> is stable and the <code>key</code> of these pieces is the same; </li><li>  What about performance?  And if 10,000 elements and for each <code>re.split</code> ; <img src="https://habrastorage.org/getpro/habr/post_images/ea7/ae1/2f2/ea7ae12f287f6b9881a121e40b02c81c.gif" alt="image"></li><li>  Stop, but I generally write on Go, I do not need your one-liners, anyway the algorithm is not working. </li></ol><br>  C # code also used RegExp, C ++ code generally used uranium bears and MFC (comments indicate that this is a modified MFC version of another version that was ported from a Perl script to C ++).  I‚Äôm sure many people who read this will not have a single story about how they rummaged through the ‚Äútrash cans‚Äù with code snippets for different languages, copied the solutions, understood the authors ‚Äôimagination, caught mistakes ... <br><br><blockquote>  <i>‚ÄúGo on a trip to the nearest hospital.</i>  <i>Usually in the neighborhood of any of them there is an unforgettable landfill, where you can find anything.</i>  <i>Your praymari obzhktiv - used syringes.</i>  <i>Quickly enter all their contents into your body and wait for the effect. ‚Äù</i> - Method number 2, Danya Shepovalov. </blockquote><br><h4>  <font color="#2980b9">Go approach</font> </h4><br>  For a couple of hours, the function on Go was successfully implemented.  Then I drove tests, benchmarks, rewrote the function again. <br><div class="spoiler">  <b class="spoiler_title">Final version</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// StringLess compares two alphanumeric strings correctly. func StringLess(s1, s2 string) (less bool) { // uint64 = max 19 digits n1, n2 := make([]rune, 0, 18), make([]rune, 0, 18) for i, j := 0, 0; i &lt; len(s1) || j &lt; len(s2); { var r1, r2 rune var w1, w2 int var d1, d2 bool // read rune from former string available if i &lt; len(s1) { r1, w1 = utf8.DecodeRuneInString(s1[i:]) i += w1 // if digit, accumulate if d1 = ('0' &lt;= r1 &amp;&amp; r1 &lt;= '9'); d1 { n1 = append(n1, r1) } } // read rune from latter string if available if j &lt; len(s2) { r2, w2 = utf8.DecodeRuneInString(s2[j:]) j += w2 // if digit, accumulate if d2 = ('0' &lt;= r2 &amp;&amp; r2 &lt;= '9'); d2 { n2 = append(n2, r2) } } // if have rune and other non-digit rune if (!d1 || !d2) &amp;&amp; r1 &gt; 0 &amp;&amp; r2 &gt; 0 { // and accumulators have digits if len(n1) &gt; 0 &amp;&amp; len(n2) &gt; 0 { // make numbers from digit group in1 := digitsToNum(n1) in2 := digitsToNum(n2) // and compare if in1 != in2 { return in1 &lt; in2 } // if equal, empty accumulators and continue n1, n2 = n1[0:0], n2[0:0] } // detect if non-digit rune from former or latter if r1 != r2 { return r1 &lt; r2 } } } // if reached end of both strings and accumulators // have some digits if len(n1) &gt; 0 || len(n2) &gt; 0 { in1 := digitsToNum(n1) in2 := digitsToNum(n2) if in1 != in2 { return in1 &lt; in2 } } // last hope return len(s1) &lt; len(s2) } // Convert a set of runes (digits 0-9) to uint64 number func digitsToNum(d []rune) (n uint64) { if l := len(d); l &gt; 0 { n += uint64(d[l-1] - 48) k := uint64(l - 1) for _, r := range d[:l-1] { n, k = n+uint64(r-48)*uint64(math.Pow10(k)), k-1 } } return }</span></span></code> </pre><br></div></div>  <i>(in fact, it is no longer final, the haborrower <a href="https://habrahabr.ru/users/mayorovp/" class="user_link">mayorovp</a> in the comments <a href="http://habrahabr.ru/post/208756/">suggested an</a> even more optimal way of comparing numeric fields and I <a href="https://github.com/Xlab/handysort/commits/master">implemented it</a> , new test cases were added)</i> . <br><br>  This code uses only the package <code>"unicode/utf8"</code> to iterate over the bytes in the string, taking into account the width of characters (in Go they are called runes).  So, in the cycle we iterate the runes in two lines (if they still remain there), until we reach the ends of <font color="#2980b9">both</font> lines.  Along the way, we check every rune we read to hit the digital ASCII range ('0' ‚â§ R ‚â§ '9') and if we hit it, we accumulate it in the runes buffer.  For each line <font color="#2980b9">s1, s2</font> there is its own rune <font color="#2980b9">r1, r2</font> and its own buffers <font color="#2980b9">n1, n2</font> .  The rune width <font color="#2980b9">w1, w2 is</font> used only for brute force. <br><br>  If at the time of the search, it turned out that one of the runes is not a digit, then both existing digit buffers are converted into two uint64 numbers <font color="#2980b9">in1, in2</font> and compared.  Immediately, I note that the self-made function <code>digitsToNum</code> works more efficiently <a href="http://golang.org/pkg/strconv/">strconv.ParseUint</a> in this case.  If the numbers in the buffer are the same, then the current runes are compared (obviously, '0' &lt;'a', but here it is important for us to make sure that <font color="#2980b9">r1! = R2</font> , for example, if 'a' and 'a'). <br><br>  As soon as we‚Äôve reached the end of both lines (which means the lines are conditionally equal) and by this time something appeared in the number buffers, we compare the resulting numbers (for example, at the ends of the lines ‚Äúhello123‚Äù and ‚Äúhello124‚Äù).  If this time the lines are conditionally the same, then we apply the last technique - we return the result of a banal length comparison, just like that "a001" <font color="#2980b9">&lt;</font> "a00001". <br><br><h4>  <font color="#2980b9">Testing</font> </h4><blockquote>  <i>"The tests and the code work together to achieve better code."</i> </blockquote><br>  I placed the main code in the <font color="#2980b9">strings.go</font> file, so we put the tests in the <font color="#2980b9">strings_test.go</font> file. <br>  The first test will be for the <code>StringLess</code> function: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestStringLess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//       //  table driven test testset := []struct { s1, s2 string //    less bool //   }{ {"aa", "ab", true}, {"ab", "abc", true}, {"abc", "ad", true}, {"ab1", "ab2", true}, {"ab1c", "ab1c", false}, {"ab12", "abc", true}, {"ab2a", "ab10", true}, {"a0001", "a0000001", true}, {"a10", "abcdefgh2", true}, {"2", "10", true}, {"2", "3", true}, {"a01b001", "a001b01", true}, {"082", "83", true}, } for _, v := range test set { if res := StringLess(v.s1, v.s2); res != v.less { t.Errorf("Compared %s to %s: expected %v, got %v", v.s1, v.s2, v.less, res) } } }</span></span></code> </pre><br>  The second test will check the correctness of the array sorting, just in case, it will cover the <code>Len</code> , <code>Swap</code> , <code>Less</code> functions of the implementation of the interface <code>sort.Interface</code> . <br><div class="spoiler">  <b class="spoiler_title">TestStringSort</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestStringSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { a := []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc5"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc10"</span></span>, } b := []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"abc5"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc10"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, } sort.Sort(Strings(b)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !reflect.DeepEqual(a, b) { t.Errorf(<span class="hljs-string"><span class="hljs-string">"Error: sort failed, expected: %v, got: %v"</span></span>, a, b) } }</code> </pre><br></div></div><br>  Half an hour later our snippet is covered with tests. <br>  Now anyone who is going to use it will be able to verify himself personally: <br><br><pre> <code class="hljs go">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> test -v -cover === RUN TestStringSort --- PASS: TestStringSort (<span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds) === RUN TestStringLess --- PASS: TestStringLess (<span class="hljs-number"><span class="hljs-number">0.00</span></span> seconds) PASS coverage: <span class="hljs-number"><span class="hljs-number">100.0</span></span>% of statements ok github.com/Xlab/handysort <span class="hljs-number"><span class="hljs-number">0.019s</span></span></code> </pre><br>  However, simple unit testing is not enough when there is a desire to show that the solution is quite effective.  First of all, this is useful for myself, because after benchmarks I sped up the code several times.  For example, I refused an alternative version using <code>regexp</code> - although it took 6 lines, the loss according to the benchmark results was enormous.  Using <code>strconv</code> and <code>unicode.IsDigit</code> not good for performance.  A simple benchmark using Go tools in the same <font color="#2980b9">strings_test.go</font> file: <br><br><pre> <code class="go hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkStringSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { <span class="hljs-comment"><span class="hljs-comment">//  1000   10000    : // *    3-8 ; // *    1-3 ; // *      . // 300    random seed,     //      ; //  func testSet     . set := testSet(300) // [][]string b.ResetTimer() //      // bN   for i := 0; i &lt; bN; i++ { //       sort.Strings(set[bN%1000]) } } func BenchmarkHandyStringSort(b *testing.B) { set := testSet(300) b.ResetTimer() for i := 0; i &lt; bN; i++ { //       sort.Sort(handysort.Strings(set[bN%1000])) } }</span></span></code> </pre><br>  Full version of the file with two tests and two benchmarks: <br><div class="spoiler">  <b class="spoiler_title">strings_test.go</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> handysort <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"math/rand"</span></span> <span class="hljs-string"><span class="hljs-string">"reflect"</span></span> <span class="hljs-string"><span class="hljs-string">"sort"</span></span> <span class="hljs-string"><span class="hljs-string">"strconv"</span></span> <span class="hljs-string"><span class="hljs-string">"testing"</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestStringSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { a := []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc5"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc10"</span></span>, } b := []<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>{ <span class="hljs-string"><span class="hljs-string">"abc5"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc1"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc10"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc2"</span></span>, } sort.Sort(Strings(b)) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> !reflect.DeepEqual(a, b) { t.Errorf(<span class="hljs-string"><span class="hljs-string">"Error: sort failed, expected: %v, got: %v"</span></span>, a, b) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TestStringLess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(t *testing.T)</span></span></span></span> { testset := []<span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> { s1, s2 <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> less <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> }{ {<span class="hljs-string"><span class="hljs-string">"aa"</span></span>, <span class="hljs-string"><span class="hljs-string">"ab"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"ab"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-string"><span class="hljs-string">"ad"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"ab1"</span></span>, <span class="hljs-string"><span class="hljs-string">"ab2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"ab1c"</span></span>, <span class="hljs-string"><span class="hljs-string">"ab1c"</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>}, {<span class="hljs-string"><span class="hljs-string">"ab12"</span></span>, <span class="hljs-string"><span class="hljs-string">"abc"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"ab2a"</span></span>, <span class="hljs-string"><span class="hljs-string">"ab10"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"a0001"</span></span>, <span class="hljs-string"><span class="hljs-string">"a0000001"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"a10"</span></span>, <span class="hljs-string"><span class="hljs-string">"abcdefgh2"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"10"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, {<span class="hljs-string"><span class="hljs-string">"2"</span></span>, <span class="hljs-string"><span class="hljs-string">"3"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>}, } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> _, v := <span class="hljs-keyword"><span class="hljs-keyword">range</span></span> testset { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> res := StringLess(v.s1, v.s2); res != v.less { t.Errorf(<span class="hljs-string"><span class="hljs-string">"Compared %s to %s: expected %v, got %v"</span></span>, v.s1, v.s2, v.less, res) } } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkStringSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { set := testSet(<span class="hljs-number"><span class="hljs-number">300</span></span>) b.ResetTimer() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { sort.Strings(set[bN%<span class="hljs-number"><span class="hljs-number">1000</span></span>]) } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BenchmarkHandyStringSort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(b *testing.B)</span></span></span></span> { set := testSet(<span class="hljs-number"><span class="hljs-number">300</span></span>) b.ResetTimer() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; bN; i++ { sort.Sort(Strings(set[bN%<span class="hljs-number"><span class="hljs-number">1000</span></span>])) } } <span class="hljs-comment"><span class="hljs-comment">// Get 1000 arrays of 10000-string-arrays. func testSet(seed int) [][]string { gen := &amp;generator{ src: rand.New(rand.NewSource( int64(seed), )), } set := make([][]string, 1000) for i := range set { strings := make([]string, 10000) for idx := range strings { // random length strings[idx] = gen.NextString() } set[i] = strings } return set } type generator struct { src *rand.Rand } func (g *generator) NextInt(max int) int { return g.src.Intn(max) } // Gets random random-length alphanumeric string. func (g *generator) NextString() (str string) { // random-length 3-8 chars part strlen := g.src.Intn(6) + 3 // random-length 1-3 num numlen := g.src.Intn(3) + 1 // random position for num in string numpos := g.src.Intn(strlen + 1) var num string for i := 0; i &lt; numlen; i++ { num += strconv.Itoa(g.src.Intn(10)) } for i := 0; i &lt; strlen+1; i++ { if i == numpos { str += num } else { str += string('a' + g.src.Intn(16)) } } return str }</span></span></code> </pre><br></div></div><br>  Running all the benchmarks of a package is as easy as testing: just run <code>go test</code> with an indication of the flag and mask.  For example, you can run only <code>BenchmarkHandyStringSort</code> , specifying <code>Handy</code> as the mask.  We are interested in both: <br><br><pre> <code class="hljs go">$ <span class="hljs-keyword"><span class="hljs-keyword">go</span></span> test -bench=. PASS BenchmarkStringSort <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">4694244</span></span> ns/op BenchmarkHandyStringSort <span class="hljs-number"><span class="hljs-number">100</span></span> <span class="hljs-number"><span class="hljs-number">15452136</span></span> ns/op ok github.com/Xlab/handysort <span class="hljs-number"><span class="hljs-number">91.389s</span></span></code> </pre><br>  Here, using the example of random arrays of 10,000 rows of different lengths, the human sorting variant showed itself 3.3 times slower than the regular version.  Sorting <font color="#2980b9"><i>10,000 lines in 15.6ms</i></font> on Intel i5 1.7GHz is an acceptable result, I believe the algorithm can be considered working.  If someone comes up with something similar and his benchmarks show the result in 5ms (comparable to 4.7ms of standard sorting), everyone will be happy, because the advantage will be <font color="#2980b9"><i>measured</i></font> . <br><br>  <font color="#2980b9">Important links to official materials about various aspects of testing in Go:</font> <br><ul><li>  <a href="http://golang.org/doc/code.html">golang.org/doc/code.html#Testing</a> </li><li>  <a href="http://golang.org/pkg/testing/">golang.org/pkg/testing</a> </li><li>  <a href="http://golang.org/doc/faq">golang.org/doc/faq#testing_framework</a> </li><li>  <a href="http://blog.golang.org/cover">blog.golang.org/cover</a> </li></ul><br><br><h4>  <font color="#2980b9">Spread</font> </h4><br>  After we combed our snippet, covered it with tests and measured performance, it‚Äôs time to share it with the public.  The name of the package came up with <code>handysort</code> , hosting of course GitHub, so the full name of the package I got is <code>github.com/Xlab/handysort</code> - this way of recording prevents any conflicts of package names, guarantees the authenticity of the sources and opens up really cool possibilities for further work with the package. <br><br><pre> <code class="hljs css">. ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">LICENSE</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">README</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.md</span></span> ‚îú‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">strings</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.go</span></span> ‚îî‚îÄ‚îÄ <span class="hljs-selector-tag"><span class="hljs-selector-tag">strings_test</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.go</span></span> 0 <span class="hljs-selector-tag"><span class="hljs-selector-tag">directories</span></span>, 4 <span class="hljs-selector-tag"><span class="hljs-selector-tag">files</span></span></code> </pre><br>  Files in the composition of the full component.  Try, maybe, look at the code of some java-component: <br>  <a href="">telegram-api&gt; src&gt; main&gt; java&gt; org&gt; telegram&gt; api&gt; engine&gt; file&gt; UploadListener.java</a> <br>  - and everything ?!  Well, ooook, now click back. <br><br>  <font color="#2980b9"><i>Approach I</i></font> <br>  Thus, no additional package design is required: you take your code, comment, cover with tests and upload to GitHub.  Now anyone can take advantage of this package by connecting it to the <code>include</code> section among others: <br><br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ( <span class="hljs-string"><span class="hljs-string">"bufio"</span></span> <span class="hljs-string"><span class="hljs-string">"bytes"</span></span> <span class="hljs-string"><span class="hljs-string">"errors"</span></span> <span class="hljs-string"><span class="hljs-string">"fmt"</span></span> <span class="hljs-string"><span class="hljs-string">"github.com/Xlab/handysort"</span></span> <span class="hljs-string"><span class="hljs-string">"io"</span></span> )</code> </pre><br>  When building a package automatically tightened if there is no local copy or it is outdated.  The author can improve the package, correct errors, your product will be effectively provided with fresh versions of packages. <br><br>  If you did not skimp on comments on the exported functions (functions with a capital letter, inside - non-public comments) and did not forget to write a brief explanation of the package, as in the example with <code>handysort</code> : <br><div class="spoiler">  <b class="spoiler_title">strings.do</b> <div class="spoiler_text"><pre> <code class="go hljs"><span class="hljs-comment"><span class="hljs-comment">// Copyright 2014 Maxim Kouprianov. All rights reserved. // Use of this source code is governed by the MIT license // that can be found in the LICENSE file. /* Package handysort implements an alphanumeric string comparison function in order to sort alphanumeric strings correctly. Default sort (incorrect): abc1 abc10 abc12 abc2 Handysort: abc1 abc2 abc10 abc12 Please note, that handysort is about 5x-8x times slower than a simple sort, so use it wisely. */ package handysort import ( "unicode/utf8" ) // Strings implements the sort interface, sorts an array // of the alphanumeric strings in decreasing order. type Strings []string func (a Strings) Len() int { return len(a) } func (a Strings) Swap(i, j int) { a[i], a[j] = a[j], a[i] } func (a Strings) Less(i, j int) bool { return StringLess(a[i], a[j]) } // StringLess compares two alphanumeric strings correctly. func StringLess(s1, s2 string) (less bool) { // uint64 = max 19 digits n1, n2 := make([]rune, 0, 18), make([]rune, 0, 18) for i, j := 0, 0; i &lt; len(s1) || j &lt; len(s2); { var r1, r2 rune var w1, w2 int var d1, d2 bool // read rune from former string available if i &lt; len(s1) { r1, w1 = utf8.DecodeRuneInString(s1[i:]) i += w1 // if digit, accumulate if d1 = ('0' &lt;= r1 &amp;&amp; r1 &lt;= '9'); d1 { n1 = append(n1, r1) } } // read rune from latter string if available if j &lt; len(s2) { r2, w2 = utf8.DecodeRuneInString(s2[j:]) j += w2 // if digit, accumulate if d2 = ('0' &lt;= r2 &amp;&amp; r2 &lt;= '9'); d2 { n2 = append(n2, r2) } } // if have rune and other non-digit rune if (!d1 || !d2) &amp;&amp; r1 &gt; 0 &amp;&amp; r2 &gt; 0 { // and accumulators have digits if len(n1) &gt; 0 &amp;&amp; len(n2) &gt; 0 { // make numbers from digit group in1 := digitsToNum(n1) in2 := digitsToNum(n2) // and compare if in1 != in2 { return in1 &lt; in2 } // if equal, empty accumulators and continue n1, n2 = n1[0:0], n2[0:0] } // detect if non-digit rune from former or latter if r1 != r2 { return r1 &lt; r2 } } } // if reached end of both strings and accumulators // have some digits if len(n1) &gt; 0 || len(n2) &gt; 0 { in1 := digitsToNum(n1) in2 := digitsToNum(n2) if in1 != in2 { return in1 &lt; in2 } } // last hope return len(s1) &lt; len(s2) } // Convert a set of runes (digits 0-9) to uint64 number func digitsToNum(d []rune) (n uint64) { if l := len(d); l &gt; 0 { n += uint64(d[l-1] - 48) k := uint64(l - 1) for _, r := range d[:l-1] { n, k = n+uint64(r-48)*uint64(10)*k, k-1 } } return }</span></span></code> </pre><br></div></div><br>  Such comments are automatically recognized by the <a href="http://golang.org/cmd/godoc/">godoc</a> documentation <a href="http://golang.org/cmd/godoc/">system</a> .  You can view the package documentation in many ways, for example in the console: <code>godoc &lt; &gt;</code> .  There is a web service <a href="http://godoc.org/">godoc.org</a> that allows you to quickly view the documentation of any package, if it is located on one of the well-known hosting code.  This means that if you have commented out the public functions in the code and the project is located, for example, on github, then the package documentation is available at <a href="http://godoc.org/github.com/Xlab/handysort">godoc.org/github.com/Xlab/handysort</a> (you can substitute any full package name).  The entire standard library is ideally commented out (for example, <a href="http://godoc.org/fmt">godoc.org/fmt</a> ), when studying packages it is useful to look at not only godoc documents, but also read the source code, I recommend. <br><br><img src="http://cl.ly/TKPb/godoc.gif" alt="image"><br><br>  <font color="#2980b9">Important links to official materials about various aspects of code design in Go:</font> <br><ul><li>  <a href="http://blog.golang.org/organizing-go-code">blog.golang.org/organizing-go-code</a> </li><li>  <a href="http://blog.golang.org/go-fmt-your-code">blog.golang.org/go-fmt-your-code</a> </li><li>  <a href="http://blog.golang.org/godoc-documenting-go-code">blog.golang.org/godoc-documenting-go-code</a> </li></ul><br>  <font color="#2980b9"><i>Approach II</i></font> <br>  In case of a lack of confidence in the ‚Äúrandom dude on GitHub‚Äù or if you need to fix a specific version of the package, you can fork the repository and connect the package as <code>github.com/VasyaPupkin/handysort</code> , the essence will not change.  At the same time, you can save humanity if one day the author of the original repository <a href="http://ru.wikipedia.org/wiki/Bus_factor">collects wheels / mushrooms</a> and methodically <a href="http://ru.wikipedia.org/wiki/Bus_factor">deletes the</a> repositories with their packages, to which many have direct links in the source code. <br><br>  <font color="#2980b9"><i>Approach III</i></font> <br>  Finally, if the project‚Äôs dependencies do not need someone else‚Äôs package and github links, it is advisable to transfer the functionality to your package ‚Äî copy the two <code>strings.go</code> and <code>strings_test.go</code> into your <code>handysort.go</code> and <code>handysort_test.go</code> .  Thus, the functional will not touch the main part in any way, and tests and benchmarks will become common.  By the way, the code in Go is formatted automatically and therefore any foreign library will be framed in a clear and proper style. <br><br><h4>  <font color="#2980b9">Instead of conclusion</font> </h4><br><img src="http://cs312621.vk.me/v312621963/81ee/C0rNKUlkth8.jpg" alt="image"><br>  Post prepared with the support of the plugin <a href="https://github.com/DisposaBoy/GoSublime">GoSublime</a> for Sublime Text. <br>  All matches are random. </div><p>Source: <a href="https://habr.com/ru/post/208756/">https://habr.com/ru/post/208756/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../208744/index.html">Virgin Galactic conducted the third supersonic flight, reaching a new height</a></li>
<li><a href="../208746/index.html">LXC (Linux Containers) - is everything really good?</a></li>
<li><a href="../208748/index.html">How to use Memcached with Ruby on Rails in Ubuntu 12.04 LTS</a></li>
<li><a href="../208752/index.html">The digest of interesting materials from the world of web development and IT for the last week No. 91 (January 5 - 11, 2014)</a></li>
<li><a href="../208754/index.html">Replacing ctags for perl in mooedit</a></li>
<li><a href="../208760/index.html">The programmer is preparing to receive investments: a step by step guide</a></li>
<li><a href="../208764/index.html">Extraction of "knowledge" or classification into one if</a></li>
<li><a href="../208766/index.html">Dropbox crash</a></li>
<li><a href="../208768/index.html">Get rid of extra $ watch'erov</a></li>
<li><a href="../208770/index.html">Retailer network Overstock.com received 130 thousand dollars for the first day after the start of taking Bitcoin</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>