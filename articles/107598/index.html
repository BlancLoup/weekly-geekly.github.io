<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The tale of how I put an unsupported Wimax / Wifi card in Lenovo X201</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I somehow got into the hands of the personal use of the laptop Lenovo X201 - a great working machine. 
 Everything seems good and everything seems to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The tale of how I put an unsupported Wimax / Wifi card in Lenovo X201</h1><div class="post__text post__text-html js-mediator-article"> I somehow got into the hands of the personal use of the laptop <a href="http://habrahabr.ru/blogs/laptop/98787/">Lenovo X201</a> - a great working machine. <br>  Everything seems good and everything seems to be there, but as usual I want more - I wanted to have built-in WiMax (I already have a 3G modem and works pretty well). <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b47/f55/601/b47f55601e8097925fe87099d4faa1c7.jpg" alt="image"><br><br>  For WiMax, an Intel WiMax / Wifi Link 5150 PCIe Mini Card was purchased. <br>  After installation, it turned out that most modern laptops (in particular, Lenovo) are equipped with White-list devices that they support.  This is done apparently so that users buy only branded devices in retail stores.  Honestly, I would be glad to buy such a device if they were sold freely with us (correct me, if that is the case, maybe I didn‚Äôt look well enough). <br>  In particular, my laptop was upset when he saw that the card I slipped to him is not in the White-list and issued a message to: <br> <code>1802: Unauthorized network card is plugged in - Power off and remove the miniPCI network card.</code> <br>  In case of installation of an unsupported 3G modem, you will receive a message: <br> <code>1804: Unauthorized WAN card is plugged in - Power off and remove the WAN card.</code> <br> <a name="habracut"></a><br>  Just want to draw attention to one feature, for those who do not know.  In fact, WiFi and WiMax being on the same board are connected via two different channels - one PCIe, the second USB, respectively. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Maybe this will surprise someone (like, for example, me earlier) - WiMax is connected via the USB bus, although both devices are on the same board.  Such a connection is not obvious and the most important thing - the presence of USB desoldering on the PCIe connector is not mandatory (which is what I pinned on a Lenovo x61s laptop) - it is necessary to check it with a tester or read the internal docks. <br>  Some information about USB on the mini-PCIe connector is on <a href="http://ru.wikipedia.org/wiki/PCI_Express">Wikipedia</a> - conclusions 36, 38. <br><br>  And by the way, such a hybrid card (at least mine) cannot work in two modes at once.  Those.  or wifi or wimax, switching software.  This, in theory, can cause problems with powering up the card.  Judging by the forums, problems are solved, but it feels like you can't do without a soldering iron.  Fortunately for me - it cost. <br><br>  So if suddenly this article encourages someone to buy a Wifi / Wimax card, you first need to make sure that there is a USB in the PCIe connector, otherwise you will have to be pretty thorough. <br>  Despite the lack of USB, some craftsmen still managed to dissolve USB on the MiniPCI - all you need is desire, hands, wires, a soldering iron and a circuit, but this is already extreme. <br><br>  Began research problems with the forum: <br>  <b>(1)</b> <a href="http://forum.thinkpads.com/viewtopic.php%3Ft%3D55837">forum.thinkpads.com/viewtopic.php?t=55837</a> <br>  and in consequence <br>  <b>(2)</b> <a href="http://www.thinkwiki.org/wiki/Problem_with_unauthorized_MiniPCI_network_card">www.thinkwiki.org/wiki/Problem_with_unauthorized_MiniPCI_network_card</a> <br>  <b>(3)</b> <a href="http://web.dodds.net/~vorlon/wiki/blog/Upgrading_a_ThinkPad_BIOS.html">http://web.dodds.net/~vorlon/wiki/blog/Upgrading_a_ThinkPad_BIOS.html</a> <br>  <b>(4)</b> <a href="http://www.endeer.cz/bios.tools/">www.endeer.cz/bios.tools</a> <br>  <b>(5)</b> <a href="http://www.endeer.cz/bios.tools/bios.html">www.endeer.cz/bios.tools/bios.html</a> <br>  <b>(6)</b> <a href="">http://forums.mydigitallife.info/threads/20223-Remove-whitelist-check-add-ID-s-to-break-hardware-restrictions-mod-requests.?p=338719#post338719</a> <br>  <b>(7)</b> <a href="http://www.endeer.cz/bios.tools/modz.html%3Fmachine%3DALL">www.endeer.cz/bios.tools/modz.html?machine=ALL</a> <br><br>  I found myself in a rather difficult case - the BIOS of the new modification and the ways of editing a couple of bytes in the CMOS did not work anymore, and there was no ready BIOS for my model by reference (7).  In my case, there were 3 ways to solve the problem: <br><ol><li>  Disable white-list checking </li><li>  Writing VEN / DEV / SUBSYS from my card in the white-list to replace some unnecessary card </li><li>  Change the VEN / DEV / SUBSYS in my map to those already in the white-list. </li></ol><br>  The third method looked somehow not beautiful and threatened with problems with firewood. <br>  The second method was seductive and seemed easier - because  You do not have to bother with the search for ASM-code and the manufacture of the patch, but still I aimed at the first method - because  It is more versatile and beautiful. <br><br>  Decide which way to choose you.  Method 3 is described by reference (2). <br>  Method 2 - stupidly replacing a sequence of bytes to the ones of interest.  The BIOS checksum, as I understand it, is not specifically checked anywhere, at least for my version.  Perhaps there are some traps, but because  I did not try to go this way - I do not know about them. <br><br>  After reading the links (4), (5) I kind of got inspired by the idea to make a patched bios myself, but after a few hours of working with the tools on the 4th link + IDA, I was a little tired and thought about scoring this idea. <br>  However, the line seen from the link (3) suddenly opened a second wind <br><img src="https://habrastorage.org/getpro/geektimes/post_images/367/d30/d36/367d30d36b0f4b6cb3b82ab5a150fcd7.gif" alt="image"><br><br>  Once again I read the contents of the links (4) and (5) more carefully and slowly began to pick the BIOS.  I will not translate what is written there, because  unfortunately, the author of these pages in my opinion is not very good with the availability of the presentation and the general availability of information (although the articles are literate), and I didn‚Äôt quite understand the part of the article concerning the actual search for the code and thinking about the replacement.  Probably being an avid connoisseur of IDA and assembler, you can understand what he writes - but I would rather measure out several times in bios issues than once unsuccessfully cut off (it was a sad experience).  There is also a feeling that the information in the article is a bit outdated.  Of course, I did have some knowledge of the assembler, but they are clearly not enough to understand what needs to be done. <br><br>  In general, my research did not lead to anything understandable, but fortunately at the right moment, when I almost dropped my hands a second time, a good acquaintance <a href="https://geektimes.ru/users/kmeaw/" class="user_link">kmeaw</a> helped me - and quickly found the check function on the White-list in the right file and corrected several byte.  On this lyric part, I will probably finish and proceed to the description of my actions. <br><br><h6>  A little warning. </h6><br><h4>  ALL THE FURTHER ACTIONS YOU DO AT YOUR OWN RISK !!! </h4><br>  Working with the BIOS (especially if you do everything yourself) is a very responsible and dangerous process. <br>  All the steps below are related to BIOS v1.22 for Lenovo X201 and may differ from the actions needed for other laptops, although I will try to describe the general principle. <br>  All utilities for working with BIOS can be found at the link at the end of the article. <br><br>  The BIOS hack consists of several stages: <br><ol><li>  Downloading, unpacking, decomposing modules. </li><li>  Search for verification functions (for WAN, one function, for WWAN, another) </li><li>  Organization of circumvention of the verification functions </li><li>  Fit the packaged version of the file to the size of the original version (the size must match) </li><li>  Making changes to the main BIOS module by comparing the original and patched version of the module. </li></ol><br>  Let's start. <br><h5>  <b>1.</b> Downloading, unpacking, decomposing modules. </h5><br>  The first thing to do is to get the BIOS file itself for further work.  This can be done in two ways: <br>  * Make backup of the current BIOS and work with it.  For some reason I decided not to use this method and I can‚Äôt tell you anything about it. <br>  * Download from the official site <a href="">file</a> with firmware, unpack. <br><br>  The file of interest $ 01C2100.FL1 will be located at \ DRIVERS \ FLASH \ 6quj08us \ 6QET52WW <br>  This file is a compressed system BIOS image.  All other files (other than FL1) belong to some other parts of the system that I was not interested in and do not know what they are intended for - they are not really needed in the future. <br><br>  After the file of interest is found, it will be necessary to unpack it. <br>  To do this, enter the command: <br> <code>phcomp /D $01C2100.FL1</code> <br>  Then you need to gut the resulting file to the modules with the command <br> <code>phnxsplit.exe $01C2100.FLh</code> <br>  (for phnxsplit.exe, the cygwin1.dll library is required) <br>  I think it‚Äôs worth paying attention to the fact that most of the files were unpacked using the lzint algorithm and to get everything back - you need to pack the corrected file back - but more on that later. <br><h5>  <b>2.</b> Search for verification functions (for WAN, one function, for WWAN, another) </h5><br>  After executing the command, you will receive a bunch of files with the extension * .rom.  Among this disgrace, you need to find the desired file, on which we will continue to mock.  First of all, you need to find a device that is 100% in the while-list.  For this you need (the method for XP will be described below, if you have another OS - try to find a way to find out the data yourself) go to <br>  "Device Manager \ (wifi device or 3g modem) \ information \ device instance code" <br>  Let it be, for example: <br> <code>Intel Wifi Link 1000BGN, PCI\VEN_8086&amp;DEV_0084&amp;SUBSYS_13158086&amp;REV_00</code> <br>  The data of interest are: <br> <code>VEN_8086&amp;DEV_0084&amp;SUBSYS_13158086</code> <br>  This results in the following search string: <br> <code>0x8680840086801513</code> <br>  In the case of a 3G modem <br> <code>0xc6050592</code> <br>  I think it is clear how this happened (inverse byte order for each part of the record). <br>  You can use this straight line from the example, I think it should be in your bios. <br><br>  After receiving such a line, you need to somehow look in all the unpacked files.  Most likely it will be a single file BIOSCODEXX.rom <br>  I personally did this using FAR (Alt + F7, look for hexadecimal code). <br><br>  In my case, the file with the check function of interest turned out to be the file BIOSCODE06.rom <br>  This is where the fun begins. <br>  Having opened it through IDA, for quite a long time I tried to understand what is being said on the link (5).  By the way, to open a file with a bios, you must first rename the source file to a file with the .hex extension. <br>  The file consists of a 27-byte header and the body of a binary hexadecimal application.  In the header there is an indication of the offset, relative to the main BIOS.  What I understood is that the offset is indicated there, since during operation all the modules are in the same memory area and the function pointers in the module are referenced taking into account the offset. <br><h5>  <b>3.</b> Organization of bypassing the verification functions </h5><br>  In practice, it turned out that in the code part of interest to us, all jmp on functions are relative and the offset does not play any value. <br>  Attempts to understand the module independently didn‚Äôt lead to anything - due to the lack of even minimal experience in disassembling matters, in spite of a small knowledge of the assembler, so I had to turn to a friend for advice. <br>  After 10 minutes, he sent me such a screenshot <br><img src="https://habrastorage.org/getpro/geektimes/post_images/b30/e2b/29a/b30e2b29aed0b9690222a223a662bc8b.png" alt="image"><br>  The screenshot itself contained what needs to be corrected. <br><br>  After seeing the screenshot, I decided to use hiew 6.50 (which can be found in the archive) to edit the file, since  It turned out to be simpler than IDM. <br>  A little help on using HIEW: <br> <code>F4 -   (Text, Hex, Decode) <br> ------      Hex <br> ------    -   Decode <br> ------   Hex   Ctrl+F5 <br> Ctrl+F5 -  .       27- .     ,    -1B <br> F5 -    (  hex) <br> F3 -  <br> F9 - . <br></code> <br><br>  The edit shown in the screenshot is quite clear and simple after the white-list check function was found. <br>  The function is called only from one place, it has clear boundaries.  The change is that at the beginning of the function jmp occurs at the end of the function.  The output looks as if the card has successfully passed the test. <br>  It seems that the check function was killed, it would seem that everything, but no - the function was responsible only for Wifi / Wimax cards (error 1802).  There is one more function - to check the WAN (error 1804).  It didn‚Äôt take long to find it - the principle turned out to be identical, but it took a long time to make the patch, because after editing, the module in compressed form did not want to become the right size (the same size as it was before the changes were made). <br><br>  The same size is necessary because the phnxmod.exe utility, which later replaces the module in the $ 01C2100.FLh file, cannot work with files if the new one differs from the old one by at least. <br><br>  Actually, in order to make the necessary change and adjust the size, I had to fix a lot and wipe a piece of the check function (since after adding jmp, it was no longer needed). <br>  Result on the picture: <br><img src="https://habrastorage.org/getpro/geektimes/post_images/67a/78a/91b/67a78a91bd973d1fafe9e9d79b16585e.png" alt="image"><br>  The top screenshot is a detour for the WAN card check function. <br>  The bottom screenshot is a detour for Wfi / Wimax card check functions. <br><br><h5>  <b>4.</b> Fit the packaged version of the file to the size of the original version. </h5><br>  The change was made to the file, after the file was back packaged. <br>  It is worth noting that the file is not packaged by the phcomp command, as you might think.  A set of commands from the kit to the BIOS. <br> <code><a href="http://web.dodds.net/~vorlon/phoenix_bios_prepare_module"></a>    - prepare.exe <br> ------        ,  ,   -. <br> ------          ,  logo.scr.    <br> ------  "LOGO logo.."  "BIOSCODE file.rom" <br>    - fi.exe, fp.exe, ceimain.bin, rom2mod.exe <br> ------        ,  ,   -. <br> ------          ,  logo.scr.    <br> ------ "LOGO logo.."  "BIOSCODE file.rom" <br> ------    linux   wine    <br></code> <br>  Determine the old from the new - you can by what comes with the BIOS in the folder \ DRIVERS \ FLASH \ 6quj08us <br>  In general, I was taking a long time with this until I realized.  At the end of the article there is a ready-made set of utilities for packing a patched file, in particular, for my BIOS with a bat-nick (based on logo.bat). <br><br>  Also, you need to pack the source file, which I called BIOSCODE06.rom <br>  The result was two BIOSCODE06.rom-lz (patched) files, BIOSCODE06.rom-orig-lz (original) of the same size. <br><h5>  <b>5.</b> Making changes to the main BIOS module by comparing the original and patched versions of the module. </h5><br>  The final step on the way to the finished patched BIOS is replacing the module in the compiled basic BIOS file $ 01C2100.FLh <br><br>  To do this, you must use the command: <br> <code>phnxmod.exe 01C2100.FLh BIOSCODE06.ro2 BIOSCODE06.ro2.patched</code> <br>  The syntax is: <br>  phnxmod.exe (unpacked version $ 01C2100.FL1) (original packed module) (modified packed module). <br><br>  After executing the command, you should see something like this: <br> <code>Okay, all files open. <br> ROM size 200000h, old module 7B66h+1Bh, new module 7B66h+1Bh. <br> Loading data...Old module (without header) found at 1EA565h. Replaced. <br> Writing modified ROM back... Done. <br> <br> ---------------- WARNING! ---------------- <br> If you don't know what you're doing there's a very high risk of rendering your <br> computer unusable by flashing a modified BIOS. This is not a safe playground. <br> ---------------- WARNING! ---------------- <br></code> <br>  This is the last stage of the hack. <br><br>  The resulting patched $ 01C2100.FLh file can be used for flashing using WinPhlash. <br>  For this I took the <a href="">archive</a> from the link (6), corrected the rom-file and the config and reshooted my laptop. <br><br>  After flashing, I successfully launched an unsupported Wimax / wifi card on my laptop, checked the connection to Wifi, Wimax (Comstar, Yota) - everything is fine. <br><br>  Also, the Sierra MC8775 3G module was tested, which should not be supported on this model.  The laptop has successfully booted.  After installing the drivers, I managed to successfully connect to the 3G network. <br><br>  Files: <br>  1. <a href="">Ready archive with patched BIOS 1.22 for Lenovo X201 (no white-list) bypass 1802/1804 error</a> <br> <code>  : <br>  WinPhlash.exe  .  "Advanced Settings"    -   : <br> <br> ("Flags" Tab): <br> [ ] Verify BIOS part number <br> [ ] Flash only if BIOS version is different <br> [ ] Flash only if BIOS version is newer <br> [ ] Verify BIOS image size <br> [ ] Verify BIOS checksum <br> [ ] Zero block before erasing <br> [x] Verify block after programming <br> [x] Disable Axx swaping automatic detection (if present) <br> [ ] Clear CMOS Checksum <br> <br> ("DMI" tab) <br> "Update": Select "Update the BIOS and not DMI" <br></code> <br>  2. <a href="">Patched BIOSCODE06.rom file</a> ($ 01C2100.FLh in the archive is already patched) <br>  3. <a href="">A set of utilities for working with BIOS</a> <br>  4. <a href="">Utilities for packing the module</a> <br><br>  In conclusion, I want to once again remind you that everything you do with the BIOS is very responsible and serious.  If there is uncertainty in something, it is better to double-check a hundred times and make sure that you are doing everything correctly.  When reflashing, be sure to turn off all programs and applications (if you are flashing from windows), or better - flashing from a bootable CD or flash drive.  It is also better to use already patched and checked BIOS versions (you can try to find by reference (7) than to do them yourself, and if you do, read as much information as possible, except for this article, at least by the links indicated above. <br><br>  ps.  Thanks to <a href="https://geektimes.ru/users/kmeaw/" class="user_link">kmeaw</a> for helping <a href="https://geektimes.ru/users/kmeaw/" class="user_link">me</a> with the ASM code editing and the guidance on the true path. <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/107598/">https://habr.com/ru/post/107598/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../107586/index.html">iPhone vs. Android vs. Blackberry</a></li>
<li><a href="../107588/index.html">Search urban routes in 15 cities and 3 widgets for sites - See Kartu.ru</a></li>
<li><a href="../107589/index.html">Android-based gadgets gradually come to the fore</a></li>
<li><a href="../107590/index.html">Europe wants more control over personal information on the web</a></li>
<li><a href="../107592/index.html">Android-based gadgets gradually come to the fore</a></li>
<li><a href="../107601/index.html">Another open source from Google: Project Szl</a></li>
<li><a href="../107603/index.html">Data model visualization</a></li>
<li><a href="../107605/index.html">Here be dragons: Memory management in Windows as it is [1/3]</a></li>
<li><a href="../107606/index.html">We watch full-screen flash video on the second monitor, we work on the first</a></li>
<li><a href="../107607/index.html">Here be dragons: Memory management in Windows as it is [2/3]</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>