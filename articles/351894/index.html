<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spread S3 Buckets across different pools in Ceph Luminous</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the process of setting up a new cluster on Ceph Luminous, the task appeared to spread various S3 buckets across different storage devices (in my ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spread S3 Buckets across different pools in Ceph Luminous</h1><div class="post__text post__text-html js-mediator-article">  In the process of setting up a new cluster on Ceph Luminous, the task appeared to spread various S3 buckets across different storage devices (in my case, SSD and HDD).  There are many instructions on the Internet on how to do this in Ceph Jewel, but in the case of Luminous, the process has undergone great changes and the old instructions no longer work.  However, this scenario is not described in the off-documentation, the configuration process is not too trivial. <br><a name="habracut"></a><br><h2>  Task </h2><br>  Once again I will describe the task: a certain number of HDD and SSD disks are installed in each node of the cluster.  It is necessary that when creating an S3 baketa, specify which devices to store it (HDD or SSD). <br><br><h2>  We carry pools on different devices </h2><br>  Let's look at the current replication rules.  By default, there should only be a ‚Äúreplicated_rule‚Äù entry: <br><br><pre><code class="hljs pgsql">ceph osd crush <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> ls</code> </pre> <br>  Thanks to the innovation in Luminous Ceph can determine the type of device itself and we can easily separate them according to different replication rules: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="hljs pgsql">ceph osd crush <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-replicated replicated_hdd <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> host hdd ceph osd crush <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-replicated replicated_ssd <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> host ssd</code> </pre><br>  Remove the old default rule: <br><br><pre> <code class="hljs pgsql">ceph osd crush <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> rm replicated_rule</code> </pre> <br>  Now we will create a new additional pool in which we will store S3 objects and locate it on the SSD: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">ceph</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">osd</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pool</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">create</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">default</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.rgw</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.buckets</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.data</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ssd</span></span> 8 8 <span class="hljs-selector-tag"><span class="hljs-selector-tag">replicated</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">replicated_ssd</span></span></code> </pre><br>  And the default data pool is located on the HDD: <br><br><pre> <code class="hljs kotlin">ceph osd pool <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.rgw.buckets.<span class="hljs-keyword"><span class="hljs-keyword">data</span></span> crush_rule replicated_hdd</code> </pre><br>  Naturally, you can do the opposite and arrange the default on the SSD. <br><br><h2>  Configure Rados Gateway </h2><br>  The most interesting part for which the article was written. <br><br>  When you install a new cluster goes without default Realm.  It is not very clear why this is done.  Create a Realm "default" and set it as default: <br><br><pre> <code class="hljs pgsql">radosgw-<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span> realm <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-comment"><span class="hljs-comment">--rgw-realm=default --default</span></span></code> </pre><br>  Add additional placement for SSD buckets to zonegroup default: <br><br><pre> <code class="hljs objectivec">radosgw-admin zonegroup placement add --rgw-zonegroup=<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> --placement-<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"ssd-placement"</span></span></code> </pre> <br>  And add additional placement to the default zone: <br><br><pre> <code class="hljs objectivec">radosgw-admin zone placement add --rgw-zone=<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> --placement-<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-string"><span class="hljs-string">"ssd-placement"</span></span> --data-pool=<span class="hljs-string"><span class="hljs-string">"default.rgw.buckets.data.ssd"</span></span> --index-pool=<span class="hljs-string"><span class="hljs-string">"default.rgw.buckets.index"</span></span></code> </pre> <br>  We have to store the index of all objects (both HDD and SSD) using one pool ‚Äúdefault.rgw.buckets.index‚Äù, but we can create a separate pool for the index. <br><br>  Tie the zonegroup "default" to the realm "default" and commit the changes: <br><br><pre> <code class="hljs objectivec">radosgw-admin zonegroup modify --rgw-zonegroup=<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> --rgw-realm=<span class="hljs-keyword"><span class="hljs-keyword">default</span></span> radosgw-admin period update --commit</code> </pre><br>  The last step is to restart Rados Gateway. <br><br>  Now we can create a new batch on the SSD (note the colon, it did not work without it): <br><pre> <code class="bash hljs">s3cmd mb s3://<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> --bucket-location=:ssd-placement</code> </pre> <br><br>  Or create a bucket with default placement (in our case on the HDD): <br><pre> <code class="bash hljs">s3cmd mb s3://<span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br><br>  I hope my little note will save someone time in solving a similar problem. </div><p>Source: <a href="https://habr.com/ru/post/351894/">https://habr.com/ru/post/351894/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351882/index.html">Vue.js and how to understand it</a></li>
<li><a href="../351884/index.html">This is not ‚Äúa real job, but a better job‚Äù: as a hiring policy, Crossover allows you to pay employees above the market</a></li>
<li><a href="../351886/index.html">Controller for Lego</a></li>
<li><a href="../351888/index.html">Espresso: ‚ÄúCute little animals or dangerous predators?‚Äù</a></li>
<li><a href="../351890/index.html">REST API Best Practices</a></li>
<li><a href="../351896/index.html">Issue # 15: IT training - current issues and challenges from leading companies</a></li>
<li><a href="../351898/index.html">Hackathon and game jam in Yekaterinburg</a></li>
<li><a href="../351900/index.html">Flask Mega-Tutorial, Part XVI: Full-Text Search</a></li>
<li><a href="../351904/index.html">Simple authentication on NGINX using LUA</a></li>
<li><a href="../351906/index.html">JavaScript compiler using ANTLR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>