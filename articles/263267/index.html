<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fault tolerance in MS SQL 2012 for 1C: Enterprise 8.2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many are currently using resiliency technologies in building information systems and this topic is not new. At the same time, ensuring only fault tole...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fault tolerance in MS SQL 2012 for 1C: Enterprise 8.2</h1><div class="post__text post__text-html js-mediator-article">  Many are currently using resiliency technologies in building information systems and this topic is not new.  At the same time, ensuring only fault tolerance is no longer considered the only and sufficient requirement.  The ideal system, in my opinion, should be <br><ul><li>  Fault tolerant (ensuring continuous operation of the system in case of failure of its component parts) </li><li>  With load balancing and high utilization of resources (with the current operation, even load distribution and use of all resources, including those reserved for failure), if possible </li><li>  Easy to expand (scalable) </li></ul><br>  For those who have no desire to master a lot of letters and pictures, I suggest moving to the end of the article to conclusions, along the way you can still look into the experiment. <br><a name="habracut"></a><br><h4>  Fault tolerance in MS SQL </h4><br>  First, let's take a quick look at existing Microsoft high availability database technologies.  One solution for fault tolerance is to use a Windows Server Failover Cluster (WSFC).  Consider it by example: <br><br><img src="https://habrastorage.org/files/008/99d/f03/00899df0319f4a32b109ddb924302614.jpg"><br><br>  The WSFC uses shared network storage (SAN).  When installing SQL in a failover cluster, system and user databases are placed on shared storage.  In the diagram, two nodes (SQLCLU01NODE01 and SQLCLU01NODE02) are combined into a failover cluster SQLCLUSTER01A.  In this case, SQL is set to a named instance (instance), i.e.  The clustered SQL server connection address is as follows SQLCLUSTER01A \ SQL.  During normal operation, one of the cluster nodes (server) is active (in the example, SQLCLU01NODE01), and the second is in hot standby.  When the active server SQLCLU01NODE01 fails, the cluster service switches (transparent to users) to the backup node SQLCLU01NODE01. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The obvious advantages of WSFC follow from the above: high reliability by full server redundancy, no downtime in case of server failure, as well as disadvantages: no protection of disk array failure, high solution cost (idle standby server, similar to the working one). <br><br>  The solution has been around for a long time (in my opinion, starting with Windows Server 2000 and SQL Server 2000) and should not cause any difficulties when deploying. <br><br>  With the release of SQL2005SP1, the possibility of database mirroring has appeared.  The basic principle of mirroring is to create a hot backup copy of a database on another server (storage). <br><br><img src="https://habrastorage.org/files/7f8/05a/565/7f805a56571c4eccb7235da244b48fa8.jpg"><br><br>  On the primary server (Primary) is a database (principal database), which users normally work with. <br>  On the backup server (Mirror) is a mirror copy of the database (mirror database). <br><br>  When protected synchronous mode of mirroring, a witness server (Witness) can be added to the schema, the task of which is to monitor the mirroring and in the event of a failure of the main server or database, automatically bring the mirrored database to the operational state. <br><br>  The advantages of mirroring are: ensuring the fault tolerance of disk arrays, the ability to use the resources of a backup server, the ability to create a geographically distributed cluster.  Disadvantages: the high cost of the solution (requires a backup server with a disk subsystem, as well as a tracking server). <br><br>  It should be noted that the connection to the mirror database by the client application will not work due to the fact that this database is always in recovery mode.  In this case, you can use a snapshot (snapshot) of the mirror base.  You can read about this and other Microsoft technologies, for example, <a href="http://sql.xp-7.ru/archives/tag/sql-server-2005">here.</a> <br><br><h4>  New features in MS SQL 2012 </h4><br>  In addition to all of the above, SQL 2012 introduced a new functionality - AlwaysOn Accessibility Groups.  What Microsoft writes to us: <br><blockquote>  If you‚Äôre not a problem, you‚Äôll be able to manage your project. </blockquote><br>  Interesting ... Ie  We are provided with a new high-level enterprise availability technology and it most likely should be cooler than what is already there. <br><br>  Let's try to understand the features.  At first glance, the AlwaysOn availability group is the development of mirroring.  There are many instructions on the network for deploying and configuring AlwaysOn, so I‚Äôll only talk about the essence.  To deploy AlwaysOn, you need a WSFC failover cluster.  To enable AlwaysOn support, you must install MS SQL on the failover cluster instance and enable AlwaysOn high availability in the SQL service properties (SQL Server Configuration Manager snap-in).  Naturally, this must be done on all servers that we plan to use for AlwaysOn. <br><br>  The following figure shows a WSFC cluster with nodes Node01-Node05.  An instance of SQL server with AlwaysOn support is installed on each node.  As part of the SQL servers, the MyAg availability group has been created with the maximum possible number of replicas (the working base is Primary Replica and the 4th copies are Secondary Replica). <br><br><img src="https://habrastorage.org/files/2e4/8bf/7f5/2e48bf7f5f8941d38b937273bf30eb09.jpg"><br><br>  An accessibility group is a collection of availability replicas, their modes of operation, a collection of databases, and a group listener.  The figure below shows the MS SQL Management Studio utility with an availability group. <br><br><img src="https://habrastorage.org/files/85a/22c/0ec/85a22c0ec8de43768ce7f2ed34563094.jpg"><br><br>  Here we see a connection to the SQL server instance named ARSHAD-PC.  On this server, an AlwaysOnDemo-AG availability group has been created, to which two replicas have been added (servers on which replicas are located) ARSHAD-PC and ARSHAD-LP.  And, at the moment, the main replica of the availability group is located on the ARSHAD-PC server and this group is managed from the same server.  The accessibility group also includes two databases, AdventureWorks and AdventureWorksDW.  This availability group has a listener named AlwaysOnDemo-L.  In essence, this is the fault-tolerant address of the connection to the virtual server of the availability group. <br><br>  Accessibility groups can be created an unlimited number, and there can be many databases in one group.  Creating a group is accompanied by a simple and clear wizard and should not cause any special problems.  It is worth paying attention to two features. <br>  When adding the base of the current server to the availability group, you must first make an archive of this base (the recovery model must be Full).  Creating a listener when creating an availability group will require domain administrator authority. <br>  And when adding databases to an existing availability group, the authority of the SQL server administrator will suffice. <br><br>  It is also necessary to mention that the rest of the ‚Äúbinding‚Äù (users, maintenance plans, agent tasks, etc.) that are not in the accessibility group remains local to the server.  About synchronization between servers and the coordination among themselves of this "binding" should be taken care of independently. <br><br>  The advantages and disadvantages of AlwaysOn are basically the same as mirroring, but there are also features.  As I understand it, the main differences between AlwaysOn and mirroring are the ability to create read-only replicas, the ability to create more than one copy, easy setup, greater flexibility, and the lack of a Whitness server (instead of a listener in the accessibility group). <br><br>  Due to some experience with 1C, there was a desire to test the work of AlwaysOn together with 1C: Enterprise.  Moreover, when building a WSFC for 1C, there should not be any problems or features.  In fact, AlwaysOn should provide fault tolerance higher than WSFC (if you use different storages), while it will be possible to unload the main database from report users (ReadOnly replica) and we will be able to distribute the load across the servers by creating several working groups. <br><br><h4>  Work 1C: Enterprise and MS SQL 2012 </h4><br>  The 1C: Enterprise platform, starting from version 8.2.17, officially supports working with MSSQL 2012 (before that, it was necessary to transfer the sp_dboption stored procedure from SQL2008). <br><br>  In connection with the emergence of AlwaysOn in SQL, the ODBC connection string syntax was added, the following parameters appeared: ApplicationIntent - allows you to determine the type of workload (ReadOnly / ReadWrite), MultiSubnetFailover - accelerated detection of the active server, etc. These new features do not support 1C.  There is a way out - to specify the address of a listener when connecting to the working database, and to the database in read mode, connect directly to the ReadOnly server replica (see the experiment for more details). <br><br>  Work with the base to read.  As you know, when working with 1C, even if the user is not going to change anything in the database, there are algorithms that try to call insert and update in the database.  The easiest way is to rewrite the 1C configuration in which to remove (comment out) parts of the code that lead to changes.  If this is not done, the user will not be able to work with the ReadOnly database - 1C will fall off with an error that it is impossible to change the database.  Below are examples for typical configurations. <br><ul><li>  Routine tasks, obviously for the ReadOnly database, they need to be disabled </li><li>  Processing the ‚ÄúFunction Panel‚Äù, when opening, always tries to set the value of the Open option when starting the Function Panel of the Register of Users Settings to True.  Workarounds - disable the "Open the When Starting the Function Panel" setting for users, comment out the code or add a special role ReadOnly, and execute the code if the role is different </li><li>  Processing the ‚ÄúFunction Panel‚Äù, when closing, records the value of the ‚ÄúCurrentPagePanelsFunction‚Äù parameter in the information register of the ‚ÄúUsers Settings‚Äù information.  Bypass paths - disable the ‚ÄúOpen the When Starting the Function Panel‚Äù setting for the user, add the ReadOnly special role, and execute the code if the role is different </li><li>  Online user support (general form "Internet Customer Support Online Access Error").  When starting the 1C configuration, it offers to connect to the 1C server and, if there is a connection, installs the setting in the general settings storage.  Workarounds - reset auto-connect settings for Internet support by creating external processing with the following button code: </li><li>  When a report is closed (for example, a reverse balance sheet), the report settings are recorded in the ‚ÄúSaved Settings‚Äù directory.  Workarounds: add the ReadOnly special role and, in the SaveSetup procedure, configure the general module StandardReports, insert the check of saving settings, if the role is different </li></ul><br><h4>  Experiment </h4><br>  So, the experiment itself.  Earlier, we agreed that we will explore AlwaysOn SQL 2012 in relation to 1C.  To begin, I will describe the server configuration. <br><br>  We have 4 servers: one application server 1C and three SQL servers in a cluster. <br><br><img src="https://habrastorage.org/files/290/113/7e6/2901137e6b0643e6a8e5f55221294d70.jpg"><br><br>  The experiment will be carried out in two stages.  At the first stage, we will test the possibility of operating the 1C information database using AlwaysOn SQL 2012 and check the failover.  In the second stage, we examine the work of the ReadOnly replica.  For simplicity, we restrict ourselves to two databases. <br><br>  As the 1C information base, we take the typical configuration ‚Äú1C: Enterprise Accounting‚Äù.  Let's do the preparatory work and configure the servers, availability groups and databases.  So, we create the Dbtest2 database on the ServerSQL2 server, then on the same server we create the availability group AG_test2, where we place the same database: <br><br><img src="https://habrastorage.org/files/d0b/925/61c/d0b92561c07845aaa336446909ebb1a8.jpg"><br><br>  We do the same with the Dbtest1 database on ServerSQL1.  Now on the application server ‚ÄúServer1C‚Äù we register two information bases: <br><br><img src="https://habrastorage.org/files/f9c/ec3/308/f9cec33088e1438c96e305203779748f.jpg"><br><br><img src="https://habrastorage.org/files/208/656/e9a/208656e9a13640bcbeaf745f73fa38d1.jpg"><br><br>  Well, let's proceed to the experiment itself, connecting from a client computer using 1C: Peredpriyatiya to both information databases.  Let's run in both 1C: Enterprise sessions the formation of any long-running report, and without waiting for the completion of its formation, we will simulate a server failure in the availability group AGtest2: <br><br><img src="https://habrastorage.org/files/cd1/096/094/cd109609477d47bf90a8864a2c02add6.jpg"><br><br>  And then we get an error in the information database, which is located in the accessibility group, where the failure was modeled: <br><br><img src="https://habrastorage.org/files/446/807/00e/44680700e74b4a8a974ddcc41cc0bace.jpg"><br><br>  Connection to another information base (for obvious reasons) remains working.  We restart on the client the 1C application of the ‚Äúemergency‚Äù information database, the program works correctly.  At the same time, we can observe in SQL Management Studio that now the main replica in this availability group is ServerSQL1.√Æ <br><br>  Probably, if we do not read, but change something, for example, to conduct a document, then the result of the change will most likely be rolled back in the transaction by mistake.  Those.  fault tolerance does not apply to running requests. <br><br>  Now let's try working with the ReadOnly database.  In order to connect from 1C to such a database, you need to do two things: modify the 1C configuration so that it does not write to the database during operation, and set up the connection of the information base. <br><br>  Examples of refinement configuration 1C above.  As for connecting to the SQL database, then everything is much easier.  Since  1C: Enterprise platform does not support the new syntax of the connection string to MSSQL 2012, we will write the connection to the database in ReadOnly mode directly: <br><br><img src="https://habrastorage.org/files/b1a/582/0a0/b1a5820a0ad246a2bd29e13db3485952.jpg"><br><br>  You must also specify the ability to connect to the ReadOnly replica for all clients.  To do this, open the properties of the availability group in SQL Management Studio and change the ‚ÄúSecondary replica for reading‚Äù property from ‚ÄúRead only‚Äù to ‚ÄúYes‚Äù for the replica: <br><br><img src="https://habrastorage.org/files/402/3e3/474/4023e3474a544296bb30861f1ded2571.jpg"><br><br>  After that, we connect from the client computer with the 1C: Enterprise application to the ReadOnly information base.  Connection occurs without problems, reports are generated.  But when you try to change something, SQL returns an error about the impossibility of changes and the 1C session closes. <br><br>  Additionally, I note that in large databases it is absolutely possible to allocate a significant category of users for working with reports (this is the case).  By allocating individual servers for them (1C and SQL), you can distribute the load across hardware resources.  It works. <br><br>  Update information in the database ReadOnly occurs "almost instantly."  Only a significant change in the data in the main replica may result in a delay in updating the database for reading. <br><br>  A curious effect was also noticed.  In the main database we change the structure (for example, add a new directory), having previously kicked out users.  At the same time, we do not expel users from the database for reading, report users continue to work quietly.  At the same time, the main base changes the structure, full-fledged users start working in it, they fill in the new reference book.  Changing the base structure and filling the base with new information is overloaded into a replica for reading.  At the same time, users of reports (replicas for reading) will not see changes in the structure in the current session, i.e.  The new directory (as the 1C client read the old metadata).  But they will always have updated information from "known" objects.  As soon as the users of the reports restart 1C (re-read the metadata), they will see a change in the structure (in our example, a new reference). <br><br>  It is clear that this behavior has a negative point - it is the control of the integrity of receiving information (for example, the user can generate a report on an outdated algorithm). <br><br><h4>  findings </h4><br>  Unfortunately, there is fault tolerance in the Microsoft DBMS, but there is still no balancing.  It‚Äôs also disappointing to work with a failure in AlwaysOn: the active connections to the base fall off.  The expectations, based on the general description of technology on Microsoft resources and on presentations at various conferences, were somewhat different.  But looking at the resources of Microsoft, I found <a href="http://technet.microsoft.com/ru-ru/library/hh213417.aspx">this</a> . <br><br>  All honestly said, but in the general descriptions of this important feature is not, and it becomes obvious only after the experiment. <br>  But at the same time, I was pleased with the flexibility and ease of setting up and managing AlwaysOn. <br><br>  I was also pleased with the ‚Äútransparent‚Äù for 1C work of the ReadOnly replica, although it is necessary to ‚Äúfinish‚Äù the 1C configuration a little. <br>  Well, it should be said that the current implementation of AlwaysOn failover can easily be used if the business is not critical to lose pending transactions and disconnect active sessions at the moment of switching. <br><br><h4>  useful links </h4><br><ul><li>  <a href="http://msdn.microsoft.com/en-us/library/ff929171.aspx">http://msdn.microsoft.com/en-us/library/ff929171.aspx</a> </li><li>  <a href="http://support.microsoft.com/default.aspx%3Fscid%3Dkb%3BEN-US%3B822400">http://support.microsoft.com/default.aspx?scid=kb;EN-US;822400</a> </li><li>  <a href="http://softpoint.ru/products_id15.htm">http://softpoint.ru/products_id15.htm</a> </li><li>  <a href="http://andriy.co/Zerkalirovanie_bazy_dannyh_na_MSSQL_Server_2005_2008.aspx">http://andriy.co/Zerkalirovanie_bazy_dannyh_na_MSSQL_Server_2005_2008.aspx</a> </li><li>  <a href="http://www.brentozar.com/archive/2010/11/sql-server-denali-database-mirroring-rocks/">http://www.brentozar.com/archive/2010/11/sql-server-denali-database-mirroring-rocks/</a> </li></ul><br>  PS: An article from the report, which is 2.5 years old, but it seemed to me that it is relevant even now (despite the release of SQL2014 and 1C 8.3). <br>  PPS: And yet - do not forget to do BackUps, AlwaysOn does not replace them. </div><p>Source: <a href="https://habr.com/ru/post/263267/">https://habr.com/ru/post/263267/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../263257/index.html">New tab engine for cloud IDE</a></li>
<li><a href="../263259/index.html">AI for "Fool"</a></li>
<li><a href="../263261/index.html">The digest of interesting materials from the world of Drupal # 11</a></li>
<li><a href="../263263/index.html">Applications in the electronic document management system. Part 2: Application Components - Document. Logical structure</a></li>
<li><a href="../263265/index.html">Human processor model</a></li>
<li><a href="../263269/index.html">Automation of updating OpenVZ templates on Proxmox</a></li>
<li><a href="../263271/index.html">Comparison of voice assistants for the declared functions and characteristics (Lexi, Ubi, Ivee, Amazon Echo, Jibo, Cubic)</a></li>
<li><a href="../263273/index.html">SHARED.menu - search virtual hosting</a></li>
<li><a href="../263275/index.html">A holy place is never empty - Mirantis Unlocked Appliance</a></li>
<li><a href="../263277/index.html">Getting root access to ONT Sercomm RV6688 using contact closure</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>