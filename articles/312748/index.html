<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We prepare multithreading with core.async</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The pattern of using channels to create is becoming increasingly popular. 
 multi-threaded applications. The idea is not new, its design was laid back...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We prepare multithreading with core.async</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/70f/086/a65/70f086a655ac44999ec031b3ec2d15c5.png" alt="image"><br><p><br>  The pattern of using channels to create is becoming increasingly popular. <br>  multi-threaded applications.  The idea is not new, its design was laid back in 1978 <br>  in the form of <a href="https://en.wikipedia.org/wiki/Communicating_sequential_processes">CSP</a> . The most well-known implementation is now widely used in Golang. </p><br><p>  We in article will consider implementation of CSP in core.async for Clojure, if interesting, welcome under kat. </p><br><a name="habracut"></a><br><p>  The article will discuss the simple and basic practices for working with core.async, described in the article will be sufficient for a good start in multi-threaded programming. </p><br><p>  Unlike Golang, where the paradigm of working with streams through channels is built into the language itself, core.async is just a library for Clojure, if you are impressed by another paradigm, then there is a choice: <a href="http://docs.paralleluniverse.co/pulsar/">pulsar</a> , <a href="https://github.com/funcool/promesa">promesa</a> , <a href="https://github.com/ztellman/manifold">manifold</a> </p><br><p>  At the same time, core.async and promesa can also be used on the browser side in ClojureScript, naturally in this case there is no need to talk about multi-threading, since all this stuff is compiled in ES5 and executed in the browser, but the familiar interface and convenient work with asynchrony can serve well. </p><br><p>  So what does core.async give us?  If we explain on the fingers, then core.async provides us with scheduling via go-blocks in its fixed Thread Pool consisting of 8 threads (the size of the Thread Pool can be changed via a special option).  When a message arrives on the channel, core.async will find the free flow itself, and pass the task to it, or put the message in a queue.  Who first hears about the Thread Pool, you can read a good note on the pattern <a href="http://ooad.asf.ru/Pattern.aspx%3FIdKat%3D7%26IdPat%3D60">Worker Thread</a> </p><br><hr><br><h2 id="primer--1">  Example number 1 </h2><br><pre><code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">defonce</span></span> log-chan (<span class="hljs-name"><span class="hljs-name">chan</span></span>)) (<span class="hljs-name"><span class="hljs-name">defn</span></span> loop-worker [msg] (<span class="hljs-name"><span class="hljs-name">println</span></span> msg)) (<span class="hljs-name"><span class="hljs-name">go-loop</span></span> [] (<span class="hljs-name"><span class="hljs-name">let</span></span> [msg (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> log-chan)] (<span class="hljs-name"><span class="hljs-name">loop-worker</span></span> msg) (<span class="hljs-name"><span class="hljs-name">recur</span></span>)))</code> </pre> <br><p>  In the example above, we created a <code>log-chan</code> channel, and defined a loop-worker function that will process messages from the channel. Then we created an infinite loop go-block, putting our <code>loop-worker</code> Now we can send data to the channel: <code>(&gt;!! log-chan "")</code> </p><br><p>  The loop-worker function was rendered separately for the go-block intentionally, for the sake of convenient debugging through the REPL. </p><br><p>  The body itself is go-loop since this macro is baked somewhere inside core.async, and recompiling it on-the-fly to the REPL is of a strange character, so the handler is easier to separate and live peacefully. </p><br><p>  It is worth noting that the go-loop does not make any infinite loop in its usual sense. <br>  After receiving the message, a one-time execution of the handler function occurs, and then the go-block is parked by the <code>&lt;!</code>  which will be waiting for a new message.  Thus, you can create as many channels and processors to them as you like. </p><br><p>  Within the go-block, the function of reading from the channel <code>&lt;!</code>  provides parking flow. <br>  Outside of the go block there is an opportunity to use the function <code>&lt;!!</code>  which blocks the main thread until a message is received.  Behavior <code>&lt;!!</code>  can be compared with the await function in ES7. </p><br><p>  Parking go block, this is the term core.async meaning that the thread is released, and is available for other tasks.  There is also the term blocking, which means that the thread will be directly blocked and unavailable for new tasks until it is released. </p><br><p>  In example 1, there is a flaw, if <code>Exception</code> is called in a loop-worker, the form will be interrupted, and <code>(recur)</code> will never be called, therefore waiting for data from the <code>log-chan</code> channel will stop, we will fix this in Example No. 2. </p><br><h2 id="primer--2">  Example number 2 </h2><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">defonce</span></span> log-chan (<span class="hljs-name"><span class="hljs-name">chan</span></span>)) (<span class="hljs-name"><span class="hljs-name">defn</span></span> loop-worker [msg] (<span class="hljs-name"><span class="hljs-name">throw</span></span> (<span class="hljs-name"><span class="hljs-name">Exception</span></span>. <span class="hljs-string"><span class="hljs-string">"my exception message"</span></span>))) (<span class="hljs-name"><span class="hljs-name">go-loop</span></span> [] (<span class="hljs-name"><span class="hljs-name">let</span></span> [msg (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> log-chan) res (<span class="hljs-name"><span class="hljs-name">try</span></span> (<span class="hljs-name"><span class="hljs-name">loop-worker</span></span> msg) <span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span> (<span class="hljs-name"><span class="hljs-name">catch</span></span> Exception e (<span class="hljs-name"><span class="hljs-name">println</span></span> (.getMessage e)) <span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>))] (<span class="hljs-name"><span class="hljs-name">recur</span></span>)))</code> </pre><br><p>  In this example, we wrapped the entire loop-worker call into a <code>try</code> form, and the variable <code>res</code> would contain a flag indicating that the form was successful or an error occurred.  This flag can be useful, for example, if we want to close the channel in case of an error.  A working example of this approach can be found <a href="">here.</a> </p><br><h2 id="primer--3">  Example number 3 </h2><br><pre> <code class="hljs lisp"> (<span class="hljs-name"><span class="hljs-name">let</span></span> [c1 (<span class="hljs-name"><span class="hljs-name">go</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> (<span class="hljs-name"><span class="hljs-name">timeout</span></span> (<span class="hljs-name"><span class="hljs-name">rand-int</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>))) <span class="hljs-number"><span class="hljs-number">5</span></span>) c2 (<span class="hljs-name"><span class="hljs-name">go</span></span> (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> (<span class="hljs-name"><span class="hljs-name">timeout</span></span> (<span class="hljs-name"><span class="hljs-name">rand-int</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>))) <span class="hljs-number"><span class="hljs-number">7</span></span>)] (<span class="hljs-name"><span class="hljs-name">go</span></span> (<span class="hljs-name"><span class="hljs-name">let</span></span> [v1 (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> c1) v2 (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> c2)] (<span class="hljs-name"><span class="hljs-name">println</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:v1</span></span> v1 <span class="hljs-symbol"><span class="hljs-symbol">:v2</span></span> v2 <span class="hljs-symbol"><span class="hljs-symbol">:summ</span></span> (<span class="hljs-name"><span class="hljs-name">+</span></span> v1 v2)}))))</code> </pre> <br><p>  This example will wait for the result of all the asynchronous operations listed in the <code>let</code> block.  This practice is very convenient for solving the problem of callback hell in JavaScript, and another reason to rejoice that it can be used on the browser side in the face of ClojureScript. </p><br><h2 id="primer--4">  Example number 4 </h2><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">defn</span></span> upload <span class="hljs-string"><span class="hljs-string">"upload emulator"</span></span> [headshot c time] (<span class="hljs-name"><span class="hljs-name">go</span></span> (<span class="hljs-name"><span class="hljs-name">Thread/sleep</span></span> time) (<span class="hljs-name"><span class="hljs-name">&gt;!</span></span> c headshot))) (<span class="hljs-name"><span class="hljs-name">let</span></span> [c1 (<span class="hljs-name"><span class="hljs-name">chan</span></span>) c2 (<span class="hljs-name"><span class="hljs-name">chan</span></span>)] (<span class="hljs-name"><span class="hljs-name">upload</span></span> <span class="hljs-string"><span class="hljs-string">"pic1.jpg"</span></span> c1 <span class="hljs-number"><span class="hljs-number">30</span></span>) (<span class="hljs-name"><span class="hljs-name">upload</span></span> <span class="hljs-string"><span class="hljs-string">"pic2.jpg"</span></span> c2 <span class="hljs-number"><span class="hljs-number">40</span></span>) (<span class="hljs-name"><span class="hljs-name">let</span></span> [[headshot channel] (<span class="hljs-name"><span class="hljs-name">alts!!</span></span> [c1 c2 (<span class="hljs-name"><span class="hljs-name">timeout</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>)])] (<span class="hljs-name"><span class="hljs-name">if</span></span> headshot (<span class="hljs-name"><span class="hljs-name">println</span></span> <span class="hljs-string"><span class="hljs-string">"Sending headshot notification for"</span></span> headshot) (<span class="hljs-name"><span class="hljs-name">println</span></span> <span class="hljs-string"><span class="hljs-string">"Timed out!"</span></span>))))</code> </pre><br><p>  In this example, we created a upload function that emulates an asynchronous operation, in this case, a file upload.  The final argument to upload, takes the delay time in milliseconds.  Using the function alts !!!  we can get the first result that will be returned to us by one of the channels listed in the vector.  In our vector, the last channel goes <code>(timeout 20)</code> , this channel will return the result in 20 milliseconds, and this will be the first value that will be written to the variable <code>headshot</code> and the form will continue.  Thus, this example emulates the installation of time on timeout, during which we will wait for the execution of a set of asynchronous operations. </p><br><h2 id="primer--5">  Example number 5 </h2><br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">def</span></span> ping (<span class="hljs-name"><span class="hljs-name">chan</span></span>)) (<span class="hljs-name"><span class="hljs-name">def</span></span> pong (<span class="hljs-name"><span class="hljs-name">chan</span></span>)) (<span class="hljs-name"><span class="hljs-name">go-loop</span></span> [] (<span class="hljs-name"><span class="hljs-name">let</span></span> [msg (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> ping)] (<span class="hljs-name"><span class="hljs-name">when</span></span> (<span class="hljs-name"><span class="hljs-name">=</span></span> msg <span class="hljs-symbol"><span class="hljs-symbol">:ping</span></span>) (<span class="hljs-name"><span class="hljs-name">println</span></span> msg) (<span class="hljs-name"><span class="hljs-name">&gt;!</span></span> pong <span class="hljs-symbol"><span class="hljs-symbol">:pong</span></span>) (<span class="hljs-name"><span class="hljs-name">Thread/sleep</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>)) (<span class="hljs-name"><span class="hljs-name">recur</span></span>))) (<span class="hljs-name"><span class="hljs-name">go-loop</span></span> [] (<span class="hljs-name"><span class="hljs-name">let</span></span> [msg (<span class="hljs-name"><span class="hljs-name">&lt;!</span></span> pong)] (<span class="hljs-name"><span class="hljs-name">when</span></span> (<span class="hljs-name"><span class="hljs-name">=</span></span> msg <span class="hljs-symbol"><span class="hljs-symbol">:pong</span></span>) (<span class="hljs-name"><span class="hljs-name">println</span></span> msg) (<span class="hljs-name"><span class="hljs-name">&gt;!</span></span> ping <span class="hljs-symbol"><span class="hljs-symbol">:ping</span></span>) (<span class="hljs-name"><span class="hljs-name">Thread/sleep</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span>)) (<span class="hljs-name"><span class="hljs-name">recur</span></span>))) (<span class="hljs-name"><span class="hljs-name">&gt;!!</span></span> ping <span class="hljs-symbol"><span class="hljs-symbol">:ping</span></span>)</code> </pre> <br><p>  An example of communication between two channels, the classic Ping-Pong. </p><br><p>  This was the last example I wanted to show.  Separately, it is also worth highlighting the presence of data types in clojure, created specifically for recording information into several streams, this <a href="http://clojure.org/reference/atoms">atom</a> and <a href="http://clojure.org/reference/agents">agent,</a> as well as the overall immunity of other types, all this greatly simplifies the developer‚Äôs life when developing a multi-threaded application. </p><br><hr><br><p>  Useful links: </p><br><blockquote>  "Http://clojure.com/blog/2013/06/28/clojure-core-async-channels.html <br>  ¬ªHttps://github.com/clojure/core.async <br>  ¬ªHttps://github.com/clojure/core.async/wiki/Getting-Started <br>  "Http://www.braveclojure.com/core-async/ <br>  ¬ªHttp://go.cognitect.com/core_async_webinar_recording </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/312748/">https://habr.com/ru/post/312748/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312736/index.html">Taking care of efficiency is a matter of lazy people. How to work, earn and benefit the company</a></li>
<li><a href="../312738/index.html">How many heap spaces do 100 million lines occupy in java?</a></li>
<li><a href="../312740/index.html">The logic of consciousness. Part 8. Spatial maps of the cerebral cortex</a></li>
<li><a href="../312744/index.html">How I became a designer in six months</a></li>
<li><a href="../312746/index.html">RailsClub 2016: Interview with Steve Klabnik</a></li>
<li><a href="../312750/index.html">Donald Knut and Surreal Numbers: I worked for six days and rested on the seventh (40,41,42 / 97)</a></li>
<li><a href="../312752/index.html">Top reports Black Hat USA 2016</a></li>
<li><a href="../312756/index.html">Kremlin girls</a></li>
<li><a href="../312760/index.html">How the company abandoned WordPress and replaced it with a self-made CMS</a></li>
<li><a href="../312762/index.html">Everything collapses</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>