<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ensuring automation of domain ownership verification based on ACME DNS records [translation]</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator : This is a translation of an article from EFF 
 A Technical Deep Dive: Securing the ACME DNS Challenge Validation . 
 The author ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ensuring automation of domain ownership verification based on ACME DNS records [translation]</h1><div class="post__text post__text-html js-mediator-article">  <i><b>From the translator</b> : This is a translation of an article from <b>EFF</b></i> <i><br></i>  <i><a href="https://www.eff.org/deeplinks/2018/02/technical-deep-dive-securing-automation-acme-dns-challenge-validation">A Technical Deep Dive: Securing the ACME DNS Challenge Validation</a> .</i> <i><br></i>  <i>The author of the original article: Joona Hoikkala.</i> <i><br></i>  <i>Date of an original publication: February 23, 2018</i> <br><br>  Earlier this month, <a href="https://www.letsencrypt.org/">Let's Encrypt</a> (a free, automated, open certificate authority that EFF helped launch two years ago) broke an important milestone: <a href="https://www.eff.org/deeplinks/2018/02/lets-encrypt-hits-50-million-active-certificates-and-counting">issuing more than 50 million active certificates</a> .  And this number will continue to grow, because in a few weeks Let's Encrypt will also start issuing wildcard certificates that many system administrators have requested. <br><a name="habracut"></a><br><h2>  What is a wildcard certificate? </h2><br>  To verify the HTTPS certificate, the user's browser checks whether the domain name of the web site is specified in the certificate.  For example, a certificate from <a href="http://www.eff.org/">www.eff.org</a> should actually include <a href="http://www.eff.org/">www.eff.org</a> as a valid domain for this certificate.  Certificates can also contain multiple domains (for example, <a href="http://www.eff.org/">www.eff.org</a> , ssd.eff.org, sec.eff.org, etc.) if the owner simply wants to use one certificate for all of their domains. <br><br>  A wildcard certificate is a certificate that says: ‚ÄúI am valid for all subdomains in this domain,‚Äù rather than listing them explicitly.  (In the certificate, this is indicated by a wildcard character indicated by an asterisk. Therefore, if you now check the certificate for eff.org, it will say that it is valid for * .eff.org.) Thus, the system administrator can obtain a certificate for all his domain and use it in new subdomains, which he did not even think about when he received the certificate. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To issue wildcard certificates, Let's Encrypt will require users to confirm their domain control using a <a href="https://en.wikipedia.org/wiki/Domain_Name_System">DNS-</a> based challenge (challenge) check, which translates domain names, such as <a href="http://www.eff.org/">www.eff.org</a> , into IP addresses, such as 69.50.232.54.  From a certification authority point of view, such as Let's Encrypt, there is no better way to prove that you are managing a domain than by changing its DNS records, since domain management is one of the foundations of DNS. <br><br>  However, one of the key ideas of Let's Encrypt is that obtaining a certificate should be an automatic process.  But to automate it, software requesting a certificate will also need to be able to change the DNS records for this domain.  In order to implement this feature, the software must also have access to the credentials for the DNS service (for example, a login and password or a cryptographic token), and these credentials should be stored where automated certification is obtained. <br><br>  In many cases, this means that if the machine processing process is compromised, the same happens with the DNS credentials, this is the real danger.  In the remainder of this post, we will go deep into the components involved in this process, and in what options do it make it safer. <br><br><h2>  How does domain ownership check work? </h2><br>  At a high level, a domain ownership check works like all other automatic checks that are part of the ACME protocol, a protocol that a certificate authority (CA) can use, such as Let's Encrypt, and client software, such as Certbot, to exchange information about which certificate the server is requesting, and how the server must confirm ownership of the corresponding domain name. <br><br>  During a domain ownership check, the user requests a certificate from the CA using ACME client software, such as Certbot, which supports this type of verification.  When a client requests a certificate, CA requests the client to verify domain ownership by adding a specific TXT record to its DNS zone.  In more detail: The CA sends a unique random token to the ACME client, and the person who has control of the domain must place this token as a TXT record in his DNS zone, in a predefined subdomain named "_acme-challenge" of the domain whose control is trying to prove the user. <br><br>  For example, if you are trying to check the domain for * .eff.org, the verification subdomain will be "_acme-challenge.eff.org".  When the value of the token is added to the DNS zone, the client informs the CA to continue to verify ownership, after which the CA will perform a DNS query to the authoritative servers for the domain.  If the authoritative DNS servers respond with a DNS record containing the correct ownership verification token, the domain ownership will be proved and the certificate issuance process can continue. <br><br><h2>  DNS service controls digital identity </h2><br>  The threats posed by the DNS zone make it so dangerous that DNS is something that users' browsers rely on to know which IP address they should contact when trying to reach your domain.  This applies to all services that use a resolvable name under your domain, from email to web services. <br><br>  When a DNS is compromised, an attacker can easily intercept all connections sent to your email or other protected service, terminate TLS encryption (since they can now verify domain ownership and get their valid certificates for them), decrypt the data and read them, and then re-encrypt the data and transfer it to your server.  For most people, this would be very difficult to detect. <br><br><h2>  Separate and limited privileges </h2><br>  Strictly speaking, in order for the ACME client to do updates in automatic mode, this client should have access only to the credentials that can update the TXT records for the "_acme-challenge" subdomains.  Unfortunately, most DNS software products and DNS service providers do not offer detailed access controls that limit these privileges, or simply do not provide an API to automate this beyond basic updates or DNS zone transactions.  This leaves possible automation methods unsuitable or unsafe. <br><br>  There is a simple way that can help maneuver past such restrictions: use a <a href="https://en.wikipedia.org/wiki/CNAME_record">CNAME record</a> .  CNAMEs essentially act as links to another DNS record.  Let's Encrypt follow the chain of CNAME records and allow the ownership check token for the last record in the chain. <br><br><h2>  Ways to mitigate the problem </h2><br>  Even using CNAME records, the main problem is that the ACME client will still need access to credentials that will allow it to change some DNS record.  There are various ways to mitigate this basic problem with different levels of complexity and security implications in the event of a compromise. <br><br>  In the following sections, this post presents some of these methods, trying to explain the possible consequences of having credentials compromised.  With one exception, they all use CNAME records. <br><br><h3>  Allow updates for TXT records only. </h3><br>  The first way is to create a set of credentials with privileges that allow you to update TXT records. <br><br>  If compromised, this method limits the attacker's ability to issue certificates for all the domains in the DNS zone (since they can use the DNS credentials to get their own certificates), as well as interrupting mail delivery.  The impact on mail delivery comes from mail-specific TXT records, namely <a href="https://en.wikipedia.org/wiki/Sender_Policy_Framework">SPF</a> , <a href="https://en.wikipedia.org/wiki/DomainKeys_Identified_Mail">DKIM</a> and its <a href="https://en.wikipedia.org/wiki/Author_Domain_Signing_Practices">ADSP</a> and <a href="https://en.wikipedia.org/wiki/DMARC">DMARC</a> extensions.  Their compromise will also facilitate the delivery of phishing emails that pretend to be the sender from the compromised domain. <br><br><h3>  Use the "throwaway" verification domain </h3><br>  The second way is to manually create CNAME records for the "_acme-challenge" subdomain and point them to the verification domain that will be in the zone controlled by another set of credentials. <br><br>  For example, if you want to get a certificate to cover "yourdomain.tld" and " <a href="http://www.yourdomain.tld/">www.yourdomain.tld</a> ", you will have to create two CNAME records - "_ acme-challenge.yourdomain.tld" and "_acme-challenge.www.yourdomain .tld "- and also point them to the external domain for verification.  The domain used to verify ownership must be in the outer DNS zone or in the sub-band DNS zone, which has its own set of management credentials.  (The DNS zone of the subdelegate is determined using NS records and in fact delegates full control over part of the zone to an external source.) <br><br>  The effect of compromise for this method is rather limited.  Since the actual stored credentials are intended for the external DNS zone, an attacker who received the credentials will only be able to issue certificates for all domains pointing to records in this zone.  However, figuring out which domains actually point there is trivial: an attacker simply needs to read the <a href="https://www.certificate-transparency.org/">transparency</a> logs of the <a href="https://www.certificate-transparency.org/">certificates</a> and check whether the domains in these certificates have a magic subdomain pointing to the vulnerable DNS zone. <br><br><h3>  Restricted access to the DNS zone </h3><br>  If your software or DNS provider allows you to create permissions associated with a subdomain (granular privileges), this can help you alleviate the entire problem. <br><br>  Unfortunately, at the time of publication, the only provider that found these privileges was found - <a href="https://docs.microsoft.com/en-us/azure/dns/dns-protect-zones-recordsets">Microsoft Azure DNS</a> .  Dyn presumably also has granular privileges, but we could not find a lower level of privileges in their service besides ‚ÄúUpdate Records‚Äù, which still leave the zone completely vulnerable. <br><br>  Route53 and possibly others allow their users to create a subdelegate zone, new user credentials, specify NS records in the new zone and specify _acme-challenge subdomains for checking them using CNAME records.  It takes a lot of work to correctly do the distribution of privileges using this method, since you need to go through all these steps for each domain for which you need to use a proprietary check. <br><br><h3>  Use ACME-DNS </h3><br>  <i>Disclaimer: the software described below is written by the author (the original article - approx. Translator), and it is used as an example of the functions needed to effectively manage the credentials needed to automate the verification of domain ownership via DNS in a secure way.</i> <br><br>  The latter method is a piece of software called ACME-DNS written to deal specifically with the problem under discussion, and it can completely eliminate it.  The only drawback is that this method adds another component to your infrastructure that needs to be supported, and also requires you to open the DNS port (53) for public access to the Internet. <br><br>  ACME-DNS acts as a simple DNS server with a limited HTTP API.  The API itself allows only to update TXT records of automatically generated random subdomains.  It has no methods for querying lost credentials, updating or adding other records.  It provides two end points: <br><br><ul><li>  / register - this endpoint creates a new subdomain to use, followed by a username and password.  As an optional parameter, the endpoint of the register accepts a list of CIDR ranges for ‚Äúwhite‚Äù updates. </li><li>  / update - this endpoint is used to update the current domain ownership check token on the server. </li></ul><br>  To use ACME-DNS, you first need to create A / AAAA records for it, and then specify NS records for it to create a delegation node.  After that, you simply create a new set of credentials through the / register end point and specify the CNAME record from the confirmation subfield of the "_acme-challenge" verification in the source zone to the newly created subdomain. <br><br>  The only credentials stored locally will be for ACME-DNS, and they are only good for updating accurate TXT records for verification subdomains for domains in the field.  This effectively limits the impact of a possible compromise for the attacker to the ability to issue certificates for these domains. <br><br>  For more information about ACME-DNS, see the page: <br>  <a href="https://github.com/joohoi/acme-dns/">github.com/joohoi/acme-dns</a> <br><br><h2>  Conclusion </h2><br>  To eliminate problems with checking domain ownership through ACME DNS, suggestions such as <a href="https://mailarchive.ietf.org/arch/msg/acme/6_j3fecaxIgwNTpJ3693U_n0Kec">assisted-DNS</a> in the ACME IETF working group were discussed, but at present these problems are still without resolution.  Since the only way to limit the impact of a compromise is to limit the access rights of the accounts of the DNS zones before changing certain TXT records, the current possibilities for reliable implementation of the automation of the domain ownership check are insignificant. <br><br>  The only sustainable option would be to force the DNS software and service providers to either implement methods for creating smaller-scale zone credentials, or provide a completely new type of credential for this particular use case. </div><p>Source: <a href="https://habr.com/ru/post/350202/">https://habr.com/ru/post/350202/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350188/index.html">ASP.NET Core: Attack Prevention Mechanisms 2.0</a></li>
<li><a href="../350192/index.html">Deep learning in the cloud: optical computers will replace the GPU</a></li>
<li><a href="../350194/index.html">Antivirus usability on the phone</a></li>
<li><a href="../350198/index.html">Basics of cryptography. Part 0</a></li>
<li><a href="../350200/index.html">Monitoring system organization</a></li>
<li><a href="../350204/index.html">March 15, QIWI will bring back-end developers to QIWI SERVER PARTY 2.0</a></li>
<li><a href="../350206/index.html">Development of a biometric speech identification system</a></li>
<li><a href="../350208/index.html">Programming Languages ‚Äã‚Äãfor a Quantum Computer</a></li>
<li><a href="../350210/index.html">Play with ormats</a></li>
<li><a href="../350212/index.html">Will robots inherit the earth?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>