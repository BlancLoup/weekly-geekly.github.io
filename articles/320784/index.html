<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Kamailio SIP proxy: an example of installation and minimum configuration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the work of the system administrator involved in the implementation of telephony systems based on Asterisk, sooner or later a situation may arise w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Kamailio SIP proxy: an example of installation and minimum configuration</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/969/ad8/72b/969ad872bcdf4c6cb22dc3568c1c2ae0.png"><br>  In the work of the system administrator involved in the implementation of telephony systems based on Asterisk, sooner or later a situation may arise when the hardware capabilities of one server to handle all calls are no longer enough.  Accordingly, it is necessary to divide the load into several servers.  One of the ways to solve this problem is to use SIP proxy, but it should be recognized that, unlike Asterisk, information on SIP proxy, forums, examples and descriptions is at least an order of magnitude less.  The purpose of this article is to show with a simple example the possibility of using Kamailio's SIP proxy in conjunction with Asterisk so as to make it as easy as possible to master the SIP proxy for beginners. <br><a name="habracut"></a><br>  All the settings in this example, we will produce on virtual machines hosted on the local network, although if they had public addresses and were in the cloud, there would be no fundamental difference. <br><br>  Suppose that Asterisk is already installed in the organization, and employees process a large number of incoming calls that the server is no longer able to handle.  We will add another Asterisk server (more precisely, we will clone the existing one), and SIP proxy will assume the role of ‚Äúdistributor‚Äù of incoming calls. <br><br>  Let's start with the choice of SIP proxy.  On Habr√© there is a <a href="https://habrahabr.ru/post/150280/">good article</a> on this topic, which discusses the history of the development of major projects.  Unlike the author of this article, my choice fell on Kamailio and the web interface for it called Siremis. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Install Kamailio.  We will use CentOs 6.8 as the OS. <br><br>  First of all, you need to disable SELinux, update the packages and install the necessary dependencies: <br><br><pre><code class="hljs sql">yum -y <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> &amp;&amp; yum -y groupinstall core &amp;&amp; yum -y groupinstall base &amp;&amp; yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> epel-<span class="hljs-keyword"><span class="hljs-keyword">release</span></span> yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> httpd mysql-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> php php-mysql php-gd php-curl</code> </pre> <br>  We will need access to port 80 to work with the web-interface and to 5060 udp to work with sip, so we add the rules IPTables: <br><br><pre> <code class="hljs perl">iptables -A INPUT -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> NEW -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> tcp -p tcp --dport <span class="hljs-number"><span class="hljs-number">80</span></span> -j ACCEPT iptables -A INPUT -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> <span class="hljs-keyword"><span class="hljs-keyword">state</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">state</span></span> NEW -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> udp -p udp --dport <span class="hljs-number"><span class="hljs-number">5060</span></span> -j ACCEPT</code> </pre> <br>  Create the file /etc/yum.repos.d/kamailio.repo with the contents: <br><br><pre> <code class="hljs pgsql">[kamailio] <span class="hljs-type"><span class="hljs-type">name</span></span>=RPMs <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> Kamailio <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> CentOS <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=rpm-md baseurl=http://rpm.kamailio.org/<span class="hljs-keyword"><span class="hljs-keyword">stable</span></span>/CentOS_6/ gpgcheck=<span class="hljs-number"><span class="hljs-number">1</span></span> gpgkey=http://rpm.kamailio.org/<span class="hljs-keyword"><span class="hljs-keyword">stable</span></span>/CentOS_6/repodata/repomd.xml.key enabled=<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br>  And install kamailio: <br><br><pre> <code class="hljs sql">yum <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> kamailio kamailio-presence kamailio-mysql</code> </pre> <br>  Do not forget to add demons to autoload: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">chkconfig</span></span> mysqld <span class="hljs-literal"><span class="hljs-literal">on</span></span> chkconfig httpd <span class="hljs-literal"><span class="hljs-literal">on</span></span> chkconfig kamailio <span class="hljs-literal"><span class="hljs-literal">on</span></span></code> </pre> <br>  Edit the / etc / kamailio / kamctlrc file: uncomment the line <br><br><pre> <code class="hljs">DBENGINE=MYSQL</code> </pre> <br>  and specify SIP_DOMAIN.  Due to the fact that we are setting up the system on the local network, it will be enough to specify the ip-address <br><br><pre> <code class="hljs">SIP_DOMAIN=192.168.0.237</code> </pre> <br>  Below you can edit the parameters of connection to the database, but in the case of a training stand it is not necessary to change them. <br><br>  Run MySQL and generate the necessary tables: <br><br><pre> <code class="hljs pgsql">service mysqld <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> kamdbctl <span class="hljs-keyword"><span class="hljs-keyword">create</span></span></code> </pre> <br>  We answer all questions of the master in the affirmative. <br><br>  Now edit the main configuration file /etc/kamailio/kamailio.cfg.  Logically, it is divided into several sections: global parameters, loading of modules, installation of parameters of modules and routes.  Each Kamailio module performs a specific function, so you can download only the necessary libraries for a specific task.  The beginning of the file we bring to the form: <br><br><pre> <code class="hljs cs"><span class="hljs-meta"><span class="hljs-meta">#!KAMAILIO #!</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WITH_MYSQL #!</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WITH_AUTH #!</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WITH_USRLOCDB #!</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WITH_PRESENCE #!</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> WITH_ACCDB</span></span></code> </pre> <br>  As is clear from the comments below, these directives include the necessary modules, for example WITH_MYSQL, defined at the beginning of the file, below leads to the loading of the mysql.so module: <br><br><pre> <code class="hljs erlang-repl">#!ifdef WITH_MYSQL loadmodule <span class="hljs-string"><span class="hljs-string">"db_mysql.so"</span></span> #!endif</code> </pre> <br>  Of course, you can load all modules manually, but using the directive is much more convenient.  WITH_AUTH, for example, allows users to register for Kamailio using a username and password, and you can see all the choices in the comments below. <br><br>  For further correct operation of the web interface and statistics, we will make a few more changes: <br><br>  After all the lines loadmodule add load two more: <br><br><pre> <code class="hljs smalltalk">loadmodule <span class="hljs-comment"><span class="hljs-comment">"rtimer.so"</span></span> loadmodule <span class="hljs-comment"><span class="hljs-comment">"sqlops.so"</span></span></code> </pre> <br>  Before the section of the routes, which is separated by the line ####### Routing Logic ######## add the parameters of the loaded modules: <br><br><pre> <code class="hljs lisp">modparam(<span class="hljs-string"><span class="hljs-string">"rtimer"</span></span>, <span class="hljs-string"><span class="hljs-string">"timer"</span></span>, <span class="hljs-string"><span class="hljs-string">"name=cdr;interval=300;mode=1;"</span></span>) modparam(<span class="hljs-string"><span class="hljs-string">"rtimer"</span></span>, <span class="hljs-string"><span class="hljs-string">"exec"</span></span>, <span class="hljs-string"><span class="hljs-string">"timer=cdr;route=CDRS"</span></span>) modparam(<span class="hljs-string"><span class="hljs-string">"sqlops"</span></span>, <span class="hljs-string"><span class="hljs-string">"sqlcon"</span></span>, <span class="hljs-string"><span class="hljs-string">"cb=&gt;mysql://kamailio:kamailiorw@localhost/kamailio"</span></span>)</code> </pre> <br>  And add an additional route after the last section of the route in the region of 910 lines of the file: <br><br><pre> <code class="hljs objectivec">route[CDRS] { sql_query(<span class="hljs-string"><span class="hljs-string">"cb"</span></span>,<span class="hljs-string"><span class="hljs-string">"call kamailio_cdrs()"</span></span>,<span class="hljs-string"><span class="hljs-string">"rb"</span></span>); sql_query(<span class="hljs-string"><span class="hljs-string">"cb"</span></span>,<span class="hljs-string"><span class="hljs-string">"call kamailio_rating('default')"</span></span>,<span class="hljs-string"><span class="hljs-string">"rb"</span></span>); }</code> </pre> <br>  Launch Kamailio and check that it started: <br><br><pre> <code class="hljs dos">service kamailio <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> ps <span class="hljs-built_in"><span class="hljs-built_in">aux</span></span> | grep kamailio</code> </pre><br>  If Kamailio does not start, you need to look at the log / var / log / messages - this is where Kamailio errors will get, unless you additionally configure rsyslog, which is not a big deal. <br><br>  The default MySQL database is kamailio with a user kamailio with password kamailiorw, unless of course you change the default settings in the / etc / kamailio / kamctlrc file before creating the database.  In the event that you change these settings, it will not be superfluous to go through the autochange on the main configuration file kamailio.cfg and enter the correct connection data to the database. <br><br>  In principle, Kamailio can work without a database - all the necessary values ‚Äã‚Äãfor modules can be set in the configuration file or stored in external files, but using the database, especially on large projects, is much more convenient, plus the Siremis web interface will work with the database, which we will install now. <br><br>  You need to download, unzip the files, copy them to the directory with which apache will work and give the correct rights: <br><br><pre> <code class="hljs ruby">cd /usr/src wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/siremis.asipto.com/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/downloads/siremis</span></span><span class="hljs-regexp"><span class="hljs-regexp">/siremis-4.3.0.tgz tar zxvf siremis* cp -a siremis*/</span></span>. /var/www/html cd /var/www/html make prepare rm -rf /var/www/html/Makefile rm -rf /var/www/html/Changelog rm -rf /var/www/html/README chown -R apache. /var/www/html</code> </pre> <br>  In the section VirtualHost in the configuration apache for Siremis add <br><br><pre> <code class="hljs pgsql"> &lt;Directory "/var/www/html/siremis"&gt; <span class="hljs-keyword"><span class="hljs-keyword">Options</span></span> Indexes FollowSymLinks MultiViews AllowOverride <span class="hljs-keyword"><span class="hljs-keyword">All</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> allow,deny Allow <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> &lt;FilesMatch "\.xml$"&gt; <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> deny,allow Deny <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> &lt;/FilesMatch&gt; &lt;FilesMatch "\.inc$"&gt; <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> deny,allow Deny <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> &lt;/FilesMatch&gt; &lt;/Directory&gt; &lt;Directory "/var/www/html/openbiz"&gt; AllowOverride <span class="hljs-keyword"><span class="hljs-keyword">All</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> deny,allow Deny <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> &lt;/Directory&gt; &lt;Directory "/var/www/html/misc"&gt; AllowOverride <span class="hljs-keyword"><span class="hljs-keyword">All</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> deny,allow Deny <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> &lt;/Directory&gt;</code> </pre><br>  Further installation of the latest version of Siremis 4.3.0 at the time of this writing may cause problems if you do not have date.timezone set, so it is recommended to make changes to php.ini right away: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">date</span></span>.timezone = Europe/Moscow</code> </pre> <br>  Siremis will require a separate database.  Add user: <br><br><pre> <code class="hljs sql">mysql -e "<span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> siremis.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> siremis@localhost <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'siremisrw'</span></span>;"</code> </pre> <br>  You can change the parameters of the connection to the database, but do not forget to set the correct values ‚Äã‚Äãin the future. <br><br>  Now you can restart apache and go to the final stage of installing Siremis - already through the browser.  Go to <a href="http://xn---ip-5cdj7k/siremis">your ip / siremis</a> <br><br><img src="https://habrastorage.org/files/419/55a/653/41955a65305c4bb3ba542f4bc65ec51f.png"><br><br>  If the system check is passed, you can start the installation. <br><br><img src="https://habrastorage.org/files/550/b91/d8e/550b91d8e5f9499db231a4e2d2241cd8.png"><br><br>  Note: by default, default passwords from Kamailio and Siremis users are hidden under the asterisks, so if you haven‚Äôt made any changes before, you can also not forget the passwords manually at this step. <br><br>  Be sure to tick all the checkboxes - Create Siremus DB, Import Dafault Data, Update SIP DB, Replace DB config. <br><br><img src="https://habrastorage.org/files/b8c/276/781/b8c276781a9d4c148b27601ea6f60b70.png"><br><br>  Verify that the correct data is provided. <br><br><img src="https://habrastorage.org/files/1d8/d50/d80/1d8d50d8024940e0a80d4b7ac83494a3.png"><br><br>  And the installation is complete. <br><br><img src="https://habrastorage.org/files/f62/eb1/e27/f62eb1e270874a778b3bbe9ae5e8a1be.png"><br><br>  Let's try to make the first call through Kamailio.  To do this, go to the SIP Admin menu tab and add a new domain to the Domain List.  Kamailio will only serve the domains listed here (or ip-addresses). <br><br><img src="https://habrastorage.org/files/b7c/f4f/de4/b7cf4fde49944f4183d2729867ef9c4f.png"><br><br>  If a domain is attached to the address, and users can register either by specifying the ip-address or by specifying the domain, you should add the domain name to the list.  In our case, we add only the ip-address of the server to which clients will contact. <br><br><img src="https://habrastorage.org/files/a73/780/565/a73780565d024e4a8fe276e8e2f389ce.png"><br><br>  To create an internal subscriber or subscriber, we will go to Subscriber Services -&gt; Subscribers and add two numbers - 101 and 102, specifying passwords and a gray address for them as the domain (in our case, 192.168.0.237). <br><br><img src="https://habrastorage.org/files/b7d/df4/1db/b7ddf41db24a4703ac43b00d17d3b8cf.png"><br><br>  Now, using a softphone, for example Zoiper, we can register on the server and make a call from 101 to 102 numbers or vice versa and make sure that all previous actions were performed correctly. <br><br>  Let's proceed to setting up the distribution of incoming calls.  In the local network, we have 2 virtual machines with Asterisk at 192.168.0.234 and 192.168.0.235, and we need to equally distribute incoming calls between them.  In this situation, we will use the dispatcher module, which provides the necessary functionality. <br><br>  Back in the console, and add to the module loading section in kamailio.cfg <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">loadmodule</span></span> <span class="hljs-string"><span class="hljs-string">"dispatcher.so"</span></span></code> </pre> <br>  as well as two parameters - connections to the database, in which the list of Asterisk servers will be stored, and the frequency of checking these servers so that the call will never go off the server: <br><br><pre> <code class="hljs lisp">modparam(<span class="hljs-string"><span class="hljs-string">"dispatcher"</span></span>, <span class="hljs-string"><span class="hljs-string">"db_url"</span></span>, <span class="hljs-string"><span class="hljs-string">"mysql://kamailio:kamailiorw@localhost/kamailio"</span></span>) modparam(<span class="hljs-string"><span class="hljs-string">"dispatcher"</span></span>, <span class="hljs-string"><span class="hljs-string">"ds_ping_interval"</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>)</code> </pre> <br>  In general, the full list of modules, their parameters and functions can always be viewed on the <a href="http://kamailio.org/docs/modules/">official website</a> .  After connecting the module, restart Kamailio and make sure that it starts.  In case of problems (modules may depend on others, require the installation of certain parameters for the module itself, and for those on which it depends), we will see an error in the log. <br><br>  We now turn to the routes section.  The routes created by default, in principle, provide the necessary minimum, for example, when trying to register with the wrong password, Kamailio will give an error 401, and if you try to call a nonexistent direction, 404. The difficulty in understanding Kamailio routing is the variables and functions that are provided by the various modules used. , and it is not always immediately possible to understand which variable or function belongs to which module.  For our training purposes, the route will require a very simple one - at the very beginning of the main route we will add a condition: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">method</span></span>=="INVITE" ) { ds_select_dst("1","4"); sl_send_reply("100","Trying"); forward(); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(); }</code> </pre> <br>  If an INVITE request arrives, that is, an invitation to the beginning of a conversation, then we select one of the servers, which we later list in the table, from group 1 according to the selection strategy 4 - round-robin.  Then we send the answer to the caller and transfer the call to the selected destination.  Please note that now absolutely any INVITE will be processed in this way, so the opportunity to call from 101 numbers to 102 that we created earlier will be lost - calls from them will also fly to one of the Asterisk servers, and incoming INVITE requests will also be go directly to Asterisk without any verification of the source of the request. <br><br>  In order for Asterisk to handle such calls, you need to add a peer of the following type to each of the servers: <br><br><pre> <code class="hljs vhdl">[kamailio] host=<span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">0.237</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span>=<span class="hljs-number"><span class="hljs-number">5060</span></span> insecure=invite <span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=friend <span class="hljs-keyword"><span class="hljs-keyword">context</span></span>=from-pstn</code> </pre> <br>  Now you can add the Asterisk server to the Kamailio database via the web-interface: <br><br><img src="https://habrastorage.org/files/717/ba5/e06/717ba5e0638c444498f7c1f95174fa45.png"><br><br>  Setid will ask which server group the new server belongs to, Priority is not used in the round-robin selection strategy, but can be used in other strategies, and Flags in this case determines that by default we consider the server to be inactive and check its status. <br><br>  After adding servers, you can either restart Kamailio, which is unacceptable in production, or execute the <code>kamcmd dispatcher.reload</code> command.  The list of commands for each module can also be viewed on the <a href="http://kamailio.org/docs/modules/">official website</a> . <br><br>  You can proceed to testing.  Using a softphone, for example, Zoiper, you can make a call directly to Kamailio, without any accounts and registrations.  It is enough to enter sip in the field set: 1@192.168.0.237.  Immediately after this, the call will be redirected to one of Asterisk and processed in accordance with the dialplan.  The next call will go to the second server. <br><br>  In principle, the training task that we faced was to distribute incoming calls equally between the servers, we decided.  However, not every telecom operator is ready to send calls to your ip-address directly, without registration, and you will need to send REGISTER requests.  This functionality is implemented by the uac module.  Let's add one more Asterisk to our scheme - it will play the role of a provider.  On it we will create some internal number, for example, 200200, which will require registration. <br><br>  Load the module in the configuration file: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">loadmodule</span></span> <span class="hljs-string"><span class="hljs-string">"uac.so"</span></span></code> </pre> <br>  And we will set a couple of required parameters in our case: <br><br><pre> <code class="hljs lisp">modparam(<span class="hljs-string"><span class="hljs-string">"uac"</span></span>, <span class="hljs-string"><span class="hljs-string">"reg_db_url"</span></span>, <span class="hljs-string"><span class="hljs-string">"mysql://kamailio:kamailiorw@localhost/kamailio"</span></span>) modparam(<span class="hljs-string"><span class="hljs-string">"uac"</span></span>, <span class="hljs-string"><span class="hljs-string">"reg_contact_addr"</span></span>, <span class="hljs-string"><span class="hljs-string">"192.168.0.237"</span></span>)</code> </pre> <br>  In addition, you will need to make a change to the parameter of another module.  Find the line in the file <br><br><pre> <code class="hljs lisp">modparam(<span class="hljs-string"><span class="hljs-string">"rr"</span></span>, <span class="hljs-string"><span class="hljs-string">"append_fromtag"</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)</code> </pre><br>  and replace with: <br><br><pre> <code class="hljs lisp">modparam(<span class="hljs-string"><span class="hljs-string">"rr"</span></span>, <span class="hljs-string"><span class="hljs-string">"append_fromtag"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre> <br>  Now you can configure the registration by restarting Kamailio so that the module loads: <br><br><img src="https://habrastorage.org/files/c4b/ded/5e5/c4bded5e59c44dd3aa148147ab2c0a2f.png"><br><br>  Pay attention to the Realm field.  By default, you can enter anything into it, but then registration will not take place, and in the log you will see something like: <br><br><pre> <code class="hljs vbscript">kamailio /usr/sbin/kamailio[<span class="hljs-number"><span class="hljs-number">26277</span></span>]: <span class="hljs-keyword"><span class="hljs-keyword">ERROR</span></span>: uac [uac_reg.c:<span class="hljs-number"><span class="hljs-number">799</span></span>]: uac_reg_tm_callback(): realms <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> match. requested realm: [asterisk]</code> </pre> <br>  That is why if you experience any problems, you should not immediately re-read the manual, look for other instructions and doubt your abilities - most often an explanation can be found in the log. <br><br>  It remains only to make sure that the subscriber 200200 is registered with Asterisk, which plays the role of a provider, and make a call from any other number to 200200. <br><br>  We‚Äôve finished this example of Kamailio setup, but note that the article does not cover the work behind NAT, security, outgoing call routing and much more that may be required in a real situation.  However, I hope that this article will make it easier for you to master Kamailio. </div><p>Source: <a href="https://habr.com/ru/post/320784/">https://habr.com/ru/post/320784/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../320772/index.html">The difference between statistics and data science</a></li>
<li><a href="../320776/index.html">Google Chrome Extensions: a quick do-it-yourself translator</a></li>
<li><a href="../320778/index.html">Recheck SharpDevelop: What's New?</a></li>
<li><a href="../320780/index.html">Vysor is a handy tool for testing.</a></li>
<li><a href="../320782/index.html">Agile is dead, long live ... Agile</a></li>
<li><a href="../320788/index.html">How to make friends Custom View and keyboard</a></li>
<li><a href="../320790/index.html">Cloud surveillance: what everyone should know?</a></li>
<li><a href="../320792/index.html">Web Standards Days: Eternal Front End Values</a></li>
<li><a href="../320794/index.html">IT-meetup Superjob ‚ÄúiOS - architecture of design, code, deployment‚Äù (report, presentation, video)</a></li>
<li><a href="../320796/index.html">How to make a girl an offer with the help of social engineering</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>