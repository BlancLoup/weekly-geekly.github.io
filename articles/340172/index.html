<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analysis of the latest version of the Dridex malware for identity theft</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention a report on the latest version of Dridex, a well-known banking trojan that became famous for its complexity and ability to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analysis of the latest version of the Dridex malware for identity theft</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/59/e4/53/59e4531d639ab560682711.jpeg"><br><br>  I present to your attention a <a href="https://pandasecurity.bitrix24.ru/~Hsblv">report</a> on the latest version of Dridex, a well-known banking trojan that became famous for its complexity and ability to go unnoticed even on infected computers. <a name="habracut"></a><br><br>  <b>1. INTRODUCTION</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Dridex is a banking Trojan known for its complexity and ability to go unnoticed on devices it infects.  Being infected, these devices are embedded in a modular botnet, in which malicious characteristics (external or own) can be freely added to them via modules or libraries. <br><br>  The first version appeared at the end of 2014.  In early 2015, a major new update was released, giving life to the second version.  When viewing earlier versions of Dridex, the third version, which appeared in April 2015 and was used in well-known cyber attacks until the fourth version, the last known version, which appeared in February 2017, became the most stable and stable. <br><br>  No other major updates for Dridex since the dismantling of the main components of the botnet made by special services in 2015 have been discovered. [1] <br><br>  This new version of the banking Trojan contains new functionality.  One of them is called AtomBombing - this is a functionality designed to embed code without calling suspicious APIs in order to avoid detection by monitoring systems.  It contains a DLL hacking technique to increase its ‚Äúvitality‚Äù.  Finally, various cryptographic methods used to obtain the configuration were optimized.  [2] <br><br>  <b>2. CHARACTERISTICS OF TROYAN</b> <br><br>  Below are some static properties of the file being analyzed.  Trojan hash: <br><br><img src="https://habrastorage.org/webt/59/e4/54/59e454ac81ee3257821299.jpeg"><br><br>  The internal creation date of the analyzed sample is May 16, 2017.  The file in question was compiled for execution in 64-bit environments in order to simulate a legal dll from Microsoft. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e4530abb74d983597268.jpeg"><br>  <i>Figure 1. File properties</i> <br><br>  In addition, the file is encrypted using a unique algorithm, which allows it to remain unnoticed by antivirus programs. <br><br>  It was found that the executable file has a fairly large number of sections (total - 11), which we can see in Figure 2: <br><br><img src="https://habrastorage.org/webt/59/e4/68/59e4680eb8162055305801.jpeg"><br>  <i>Fig 2. Static information of the analyzed binary file</i> <br><br>  In the DATA section, we can see that the entropy is at the level of 7,799, and it is quite large.  It is located exactly in the section where it is possible to find a hard-to-encrypted binary file (it becomes a real malicious code after decryption).  In the first decrypted layer, the executable file stores memory in the process, then copies the code and eventually calls and runs it, as we can see in Figure 3: <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453096f838772692919.jpeg"><br>  <i>Fig.</i>  <i>3. Transition to Shelco</i> <br><br>  The first thing the code does is get the addresses of the functions it will use.  It does this using dynamic search through libraries loaded by the program.  To perform this task, it is executed through the PEB_LDR_DATA structure and the LDR-MODULE structure to find the main address of the loaded dll.  It refers to the starting address of the export table in order to perform all the functions exported by the dll and find the address of the function sought in the computer‚Äôs memory. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e45308e1f66166953017.jpeg"><br>  <i>Fig.</i>  <i>4. Listing the loaded modules</i> <br><br>  The silk code, in turn, checks whether there is a ‚Äúhook‚Äù in the undocumented function LdrLoadDll, referring to its address and checking if the first bit is the same as E9 (equivalent to jmp assembler). <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e45309055d3229837574.jpeg"><br>  <i>Fig.</i>  <i>5. Hook Verification</i> <br><br>  If the previous verification was successful, it proceeds to unpacking the dll memory process with the name ‚Äúsnxhk.dll‚Äù, which is the Avast and AVG library creating ‚Äúhooks‚Äù for monitoring processes occurring in the sandbox. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453078628c306475820.jpeg"><br>  <i>Fig.</i>  <i>6. Library: snxhk.dll</i> <br><br>  Finally, the shellcode decrypts the executable file in the DATA section in the computer's memory, copies it to the address of the base image, and then launches the new resulting executable file. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e4530770e69813411744.jpeg"><br>  <i>Fig.</i>  <i>7. Decrypted executable file</i> <br><br>  Thus, the complete process of sample unpacking can be seen in Figure 8, where it is presented more schematically. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453073696f080701988.jpeg"><br>  <i>Fig.</i>  <i>8. Complete unpacking process.</i> <br><br>  <b>3. PROCESS OF INFECTION</b> <br><br>  <b>3.1.</b>  <b>Infection vectors</b> <br>  While it is not clear to the end, in what directions is the infection of the device.  This can be via an exploit or as part of a spam campaign. <br><br>  <b>3.2.</b>  <b>Interaction with the infected system</b> <br>  Once launched, the trojan checks if it is the only instance of the malware running on the device, and also checks if it has already been implemented in the explorer.exe process. <br><br>  All this is done by creating and opening a mutex.  In order to achieve this, he first builds together the device name and user name, and then calculates their MD5 hash. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e45306cfa4d451188070.jpeg"><br>  <i>Fig.</i>  <i>9. Calculate hash</i> <br><br>  Then, it adds square brackets at the beginning and end, and separates them with dashes, like a COM object. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453060f713350820984.jpeg"><br>  <i>Figure 10. Mutex created in the system</i> <br><br>  Using this algorithm, it is possible to develop a vaccine that creates these mutexes in the systems in order to avoid being infected with the Dridex Trojan.  A malicious program that is not running creates a folder in% WINDOWS% \ system32 \ [0-9] {4] <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453055f4e5106546086.jpeg"><br>  <i>Fig.</i>  <i>11. Created folder</i> <br><br>  The malicious program copies the legal .exe to the folder along with the corresponding .dll or .cpl.  This .dll or .cpl is not legitimate - this is a trojan.  After starting .exe from a folder, malicious .dll or .cpl is loaded using a technique known as hijacking. <br><br>  It also programs a task with a random name (in our example in Figure 12 it is ‚ÄúDomitxtdoi‚Äù), which will run every 60 minutes. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453049b928761307163.jpeg"><br>  <i>Fig.</i>  <i>12. Creating a task</i> <br><br>  In this example, we see that tcmsetup.exe is launched, after which a malicious dll (TAPI32.dll) is loaded and the infection process begins. <br><br>  After programming the task, a set of commands is launched and a rule is created in the firewall for explorer.exe: <br>  netsh advfirewall firewall add rule name = "Core Networking - Multicast Listener Done (ICMPv4-In)" program = "C: \ Windows \ Explorer.EXE" dir = in action = allow protocol = TCP localport = any <br><br>  <b>Creating a malicious task</b> <br><br>  schtasks.exe / Create / F / TN "Utdcm" / SC minute / MO 60 / TR "C: \ Windows \ system32 \ 3007 \ tcmsetup.exe" / RL highest <br><br>  During this process, the malicious .dll will be built into the explorer.exe process using AtomBombing techniques.  Then it will wait for the moment when the user opens the browser (Internet Explorer, Firefox, Chrome, etc.). <br><br>  At the moment when the user opens the browser, the new shellcode will be embedded from explorer.exe into the browser, using the same AtomBombing technique. <br><br>  <b>4. PRESENCE IN THE SYSTEM</b> <br><br>  To ensure its presence in the system, the following actions are performed.  It creates a folder with four random numbers in C: \ Windows \ System32, inside which it copies the legitimate Windows executable file (not always the same) and the .dll, which should be loaded by this executable file.  Just this .dll will be modified by malicious code. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453047de03794829151.jpeg"><br>  <i>Fig.</i>  <i>13. Presence in the system</i> <br><br>  This technique is known as DLL-hijacking.  It uses a command that allows the system to search for the libraries / files that it is going to load / use.  In the case of the picture above, the executable file ‚ÄúSystemPropertiesPerformance.exe‚Äù will load ‚ÄúSYSDM.CPL‚Äù among other libraries.  By default, the search for the file "SYSDM.CPL" will first be carried out in the folder where the application was launched.  In our example, this is C: \ Windows \ System32 \ 1365.  If this file is not found there, then its search will be carried out in other folders depending on how the system has configured the search order for .dll files. <br><br>  After the executable file and the modified .dll are copied to the same folder, now Dridex must do so as to cause as little suspicion as possible, so its malicious actions are carried out through a legitimate program. <br><br>  To execute a file, it creates a scheduled task to launch it in a folder with random numbers (C: \ Windows \ System32 \ 1365) every hour, as shown in the previous chapter. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453045816d481040602.jpeg"><br>  <i>Fig.</i>  <i>14. Creating a programmed task</i> <br><br>  As already mentioned, the folder name contains four random numbers, and the executable file that it creates does not always have the same name as .dll, but the malware always knows which executable file which library loads, and it is always able to modify the specified library using malicious code. <br><br>  Continuing our analysis, we see that it acts as follows: <br><br><ol><li>  It will list all executable files in "C: \ Windows \ System32 \" </li><li>  It will shash the name of each executable file and compare it with the value that was saved earlier.  If they match, he will continue working with this executable file. </li><li>  It will read the IAT of the selected executable file and from there select the .dll for further modification. </li><li>  It will read IAT .dll, selected in item 3. </li><li>  It will create a copy of the malicious code (the .dll itself) and add a section with a random name at the end to copy the IAT obtained in Section 4. </li><li>  It will copy the selected executable file (p. 3) and the modified malicious .dll (p. 5) to a random folder. </li></ol><br>  In this case, it receives a presence in the system and each time the executable file is executed, it will download a malicious .dll. <br><br>  The malicious program will also create a copy of itself in an executable format along with the registry key in AppData \ Roaming \ [random folder name] with a route in ‚ÄúHKCU \ Software \ Microsoft \ Windows \ CurrentVersion \ Run‚Äù. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e4530415255082111617.jpeg"><br>  <i>Fig.</i>  <i>15. Registry key</i> <br><br>  <b>5. INTRODUCTION THROUGH ATOMBOMBING</b> <br><br>  Dridex uses the AtomBombing technique to write the shellcode to other processes without causing any suspicion.  This is achieved through calls to APC and one of the most commonly used Windows Executive Objects called Atoms.  Below are the different stages of implementation in another process. <br><br>  <b>5.1.</b>  <b>Search for a target process</b> <br><br>  In this case, the target process is the explorer.exe process, and to integrate into it, it must first be available when listing the participating processes using the following functions: <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453039b84e433959352.jpeg"><br>  <i>Fig.</i>  <i>16. Enumeration of processes</i> <br><br>  Once it finds the explorer.exe process, it will call the OpenProcess function to begin listing the alertable threads. <br><br>  <b>5.2.</b>  <b>Search alertable streams</b> <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e45302c17df839914432.jpeg"><br>  <i>Fig.</i>  <i>17. Alertable streams</i> <br><br>  At this stage, the malware will try to find any stream in the alertable state, since  this will allow her to make APC calls to execute code in the target process. <br><br>  To find the alertable stream, the trojan first obtains a handle for each thread in explorer.exe.  It then runs the call to NtQueueApcThread as NtSetEvent, and waits for any of the threads to respond. <br><br>  If everything works correctly, then it receives the first thread that answered the call, after which it starts to inject the code. <br><br>  <b>5.3.</b>  <b>Insertion of silk code in the target process</b> <br><br>  First, the malicious .dll makes a call to GlobalAddAtomW and creates a new Atom with the content that it wants to embed in the target process (in this case, explorer.exe). <br><br>  Secondly, the malicious .dll calls NtQueueApcThread, and then sends as a parameter a function that must be started by the explorer.exe process. <br><br>  The first time this is done, the trojan makes a call to the memset to make sure that the zone where the shellcode will be written is at 0. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e45301a2221482546975.jpeg"><br>  <i>Fig.</i>  <i>18. Clear memory</i> <br><br>  It is important to point out that the zone that Dridex chose to copy the silk code is in ntdll, as we can see in R8.  This is because ntdll is always loaded into the same starting number in all processes, regardless of ASLR. <br><br>  In the next iterations, the function passed as the NtQueueApcThread parameter will become GlobalAtomGetAtomNameW, as a result of which the target process will receive the Atom that has just been created by the malicious .dll and write it to the specified zone so that will arouse any suspicion. <br><br>  First, it will create an IAT for the shells. <br><br><img src="https://habrastorage.org/webt/59/e4/52/59e452ffc9172686832558.jpeg"><br>  <i>Fig.</i>  <i>19. Creating IAT in explorer.exe</i> <br><br>  And after some iterations, it will completely copy the shellcode to explorer.exe. <br><br><img src="https://habrastorage.org/webt/59/e4/53/59e453027a627713598150.jpeg"><br>  <i>Fig.</i>  <i>20. Shelcode in explorer.exe</i> <br><br>  <b>5.4.</b>  <b>Performing the shells in the target process</b> <br><br>  After the shellcode is copied to explorer.exe, it must be executed.  To do this, Dridex modifies the GlobalAtomGetAtomNameA function in the same way as the shellcode was implemented using Atoms.  Function source code: <br><br><img src="https://habrastorage.org/webt/59/e4/52/59e452fdddbc8497583767.jpeg"><br>  <i>Fig.</i>  <i>21. Initial function</i> <br><br>  Here's how the function was modified: <br><br><img src="https://habrastorage.org/webt/59/e4/52/59e452fdba0e4683346074.jpeg"><br>  <i>Fig.</i>  <i>22. Modified function</i> <br><br>  As you can see, when you call GlobalAtomGetAtomNameA in explorer.exe, the program will execute the shellcode.  After modification of the malicious .dll, a call will be made to GlobalAtomGetAtomNameA using NtQueueApcThread. <br><br><img src="https://habrastorage.org/webt/59/e4/52/59e452fcce6de960735934.jpeg"><br>  <i>Fig.</i>  <i>23. Remote execution of the silkcode</i> <br><br>  At this point, the shellcode will be executed.  After that, GlobalAtomGetAtomNameA will return to its original state, so as not to cause any suspicion. <br><br>  <b>6. NETWORK CONNECTIONS</b> <br><br>  After the trojan has been deployed to the explorer.exe process, it opens port 443 (usually used for the HTTPS protocol) and waits for a certain connection. <br><br><img src="https://habrastorage.org/webt/59/e4/65/59e465f11ea89294649426.jpeg"><br>  <i>Fig.</i>  <i>24. Open port 443</i> <br><br>  <b>7. INDICATORS OF COMPROMATION</b> <br><br>  To check whether the computer has been compromised by this version of Dridex, consider the following points: <br><br><ul><li>  The explorer.exe process listens on port 443, and the firewall has a rule that allows network traffic for this process. </li><li>  There are folders corresponding to the% SYSTEM% \ [0-9] {4} expression, which contain a legitimate executable file and a file with the extension .dll or .cpl. </li><li>  There are scheduled tasks that run the file from the% SYSTEM% \ [0-9] {4} folder every 60 minutes. </li></ul><br>  <b>8. LINKS</b> <br><br>  [1] <a href="http://www.bankinfosecurity.com/dridex-botnet-disruption-lessons-learned-a-8594">Inside the Dridex Malware Takedown</a> <br><br>  [2] <a href="https://www.virusbulletin.com/conference/vb2017/abstracts/dridex-v4-atombombing-and-other-surprises/">Dridex v4 - AtomBombing and other surprises</a> <br><br>  [3] <a href="http://blog.nsfocus.net/dridex-banking-malware-sample-technical-analysis-solution/">Dridex Banking Malware Sample Technical Analysis and Solution</a> </div><p>Source: <a href="https://habr.com/ru/post/340172/">https://habr.com/ru/post/340172/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340160/index.html">Header design features</a></li>
<li><a href="../340164/index.html">Information security in the process control system: attack vector man-machine interface</a></li>
<li><a href="../340166/index.html">How Android Converts Resource Sizes</a></li>
<li><a href="../340168/index.html">How did we choose Graylog2</a></li>
<li><a href="../340170/index.html">Rust 1.21 release</a></li>
<li><a href="../340176/index.html">The whole web on 60+ FPS: how a new renderer in Firefox got rid of jerks and slowdowns</a></li>
<li><a href="../340178/index.html">Monoids, semigroups and all-all-all</a></li>
<li><a href="../340180/index.html">Wi-Fi security is compromised due to multiple vulnerabilities found in WPA2</a></li>
<li><a href="../340182/index.html">Critical vulnerabilities detected in WPA2 - Key Reinstallation Attacks (KRACK)</a></li>
<li><a href="../340184/index.html">Introduction to Neural Network Architectures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>