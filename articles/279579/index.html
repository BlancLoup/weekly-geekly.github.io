<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>XData Studio Assist - autocompletion in XData blocks of InterSystems Cach√© classes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article is a translation of my article published on the new InterSystems Developer Community portal. It tells about another possibility in Studio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>XData Studio Assist - autocompletion in XData blocks of InterSystems Cach√© classes</h1><div class="post__text post__text-html js-mediator-article"> <a href="https://habrahabr.ru/company/intersystems/blog/279579/"><img width="50%" align="left" src="https://habrastorage.org/files/f7a/c9f/c1a/f7ac9fc1a2cf431296ef861886d02311.png"></a>  This article is a translation of my article published on the new InterSystems <a href="https://community.intersystems.com/post/xdata-studio-assist">Developer Community</a> portal.  It tells about another possibility in Studio - support for autocompletion when creating XML documents in XData.  This article develops the <a href="https://community.intersystems.com/post/object-generators-homemade-ruleengine">idea</a> raised by Albert Fuentes about the use of XData and <a href="">code generators</a> to simplify the creation of certain rules.  You may have already encountered autocompletion in XData when developing a <a href="">ZEN</a> application, <a href="">% Installer-</a> manifest or <a href="">REST</a> broker.  This is called <a href="">Studio Assist</a> .  I will tell you how to configure and use this feature. <br><a name="habracut"></a><br><br clear="left"><h2>  XData XML XML Completion </h2><br>  There are several ways to implement autocompletion for XML.  But they all come down to one degree or another to using the class <a href="">% Studio.SASchemaClass</a> .  Some schemes are described not through classes but in the form of a single file, examples of these files can be seen in the folder with installed Cach√© / dev / studio / saschema.  For example, here is the location of the <a href="">routing</a> description scheme file used in <a href="">% CSP.REST</a> , this class defines the XML schema, but it is used only for parsing UrlMap.  The format is quite simple, it describes the xml namespace and the prefix.  The following describes the hierarchy of tags, with attributes and their values. <br><blockquote><pre><code class="hljs pgsql"># This file defines the Rest UrlMap studio assist <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> # Define the prefix <span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span> !prefix-<span class="hljs-keyword"><span class="hljs-keyword">mapping</span></span>:urlmap:http://www.intersystems.com/urlmap # <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> namespace <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> urlmap !<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-namespace:http://www.intersystems.com/urlmap # <span class="hljs-keyword"><span class="hljs-keyword">Set</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> prefix <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> element definitions that follow !<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-prefix:urlmap /#Routes Routes/#Map Routes/#Route Map|Prefix Map|Forward Route|Url Route|<span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>@enum:!,<span class="hljs-keyword"><span class="hljs-keyword">GET</span></span>,HEAD,POST,PUT,<span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span>,TRACE,<span class="hljs-keyword"><span class="hljs-keyword">CONNECT</span></span> Route|<span class="hljs-keyword"><span class="hljs-keyword">Call</span></span> Route|Cors@enum:!,<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre> </blockquote><br>  But in this case it is only suitable as an assistant in the studio, we still need to add XML-based code generation.  Classes from the <a href="">% XGEN</a> package will help us in this.  Unfortunately, these classes are marked as not recommended for use, as they may or may not be removed from future versions, and it is recommended to contact InterSystems if you need them.  Thus, now, to describe the schema, we need to create a series of classes: for each tag in our XML, we need to create a separate class, another class that will compile all our rules will be the superclass for the new rules.  I slightly modified the XML format for the rules from Albert‚Äôs article, and as a result we have the Definition root tag, which may contain Rule tags, and those in turn, any number of Action tags.  Below is an example of XML that we should get. <br><br><pre> <code class="hljs pgsql">XData XMLData [ XMLNamespace = RuleEngine ] { &lt;Definition Identifier="PatientAlerts"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> Title="Not young anymore!" Condition="context.Patient.DOB &gt; $horolog-30"&gt; &lt;Action <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="call" <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span>="IAT.RuleEngine.Test.Utils" <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>="SendEmail" Args=""test@<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.com","Patient <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> so <span class="hljs-built_in"><span class="hljs-built_in">old</span></span>!""/&gt; &lt;Action <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="call" <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span>="IAT.RuleEngine.Test.Utils" <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>="ShowObject" Args="context.Patient"/&gt; &lt;Action <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="return"/&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span>&gt; &lt;/Definition&gt; }</code> </pre> <br>  Next, we need to generate code based on the XML that will check the condition in the rule and perform the actions described in this rule. <br><br>  Thanks to% XGEN, we not only get auto-completion in XData, but also the ability to generate code based on it.  Our tag classes get several methods that allow you to generate code for a specific tag.  These are <b>% OnGenerateCode</b> , <b>% OnBeforeGenerateCode,</b> and <b>% OnAfterGenerateCode methods</b> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Classes for the Definition root tag: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> IAT.RuleEngine.Definition Extends %XGEN.AbstractDocument [ <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> ] { Parameter NAMESPACE = "RuleEngine"; Parameter XMLNAMESPACE = "RuleEngine"; Parameter ROOTCLASSES <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> STRING = "IAT.RuleEngine.Definition:Definition"; Property Identifier <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String(MAXLEN = <span class="hljs-number"><span class="hljs-number">200</span></span>, XMLPROJECTION = "ATTRIBUTE"); Property Rules <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> list <span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span>(XMLPROJECTION = "ELEMENT"); /// This <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> containing an XGEN /// document <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> compiled. It <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> &lt;em&gt;<span class="hljs-keyword"><span class="hljs-keyword">before</span></span>&lt;/em&gt; the &lt;<span class="hljs-keyword"><span class="hljs-keyword">method</span></span>&gt;%GenerateCode&lt;/<span class="hljs-keyword"><span class="hljs-keyword">method</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> /// processes its children.&lt;br&gt; /// &lt;var&gt;pTargetClass&lt;/var&gt; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> that contains the XGEN document.&lt;br/&gt; /// &lt;var&gt;pCode&lt;/var&gt; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a stream containing the <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> code.&lt;br/&gt; /// &lt;var&gt;pDocument&lt;/var&gt; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the top-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> XGEN document <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> that contains this node.&lt;br/&gt; /// A subclass can provide an implementation <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> that will /// generate specific lines <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> code.&lt;br/&gt; <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> %OnBeforeGenerateCode(pTargetClass <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>.CompiledClass, pCode <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Stream.TmpCharacter, pDocument <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %XGEN.AbstractDocument) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pCode.WriteLine("#define AddLog(%line) set log($i(log))=""[""_$zdatetime($ztimestamp,3)_""] ""_%line") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pCode.WriteLine(..%Indent(<span class="hljs-number"><span class="hljs-number">1</span></span>)_"Set tSC = $$$OK ") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pCode.WriteLine(..%Indent(<span class="hljs-number"><span class="hljs-number">1</span></span>)_"try { ") quit $$<span class="xml"><span class="xml">$OK } /// This method is called when a class containing an XGEN /// document is compiled. It is called </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">em</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">after</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">em</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> the </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">method</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">%GenerateCode</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">method</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> method /// processes its children.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> /// </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">var</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">pTargetClass</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">var</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> is the class that contains the XGEN document.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> /// </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">var</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">pCode</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">var</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> is a stream containing the generated code.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> /// </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">var</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">pDocument</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">var</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> is the top-level XGEN document object that contains this node.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> /// A subclass can provide an implementation of this method that will /// generate specific lines of code.</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag">/&gt;</span></span></span><span class="xml"> Method %OnAfterGenerateCode(pTargetClass As %Dictionary.CompiledClass, pCode As %Stream.TmpCharacter, pDocument As %XGEN.AbstractDocument) As %Status { do pCode.WriteLine(..%Indent(1)_"} catch ex { set tSC = ex.AsStatus() }") do pCode.WriteLine(..%Indent(1)_"quit tSC") quit $$</span></span>$OK } }</code> </pre> <br>  Next, the Rule tag: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> IAT.RuleEngine.<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> Extends IAT.RuleEngine.<span class="hljs-keyword"><span class="hljs-keyword">Sequence</span></span> [ <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> ] { Property Title <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String(XMLPROJECTION = "ATTRIBUTE"); Property Condition <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %String(XMLPROJECTION = "ATTRIBUTE"); Property Actions <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> list <span class="hljs-keyword"><span class="hljs-keyword">Of</span></span> Action(XMLPROJECTION = "ELEMENT"); /// This <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> containing an XGEN /// document <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> compiled. It <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">called</span></span> &lt;em&gt;<span class="hljs-keyword"><span class="hljs-keyword">before</span></span>&lt;/em&gt; the &lt;<span class="hljs-keyword"><span class="hljs-keyword">method</span></span>&gt;%GenerateCode&lt;/<span class="hljs-keyword"><span class="hljs-keyword">method</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> /// processes its children.&lt;br&gt; /// &lt;var&gt;pTargetClass&lt;/var&gt; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> that contains the XGEN document.&lt;br/&gt; /// &lt;var&gt;pCode&lt;/var&gt; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> a stream containing the <span class="hljs-keyword"><span class="hljs-keyword">generated</span></span> code.&lt;br/&gt; /// &lt;var&gt;pDocument&lt;/var&gt; <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> the top-<span class="hljs-keyword"><span class="hljs-keyword">level</span></span> XGEN document <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> that contains this node.&lt;br/&gt; /// A subclass can provide an implementation <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> this <span class="hljs-keyword"><span class="hljs-keyword">method</span></span> that will /// generate specific lines <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> code.&lt;br/&gt; <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span> %OnBeforeGenerateCode(pTargetClass <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %<span class="hljs-keyword"><span class="hljs-keyword">Dictionary</span></span>.CompiledClass, pCode <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Stream.TmpCharacter, pDocument <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %XGEN.AbstractDocument) <span class="hljs-keyword"><span class="hljs-keyword">As</span></span> %Status { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pCode.WriteLine(..%Indent()_"If ("_..Condition_") { set actionCounter=0 ") <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> pCode.WriteLine(..%Indent(<span class="hljs-number"><span class="hljs-number">1</span></span>)_"$$$AddLog(""Rule: "_..Title_" "")") quit $$<span class="ruby"><span class="ruby">$OK } /</span><span class="hljs-regexp"><span class="ruby"><span class="hljs-regexp">//</span></span></span><span class="ruby"> This method is called </span><span class="hljs-keyword"><span class="ruby"><span class="hljs-keyword">when</span></span></span><span class="ruby"> a </span><span class="hljs-class"><span class="hljs-keyword"><span class="ruby"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">containing</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">an</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">XGEN</span></span></span></span><span class="ruby"><span class="hljs-class"> /// </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">document</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">is</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">compiled</span></span></span></span><span class="ruby"><span class="hljs-class">. </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">It</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">is</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">called</span></span></span></span><span class="ruby"><span class="hljs-class"> &lt;em&gt;</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">after</span></span></span></span><span class="ruby"><span class="hljs-class">&lt;/</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">em</span></span></span></span><span class="ruby"><span class="hljs-class">&gt; </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">the</span></span></span></span><span class="ruby"><span class="hljs-class"> &lt;method&gt;%</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">GenerateCode</span></span></span></span><span class="ruby"><span class="hljs-class">&lt;/</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">method</span></span></span></span><span class="ruby"><span class="hljs-class">&gt; </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">method</span></span></span></span><span class="ruby"><span class="hljs-class"> /// </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">processes</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">its</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">children</span></span></span></span><span class="ruby"><span class="hljs-class">.&lt;br&gt; /// &lt;var&gt;</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pTargetClass</span></span></span></span><span class="ruby"><span class="hljs-class">&lt;/</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">var</span></span></span></span><span class="ruby"><span class="hljs-class">&gt; </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">is</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">the</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">class</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">that</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">contains</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">the</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">XGEN</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">document</span></span></span></span><span class="ruby"><span class="hljs-class">.&lt;br/&gt; /// &lt;var&gt;</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pCode</span></span></span></span><span class="ruby"><span class="hljs-class">&lt;/</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">var</span></span></span></span><span class="ruby"><span class="hljs-class">&gt; </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">is</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">a</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">stream</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">containing</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">the</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">generated</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">code</span></span></span></span><span class="ruby"><span class="hljs-class">.&lt;br/&gt; /// &lt;var&gt;</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pDocument</span></span></span></span><span class="ruby"><span class="hljs-class">&lt;/</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">var</span></span></span></span><span class="ruby"><span class="hljs-class">&gt; </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">is</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">the</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">top</span></span></span></span><span class="ruby"><span class="hljs-class">-</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">level</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">XGEN</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">document</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">object</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">that</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">contains</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">this</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">node</span></span></span></span><span class="ruby"><span class="hljs-class">.&lt;br/&gt; /// </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">A</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">subclass</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">can</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">provide</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">an</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">of</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">this</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">method</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">that</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">will</span></span></span></span><span class="ruby"><span class="hljs-class"> /// </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">generate</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">specific</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">lines</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">of</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">code</span></span></span></span><span class="ruby"><span class="hljs-class">.&lt;br/&gt; </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">Method</span></span></span></span><span class="ruby"><span class="hljs-class"> %</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">OnAfterGenerateCode</span></span></span></span><span class="ruby"><span class="hljs-class">(</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pTargetClass</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">As</span></span></span></span><span class="ruby"><span class="hljs-class"> %</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">Dictionary</span></span></span></span><span class="ruby"><span class="hljs-class">.</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">CompiledClass</span></span></span></span><span class="ruby"><span class="hljs-class">, </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pCode</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">As</span></span></span></span><span class="ruby"><span class="hljs-class"> %</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">Stream</span></span></span></span><span class="ruby"><span class="hljs-class">.</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">TmpCharacter</span></span></span></span><span class="ruby"><span class="hljs-class">, </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pDocument</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">As</span></span></span></span><span class="ruby"><span class="hljs-class"> %</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">XGEN</span></span></span></span><span class="ruby"><span class="hljs-class">.</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">AbstractDocument</span></span></span></span><span class="ruby"><span class="hljs-class">) </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">As</span></span></span></span><span class="ruby"><span class="hljs-class"> %</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">Status</span></span></span></span><span class="ruby"><span class="hljs-class"> { </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">do</span></span></span></span><span class="ruby"><span class="hljs-class"> </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">pCode</span></span></span></span><span class="ruby"><span class="hljs-class">.</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">WriteLine</span></span></span></span><span class="ruby"><span class="hljs-class">(..%</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">Indent</span></span></span></span><span class="ruby"><span class="hljs-class">()</span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">_</span></span></span></span><span class="ruby"><span class="hljs-class">"}") </span></span><span class="hljs-title"><span class="ruby"><span class="hljs-class"><span class="hljs-title">quit</span></span></span></span><span class="ruby"><span class="hljs-class"> $$</span></span></span></span>$OK } }</code> </pre> <br>  And the last Action tag: <br><br><pre> <code class="hljs cs">Class IAT.RuleEngine.Action Extends IAT.RuleEngine.RuleEngineNode [ System = <span class="hljs-number"><span class="hljs-number">3</span></span> ] { Parameter NAMESPACE = <span class="hljs-string"><span class="hljs-string">"RuleEngine"</span></span>; Property Type As %String(VALUELIST = <span class="hljs-string"><span class="hljs-string">",call,return"</span></span>, XMLPROJECTION = <span class="hljs-string"><span class="hljs-string">"ATTRIBUTE"</span></span>); Property Class As %String(XMLPROJECTION = <span class="hljs-string"><span class="hljs-string">"ATTRIBUTE"</span></span>); Property Method As %String(XMLPROJECTION = <span class="hljs-string"><span class="hljs-string">"ATTRIBUTE"</span></span>); Property Args As %String(XMLPROJECTION = <span class="hljs-string"><span class="hljs-string">"ATTRIBUTE"</span></span>); <span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Generate code for this node.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;br/&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> This method is called when a class containing an XGEN </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> document is compiled.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;br/&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;var&gt;</span></span></span><span class="hljs-comment">pTargetClass</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/var&gt;</span></span></span><span class="hljs-comment"> is the class that contains the XGEN document.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;br/&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;var&gt;</span></span></span><span class="hljs-comment">pCode</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/var&gt;</span></span></span><span class="hljs-comment"> is a stream containing the generated code.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;br/&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;var&gt;</span></span></span><span class="hljs-comment">pDocument</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/var&gt;</span></span></span><span class="hljs-comment"> is the top-level XGEN document object that contains this node.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;br/&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> A subclass will provide an implementation of this method that will </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> generate specific lines of code.</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;br/&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> For example: </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;example&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Do pCode.WriteLine(..%Indent()_"Set " _ ..target _ "=" _ $$$quote(..value)) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/example&gt;</span></span></span><span class="hljs-comment"> Method %OnGenerateCode(pTargetClass As %Dictionary.CompiledClass, pCode As %Stream.TmpCharacter, pDocument As %XGEN.AbstractDocument) As %Status { do pCode.WriteLine(..%Indent()_"$$$AddLog(""Action: ""_$i(actionCounter))") if ..Type="call" { do pCode.WriteLine(..%Indent() _ "do $classmethod("_$$$quote(..Class)_", "_$$$quote(..Method)_", "_..Args_")") } elseif ..Type="return" { do pCode.WriteLine(..%Indent() _ "quit ") } Quit $$$OK } }</span></span></code> </pre> <br>  Now we need a class that will be a template for describing the rules, and which will be able to compile the resulting XML. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> IAT.RuleEngine.Engine Extends %RegisteredObject [ <span class="hljs-keyword"><span class="hljs-keyword">System</span></span> = <span class="hljs-number"><span class="hljs-number">3</span></span> ] { XData XMLData [ XMLNamespace = RuleEngine ] { &lt;Definition&gt; &lt;/Definition&gt; } ///   ClassMethod Evaluate(context, <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>) [ CodeMode = objectgenerator ] { ///      Quit ##<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(IAT.RuleEngine.Definition).%Generate(%compiledclass, %code, "XMLData") } }</code> </pre><br>  And now we can create our own class with rules: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Class</span></span> IAT.RuleEngine.Test.PatientAlertsRule Extends IAT.RuleEngine.Engine { XData XMLData [ XMLNamespace = RuleEngine ] { &lt;Definition Identifier="PatientAlerts"&gt; &lt;<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span> Title="Not young anymore!" Condition="context.Patient.DOB &gt; $horolog-30"&gt; &lt;Action <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="call" <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span>="IAT.RuleEngine.Test.Utils" <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>="SendEmail" Args=""test@<span class="hljs-keyword"><span class="hljs-keyword">server</span></span>.com","Patient <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> so <span class="hljs-built_in"><span class="hljs-built_in">old</span></span>!""/&gt; &lt;Action <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="call" <span class="hljs-keyword"><span class="hljs-keyword">Class</span></span>="IAT.RuleEngine.Test.Utils" <span class="hljs-keyword"><span class="hljs-keyword">Method</span></span>="ShowObject" Args="context.Patient"/&gt; &lt;Action <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>="return"/&gt; &lt;/<span class="hljs-keyword"><span class="hljs-keyword">Rule</span></span>&gt; &lt;/Definition&gt; } }</code> </pre> <br>  After compiling which we get the code: <br><br><pre> <code class="hljs bash">zEvaluate(context,<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>) public { // generated by IAT.RuleEngine.Definition <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tSC=1 try { If (context.Patient.DOB &gt; <span class="hljs-variable"><span class="hljs-variable">$horolog</span></span>-30) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> actionCounter=0 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>))=<span class="hljs-string"><span class="hljs-string">"["</span></span>_<span class="hljs-variable"><span class="hljs-variable">$zdatetime</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ztimestamp</span></span>,3)_<span class="hljs-string"><span class="hljs-string">"] "</span></span>_<span class="hljs-string"><span class="hljs-string">"Rule: Not young anymore! "</span></span> <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>))=<span class="hljs-string"><span class="hljs-string">"["</span></span>_<span class="hljs-variable"><span class="hljs-variable">$zdatetime</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ztimestamp</span></span>,3)_<span class="hljs-string"><span class="hljs-string">"] "</span></span>_<span class="hljs-string"><span class="hljs-string">"Action: "</span></span>_<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(actionCounter) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-variable"><span class="hljs-variable">$classmethod</span></span>(<span class="hljs-string"><span class="hljs-string">"IAT.RuleEngine.Test.Utils"</span></span>, <span class="hljs-string"><span class="hljs-string">"SendEmail"</span></span>, <span class="hljs-string"><span class="hljs-string">"test@server.com"</span></span>,<span class="hljs-string"><span class="hljs-string">"Patient is so old!"</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>))=<span class="hljs-string"><span class="hljs-string">"["</span></span>_<span class="hljs-variable"><span class="hljs-variable">$zdatetime</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ztimestamp</span></span>,3)_<span class="hljs-string"><span class="hljs-string">"] "</span></span>_<span class="hljs-string"><span class="hljs-string">"Action: "</span></span>_<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(actionCounter) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-variable"><span class="hljs-variable">$classmethod</span></span>(<span class="hljs-string"><span class="hljs-string">"IAT.RuleEngine.Test.Utils"</span></span>, <span class="hljs-string"><span class="hljs-string">"ShowObject"</span></span>, context.Patient) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">log</span></span>(<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>))=<span class="hljs-string"><span class="hljs-string">"["</span></span>_<span class="hljs-variable"><span class="hljs-variable">$zdatetime</span></span>(<span class="hljs-variable"><span class="hljs-variable">$ztimestamp</span></span>,3)_<span class="hljs-string"><span class="hljs-string">"] "</span></span>_<span class="hljs-string"><span class="hljs-string">"Action: "</span></span>_<span class="hljs-variable"><span class="hljs-variable">$i</span></span>(actionCounter) quit } } catch ex { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tSC = ex.AsStatus() } quit tSC }</code> </pre><br>  The complete code can be viewed on <a href="https://github.com/intersystems-ib/cache-iat-ruleengine/tree/pr/xgen">GitHub</a> . <br><br><h2>  Separate file </h2><br>  But the possibilities of the Studio do not end there.  I have already told in one of the previous <a href="https://habrahabr.ru/company/intersystems/blog/222563/">articles</a> about the possibility of creating my own file types.  In this case, it is possible to create a new type of XML format, which will also support both autocompletion and compilation of XML into some code, along the same lines.  With the current example, there is also my post on the <a href="https://community.intersystems.com/post/custom-studio-file">Developer Community</a> . <br><br><div class="spoiler">  <b class="spoiler_title">File Description Class Code</b> <div class="spoiler_text"><pre> <code class="hljs dos">Class IAT.RuleEngine.EngineFile Extends %Studio.AbstractDocument [ System = <span class="hljs-number"><span class="hljs-number">4</span></span> ] { Projection RegisterExtension As %Projection.StudioDocument(DocumentDescription = "RuleEngine file", DocumentExtension = "RULE", DocumentNew = <span class="hljs-number"><span class="hljs-number">0</span></span>, DocumentType = "xml", XMLNamespace = "RuleEngine"); Parameter NAMESPACE = "RuleEngine"; Parameter EXTENSION = ".rule"; Parameter DOCUMENTCLASS = "IAT.RuleEngine.Engine"; ClassMethod GetClassName(pName As %String) As %String [ CodeMode = expression ] { $P(pName,".",<span class="hljs-number"><span class="hljs-number">1</span></span>,$L(pName,".")-<span class="hljs-number"><span class="hljs-number">1</span></span>) } /// Load the routine <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Name into the stream Code Method Load() As %Status { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassName = ..GetClassName(..Name) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tXDataDef = ##class(<span class="hljs-variable"><span class="hljs-variable">%Dictionary.XDataDefinition).%</span></span>OpenId(tClassName_"||XMLData") <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ($IsObject(tXDataDef)) { <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..CopyFrom(tXDataDef.Data) } Quit $$$OK } /// Compile the routine Method Compile(flags As %String) As %Status { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tSC = $$$OK <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> $get($$$qualifierGetValue(flags,"displaylog")){ Write !,"Compiling document: " _ ..Name } <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tSC = $System.OBJ.Compile(..GetClassName(..Name),.flags,,<span class="hljs-number"><span class="hljs-number">1</span></span>) Quit tSC } /// Delete the routine 'name' which includes the routine extension ClassMethod Delete(name As %String) As %Status { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tSC = $$$OK <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (..#DOCUMENTCLASS'="") { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tSC = $System.OBJ.Delete(..GetClassName(name)) } Quit tSC } /// Lock the class definition <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the document. Method Lock(flags As %String) As %Status { <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ..Locked <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> ..Locked=..Locked+<span class="hljs-number"><span class="hljs-number">1</span></span> Quit $$$OK <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassname = ..GetClassName(..Name) Lock +^oddDEF(tClassname):<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> '$Test Quit $$$ERROR($$$CanNotLockRoutineInfo,tClassname) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> ..Locked=<span class="hljs-number"><span class="hljs-number">1</span></span> Quit $$$OK } /// Unlock the class definition <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> the document. Method Unlock(flags As %String) As %Status { <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> '..Locked Quit $$$OK <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassname = ..GetClassName(..Name) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> ..Locked&gt;<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> ..Locked=..Locked-<span class="hljs-number"><span class="hljs-number">1</span></span> Quit $$$OK Lock -^oddDEF(tClassname) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> ..Locked=<span class="hljs-number"><span class="hljs-number">0</span></span> Quit $$$OK } /// Return the timestamp of routine 'name' <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> %TimeStamp <span class="hljs-built_in"><span class="hljs-built_in">format</span></span>. This is used to determine <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the routine has /// been updated on the server and so needs reloading from Studio. So the <span class="hljs-built_in"><span class="hljs-built_in">format</span></span> should be $zdatetime($horolog,<span class="hljs-number"><span class="hljs-number">3</span></span>), /// or "" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the routine does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exist</span></span>. ClassMethod TimeStamp(name As %String) As %TimeStamp { <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (..#DOCUMENTCLASS'="") { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> <span class="hljs-built_in"><span class="hljs-built_in">cls</span></span> = ..GetClassName(name) Quit $ZDT($$$defClassKeyGet(<span class="hljs-built_in"><span class="hljs-built_in">cls</span></span>,$$$cCLASStimechanged),<span class="hljs-number"><span class="hljs-number">3</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> { Quit "" } } /// Return <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> the routine 'name' exists and <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it does <span class="hljs-keyword"><span class="hljs-keyword">not</span></span>. ClassMethod Exists(name As %String) As %Boolean { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tExists = <span class="hljs-number"><span class="hljs-number">0</span></span> Try { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClass = ..GetClassName(name) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tExists = ##class(<span class="hljs-variable"><span class="hljs-variable">%Dictionary.ClassDefinition).%</span></span>ExistsId(tClass) } Catch ex { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tExists = <span class="hljs-number"><span class="hljs-number">0</span></span> } Quit tExists } /// Save the routine stored <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Code Method Save() As %Status { Write !,"Save: ",..Name <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tSC = $$$OK try { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassName = ..GetClassName(..Name) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassDef = ##class(<span class="hljs-variable"><span class="hljs-variable">%Dictionary.ClassDefinition).%</span></span>OpenId(tClassName) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> '$isObject(tClassDef) { <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tClassDef = ##class(<span class="hljs-variable"><span class="hljs-variable">%Dictionary.ClassDefinition).%</span></span>New() <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassDef.Name = tClassName <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tClassDef.Super = ..#DOCUMENTCLASS } <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tIndex = tClassDef.XDatas.FindObjectId(tClassName_"||XMLData") <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> tIndex'="" <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> tClassDef.XDatas.RemoveAt(tIndex) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tXDataDef = ##class(<span class="hljs-variable"><span class="hljs-variable">%Dictionary.XDataDefinition).%</span></span>New() <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tXDataDef.Name = "XMLData" <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tXDataDef.XMLNamespace = ..#NAMESPACE <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tXDataDef.parent = tClassDef <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> ..Rewind() <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> tXDataDef.Data.CopyFrom($this) <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> tSC = tClassDef.%Save() } catch ex { } Quit tSC } Query List(Directory As %String, Flat As %Boolean, System As %Boolean) As %Query(ROWSPEC = "name:<span class="hljs-variable"><span class="hljs-variable">%String,modified:%</span></span>TimeStamp,size:<span class="hljs-variable"><span class="hljs-variable">%Integer,directory:%</span></span>String") [ SqlProc ] { } ClassMethod ListExecute(ByRef qHandle As %Binary, Directory As %String = "", Flat As %Boolean, System As %Boolean) As %Status { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> qHandle = "" <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> Directory'="" Quit $$$OK // get list of classes <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tRS = ##class(<span class="hljs-variable"><span class="hljs-variable">%Library.ResultSet).%</span></span>New("%Dictionary.ClassDefinition:SubclassOf") <span class="hljs-keyword"><span class="hljs-keyword">Do</span></span> tRS.Execute(..#DOCUMENTCLASS) While (tRS.Next()) { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> qHandle("Classes",tRS.Data("Name")) = "" } Quit $$$OK } ClassMethod ListFetch(ByRef qHandle As %Binary, ByRef Row As %List, ByRef AtEnd As %Integer = <span class="hljs-number"><span class="hljs-number">0</span></span>) As %Status [ PlaceAfter = ListExecute ] { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> qHandle = $O(qHandle("Classes",qHandle)) <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (qHandle '= "") { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> tTime = $ZDT($$$defClassKeyGet(qHandle,$$$cCLASStimechanged),<span class="hljs-number"><span class="hljs-number">3</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> Row = $LB(qHandle _ ..#EXTENSION,tTime,,"") <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> AtEnd = <span class="hljs-number"><span class="hljs-number">0</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">Else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> Row = "" <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> AtEnd = <span class="hljs-number"><span class="hljs-number">1</span></span> } Quit $$$OK } /// Return other document types that this is related to. /// Passed a name and you return a comma separated list of the other documents it is related to /// or "" <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> it is <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> related to anything&lt;br&gt; /// Subclass should override this behavior <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> non-class based editors. ClassMethod GetOther(Name As %String) As %String { <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> (..#DOCUMENTCLASS="") { // no related item Quit "" } <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> result = "",tCls=..GetClassName(Name) // This changes with MAK1867 <span class="hljs-keyword"><span class="hljs-keyword">If</span></span> $$$defClassDefined(tCls),..Exists(Name) { <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span>:result'="" result=result_"," <span class="hljs-built_in"><span class="hljs-built_in">Set</span></span> result = result _ tCls _ ".<span class="hljs-built_in"><span class="hljs-built_in">cls</span></span>" } Quit result } }</code> </pre> </div></div><br>  After that, it is possible to select our new file type * .rule, and select the file that is actually selected as a successor to our template class, which compiles our XML. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/23e/e4e/449/23ee4e449a07412a9cee81bf00c6c3f3.png" alt="image"></div><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/7dc/1c1/7ef/7dc1c17ef65642419e8eb7fb641e84f0.png" alt="image"></a> </div><br>  If another code is displayed in the XML editing mode, the same class will be displayed.  In this way, we were able to edit only one XML, and at the output we get working code ready for the rules. <br><br><h2>  Atelier </h2><br>  Studio is no longer the only official Cach√© development environment.  Now we have Atelier.  How about supporting such features in Atelier?  So far there is no such support, just as there is no information about when it will appear and whether it will appear at all in the future.  This applies to both autocompletion and native file types.  But Atelier was developed on the Eclipse platform, respectively, this feature can be realized not only in InterSystems and added as a plugin. </div><p>Source: <a href="https://habr.com/ru/post/279579/">https://habr.com/ru/post/279579/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279567/index.html">Universal script to switch 2 Internet channels Mikrotik</a></li>
<li><a href="../279569/index.html">How to make an automatic snapshot of your site when it fell</a></li>
<li><a href="../279571/index.html">IBM introduced the new z13s hybrid cloud mainframe.</a></li>
<li><a href="../279573/index.html">DroidShoter - screenshots of the application at different screen resolutions, using one device and Adb</a></li>
<li><a href="../279577/index.html">Why did Citrix not become the ‚Äúnew Red Hat‚Äù in the virtualization market? Part 1</a></li>
<li><a href="../279585/index.html">Full-text fuzzy search using the Wagner-Fisher algorithm</a></li>
<li><a href="../279587/index.html">Game Industry Digest: February</a></li>
<li><a href="../279589/index.html">Free Cluster (Proxmox + Nexenta)</a></li>
<li><a href="../279591/index.html">Our experience of using photogrammetry in the development of a computer game (Part 1)</a></li>
<li><a href="../279595/index.html">L10n lines in applications (javascript)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>