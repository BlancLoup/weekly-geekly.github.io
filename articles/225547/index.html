<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Record video from Google Street View</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago, the topic of the Hyperlapse / time-lapse video became popular. First of all, thanks to the well-known resource http://hyperlapse.tllabs...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Record video from Google Street View</h1><div class="post__text post__text-html js-mediator-article">  Some time ago, the topic of the Hyperlapse / time-lapse video became popular.  First of all, thanks to the well-known resource <a href="http://hyperlapse.tllabs.io/">http://hyperlapse.tllabs.io/</a> <br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/63653873&amp;xid=17259,15700023,15700186,15700191,15700253&amp;usg=ALkJrhgXHjxH66JHrBs_Kdg5MBEbAnAZCA" width="560" height="315" frameborder="0" title="Google Street View Hyperlapse" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br>  The opportunity itself is certainly wonderful, but the site does not allow saving the results of experiments in the form of videos.  It was decided to fix this annoying nuisance, and not just fix it, but implement it in the form of a program for iOS, thereby helping to turn the iPhone or iPad into a device for creating, rather than consuming, content. <br><a name="habracut"></a>  How things are arranged <br>  So, today we have several resources to shoot Street Videos.  First of all, it is <a href="http://hyperlapse.tllabs.io/">hyperlapse.tllabs.io</a> , which allows you to mark 2 points, pave a route between them and enjoy looped animation. <br><img src="https://habrastorage.org/getpro/habr/post_images/e79/f19/e74/e79f19e74464071fb7ea155e43ac4f21.png" alt="image"><br>  The second site that allows you to watch a street video is <a href="http://track-kit.net/">http://track-kit.net</a> <br><img src="https://habrastorage.org/getpro/habr/post_images/427/81c/da5/42781cda5156e191e4496fd4cc9505c5.png" alt="image"><br>  This site allows you to view videos for created or imported tracks.  Despite the fact that Street Video is not the main function here, you can generate a direct link to the video for the tech.  For example, such: <br>  <a href="http://track-kit.net/maps_s3/index.php%3Ftrack%3D8821.gpx%26svv%3D134">http://track-kit.net/maps_s3/index.php?track=8821.gpx&amp;svv=134</a> <br>  True, on my Mac, it works more or less only in Chrome. <br><br>  However, none of these resources allows you to save videos.  We are going to solve this problem now. <br>  To prepare the video, we need to solve several problems. <br><ol><li>  Get a route from point A to point B. It is advisable to display the accessibility of the Google Street View. </li><li>  Upload panorama shots </li><li>  To enable the user to edit the panoramas, for example, by pointing the camera at any object. </li><li>  Generate video from a set of frames </li><li>  Solve a number of typical iOS problems. </li></ol><br><br><h5>  Plot a route </h5><br>  For this we use the <a href="https://developers.google.com/maps/documentation/ios/releases">Google Maps SDK for iOS</a> and the <a href="https://developers.google.com/maps/documentation/directions/">Google direction API</a> <br>  Using the Google direction API, we ask Google for a set of points between the initial and, of course, waypoints in encoded form. <br>  The Google Maps SDK for iOS (class GMSPath) will be needed to translate a coded list of points that we received from Google in latitude and longitude. <br>  AFNetworking is used to communicate with Google. <br><pre><code class="objectivec hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *kLWSDirectionsURL = <span class="hljs-string"><span class="hljs-string">@"http://maps.googleapis.com/maps/api/directions/json?"</span></span>; - (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)loadDirectionsForWaypoints:(<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)waypoints{ <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *origin = [waypoints objectAtIndex:<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> waypointCount = [waypoints count]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> destinationPos = waypointCount <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *destination = [waypoints objectAtIndex:destinationPos]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *sensor = <span class="hljs-string"><span class="hljs-string">@"false"</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableString</span></span> *url = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%@&amp;origin=%@&amp;destination=%@&amp;sensor=%@"</span></span>, kLWSDirectionsURL,origin,destination, sensor]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(waypointCount&gt;<span class="hljs-number"><span class="hljs-number">2</span></span>) { [url appendString:<span class="hljs-string"><span class="hljs-string">@"&amp;waypoints=optimize:true"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> wpCount = waypointCount<span class="hljs-number"><span class="hljs-number">-2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>;i&lt;wpCount;i++){ [url appendString: <span class="hljs-string"><span class="hljs-string">@"|"</span></span>]; [url appendString:[waypoints objectAtIndex:i]]; } } url = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableString</span></span> stringWithString:[url stringByAddingPercentEscapesUsingEncoding: <span class="hljs-built_in"><span class="hljs-built_in">NSASCIIStringEncoding</span></span>]]; _directionsURL = [<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> URLWithString:url]; [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> startDownloadDataForURL:_directionsURL]; } AFHTTPRequestOperation *requestOperation; <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>* coordinatesArr; -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)startDownloadDataForURL:(<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span>*)url{ [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> stopLoadingForUserInfo:userInfo]; requestOperation = [manager GET:[url absoluteString] parameters:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> responseObject) { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* status = [responseObject objectForKey:<span class="hljs-string"><span class="hljs-string">@"status"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span>* routesArr = [responseObject objectForKey:<span class="hljs-string"><span class="hljs-string">@"routes"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([status isEqualToString:<span class="hljs-string"><span class="hljs-string">@"OK"</span></span>] &amp;&amp; [routesArr count] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *routes = [responseObject objectForKey:<span class="hljs-string"><span class="hljs-string">@"routes"</span></span>][<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *route = [routes objectForKey:<span class="hljs-string"><span class="hljs-string">@"overview_polyline"</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *overview_route = [route objectForKey:<span class="hljs-string"><span class="hljs-string">@"points"</span></span>]; GMSPath *path = [GMSPath pathFromEncodedPath:overview_route]; coordinatesArr = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> array]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; [path count]; ++i) { <span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span> coord = [path coordinateAtIndex:i]; [coordinatesArr addObject:[<span class="hljs-built_in"><span class="hljs-built_in">NSValue</span></span> valueWithMKCoordinate:coord]]; } } } failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { }]; }</code> </pre> <br>  If the download was successful in the coordinatesArr list, we store a set of coordinates of points on our path. <br>  PS The Google direction API has 1 nuance - if you need to route a route not through 2, but say, through 20 points, you will have to make several requests for the waypoint intervals, as if you send a large number of intermediate points through the ‚Äú&amp; waypoints‚Äù, Google can return error. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  We load panoramas </h5><br>  To download a panorama, you can use a query like <a href="http://cbk0.google.com/cbk%3Foutput%3Djson%26ll%3Dlatitude">cbk0.google.com/cbk?output=json&amp;ll=latitude</a> , longitude <br>  It will return information about the closest panorama with latitude, longitude coordinates. <br>  The most important thing is that we can get this ‚ÄúpanoId‚Äù - the id of the panorama we need (in addition to panoID, we can also get information about the pan offset angles, which can be useful if you need to rotate the panorama in a certain direction): <br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* panoID; -(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)loadMyWebViewForCoord:(<span class="hljs-built_in"><span class="hljs-built_in">CLLocationCoordinate2D</span></span>)arg{ <span class="hljs-keyword"><span class="hljs-keyword">@try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!manager) { manager = [AFHTTPRequestOperationManager manager]; } <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* urlStr = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"http://cbk0.google.com/cbk?output=json&amp;ll=%f,%f"</span></span>,arg.latitude,arg.longitude]; request = [manager GET:urlStr parameters:<span class="hljs-literal"><span class="hljs-literal">nil</span></span> success:^(AFHTTPRequestOperation *operation, <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> responseObject) { <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> location = [responseObject objectForKey:<span class="hljs-string"><span class="hljs-string">@"Location"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> projection = [responseObject objectForKey:<span class="hljs-string"><span class="hljs-string">@"Projection"</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location &amp;&amp; projection) { panoID = [location objectForKey:@¬´panoId¬ª]; } } failure:^(AFHTTPRequestOperation *operation, <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error) { }]; }</code> </pre><br>  Further, using the obtained panorama ID, we can, via the request: <br>  <a href="http://cbk0.google.com/cbk%3Foutput%3Dtile%26panoid%3Dpanoid%26zoom%3Dzoom%26x%3Dx%26y%3Dy">cbk0.google.com/cbk?output=tile&amp;panoid=panoid&amp;zoom=zoom&amp;x=x&amp;y=y</a> <br>  get the panorama tiles we need, where panoId is the panorama identifier obtained earlier, zoom is the panorama scale (its size), x and y are the vertical and horizontal panorama tile numbers, and the number of panorama tiles depends on the zoom we entered.  For example, if we choose zoom = 3, then the panorama will consist of 7 tiles in width and 3 in height. <br>  That is, to get the whole panorama we need to load all the tiles: <br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)loadImagesForPanoPoint:(PanoPoint*)currentPanoPointArg { <span class="hljs-keyword"><span class="hljs-keyword">@try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> zoom; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxX; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxY; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([StreetViewSettings instance].hiQualityPano) { zoom = <span class="hljs-number"><span class="hljs-number">3</span></span>; maxX = <span class="hljs-number"><span class="hljs-number">7</span></span>; maxY = <span class="hljs-number"><span class="hljs-number">3</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { zoom = <span class="hljs-number"><span class="hljs-number">2</span></span>; maxX = <span class="hljs-number"><span class="hljs-number">4</span></span>; maxY = <span class="hljs-number"><span class="hljs-number">2</span></span>; } __block <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> allImages = maxX; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> x = <span class="hljs-number"><span class="hljs-number">0</span></span>; x &lt; maxX; ++x) { <span class="hljs-built_in"><span class="hljs-built_in">dispatch_async</span></span>(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, <span class="hljs-number"><span class="hljs-number">0</span></span>), ^{ <span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span>* imForCurrentCoodY = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> array]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> y = <span class="hljs-number"><span class="hljs-number">0</span></span>; y &lt; maxY; ++y) { <span class="hljs-keyword"><span class="hljs-keyword">@autoreleasepool</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* pathStr = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"http://cbk0.google.com/cbk?output=tile&amp;panoid=%@&amp;zoom=%d&amp;x=%d&amp;y=%d"</span></span>,currentPanoPointArg.panoID,zoom,x,y]; <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* tempDirectory = <span class="hljs-built_in"><span class="hljs-built_in">NSTemporaryDirectory</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>* imPath = [<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> stringWithFormat:<span class="hljs-string"><span class="hljs-string">@"%@/panoLoadCash/%@zoom=%dx=%dy=%d_%d"</span></span>,tempDirectory,currentPanoPointArg.panoID,zoom,x,y,currentCoordArrIndex]; <span class="hljs-built_in"><span class="hljs-built_in">NSData</span></span>* im = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span>* fM = [<span class="hljs-built_in"><span class="hljs-built_in">NSFileManager</span></span> defaultManager]; <span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span> isD; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![fM fileExistsAtPath:imPath isDirectory:&amp;isD]) { im = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> imgByPath:pathStr]; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [imForCurrentCoodY addObject:imPath]; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (im) { pakSize += im.length; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![fM fileExistsAtPath:[<span class="hljs-built_in"><span class="hljs-built_in">NSTemporaryDirectory</span></span>() stringByAppendingString:<span class="hljs-string"><span class="hljs-string">@"panoLoadCash"</span></span>] isDirectory:&amp;isD]) { <span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span>* err; [fM createDirectoryAtPath:[<span class="hljs-built_in"><span class="hljs-built_in">NSTemporaryDirectory</span></span>() stringByAppendingString:<span class="hljs-string"><span class="hljs-string">@"panoLoadCash"</span></span>] withIntermediateDirectories:<span class="hljs-literal"><span class="hljs-literal">YES</span></span> attributes:[<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> dictionary] error:&amp;err]; } [im writeToFile:imPath atomically:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>]; [imForCurrentCoodY addObject:imPath]; } } } [imForCurrentCoordV addObject:@(x)]; [imForCurrentCoordTemp addObject:imForCurrentCoodY]; --allImages; }); } }</code> </pre><br>  Thus, walking through all points of the route received from Google, we can upload panoramas for them and then display them to the user in the form of a video. <br><br><h5>  We generate video </h5><br>  For this we need the AVFoundation library: <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;AVFoundation/AVFoundation.h&gt;</span></span></span></span></code> </pre><br>  From there we take only 3 classes: <br>  <a href="https://developer.apple.com/library/ios/documentation/AVFoundation/Reference/AVAssetWriter_Class/Reference/Reference.html">AVAssetWriter</a> - write media data to file <br>  <a href="https://developer.apple.com/library/ios/documentation/AVFoundation/Reference/AVAssetWriterInput_Class/Reference/Reference.html">AVAssetWriterInput</a> - Adds a media packet to the AVAssetWriter to write to the file. <br>  <a href="https://developer.apple.com/library/ios/documentation/AVFoundation/Reference/AVAssetWriterInputPixelBufferAdaptor_Class/Reference/Reference.html">AVAssetWriterInputPixelBufferAdaptor</a> - provides a video data pack (CVPixelBuffer) for AVAssetWriterInput <br>  Accordingly, we need to define them somewhere: <br><pre> <code class="objectivec hljs"> <span class="hljs-built_in"><span class="hljs-built_in">AVAssetWriter</span></span>* videoWriter; <span class="hljs-built_in"><span class="hljs-built_in">AVAssetWriterInput</span></span>* writerInput; <span class="hljs-built_in"><span class="hljs-built_in">AVAssetWriterInputPixelBufferAdaptor</span></span>* adaptor;</code> </pre><br>  Next, initialization: <br><pre> <code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSError</span></span> *error = <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; videoWriter = [[<span class="hljs-built_in"><span class="hljs-built_in">AVAssetWriter</span></span> alloc] initWithURL:[<span class="hljs-built_in"><span class="hljs-built_in">NSURL</span></span> fileURLWithPath:videoPath] fileType:<span class="hljs-built_in"><span class="hljs-built_in">AVFileTypeQuickTimeMovie</span></span> error:&amp;error]; <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *videoSettings = [[<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> alloc] initWithObjectsAndKeys: <span class="hljs-built_in"><span class="hljs-built_in">AVVideoCodecH264</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">AVVideoCodecKey</span></span>, [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithInt:videoSize.width], <span class="hljs-built_in"><span class="hljs-built_in">AVVideoWidthKey</span></span>, [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithInt:videoSize.height], <span class="hljs-built_in"><span class="hljs-built_in">AVVideoHeightKey</span></span>, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; writerInput = [<span class="hljs-built_in"><span class="hljs-built_in">AVAssetWriterInput</span></span> assetWriterInputWithMediaType:<span class="hljs-built_in"><span class="hljs-built_in">AVMediaTypeVideo</span></span> outputSettings:videoSettings]; adaptor = [<span class="hljs-built_in"><span class="hljs-built_in">AVAssetWriterInputPixelBufferAdaptor</span></span> assetWriterInputPixelBufferAdaptorWithAssetWriterInput:writerInput sourcePixelBufferAttributes:<span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; [videoWriter addInput:writerInput]; [videoWriter startWriting]; [videoWriter startSessionAtSourceTime:kCMTimeZero]</code> </pre><br>  After that, everything is ready to record video. <br>  AVAssetWriterInput has a function: <br>  <a href="https://developer.apple.com/library/mac/documentation/AVFoundation/Reference/AVAssetWriterInput_Class/Reference/Reference.html">(void) requestMediaDataWhenReadyOnQueue: (dispatch_queue_t) queue usingBlock: (void (^) (void)) block</a> <br>  Which, causes Block every time a new piece of data is needed. <br><pre> <code class="objectivec hljs">[writerInput requestMediaDataWhenReadyOnQueue:assetWriterQueue usingBlock:^ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (buffer == <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { CVPixelBufferPoolCreatePixelBuffer (<span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, adaptor.pixelBufferPool, &amp;buffer); } <span class="hljs-built_in"><span class="hljs-built_in">UIImage</span></span> *image = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> imageForIndex:currentIndexForBuff]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (image) { buffer = [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> pixelBufferFromCGImage:image.CGImage]; <span class="hljs-built_in"><span class="hljs-built_in">CMTime</span></span> presentationTime= <span class="hljs-built_in"><span class="hljs-built_in">CMTimeMakeWithSeconds</span></span>(speed*currentIndexForBuff, <span class="hljs-number"><span class="hljs-number">33</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (![adaptor appendPixelBuffer:buffer withPresentationTime:presentationTime]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> finishVideo]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } CVPixelBufferRelease(buffer); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentIndexForBuff &lt; imagesPathsForVideo.count) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> finishVideo]; } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentIndexForBuff &lt; imagesPathsForVideo.count) { } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> finishVideo]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } ++currentIndexForBuff; }];</code> </pre><br>  Video playback speed is controlled by the presentationTime variable, which indicates the frame time in the output file. <br>  UIImage * image is the current frame <br>  When all frames are recorded in a video, we inform videoWriter and writerInput about the need to stop recording video: <br><pre> <code class="objectivec hljs">-(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)finishVideo { [writerInput markAsFinished]; [videoWriter finishWritingWithCompletionHandler:^(){}]; }</code> </pre><br>  The function to get CVPixelBufferRef from the image: <br><pre> <code class="objectivec hljs">- (CVPixelBufferRef) pixelBufferFromCGImage: (<span class="hljs-built_in"><span class="hljs-built_in">CGImageRef</span></span>) image { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (image) { <span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *options = [[<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> alloc] initWithObjectsAndKeys: [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithBool:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>], kCVPixelBufferCGImageCompatibilityKey, [<span class="hljs-built_in"><span class="hljs-built_in">NSNumber</span></span> numberWithBool:<span class="hljs-literal"><span class="hljs-literal">YES</span></span>], kCVPixelBufferCGBitmapContextCompatibilityKey, <span class="hljs-literal"><span class="hljs-literal">nil</span></span>]; CVPixelBufferRef pxbuffer = <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>; CVPixelBufferCreate(kCFAllocatorDefault, <span class="hljs-built_in"><span class="hljs-built_in">CGImageGetWidth</span></span>(image), <span class="hljs-built_in"><span class="hljs-built_in">CGImageGetHeight</span></span>(image), kCVPixelFormatType_32ARGB, (__bridge <span class="hljs-built_in"><span class="hljs-built_in">CFDictionaryRef</span></span>) options, &amp;pxbuffer); CVPixelBufferLockBaseAddress(pxbuffer, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> *pxdata = CVPixelBufferGetBaseAddress(pxbuffer); <span class="hljs-built_in"><span class="hljs-built_in">CGColorSpaceRef</span></span> rgbColorSpace = <span class="hljs-built_in"><span class="hljs-built_in">CGColorSpaceCreateDeviceRGB</span></span>(); <span class="hljs-built_in"><span class="hljs-built_in">CGContextRef</span></span> context = <span class="hljs-built_in"><span class="hljs-built_in">CGBitmapContextCreate</span></span>(pxdata, <span class="hljs-built_in"><span class="hljs-built_in">CGImageGetWidth</span></span>(image), <span class="hljs-built_in"><span class="hljs-built_in">CGImageGetHeight</span></span>(image), <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>*<span class="hljs-built_in"><span class="hljs-built_in">CGImageGetWidth</span></span>(image), rgbColorSpace, kCGImageAlphaNoneSkipFirst); <span class="hljs-built_in"><span class="hljs-built_in">CGContextDrawImage</span></span>(context, <span class="hljs-built_in"><span class="hljs-built_in">CGRectMake</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">CGImageGetWidth</span></span>(image), <span class="hljs-built_in"><span class="hljs-built_in">CGImageGetHeight</span></span>(image)), image); <span class="hljs-built_in"><span class="hljs-built_in">CGColorSpaceRelease</span></span>(rgbColorSpace); <span class="hljs-built_in"><span class="hljs-built_in">CGContextRelease</span></span>(context); CVPixelBufferUnlockBaseAddress(pxbuffer, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pxbuffer; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span>; } }</code> </pre><br><br><h5>  Work in the background </h5><br>  For the video to continue to be generated when our application is in the background, you can use the <a href="https://developer.apple.com/library/ios/documentation/UIKit/Reference/UIApplication_Class/Reference/Reference.html">long-running background task</a> for this I advise you to use a good class <br>  <a href="https://github.com/vaskravchuk/VideoMaker/">https://github.com/vaskravchuk/VideoMaker/</a> <br><br>  Adding a few options, we get such a software product. <br>  <a href="https://itunes.apple.com/us/app/street-video-maker-free-create/id788610126%3Fmt%3D8">itunes.apple.com/us/app/street-video-maker-free-create/id788610126?mt=8</a> <br><img src="http://habrastorage.org/files/10e/2a9/318/10e2a93184a04a35ac7c298c679f859e.png" alt="image"><br>  Here is an example of a video created with this program: <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/yMokyIe31mU%3Ffeature%3Doembed&amp;xid=17259,15700023,15700186,15700191,15700253&amp;usg=ALkJrhiMcaFwyWBOzhwWHCrXFkRaWHXhzw" frameborder="0" allowfullscreen=""></iframe><br>  One of the interesting uses of street video was the late 360 ‚Äã‚Äã¬∞ Langstrasse site.  From which the rest is only video: <br><iframe src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/33529166&amp;xid=17259,15700023,15700186,15700191,15700253&amp;usg=ALkJrhjB8zbEQUmVHwtne2cX2AjRfFPNdA" width="420" height="315" frameborder="0" title="360 ¬∞ Langstrasse" webkitallowfullscreen="" mozallowfullscreen="" allowfullscreen=""></iframe><br>  With this technology, you can create interesting augmented reality projects, conduct geographical surveys and, of course.  Have fun.  Lastly, a little bit of a professional Time-lapse from Gunther Wegner <br><video>  http://vimeo.com/50238512 </video></div><p>Source: <a href="https://habr.com/ru/post/225547/">https://habr.com/ru/post/225547/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../225533/index.html">Samsung Introduces New 845DC EVO SSD Series</a></li>
<li><a href="../225535/index.html">Released record long-term software, created 54 years</a></li>
<li><a href="../225537/index.html">DevConf :: Mobi - as early as next week on June 14, a section program was formed</a></li>
<li><a href="../225539/index.html">How IPv6 helps routers break</a></li>
<li><a href="../225543/index.html">How to develop secure applications for Android. Yandex Workshop</a></li>
<li><a href="../225549/index.html">On bang to Jupiter</a></li>
<li><a href="../225551/index.html">Updated HTTP / 1.1</a></li>
<li><a href="../225553/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ112 (June 1 - 7, 2014)</a></li>
<li><a href="../225555/index.html">We increase conversion in the form of payment with the help of visual improvement of fields</a></li>
<li><a href="../225557/index.html">STAN is the shortest template engine.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>