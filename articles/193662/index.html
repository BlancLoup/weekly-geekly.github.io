<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sharing SAML 2.0 SSO Integration Experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="1. Background 
 Despite the fact that the Single Sign On (SSO) function exists, it has been discussed and used for a long time, in practice its implem...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sharing SAML 2.0 SSO Integration Experience</h1><div class="post__text post__text-html js-mediator-article"><h5>  1. Background </h5><br>  Despite the fact that the Single Sign On (SSO) function exists, it has been discussed and used for a long time, in practice its implementation is often accompanied by overcoming a variety of problems.  The goal of this article will be to show how to implement the simplest native Service Provider <sup>1</sup> (SP) for SAML 2.0 identity provider (idP) and use it to integrate SSO into a Java Web application. <br><br>  One of our recent projects was the preparation and clustering of a portal solution for a large university.  As part of the project, we are faced with the task of implementing (and also clustering) a single authentication function for the following systems: <br><br><ol><li>  Liferay version 6.1.20-ee-ga2. </li><li>  A simple java web application. </li><li>  Google apps. </li></ol><br>  <u>From the customer‚Äôs side, the main requirements for building SSO were put forward:</u> <br><ol><li>  To build SSO, the SAML 2.0 protocol must be used. </li><li>  Integration with Jasig CAS is required to keep existing systems running. </li><li>  LDAP is used to verify user authentication. </li></ol><br>  As idP, we decided to use Shibboleth ( <a href="http://shibboleth.net/about/index.html">http://shibboleth.net/about/index.html</a> ) as an open source system that fully implements SAML 1.0 &amp;&amp; SAML 2.0 protocols. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <u>Difficult moments that we encountered in solving this problem:</u> <br><br><ol><li>  Lack of expertise on working with the SAML 2.0 protocol and the Shibboleth product. </li><li>  The raw and not yet well-structured Shibboleth documentation from the manufacturer. </li><li>  Lack of quality examples on the implementation of a Service Provider to integrate SSO into its Java Web application. </li></ol><br>  Overcoming these barriers has become the motivation for publishing this article.  We want to share the acquired knowledge, help developers solve such problems, and also facilitate familiarity with the SAML 2.0 protocol. <br><br><h5>  2. Who is the article for? </h5><br>  This article is aimed at the following audience: <br><ol><li>  Developers integrating the SSO feature in their projects using SAML 2.0. </li><li>  Java developers who need a practical example of integrating SSO into their application using SAML 2.0. </li><li>  Java developers who want to try out Shibboleth components as SSO Identity Provider (idP). </li></ol><br>  To understand the article, it is recommended to have minimal knowledge of the SAML 2.0 protocol. <br><br><a name="habracut"></a><h5>  3. Main components of SSO operation </h5><br>  The diagram below shows the general operation of our centralized entrance. <br><br><img src="https://habrastorage.org/storage3/119/21a/068/11921a06890ecf800d67d1b6d6c2e024.png"><br><br>  The main components and points noted in the diagram: <br><ol><li>  2 applications participate in the SSO system: <br>  a.  Java Web App - A Normal Java Web Application <br>  b.  Google Apps is an application from Google cloud services.  We will use it only to test the operation of SSO. </li><li>  SP Filter is an implementation of a Service Provider whose function will be to interact with Shibboleth idP means of sending and parsing SAML 2.0 messages </li><li>  Shibboleth idP is an application for authentication and authorization using SAML 1.0 and SAML 2.0. </li><li>  Tomcat AS - Java Application Server. </li><li>  The interaction between SP filter and Shibboleth idP occurs via a secure HTTPS protocol. </li></ol><br>  Note: In the Shibboleth idP diagram and the Java Web application are physically separated into different Tomcat servers.  However, you can deploy the environment on a single network node using just one Tomcat instance. <br><br><h5>  4. Configure the environment for Shibboleth idP </h5><br><h6>  Install and configure shibboleth idP: </h6><br>  1. Download the latest version of idP here <a href="http://shibboleth.net/downloads/identity-provider/latest/">shibboleth.net/downloads/identity-provider/latest</a> <sup>2</sup> and unzip <i>$ shDistr</i> to an arbitrary place. <br>  2. Check that the JAVA_HOME variable is set correctly <sup>3</sup> . <br>  Run <i>$ shDistr / install.sh</i> (we will assume that you are using a UNIX-like operating system).  <sup>four</sup> <br><br>  The installer will request the following information to keep in mind: <br><ul><li>  installation path (for example: / opt / shib) </li><li>  idP server name (for example: idp.local.ru). <br><br>  <b>Add the idP server to the list of aliases for localhost in the / etc / hosts file:</b> <br>  127.0.0.1 localhost idp.local.ru </li><li>  password for java key store, which is generated during the installation process (for example: 12345). </li></ul><br>  Further we check that the installation process is successfully completed. <br><br>  We introduce the notation: <br><br><ul><li>  <i>$ shHome</i> - directory where Shibboleth was installed; </li><li>  <i>$ shHost</i> - idP server name; </li><li>  <i>$ shPassword</i> - password for java key store (JKS). </li></ul><br>  3. Determine which attributes and from which sources idP will be extracted.  In our case, we will transfer the user login.  Add the attribute description to the <i>$ shHome / conf / attribute-resolver.xml</i> file after the &lt;resolver: AttributeDefinition id = "transientId" xsi: type = "ad: TransientId"&gt; element. <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resolver:AttributeDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"PrincipalName"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:mace:shibboleth:2.0:resolver:ad"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userLogin"</span></span></span><span class="hljs-tag"> &gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resolver:AttributeEncoder</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SAML1String"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:mace:shibboleth:2.0:attribute:encoder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userLogin"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resolver:AttributeEncoder</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SAML2String"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:mace:shibboleth:2.0:attribute:encoder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userLogin"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resolver:AttributeDefinition</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  <i>Note: in the same file, you can configure the retrieval of attributes from various data sources such as LDAP or DBMS via JDBC.</i>  <i>Read more here <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/IdPAddAttribute">https://wiki.shibboleth.net/confluence/display/SHIB2/IdPAddAttribute</a> .</i> <br><br>  4. In order for idP to give this SAML SP attribute to the filter, we describe it in the <i>$ shHome / conf / attribute-filter.xml file</i> . <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">afp:AttributeFilterPolicy</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"releaseUserLoginToAnyone"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">afp:PolicyRequirementRule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"basic:ANY"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">afp:AttributeRule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">attributeID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userLogin"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">afp:PermitValueRule</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"basic:ANY"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">afp:AttributeRule</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">afp:AttributeFilterPolicy</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <i>Note: Here you can set a more complex and correct rule.</i>  <i>For example, you can specify that this attribute is transmitted only to a specific SAML SP.</i> <br><br>  5. Our Shibboleth idP should know about the nodes with which it can interact - the so-called relying party ( <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/IdPUnderstandingRP">https://wiki.shibboleth.net/confluence/display/SHIB2/IdPUnderstandingRP</a> ).  This information is stored in the <i>$ shHome / conf / relying-party.xml file</i> . <br>  Open the file and add the following element to it: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rp:RelyingParty</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sp.local.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">provider</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://idp.local.ru/idp/shibboleth"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">defaultSigningCredentialRef</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"IdPCredential"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rp:ProfileConfiguration</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"saml:SAML2SSOProfile"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">signResponses</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"never"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">signAssertions</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"never"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">encryptNameIds</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"never"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">encryptAssertions</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"never"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">rp:RelyingParty</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Here we indicate that for SP with id = "sp.local.ru" idP will be used with id = " <a href="https://idp.local.ru/idp/shibboleth">https://idp.local.ru/idp/shibboleth</a> ". <br><br>  <b>Add SP to the list of aliases for localhost in the / etc / hosts file:</b> <br>  127.0.0.1 localhost sp.local.ru <br><br>  We also instruct shibboleth idP not to sign SAML 2.0 responses and a set of assertions.  Up to the current time, our shibboleth idP had no idea what the component with id = "sp.local.ru" was.  Time to fix this moment.  We go to the next step. <br><br>  6. Add a description of our SAML 2.0 SP filter.  To do this, in the <i>$ shHome / conf / relying-party.xml file, we</i> define the meta information for our SP, next to the &lt;metadata: MetadataProvider element id = "IdPMD" xsi: type = "metadata: FilesystemMetadataProvider" ...&gt; <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">metadata:MetadataProvider</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"spMD"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"metadata:FilesystemMetadataProvider"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">metadataFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/opt/shib/metadata/saml-sp-metadata.xml"</span></span></span><span class="hljs-tag">/&gt;</span></span></code> </pre><br>  We instructed shibboleth idP to look for the SP definition in the /opt/shib/metadata/saml-sp-metadata.xml file.  Create this file with the following content: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:EntityDescriptor</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:md</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:metadata"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">entityID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sp.local.ru"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SPSSODescriptor</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AuthnRequestsSigned</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sp.local.ru"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocolSupportEnumeration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:protocol"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:AssertionConsumerService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Binding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://sp.local.ru:8443/sso/acs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">index</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">isDefault</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:SPSSODescriptor</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">md:EntityDescriptor</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Here you need to understand the following: <br><br><ul><li>  Our SAML 2.0 SP has an identifier "sp.local.ru" </li><li>  The address at which shibboleth idP will return SAML 2.0 messages <i>Location = " <a href="https://sp.local.ru:8443/sso/acs">https://sp.local.ru:8443/sso/acs</a> "</i> is specified in the md element: AssertionConsumerService. </li><li>  Finally, the Binding = parameter ‚Äúurn: oasis: names: tc: SAML: 2.0: bindings: HTTP-POST‚Äù indicates that the SP response will be sent from shibboleth idP via a redirect of the browser. </li></ul><br>  7. It remains to choose the way in which shibboleth idP will perform real user authentication.  In the production environment there can be a variety of configurations, including authentication via LDAP, DBMS and even CAS.  Here, as they say, the taste and color.  We will use the already enabled Remote User Authentication mechanism ( <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/IdPAuthRemoteUser">https://wiki.shibboleth.net/confluence/display/SHIB2/IdPAuthRemoteUser</a> ).  When receiving a shibboleth idP authentication request, it will look in the context of the REMOTE_USER variable.  If there is such a variable, then shibboleth idP will assume that the user has already been authenticated through the external system (for example, through the Apache Web server).  In order not to complicate this article, we decided to go for the trick and set the variable REMOTE_USER artificially for each request. <br>  This will be done in the next section when configuring Tomcat AS (step 7). <br><br>  Shibboleth setup is complete, congratulations :) <br><br><h5>  Install and configure Tomcat for shibboleth idP: </h5><br><ol><li>  Download tomkat 6 <a href="http://tomcat.apache.org/download-60.cgi">http://tomcat.apache.org/download-60.cgi</a> , unzip it into an arbitrary <i>$ tomcatHome</i> folder (for example: in opt / shib-tomcat). <br><br>  <b>It is important to note that currently Tomcat 7. * cannot be used when communication between SP and idP occurs directly via the SOAP protocol.</b>  <b>And although in the examples of this article we will use direct browser redirects to implement these communications, we still recommend using Tomcat version 6.</b> </li><li>  Copy the <i>$ shDistr / endorsed</i> folder into the <i>$ tomcatHome</i> folder. </li><li>  <i>We change the $ tomcatHome / bin / setenv.s</i> h <i>file</i> , set the settings for the dynamic and permanent JVM memory: <br>  JAVA_OPTS = "$ JAVA_OPTS -Xmx512m -XX: MaxPermSize = 128m" </li><li>  Download the library ( <a href="">https://build.shibboleth.net/nexus/content/repositories/releases/edu/internet2/middleware/security/tomcat6/tomcat6-dta-ssl/1.0.0/tomcat6-dta-ssl-1.0.0 .jar</a> ) to support the SOAP protocol in the process of communication between SP and idP in the <i>$ tomcatHome / lib</i> folder. <br>  Open <i>$ tomcatHome / conf / server.xml</i> and set up access to Tomcat via HTTPS. <br>  To do this, we define the following Connector element: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Connector</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">port</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"8443"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">protocol</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.apache.coyote.http11.Http11Protocol"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SSLImplementation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"edu.internet2.middleware.security.tomcat6.DelegateToApplicationJSSEmplementation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scheme</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SSLEnabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">clientAuth</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"want"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keystoreFile</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$shHome/credentials/idp.jks"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">keystorePass</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$shPassword"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  <b>Remember to replace the $ shHome and $ shPassword variables with real values</b> . </li><li>  Deploy the shibboleth idP application to Tomcat.  To do this, create a file <br>  <i>$ tomcatHome / conf / Catalina / localhost / idp.xml</i> with contents: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Context</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">docBase</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"$shHome/war/idp.war"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">privileged</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">antiResourceLocking</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">antiJARLocking</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unpackWAR</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">swallowOutput</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br><br>  Remember to replace the $ shHome variables with a real value. </li><li>  Compile <sup>5 the</sup> following class into the arbitrary library tomcat-valve.jar: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RemoteUserValve</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ValveBase</span></span></span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoteUserValve</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">invoke</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Request request, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Response response)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, ServletException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String username = <span class="hljs-string"><span class="hljs-string">"idpuser"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String credentials = <span class="hljs-string"><span class="hljs-string">"idppass"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> List&lt;String&gt; roles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;String&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Principal principal = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenericPrincipal(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, username, credentials, roles); request.setUserPrincipal(principal); getNext().invoke(request, response); } }</code> </pre><br>  Library put in the folder $ {tomcatHome} / lib.  And add the line to server.xml file <br>  &lt;Valve lassName = "ru.eastbanctech.java.web.RemoteUserValve" /&gt; inside the element <br>  &lt;Host name = "localhost" appBase = "webapps" ..&gt;.  After starting the server, when accessing any Tomcat server application, the REMOTE_USER parameter with the idpuser value will be automatically put into the context of the request. <br></li></ol><br><h5>  5. Implementing SP Filter for SAML 2.0 Protocol </h5><br>  To implement this solution, we will create a SAML 2.0 Service Provider filter whose tasks will be: <br><ol><li>  The filter skips requests for public resources for which no authentication is required. </li><li>  The filter stores information on an authenticated user in order to reduce the number of calls to Shibboleth idP. </li><li>  The filter creates a SAML 2.0 authentication request in the form of a SAML 2.0 message ( <i>AuthN</i> ) and redirects the browser to redirect the user to Shibboleth idP. </li><li>  The filter processes the response from the Shibboleth idP, and if the user authentication process is successful, the system shows the originally requested resource. </li><li>  The filter removes the local session when the user logs out of the Java Web application. </li><li>  At the same time, the session on shibboleth idP continues to be active. </li></ol><br><br>  From a technical point of view, the filter will be an implementation of the standard javax.filter.Filter interface.  The filter scope will be specified in a specific web application. <br><br>  Now that the filter functionality is clear, let's proceed to the implementation: <br>  1. Create a skeleton maven project <br>  You can do it through the mvn plugin: archetype: <br>  mvn archetype: generate -DgroupId = en.eastbanctech.java.web -DartifactId = saml-sp-filter -DarchetypeArtifactId = maven-archetype-quickstart -DinteractiveMode = false <br>  The parameters groupId and artefactId can indicate your taste and color. <br>  The structure of our project in Intellij Idea will look like this: <br><img src="http://habrastorage.org/storage3/d32/10b/1e8/d3210b1e849e5ef694f5b075aed72f28.png"><br><br>  2. Assembly file pom.xml: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span>4.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>ru.eastbanctech.web<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>saml-sp-filter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>${project.artifactId}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0-SNAPSHOT<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span>jar<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jdk.version</span></span></span><span class="hljs-tag">&gt;</span></span>1.6<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">jdk.version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">encoding</span></span></span><span class="hljs-tag">&gt;</span></span>UTF-8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">encoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.build.sourceEncoding</span></span></span><span class="hljs-tag">&gt;</span></span>${encoding}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.build.sourceEncoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.reporting.outputEncoding</span></span></span><span class="hljs-tag">&gt;</span></span>${encoding}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project.reporting.outputEncoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pluginManagement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.apache.maven.plugins<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>maven-compiler-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.5.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">encoding</span></span></span><span class="hljs-tag">&gt;</span></span>${encoding}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">encoding</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">soure</span></span></span><span class="hljs-tag">&gt;</span></span>${jdk.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">soure</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag">&gt;</span></span>${jdk.version}<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">target</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pluginManagement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.opensaml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>opensaml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.5.1-1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>javax.servlet<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>servlet-api<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span>provided<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">scope</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.slf4j<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>log4j-over-slf4j<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.7.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.slf4j<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>slf4j-api<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.7.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br>  3. The heart of our filter will be the class SAMLSPFilter: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLSPFilter</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Filter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SAML_AUTHN_RESPONSE_PARAMETER_NAME = <span class="hljs-string"><span class="hljs-string">"SAMLResponse"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(SAMLSPFilter.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FilterConfig filterConfig; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SAMLResponseVerifier checkSAMLResponse; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SAMLRequestSender samlRequestSender; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(javax.servlet.FilterConfig config)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ServletException </span></span>{ OpenSamlBootstrap.init(); filterConfig = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FilterConfig(config); checkSAMLResponse = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLResponseVerifier(); samlRequestSender = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLRequestSender(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">doFilter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain chain)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, ServletException </span></span>{ HttpServletRequest request = (HttpServletRequest) servletRequest; HttpServletResponse response = (HttpServletResponse) servletResponse; <span class="hljs-comment"><span class="hljs-comment">/*  1:  ,      2:     Shibboleth idP,    3:     logout,     4:    ,      5:  SAML        Shibboleth idP */</span></span> } }</code> </pre><br><br>  In the FilterConfig class, we define the main filter variables (filter scope, idP name, idP metadata path, SP name, etc.).  The values ‚Äã‚Äãof these parameters will be set in the Java web application's web.xml configuration file.  The checkSAMLResponse and samlRequestSender objects are needed to check the validity of SAML 2.0 messages and send an authentication request.  We will return to them later. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FilterConfig</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * The parameters below should be defined in web.xml file of Java Web Application */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String EXCLUDED_URL_PATTERN_PARAMETER = <span class="hljs-string"><span class="hljs-string">"excludedUrlPattern"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SP_ACS_URL_PARAMETER = <span class="hljs-string"><span class="hljs-string">"acsUrl"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SP_ID_PARAMETER = <span class="hljs-string"><span class="hljs-string">"spProviderId"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String SP_LOGOUT_URL_PARAMETER = <span class="hljs-string"><span class="hljs-string">"logoutUrl"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String IDP_SSO_URL_PARAMETER = <span class="hljs-string"><span class="hljs-string">"idProviderSSOUrl"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String excludedUrlPattern; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String acsUrl; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String spProviderId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String logoutUrl; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String idpSSOUrl; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FilterConfig</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(javax.servlet.FilterConfig config)</span></span></span><span class="hljs-function"> </span></span>{ excludedUrlPattern = config.getInitParameter(EXCLUDED_URL_PATTERN_PARAMETER); acsUrl = config.getInitParameter(SP_ACS_URL_PARAMETER); spProviderId = config.getInitParameter(SP_ID_PARAMETER); idpSSOUrl = config.getInitParameter(IDP_SSO_URL_PARAMETER); logoutUrl = config.getInitParameter(SP_LOGOUT_URL_PARAMETER); } <span class="hljs-comment"><span class="hljs-comment">// getters and should be defined below }  OpenSamlBootstrap      SAML 2.0 : public class OpenSamlBootstrap extends DefaultBootstrap { private static Logger log = LoggerFactory.getLogger(OpenSamlBootstrap.class); private static boolean initialized; private static String[] xmlToolingConfigs = { "/default-config.xml", "/encryption-validation-config.xml", "/saml2-assertion-config.xml", "/saml2-assertion-delegation-restriction-config.xml", "/saml2-core-validation-config.xml", "/saml2-metadata-config.xml", "/saml2-metadata-idp-discovery-config.xml", "/saml2-metadata-query-config.xml", "/saml2-metadata-validation-config.xml", "/saml2-protocol-config.xml", "/saml2-protocol-thirdparty-config.xml", "/schema-config.xml", "/signature-config.xml", "/signature-validation-config.xml" }; public static synchronized void init() { if (!initialized) { try { initializeXMLTooling(xmlToolingConfigs); } catch (ConfigurationException e) { log.error("Unable to initialize opensaml DefaultBootstrap", e); } initializeGlobalSecurityConfiguration(); initialized = true; } } }</span></span></code> </pre></div></div><br>  A set of XML files contains instructions on how to parse the elements of SAML 2.0 messages and is contained in the opensaml - *. Jar library, which will connect when building a project through maven. <br><br>  <b>STEP 1: Ignore non-filter requests</b> <br>  The parameter <i>excludedUrlPattern</i> , which encloses a regular expression.  If the requested resource falls into the <i>excludedUrlPattern</i> template, the filter does not process it: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isFilteredRequest(request)) { log.debug(<span class="hljs-string"><span class="hljs-string">"According to {} configuration parameter request is ignored + {}"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Object[]{FilterConfig.EXCLUDED_URL_PATTERN, request.getRequestURI()}); chain.doFilter(servletRequest, servletResponse); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//     ,       private boolean isFilteredRequest(HttpServletRequest request) { return !(filterConfig.getExcludedUrlPattern() != null &amp;&amp; getCorrectURL(request).matches(filterConfig.getExcludedUrlPattern())); } //       URL private String getCorrectURL(HttpServletRequest request) { String contextPath = request.getContextPath(); String requestUri = request.getRequestURI(); int contextBeg = requestUri.indexOf(contextPath); int contextEnd = contextBeg + contextPath.length(); String slash = "/"; String url = (contextBeg &lt; 0 || contextEnd == (requestUri.length() - 1)) ? requestUri : requestUri.substring(contextEnd); if (!url.startsWith(slash)) { url = slash + url; } return url; }</span></span></code> </pre><br><br>  <b>Step 2: If the answer came from Shibboleth idP, we process it</b> <br>  We are looking for the ‚ÄúSAMLResponse‚Äù parameter in the request and if it is found, it means that we received a response from the shibboleth idP to the authentication request.  Getting to the processing of SAML 2.0 messages. <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs">log.debug(<span class="hljs-string"><span class="hljs-string">"Attempt to secure resource is intercepted : {}"</span></span>, ((HttpServletRequest) servletRequest).getRequestURL().toString()); <span class="hljs-comment"><span class="hljs-comment">/* Check if response message is received from identity provider; In case of successful response system redirects user to relayState (initial) request */</span></span> String responseMessage = servletRequest.getParameter(SAML_AUTHN_RESPONSE_PARAMETER_NAME); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (responseMessage != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.debug(<span class="hljs-string"><span class="hljs-string">"Response from Identity Provider is received"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { log.debug(<span class="hljs-string"><span class="hljs-string">"Decoding of SAML message"</span></span>); SAMLMessageContext samlMessageContext = SAMLUtils.decodeSamlMessage((HttpServletRequest) servletRequest, (HttpServletResponse) servletResponse); log.debug(<span class="hljs-string"><span class="hljs-string">"SAML message has been decoded successfully"</span></span>); samlMessageContext.setLocalEntityId(filterConfig.getSpProviderId()); String relayState = getInitialRequestedResource(samlMessageContext); checkSAMLResponse.verify(samlMessageContext); log.debug(<span class="hljs-string"><span class="hljs-string">"Starting and store SAML session.."</span></span>); SAMLSessionManager.getInstance().createSAMLSession(request.getSession(), samlMessageContext); log.debug(<span class="hljs-string"><span class="hljs-string">"User has been successfully authenticated in idP. Redirect to initial requested resource {}"</span></span>, relayState); response.sendRedirect(relayState); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServletException(e); } }</code> </pre><br></div></div><br>  To do this, we decode the SAML message in the <i>SAMLUtils.decodeSamlMessage (..)</i> method, check the <i>validity of the</i> SAML assertions - <i>checkSAMLResponse.verify (..)</i> .  If all checks are performed, then create an internal SAML session <i>SAMLSessionManager.getInstance (). CreateSAMLSession (..)</i> and redirect the user to the originally requested resource <i>response.sendRedirect (..).</i> <br><br>  In the SAMLUtils class, we will place useful intermediate methods when working with SAML 2.0 messages.  One such method would be the decodeSamlMessage method, which decodes messages received via SAML 2.0 HTTPS. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLUtils</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SAMLMessageContext </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decodeSamlMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ SAMLMessageContext&lt;SAMLObject, SAMLObject, NameID&gt; samlMessageContext = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicSAMLMessageContext&lt;SAMLObject, SAMLObject, NameID&gt;(); HttpServletRequestAdapter httpServletRequestAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpServletRequestAdapter(request); samlMessageContext.setInboundMessageTransport(httpServletRequestAdapter); samlMessageContext.setInboundSAMLProtocol(SAMLConstants.SAML20P_NS); HttpServletResponseAdapter httpServletResponseAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpServletResponseAdapter(response, request.isSecure()); samlMessageContext.setOutboundMessageTransport(httpServletResponseAdapter); samlMessageContext.setPeerEntityRole(IDPSSODescriptor.DEFAULT_ELEMENT_NAME); SecurityPolicyResolver securityPolicyResolver = getSecurityPolicyResolver(request.isSecure()); samlMessageContext.setSecurityPolicyResolver(securityPolicyResolver); HTTPPostDecoder samlMessageDecoder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTTPPostDecoder(); samlMessageDecoder.decode(samlMessageContext); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> samlMessageContext; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SecurityPolicyResolver </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getSecurityPolicyResolver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isSecured)</span></span></span><span class="hljs-function"> </span></span>{ SecurityPolicy securityPolicy = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicSecurityPolicy(); HTTPRule httpRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HTTPRule(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, isSecured); MandatoryIssuerRule mandatoryIssuerRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MandatoryIssuerRule(); List&lt;SecurityPolicyRule&gt; securityPolicyRules = securityPolicy.getPolicyRules(); securityPolicyRules.add(httpRule); securityPolicyRules.add(mandatoryIssuerRule); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StaticSecurityPolicyResolver(securityPolicy); } }</code> </pre></div></div><br>  In the same class we will place an auxiliary method for converting SAML objects into String.  This will be useful when logging SAML messages. <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SAMLObjectToString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(XMLObject samlObject)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Marshaller marshaller = org.opensaml.Configuration.getMarshallerFactory().getMarshaller(samlObject); org.w3c.dom.Element authDOM = marshaller.marshall(samlObject); StringWriter rspWrt = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringWriter(); XMLHelper.writeNode(authDOM, rspWrt); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rspWrt.toString(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { e.printStackTrace(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; }</code> </pre><br>  Create a SAMLResponseVerifier class in which we place the functionality for checking SAML 2.0 messages received from shibboleth idP.  In the main verify (..) method, we implement the following checks: <br><br><ul><li>  This SAML 2.0 response from idP was preceded by a SAML 2.0 request sent by our filter. </li><li>  The message contains a positive user authentication result through shibboleth idP. </li><li>  The main statements in the SAML 2.0 response are fulfilled (the message prescription period has not expired, this message is intended for our SP, etc.). </li></ul><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLResponseVerifier</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Logger log = LoggerFactory.getLogger(SAMLResponseVerifier.class); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SAMLRequestStore samlRequestStore = SAMLRequestStore.getInstance(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(SAMLMessageContext&lt;Response, SAMLObject, NameID&gt; samlMessageContext)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SAMLException </span></span>{ Response samlResponse = samlMessageContext.getInboundSAMLMessage(); log.debug(<span class="hljs-string"><span class="hljs-string">"SAML Response message : {}"</span></span>, SAMLUtils.SAMLObjectToString(samlResponse)); verifyInResponseTo(samlResponse); Status status = samlResponse.getStatus(); StatusCode statusCode = status.getStatusCode(); String statusCodeURI = statusCode.getValue(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!statusCodeURI.equals(StatusCode.SUCCESS_URI)) { log.warn(<span class="hljs-string"><span class="hljs-string">"Incorrect SAML message code : {} "</span></span>, statusCode.getStatusCode().getValue()); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLException(<span class="hljs-string"><span class="hljs-string">"Incorrect SAML message code : "</span></span> + statusCode.getValue()); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (samlResponse.getAssertions().size() == <span class="hljs-number"><span class="hljs-number">0</span></span>) { log.error(<span class="hljs-string"><span class="hljs-string">"Response does not contain any acceptable assertions"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLException(<span class="hljs-string"><span class="hljs-string">"Response does not contain any acceptable assertions"</span></span>); } Assertion assertion = samlResponse.getAssertions().get(<span class="hljs-number"><span class="hljs-number">0</span></span>); NameID nameId = assertion.getSubject().getNameID(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (nameId == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { log.error(<span class="hljs-string"><span class="hljs-string">"Name ID not present in subject"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLException(<span class="hljs-string"><span class="hljs-string">"Name ID not present in subject"</span></span>); } log.debug(<span class="hljs-string"><span class="hljs-string">"SAML authenticated user "</span></span> + nameId.getValue()); verifyConditions(assertion.getConditions(), samlMessageContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verifyInResponseTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Response samlResponse)</span></span></span><span class="hljs-function"> </span></span>{ String key = samlResponse.getInResponseTo(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!samlRequestStore.exists(key)) { { log.error(<span class="hljs-string"><span class="hljs-string">"Response does not match an authentication request"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"Response does not match an authentication request"</span></span>); } samlRequestStore.removeRequest(samlResponse.getInResponseTo()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verifyConditions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Conditions conditions, SAMLMessageContext samlMessageContext)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SAMLException</span></span>{ verifyExpirationConditions(conditions); verifyAudienceRestrictions(conditions.getAudienceRestrictions(), samlMessageContext); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verifyExpirationConditions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Conditions conditions)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SAMLException </span></span>{ log.debug(<span class="hljs-string"><span class="hljs-string">"Verifying conditions"</span></span>); DateTime currentTime = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DateTime(DateTimeZone.UTC); log.debug(<span class="hljs-string"><span class="hljs-string">"Current time in UTC : "</span></span> + currentTime); DateTime notBefore = conditions.getNotBefore(); log.debug(<span class="hljs-string"><span class="hljs-string">"Not before condition : "</span></span> + notBefore); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((notBefore != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; currentTime.isBefore(notBefore)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLException(<span class="hljs-string"><span class="hljs-string">"Assertion is not conformed with notBefore condition"</span></span>); DateTime notOnOrAfter = conditions.getNotOnOrAfter(); log.debug(<span class="hljs-string"><span class="hljs-string">"Not on or after condition : "</span></span> + notOnOrAfter); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((notOnOrAfter != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) &amp;&amp; currentTime.isAfter(notOnOrAfter)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLException(<span class="hljs-string"><span class="hljs-string">"Assertion is not conformed with notOnOrAfter condition"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">verifyAudienceRestrictions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( List&lt;AudienceRestriction&gt; audienceRestrictions, SAMLMessageContext&lt;?, ?, ?&gt; samlMessageContext)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SAMLException</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">TODO:</span></span></span><span class="hljs-comment"> Audience restrictions should be defined below&lt;sup&gt;7&lt;/sup&gt; } }</span></span></code> </pre><br></div></div><br>  The <i>verifyInResponseTo</i> method checks that the SAML 2.0 response was preceded by a request from our filter.  For the implementation, an object of the SAMLRequestStore class is used, which stores the shibboleth idP sent by SAML 2.0. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLRequestStore</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;String&gt; samlRequestStorage = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HashSet&lt;String&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IdentifierGenerator identifierGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RandomIdentifierGenerator(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> SAMLRequestStore instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SAMLRequestStore(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SAMLRequestStore</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> SAMLRequestStore </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storeRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (samlRequestStorage.contains(key)) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RuntimeException(<span class="hljs-string"><span class="hljs-string">"SAML request storage has already contains key "</span></span> + key); samlRequestStorage.add(key); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">storeRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ String key = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { key = identifierGenerator.generateIdentifier(<span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!samlRequestStorage.contains(key)){ storeRequest(key); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> key; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">exists</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> samlRequestStorage.contains(key); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">synchronized</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String key)</span></span></span><span class="hljs-function"> </span></span>{ samlRequestStorage.remove(key); } }</code> </pre><br></div></div><br><br>  To create a local session, we will use our SAMLSessionManager class.  Its task will be to create / destroy local sessions, which is an object of the next class SAMLSessionInfo. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLSessionInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String nameId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Map&lt;String, String&gt; attributes; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Date validTo; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SAMLSessionInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String nameId, Map&lt;String, String&gt; attributes, Date validTo)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.nameId = nameId; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.attributes = attributes; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.validTo = validTo; } <span class="hljs-comment"><span class="hljs-comment">// getters should be defined below }</span></span></code> </pre><br>  In fact, the SAMLSManager class itself, which creates and destroys local SAML sessions in the Session context of the certificate, using SAMLContext. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java"</span></span></span><span class="hljs-tag">&gt;</span></span> public class SAMLSessionManager { public static String SAML_SESSION_INFO = "SAML_SESSION_INFO"; private static SAMLSessionManager instance = new SAMLSessionManager(); private SAMLSessionManager() { } public static SAMLSessionManager getInstance() { return instance; } public void createSAMLSession(HttpSession session, SAMLMessageContext<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Response,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SAMLObject</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NameID</span></span></span><span class="hljs-tag">&gt;</span></span> samlMessageContext) { List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Assertion</span></span></span><span class="hljs-tag">&gt;</span></span> assertions = samlMessageContext.getInboundSAMLMessage().getAssertions(); NameID nameId = (assertions.size() != 0 &amp;&amp; assertions.get(0).getSubject() != null) ? assertions.get(0).getSubject().getNameID() : null; String nameValue = nameId == null ? null : nameId.getValue(); SAMLSessionInfo samlSessionInfo = new SAMLSessionInfo(nameValue, getAttributesMap(getSAMLAttributes(assertions)), getSAMLSessionValidTo(assertions)); session.setAttribute(SAML_SESSION_INFO, samlSessionInfo); } public boolean isSAMLSessionValid(HttpSession session) { SAMLSessionInfo samlSessionInfo = (SAMLSessionInfo) session.getAttribute(SAML_SESSION_INFO); if (samlSessionInfo == null) return false; return samlSessionInfo.getValidTo() == null || new Date().before(samlSessionInfo.getValidTo()); } public void destroySAMLSession(HttpSession session) { session.removeAttribute(SAML_SESSION_INFO); } public List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Attribute</span></span></span><span class="hljs-tag">&gt;</span></span> getSAMLAttributes(List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Assertion</span></span></span><span class="hljs-tag">&gt;</span></span> assertions) { List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Attribute</span></span></span><span class="hljs-tag">&gt;</span></span> attributes = new ArrayList<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Attribute</span></span></span><span class="hljs-tag">&gt;</span></span>(); if (assertions != null) { for (Assertion assertion : assertions) { for (AttributeStatement attributeStatement : assertion.getAttributeStatements()) { for (Attribute attribute : attributeStatement.getAttributes()) { attributes.add(attribute); } } } } return attributes; } public Date getSAMLSessionValidTo(List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Assertion</span></span></span><span class="hljs-tag">&gt;</span></span> assertions) { org.joda.time.DateTime sessionNotOnOrAfter = null; if (assertions != null) { for (Assertion assertion : assertions) { for (AuthnStatement statement : assertion.getAuthnStatements()) { sessionNotOnOrAfter = statement.getSessionNotOnOrAfter(); } } } return sessionNotOnOrAfter != null ? sessionNotOnOrAfter.toCalendar(Locale.getDefault()).getTime() : null; } public Map<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">String,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">&gt;</span></span> getAttributesMap(List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Attribute</span></span></span><span class="hljs-tag">&gt;</span></span> attributes) { Map<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">String,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">&gt;</span></span> result = new HashMap<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">String,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">&gt;</span></span>(); for (Attribute attribute : attributes) { result.put(attribute.getName(), attribute.getDOM().getTextContent()); } return result; } }</code> </pre></div></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 3: If a logout request is received, delete the local session</font></font></b> <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (getCorrectURL(request).equals(filterConfig.getLogoutUrl())) { log.debug(<span class="hljs-string"><span class="hljs-string">"Logout action: destroying SAML session."</span></span>); SAMLSessionManager.getInstance().destroySAMLSession(request.getSession()); chain.doFilter(request, response); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }</code> </pre><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Note: It is worth noting that the session remains active on shibboleth idP and on the next request for authentication shibboleth idP will simply return us to the active session. </font><font style="vertical-align: inherit;">The implementation of the global logout requires additional configuration and up to version 2.4.0, shibboleth idP was not supported. </font><font style="vertical-align: inherit;">You can read more here </font></font><a href="https://wiki.shibboleth.net/confluence/display/SHIB2/SLOIssues"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://wiki.shibboleth.net/confluence/display/SHIB2/SLOIssues</font></font></a></i> <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Step 4: If the user is already authenticated, give access to the resource</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> If the user has an active SAML session in our filter, then we give the user this resource.</font></font><br><pre> <code class="xml hljs">if (SAMLSessionManager.getInstance().isSAMLSessionValid(request.getSession())) { log.debug("SAML session exists and valid: grant access to secure resource"); chain.doFilter(request, response); return; }</code> </pre><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Step 5: Create a SAML authentication request and send the user to </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Shibboleth idP</font></font></b> <br><br><pre> <code class="java hljs">log.debug(<span class="hljs-string"><span class="hljs-string">"Sending authentication request to idP"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { samlRequestSender .sendSAMLAuthRequest(request, response, filterConfig.getSpProviderId(), filterConfig.getAcsUrl(), filterConfig.getIdpSSOUrl()); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception e) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServletException(e); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The SAMLRequestSender class creates, codes, and sends requests as SAML 2.0 messages. </font></font><br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java"</span></span></span><span class="hljs-tag">&gt;</span></span> public class SAMLRequestSender { private static Logger log = LoggerFactory.getLogger(SAMLRequestSender.class); private SAMLAuthnRequestBuilder samlAuthnRequestBuilder = new SAMLAuthnRequestBuilder(); private MessageEncoder messageEncoder = new MessageEncoder(); public void sendSAMLAuthRequest(HttpServletRequest request, HttpServletResponse servletResponse, String spId, String acsUrl, String idpSSOUrl) throws Exception { String redirectURL; String idpUrl = idpSSOUrl; AuthnRequest authnRequest = samlAuthnRequestBuilder.buildRequest(spId, acsUrl, idpUrl); // store SAML 2.0 authentication request String key = SAMLRequestStore.getInstance().storeRequest(); authnRequest.setID(key); log.debug("SAML Authentication message : {} ", SAMLUtils.SAMLObjectToString(authnRequest)); redirectURL = messageEncoder.encode(authnRequest, idpUrl, request.getRequestURI()); HttpServletResponseAdapter responseAdapter = new HttpServletResponseAdapter(servletResponse, request.isSecure()); HTTPTransportUtils.addNoCacheHeaders(responseAdapter); HTTPTransportUtils.setUTF8Encoding(responseAdapter); responseAdapter.sendRedirect(redirectURL); } private static class SAMLAuthnRequestBuilder { public AuthnRequest buildRequest(String spProviderId, String acsUrl, String idpUrl){ /* Building Issuer object */ IssuerBuilder issuerBuilder = new IssuerBuilder(); Issuer issuer = issuerBuilder.buildObject("urn:oasis:names:tc:SAML:2.0:assertion", "Issuer", "saml2p"); issuer.setValue(spProviderId); /* Creation of AuthRequestObject */ DateTime issueInstant = new DateTime(); AuthnRequestBuilder authRequestBuilder = new AuthnRequestBuilder(); AuthnRequest authRequest = authRequestBuilder.buildObject(SAMLConstants.SAML20P_NS, "AuthnRequest", "saml2p"); authRequest.setForceAuthn(false); authRequest.setIssueInstant(issueInstant); authRequest.setProtocolBinding(SAMLConstants.SAML2_POST_BINDING_URI); authRequest.setAssertionConsumerServiceURL(acsUrl); authRequest.setIssuer(issuer); authRequest.setNameIDPolicy(nameIdPolicy); authRequest.setVersion(SAMLVersion.VERSION_20); authRequest.setDestination(idpUrl); return authRequest; } } private static class MessageEncoder extends HTTPRedirectDeflateEncoder { public String encode(SAMLObject message, String endpointURL, String relayState) throws MessageEncodingException { String encodedMessage = deflateAndBase64Encode(message); return buildRedirectURL(endpointURL, relayState, encodedMessage); } public String buildRedirectURL(String endpointURL, String relayState, String message) throws MessageEncodingException { URLBuilder urlBuilder = new URLBuilder(endpointURL); List<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Pair</span></span></span><span class="hljs-tag">&lt;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">&gt;</span></span>&gt; queryParams = urlBuilder.getQueryParams(); queryParams.clear(); queryParams.add(new Pair<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">String,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">&gt;</span></span>("SAMLRequest", message)); if (checkRelayState(relayState)) { queryParams.add(new Pair<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">String,</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">String</span></span></span><span class="hljs-tag">&gt;</span></span>("RelayState", relayState)); } return urlBuilder.buildURL(); } } }</code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The SAML 2.0 message with the user authentication instruction is created in the buildRequest method and is an XML object:</font></font><br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:AuthnRequest</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:saml2p</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:protocol"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AssertionConsumerServiceURL</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://sp.local.ru:8443/sso/acs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Destination</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://idp.local.ru:8443/idp/profile/SAML2/Redirect/SSO"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ForceAuthn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"false"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_0ddb303f9500839762eabd30e7b1e3c28b596c69"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueInstant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T09:46:41.882Z"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ProtocolBinding</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:bindings:HTTP-POST"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:Issuer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:saml2p</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:assertion"</span></span></span><span class="hljs-tag">&gt;</span></span>sp.local.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:Issuer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:AuthnRequest</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  <i>AssertionConsumerServiceURL</i>  URL,   shibboleth idP   ,   <i>ProtocolBinding</i>        (POST   HTTP) <br>  ID   ,       <br> <i>String key = SAMLRequestStore.getInstance().storeRequest();</i> <br>        <i>verifyInResponseTo</i>  <i>SAMLResponseVerifier</i> . <br><br>  saml2p:Issuer    SP.   <i>saml2p:Issuer</i> shibboleth idP    SP    ,      (  SP). <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In response to the above SAML 2.0 message, we will receive a response from idP as a SAML 2.0 message in XML format: </font></font><br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">source</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">lang</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xml"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:Response</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:saml2p</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:protocol"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Destination</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://sp.local.ru:8443/sso/acs"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_9c5e6028df334510cce22409ddbca6ac"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">InResponseTo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_0ddb303f9500839762eabd30e7b1e3c28b596c69"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueInstant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T10:13:35.177Z"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Issuer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:saml2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:assertion"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Format</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:nameid-format:entity"</span></span></span><span class="hljs-tag">&gt;</span></span> https://idp.local.ru/idp/shibboleth <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Issuer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:Status</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:StatusCode</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:status:Success"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:Status</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Assertion</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:saml2</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:assertion"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ID</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_0a299e86f4b17b5e047735121a880ccb"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">IssueInstant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T10:13:35.177Z"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">version</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2.0"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Issuer</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Format</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:nameid-format:entity"</span></span></span><span class="hljs-tag">&gt;</span></span> https://idp.local.ru/idp/shibboleth <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Issuer</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Subject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:NameID</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Format</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:nameid-format:transient"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NameQualifier</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://idp.local.ru/idp/shibboleth"</span></span></span><span class="hljs-tag">&gt;</span></span> _f1de09ee54294d4b5ddeb3aa5e6d2aab <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:NameID</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:SubjectConfirmation</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:cm:bearer"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:SubjectConfirmationData</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"127.0.0.1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">InResponseTo</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_0ddb303f9500839762eabd30e7b1e3c28b596c69"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NotOnOrAfter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T10:18:35.177Z"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Recipient</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://sp.local.ru:8443/sso/acs"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:SubjectConfirmation</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Subject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Conditions</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NotBefore</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T10:13:35.177Z"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NotOnOrAfter</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T10:18:35.177Z"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AudienceRestriction</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Audience</span></span></span><span class="hljs-tag">&gt;</span></span>sp.local.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Audience</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AudienceRestriction</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Conditions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AuthnStatement</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AuthnInstant</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2013-09-12T10:13:35.137Z"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SessionIndex</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_91826738984ca8bef18a8450135b1821"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:SubjectLocality</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Address</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"127.0.0.1"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AuthnContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AuthnContextClassRef</span></span></span><span class="hljs-tag">&gt;</span></span> urn:oasis:names:tc:SAML:2.0:ac:classes:PasswordProtectedTransport <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AuthnContextClassRef</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AuthnContext</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AuthnStatement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AttributeStatement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Attribute</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"userLogin"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">NameFormat</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"urn:oasis:names:tc:SAML:2.0:attrname-format:uri"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AttributeValue</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xs</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"xs:string"</span></span></span><span class="hljs-tag">&gt;</span></span>idpuser<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AttributeValue</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Attribute</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:AttributeStatement</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2:Assertion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">saml2p:Response</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The message will be processed in the already implemented method SAMLResponseVerifier.verify (..) </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">That's all, our filter is implemented! </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The structure of our project is as follows: </font></font><br><img src="http://habrastorage.org/storage3/d32/10b/1e8/d3210b1e849e5ef694f5b075aed72f28.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Putting the implemented filter in the jar library into a local repository. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, execute the command in the directory with </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pom.xml: mvn clean install</font></font></i> <br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> 6. Create a Java Web application with SSO support </font></font></h5><br><h6><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Create Java Web Application </font></font></h6><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For a visual example, we will create a simple Java Web application with private and public resources. Access to private resources requires user authentication through the Shibboleth idP web application. One of the private resources will make a page that displays information on the current user of the system. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The structure of our application is as follows:</font></font><br><img src="http://habrastorage.org/storage3/2ef/1f2/3b9/2ef1f23b97fe49eeb6a9d68aedc80c10.png"><br><br>  <b>pom.xml</b> <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/maven-v4_0_0.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span>4.0.0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">modelVersion</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> ru.eastbanctech.web<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>SimpleSSOApplication<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span>war<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">packaging</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0-SNAPSHOT<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>SimpleSSOApplication<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span>http://maven.apache.org<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--      --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sp.id</span></span></span><span class="hljs-tag">&gt;</span></span>sp.local.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sp.id</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">acs.url</span></span></span><span class="hljs-tag">&gt;</span></span>https://sp.local.ru:8443/sso/acs<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">acs.url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">idp.sso.url</span></span></span><span class="hljs-tag">&gt;</span></span>https://idp.local.ru:8443/idp/profile/SAML2/Redirect/SSO<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">idp.sso.url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logout.url</span></span></span><span class="hljs-tag">&gt;</span></span>/logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">logout.url</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">properties</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>javax.servlet<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>servlet-api<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>2.5<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> ru.eastbanctech.web<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>saml-sp-filter<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.0-SNAPSHOT<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sup</span></span></span><span class="hljs-tag">&gt;</span></span>8<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sup</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.slf4j<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>slf4j-api<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.7.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span>org.slf4j<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">groupId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>slf4j-log4j12<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span>1.7.1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">dependencies</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">finalName</span></span></span><span class="hljs-tag">&gt;</span></span>sso<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">finalName</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span>maven-war-plugin<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">artifactId</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">webResources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resource</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filtering</span></span></span><span class="hljs-tag">&gt;</span></span>true<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">filtering</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span>src/main/webapp/WEB-INF<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">directory</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targetPath</span></span></span><span class="hljs-tag">&gt;</span></span>WEB-INF<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">targetPath</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">includes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">include</span></span></span><span class="hljs-tag">&gt;</span></span>**/*.xml<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">include</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">includes</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">resource</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">webResources</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">configuration</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugin</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">plugins</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">build</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">project</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here it is necessary to turn to the </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">properties</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> section </font><font style="vertical-align: inherit;">, where the basic parameters of our </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;sp.id&gt; sp.local.ru &lt;/sp.id&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> filter are set </font><font style="vertical-align: inherit;">- the name of the SAML 2.0 SP filter </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;acs.url&gt; https://sp.local.ru: 8443 / sso / acs &lt;/acs.url&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the URL of the filter by which it </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will process SAML 2.0 messages from shibboleth idP </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;idp.sso.url&gt; https://idp.local.ru:8443/idp/profile/SAML2 / Redirect / SSO &lt;/idp.sso.url&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - the URL by </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">which our filter will send messages shibboleth idP </font></font><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">&lt;logout.url&gt; / logout &lt;/logout.url&gt;</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - logout URL </font></font><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">web.xml</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> In the web.xml file we define the parameters our filter and its scope. Make resources in the format ".jpg"open through the parameter </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">excludedUrlPattern</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="java hljs">&lt;!DOCTYPE web-app PUBLIC <span class="hljs-string"><span class="hljs-string">"-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"</span></span> <span class="hljs-string"><span class="hljs-string">"http://java.sun.com/dtd/web-app_2_3.dtd"</span></span> &gt; &lt;web-app&gt; &lt;display-name&gt;Simple SSO Java Web Application&lt;/display-name&gt;<span class="hljs-number"><span class="hljs-number">7</span></span>. &lt;filter&gt; &lt;filter-name&gt;SSOFilter&lt;/filter-name&gt; &lt;filter-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ru</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">eastbanctech</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">web</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filter</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">saml</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SAMLSPFilter</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filter</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">excludedUrlPattern</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt;.*\.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">jpg</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; &lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">init</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">idProviderSSOUrl</span></span></span><span class="hljs-class">&lt;/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">name</span></span></span><span class="hljs-class">&gt; &lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">param</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">value</span></span></span><span class="hljs-class">&gt; $</span></span>{idp.sso.url}&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;spProviderId&lt;/param-name&gt; &lt;param-value&gt;${sp.id}&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;acsUrl&lt;/param-name&gt; &lt;param-value&gt;${acs.url}&lt;/param-value&gt; &lt;/init-param&gt; &lt;init-param&gt; &lt;param-name&gt;logoutUrl&lt;/param-name&gt; &lt;param-value&gt;${logout.url}&lt;/param-value&gt; &lt;/init-param&gt; &lt;/filter&gt; &lt;filter-mapping&gt; &lt;filter-name&gt;SSOFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/pages/<span class="hljs-keyword"><span class="hljs-keyword">private</span></span><span class="hljs-comment"><span class="hljs-comment">/*&lt;/url-pattern&gt; &lt;/filter-mapping&gt; &lt;filter-mapping&gt; &lt;filter-name&gt;SSOFilter&lt;/filter-name&gt; &lt;url-pattern&gt;${logout.url}&lt;/url-pattern&gt; &lt;/filter-mapping&gt; &lt;filter-mapping&gt; &lt;filter-name&gt;SSOFilter&lt;/filter-name&gt; &lt;url-pattern&gt;/acs&lt;/url-pattern&gt; &lt;/filter-mapping&gt; &lt;/web-app&gt;</span></span></code> </pre></div></div><br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">private / page.jsp A</font></font></b> <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> page is simply a </font><b><font style="vertical-align: inherit;">listing of the</font></b><font style="vertical-align: inherit;"> id and attributes of an authenticated user.</font></font><br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">import</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" ru.eastbanctech.java.web.filter.saml.store.SAMLSessionManager"</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">import</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" ru.eastbanctech.java.web.filter.saml.store.SAMLSessionInfo"</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%@</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">page</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">import</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.util.Map"</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Private Resource<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">SAMLSessionInfo</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">info</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">(SAMLSessionInfo)request.getSession().getAttribute(SAMLSessionManager.SAML_SESSION_INFO);</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out.println</span></span></span><span class="hljs-tag">("</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">User</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag"> = </span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" + info.getNameId() + "</span></span></span><span class="hljs-tag"> "); </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">out.println</span></span></span><span class="hljs-tag">("&lt;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">TABLE</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TR</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TH</span></span></span><span class="hljs-tag">&gt;</span></span> Attribute name <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TH</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TH</span></span></span><span class="hljs-tag">&gt;</span></span> Attribulte value <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TH</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TR</span></span></span><span class="hljs-tag">&gt;</span></span>"); for (Map.Entry entry : info.getAttributes().entrySet()) { out.println("<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TR</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TD</span></span></span><span class="hljs-tag">&gt;</span></span>" + entry.getKey() + "<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TD</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TD</span></span></span><span class="hljs-tag">&gt;</span></span>" + entry.getValue() + "<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TD</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TR</span></span></span><span class="hljs-tag">&gt;</span></span>"); } out.println("<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TABLE</span></span></span><span class="hljs-tag">&gt;</span></span>"); %&gt; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"&lt;%=request.getContextPath()%&gt;/logout"</span></span></span><span class="hljs-tag">&gt;</span></span>Logout<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Build the application with the command: mvn clean package. </font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Checking Java Web Applications </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Deploy the application to Tomcat AS and check the operation of SSO: </font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Describes the application context in the $ {tomcatHome} /conf/Catalina/localhost/sso.xml file </font></font><br><pre> <code class="java hljs">&lt;Context docBase=<span class="hljs-string"><span class="hljs-string">"$pathToWebApp"</span></span> privileged=<span class="hljs-string"><span class="hljs-string">"true"</span></span> antiResourceLocking=<span class="hljs-string"><span class="hljs-string">"false"</span></span> antiJARLocking=<span class="hljs-string"><span class="hljs-string">"false"</span></span> unpackWAR=<span class="hljs-string"><span class="hljs-string">"false"</span></span> swallowOutput=<span class="hljs-string"><span class="hljs-string">"true"</span></span> /&gt;</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> or simply copy our sso.war application to $ {tomcatHome} / webapps </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In order for tomkata applications to establish a connection with shibboleth idP via HTTPS protocol, you need to add a shibboleth idP certificate to the java keystore. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, use the Java keytool utility: </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">keytool -alias idp.local.ru -importcert -file $ {shHome} /idp.crt -keystore $ {keystorePath}</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We start Tomcat AS </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Open the browser and knock on the closed resource of the application </font></font><a href="https://sp.local.ru/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">sp.local.ru</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> : 8443 / sso / pages / private / page.jsp</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Check that the page is open and the system displayed the id and user name </font></font><br><img src="http://habrastorage.org/storage3/379/704/b1b/379704b1bf2a28d8767f200f62a05fe8.png"><br></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> As an exercise, check that the filter skips requests for pictures in the .jpg format in the / pages / private folder. </font></font></li></ol><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Integration with Google Apps. </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And now it's time to check that SSO really works for us. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To do this, we will use the application from the Google Apps cloud services ( </font></font><a href="http://www.google.com/enterprise/apps/business/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">http://www.google.com/enterprise/apps/business/</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ).</font></font><br><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Register your domain name and super-administrator using a free trial version. </font><font style="vertical-align: inherit;">After everything is completed, log in to </font></font><a href="http://admin.google.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">admin.google.com</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> under the created user (using the fully qualified domain name).</font></font></li><li>      idpuser,    Super Administrator. </li><li>    ¬´  ¬ª      <br>   ¬´¬ª. <br><img src="http://habrastorage.org/storage3/7ad/ad9/639/7adad9639f6e64572419ca91b7e6e9c0.png"><br></li><li>     -&gt;   . </li><li>        : <br> <i>URL   *</i> = <a href="https://idp.local.ru:8443/idp/profile/SAML2/Redirect/SSO">https://idp.local.ru:8443/idp/profile/SAML2/Redirect/SSO</a> <br> <i>URL   *</i> = gmail.com <br> <i>  URL *</i> = gmail.com <br><br>    <i> </i> . </li><li>      shibboleth idP  HTTPS <br>    <i>$shHome/credentials/idp.crt</i> <br><img src="http://habrastorage.org/storage3/301/7fd/1ab/3017fd1ab7f55290587fc1031c1bba9e.png"><br><br>     . </li><li>   <a href="https://shibboleth.usc.edu/docs/google-apps/">https://shibboleth.usc.edu/docs/google-apps/</a>  shibboleth idP    Google Apps. <br><br> <b>:      ,      shibboleth idP. ,  RelyingParty   rp:RelyingParty.</b> </li><li>  logger'   edu.internet2.middleware.shibboleth   DEBUG <br><pre> <code class="java hljs"> &lt;!-- Logs IdP, but not OpenSAML, messages --&gt; &lt;logger name=<span class="hljs-string"><span class="hljs-string">"edu.internet2.middleware.shibboleth"</span></span> level=<span class="hljs-string"><span class="hljs-string">"DEBUG"</span></span>/&gt;</code> </pre><br>  shibboleth idP     <a href="https://admin.google.com/">https://admin.google.com</a>     (   ,  Google Chrome    ). <br>  idpuser@ <font color="red">domain_name</font> ,  domain_name ‚Äì      .  ¬´¬ª. <br>      ,     google apps   idpuser. <br>   <i>${shHome}/logs/idp-process.log</i>    ,  shibboleth idP   .   ,      <i>RemoteUserLoginHandler</i> <br><pre> <code class="java hljs"><span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">49.172</span></span> - DEBUG [edu.internet2.middleware.shibboleth.idp.authn.provider.RemoteUserLoginHandler:<span class="hljs-number"><span class="hljs-number">66</span></span>] - Redirecting to &lt;a href=<span class="hljs-string"><span class="hljs-string">"https://idp.local.ru:8443/idp/Authn/RemoteUser"</span></span>&gt;https:<span class="hljs-comment"><span class="hljs-comment">//idp.local.ru:8443/idp/Authn/RemoteUser&lt;/a&gt;</span></span></code> </pre><br><br>    shibboleth idP        .    ,    . <br>       <a href="https://sp.local.ru/">sp.local.ru</a> :8443/sso/pages/private/page.jsp <br>    ,  shibboleth idP      idpuser. <br><br>  Well that's all.    SSO . ,    -   . <br><br><h5>  Notes </h5><br> <sup>1</sup> ‚Äî    Service Provider  .    Shibboleth      ,     Apache-  Application Server'. <br> <sup>2</sup> ‚Äî        Shibboleth idP 2.4.0 <br> <sup>3</sup> ‚Äî   Java 7   . <br> <sup>4</sup> ‚Äî   CentOS 6.3   OS.    Ubuntu 12.04. <br> <sup>5</sup> ‚Äî     servlet-api 2.5  ${tomcatHome}/lib/catalina.jar <br> <sup>6</sup> ‚Äî ru.eastbanctech.java.web.RemoteUserValve ‚Äì     RemoteUserValve.         . <br> <sup>7</sup> ‚Äî      . <br> <sup>8</sup> ‚Äî          . <br><br><h5>  useful links <br></h5><br><ol><li> <a href="https://developers.google.com/google-apps/sso/saml_reference_implementation">https://developers.google.com/google-apps/sso/saml_reference_implementation</a> ‚Äî SSO   Google Apps.      SSO  Google Docs  SAML. </li><li> <a href="https://shibboleth.usc.edu/docs/google-apps/">https://shibboleth.usc.edu/docs/google-apps/</a> ‚Äî    Shibboleth  Google docs. </li><li> <a href="httpservletrequest-getremoteuser-in-tomcat-without-modify">http://stackoverflow.com/questions/7553967/getting-a-value-from-httpservletrequest-getremoteuser-in-tomcat-without-modify</a> ‚Äî    Tomcat Valve </li><li> <a href="https://wiki.shibboleth.net/confluence/display/SHIB2/Home">https://wiki.shibboleth.net/confluence/display/SHIB2/Home</a> ‚Äî   Shibboleth </li></ol></li></ol></div><p>Source: <a href="https://habr.com/ru/post/193662/">https://habr.com/ru/post/193662/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193646/index.html">Direct data transfer between FPGA Virtex-7 over the bus PCI Express</a></li>
<li><a href="../193650/index.html">How to buy a 3D printer in China, or Toy for $ 1000</a></li>
<li><a href="../193654/index.html">Application of EDS in SAP NetWeaver web templates</a></li>
<li><a href="../193658/index.html">Applying local binary patterns to solving face recognition tasks</a></li>
<li><a href="../193660/index.html">Media Center from MacMini and Rapsberry PI</a></li>
<li><a href="../193666/index.html">Steganography in .NET applications or watermarks</a></li>
<li><a href="../193668/index.html">Straight lines in a hexagonal raster</a></li>
<li><a href="../193670/index.html">Autonomous operation of the smartphone: "intelligible" comparative guide</a></li>
<li><a href="../193672/index.html">Pandorama BigData Infrastructure and Protecting Its Data from Failure</a></li>
<li><a href="../193674/index.html">Profiler in MarkLogic Server</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>