<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating and using a Clang plugin for Xcode</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This tutorial describes how to create a plugin for Clang and covers the following steps: 


- environment setting 
- creating base plugin 
- creating ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating and using a Clang plugin for Xcode</h1><div class="post__text post__text-html js-mediator-article"><h4>  This tutorial describes how to create a plugin for Clang and covers the following steps: </h4><br><ul><li>  environment setting </li><li>  creating base plugin </li><li>  creating an Xcode project for plugin development </li><li>  generating alerts </li><li>  error generation </li><li>  plug-in integration in Xcode </li><li>  interactive tips to eliminate warnings and errors </li></ul><br><br><h5>  TL; DR </h5><br>  Ready plugin can be found <a href="https://github.com/AlexDenisov/ToyClangPlugin">here.</a> <br><a name="habracut"></a><br><h5>  Introduction </h5><br>  During the development of <a href="https://github.com/railsware/BloodMagic">BloodMagic,</a> I decided that it would be great to have a tool for finding semantic errors when using BM.  For example, a property is marked as <code>lazy</code> in the interface, but in the implementation it is not marked as @dynamic, or marked as <code>lazy</code> , but the container class does not support injections.  I came to the conclusion that I would have to work with <a href="http://ru.wikipedia.org/wiki/%25D0%2590%25D0%25B1%25D1%2581%25D1%2582%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25BD%25D0%25BE%25D0%25B5_%25D1%2581%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B0%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B5_%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B5%25D0%25B2%25D0%25BE">AST</a> , and therefore a full parser is needed. <br><br>  I tried different options: <a href="http://ru.wikipedia.org/wiki/Flex_(%25D0%25B3%25D0%25B5%25D0%25BD%25D0%25B5%25D1%2580%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580_%25D0%25BB%25D0%25B5%25D0%25BA%25D1%2581%25D0%25B8%25D1%2587%25D0%25B5%25D1%2581%25D0%25BA%25D0%25B8%25D1%2585_%25D0%25B0%25D0%25BD%25D0%25B0%25D0%25BB%25D0%25B8%25D0%25B7%25D0%25B0%25D1%2582%25D0%25BE%25D1%2580%25D0%25BE%25D0%25B2)">flex</a> + <a href="http://ru.wikipedia.org/wiki/GNU_bison">bison</a> , <a href="http://clang.llvm.org/doxygen/group__CINDEX.html">libclang</a> , but in the end I decided to write a plugin for Clang. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the test plugin, I set the following goals: <br><br><ul><li>  use Xcode to develop </li><li>  integrate the plug-in into Xcode for everyday use </li><li>  the plugin should be able to generate warnings, errors and show interactive prompts (via Xcode) </li></ul><br>  Features for the test plugin: <br><br><ul><li>  generate a warning if the class name starts with a lowercase letter </li><li>  generate an error if the class name contains an underscore </li><li>  suggest hints for correction </li></ul><br><h5>  Setting up the environment </h5><br>  To develop a plugin, we need llvm / clang, compiled from sources <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt sudo mkdir llvm sudo chown `whoami` llvm <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> llvm <span class="hljs-built_in"><span class="hljs-built_in">export</span></span> LLVM_HOME=`<span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span>`</code> </pre> <br>  The current version of clang on my machine is 3.3.1, because I use the appropriate version: <br><br><pre> <code class="bash hljs">git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b release_33 https://github.com/llvm-mirror/llvm.git llvm git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b release_33 https://github.com/llvm-mirror/clang.git llvm/tools/clang git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b release_33 https://github.com/llvm-mirror/clang-tools-extra.git llvm/tools/clang/tools/extra git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> -b release_33 https://github.com/llvm-mirror/compiler-rt.git llvm/projects/compiler-rt mkdir llvm_build <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> llvm_build cmake ../llvm -DCMAKE_BUILD_TYPE:STRING=Release make -j`sysctl -n hw.logicalcpu`</code> </pre><br><h5>  Creating a base plugin </h5><br>  Create a plugin directory <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-variable"><span class="hljs-variable">$LLVM_HOME</span></span> mkdir toy_clang_plugin; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> toy_clang_plugin</code> </pre><br>  Our plugin is based on an example from the Clang repository and has the following structure: <br><br><pre> <code class="bash hljs">ToyClangPlugin.exports CMakeLists.txt ToyClangPlugin.cpp</code> </pre><br>  We will use one file to simplify: <br><br><div class="spoiler">  <b class="spoiler_title">ToyClangPlugin.cpp</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// ToyClangPlugin.cpp #include "clang/Frontend/FrontendPluginRegistry.h" #include "clang/AST/AST.h" #include "clang/AST/ASTConsumer.h" #include "clang/Frontend/CompilerInstance.h" using namespace clang; namespace { class ToyConsumer : public ASTConsumer { }; class ToyASTAction : public PluginASTAction { public: virtual clang::ASTConsumer *CreateASTConsumer(CompilerInstance &amp;Compiler, llvm::StringRef InFile) { return new ToyConsumer; } bool ParseArgs(const CompilerInstance &amp;CI, const std::vector&lt;std::string&gt;&amp; args) { return true; } }; } static clang::FrontendPluginRegistry::Add&lt;ToyASTAction&gt; X("ToyClangPlugin", "Toy Clang Plugin");</span></span></code> </pre></div></div><br>  Data required for assembly: <br><br><div class="spoiler">  <b class="spoiler_title">CMakeLists.txt</b> <div class="spoiler_text"><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">cmake_minimum_required</span></span> (VERSION <span class="hljs-number"><span class="hljs-number">2.6</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">project</span></span> (ToyClangPlugin) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( CMAKE_RUNTIME_OUTPUT_DIRECTORY <span class="hljs-variable"><span class="hljs-variable">${CMAKE_BINARY_DIR}</span></span>/bin ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( CMAKE_LIBRARY_OUTPUT_DIRECTORY <span class="hljs-variable"><span class="hljs-variable">${CMAKE_BINARY_DIR}</span></span>/lib ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( CMAKE_ARCHIVE_OUTPUT_DIRECTORY <span class="hljs-variable"><span class="hljs-variable">${CMAKE_BINARY_DIR}</span></span>/lib ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( LLVM_HOME /opt/llvm ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( LLVM_SRC_DIR <span class="hljs-variable"><span class="hljs-variable">${LLVM_HOME}</span></span>/llvm ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( CLANG_SRC_DIR <span class="hljs-variable"><span class="hljs-variable">${LLVM_HOME}</span></span>/llvm/tools/clang ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( LLVM_BUILD_DIR <span class="hljs-variable"><span class="hljs-variable">${LLVM_HOME}</span></span>/llvm_build ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>( CLANG_BUILD_DIR <span class="hljs-variable"><span class="hljs-variable">${LLVM_HOME}</span></span>/llvm_build/tools/clang) <span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span> (-D__STDC_LIMIT_MACROS -D__STDC_CONSTANT_MACROS) <span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span> (-D_GNU_SOURCE -DHAVE_CLANG_CONFIG_H) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (CMAKE_CXX_COMPILER <span class="hljs-string"><span class="hljs-string">"${LLVM_BUILD_DIR}/bin/clang++"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (CMAKE_CC_COMPILER <span class="hljs-string"><span class="hljs-string">"${LLVM_BUILD_DIR}/bin/clang"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (CMAKE_CXX_FLAGS <span class="hljs-string"><span class="hljs-string">"${CMAKE_CXX_FLAGS} -fPIC -fno-common -Woverloaded-virtual -Wcast-qual -fno-strict-aliasing -pedantic -Wno-long-long -Wall -Wno-unused-parameter -Wwrite-strings -fno-exceptions -fno-rtti"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (CMAKE_MODULE_LINKER_FLAGS <span class="hljs-string"><span class="hljs-string">"-Wl,-flat_namespace -Wl,-undefined -Wl,suppress"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (LLVM_LIBS LLVMJIT LLVMX86CodeGen LLVMX86AsmParser LLVMX86Disassembler LLVMExecutionEngine LLVMAsmPrinter LLVMSelectionDAG LLVMX86AsmPrinter LLVMX86Info LLVMMCParser LLVMCodeGen LLVMX86Utils LLVMScalarOpts LLVMInstCombine LLVMTransformUtils LLVMipa LLVMAnalysis LLVMTarget LLVMCore LLVMMC LLVMSupport LLVMBitReader LLVMOption ) <span class="hljs-keyword"><span class="hljs-keyword">macro</span></span>(add_clang_plugin name) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (srcs <span class="hljs-variable"><span class="hljs-variable">${ARGN}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>( <span class="hljs-string"><span class="hljs-string">"${LLVM_SRC_DIR}/include"</span></span> <span class="hljs-string"><span class="hljs-string">"${CLANG_SRC_DIR}/include"</span></span> <span class="hljs-string"><span class="hljs-string">"${LLVM_BUILD_DIR}/include"</span></span> <span class="hljs-string"><span class="hljs-string">"${CLANG_BUILD_DIR}/include"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">link_directories</span></span>( <span class="hljs-string"><span class="hljs-string">"${LLVM_BUILD_DIR}/lib"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">add_library</span></span>( <span class="hljs-variable"><span class="hljs-variable">${name}</span></span> SHARED <span class="hljs-variable"><span class="hljs-variable">${srcs}</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (SYMBOL_FILE) <span class="hljs-keyword"><span class="hljs-keyword">set_target_properties</span></span>( <span class="hljs-variable"><span class="hljs-variable">${name}</span></span> PROPERTIES LINK_FlAGS <span class="hljs-string"><span class="hljs-string">"-exported_symbols_list ${SYMBOL_FILE}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">endif</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (clang_lib <span class="hljs-variable"><span class="hljs-variable">${CLANG_LIBS}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>( <span class="hljs-variable"><span class="hljs-variable">${name}</span></span> <span class="hljs-variable"><span class="hljs-variable">${clang_lib}</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">endforeach</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (llvm_lib <span class="hljs-variable"><span class="hljs-variable">${LLVM_LIBS}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>( <span class="hljs-variable"><span class="hljs-variable">${name}</span></span> <span class="hljs-variable"><span class="hljs-variable">${llvm_lib}</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">endforeach</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (user_lib <span class="hljs-variable"><span class="hljs-variable">${USER_LIBS}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>( <span class="hljs-variable"><span class="hljs-variable">${name}</span></span> <span class="hljs-variable"><span class="hljs-variable">${user_lib}</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">endforeach</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">endmacro</span></span>(add_clang_plugin) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(SYMBOL_FILE ToyClangPlugin.exports) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (CLANG_LIBS clang clangFrontend clangAST clangAnalysis clangBasic clangCodeGen clangDriver clangFrontendTool clangLex clangParse clangSema clangEdit clangSerialization clangStaticAnalyzerCheckers clangStaticAnalyzerCore clangStaticAnalyzerFrontend ) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> (USER_LIBS pthread curses ) add_clang_plugin(ToyClangPlugin ToyClangPlugin.cpp ) <span class="hljs-keyword"><span class="hljs-keyword">set_target_properties</span></span>(ToyClangPlugin PROPERTIES LINKER_LANGUAGE CXX PREFIX <span class="hljs-string"><span class="hljs-string">""</span></span>)</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">ToyClangPlugin.exports</b> <div class="spoiler_text"><pre> <code class="cpp hljs">__ZN4llvm8Registry*</code> </pre></div></div><br>  Now we can generate an Xcode project based on `CMakeLists.txt` <br><br><pre> <code class="bash hljs">mkdir build; <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> build cmake -G Xcode .. open ToyClangPlugin.xcodeproj</code> </pre> <br>  Run 'ALL_BUILD', if successful, the finished library will be here: `lib / Debug / ToyCLangPlugin.dylib`. <br><br><h5>  RecursiveASTVisitor </h5><br>  The AST module provides <a href="http://clang.llvm.org/doxygen/classclang_1_1RecursiveASTVisitor.html">RecursiveASTVisitor</a> , which allows you to go through the syntax tree.  All we need is to follow and implement the methods of interest. <br>  As a small test, we will display all the classes encountered: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToyClassVisitor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RecursiveASTVisitor&lt;ToyClassVisitor&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitObjCInterfaceDecl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjCInterfaceDecl *declaration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"ObjClass: %s\n"</span></span>, declaration-&gt;getNameAsString().c_str()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToyConsumer</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ASTConsumer { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">HandleTranslationUnit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ASTContext &amp;context)</span></span></span><span class="hljs-function"> </span></span>{ visitor.TraverseDecl(context.getTranslationUnitDecl()); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: ToyClassVisitor visitor; };</code> </pre><br>  Let's create a test class and check the work of the plugin. <br><br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> @interface ToyObject : NSObject @end @implementation ToyObject @end</span></span></code> </pre><br>  Running plugin <br><br><pre> <code class="bash hljs">/opt/llvm/toy_clang_plugin/build $ <span class="hljs-variable"><span class="hljs-variable">$LLVM_HOME</span></span>/llvm_build/bin/clang ../test.m \ -Xclang -load \ -Xclang lib/Debug/ToyClangPlugin.dylib \ -Xclang -plugin \ -Xclang ToyClangPlugin</code> </pre><br>  The output should be a huge list of classes. <br><br><h5>  Generating alerts </h5><br>  If the class name begins with a lowercase letter, the user will see a warning. <br>  You need a context to generate alerts. <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToyClassVisitor</span></span></span><span class="hljs-class"> :</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> RecursiveASTVisitor&lt;ToyClassVisitor&gt; { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span>: ASTContext *context; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ASTContext &amp;context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>-&gt;context = &amp;context; } <span class="hljs-comment"><span class="hljs-comment">// ... }; // ... void HandleTranslationUnit(ASTContext &amp;context) { visitor.setContext(context); visitor.TraverseDecl(context.getTranslationUnitDecl()); } // ...</span></span></code> </pre><br>  Class Name Validation: <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitObjCInterfaceDecl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjCInterfaceDecl *declaration)</span></span></span><span class="hljs-function"> </span></span>{ checkForLowercasedName(declaration); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// ... void checkForLowercasedName(ObjCInterfaceDecl *declaration) { StringRef name = declaration-&gt;getName(); char c = name[0]; if (isLowercase(c)) { DiagnosticsEngine &amp;diagEngine = context-&gt;getDiagnostics(); unsigned diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Warning, "Class name should not start with lowercase letter"); SourceLocation location = declaration-&gt;getLocation(); diagEngine.Report(location, diagID); } }</span></span></code> </pre><br>  Now you need to add a class with a ‚Äúbad‚Äù name. <br><br><pre> <code class="objectivec hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">@interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bad_ToyObject</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NSObject</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implementation</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bad_ToyObject</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre><br>  and check the work of the plugin <br><br><pre> <code class="bash hljs">/opt/llvm/toy_clang_plugin/build $ <span class="hljs-variable"><span class="hljs-variable">$LLVM_HOME</span></span>/llvm_build/bin/clang ../test.m \ -Xclang -load \ -Xclang lib/Debug/ToyClangPlugin.dylib \ -Xclang -plugin \ -Xclang ToyClangPlugin ../test.m:11:12: warning: Class name should not start with lowercase letter @interface bad_ToyObject : NSObject ^ 1 warning generated.</code> </pre><br><h5>  Error generation </h5><br>  If the class name contains an underscore ('_'), then the user will see an error. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkForUnderscoreInName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjCInterfaceDecl *declaration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> underscorePos = declaration-&gt;getName().find(<span class="hljs-string"><span class="hljs-string">'_'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (underscorePos != StringRef::npos) { DiagnosticsEngine &amp;diagEngine = context-&gt;getDiagnostics(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Error, <span class="hljs-string"><span class="hljs-string">"Class name with `_` forbidden"</span></span>); SourceLocation location = declaration-&gt;getLocation().getLocWithOffset(underscorePos); diagEngine.Report(location, diagID); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">VisitObjCInterfaceDecl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjCInterfaceDecl *declaration)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// disable this check temporary // checkForLowercasedName(declaration); checkForUnderscoreInName(declaration); return true; }</span></span></code> </pre><br>  Output after launch <br><br><pre> <code class="bash hljs">/opt/llvm/toy_clang_plugin/build $ <span class="hljs-variable"><span class="hljs-variable">$LLVM_HOME</span></span>/llvm_build/bin/clang ../test.m \ -Xclang -load \ -Xclang lib/Debug/ToyClangPlugin.dylib \ -Xclang -plugin \ -Xclang ToyClangPlugin ../test.m:11:15: error: Class name with `_` forbidden @interface bad_ToyObject : NSObject ^ 1 error generated.</code> </pre><br>  Uncomment the first check and the output will be both an error and a warning <br><br><pre> <code class="bash hljs">/opt/llvm/toy_clang_plugin/build $ <span class="hljs-variable"><span class="hljs-variable">$LLVM_HOME</span></span>/llvm_build/bin/clang ../test.m \ -Xclang -load \ -Xclang lib/Debug/ToyClangPlugin.dylib \ -Xclang -plugin \ -Xclang ToyClangPlugin ../test.m:11:12: warning: Class name should not start with lowercase letter @interface bad_ToyObject : NSObject ^ ../test.m:11:15: error: Class name with `_` forbidden @interface bad_ToyObject : NSObject ^ 1 warning and 1 error generated.</code> </pre><br><h5>  Xcode Integration </h5><br>  Unfortunately, the system (I understand the clang from the Xcode distribution) as the system clang does not support plugins, so you need to patch the Xcode a bit so that you can use the custom compiler <br><br>  Unpack <a href="">this</a> archive and run the following commands: <br><br><pre> <code class="bash hljs">sudo mv HackedClang.xcplugin `xcode-select -<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>-path`/../PlugIns/Xcode3Core.ideplugin/Contents/SharedSupport/Developer/Library/Xcode/Plug-ins sudo mv HackedBuildSystem.xcspec `xcode-select -<span class="hljs-built_in"><span class="hljs-built_in">print</span></span>-path`/Platforms/iPhoneSimulator.platform/Developer/Library/Xcode/Specifications</code> </pre><br>  These hacks will add a new compiler in Xcode and allow them to build projects for OSX and iPhoneSimulator. <br><br>  After restarting Xcode you will see the new clang in the list. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/74b/9d2/609/74b9d26095094bfaa9ba680d2618b2a8.png"><br><br>  Create a new project and select our custom clang in 'Build settings'. <br>  To enable the plugin, add the following parameters to the 'Other C Flags' <br><br><pre> <code class="bash hljs">-Xclang -load -Xclang /opt/llvm/toy_clang_plugin/build/lib/Debug/ToyClangPlugin.dylib -Xclang -add-plugin -Xclang ToyClangPlugin</code> </pre><br><img src="https://habrastorage.org/getpro/habr/post_images/7d7/bb6/e4a/7d7bb6e4aea4b639bd6ce9b9cdf21a12.png"><br><br>  Please note that here we use `-add-plugin`, because we want to add our` ASTAction`, and not replace the existing one. <br>  You also need to disable the modules for this assembly: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/451/73b/f7e/45173bf7eec5d0a9a8682990118062de.png" alt="disable_modules"><br><br>  Add our `test.m` to this project or create a new class with names matching the plugin criteria. <br>  After assembly, you should see warnings and errors in a more familiar form: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2f8/fd3/748/2f8fd374817eb321ff2a37ca6238e618.png" alt="error_warning"><br><br><h5>  Interactive tips </h5><br>  Now it‚Äôs worth adding interactive tips to correct errors and warnings. <br><br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkForLowercasedName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjCInterfaceDecl *declaration)</span></span></span><span class="hljs-function"> </span></span>{ StringRef name = declaration-&gt;getName(); <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> c = name[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isLowercase(c)) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> tempName = name; tempName[<span class="hljs-number"><span class="hljs-number">0</span></span>] = toUppercase(c); <span class="hljs-function"><span class="hljs-function">StringRef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tempName)</span></span></span></span>; SourceLocation nameStart = declaration-&gt;getLocation(); SourceLocation nameEnd = nameStart.getLocWithOffset(name.size()); FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement); DiagnosticsEngine &amp;diagEngine = context-&gt;getDiagnostics(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Warning, <span class="hljs-string"><span class="hljs-string">"Class name should not start with lowercase letter"</span></span>); SourceLocation location = declaration-&gt;getLocation(); diagEngine.Report(location, diagID).AddFixItHint(fixItHint); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkForUnderscoreInName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ObjCInterfaceDecl *declaration)</span></span></span><span class="hljs-function"> </span></span>{ StringRef name = declaration-&gt;getName(); <span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> underscorePos = name.find(<span class="hljs-string"><span class="hljs-string">'_'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (underscorePos != StringRef::npos) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> tempName = name; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span>::iterator end_pos = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::remove(tempName.begin(), tempName.end(), <span class="hljs-string"><span class="hljs-string">'_'</span></span>); tempName.erase(end_pos, tempName.end()); <span class="hljs-function"><span class="hljs-function">StringRef </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(tempName)</span></span></span></span>; SourceLocation nameStart = declaration-&gt;getLocation(); SourceLocation nameEnd = nameStart.getLocWithOffset(name.size()); FixItHint fixItHint = FixItHint::CreateReplacement(SourceRange(nameStart, nameEnd), replacement); DiagnosticsEngine &amp;diagEngine = context-&gt;getDiagnostics(); <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> diagID = diagEngine.getCustomDiagID(DiagnosticsEngine::Error, <span class="hljs-string"><span class="hljs-string">"Class name with `_` forbidden"</span></span>); SourceLocation location = declaration-&gt;getLocation().getLocWithOffset(underscorePos); diagEngine.Report(location, diagID).AddFixItHint(fixItHint); } }</code> </pre><br>  Rebuild the plugin and start building the test project. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b13/45b/957/b1345b9577328433c1939eaf8dda9ffe.png" alt="warning_fixit_hint"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0c/44b/79e/b0c44b79e2738416c60771db7f0831c7.png" alt="error_fixit_hint"><br><br><h5>  Conclusion </h5><br>  As you can see, creating a plug-in for clang is relatively simple, but it requires dirty hacks with Xcode, and you need to build your clang, because I would not recommend using a custom compiler to build applications in production.  Apple provides a patched version of clang, and we can't know the difference.  In addition, the Clang plugin for Xcode requires a lot of effort in order to make it workable, which does not make it particularly usable. <br>  There is another problem that you may encounter during development, an unstable and constantly changing API. <br><br>  You can use similar plugins on your system, but please do not make other people depend on such heavy things. <br><br>  If you have any comments, questions or suggestions, write to <a href="https://twitter.com/1101_debian">twitter</a> , <a href="https://github.com/AlexDenisov/ToyClangPlugin/issues/new">github</a> or just leave a comment here. <br><br>  Happy hacking! </div><p>Source: <a href="https://habr.com/ru/post/214275/">https://habr.com/ru/post/214275/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../214259/index.html">Notifications of endings of fabric tasks, with decorators and detailed information</a></li>
<li><a href="../214261/index.html">Dragon for MSI</a></li>
<li><a href="../214263/index.html">Send an application to the State Duma regarding the "" anti "terrorist" package of bills</a></li>
<li><a href="../214267/index.html">Imo.im messenger disables all protocols.</a></li>
<li><a href="../214269/index.html">European Commission: ‚ÄúFritupley? Then no in-app purchases! ‚Äù</a></li>
<li><a href="../214279/index.html">Skolkovo Robotics visit via Webot robots</a></li>
<li><a href="../214281/index.html">Test task of my dream</a></li>
<li><a href="../214285/index.html">PHP design patterns. Part 1. Generating</a></li>
<li><a href="../214287/index.html">Colobot Gold - opensource version of the game Colobot</a></li>
<li><a href="../214289/index.html">About SAN (Storage Area Network) on the fingers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>