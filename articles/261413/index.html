<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Skin Detection in Wolfram Language (Mathematica)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Translation of the post by Matthias Odisio " Seeing Skin with Mathematica ". 
 Download the file containing the text of the article, interactive model...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Skin Detection in Wolfram Language (Mathematica)</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/670/b13/2a8/670b132a8d944d67bb09a968737be29f.png"></div><br>  <i>Translation of the post by Matthias Odisio " <a href="http://blog.wolfram.com/2013/05/09/seeing-skin-with-mathematica/">Seeing Skin with Mathematica</a> ".</i> <i><br></i>  <i>Download the file containing the text of the article, interactive models and all the code given in the article <a href="">here</a> .</i> <i><br></i>  <i>I express my deep gratitude to <a href="http://vk.com/ld742">Kirill Guzenko</a> for his help in translating.</i> <hr> Skin detection can be quite useful - this is one of the main steps to more advanced systems aimed at detecting people, recognizing gestures, faces, filtering based on content, and more.  Despite all of the above, my motivation for creating the application was different.  The development and research department at Wolfram Research, where I work, has undergone a slight reorganization.  With my colleagues who are involved in probabilities and statistics, who have become much closer to me, I decided to develop a small application that would use both the image processing functionality in <i>Mathematica</i> and the statistical functions.  Skin detection is the first thing that came to my mind. <br><br>  Skin shades and appearance may vary, which complicates the task of detection.  The detector I wanted to develop is based on probabilistic models for pixel colors.  For each pixel of the image applied to the input, a skin detector indicates the probability that this pixel belongs to a skin area. <br><br><img title="Skin detection model" src="https://habrastorage.org/getpro/habr/post_images/632/116/b2c/632116b2c4787af2f950c61509f501cc.png" alt="Skin detection model" width="526" height="204"><br><a name="habracut"></a><br>  Let's look at this problem from the point of view of probability theory.  We would like to estimate the probability that a pixel belongs to an area with skin of a given color.  Using the Bayes formula, we can express it like this (let's call it equation 1): 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img title="Equation 1" src="https://habrastorage.org/getpro/habr/post_images/08a/45d/179/08a45d1798dd91ac53810dc5c46bf568.png" alt="Equation 1" width="303" height="40"><br><br>  Please note that in this post the probabilities are denoted by the capital P [.]. <br><br>  The three conditions on the right side of the equation can be represented in a computable form.  Here the probabilistic approach will be useful to us and these two training data sets: the first consists of pixels belonging to areas with skin, and the second from pixels that do not belong.  We will teach a statistical model and get a formula for <b>P [color | skin]</b> .  The estimation of a priori <b>P [skin]</b> can be arbitrary in the sense that it depends on the final application for which the skin detector is being developed.  We will go in a simple way and determine the prior probability through the ratio of the number of pixels from the two training data sets.  With <b>P [color]</b> , there will be more problems at first, because reliable probability modeling for each possible color will require a huge training data set.  Fortunately, the full probability formula allows us to circumvent this problem by decomposing this term as follows: <br><br><img title="P [color] == P [color | skin] * P [skin] + P [color | nonskin] * P [nonskin]" src="https://habrastorage.org/getpro/habr/post_images/0e9/333/a76/0e9333a76b0371854fc5a83ff747da9d.png" width="354" height="32"><br><br>  Finally, our probabilistic skin detector will be implemented by the formula (let's call it equation 2): <br><br><img title="Equation 2" src="https://habrastorage.org/getpro/habr/post_images/4a4/d95/256/4a4d95256103b9d7f1236a28c5001dc7.png" alt="Equation 2" width="427" height="59"><br><br>  Let's now create two sets of images and train our model on them. <br><br>  I know firsthand that creating such collections is something like art, and requires a lot of effort.  However, this time we will not be particularly zealous and will collect instead only with a dozen of the images, which depict the skin.  Of course, serious statistically significant models would require hundreds of images and complex skin models. <br><br>  Using the <b>Graphics</b> menu in <b>Mathematica</b> , I can manually select areas with skin in the image and repeat the process for collections with images - frankly, not the most interesting part of my day: <br><br><img title="Selecting regions of skin" src="https://habrastorage.org/getpro/habr/post_images/f60/cd6/fbd/f60cd6fbd3883c62046ef9724c14fa67.png" alt="Selecting regions of skin" width="371" height="262"><br><br>  There is evidence that the standard RGB color space is not the best color space for implementing models with color separation by skin / not skin.  Most of the problems can arise from the fact that with different lighting and different facial features the skin looks different. <br><br>  As you can see, the colors of the skin and everything else (shown in red and green, respectively) do not overlap much in the images in the sample, but at the same time cover most of the three-dimensional RGB space: <br><br><img title="3D space of skin and non-skin colors" src="https://habrastorage.org/getpro/habr/post_images/b7d/906/7e9/b7d9067e9592440a77b7b6595f288167.png" alt="3D space of skin and non-skin colors" width="366" height="285"><br><br>  Let's experiment with a different color space, where such changes in how the skin looks, are modeled, perhaps, more reliably. <br><br>  CIE XYZ can be selected as the color space, and the skin color can be presented in two color and one luminance coordinates.  To develop models that are more resistant to changes in lighting conditions, we will work only with the color coordinates <i>x</i> and <i>y</i> , defined as <i>x</i> = <i>X</i> / ( <i>X</i> + <i>Y</i> + <i>Z</i> ) and <i>y</i> = <i>Y</i> / ( <i>X</i> + <i>Y</i> + <i>Z</i> ): <br>  The <b>colorConvertxy</b> function gives a two-channel <i>xy</i> image: <br><br><img title="colorConvertxy [img_]: = ImageApply [Most [#] / (Total [#] + $ MachineEpsilon) &amp; amp; ColorConvert [img, &amp; quot; XYZ &amp; quot;]];" src="https://habrastorage.org/getpro/habr/post_images/15b/68e/1ae/15b68e1ae679d84fde1710521d263d45.png" alt="colorConvertxy[img_] :=    ImageApply[Most[#]/(Total[#] + $MachineEpsilon) &amp;amp;,     ColorConvert[img, &amp;quot;XYZ&amp;quot;]];" width="445" height="54"><br><br>  The list of <i>xy</i> regions with skin is extracted using the image itself, a mask of skin areas and <a href="http://reference.wolfram.com/mathematica/ref/PixelValuePositions.html%3Fq%3DPixelValuePositions"><b>PixelValuePositions</b></a> and <a href="http://reference.wolfram.com/mathematica/ref/PixelValue.html%3Fq%3DPixelValue"><b>PixelValue functions</b></a> .  A list of pairs of <i>xy</i> areas of the skinless image can be obtained in exactly the same way. <br><br><img title="Extracting the list of non-skin xy pairs" src="https://habrastorage.org/getpro/habr/post_images/727/090/f31/727090f313b9705106bd246cc00947d4.png" alt="Extracting the list of non-skin xy pairs" width="362" height="122"><br><br>  In the two-dimensional <i>xy</i> color space, the regions with coordinates of skin points for all the training images have a smaller area than in RGB, and the difference between the areas with skin and without less pronounced.  In the distributions for the colors of areas with and without skin presented below, the first are in shades of green and the second in shades of red. <br><br><img title="Building a 3D whereto in the dataset" src="https://habrastorage.org/getpro/habr/post_images/d9a/97c/e45/d9a97ce4594c555084b61f16c60398e2.png" alt="Building a 3D histogram to illustrate where skin and non-skin regions are in the dataset" width="434" height="88"><br><br><img title="3D histogram of skin and non-skin regions" src="https://habrastorage.org/getpro/habr/post_images/e09/c91/4c9/e09c914c90731c8921c79c9f0c39904b.png" alt="3D histogram of skin and non-skin regions" width="446" height="312"><br><br>  Work in a two-dimensional <i>xy</i> color space is promising.  Let's go back and present the data-based statistical models for equation 2. For the convenience of the reader, we repeat the formula: <br><br><img title="Equation 2" src="https://habrastorage.org/getpro/habr/post_images/4a4/d95/256/4a4d95256103b9d7f1236a28c5001dc7.png" alt="Equation 2" width="427" height="59"><br><br>  The proportion of skinned pixels among the million pixels of the training data set is about 13%.  Let's keep this empirical value in our model for a priori probability <b>P [skin]</b> : <br><br><img title="pskin = N [Length [skinxy]] / (Length [skinxy] + Length [nonskinxy])" src="https://habrastorage.org/getpro/habr/post_images/35c/add/19e/35cadd19e1e76c047e9c0a8ea484a574.png" alt="pskin = N[Length[skinxy]] / (Length[skinxy] + Length[nonskinxy])" width="362" height="40"><br><br><img title="0.12706" src="https://habrastorage.org/getpro/habr/post_images/8ea/9a2/4a0/8ea9a24a096b6833ee62c56e89e7b137.png" alt="0.12706" width="104" height="18"><br><br>  To model the probability density functions <b>P [color | skin]</b> and <b>P [color | nonskin], it</b> comes to mind to use a certain mixture of Gaussian distributions.  These distributions may well be suitable for these <i>xy</i> pairs presented above.  However, on my laptop, calculations are done a little faster when choosing a model based on distributions with a smooth kernel distributions, which are built using the <a href="https://reference.wolfram.com/language/ref/SmoothKernelDistribution.html">SmoothKernelDistribution</a> function: <br><br><img title="pcolorskin = SmoothKernelDistribution [skinxy];" src="https://habrastorage.org/getpro/habr/post_images/ac5/1cb/1cb/ac51cb1cb735b915fe222b148ba413af.png" alt="pcolorskin = SmoothKernelDistribution[skinxy];" width="396" height="18"><br><br><img title="pcolornonskin = SmoothKernelDistribution [nonskinxy];" src="https://habrastorage.org/getpro/habr/post_images/994/a01/2ed/994a012ed7a00e013dab149a4bb73711.png" alt="pcolornonskin = SmoothKernelDistribution[nonskinxy];" width="445" height="20"><br><br>  Finally, the probability that a given color in <i>xy</i> corresponds to the skin can be represented through the following function: <br><br><img title="probabilityskin = Function [{x, y}, Evaluate [(pskin PDF [pcolorskin, {x, y}]) / ((1 - pskin) PDF [pcolornonskin, {x, y}] + pskin PDF [pcolorskin, {x , y}] + $ MachineEpsilon)]];" src="https://habrastorage.org/getpro/habr/post_images/e7a/bf9/145/e7abf91454cdaf94256c54e08c14981d.png" alt="probabilityskin =    Function[{x, y},     Evaluate[(pskin PDF[         pcolorskin, {x, y}])/((1 - pskin) PDF[pcolornonskin, {x, y}] +         pskin PDF[pcolorskin, {x, y}] + $MachineEpsilon)]];" width="484" height="88"><br><br><img title="Plot3D [probabilityskin [x, y], {x, 0, 1}, {y, 0, 1}]" src="https://habrastorage.org/getpro/habr/post_images/855/b36/c47/855b36c47ccdf0af0536dcff669de053.png" alt="Plot3D[probabilityskin[x, y], {x, 0, 1}, {y, 0, 1}]" width="427" height="17"><br><br><img title="Xy color" src="https://habrastorage.org/getpro/habr/post_images/8e6/125/1e4/8e61251e420257b4a0e093f877242a5d.png" alt="3D plot of the probability that a given xy color corresponds to skin" width="410" height="286"><br><br>  How will the presented model work?  Let's apply the function to several test images: <br><br><img title="skinness [image_]: = ImageApply [probabilityskin [Sequence @@ #] &amp; amp; colorConvertxy [image]];" src="https://habrastorage.org/getpro/habr/post_images/b00/103/319/b00103319b5bbe01d42be9590f4b0c3f.png" alt="skinness[image_] :=      ImageApply[probabilityskin[Sequence @@ #] &amp;amp;, colorConvertxy[image]];" width="392" height="51"><br><br><img title="Applying the skin detection function" src="https://habrastorage.org/getpro/habr/post_images/5ea/272/43f/5ea27243f0084a06016f3c92d3ecf685.png" alt="Applying the skin detection function" width="377" height="200"><br><br><img title="Final result with skin detected" src="https://habrastorage.org/getpro/habr/post_images/3c3/91b/f1e/3c391bf1e490524071eadfbd27e4b50b.png" alt="Final result with skin detected" width="497" height="390"><br><br>  Not bad, is it?  But with another test image below it turns out interesting - the blurred area on the border between the red T-shirt and the green foliage is incorrectly and accurately defined as leather. <br><br><img title="Running the skin detection app" src="https://habrastorage.org/getpro/habr/post_images/6a9/000/21d/6a900021d6152537f69f42ac6e0aeb1a.png" alt="Running the skin detection app" width="378" height="178"><br><br><img title="Example image with skin being detected" src="https://habrastorage.org/getpro/habr/post_images/223/640/626/223640626a66fac7c381838d409a83f0.png" alt="Example image with skin being detected" width="497" height="348"><br><br>  Everything is almost done.  In fact, skin detection requires deciding whether a pixel belongs to the skin.  To create such a binary image, we could set a threshold for the images we received.  However, what threshold to choose?  If you choose too high, then the skin pixels may not show up.  If you choose too low, then the number of skinless pixels defined as skin will be large.  All this leads to the construction and analysis of ROC curves.  Yes, it would be great to recreate this functionality with <i>Mathematica</i> , but I believe that this topic deserves more attention.  In general, another time, in another post. <br><br>  In an alternative strategy, it is proposed to compare the probabilities for a pixel to be part of an area with skin or not.  Like last time, let's use the probabilistic approach and reconsider equation 1: <b>P [skin | color] == P [color | skin] * P [skin] / P [color]</b> .  In the same way, it is possible to express the posterior probability that a given pixel does not belong to an area with skin: <br><br><img title="P [nonskin | color] == P [color | nonskin] * P [nonskin] / P [color]" src="https://habrastorage.org/getpro/habr/post_images/5a8/e06/b09/5a8e06b0991f2df99a801c7e022cc483.png" alt="P[nonskin|color] ==   P[color|nonskin]*P[nonskin]/P[color]" width="309" height="33"><br><br>  To sort this color by skin / not skin, we just need to compare the posterior probabilities obtained and select a large one.  <b>P [color]</b> can be dropped, and then the pixel will be defined as belonging to the skin area if <b>P [color | skin] * P [skin]&gt; P [color | nonskin] * P [nonskin]</b> . <br><br>  Here is how the skin detector works at the moment: <br><br><img title="Building the skin detector" src="https://habrastorage.org/getpro/habr/post_images/b42/9e5/671/b429e5671eb72a9843b6418c04a9131d.png" alt="Building the skin detector" width="484" height="89"><br><br>  A quick assessment of test images allows us to conclude that the system copes well with the task: <br><br><img title="Performing the analysis" src="https://habrastorage.org/getpro/habr/post_images/21e/5c2/a4a/21e5c2a4a881f146ba38abd1a9ec5453.png" alt="Performing the analysis on two test images" width="429" height="96"><br><br><img title="Two test images with skin detected" src="https://habrastorage.org/getpro/habr/post_images/284/bcf/13e/284bcf13ec89c2abd64b2d0593dd7b84.png" alt="Two test images with skin detected" width="318" height="394"><br><br>  Let's end this topic with a skin detection application: <br><br><img title="Showing the skin detection app" src="https://habrastorage.org/getpro/habr/post_images/4f4/cc9/813/4f4cc9813b5f7a9ada0524fc7413cc3e.png" alt="Showing the skin detection app" width="418" height="156"><br><br><img title="Example images with skin being highlighted" src="https://habrastorage.org/getpro/habr/post_images/eb6/b25/85b/eb6b2585b4ef721d5dfd317d6dc73c33.png" alt="Example images with skin being highlighted" width="317" height="395"><br><br>  Initially, my goal was to create a skin detector purely from pleasure in exploring the interactions between probabilities, statistics, and image processing.  Practically every element of our final version of a skin detector (for example, a training sample, a choice of statistical distributions, a classifier, a quantitative assessment) can be studied in more detail and improved using the wide functionality of <i>Mathematica</i> . </div><p>Source: <a href="https://habr.com/ru/post/261413/">https://habr.com/ru/post/261413/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../261395/index.html">Free webinar "Choosing a Transportation Management Systems class information system"</a></li>
<li><a href="../261397/index.html">10 fatal mistakes of the usability of online stores and something else</a></li>
<li><a href="../261403/index.html">How to treat a malfunctioning cloud provider</a></li>
<li><a href="../261405/index.html">Consolidation of offices in 3CX (Part 1. We use trunks)</a></li>
<li><a href="../261409/index.html">Import substitution, as was said</a></li>
<li><a href="../261415/index.html">Your cloud hosting in 5 minutes. Part 1: Ansible, Docker, Docker Swarm</a></li>
<li><a href="../261417/index.html">The Subtleties of ES6: Collections (Part 2)</a></li>
<li><a href="../261419/index.html">CIFS in Android, or how I got files from a broken phone</a></li>
<li><a href="../261421/index.html">The magic of tensor algebra: Part 1 - what is a tensor and what is it for?</a></li>
<li><a href="../261425/index.html">Combining Qt and AdMob</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>