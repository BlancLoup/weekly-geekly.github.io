<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How is the DHCP lease duration and DNS garbage collection process related?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a preface. When communicating with colleagues, answering their questions about the joint configuration of DNS and DHCP, I often refer them to the w...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How is the DHCP lease duration and DNS garbage collection process related?</h1><div class="post__text post__text-html js-mediator-article">  As a preface.  <i>When communicating with colleagues, answering their questions about the joint configuration of DNS and DHCP, I often refer them to the wonderful <a href="https://blogs.technet.microsoft.com/askpfe/2011/06/03/how-dns-scavenging-and-the-dhcp-lease-duration-relate/">article by</a> <a href="https://social.technet.microsoft.com/profile/Sean%2BIvey%2B%255BMSFT%255D">Sean Ivey</a> on Technet.</i>  <i>Unfortunately, I did not find a similar material in Russian.</i>  <i>Once again, when I orally translated it to a friend, I decided to issue a translation in order to be able to send to him.</i> <br><br>  Hello everyone, my name is Shawn Ivey and I am US PFE (Premier Field Engineer).  My specialty is Windows and Active Directory.  Simply put, I specialize in Active Directory and its associated network services.  Recently, with three different clients, I helped SCCM administrators who had a problem installing the SCCM agent.  In the <b>ccm.log</b> log, <b>there</b> was an error <b>Failed to get token for current process (5)</b> .  We found that the problem was not in SCCM, but in the interaction of DNS and DHCP.  As it turned out, other services also experienced related problems, simply either showed other symptoms or did not show them at all.  Let's talk about why it happened and how it can be prevented! <br><a name="habracut"></a><br>  Consider the following scenario: <br><h3>  DHCP </h3><br><ul><li>  The DHCP area is configured with IP addresses, with a lease term of 8 days </li><li>  There are few free IP addresses in the DHCP area </li><li>  Client A did not renew the rental of his address for 8 days and it expired </li><li>  Client B requests a new IP address </li><li>  DHCP server gives Client B the address previously used by Client A </li></ul><br><br>  So far, so good.  This is a fairly typical scenario of the DHCP server and everything happens exactly as we expect.  Let's add the DNS server here now. <br><h3>  DNS </h3><br><ul><li>  Active Directory-integrated DNS zone with zone cleaning configured </li><li>  Clear default settings: ‚ÄúBlock interval = 7 days‚Äù and ‚ÄúUpdate interval = 7 days‚Äù </li><li>  Server settings are also default: ‚ÄúCleanup period = 7 days‚Äù </li><li>  Client A updated the DNS record 8 days ago (on the very day he received his address) </li><li>  Client A is the owner of its DNS record and it cannot be deleted by a DHCP server (with default settings) </li><li>  Client B tries to register a DNS entry with a new address that he received from a DHCP server </li><li>  This is the same IP address that Client A used! </li><li>  DNS server will not be able to clean the old record of the Client And 6 more days! </li></ul><br>  (If, all of a sudden, you don‚Äôt know what a ‚Äúcleaning zone‚Äù is, ‚Äúblocking / updating interval‚Äù, then I recommend you to read <a href="https://blogs.technet.microsoft.com/networking/2008/03/19/dont-be-afraid-of-dns-scavenging-just-be-patient/">my colleague‚Äôs blog</a> . It‚Äôs awesome! <i>Note: since you‚Äôre reading a translation of the original article, then it may be easier for you get acquainted with the Russian-language <a href="https://technet.microsoft.com/ru-ru/library/cc771677.aspx">material</a></i> ) <br>  Now everything is not so good.  This happens more often than you might think.  Now Clients A and B have DNS records that refer to the same IP address. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/226/c10/aac/226c10aac68949a280d7ef2a577eaa4c.jpg"><br>  <font color="#4D8EE3"><b>Picture 1</b></font> <br><br>  So, we have two different names in the DNS that refer to the same IP address.  And, most likely, everything will remain like this at least another 6 days, until the intervals described above expire.  What problems can this cause?  Let's get a look. <br><br><h3>  Problem </h3><br>  I already mentioned that the symptom of this situation was the problem with installing the SCCM client, but, in fact, we can use to demonstrate a simpler example - access to a shared folder.  The principle is the same. <br><br>  Let's imagine that I need to access the shared folder on Client A. For example, let's take one of the administrative shared folders. <br><br><img src="https://habrastorage.org/files/f07/bc6/87d/f07bc687de3941029e21dd26d424f9bc.jpg"><br>  <font color="#4D8EE3"><b>Figure 2</b></font> <br><br>  But this is already interesting.  First, client A is not even included ... but we get a response on his behalf.  And this is an authentication error!  Some of you have already guessed that this happens when you send a Kerberos session key intended for one computer to another, but let's take it in order. <br><br>  We see that our computer (Infra-App1) sends a request to DNS in the name client-a.corp.contoso.com.  In response, he receives the IP address 10.0.0.100. <br><br><img src="https://habrastorage.org/files/e44/fad/610/e44fad610cb24ad1b418928c56c3c3e1.jpg"><br>  <font color="#4D8EE3"><b>Figure 3</b></font> <br><br>  As far as DNS is known, it is.  Client A actually has the address 10.0.0.100, but Client B. has the exact same address. <br><br>  Great, now we get the Kerberos session key.  But the DNS request was addressed to Client A, so the response from the Kerberos service will also be addressed to client A. <br><br><img src="https://habrastorage.org/files/e92/831/846/e928318466db4dcb996ea3ae9c2f4c17.jpg"><br>  <font color="#4D8EE3"><b>Figure 4</b></font> <br><img src="https://habrastorage.org/files/035/d1e/94d/035d1e94d9fb4d65983b5107595d5250.jpg"><br>  <font color="#4D8EE3"><b>Figure 5</b></font> <br><br>  We see the request for Figure 4 and the response of the domain controller in Figure 5. <br><br>  Now, having received the key, we can try to connect to what we consider to be Client A. <br><br><img src="https://habrastorage.org/files/075/366/00d/07536600d55d4a2f9675c6c658d20777.jpg"><br>  <font color="#4D8EE3"><b>Figure 6</b></font> <br><br>  Here we see the Kerberos session key. <br><br>  And finally, we see an error message from Client A. Why?  Because Client A is not Client A, but Client B. <br><br><img src="https://habrastorage.org/files/784/c9e/2f8/784c9e2f898a4a5fb4915737f68835cc.jpg"><br>  <font color="#4D8EE3"><b>Figure 7</b></font> <br><br>  All this only confirms what you probably already knew.  In order for Kerberos to work normally, you must contact the correct session key with the correct recipient (If you want to learn more about Kerberos, read Rob Green's blog " <a href="https://blogs.technet.microsoft.com/askds/2008/03/06/kerberos-for-the-busy-admin/">Kerberos for busy admins</a> " <i>Note: I did not find similar material in Russian, but with general information can be found <a href="https://technet.microsoft.com/ru-ru/library/hh831553.aspx">here</a></i> ). <br><br>  Of course, everything will work fine if, instead of the FQDN of the name, we turn to the IP address.  Why?  Because in this case, NTLM authentication will be used instead of Kerberos.  Using an IP address, we make no assumptions about which client we connect to.  We simply connect to a specific IP address.  Some of you might think that for the FQDN should work.  In the end, getting an error when using Kerberos, we have to switch to NTLM, right?  Not really.  I will not go into details, but we will switch to NTLM only if we could not agree on using Kerberos.  You can read more about this <a href="http://technet.microsoft.com/en-us/library/cc780455(WS.10).aspx">here</a> .  In any case, Kerberos did not return errors to us, he regularly answered us with the session key. <br><br><h3>  How to prevent </h3><br>  Now that we‚Äôve figured out that the problem is caused by outdated DNS records, let's discuss how we can prevent this situation.  There are several different ways to do this.  Let's discuss each of them. <br><br>  Note: I recommend reducing the cleaning interval for each of these methods to 1-3 days.  The default 7-day interval allows problem logs to remain in the DNS for too long. <br><br><ol><li>  Increase the duration of the DHCP lease so that it matches the sum of the refresh and block intervals.  In our example, we will increase it to 14 days. <br><br>  Benefits: <br><ol><li>  By the time DHCP can issue an address to a new client, the old DNS record may already be deleted. </li><li>  Ease of implementation </li></ol><br>  Disadvantages: <br><ol><li>  If you already have few free IP addresses in DHCP, they can simply end. </li><li>  The moment of cleaning the zone does not necessarily coincide with the time the expiration of the update and blocking intervals (and therefore the DHCP lease time) and we can get the situation described above for a short time.  To reduce the number of such problems, we can reduce the cleaning interval to 1 day. </li></ol><br></li><li>  Reduce the update and blocking intervals so that their amount matches the length of the DHCP lease.  In our example, we will reduce both intervals to 4 days. <br><br>  Benefits: <br><ol><li>  The existing DNS record will be cleared earlier.  In essence, the result will be similar to the previous one. </li><li>  Ease of implementation </li></ol><br>  Disadvantages: <br><ol><li>  The load on Active Directory replication will slightly increase (if, of course, this is an Active Directory integrated zone).  This is because clients will update their DNS records more often (in our case, every 4 days instead of 7) </li><li>  The moment of cleaning the zone does not necessarily coincide with the time the expiration of the update and blocking intervals (and therefore the DHCP lease time) and we can get the situation described above for a short time.  To reduce the number of such problems, we can reduce the cleaning interval to 1 day. </li></ol><br></li><li>  Configure a DHCP server so that it registers DNS records on behalf of clients (you can read how to configure it <a href="https://support.microsoft.com/en-us/kb/816592">here.</a> <i>Note: in Russian, <a href="https://technet.microsoft.com/ru-ru/library/cc771732.aspx">here</a></i> ) <br><br>  Benefits: <br><ol><li>  DHCP server will delete records in DNS immediately after the lease of the IP address </li><li>  With proper setup, you will never have such problem records. </li></ol><br>  Disadvantages: <br><ol><li>  More complex setup requires the involvement of more qualified staff. </li><li>  Setup is further complicated by the need for a service account, on behalf of which the DHCP server will work or all DHCP servers will need to be added to the DNSUpdateProxy group (a less secure option) </li></ol><br></li></ol><br><br>  Try experimenting with the update and blocking intervals and the length of the DHCP lease.  You may find that changing the default intervals has a beneficial effect on the performance of your network services.  Short term DHCP leases are often used for wireless networks.  At the same time, do not forget about the additional load that you place on the server, especially if you configure frequent (every few hours) cleaning for a very large DNS zone. <br><br><h3>  Search DNS records with the same IP address </h3><br><br>  Almost all!  Now we understand why this situation occurs when a problem occurs and how to prevent it.  But how can we easily and quickly find such records if trouble has already happened?  You can easily find such paired records in DNS using a simple PowerShell script (this is certainly not the only way). <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#Import the Active Directory Module import-module activedirectory #Define an empty array to store computers with duplicate IP address registrations in DNS $duplicate_comp = @() #Get all computers in the current Active Directory domain along with the IPv4 address #The IPv4 address is not a property on the computer account so a DNS lookup is performed #The list of computers is sorted based on IPv4 address and assigned to the variable $comp $comp = get-adcomputer -filter * -properties ipv4address | sort-object -property ipv4address #For each computer object returned, assign just a sorted list of all #of the IPv4 addresses for each computer to $sorted_ipv4 $sorted_ipv4 = $comp | foreach {$_.ipv4address} | sort-object #For each computer object returned, assign just a sorted, unique list #of all of the IPv4 addresses for each computer to $unique_ipv4 $unique_ipv4 = $comp | foreach {$_.ipv4address} | sort-object | get-unique #compare $unique_ipv4 to $sorted_ipv4 and assign just the additional #IPv4 addresses in $sorted_ipv4 to $duplicate_ipv4 $duplicate_ipv4 = Compare-object -referenceobject $unique_ipv4 -differenceobject $sorted_ipv4 | foreach {$_.inputobject} #For each instance in $duplicate_ipv4 and for each instance #in $comp, compare $duplicate_ipv4 to $comp If they are equal, assign #the computer object to array $duplicate_comp foreach ($duplicate_inst in $duplicate_ipv4) { foreach ($comp_inst in $comp) { if (!($duplicate_inst.compareto($comp_inst.ipv4address))) { $duplicate_comp = $duplicate_comp + $comp_inst } } } #Pipe all of the duplicate computers to a formatted table $duplicate_comp | ft name,ipv4address -a</span></span></code> </pre> <br><br>  Below is a sample output of this script: <br><br><img src="https://habrastorage.org/files/f61/6a3/489/f616a3489805434bb5a4587221d5cbb7.jpg"><br>  <font color="#4D8EE3"><b>Figure 8</b></font> <br><br>  The script is very simple.  Consider it only as an example.  It will return duplicate IP addresses registered for computer accounts in Active Directory.  Remember that he will request all computer objects from the Active Directory domain and check the IP address of each of them in the DNS.  If you have many computers, use the -searchbase option with the get-adcomputer command to limit the number of objects polled each time.  If your computer is not included in the Active Directory domain, then you will not be able to find it with the get-adcomputer command.  My script is specifically designed to get duplicate DNS records for the script I described above. <br><br><h3>  Conclusion </h3><br>  There are so many articles on configuring DHCP and DNS integration.  The purpose of this is to summarize how these two services work together to make it easier for you to understand.  Summarize: <br><br><ul><li>  Scenario <br><br><ul><li>  DHCP lease address duration and default update and blocking intervals = obsolete DNS records </li></ul><br></li><li>  Symptoms <br><br><ul><li>  SCCM: ‚ÄúFailed to get token for current process (5)‚Äù </li><li>  Shared folders: ‚ÄúLogon Failure: The target account name is incorrect‚Äù </li><li>  Any other services using Kerberos can also produce various errors. </li></ul><br></li><li>  Problem <br><br><ul><li>  Correct operation of Kerberos requires that the session key be issued specifically for the computer with which we are trying to establish a connection.  Outdated DNS records can lead to situations where we will access one computer with a key for another. </li></ul><br></li><li>  Decision <br><br><ul><li>  Change the refresh and blocking intervals and / or the duration of a DHCP lease </li><li>  Configuring DHCP for the server to register DNS records on behalf of clients </li><li>  Find and delete duplicate entries </li></ul><br></li></ul><br><br>  I hope that the article was useful to you!  Proper configuration of DNS and DHCP integration will relieve you of such problems on your network! </div><p>Source: <a href="https://habr.com/ru/post/281410/">https://habr.com/ru/post/281410/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../28140/index.html">Not a drop of champagne ...</a></li>
<li><a href="../281400/index.html">R: Geospatial Libraries</a></li>
<li><a href="../281404/index.html">What is grammatical evolution + easy implementation</a></li>
<li><a href="../281406/index.html">Briefly about OpenID Connect</a></li>
<li><a href="../281408/index.html">Replenishment in light weight. Or new low-port switches Ubiquiti</a></li>
<li><a href="../281412/index.html">NVRAM device in UEFI-compatible firmware, part two</a></li>
<li><a href="../281416/index.html">FAQ on Java-conference for students in Moscow</a></li>
<li><a href="../281418/index.html">Turning on the Linux subsystem in Windows 10</a></li>
<li><a href="../28142/index.html">Error codes Habra?</a></li>
<li><a href="../281420/index.html">Y. Gagarin and Web Audio API from Yandex</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>