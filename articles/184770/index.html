<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Where is my post office? - search post office DoubleGis index</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once after the move, I had to be puzzled by the search for my post office. In the latest versions of the desktop version 2Gis, fortunately, for most c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Where is my post office? - search post office DoubleGis index</h1><div class="post__text post__text-html js-mediator-article">  Once after the move, I had to be puzzled by the search for my post office.  In the latest versions of the desktop version 2Gis, fortunately, for most cities there is information about building indexes and ultimately the search came down to choosing a post office at a number equal to the last three digits of the index, but the number of routine operations for this was quite large and wanted at leisure as a warm-up for the mind and for the love of applied algorithms, try to automate this process. <br><img src="https://habrastorage.org/storage2/c0b/1c8/7c3/c0b1c87c3c0b6548cb6715d600a0a984.png"><br><a name="habracut"></a><br><h4>  Attempt # 1 </h4><br>  First, it was decided to go "on the forehead", that is, to find a way to get the post office address immediately by index.  The method was found quite quickly - on the Russian Post site there is a service <a href="http://www.russianpost.ru/rp/servise/ru/home/postuslug/searchops">Search for postal offices</a> that implements this task.  Although the stability and speed of this service leaves much to be desired (for the last few days it has been completely disabled due to maintenance work), quite a few third-party services have been found that mirror this information, for example, <a href="http://gdeposylka.ru/info/pochtamt/101000">PostPostilka</a> or <a href="http://www.rospt.ru/pochta_101000.html">Independent rating of Russian post offices</a> .  However, another problem arose - the received address could only be fed to the application via the user interface in the universal ‚ÄúWhere‚Äù field: <br><img src="https://habrastorage.org/storage2/b7a/1dc/282/b7a1dc282d852fc38d4f97b02df1dc46.png"><br>  However, the API of plugins does not have such an opportunity; the search method needs to be delivered to three separate fields: settlement, street, house.  In principle, at this stage it would be possible to try puzzled by biting the address fields from the resulting line, but this task did not seem interesting and it was decided to go around (perhaps now I would return to this option). <br><br><h4>  Attempt # 2 </h4><br>  In addition to the address of the post office, the above services also report its name, which, in general, consists of the name of the settlement and the sequence number of the department if there are several of them.  This information, in general, should be enough to search for the directory of organizations (by locality and the name of the department).  At this stage, the first working version of the plug-in was implemented, which polls all three of the above services based on their availability ( <a href="https://github.com/askell/2GisPostOfficeByIndex/tree/master">repository on GitHub</a> ).  However, in any case, the response time was unstable and the ideology of the desktop application 2Gis suggests the possibility of full-fledged work in offline mode. <br><br><h4>  Attempt number 3 </h4><br>  After a brief search for the offline database, the <a href="http://info.russianpost.ru/database/ops.html">Reference Postal Code Directory of the postal objects</a> was found, which is a DBF file, and also updated with an enviable periodicity.  From the 18-megabyte file, only the necessary information was sampled and included in the plugin. <br>  However, at this stage, a number of problems were discovered with the names of post offices and their assignment to settlements.  Almost all of them managed to be solved in the current implementation of the plugin (the <a href="https://github.com/askell/2GisPostOfficeByIndex/tree/separateButton">current branch on GitHub</a> ). <br>  Below is the main algorithm for generating criteria for finding a post office in the directory of organizations: <br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//     string postOfficeName = LocalFileInformationService.Instance.GetPostOffice(postIndex); if (postOfficeName != null) { //     "&lt; &gt; &lt;&gt;" Match m = CITY_POST_OFFICE_NAME.Match(postOfficeName); String city; String number; if (m.Success) { //     city = m.Groups[1].Value; number = m.Groups[2].Value; } else { // ,        city = postOfficeName; number = null; } try { ICriteriaSet criteries = _pBaseView.Factory.CreateCriteriaSet(); //     " " criteries.set_Criterion("grym_rub:name", " "); string gisCityName; if (_cities.TryGetValue(city, out gisCityName)) { //        ,     ,       criteries.set_Criterion("grym_city:name", gisCityName); } if (number != null) { //     ,        criteries.set_Criterion("grym_name", number); } else { //        int officesCount = LocalFileInformationService.Instance.GetCityPostOffices(city, postIndex.Substring(0, 3)); if (officesCount &gt; 2) { //      ( )  ,        "" criteries.set_Criterion("grym_name", ""); } else if (String.IsNullOrEmpty(gisCityName)) { //          ( .   .       ),         //       ,       ,          . if (((int)dr.Value["addr_count"]) &gt; 0) { //        string featureCity = dr.Value["city"].ToString(); //           int officesCount2 = LocalFileInformationService.Instance.GetCityPostOffices(NormalizeCityName(featureCity), postIndex.Substring(0, 3)); if (officesCount2 &gt; 0) { //         ,      ,     (     ) (. , ) //       criteries.set_Criterion("grym_name", city); } else { //              . ,          //     .  ,    criteries.set_Criterion("grym_city:name", featureCity); } // else     ,     ,     ? } else { //   ? ,      criteries.set_Criterion("grym_name", city); } } } _pBaseView.Frame.DirectoryCollection.Search(criteries, "  " + postIndex, "&lt;criterion&gt; &lt;/criterion&gt;&lt;description&gt;" + postOfficeName + "&lt;/description&gt;"); } catch (Exception e) { MessageBox.Show(e.Message + e.StackTrace + e.GetType().ToString()); } } else { MessageBox.Show(",     ."); }</span></span></code> </pre> <br>  There is only a problem with the village of Timiryazevo, officially part of the city of Tomsk - the branch in it is called ‚ÄúTimiryazevsky‚Äù, but the village itself is not allocated in the directory as an independent settlement (which it is).  It may be worth returning to step 1 and try to work with the address information. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Attempt # 4 </h5><br>  There was also an assumption that the building in which the post office is located has the same index as the department itself, but this turned out to be wrong, for example, Post Office No. 39 in Prokopyevsk has an index of 653033. In addition, API 2Gis does not allow in <a href="http://plugins.2gis.ru/wiki/%25D0%25A1%25D1%2582%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0%25D1%2580%25D1%2582%25D0%25BD%25D1%258B%25D0%25B5_%25D0%25BA%25D1%2580%25D0%25B8%25D1%2582%25D0%25B5%25D1%2580%25D0%25B8%25D0%25B8_%25D0%25BF%25D0%25BE%25D0%25B8%25D1%2581%25D0%25BA%25D0%25B0">the search criteria of organizations</a> indicate the zip code of the building. <br><br><h4>  Buns and improvements. </h4><br><h5>  Auto update. </h5><br>  Given the frequency of updates of the reference directory, there is a desire to add the auto-update function of the index database. <br><br><h5>  Interface. </h5><br>  When the plug-in was conceived, there was a desire to embed its functionality as much as possible into the existing interface, that is, to make the building index in the building information card a hyperlink initiating a search: <br><img src="https://habrastorage.org/storage2/7b2/ee0/8ec/7b2ee08ec3906a449e1e5f439ad29b7a.png"><br>  However, the staff API does not provide for such a possibility, but a workaround was found with the substitution of the controller for this tab (implemented in the first version of the plugin): <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">CustomMainController</span></span> : <span class="hljs-title"><span class="hljs-title">IMapInfoController</span></span>, <span class="hljs-title"><span class="hljs-title">IControlAppearance</span></span>, <span class="hljs-title"><span class="hljs-title">IObjectCustomization</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IMapInfoController _innerController; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IBaseViewThread _pBaseView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _currentCity; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CustomMainController</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IBaseViewThread pBaseView</span></span></span><span class="hljs-function">)</span></span> { _innerController = ((GrymCore.IMapInfoControllers2)pBaseView.Frame.Map.MapInfoControllers).FindMapInfoController(<span class="hljs-string"><span class="hljs-string">"Grym.MapInfo.Default"</span></span>); _pBaseView = pBaseView; _currentCity=_pBaseView.BaseReference.Name; ((GrymCore.IMapInfoControllers2)pBaseView.Frame.Map.MapInfoControllers).RemoveController(_innerController); ((GrymCore.IMapInfoControllers2)pBaseView.Frame.Map.MapInfoControllers).AddController(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); PostalInformationServiceManager.Instance.BaseViewThread = _pBaseView; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Check</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">IFeature f</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _innerController.Check(f); } ... }</code> </pre><br>  However, this implementation has some problems: the information tab moves to the end of the list and failures occur while simultaneously running several copies of a directory for different cities), so for now the idea was abandoned in favor of a regular customizer mechanism that allows adding custom links to the card footer. <br><br><h4>  Conclusion </h4><br>  At this stage, the primary tasks of writing a plugin (to solve an interesting puzzle, learn something new, remember c #) seem to be done.  In addition, there was an idea of ‚Äã‚Äãanother plug-in that extends the functionality of the "Works Now" filter.  Therefore, we must decide what to do next.  In this I would like to listen to the opinion of the community - suddenly someone will be interested in this development or there will be interesting ideas for its development. <br><br><h5>  Download: </h5><br>  <a href="">Normal plugin version</a> <br>  <a href="">The version of the plug-in replaces the index of the building on the link</a> (carefully, the version is unstable and can lead to a 2Gis shell fall). </div><p>Source: <a href="https://habr.com/ru/post/184770/">https://habr.com/ru/post/184770/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../184754/index.html">Old-Hard communication, or ‚Äúfile transfer via COM and LPT ports‚Äù</a></li>
<li><a href="../184756/index.html">Access to SOAP web services 1C from JavaScript and Html</a></li>
<li><a href="../184758/index.html">Service - how much sense in this word ... but is there such a word?</a></li>
<li><a href="../184762/index.html">Taist: sharpen the "clouds" by yourself</a></li>
<li><a href="../184766/index.html">The evolution of racing cars on javascript</a></li>
<li><a href="../184772/index.html">USB flash drive Leef Bridge with micro USB connectors</a></li>
<li><a href="../184778/index.html">Richard Stallman and Aaron Schwartz taken to the Internet Hall of Fame</a></li>
<li><a href="../184780/index.html">Samsung Galaxy S4 and HTC One are available for order on Google Play</a></li>
<li><a href="../184786/index.html">How do you make a living,% username%?</a></li>
<li><a href="../184788/index.html">How Yandeks.Pochta began to understand what you need</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>