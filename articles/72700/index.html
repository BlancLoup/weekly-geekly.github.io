<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The task of displaying trees in MySql. How to display on stored procedures</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 

 I really wanted to raise the issue of tree structures in MySql. Specifically, about sampling and data storage ... 
 Oracle users and Post...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The task of displaying trees in MySql. How to display on stored procedures</h1><div class="post__text post__text-html js-mediator-article">  Good day. <br><br>  I really wanted to raise the issue of tree structures in MySql.  Specifically, about sampling and data storage ... <br>  Oracle users and PostgresSQL live well, these databases have built-in tools for retrieving recurrent data (see <a href="http://habrahabr.ru/blogs/sql/43955/">Hierarchical (recursive) queries</a> ). <br>  Mysql users have to work with what is, that is, work on the client side. <br>  Since this topic has been raised more than once, I will try to talk about a specific task and how to solve it. <br><a name="habracut"></a><br><h2>  Task </h2><br>  There is a project in php, it has a double structure implemented in the table mysql catalog (id int NOT NULL, pid int NOT NULL, ...) <br>  pid is the id of the parent.  That is, the data is stored in one table, each cell refers to the parent.  Thus the whole tree is formed. <br>  Naturally, the table stores a bunch of related data, the description of which I will omit, since they will not affect the essence of the task, but will only interfere. <br><br>  An example of such data storage: <br> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   ";</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   "; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   "; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   "; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   "; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   "; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TABLE</font> <font color="#0000ff">catalog</font> ( id <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> <font color="#0000ff">PRIMARY</font> , pid <font color="#0000ff">INT</font> <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> , someData text <font color="#0000ff">NOT</font> <font color="#0000ff">NULL</font> ) comment = "   ";</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <table> <tbody><tr><th>  id </th><th>  pid </th><th>  someData </th></tr><tr><td>  one </td><td>  0 </td><td>  Catalog </td></tr><tr><td>  2 </td><td>  one </td><td>  Book 1 </td></tr><tr><td>  3 </td><td>  one </td><td>  Book 2 </td></tr><tr><td>  four </td><td>  3 </td><td>  Chapter 1 </td></tr><tr><td>  five </td><td>  3 </td><td>  Chapter 2 </td></tr><tr><td>  6 </td><td>  3 </td><td>  Chapter 3 </td></tr></tbody></table><br><img src="http://img5.imageshack.us/img5/232/treeug.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The entire tree is sampled recursively on the client side.  The total base of 500MB, and will continue to grow.  Since there are many branches and nodes, the total number of requests to the database currently ranges from 300 to 1000. <br><br>  As a result of recurrent sampling, an array of data is formed (for some reason, also of a recurrent type), which is given to the template engine. <br>  The task is to optimize the sample so that it pulls out the necessary data in one query (well, or two or three, but not so that there are so many ...) <br><br><h2>  Solution </h2><br><br>  The task as a whole is trivial.  She repeatedly decided.  <strong>Additional data</strong> are entered that is used to restrict the selection from the table.  The whole question boils down to what kind of additional field (s).  One way or another, additional data leads to redundancy, which means overhead for maintaining the correctness of data. <br><br>  In publications, the most common solution is with an additional field of the varchar type, in which id-names are stored, separated by a special character.  This field is used for sorting and limiting by something like% ...%. <br><br>  In general, the solution is very good, but has its drawbacks: <br><ol><li>  natural restriction on hierarchy nesting. </li><li>  overhead and difficulty supporting this field.  (in my case, if you write a script involved in supporting this field, then it will just hang on timeout, which means you need to do these actions in cron) </li><li>  a serious load on the network, which is the basis for setting the task, the load is not where it has gone, it is just in the background, and the server still slows down. </li><li>  in case of transferring tree nodes, update this field data. </li></ol><br><br>  As a result, we get a rather difficult and complicated decision.  There was no time for its implementation as always. <br><br>  To solve all the problems outlined above, you need to act differently.  First, it is better to do the formation of additional data where this data is located, that is, on the side of the database.  Secondly, supporting additional data is an overhead, so it‚Äôs best to update it every time. <br><br>  This concept is implemented as follows: a simple procedure is written that would form the data for the tmp__index timestamp, performing a recurrent tree walk. <br>  Here is the real procedure code: <br><br> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ;</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) BEGIN <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; ELSE <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ; <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">DELIMITER $$ <font color="#0000ff">DROP</font> <font color="#0000ff">PROCEDURE</font> <font color="#0000ff">IF</font> <font color="#0000ff">EXISTS</font> `getIndexToTmpTable`$$ /** main_id -      search_id -     zlevel -   ,     , -  -1 -      sublevel -   ,       -  1 */ <font color="#0000ff">CREATE</font> <font color="#0000ff">PROCEDURE</font> `getIndexToTmpTable` ( <font color="#0000ff">in</font> main_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> search_id <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> zlevel <font color="#0000ff">INT</font> , <font color="#0000ff">in</font> sublevel <font color="#0000ff">INT</font> ) <font color="#0000ff">BEGIN</font> <font color="#0000ff">DECLARE</font> done <font color="#0000ff">INT</font> <font color="#0000ff">DEFAULT</font> 0; <font color="#0000ff">DECLARE</font> catalog_id <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> catalog_pid <font color="#0000ff">INT</font> ; <font color="#0000ff">DECLARE</font> cur1 <font color="#0000ff">CURSOR</font> <font color="#0000ff">FOR</font> <font color="#0000ff">select</font> id,pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> pid=search_id; <font color="#0000ff">DECLARE</font> <font color="#0000ff">CONTINUE</font> HANDLER <font color="#0000ff">FOR</font> <font color="#0000ff">NOT</font> <font color="#0000ff">FOUND</font> <font color="#0000ff">SET</font> done = 1; <font color="#0000ff">IF</font> sublevel&lt;=1 <font color="#0000ff">THEN</font> /**    */ <font color="#0000ff">IF</font> zlevel&lt;=0 <font color="#0000ff">THEN</font> /**   */ <font color="#0000ff">SET</font> max_sp_recursion_depth= 15; <font color="#0000ff">ELSE</font> <font color="#0000ff">SET</font> max_sp_recursion_depth= zlevel+1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; <font color="#0000ff">OPEN</font> cur1; <font color="#0000ff">IF</font> main_id = search_id <font color="#0000ff">THEN</font> /**   ,     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = main_id, pid =( <font color="#0000ff">select</font> pid <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">where</font> id=main_id <font color="#0000ff">limit</font> 1), rid =main_id, <font color="#0000ff">level</font> = sublevel-1; <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; /**     */ REPEAT <font color="#0000ff">FETCH</font> cur1 <font color="#0000ff">INTO</font> catalog_id,catalog_pid; <font color="#0000ff">IF</font> <font color="#0000ff">NOT</font> done <font color="#0000ff">THEN</font> /**     */ <font color="#0000ff">insert</font> <font color="#0000ff">into</font> tmp__index <font color="#0000ff">set</font> id = catalog_id, pid = catalog_pid, rid = main_id, <font color="#0000ff">level</font> = sublevel; /**    */ <font color="#0000ff">call</font> getIndexToTmpTable(main_id,catalog_id,zlevel,sublevel+1); <font color="#0000ff">END</font> <font color="#0000ff">IF</font> ; UNTIL done <font color="#0000ff">END</font> REPEAT; <font color="#0000ff">CLOSE</font> cur1; <font color="#0000ff">END</font> $$ DELIMITER ;</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br> <br>  The start of the procedure is preceded by the creation of a temporary table, and then a simple select is ripped out the necessary data. <br><br> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TEMPORARY</font> <font color="#0000ff">TABLE</font> tmp__index(id <font color="#0000ff">int</font> ,pid <font color="#0000ff">int</font> ,rid <font color="#0000ff">int</font> ); <font color="#0000ff">call</font> getIndexToTmpTable(&lt;id_&gt;,&lt;id_&gt;,1,1); <font color="#0000ff">select</font> c.* <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">as</font> c <font color="#0000ff">join</font> tmp__index <font color="#0000ff">as</font> t <font color="#0000ff">on</font> t.rid=c.id</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TEMPORARY</font> <font color="#0000ff">TABLE</font> tmp__index(id <font color="#0000ff">int</font> ,pid <font color="#0000ff">int</font> ,rid <font color="#0000ff">int</font> ); <font color="#0000ff">call</font> getIndexToTmpTable(&lt;id_&gt;,&lt;id_&gt;,1,1); <font color="#0000ff">select</font> c.* <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">as</font> c <font color="#0000ff">join</font> tmp__index <font color="#0000ff">as</font> t <font color="#0000ff">on</font> t.rid=c.id <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TEMPORARY</font> <font color="#0000ff">TABLE</font> tmp__index(id <font color="#0000ff">int</font> ,pid <font color="#0000ff">int</font> ,rid <font color="#0000ff">int</font> ); <font color="#0000ff">call</font> getIndexToTmpTable(&lt;id_&gt;,&lt;id_&gt;,1,1); <font color="#0000ff">select</font> c.* <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">as</font> c <font color="#0000ff">join</font> tmp__index <font color="#0000ff">as</font> t <font color="#0000ff">on</font> t.rid=c.id <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">CREATE</font> <font color="#0000ff">TEMPORARY</font> <font color="#0000ff">TABLE</font> tmp__index(id <font color="#0000ff">int</font> ,pid <font color="#0000ff">int</font> ,rid <font color="#0000ff">int</font> ); <font color="#0000ff">call</font> getIndexToTmpTable(&lt;id_&gt;,&lt;id_&gt;,1,1); <font color="#0000ff">select</font> c.* <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">as</font> c <font color="#0000ff">join</font> tmp__index <font color="#0000ff">as</font> t <font color="#0000ff">on</font> t.rid=c.id <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">CREATE</font> <font color="#0000ff">TEMPORARY</font> <font color="#0000ff">TABLE</font> tmp__index(id <font color="#0000ff">int</font> ,pid <font color="#0000ff">int</font> ,rid <font color="#0000ff">int</font> ); <font color="#0000ff">call</font> getIndexToTmpTable(&lt;id_&gt;,&lt;id_&gt;,1,1); <font color="#0000ff">select</font> c.* <font color="#0000ff">from</font> <font color="#0000ff">catalog</font> <font color="#0000ff">as</font> c <font color="#0000ff">join</font> tmp__index <font color="#0000ff">as</font> t <font color="#0000ff">on</font> t.rid=c.id</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br> <br>  Let's stop for a minute and think about what we have done and how good it is: <br><ol><li>  we do all 3rd queries to the database </li><li>  got rid of the problems associated with the support of the additional field, since everything is dynamically generated </li><li>  this procedure cannot loop, mysql limits the recursion depth </li><li>  we can control ourselves how deeply we need to go around the tree (that is, to what level) </li><li>  we know everything about each element, down to what level it is </li><li>  secondary execution of the procedure on the same data can be eliminated using the local cache of the query result. </li></ol><br>  Honestly, I was very surprised that such a functionality is so easily implemented by the database.  However, we go further, the task is not completely solved.  Now the question arises - what to do with this array.  There are only two options: <br><ol><li>  rewrite all templates in a new way. </li><li>  make a tree structure from linear. </li></ol><br>  I believe that if there is a possibility, then it is better to refactor templates so that they understand the linear data structure.  This is the most good way.  But unfortunately in my case, it is easier and faster to make a wood-like structure, and not to cringe the entire project ... <br><br>  So I did this: formed a caracas tree based on the links, sequentially placing a reference to the child element in the parent element.  After forming the skeleton of a tree, I walked through it recurrently and created a tree with real data. <br><br><img src="http://img148.imageshack.us/img148/4025/treelink.png"><br>  The figure shows the kind of frame I get.  I schematically indicated the name of the field there, but in reality there are only identifiers stored in the form $ id =&gt; array (...), where $ id is the element identifier, and the array contains a set of links to the root elements of the array.  It is important to understand that records with the same name refer to the same memory location.  The total amount of data stored in the memory is the number of elements + overhead costs of storing an array of links. <br><br>  Here is the conversion code, it's in the inside of the class.  Please do not judge strictly, it was written quickly, from under the lash: <br><br> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; /** <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> *        <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> *     ,        <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> * $_idToData, $_data <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> * <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> * @param array&amp; $curItemFrom <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> * @param array&amp; $curItemTo <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> */ <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); //        <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> //  id-&gt; num   data    <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { //   $pid=&gt;array($id, ...),       $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); //  ,        ... <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { //            <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">protected</font> $_idToData = <font color="#0000ff">null</font> ; <font color="#0000ff">protected</font> $_dataArray = <font color="#0000ff">null</font> ; <font color="#008000">/**</font> <font color="#008000">*       </font> <font color="#008000">*     ,       </font> <font color="#008000">* $_idToData, $_data</font> <font color="#008000">*</font> <font color="#008000">* @param array&amp; $curItemFrom</font> <font color="#008000">* @param array&amp; $curItemTo</font> <font color="#008000">*/</font> <font color="#0000ff">protected</font> <font color="#0000ff">function</font> _recGenTreeResult(array&amp;$curItemFrom,array&amp;$curItemTo) { <font color="#0000ff">foreach</font> ($curItemFrom <font color="#0000ff">as</font> $id=&gt;&amp;$list) { <font color="#0000ff">if</font> (!isset($ <font color="#0000ff">this</font> -&gt;_idToData[$id]) || !isset($ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ])) <font color="#0000ff">throw</font> <font color="#0000ff">new</font> Exception( <font color="#A31515">'recursion build error!'</font> ); $curItemTo[] = $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$id] ]; $i = count($curItemTo)-1; <font color="#0000ff">if</font> (count($list)) { $curItemTo[$i][ <font color="#A31515">'dir'</font> ] = array(); $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$list,&amp;$curItemTo[$i][ <font color="#A31515">'dir'</font> ]); } } } <font color="#0000ff">function</font> listToTree($dataArray) { $ <font color="#0000ff">this</font> -&gt;_dataArray = &amp;$dataArray; $ <font color="#0000ff">this</font> -&gt;_idToData = array(); $parentList = array(); $rootIds = array(); <font color="#008000">//       </font> <font color="#008000">//  id-&gt; num   data   </font> <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'id'</font> ]] = $k; <font color="#0000ff">foreach</font> ($ <font color="#0000ff">this</font> -&gt;_dataArray <font color="#0000ff">as</font> $k=&gt;$d) { <font color="#008000">//   $pid=&gt;array($id, ...),      </font> $parentList[$d[ <font color="#A31515">'pid'</font> ]][$d[ <font color="#A31515">'id'</font> ]]= array(); <font color="#008000">//  ,        ...</font> <font color="#0000ff">if</font> (isset($ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]])) { <font color="#008000">//           </font> <font color="#0000ff">if</font> (isset($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]])) <font color="#0000ff">if</font> (empty($parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ])) $parentList[ $ <font color="#0000ff">this</font> -&gt;_dataArray[ $ <font color="#0000ff">this</font> -&gt;_idToData[$d[ <font color="#A31515">'pid'</font> ]] ][ <font color="#A31515">'pid'</font> ]][ $d[ <font color="#A31515">'pid'</font> ] ] = &amp;$parentList[$d[ <font color="#A31515">'pid'</font> ]]; } <font color="#0000ff">else</font> $rootIds [$d[ <font color="#A31515">'pid'</font> ] ] = <font color="#0000ff">true</font> ; } $result = array(); <font color="#0000ff">foreach</font> (array_keys($rootIds) <font color="#0000ff">as</font> $pid) $ <font color="#0000ff">this</font> -&gt;_recGenTreeResult(&amp;$parentList[$pid],&amp;$result); <font color="#0000ff">return</font> $result; }</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <br> <br>  In the end, we got quite a workable thing.  In the case of a large base and the depth of recursion, this solution can also be bad.  specifically can be bad to mySql server.  I would solve this problem by introducing a caching table (permanent), which would store the results of the descent from the beginning of a certain element, and copy them into a temporary table.  That is, the classic recursion cache would work, only in SQL.  This is close to dynamic programming techniques.  Maybe I‚Äôll ever realize it if the local cache is not enough for stable operation.  Although I think that's enough ... <br><br><hr><br>  links to what to read: <br><ul><li>  <a title="tree slides" href="http://www.slideshare.net/quipo/trees-in-the-database-advanced-data-structures%3Ftype%3Dpresentation">Php conf2 conference 2008 - slides on tree structures</a> </li><li>  <a title="stored procedures, official documentation" href="http://dev.mysql.com/doc/refman/5.1/en/create-procedure.html">stored procedures, official documentation: http://dev.mysql.com/doc/refman/5.1/en/create-procedure.html</a> </li><li>  <a title="cursors, official documentation" href="http://dev.mysql.com/doc/refman/5.1/en/cursors.html">cursors, official documentation: http://dev.mysql.com/doc/refman/5.1/en/cursors.html</a> </li><li>  <a title="article about cursors" href="http://habrahabr.ru/blogs/mysql/46333/">article about cursors: http://habrahabr.ru/blogs/mysql/46333/</a> </li><li>  <a title="links in php" href="http://php.su/learnphp/%3Fre">links in php: http://php.su/learnphp/?re</a> </li><li>  <a href="http://habrahabr.ru/blogs/sql/43955/">Hierarchical (recursive) queries</a> </li><li>  <a href="http://habrahabr.ru/blogs/mysql/67722/">Full hierarchical hierarchical structures in databases</a> </li></ul><br><br>  <b>UPD The</b> article is written by Nikolai Punin (nicolay.punin@gmail.com), who, unfortunately, does not yet have an invite. </div><p>Source: <a href="https://habr.com/ru/post/72700/">https://habr.com/ru/post/72700/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../72689/index.html">Product licenses iolo + coupon codes</a></li>
<li><a href="../72690/index.html">Eight-bit gloves</a></li>
<li><a href="../72691/index.html">How I changed the keyboard</a></li>
<li><a href="../72692/index.html">Yaml debug</a></li>
<li><a href="../72694/index.html">Halloween Apple Pie</a></li>
<li><a href="../72701/index.html">Looking to the future: a possible way to combat Internet piracy through social security of citizens the right to free download of works</a></li>
<li><a href="../72702/index.html">Search person by email</a></li>
<li><a href="../72703/index.html">AOL Again changed the protocol</a></li>
<li><a href="../72704/index.html">We diagnose a lie ...</a></li>
<li><a href="../72705/index.html">Ample SDK - Javascript GUI library. Overview</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>