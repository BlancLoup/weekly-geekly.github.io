<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make a Laser Squad from XCOM: etude for GDB in OSX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is how the Laser Squad game now looks like, which I saw a long time ago. Then it was simpler in every sense and looked like this: 



 At the sam...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make a Laser Squad from XCOM: etude for GDB in OSX</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/233/50d/817/23350d817fa54273ac4513758a1d73ef.jpg" alt="image"><br><br>  This is how the Laser Squad game now looks like, which I saw a long time ago.  Then it was simpler in every sense and looked like this: <br><br><img src="https://habrastorage.org/files/805/8f3/03a/8058f303aae14a938528d4a48ca91f49.png" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At the same time, fundamentally the game has not changed.  It just got harder: a bunch of types of resources, a lot of options for their use, plus ‚Äúinflation‚Äù: each next workshop, laboratory or satellite channel costs more than the previous ones.  On the one hand, all this makes it possible to play with different development strategies, but sometimes you just want to play just Laser Squad!  Therefore‚Ä¶ <br><a name="habracut"></a><br>  So I went to the App Store and bought XCOM for some $ 29.  The hack method of resources in games has not changed since the advent of the First Save: save, change the amount of the target resource, save again, run the hex editor, find the place where the first control value has changed to the second control value, write there a significant integer (which something like 0x7FFF) - and enjoy the dramatically simplified gameplay. <br><br>  But here I was waiting for a bummer.  Even two: first, successively saved files differed in size.  Secondly, in the part of the file that referred to the conditional header, the corresponding values ‚Äã‚Äãwere, but changing them resulted in XCOM complaining about the broken files: obviously, the format provides for some checksums that do not match after such a rough making changes. <br><br>  Well then.  So, it‚Äôs time to take the debugger in your hands: it‚Äôs impossible to edit the files, then we‚Äôll edit the memory immediately.  Here the method is slightly different: <br><br><ol><li>  launched the game; </li><li>  clung to the debugger; </li><li>  looked at the amount of the target resource; </li><li>  found a set of addresses in the process memory with this value and saved it; </li><li>  changed the amount of the target resource; </li><li>  found a new set of addresses in memory and crossed (set intersection) with the previous one; </li><li>  repeated paragraphs.  5 and 6 is not yet a single address; </li><li>  recorded at this address the desired amount of the target resource. </li></ol><br>  But there are difficulties.  The first is that, in the general case, the virtual memory of the process in all modern operating systems is not continuous, and it is too long to go through the whole space of possible addresses.  Fortunately, OS X has a wonderful vmmap junk that, at the output, gives a detailed process memory card in the form: <br><blockquote>  % vmmap 15552 <br>  ... <br>  shared memory 3afff000-3b000000 [4K] rw- / rw- SM = SHM <br>  MALLOC_SMALL 3b000000-3b800000 [8192K] rw- / rwx SM = PRV DefaultMallocZone_0x4816000 <br>  MALLOC_LARGE 3b800000-3b84c000 [304K] rw- / rwx SM = PRV DefaultMallocZone_0x4816000 <br>  shared memory 3b84c000-3b854000 [32K] rw- / rw- SM = SHM <br>  IOKit 3b85d000-3b866000 [36K] rw- / rw- SM = ALI <br>  MALLOC_LARGE 3b866000-3b891000 [172K] rw- / rwx SM = PRV DefaultMallocZone_0x4816000 <br>  shared memory 3b891000-3b899000 [32K] rw- / rw- SM = SHM <br>  MALLOC_LARGE 3b8a2000-3b8ee000 [304K] rw- / rwx SM = PRV DefaultMallocZone_0x4816000 <br>  ... <br></blockquote><br><br>  The second difficulty is that there can be a lot of such memory segments as in the example above.  For example, in my case there were more than two and a half thousand of them, so manually scanning them all will not work. <br><br>  From the point of view of the task and the current difficulties, GDB is perfect: it is scripted  This means that it can be run in batch mode and fed to it lists of commands either from a file or from the command line. <br><br>  In general, two things are done with GDB: finding the address (s), and writing down the desired value at a given address.  Finding addresses of a desired value is done in GDB by the find command (surprise!).  For one of the above ranges and the value 100 the command will look like this: <b>find / w 0x3b800000, 0x3b84c000 100</b> .  If the address we need is 0x3b800004, then the command to write the value 200 to this address will be: <b>set {int} 0x3b800000 = 200</b> . <br><br>  In theory, everything is transparent.  But already on trying to join the process, I had another bummer: GDB received head-on segfault and fell into the crust.  I checked the rights: the id of the effective user for the debugger and the game are the same - mine.  I tried to join the top, launched in the next shell - it turned out only from the root.  Joining the XCOM process, even from the root - does not work, segfault ... <br><br>  Further investigation clarified two things: <br><br><ul><li>  GDB, which comes bundled with Xcode, is very old </li><li>  The security system of processes in OS X is a cut higher than in Microsoft Windows Vista and Windows 7 not because ‚Äúit is there inside UNIX‚Äù, but ‚ÄúWinda Mastday‚Äù. </li></ul><br><br>  Lyrical digression: various malicious programs try to either not have their own separate process, or disguise themselves as a system, or hide their process.  The first two approaches boil down to the possibility of ‚Äújumping up‚Äù into the process of an honest program and further creating dark things on its good name.  The third usually requires "jumping" into the kernel of the operating system.  So, in OS X, I even succeeded in joining a neighboring process running with my rights, after I read the article in which this process is described in detail.  In short, when calling certain APIs, the kernel first makes sure that the code that made this call is signed with the proper certificate.  Therefore, in order for our approach to work, it is necessary: <br><br><ol><li>  create a local self-signed certificate to sign the code with the highest level of trust; </li><li>  put a new GDB; </li><li>  sign the gdb executable file with the newly created certificate. </li></ol><br><br>  In case I wanted to get away from using gdb and write to the XCOM address space from my process, I would need an additional Info.plist, which I need to compile into the executable file.  For a detailed description of the approach I send to the <a href="http://os-tres.net/blog/2010/02/17/mac-os-x-and-task-for-pid-mach-call/">article</a> , from which I learned all this mechanics.  Another good article, in which the mechanics of code signing and right-cutting the process is well written, <a href="http://habrahabr.ru/post/223675/">lies right on Habr√©</a> . <br><br>  After all these dance steps, GDB was finally able to join the game process and I was able to test the search manually.  Since there was a lot of data (lists of even several dozens of addresses can be tiring if compared with their eyes), a binding was written over vmmap and GDB, which automated the process of searching and editing values ‚Äã‚Äãin memory. <br><br>  I'm still not sure from what more satisfaction was obtained: from playing the good old Laser Squad or from the process of turning XCOM into it. </div><p>Source: <a href="https://habr.com/ru/post/255787/">https://habr.com/ru/post/255787/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../255773/index.html">Java-based configuration of embedded Jetty / Spring MVC / Spring Security</a></li>
<li><a href="../255775/index.html">Algorithms of intellectual autogeneration of levels in iOS game</a></li>
<li><a href="../255779/index.html">Microsoft and Adobe released a set of updates for their products, April 2015</a></li>
<li><a href="../255781/index.html">A new issue of the journal "In the clouds. RF"</a></li>
<li><a href="../255785/index.html">Lumen - a new PHP microframe from the developer Laravel</a></li>
<li><a href="../255789/index.html">Analysis of external links in MegaIndex and updating the procurement algorithm</a></li>
<li><a href="../255791/index.html">Never Ending Story: a story in the MMORPG</a></li>
<li><a href="../255793/index.html">The results of a single rating web studios 2015</a></li>
<li><a href="../255799/index.html">RSA encryption in PHP (openssl), Android / Java, JavaScript and Go</a></li>
<li><a href="../255801/index.html">Overview of malicious browser extensions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>