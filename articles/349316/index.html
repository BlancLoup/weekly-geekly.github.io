<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Integration of Asterisk and Bitrix24</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The network has different integration options for IP-PBX Asterisk and Bitrix24 CRM, but we, all the same, decided to write our own. 

 In terms of fun...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Integration of Asterisk and Bitrix24</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/d2/bl/rd/d2blrdldi6khjwtmv0hylxi7vvq.png"></div><br>  The network has different integration options for IP-PBX Asterisk and Bitrix24 CRM, but we, all the same, decided to write our own. <br><br>  In terms of functionality, everything is standard: <br><br><ul><li>  By clicking on the link with the client‚Äôs phone number in Bitrix24, Asterisk connects the internal number of the user, on whose behalf this click is made, to the client‚Äôs phone number.  The record of the call is recorded in Bitrix24 and the recording of the conversation is pulled up at the end of the call. </li><li>  Asterisk receives a call from the outside - in the Bitrix24 interface, we show the client's card to the employee to whose number this call arrived. <br>  If there is no such client, open the new lead creation card. <br>  As soon as the call is completed, we reflect it on the card and pull up the recording of the conversation. </li></ul><br>  Under the cut, I'll tell you how to set everything up at home and give a link to github - yes, take it and use it! <br><a name="habracut"></a><br><h2>  general description </h2><br>  We called our integration CallMe.  CallMe is a small web application written in PHP. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Used technologies and services </h4><br><ul><li>  PHP 5.6 </li><li>  <a href="https://github.com/marcelog/PAMI">PHP AMI Library</a> </li><li>  Composer </li><li>  Nginx + php-fpm </li><li>  supervisor </li><li>  AMI (Asterisk menegement interface) </li><li>  Bitrix webcaps (simplified implementation of the REST API) </li></ul><br><h4>  Presetting </h4><br>  On the server with Asterisk, you need to install a web server (we have nginx + php-fpm), supervisor and git. <br><br>  Command to install (CentOS): <br><br><pre><code class="bash hljs">yum install nginx php-fpm supervisor git</code> </pre> <br>  Go to the directory accessible by the web server, pull the application from the gita and set the necessary rights for the folder: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /var/www git <span class="hljs-built_in"><span class="hljs-built_in">clone</span></span> https://github.com/ViStepRU/callme.git chown nginx. -R callme/</code> </pre><br>  Next, configure nginx, our config is located in <br><br><pre> <code class="bash hljs">/etc/nginx/conf.d/pbx.vistep.ru.conf</code> </pre> <br><pre> <code class="nginx hljs"><span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.pbx.vistep.ru pbx.vistep.ru; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> *:<span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^</span></span> https://pbx.vistep.ru<span class="hljs-variable"><span class="hljs-variable">$request_uri</span></span>? <span class="hljs-literal"><span class="hljs-literal">permanent</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-comment"><span class="hljs-comment"># listen *:80; # server_name pbx.vistep.ru; access_log /var/log/nginx/pbx.vistep.ru.access.log main; error_log /var/log/nginx/pbx.vistep.ru.error.log; listen 443 ssl http2; server_name pbx.vistep.ru; resolver 8.8.8.8; ssl_stapling on; ssl on; ssl_certificate /etc/letsencrypt/live/pbx.vistep.ru/fullchain.pem; ssl_certificate_key /etc/letsencrypt/live/pbx.vistep.ru/privkey.pem; ssl_dhparam /etc/nginx/certs/dhparam.pem; ssl_session_timeout 24h; ssl_session_cache shared:SSL:2m; ssl_protocols TLSv1 TLSv1.1 TLSv1.2; ssl_ciphers kEECDH+AES128:kEECDH:kEDH:-3DES:kRSA+AES128:kEDH+3DES:DES-CBC3-SHA:!RC4:!aNULL:!eNULL:!MD5:!EXPORT:!LOW:!SEED:!CAMELLIA:!IDEA:!PSK:!SRP:!SSLv2; ssl_prefer_server_ciphers on; add_header Strict-Transport-Security "max-age=31536000;"; add_header Content-Security-Policy-Report-Only "default-src https:; script-src https: 'unsafe-eval' 'unsafe-inline'; style-src https: 'unsafe-inline'; img-src https: data:; font-src https: data:; report-uri /csp-report"; root /var/www/callme; index index.php; location ~ /\. { deny all; #     } location ~* /(?:uploads|files)/.*\.php$ { deny all; #     } location ~* ^.+\.(ogg|ogv|svg|svgz|eot|otf|woff|mp4|ttf|rss|atom|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ { access_log off; log_not_found off; expires max; #   } location ~ \.php { root /var/www/callme; index index.php; fastcgi_pass unix:/run/php/php5.6-fpm.sock; # fastcgi_pass 127.0.0.1:9000; fastcgi_index index.php; fastcgi_param SCRIPT_FILENAME $document_root/$fastcgi_script_name; include /etc/nginx/fastcgi_params; } }</span></span></code> </pre><br>  I will leave the analysis of the config, security issues, obtaining a certificate, and even the choice of a web server outside of the article - there is a lot written about this.  The application has no restrictions, it works on http and https. <br><br>  We have https, let's let's encrypt certificate. <br><br>  If you did everything right, then clicking on the link should see something like <br><br><img src="https://habrastorage.org/webt/_0/ag/ij/_0agijgm_tagwpymgdnehhbpbrg.png"><br><br><h2>  Setting Bitrix24 </h2><br>  Create two webhook. <br><br>  <b>Incoming webhuk.</b> <br><br>  Under the administrator account (with id 1) go along the path: Applications -&gt; WebHooks -&gt; Add WebHook -&gt; Inbound WebHook <br><br><img src="https://habrastorage.org/webt/wr/ge/e-/wrgee-n17vzvnqfixsipxgiwg1w.png"><br><br>  Fill in the parameters of the incoming webhuk as on screenshots: <br><br><img src="https://habrastorage.org/webt/mg/kw/hh/mgkwhhqed4oxivgf-ngxwjxnrqi.png"><br><br><img src="https://habrastorage.org/webt/51/q4/z6/51q4z6zbhgg5tn03fpqmvvumc14.png"><br><br>  And click save. <br><br>  After saving, Bitrix24 will provide the URL of the incoming webhuk, for example: <br><br><img src="https://habrastorage.org/webt/su/ul/vh/suulvhnquhept_hkecbni3zmqzk.png"><br><br>  Save your version of the URL without the final / profile / - it will be used in the application to work with incoming calls. <br><br>  I have this <code>https://b24-xsynia.bitrix24.ru/rest/1/7eh61lh8pahw0fwt</code> <br><br>  <b>Outgoing webhuk.</b> <br><br>  Applications -&gt; WebHooks -&gt; Add WebHook -&gt; Outgoing WebHook <br><br>  Details again on screenshots: <br><br><img src="https://habrastorage.org/webt/50/uc/jb/50ucjbiwvtyqcylie_piamvp1py.png"><br><br><img src="https://habrastorage.org/webt/ph/63/rv/ph63rv-br9gxrjmk80qk0lpe4rw.png"><br><br>  Save and get the authorization code <br><br><img src="https://habrastorage.org/webt/to/ui/wa/touiwa_xq2j4svjcdmndny9fkfw.png"><br><br>  I have this <code>xcrp2ylhzzd2v43cmfjqmkvrgrcbkni6</code> .  He also needs to be copied to himself, he is needed to make outgoing calls. <br><br>  <b>Important!</b> <br><blockquote>  On the Bitrix24 server, an ssl certificate must be configured (you can use letsencrypt), otherwise the bitrix api will not work.  If you have a cloud version, don't worry - there is already ssl. </blockquote><br>  And with the final touch, we will install our CallMeOut as an application for making calls (so that by clicking on the number on the PBX the command would fly away to originate the call). <br><br>  In the menu, select: More -&gt; Telephony -&gt; More -&gt; Settings, put in ‚ÄúDefault number for outgoing call‚Äù Appendix: CallMeOut and click ‚ÄúSave‚Äù <br><br><img src="https://habrastorage.org/webt/wl/ki/r8/wlkir8agmixr4lvmnezvdrqtaoo.png"><br><br><h2>  Asterisk setup </h2><br>  For successful interaction between Asterisk and Bitrix24, we need to add the AMI callme user in manager.conf: <br><br><pre> <code class="hljs pgsql">[callme] secret = JD3clEB8_f23r<span class="hljs-number"><span class="hljs-number">-3</span></span>ry84gJ deny = <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> permit = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> permit= <span class="hljs-number"><span class="hljs-number">10.100</span></span><span class="hljs-number"><span class="hljs-number">.111</span></span><span class="hljs-number"><span class="hljs-number">.249</span></span>/<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span> permit = <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.254</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">255.255</span></span><span class="hljs-number"><span class="hljs-number">.255</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>,agent,<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>,config,dtmf,reporting,cdr,dialplan <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">call</span></span>,agent,<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">verbose</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>,config,command,reporting,originate</code> </pre><br>  Then there are several tricks that need to be implemented through dialplan (we have extensions.ael). <br><br>  I give the whole file, and after I give explanations: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">globals</span></span> { WAV=/var/www/pbx.vistep.ru/callme/records/wav; //   WAV MP3=/var/www/pbx.vistep.ru/callme/records/mp3; //  mp3  URLRECORDS=https://pbx.vistep.ru/callme/records/mp3; RECORDING=1; // , 1 - . }; macro recording(calling,called) { if (<span class="hljs-string"><span class="hljs-string">"${RECORDING}"</span></span> = <span class="hljs-string"><span class="hljs-string">"1"</span></span>){ Set(fname=<span class="hljs-variable"><span class="hljs-variable">${UNIQUEID}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${EPOCH}</span></span></span><span class="hljs-variable">,,%Y-%m-%d-%H_%M)}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${calling}</span></span>-<span class="hljs-variable"><span class="hljs-variable">${called}</span></span>); Set(datedir=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${EPOCH}</span></span></span><span class="hljs-variable">,,%Y/%m/%d)}</span></span>); System(mkdir -p <span class="hljs-variable"><span class="hljs-variable">${MP3}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>); System(mkdir -p <span class="hljs-variable"><span class="hljs-variable">${WAV}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>); Set(monopt=nice -n 19 /usr/bin/lame -b 32 --silent <span class="hljs-string"><span class="hljs-string">"${WAV}/${datedir}/${fname}.wav"</span></span> <span class="hljs-string"><span class="hljs-string">"${MP3}/${datedir}/${fname}.mp3"</span></span> &amp;&amp; rm -f <span class="hljs-string"><span class="hljs-string">"${WAV}/${fname}.wav"</span></span> &amp;&amp; chmod o+r <span class="hljs-string"><span class="hljs-string">"${MP3}/${datedir}/${fname}.mp3"</span></span>); Set(FullFname=<span class="hljs-variable"><span class="hljs-variable">${URLRECORDS}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.mp3); Set(CDR(filename)=<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.mp3); Set(CDR(recordingfile)=<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.wav); Set(CDR(realdst)=<span class="hljs-variable"><span class="hljs-variable">${called}</span></span>); MixMonitor(<span class="hljs-variable"><span class="hljs-variable">${WAV}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.wav,b,<span class="hljs-variable"><span class="hljs-variable">${monopt}</span></span>); }; }; context incoming { 888999 =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Answer(); ExecIF(<span class="hljs-variable"><span class="hljs-variable">${CallMeCallerIDName}</span></span>?Set(CALLERID(name)=<span class="hljs-variable"><span class="hljs-variable">${CallMeCallerIDName}</span></span>):NoOp()); //  CallerID     24 Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Queue(Q1,tT); Set(CallMeDISPOSITION=<span class="hljs-variable"><span class="hljs-variable">${CDR(disposition)}</span></span>); Hangup(); } h =&gt; { Set(CDR_PROP(disable)=true); Set(CallStop=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Set(CallMeDURATION=<span class="hljs-variable"><span class="hljs-variable">${MATH(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStop}</span></span></span><span class="hljs-variable">-</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStart}</span></span></span><span class="hljs-variable">,int)}</span></span>); ExecIF(<span class="hljs-variable"><span class="hljs-variable">${ISNULL(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span></span><span class="hljs-variable">)}</span></span>?Set(CallMeDISPOSITION=<span class="hljs-variable"><span class="hljs-variable">${CDR(disposition)}</span></span>):NoOP(=== CallMeDISPOSITION already was set ===)); System(curl -s https://pbx.vistep.ru/CallMeOut.php --data action=sendcall2b24 --data call_id=<span class="hljs-variable"><span class="hljs-variable">${CallMeCALL_ID}</span></span> --data-urlencode FullFname=<span class="hljs-variable"><span class="hljs-variable">${FullFname}</span></span> --data CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CallIntNum}</span></span> --data CallDuration=<span class="hljs-variable"><span class="hljs-variable">${CallMeDURATION}</span></span> --data-urlencode CallDisposition=<span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span>); } } context default { _X. =&gt; { Hangup(); } }; context dial_out { _[1237]XX =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Set(__CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>) Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Dial(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>,,tTr); Hangup(); } _11XXX =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Set(__CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>); Dial(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN:2}</span></span>@toOurAster,,t); Hangup(); } _. =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Set(__CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>) Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Dial(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>@toOurAster,,t); Hangup(); } h =&gt; { Set(CDR_PROP(disable)=true); Set(CallStop=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Set(CallMeDURATION=<span class="hljs-variable"><span class="hljs-variable">${MATH(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStop}</span></span></span><span class="hljs-variable">-</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStart}</span></span></span><span class="hljs-variable">,int)}</span></span>); if(<span class="hljs-variable"><span class="hljs-variable">${ISNULL(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span></span><span class="hljs-variable">)}</span></span>) { Set(CallMeDISPOSITION=<span class="hljs-variable"><span class="hljs-variable">${CDR(disposition)}</span></span>); } System(curl -s http://pbx.vistep.ru/CallMeOut.php --data action=sendcall2b24 --data call_id=<span class="hljs-variable"><span class="hljs-variable">${CallMeCALL_ID}</span></span> --data-urlencode FullFname=<span class="hljs-variable"><span class="hljs-variable">${FullFname}</span></span> --data CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CallIntNum}</span></span> --data CallDuration=<span class="hljs-variable"><span class="hljs-variable">${CallMeDURATION}</span></span> --data-urlencode CallDisposition=<span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span>); } };</code> </pre><br>  Let's start from the beginning: the <b>globals</b> directive. <br><br>  The <b>URLRECORDS</b> variable stores the URL to the conversation recording files, according to which Bitrix24 will pull them into the contact card. <br><br>  Next we are interested in macro macro <b>recording</b> . <br><br>  Here, in addition to recording conversations, we set the variable <b>FullFname</b> . <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">Set</span></span>(FullFname=<span class="hljs-variable"><span class="hljs-variable">${URLRECORDS}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${datedir}</span></span>/<span class="hljs-variable"><span class="hljs-variable">${fname}</span></span>.mp3);</code> </pre> <br>  It stores the full URL to a specific file (the macro is called everywhere). <br><br>  We analyze the outgoing call: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">_</span></span>. =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Set(__CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>) Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Dial(SIP/<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>@toOurAster,,t); Hangup(); } h =&gt; { Set(CDR_PROP(disable)=true); Set(CallStop=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Set(CallMeDURATION=<span class="hljs-variable"><span class="hljs-variable">${MATH(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStop}</span></span></span><span class="hljs-variable">-</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStart}</span></span></span><span class="hljs-variable">,int)}</span></span>); if(<span class="hljs-variable"><span class="hljs-variable">${ISNULL(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span></span><span class="hljs-variable">)}</span></span>) { Set(CallMeDISPOSITION=<span class="hljs-variable"><span class="hljs-variable">${CDR(disposition)}</span></span>); } System(curl -s http://pbx.vistep.ru/CallMeOut.php --data action=sendcall2b24 --data call_id=<span class="hljs-variable"><span class="hljs-variable">${CallMeCALL_ID}</span></span> --data-urlencode FullFname=<span class="hljs-variable"><span class="hljs-variable">${FullFname}</span></span> --data CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CallIntNum}</span></span> --data CallDuration=<span class="hljs-variable"><span class="hljs-variable">${CallMeDURATION}</span></span> --data-urlencode CallDisposition=<span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span>); }</code> </pre><br>  Suppose we call 89991234567, the first thing we get here: <br><br><pre> <code class="apache hljs">&amp;<span class="hljs-attribute"><span class="hljs-attribute">recording</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>);</code> </pre> <br>  those.  the call recording macro is called and the necessary variables are set. <br><br>  Further <br><br><pre> <code class="apache hljs"> <span class="hljs-attribute"><span class="hljs-attribute">Set</span></span>(__CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CALLERID(num)}</span></span>) Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>);</code> </pre><br>  we write down who initiated the call and fix the start time of the call. <br><br>  And upon its completion, in a special context <b>h</b> <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">h</span></span> =&gt; { Set(CDR_PROP(disable)=true); Set(CallStop=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); Set(CallMeDURATION=<span class="hljs-variable"><span class="hljs-variable">${MATH(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStop}</span></span></span><span class="hljs-variable">-</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallStart}</span></span></span><span class="hljs-variable">,int)}</span></span>); if(<span class="hljs-variable"><span class="hljs-variable">${ISNULL(</span><span class="hljs-variable"><span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span></span><span class="hljs-variable">)}</span></span>) { Set(CallMeDISPOSITION=<span class="hljs-variable"><span class="hljs-variable">${CDR(disposition)}</span></span>); } System(curl -s http://pbx.vistep.ru/CallMeOut.php --data action=sendcall2b24 --data call_id=<span class="hljs-variable"><span class="hljs-variable">${CallMeCALL_ID}</span></span> --data-urlencode FullFname=<span class="hljs-variable"><span class="hljs-variable">${FullFname}</span></span> --data CallIntNum=<span class="hljs-variable"><span class="hljs-variable">${CallIntNum}</span></span> --data CallDuration=<span class="hljs-variable"><span class="hljs-variable">${CallMeDURATION}</span></span> --data-urlencode CallDisposition=<span class="hljs-variable"><span class="hljs-variable">${CallMeDISPOSITION}</span></span>); }</code> </pre><br>  We disable recording to the CDR table for this extension (it is not needed there), set the call completion time, calculate the duration, if the result of the call is not known - set ( <b>CallMeDISPOSITION</b> variable) and, at the last step, send the bitrix through the system curl. <br><br>  And a little more magic - incoming call: <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">888999</span></span> =&gt; { &amp;recording(<span class="hljs-variable"><span class="hljs-variable">${CALLERID(number)}</span></span>,<span class="hljs-variable"><span class="hljs-variable">${EXTEN}</span></span>); Answer(); ExecIF(<span class="hljs-variable"><span class="hljs-variable">${CallMeCallerIDName}</span></span>?Set(CALLERID(name)=<span class="hljs-variable"><span class="hljs-variable">${CallMeCallerIDName}</span></span>):NoOp()); //  CallerID     24 Set(CallStart=<span class="hljs-variable"><span class="hljs-variable">${STRFTIME(epoch,,%s)}</span></span>); //     Queue(Q1,tT); Set(CallMeDISPOSITION=<span class="hljs-variable"><span class="hljs-variable">${CDR(disposition)}</span></span>); Hangup(); }</code> </pre><br>  Here we are only interested in one line. <br><br><pre> <code class="apache hljs"><span class="hljs-attribute"><span class="hljs-attribute">ExecIF</span></span>(<span class="hljs-variable"><span class="hljs-variable">${CallMeCallerIDName}</span></span>?Set(CALLERID(name)=<span class="hljs-variable"><span class="hljs-variable">${CallMeCallerIDName}</span></span>):NoOp());</code> </pre> <br>  She tells the PBX to set the <b>CallerID (name)</b> to the variable <b>CallMeCallerIDName</b> . <br><br>  The CallMeCallerIDName variable itself, in turn, is set by the CallMe application (if Bitrix24 has a full name for the caller‚Äôs number, set it as <b>CallerID (name)</b> , if not, we will not do anything). <br><br><h2>  Application setup </h2><br>  The application settings file - /var/www/pbx.vistep.ru/config.php <br><br>  Description of application parameters: <br><br><ul><li>  <b>CallMeDEBUG</b> - if 1, then all events processed by the application will be written to the log file, 0 - do not write anything </li><li>  <b>tech</b> - SIP / PJSIP / IAX / etc </li><li>  <b>authToken</b> - <b>bitriks24</b> authorization token, authorization code for outgoing webhook </li><li>  <b>bitrixApiUrl</b> - URL of incoming webhuk, without profile / </li><li>  <b>extentions</b> - list of external numbers </li><li>  <b>context</b> - context for call origination </li><li>  <b>listener_timeout</b> - asterisk event handling speed </li><li>  <b>asterisk</b> - an array with settings for connecting to an asterisk: </li><li>  <b>host</b> - server ip or hostname asterisk </li><li>  <b>scheme</b> - connection scheme (tcp: //, tls: //) </li><li>  <b>port</b> </li><li>  <b>username</b> - username </li><li>  <b>secret</b> - password </li><li>  <b>connect_timeout</b> - connection timeout </li><li>  <b>read_timeout</b> - read timeout </li></ul><br>  sample configuration file: <br><br><pre> <code class="php hljs"> <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'CallMeDEBUG'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-comment"><span class="hljs-comment">//    : 1 - , 0 -   'tech' =&gt; 'SIP', 'authToken' =&gt; 'xcrp2ylhzzd2v43cmfjqmkvrgrcbkni6', //   'bitrixApiUrl' =&gt; 'https://b24-xsynia.bitrix24.ru/rest/1/7eh61lh8pahw0fwt', //url  api  ( ) 'extentions' =&gt; array('888999'), //   ,   'context' =&gt; 'dial_out', //     'asterisk' =&gt; array( //      'host' =&gt; '10.100.111.249', 'scheme' =&gt; 'tcp://', 'port' =&gt; 5038, 'username' =&gt; 'callme', 'secret' =&gt; 'JD3clEB8_f23r-3ry84gJ', 'connect_timeout' =&gt; 10000, 'read_timeout' =&gt; 10000 ), 'listener_timeout' =&gt; 300, //    asterisk );</span></span></code> </pre> <br><h2>  Supervisor setup </h2><br>  Supervisor is used to launch an event handler from Asterisk CallMeIn.php, which tracks incoming calls and interacts with Bitrix24 (show card, hide card, etc.). <br><br>  Settings file to create: <br><br> <code>/etc/supervisord.d/callme.conf</code> <br> <br><pre> <code class="hljs ruby">[<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>callme] command=<span class="hljs-regexp"><span class="hljs-regexp">/usr/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/php CallMeIn.php directory=/var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/www/pbx</span></span>.vistep.ru autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> startretries=<span class="hljs-number"><span class="hljs-number">5</span></span> stderr_logfile=<span class="hljs-regexp"><span class="hljs-regexp">/var/www</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pbx.vistep.ru/logs</span></span><span class="hljs-regexp"><span class="hljs-regexp">/daemon.log stdout_logfile=/var</span></span><span class="hljs-regexp"><span class="hljs-regexp">/www/pbx</span></span>.vistep.ru/logs/daemon.log</code> </pre> <br>  Starting and restarting the application: <br><br><pre> <code class="hljs pgsql">supervisorctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> callme supervisorctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> callme</code> </pre> <br>  view the status of the application: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">supervisorctl</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">status</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">callme</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">callme</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">RUNNING</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">pid</span></span> 11729, <span class="hljs-selector-tag"><span class="hljs-selector-tag">uptime</span></span> 17 <span class="hljs-selector-tag"><span class="hljs-selector-tag">days</span></span>, 16<span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:58</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:07</span></span></code> </pre> <br><h2>  Conclusion </h2><br>  It turned out quite difficult, but I am sure that an experienced administrator will be able to implement and please his users. <br><br>  As promised, a <a href="https://github.com/ViStepRU/callme">link to the githab</a> . <br><br>  Questions, wishes - please in the comments.  Also, if you are interested in how the development of this integration was going on, write, and in the next article I will try to reveal in more detail. </div><p>Source: <a href="https://habr.com/ru/post/349316/">https://habr.com/ru/post/349316/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349306/index.html">Creating a modal component using Vue.js</a></li>
<li><a href="../349308/index.html">Startup Cemeteries are full of visionaries without experience and knowledge.</a></li>
<li><a href="../349310/index.html">Why I don‚Äôt like ad blockers</a></li>
<li><a href="../349312/index.html">Where the money goes: Cisco IT infrastructure spending report</a></li>
<li><a href="../349314/index.html">Top 100 technical articles medium for 2017</a></li>
<li><a href="../349318/index.html">FastTrack Training. "Network Basics". "Understanding the OSI Model". Part two. Eddie Martin December 2012</a></li>
<li><a href="../349320/index.html">Friday: Safety and Paradox of the Survivor</a></li>
<li><a href="../349322/index.html">Quick launch of the Github repository with Angular CLI in your browser</a></li>
<li><a href="../349326/index.html">Tanchiki in the console, article four: "The new server - the new protocol"</a></li>
<li><a href="../349330/index.html">"Hi, Habr" at a frequency of 835 kHz</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>