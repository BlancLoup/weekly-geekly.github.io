<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Watching the vote on "Russia 10"</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Like many Russians, lately I go to vote every day on the site 10russia.ru . If someone does not know, Russia 10 is an all-Russian project, under which...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Watching the vote on "Russia 10"</h1><div class="post__text post__text-html js-mediator-article">  Like many Russians, lately I go to vote every day on the site <a href="http://10russia.ru/">10russia.ru</a> .  If someone does not know, Russia 10 is an all-Russian project, under which everyone can vote for their favorite geographical or architectural object in Russia.  The task of the project is the selection of ten new visual symbols of Russia. <br>  I thought the numbers in TOP2 in voting were strange, and I decided to see how they change. <a name="habracut"></a>  There was little time, and in haste a small parser wrote, which saves once every 2-3 seconds data on the number of votes on the site and SMS.  To display this data, I created a website (The design and the basis of the graphics from here were taken from <a href="http://habrahabr.ru/post/176547/">habrahabr.ru/post/176547</a> . I hope the author will not mind).  I didn‚Äôt want to spend money, and only a personal weak VDS was at disposal, which would have quickly gone down if the data were dynamically generated.  Therefore, it was decided to do with static html and json file generation by crown.  It will be interesting to see how much the VDS can handle without changing the current configuration (CPU 300MHz, RAM 128 Mb), considering that there are two small services and one small website running there.  At the end of the vote lay out, if anyone should, all the data obtained by voting. <br><br><h3>  Parser listing </h3><br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> set_time_limit(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleError</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($errno, $errstr, $errfile, $errline, array $errcontext)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span> === error_reporting()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ErrorException($errstr, <span class="hljs-number"><span class="hljs-number">0</span></span>, $errno, $errfile, $errline); } set_error_handler(<span class="hljs-string"><span class="hljs-string">'handleError'</span></span>); mysql_connect(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>); mysql_select_db(<span class="hljs-string"><span class="hljs-string">'10russia'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addNewData</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($html, $key)</span></span></span><span class="hljs-function"> </span></span>{ $site = $sms = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( preg_match(<span class="hljs-string"><span class="hljs-string">'/&lt;span id="count_votes_site"&gt;([^&lt;]+)/iu'</span></span>, $html, $match) ) { $site = (int)str_replace(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, $match[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( preg_match(<span class="hljs-string"><span class="hljs-string">'/&lt;span id="count_votes_sms"&gt;([^&lt;]+)/iu'</span></span>, $html, $match) ) { $sms = (int)str_replace(<span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>, $match[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($site &amp;&amp; $sms) { $all = $sms + $site; mysql_query(<span class="hljs-string"><span class="hljs-string">"INSERT INTO stat(`key`, sms, site, `all`) VALUES('$key', $sms, $site, $all)"</span></span>); } } $urls = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'object_31'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://10russia.ru/object_31'</span></span>, <span class="hljs-string"><span class="hljs-string">'object_61'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'http://10russia.ru/object_61'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($urls <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $url) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $result = file_get_contents($url); addNewData($result, $key); sleep(<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span> $e) {} } }</code> </pre> <br><br><h3>  Listing script to create json files </h3><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> mysql_connect(<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>, <span class="hljs-string"><span class="hljs-string">'login'</span></span>, <span class="hljs-string"><span class="hljs-string">'password'</span></span>); mysql_select_db(<span class="hljs-string"><span class="hljs-string">'10russia'</span></span>); $keys = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'object_31'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'object31.json'</span></span>, <span class="hljs-string"><span class="hljs-string">'object_61'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'object61.json'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($keys <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $key =&gt; $file) { $filename = dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $file . <span class="hljs-string"><span class="hljs-string">'.tmp'</span></span>; $fLink = fopen($filename, <span class="hljs-string"><span class="hljs-string">'w'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($fLink) { $result = mysql_query(<span class="hljs-string"><span class="hljs-string">"SELECT `date`, `all` FROM stat WHERE `key`='$key' ORDER BY id ASC"</span></span>); fwrite($fLink, <span class="hljs-string"><span class="hljs-string">"[\n"</span></span>); $row = mysql_fetch_assoc($result); $first = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { $str = <span class="hljs-string"><span class="hljs-string">''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!$first){ $str = <span class="hljs-string"><span class="hljs-string">","</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $first = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } fwrite($fLink, $str . <span class="hljs-string"><span class="hljs-string">'['</span></span>.strtotime($row[<span class="hljs-string"><span class="hljs-string">'date'</span></span>]) . <span class="hljs-string"><span class="hljs-string">"000,{$row['all']}]"</span></span> ); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>($row = mysql_fetch_assoc($result)); fwrite($fLink, <span class="hljs-string"><span class="hljs-string">"]"</span></span>); fclose($fLink); rename($filename, dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>) . <span class="hljs-string"><span class="hljs-string">'/'</span></span> . $file); } }</code> </pre><br>  An interesting point - I first generate a .tmp file, and then overwrite the file generated an hour ago, thereby avoiding the situation when the file does not exist or is not fully generated. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Interesting points on the charts </h2><br>  <b>Maximum increase in 30 minutes</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/197/efb/c25/197efbc250c8b43e28175ebb5bd2ab68.png" alt="Maximum increase in 30 minutes"><br><br>  <b>The overall dynamics of all time monitoring</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/b32/5c6/479/b325c647959d84e073e8f0bcb2e4ce86.png" alt="The overall dynamics of all time monitoring"><br><br><h2>  VGTRK </h2><br>  I hope that you have not created big problems for you, given the great popularity of the project, I think you were ready for a large flow of visitors.  By the way, if someone is looking for a job as a system administrator in Moscow, then the site creators are looking for employees who are no longer quite original, but in a rare way: <br><img src="https://habrastorage.org/getpro/habr/post_images/bd3/956/c75/bd3956c757aec63c3d217e4a1fdd343b.png" alt="Job"><br><br><h2>  Links </h2><br>  See what I did, read the detailed voting statistics and draw conclusions: <a href="http://10russia.miningdata.ru/">http://10russia.miningdata.ru/</a> </div><p>Source: <a href="https://habr.com/ru/post/192004/">https://habr.com/ru/post/192004/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191994/index.html">Basics of Irrlicht Engine for newbies</a></li>
<li><a href="../191996/index.html">We draw electronic money</a></li>
<li><a href="../191998/index.html">Zaovnil, stuck, gash: dictionary IT-Schnick</a></li>
<li><a href="../192000/index.html">Bootstrap, or application statistics with almost no formulas</a></li>
<li><a href="../192002/index.html">Development of a new professional standard in the field of information technology</a></li>
<li><a href="../192006/index.html">Bitcoin Foundation representatives met with US government agencies</a></li>
<li><a href="../192008/index.html">Yammer Tutorial: Registration Conversion</a></li>
<li><a href="../192010/index.html">RailsClub'Moscow 2013 (September 28). Conference news</a></li>
<li><a href="../192012/index.html">Several interesting and useful things for a web developer (release 2)</a></li>
<li><a href="../192014/index.html">Facebook attacks generate $ 200 million in profits for attackers every year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>