<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Memory Technologies in vSphere 5.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="At habrahabr, memory technologies used in various hypervisors have been repeatedly discussed. These technologies are often taken under the common name...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Memory Technologies in vSphere 5.0</h1><div class="post__text post__text-html js-mediator-article">  At habrahabr, memory technologies used in various hypervisors have been repeatedly discussed.  These technologies are often taken under the common name - Memory Overcommitment. <br>  Objectives that usually tend to achieve using memory overcommitment are two: <br><ul><li>  Increase utilization of physical memory of hosts with mainly active guest memory pages as much as possible; </li><li>  Increase the overall importance of consolidating virtual machines. </li></ul>  In this small topic, I want to offer you a quick recap of the technologies that have already been described in a much larger amount by other users, and will dwell a little bit more on the relatively new ones implemented in the vSphere 5.0 hypervisor. <br><a name="habracut"></a><br><h3>  Transparent page sharing (TPS) </h3><br>  When running multiple virtual machines, some of them may contain identical memory pages.  Page sharing allows you to keep such pages in the physical memory of the hypervisor in only one instance.  As a result, if the memory page is used, for example, by two virtual machines (they run similar code), they both work with only one memory page.  In other words, pages are deduplicated.  The method used is the calculation of the hash of each page used and their comparison in the hash table.  If a match occurs, the bit-matching process is additionally started.  This generic page is read only.  If one of the machines needs to change the content of the page, the creation of a private copy is initiated and the page is replaced.  Only after remaping recording is allowed.  Therefore, the insignificant decrease in performance, which is usually attributed to TPS (slightly less than 1%), lies precisely in the procedure for playing such a substitution for recording.  TPS is enabled and works by default with 4KB guest memory pages.  For pages the size of 2MB is turned off. <br><br><h3>  Ballooning </h3><br>  It turns on when the value of the free memory of the host decreases overcoming the 4% threshold.  Allows you to displace already allocated, but not used memory pages.  At best, these are the pages that the operating system usually marks in its ‚Äúfree‚Äù list (the operating system, roughly speaking, puts the pages of guest physical memory in two lists - ‚Äúallocate‚Äù and ‚Äúfree‚Äù).  From the pseudo-device vmmemctl, which is the driver in the VMware Tools bundle, the OS receives a request to allocate the required amount of memory, after receiving it, the pages of this volume are reported to the hypervisor as free. <br><br><h3>  Memory Compression </h3><br>  The technology is compression of memory pages.  It is activated along with the swapping of virtual machines (not to be confused with the OS swap) when the value of the free memory of the host overcomes the 2% threshold. <br>  The method is to create a special memory area for each virtual machine - compression cache, which is designed to contain compressed memory pages.  This area is initially empty and grows as it accumulates.  When a decision is made to swap a page of memory, first it is analyzed for the level of compression.  If the level is more than 50%, the page is compressed and placed in the compression cache. <br><img src="https://habrastorage.org/storage1/dab194b8/d3a28e98/9182237b/cd2cef0d.png"><br>  Thus, the page does not immediately fall into the swap (Figure a), but continues to be the physical memory of the host, but in a compressed form (Figure b).  Thus, at least twice as much memory is available at the cost of access to it. <br>  If this page is needed, it is decompressed from the cache and becomes available again in the guest memory.  This significantly reduces the page retrieval time, compared to swap. <br>  The volume of compression cache has a default size of 10% of the configured memory of the virtual machine.  When the cache is filled, pages that have not been accessed for a long time are retrieved through decompression and fall into the swap.  From compression cache, the pages never move to a swap in a compressed form. <br>  When it is necessary to free up even that memory area which is used under compression cache (in case of extreme memory shortage), then all compressed pages are extracted and drop into the swap, and the area becomes free. <br>  It is also important to note that the amount of memory used under the compression cache is attributed to the guest memory of the virtual machine.  That is, this volume is not allocated separately, as is the memory for the overhead projector.  Therefore, it is important to observe the optimal value of the maximum size of the compression cache.  If the size is too modest, many compressed pages of memory will fall into the swap, significantly negating the advantages of memory compression.  If it is too large, there will be too many pages in the cache that may not be in demand for a long time, and the bloated cache will simply waste the amount of guest memory.  The behavior of the technology is governed by advanced parameters, the name of which begins with Mem.MemZip.  For example, the cache size is primarily controlled by the Mem.MemZipMaxPc parameter. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Hypervisor swapping </h3><br>  In the case when using TPS, ballooning and memory compression, the hypervisor fails to exceed the host's free memory line by 2%, ESXi actively uses virtual machine swapping (pages start to drop into the .swap file created on the disk storage when the virtual machine starts). <br>  As a rule, if we consider swapping virtual machines by themselves, it allows us to guarantee the release of a certain value of memory for a certain time, but it has such serious disadvantages: <br><ul><li>  The hypervisor does not really know which memory pages are best suited as the operating system knows about them; </li><li>  For the same reason, there is the problem of double swapping.  When the OS memory management manager decides to zapvapirovat the same page, which the hypervisor has already managed to zavapirovat, the page is retrieved by the hypervisor, and immediately falls into the operating system swap; </li><li>  And of course, swapping is very expensive for a virtual machine.  Delays during which pages are extracted from a swap can reach up to ten milliseconds.  This leads to a serious drop in performance. </li></ul>  Therefore, the following three methods are used in ESXi to reduce the effect of the disadvantages described above: <br><ul><li>  Reducing the effect of intersection with the work of the OS memory management manager by randomly selecting memory pages for swapping; </li><li>  Applications Memory Compression to reduce the number of pages sent to the swap; </li><li>  The use of SSD drives for storage swap.  So, having transferred a swap to an SSD, whose reading speed is much higher than that of regular disks, you can significantly reduce the delay in extracting pages from the swap.  The name given to this approach is Host Cache, and it is recommended to use local SSDs rather than to use on remote storage. </li></ul><h1>  Some results of tests conducted by VMware </h1><br>  Compare the performance dropdown of the Sharepoint configuration with and without memory comression: <br><img src="https://habrastorage.org/storage1/10ba11c0/116e6800/c2538dde/5d1abb59.png"><br>  Horizontally, the amount of physical memory available to the hypervisor was gradually reduced.  And along the vertical to the left you can trace the performance drop. <br><br>  In this test, the drop in performance of <a href="http://dominicgiles.com/swingbench.html">Swingbench</a> loads was compared in the same <a href="http://dominicgiles.com/swingbench.html">way</a> : <br><img src="https://habrastorage.org/storage1/9bd89a8c/3069c7c8/678244d9/00cccbb3.png"><br><br>  And in this test, compare the performance drop with the use of Host Cache on SSD drives and without: <br><img src="https://habrastorage.org/storage1/076300b5/42cf49e2/4ce851cf/e0a1c9cc.png"><br>  Unfortunately, it still remains and it is not clear what kind of disk was used in the test without Host Cache. <br><br>  Additionally, all the graphs above show the value of swapping, which makes it easy to follow the work of the TPS and ballooning technologies, which were also included in these tests.  For detailed tests of TPS and ballooning technologies, see the links below. <br><br>  In this topic, I also think it should be remembered about the feature Memory fault isolation stated in ESXi 5.0.  The hypervisor is able to detect failed memory regions and isolate them.  So, if a bad region was detected among the pages of guest memory, the virtual machine is restarted.  But the ESXi magenta screen will now fall only when such a region is occupied by the hypervisor code. <br><br>  According to the materials: <br>  <a href="http://www.petri.co.il/memory-compression-in-vsphere-4-1.htm">www.petri.co.il/memory-compression-in-vsphere-4-1.htm</a> <br>  <a href="http://www.vmware.com/pdf/Perf_Best_Practices_vSphere5.0.pdf">www.vmware.com/pdf/Perf_Best_Practices_vSphere5.0.pdf</a> <br>  <a href="http://www.vmware.com/files/pdf/mem_mgmt_perf_vsphere5.pdf">www.vmware.com/files/pdf/mem_mgmt_perf_vsphere5.pdf</a> <br>  <a href="http://www.vmware.com/support/vsphere5/doc/vsphere-esx-vcenter-server-50-new-features.html">www.vmware.com/support/vsphere5/doc/vsphere-esx-vcenter-server-50-new-features.html</a> </div><p>Source: <a href="https://habr.com/ru/post/134631/">https://habr.com/ru/post/134631/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134625/index.html">A little bit about testing applications and user feedback</a></li>
<li><a href="../134627/index.html">My BlackBerry Development Experience</a></li>
<li><a href="../134628/index.html">Online courses from Stanford University and Berkeley University for 2012</a></li>
<li><a href="../134629/index.html">Experience of moving to SSD: in half a year</a></li>
<li><a href="../134630/index.html">Video review of entertaining iPad apps through the eyes of a simple parent</a></li>
<li><a href="../134632/index.html">Notes startups (from the creators of Wizee Shopping)</a></li>
<li><a href="../134634/index.html">Limoncelli test</a></li>
<li><a href="../134635/index.html">Algorithm for determining motion through comparing two frames</a></li>
<li><a href="../134636/index.html">Hidden redirect to ER.RU</a></li>
<li><a href="../134637/index.html">Java Singleton Option</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>