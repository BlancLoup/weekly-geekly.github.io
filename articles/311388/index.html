<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Features of ProxyChanging software in Android. Part 1: From Jelly Bean to Lollipop</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once, for my own convenience, I wanted to write an application that changes the proxy settings in the Wifi network configuration for Android. The task...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Features of ProxyChanging software in Android. Part 1: From Jelly Bean to Lollipop</h1><div class="post__text post__text-html js-mediator-article">  Once, for my own convenience, I wanted to write an application that changes the proxy settings in the Wifi network configuration for Android.  The task, as it seemed to me then, was to spit on time, however, in practice, as always, unforeseen difficulties arose. <br><br><img src="https://habrastorage.org/files/aed/159/b66/aed159b669ca4dc3b7160de230f83bb4.png"><br><br>  If you think it is useful in the future to know the decision, you want to learn something for yourself or if curiosity just woke up in you - welcome under cat.  There you will find the internal structure of the classes responsible for the configuration of Wifi in different versions of Android, a small cup of Java code and a pinch of Reflection. <br><a name="habracut"></a><br>  A bit of communication with Google on the topic ‚Äúchange wifi proxy settings in android programmatically‚Äù led, of course, to StackOverflow, where the solution was present via Reflection.  Without thinking, I copied the code and ran it on my device. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">Result</b> <div class="spoiler_text"><img src="https://s-media-cache-ak0.pinimg.com/originals/d6/67/7a/d6677a1dc97b940f70e42ef0363dd496.jpg" alt="image"><br></div></div><br>  The disappointment was quickly replaced by interest and excitement, approximately at this moment the author decided that he had already spent too much time in order to simply score on the above question, and also realized that this task requires a more global approach.  So let's go. <br><br><h4>  Step 1. We study the internal structure of the android.net library and the differences in Jelly Bean - Kitkat and Lollipop </h4><br><div class="spoiler">  <b class="spoiler_title">A list of things you want to know to better understand what's going on below.</b> <div class="spoiler_text"><ul><li>  Your English level must be, at least, pre-intermediate. </li><li>  You should not have questions ‚ÄúWhat is <i>Context</i> ?‚Äù And similar in complexity, if it arose at this moment - you can read <a href="https://developer.android.com/training/basics/firstapp/index.html">developer.android.com</a> or <a href="http://developer.alexanderklimov.ru/android/">Alexander Klimov</a> </li><li>  Also, the annotations of <i>@Before</i> , <i>@Test</i> , <i>@After</i> and other things related to testing should not cause embarrassment.  Again, link: <a href="https://developer.android.com/training/testing/start/index.html">developer.android.com</a> </li></ul><br>  I would love to take it all apart, but you know, then my article will grow into a book. <br><br>  I would also like to give a few more general clarifications: <br><br><ul><li>  You almost will not find comments in my code.  I thought about this issue for a long time and doubted it for a very long time, but in the end I decided to just give it to a girl who doesn‚Äôt know java at all, and, after a brief explanation of what <i>class</i> , <i>void</i> , <i>throws</i> , <i>exception</i> was, she could read several classes , it is very accurate to say what happens in them and their methods, so I almost abandoned them. </li><li>  If you have comments, additions, questions, comments (for example, on the previous paragraph) - the author is waiting for them. </li><li>  The article at the moment is very generalized, again, if you want to see some points in more detail, then depending on the scope of work, I will write a comment or, perhaps, a separate article on the topic that interests you. </li><li>  There are no imports in the code, because the package name contains the nickname of your humble servant, and, judging by the rules, they should not be shined in the sandbox article. </li></ul></div></div><br>  Some more questions on Google led me to <a href="https://android.googlesource.com/platform/frameworks/base/%2Brefs">android.googlesource</a> <br><br>  Proxy settings (as well as some others) are enclosed in the <i>WifiConfiguration</i> instance (Reference to the <a href="">class for Kitkat mr2.2</a> ) for this network.  When studying this class, an answer was obtained to why the solution with StackOverflow did not work on my device.  It turned out that since the fifth version of the Android device of the <i>WifiConfiguration</i> class, as well as the <i>android.net</i> package, the <a href=""><i>LinkPropeties</i></a> object with which the above code has worked does not exist within this class has undergone significant changes.  But there is an <a href=""><i>IpConfiguraion</i></a> object with a <a href=""><i>ProxyInfo</i></a> object. <br><br>  Given that these Android versions covered 80% of various devices, the task was to simply write something like this: <br><br><pre><code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Build.VERSION.SDK_INT &gt; <span class="hljs-number"><span class="hljs-number">14</span></span> &amp;&amp; Build.VERSION.SDK_INT &lt; <span class="hljs-number"><span class="hljs-number">20</span></span>){ changeProxyWithLikProperties(String host, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(Build.VERSION.SDK_INT &gt; <span class="hljs-number"><span class="hljs-number">20</span></span> &amp;&amp; Build.VERSION.SDK_INT &lt; <span class="hljs-number"><span class="hljs-number">23</span></span>){ changeProxyWithProxyInfo(String host, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(<span class="hljs-string"><span class="hljs-string">"Sorry, android version not supported"</span></span>) } }</code> </pre> <br>  where <i>changeProxyXXX</i> - monstrous methods, on a couple of pages.  Not the most elegant solution. <br><br><h4>  Step 2. Developing a library for configuring Wifi proxy in Android </h4><br>  So, the author decided not to dwell on the cumbersome class with a bunch of methods.  There is free time (untimely leave on the occasion of the reduction of funding for the project in which I participated), so why not work more globally on the task. <br><br><h5>  Module architecture </h5><br>  We have different implementations for different versions of Android, which should have a single interface for changing proxy settings, and working with the <i>WifiConfiguration</i> object.  Trying to satisfy these requirements as much as possible, at the initial stage my inflamed consciousness came up with something like this: <br><br><img src="https://habrastorage.org/files/c0c/1ee/f16/c0c1eef16af74e03ba28bd3cb98e4b33.png"><br><br><div class="spoiler">  <b class="spoiler_title">An explanatory comment on the picture above.</b> <div class="spoiler_text"><ul><li>  The <i>BaseWifiConfiguration</i> class, in fact, stores the <i>WifiConfiguration</i> object and contains the implementation of taking the configuration of the network that is current when created via <i>Context</i> . </li><li>  The <i>ProxyChanger</i> interface, accordingly, guarantees the availability of methods for working with the network proxy configuration. </li><li>  We have to work with Reflection, and it is desirable to move the main methods for this into a separate class, as they will be used frequently.  Therefore, we create the <i>ReflectionHelper</i> class. </li></ul><br>  Classes for different versions of Android are inherited from <i>BaseWifiConfiguration in</i> order to have easy access to the <i>WifiConfiguration</i> instance of the <i>network of</i> interest to us and facilitate working with it, and should have implementations of the methods declared in <i>ProxyChanger</i> . <br><br><div class="spoiler">  <b class="spoiler_title">PS</b> <div class="spoiler_text">  I do not argue that this is perhaps not the best architectural solution, and if you have any suggestions for improvement or any comments, I‚Äôm glad to see them in the comments. <br><br>  For example, I am very interested in ReflectionHelper, as you can see, it is declared abstract, it is made for reasons that it should not have concrete implementations and is used only for structuring and easy access to the methods of interest to us.  I do not know how correct this approach is, so if you have a comment on this issue (or some other), I will be very grateful to hear it. </div></div></div></div><br>  Of course, this is only a common framework and, after several iterations of refactoring, it will acquire new details. <br><br><h5>  Tests </h5><br>  So, we thought about architecture, it is time to write a couple of lines of code.  Of course, not working, and testing our project. <br><br>  We create a small class that will be responsible for choosing ProxyChanger for a specific api, a class for working with the above-mentioned object in terms of changing the proxy configuration and one more, for taking information about the current network settings, we get a couple of phones and start. <br><br><div class="spoiler">  <b class="spoiler_title">WifiProxyChangerTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiProxyChangerTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExpectedException expectedException = ExpectedException.none(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ActivityTestRule mActivityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;( MainActivity.class); Context context; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ context = mActivityRule.getActivity(); ExceptionsPreparer.prepareExceptions(expectedException, context); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testChangeWifiStaticProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String testIp = RandomValuesGenerator.randomIp(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> testPort = RandomValuesGenerator.randomPort(); WifiProxyChanger.changeWifiStaticProxySettings(testIp, testPort, context); assertEquals(testIp, WifiProxyInfo.getHost(context)); assertEquals(testPort, WifiProxyInfo.getPort(context)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testProxySettingsClear</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String testIp = RandomValuesGenerator.randomIp(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> testPort = RandomValuesGenerator.randomPort(); WifiProxyChanger.changeWifiStaticProxySettings(testIp, testPort, context); WifiProxyChanger.clearProxySettings(context); assertEquals(ProxySettings.NONE, CurrentProxyChangerGetter .chooseProxyChangerForCurrentApi(context) .getProxySettings()); } <span class="hljs-meta"><span class="hljs-meta">@After</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> learSettings() <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NetworkHelper.isWifiConnected(context) &amp;&amp; ApiChecker.isSupportedApi()) WifiProxyChanger.clearProxySettings(context); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">WifiProxyInfoTest.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiProxyInfoTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExpectedException expectedException = ExpectedException.none(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ActivityTestRule mActivityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;( MainActivity.class); Context context; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareAndPresetProxy</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ context = mActivityRule.getActivity(); ExceptionsPreparer.prepareExceptions(expectedException, context); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ApiChecker.isSupportedApi()) { WifiProxyChanger.clearProxySettings(context); WifiProxyChanger.changeWifiStaticProxySettings(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">3030</span></span>, context); } } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ assertEquals(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, WifiProxyInfo.getHost(context)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ assertEquals(<span class="hljs-number"><span class="hljs-number">3030</span></span>, WifiProxyInfo.getPort(context)); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testGetProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ assertEquals(ProxySettings.STATIC, WifiProxyInfo.getProxySettings(context)); } <span class="hljs-meta"><span class="hljs-meta">@After</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> learSettings() <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> Exception { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (NetworkHelper.isWifiConnected(context) &amp;&amp; ApiChecker.isSupportedApi()) WifiProxyChanger.clearProxySettings(context); } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">CurrentProxyChangerGetterTest .java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@RunWith</span></span>(AndroidJUnit4.class) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentProxyChangerGetterTest</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ExpectedException expectedException = ExpectedException.none(); <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ActivityTestRule mActivityRule = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ActivityTestRule&lt;&gt;( MainActivity.class); Context context; <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ context = mActivityRule.getActivity(); ExceptionsPreparer.prepareExceptions(expectedException, context); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">testChooseProxyChangerForCurrentApi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ ProxyChanger proxyChanger = CurrentProxyChangerGetter.chooseProxyChangerForCurrentApi(context); WifiManager manager = (WifiManager) context.getSystemService(Context.WIFI_SERVICE); assertEquals(manager.getConnectionInfo().getNetworkId(), proxyChanger.getWifiConfiguration().networkId); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ApiChecker.isJellyBeanOrKitkat()) { assertTrue(proxyChanger <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> WifiConfigurationForApiFrom15To19); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ApiChecker.isLolipop()) { assertTrue(proxyChanger <span class="hljs-keyword"><span class="hljs-keyword">instanceof</span></span> WifiConfigurationForApiFrom21To22); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ExceptionsPreparer.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExceptionsPreparer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepareExceptions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExpectedException expectedException, Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ApiChecker.isSupportedApi()) { expectedException.expect(ApiNotSupportedException.class); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!NetworkHelper.isWifiConnected(context)) { expectedException.expect(NullWifiConfigurationException.class); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!CurrentProxyChangerGetter.chooseProxyChangerForCurrentApi(context).isProxySetted()) { expectedException.expect(WifiProxyNotSettedException.class); } } }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">A comment to the code explaining where it came from there are a lot of incomprehensible things about which I did not mention.</b> <div class="spoiler_text">  I think, after reading, there were reasonable questions: What is this <i>‚ÄúProxySettings.STATIC‚Äù</i> , and for which he answers, where did the Exceptions come from, which were also not mentioned before, and so on. <br>  The fact is that, unfortunately, I didn‚Äôt have the original version, and only the test classes that have passed several iterations of refactoring are present in bitbucket. <br></div></div><br>  Running tests ends in failure, now we need to fix it somehow. <br><br><h4>  Step 3. Implementation </h4><br>  Finally, having thought over what to write and having made all the necessary preparations, we can proceed to the implementation of our project. <br><br><h5>  Part one: Preparatory work and auxiliary classes </h5><br><h6>  For a start, let's proceed to our promised pinch of Reflection. </h6><br><div class="spoiler">  <b class="spoiler_title">A little bit about Reflection api</b> <div class="spoiler_text"><blockquote>  It is commonly used in the Java virtual machine. <br>  Oracle Java Turtorial </blockquote><br>  Class, but what exactly can you do about it? <br><br><div class="spoiler">  <b class="spoiler_title">Small example</b> <div class="spoiler_text">  Suppose we have a small library, there are a couple of classes in it for taking a web page and saving it.  I want to connect it on the fly and use it.  We write for this a small class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LibLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//      ,   2   . URLClassLoader urlClassLoader; String page; LibLoader(File myJar) throws MalformedURLException { urlClassLoader = new URLClassLoader(new URL[]{myJar.toURL()}, this.getClass().getClassLoader()); } public void loadPage(URL url) throws Exception { Class classToLoad = Class.forName("com.company.HtmlPageGetter", true, urlClassLoader); Method method = classToLoad.getDeclaredMethod("getPageFromURL", URL.class); Object instance = classToLoad.newInstance(); Object result = method.invoke(instance, url); page = (String) result; } public String getCurrentPage() { return page; } public void saveCurrentPage(String name) throws Exception { List&lt;String&gt; content = new ArrayList&lt;&gt;(); content.add(page); Class classToLoad = Class.forName("com.company.HtmlPageSaver", true, urlClassLoader); Method method = classToLoad.getDeclaredMethod("savePageToFile", String.class, List.class); Object instance = classToLoad.newInstance(); method.invoke(instance, name, content); } }</span></span></code> </pre><br>  Now use it: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ File lib = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(<span class="hljs-string"><span class="hljs-string">"htmlgetandsave.jar"</span></span>); LibLoader libLoader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LibLoader(lib); libLoader.loadPage(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> URL(<span class="hljs-string"><span class="hljs-string">"https://habrahabr.ru/post/69552/"</span></span>)); System.out.println(libLoader.getCurrentPage()); libLoader.saveCurrentPage(<span class="hljs-string"><span class="hljs-string">"   -  reflection     "</span></span>); }</code> </pre><br>  Run and enjoy the result: <br><br><img src="https://habrastorage.org/files/a68/8a9/95d/a688a995dd6948b6a73bcb4d55056396.png"><br><br>  Moreover, we could only know the location of the library file and not know anything about its structure, Reflection api would allow to study this question right in runtime, and use it after that. <br></div></div><br>  However, what is important for us now is that, among other things, thanks to Reflection, we can get access to private fields and methods, as well as with the <i>hide</i> annotation. <br></div></div><br>  So, we write already mentioned above <i>ReflectionHelper</i> . <br><br><div class="spoiler">  <b class="spoiler_title">ReflectionHelper.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ReflectionHelper</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Used for getting public fields with </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@hide</span></span></span><span class="hljs-comment"> annotation */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object, String name)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SecurityException, NoSuchFieldException, IllegalArgumentException, IllegalAccessException </span></span>{ Field field = object.getClass().getField(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> field.get(object); } <span class="hljs-comment"><span class="hljs-comment">/** * Used for getting private fields */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDeclaredField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object, String name)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SecurityException, NoSuchFieldException, IllegalArgumentException, IllegalAccessException </span></span>{ Field declaredField = object.getClass().getDeclaredField(name); declaredField.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> declaredField.get(object); } <span class="hljs-comment"><span class="hljs-comment">/** * Used for setting private fields */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDeclaredField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object, String name, Object value)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ Field declaredField = object.getClass().getDeclaredField(name); declaredField.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); declaredField.set(object, value); } <span class="hljs-comment"><span class="hljs-comment">/** * Used for setting Enum fields */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setEnumField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object, String value, String name)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SecurityException, NoSuchFieldException, IllegalArgumentException, IllegalAccessException </span></span>{ Field field = object.getClass().getField(name); field.set(object, Enum.valueOf((Class&lt;Enum&gt;) field.getType(), value)); } <span class="hljs-comment"><span class="hljs-comment">/** * Used for simplifying process of invoking private method * Automatically detects args types and founds method to get and invoke */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getMethodAndInvokeIt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object object, String methodName, Object... args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span></span>{ Method method = object.getClass().getDeclaredMethod(methodName, parameterTypes(args)); method.setAccessible(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> method.invoke(object, args); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Class[] parameterTypes(Object... args) { ArrayList&lt;Class&gt; classes = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Object arg : args) { classes.add(arg.getClass()); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> classes.toArray(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[args.length]); } }</code> </pre> <br>  Here, I still set myself a memo, because, for example, the difference between <i>getField</i> and <i>getDeclaredField</i> and in what cases which one to use can be easily forgotten. <br></div></div><br>  Most of the work with Reflection has been moved to a separate class, let's deal with the implementation of the remaining parts. <br><br><h6>  Create Exceptions for 3 cases: </h6><br><ul><li>  Inappropriate api version.  Corresponding class: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiNotSupportedException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ApiNotSupportedException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"Api version not supported"</span></span>); } }</code> </pre><br></li><li>  Attempt to create an object with a non-configured Wifi configuration (For example, a user tries to change the current network proxy settings with wifi disabled): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NullWifiConfigurationException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Exception</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">NullWifiConfigurationException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"WiFi configuration was null. \n"</span></span> + <span class="hljs-string"><span class="hljs-string">"If you are trying to change current network settings - check your connection."</span></span>); } }</code> </pre><br></li><li>  The object for the proxy settings in the current WifiConfiguration class is not defined: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiProxyNotSettedException</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IllegalStateException</span></span></span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WifiProxyNotSettedException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(<span class="hljs-string"><span class="hljs-string">"Wifi proxy not setted for current WifiConfiguration"</span></span>); } }</code> </pre><br></li></ul><br><h6>  Implement the class that serves as the base class for subclasses working with <i>WifiConfiguration</i> under different api: </h6><br><div class="spoiler">  <b class="spoiler_title">BaseWifiConfiguration.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseWifiConfiguration</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> WifiConfiguration wifiConfiguration; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseWifiConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WifiConfiguration wifiConfiguration)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wifiConfiguration == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NullWifiConfigurationException(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wifiConfiguration = wifiConfiguration; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BaseWifiConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(getCurrentWifiConfigurationFromContext(context)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> WifiConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWifiConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wifiConfiguration; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> WifiConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentWifiConfigurationFromContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> WifiManager manager = (WifiManager) context.getSystemService(Context.WIFI_SERVICE); List&lt;WifiConfiguration&gt; wifiConfigurationList = manager.getConfiguredNetworks(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!manager.isWifiEnabled() || wifiConfigurationList == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || wifiConfigurationList.isEmpty()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> findWifiConfigurationByNetworkId(wifiConfigurationList, manager.getConnectionInfo().getNetworkId()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> WifiConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">findWifiConfigurationByNetworkId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;WifiConfiguration&gt; wifiConfigurationList, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> networkId)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (WifiConfiguration wifiConf : wifiConfigurationList) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (wifiConf.networkId == networkId) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> wifiConf; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br></div></div><br><h6>  <i>We declare ProxyChanger</i> interface </h6><br><div class="spoiler">  <b class="spoiler_title">ProxyChanger.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProxyChanger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProxySettings proxySettings)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException</span></span>; <span class="hljs-function"><span class="hljs-function">ProxySettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxyHostAndPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException</span></span>; <span class="hljs-function"><span class="hljs-function">String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ApiNotSupportedException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, NoSuchFieldException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProxySetted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException</span></span>; <span class="hljs-function"><span class="hljs-function">WifiConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getWifiConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; }</code> </pre><br>  Yes, the Exception list when using Reflection is something. <br></div></div><br>  Look like that's it?  And, no, there is another small sub-item: <br><br><h6>  ProxySettings.java - what is it all about and why is it needed? </h6><br>  This is the equivalent of an enumeration that is in the <i>Android</i> library's <i>WifiConfiguration</i> class.  We create it in order to facilitate the work with it and not to prescribe <i>STATIC</i> , <i>NONE</i> and others manually each time. <br><br><div class="spoiler">  <b class="spoiler_title">ProxySettings.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">enum</span></span> ProxySettings { <span class="hljs-comment"><span class="hljs-comment">/* No proxy is to be used. Any existing proxy settings * should be cleared. */</span></span> NONE(<span class="hljs-string"><span class="hljs-string">"NONE"</span></span>), <span class="hljs-comment"><span class="hljs-comment">/* Use statically configured proxy. Configuration can be accessed * with httpProxy. */</span></span> STATIC(<span class="hljs-string"><span class="hljs-string">"STATIC"</span></span>), <span class="hljs-comment"><span class="hljs-comment">/* no proxy details are assigned, this is used to indicate * that any existing proxy settings should be retained */</span></span> UNASSIGNED(<span class="hljs-string"><span class="hljs-string">"UNASSIGNED"</span></span>), <span class="hljs-comment"><span class="hljs-comment">/* Use a Pac based proxy. */</span></span> PAC(<span class="hljs-string"><span class="hljs-string">"PAC"</span></span>); String value = <span class="hljs-string"><span class="hljs-string">""</span></span>; ProxySettings(String value) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.value = value; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> value; } }</code> </pre><br></div></div><br><h5>  Part Two: We write classes that implement <i>ProxyChanger</i> for specific Api </h5><br>  So, it's time to finally write the same code that will change our proxy settings.  At once I will make a reservation that there are various ways to get to them through Reflection: you can call the methods of the <i>WifiConfiguration</i> class, you can get to, in fact, the fields where they are and change them directly through <i>setDeclaredField</i> . <br><br>  I wrote only a part for working with the current network (for this is what the author needed), i.e.  with instantiating classes through <i>Context</i> , however, our architecture allows adding just a few lines to adapt these classes to work with an arbitrary <i>WifiConfiguration</i> object. <br><br><h6>  Kitkat and Jelly Bean </h6><br>  As mentioned in step 1, in these versions of Android, the <i>ProxyProperties</i> object stored in <i>LinkProperties</i> , which in turn is in <i>WifiConfiguration,</i> is responsible for storing the Proxy settings.  Yes, yes, a needle in an egg, an egg in a duck, a duck in a hare, and so on. <br><br>  In order to change the proxy settings, create a new instance of <i>ProxyProperties</i> with the parameters we need, then replace this object with an existing one and then configure <i>ProxySettings</i> . <br><br>  A separate class will be responsible for creating instances of <i>ProxyProperties</i> : <br><br><div class="spoiler">  <b class="spoiler_title">ProxyPropertiesConstructor.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProxyPropertiesConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxyProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyProperties(host, port, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxyProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port, String exclList)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, ClassNotFoundException, IllegalAccessException, InvocationTargetException, InstantiationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyPropertiesConstructor().newInstance(host, port, exclList); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Constructor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxyPropertiesConstructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Class.forName(<span class="hljs-string"><span class="hljs-string">"android.net.ProxyProperties"</span></span>).getConstructor(String.class, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.class, String.class); } }</code> </pre><br></div></div><br>  For convenient work with this object, we will also create a container class that contains the <i>ProxyProperties</i> object and provides access to the main fields (and allows you to conveniently create it immediately through the host and port): <br><br><div class="spoiler">  <b class="spoiler_title">ProxyPropertiesContainer.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProxyPropertiesContainer</span></span></span><span class="hljs-class"> </span></span>{ Object proxyProperties; ProxyPropertiesContainer(Object proxyProperties) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.proxyProperties = proxyProperties; } ProxyPropertiesContainer(String host, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> ClassNotFoundException, NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(host, port, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } ProxyPropertiesContainer(String host, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> port, String exclList) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(ProxyPropertiesConstructor.proxyProperties(host, port, exclList)); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (String) ReflectionHelper.getDeclaredField(proxyProperties, <span class="hljs-string"><span class="hljs-string">"mHost"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>) ReflectionHelper.getDeclaredField(proxyProperties, <span class="hljs-string"><span class="hljs-string">"mPort"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getExclusionList</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (String) ReflectionHelper.getDeclaredField(proxyProperties, <span class="hljs-string"><span class="hljs-string">"mExclusionList"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyProperties; } }</code> </pre><br></div></div><br>  Now we write the implementation of the actual class: <br><br><div class="spoiler">  <b class="spoiler_title">WifiConfigurationForApiFrom15To19.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiConfigurationForApiFrom15To19</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseWifiConfiguration</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProxyChanger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ProxyPropertiesContainer proxyPropertiesContainer; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WifiConfigurationForApiFrom15To19</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException, NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.proxyPropertiesContainer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProxyPropertiesContainer(getCurrentProxyProperties()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> WifiConfigurationForApiFrom15To19 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFromCurrentContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException, NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiConfigurationForApiFrom15To19(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProxySettings proxySettings)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ ReflectionHelper.setEnumField(wifiConfiguration, proxySettings.getValue(), <span class="hljs-string"><span class="hljs-string">"proxySettings"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProxySettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProxySettings.valueOf(String.valueOf(ReflectionHelper.getDeclaredField(wifiConfiguration, <span class="hljs-string"><span class="hljs-string">"proxySettings"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxyHostAndPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException </span></span>{ proxyPropertiesContainer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProxyPropertiesContainer(host, port); ReflectionHelper.getMethodAndInvokeIt( getLinkProperties(), <span class="hljs-string"><span class="hljs-string">"setHttpProxy"</span></span>, proxyPropertiesContainer.getProxyProperties()); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (proxyPropertiesContainer == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiProxyNotSettedException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyPropertiesContainer.getHost(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ApiNotSupportedException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, NoSuchFieldException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (proxyPropertiesContainer == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiProxyNotSettedException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyPropertiesContainer.getPort(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProxySetted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !(proxyPropertiesContainer == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> LinkProperties </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLinkProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (LinkProperties) ReflectionHelper.getField(wifiConfiguration, <span class="hljs-string"><span class="hljs-string">"linkProperties"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentProxyProperties</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ReflectionHelper.getDeclaredField(getLinkProperties(), <span class="hljs-string"><span class="hljs-string">"mHttpProxy"</span></span>); } }</code> </pre><br></div></div><br>  C finished with this version, remained: <br><br><h6>  Lollipop </h6><br>  Again, appealing to step 1, we can conclude that the proxy settings in this version of Api are in the <i>ProxyInfo</i> class contained in <i>IpConfiguration</i> , which in turn has our <i>WifiConfiguration</i> as its location.  <i>ProxySettings</i> - also moved, now it is in the above <i>IpConfiguration</i> . <br><br>  Let's write a class that makes new ProxyInfo instances by the specified parameters. <br><br><div class="spoiler">  <b class="spoiler_title">ProxyInfoConstructor.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProxyInfoConstructor</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ProxyInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxyInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyInfo(host, port, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ProxyInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxyInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port, String exclude)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException </span></span>{ Object newProxyInfo = proxyInfoConstructor().newInstance(host, port, exclude); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (ProxyInfo) newProxyInfo; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> Constructor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">proxyInfoConstructor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Class.forName(<span class="hljs-string"><span class="hljs-string">"android.net.ProxyInfo"</span></span>).getConstructor(String.class, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.class, String.class); } }</code> </pre><br></div></div><br>  As you can see, here we are not returning Objects, but <i>ProxyInfo</i> instances, moreover, it will be seen later that this class also has <i>getHost</i> and <i>getPort methods</i> .  In the previous case, we could not do this, the <i>ProxyProperties</i> class was hidden, which is why we wrote a ‚Äúshell‚Äù for it. <br><br>  And, actually, the code for another implementation: <br><br><div class="spoiler">  <b class="spoiler_title">WifiConfigurationForApiFrom21To22.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiConfigurationForApiFrom21To22</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseWifiConfiguration</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProxyChanger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WifiConfigurationForApiFrom21To22</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> WifiConfigurationForApiFrom21To22 </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createFromCurrentContext</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiConfigurationForApiFrom21To22(context); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProxySettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ProxySettings.valueOf(String.valueOf(ReflectionHelper.getDeclaredField(getIpConfigurationObject(), <span class="hljs-string"><span class="hljs-string">"proxySettings"</span></span>))); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProxySettings proxySettings)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ ReflectionHelper.setEnumField(getIpConfigurationObject(), proxySettings.getValue(), <span class="hljs-string"><span class="hljs-string">"proxySettings"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxyHostAndPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException </span></span>{ setProxyInfo(ProxyInfoConstructor.proxyInfo(host, port)); } <span class="hljs-meta"><span class="hljs-meta">@TargetApi</span></span>(Build.VERSION_CODES.LOLLIPOP) <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException </span></span>{ ProxyInfo info = getProxyInfo(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiProxyNotSettedException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.getHost(); } <span class="hljs-meta"><span class="hljs-meta">@TargetApi</span></span>(Build.VERSION_CODES.LOLLIPOP) <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ApiNotSupportedException, NoSuchMethodException, IllegalAccessException, InvocationTargetException </span></span>{ ProxyInfo info = getProxyInfo(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (info == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WifiProxyNotSettedException(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> info.getPort(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isProxySetted</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !(getProxyInfo() == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Object </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getIpConfigurationObject</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchFieldException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ReflectionHelper.getDeclaredField(wifiConfiguration, <span class="hljs-string"><span class="hljs-string">"mIpConfiguration"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> ProxyInfo </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxyInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, InvocationTargetException, IllegalAccessException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (ProxyInfo) ReflectionHelper.getMethodAndInvokeIt(wifiConfiguration, <span class="hljs-string"><span class="hljs-string">"getHttpProxy"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProxyInfo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ProxyInfo proxyInfo)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, InvocationTargetException, IllegalAccessException, NoSuchFieldException </span></span>{ ReflectionHelper.getMethodAndInvokeIt(wifiConfiguration, <span class="hljs-string"><span class="hljs-string">"setHttpProxy"</span></span>, proxyInfo); } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With the main implementation that's all. </font><font style="vertical-align: inherit;">To the finish line left quite a bit.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Step 4. Pre-launch preparation </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We implement the classes mentioned earlier in the tests (note: we implement the configuration of the proxy by IP and port, respectively, the type </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ProxySettings</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> - </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">STATIC</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .)</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">CurrentProxyChangerGetter.java</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CurrentProxyChangerGetter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ProxyChanger </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chooseProxyChangerForCurrentApi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ApiNotSupportedException, NoSuchFieldException, IllegalAccessException, NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ApiChecker.isJellyBeanOrKitkat()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WifiConfigurationForApiFrom15To19.createFromCurrentContext(context); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (ApiChecker.isLolipop()) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> WifiConfigurationForApiFrom21To22.createFromCurrentContext(context); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ApiNotSupportedException(); } } }</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WifiProxyChanger.java</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiProxyChanger</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeWifiStaticProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port, Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, InstantiationException, IllegalAccessException, NoSuchFieldException, ApiNotSupportedException, NullWifiConfigurationException </span></span>{ updateWifiWithNewConfiguration( getCurrentWifiConfiguretionWithUpdatedSettings(host, port, ProxySettings.STATIC, context), context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">clearProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IllegalAccessException, ApiNotSupportedException, NoSuchFieldException, NullWifiConfigurationException, ClassNotFoundException, NoSuchMethodException, InstantiationException, InvocationTargetException </span></span>{ updateWifiWithNewConfiguration( getCurrentWifiConfiguretionWithUpdatedSettings(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, ProxySettings.NONE, context), context); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> WifiConfiguration </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getCurrentWifiConfiguretionWithUpdatedSettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port, ProxySettings proxySettings, Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ApiNotSupportedException, IllegalAccessException, NullWifiConfigurationException, NoSuchFieldException, ClassNotFoundException, NoSuchMethodException, InstantiationException, InvocationTargetException </span></span>{ ProxyChanger proxyChanger = CurrentProxyChangerGetter.chooseProxyChangerForCurrentApi(context); proxyChanger.setProxyHostAndPort(host, port); proxyChanger.setProxySettings(proxySettings); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> proxyChanger.getWifiConfiguration(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">updateWifiWithNewConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WifiConfiguration wifiConfiguration, Context context)</span></span></span><span class="hljs-function"> </span></span>{ WifiManager currentWifiManager = NetworkHelper.getWifiManager(context); currentWifiManager.updateNetwork(wifiConfiguration); currentWifiManager.saveConfiguration(); currentWifiManager.reconnect(); } }</code> </pre><br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WifiProxyInfo.java</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WifiProxyInfo</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getHost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException, NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CurrentProxyChangerGetter.chooseProxyChangerForCurrentApi(context).getProxyHost(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPort</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NoSuchMethodException, IllegalAccessException, InvocationTargetException, ApiNotSupportedException, NoSuchFieldException, NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CurrentProxyChangerGetter.chooseProxyChangerForCurrentApi(context).getProxyPort(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> ProxySettings </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> ApiNotSupportedException, IllegalAccessException, NoSuchFieldException, NullWifiConfigurationException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CurrentProxyChangerGetter.chooseProxyChangerForCurrentApi(context).getProxySettings(); } }</code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Implement an auxiliary class to check the API version: </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ApiChecker.java</font></font></b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ApiChecker</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isJellyBeanOrKitkat</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Build.VERSION.SDK_INT &gt; <span class="hljs-number"><span class="hljs-number">14</span></span> &amp;&amp; Build.VERSION.SDK_INT &lt; <span class="hljs-number"><span class="hljs-number">20</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isLolipop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Build.VERSION.SDK_INT &gt; <span class="hljs-number"><span class="hljs-number">20</span></span> &amp;&amp; Build.VERSION.SDK_INT &lt; <span class="hljs-number"><span class="hljs-number">23</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isSupportedApi</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> isJellyBeanOrKitkat() || isLolipop(); } }</code> </pre><br></div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> LAUNCHING TESTS </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> (I apologize, but this is such a moment that I decided to single out its title) </font></font><br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5a2/035/7c7/5a20357c7dab47ef86f70302088e1e45.png"></div><br>  ... <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Champagne! </font><font style="vertical-align: inherit;">Wine! </font><font style="vertical-align: inherit;">Folk festivals! </font><font style="vertical-align: inherit;">Applause! </font><font style="vertical-align: inherit;">Queen - We are the champions as music!</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Small comment</font></font></b> <div class="spoiler_text"> ,               .          ,     -  ,   <i>"!"</i>  . ,           10  ,   ,         . </div></div><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Step 5. Enjoy the fruits of our activities </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We connect the library to the application created by default and check the result: </font></font><br><br><div class="spoiler">  <b class="spoiler_title">MainActivity.java</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MainActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppCompatActivity</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.activity_main); changeProxySettings(<span class="hljs-string"><span class="hljs-string">"myhost.com"</span></span>, <span class="hljs-number"><span class="hljs-number">12345</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeProxySettings</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String host, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> port)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { WifiProxyChanger.changeWifiStaticProxySettings(host, port, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException | NoSuchMethodException | InstantiationException | InvocationTargetException | NoSuchFieldException | IllegalAccessException | NullWifiConfigurationException | ApiNotSupportedException e) { e.printStackTrace(); } } }</code> </pre><br></div></div><br>  We start.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We will not see anything interesting on the application screen, because we immediately go to the wifi network settings to which we are connected. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Result. </font><font style="vertical-align: inherit;">The picture is too big.</font></font></b> <div class="spoiler_text"><img src="https://habrastorage.org/files/11d/91c/eaf/11d91ceafa2b4b6f8b012e9ceb6ba3ff.png"><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The result is achieved. </font></font><br><br><h4>  Summarizing </h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the moment we have a working, easily expandable library, which can already be used to change the settings of wifi proxy networks in the above versions of Android. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Future plans? </font><font style="vertical-align: inherit;">Yes, the author has a list of them!</font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Of course, you need to add support for Marshmallow, just appeared a new phone running this version of Android (and I feel that working with the new permissions system will be the one more task). </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> I would also like to study the issue of settings for the mobile network. </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It may be worth refining the library to fully change the configuration of Wifi networks. </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">WifiConfiguration</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> is a large and interesting class, and, perhaps, soon </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">IpSettingsChanger</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> interface will appear in the library </font><font style="vertical-align: inherit;">, and with it a new article.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And, of course, you need to properly arrange the readme and other things on Bitbucket. </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And, of course, this is not all. </font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Post scriptum and some more author comments</font></font></b> <div class="spoiler_text"> ¬ª      ,  ,       ,          Bitbucket (   ). <br><br> ¬ª       ‚Äî    ,       . <br><br> ¬ª    ,           ,       ‚Äî . </div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Thank you for your interest in the article, sincerely yours, ‚ÄúNickname, which can not be left in the sandbox‚Äù </font></font></div><p>Source: <a href="https://habr.com/ru/post/311388/">https://habr.com/ru/post/311388/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311374/index.html">The results of the summer internship at Digital Security. Department of research</a></li>
<li><a href="../311376/index.html">Authentication and authorization in microservice applications</a></li>
<li><a href="../311378/index.html">Moderate usability testing</a></li>
<li><a href="../311380/index.html">Formation of web-studio products: hours, dates, profitability</a></li>
<li><a href="../311384/index.html">Announcement Rust 1.12</a></li>
<li><a href="../311390/index.html">The story of one obsession, or as I wrote a calendar script for Photoshop</a></li>
<li><a href="../311392/index.html">Create your own bot to play Go</a></li>
<li><a href="../311394/index.html">Virtual supercomputer on demand</a></li>
<li><a href="../311396/index.html">Russian Design Cup 2016</a></li>
<li><a href="../311398/index.html">Program where the plug will be, not where it was</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>