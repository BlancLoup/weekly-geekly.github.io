<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Emulate Amazon web services in the JVM process. Avoiding Roskomnadzor and accelerate development and testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Why then may you need to emulate the Amazon web services infrastructure? 

 First of all, it is saving - saving time for development and debugging, an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Emulate Amazon web services in the JVM process. Avoiding Roskomnadzor and accelerate development and testing</h1><div class="post__text post__text-html js-mediator-article"> Why then may you need to emulate the Amazon web services infrastructure? <br><br>  First of all, it is saving - saving time for development and debugging, and last but not least - saving money from the project budget.  It is clear that the emulator will not be 100% identical to the source environment that we are trying to emulate.  But in order to accelerate the development and automation of the process, the existing similarity should suffice.  The most topical of what happened in 2018 with AWS is blocking by providers of IP addresses of AWS subnets in the Russian Federation.  And these locks have affected our infrastructure hosted in the Amazon cloud.  If you plan to use AWS technology and place the project in this cloud, then emulation is more than worthwhile for development and testing. <br><br><img src="https://habrastorage.org/webt/jz/ty/k7/jztyk798xcq9yqietemgy-6133m.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In the publication I will tell how we managed to perform such a trick with the services S3, SQS, RDS PostgreSQL and Redshift when migrating the data warehouse existing on AWS for many years. <br><a name="habracut"></a><br>  This is only a part of my last year's report at the <a href="https://www.meetup.com/bigmoscow/events/249449918/">mitap</a> , it corresponds to the topics of the AWS and Java hubs.  The second part relates to PostgreSQL, Redshift and column databases and its text version can be published in the corresponding hubs, videos and slides are on <a href="https://2018.secrus.org/lang/ru/program/submitted-presentations/sequence-diagram-generated-from-bdd-test/">the conference website</a> . <br><br>  When developing an application for AWS during the blocking of AWS subnets, the team practically did not notice them in the daily development process of the new functionality.  The tests also worked and you can debug the application.  And only when trying to view application logs in logentries, metrics in SignalFX, or data analysis in Redshift / PostgreSQL RDS was disappointing - services were not available through the network of a Russian provider.  AWS emulation helped us to ignore this and avoid much greater delays when working with the Amazon cloud over a VPN network. <br><br>  Every cloud provider ‚Äúunder the hood‚Äù has a lot of dragons and you should not give in to advertising.  We must understand why all this is necessary for the service provider.  Of course, there are advantages to the existing infrastructure of Amazon, Microsoft and Google.  And when they tell you that everything was done only so that it was convenient for you to develop, they are most likely trying to plant you on their needle and give the first dose for free.  That then did not get down from the infrastructure and specific technology.  Therefore, we will try to avoid binding to the supplier (vendor lock-in).  It is clear that it is not always possible to completely abstract away from specific solutions and I think that quite often in a project it is possible to abstract almost by 90%.  But the remaining 10% of the project is tied to the technology provider, which is very important - this is either an optimization of the application performance, or the unique functions of which are not found anywhere else.  You should always keep in mind the advantages and disadvantages of technologies and secure yourself as much as possible, not to ‚Äúsit down‚Äù on a specific API of the cloud infrastructure provider. <br><br>  Amazon on its website writes about the <a href="https://docs.aws.amazon.com/amazon-mq/latest/developer-guide/welcome.html">processing of messages</a> .  The essence and abstraction of messaging technologies is the same everywhere, although there are nuances - the transfer of messages through queues or through topics.  AWS recommends using Apache ActiveMQ provided and managed by them to migrate applications from an existing messaging broker to new Amazon SQS / SNS applications.  This is like an example of binding to their own API, instead of the standardized JMS API and AMQP, MMQT, STOMP protocols.  It is clear that this provider with its solution may have higher performance, supported scalability, etc.  From my point of view, if you use their libraries, and not standardized APIs, then there will be much more problems. <br><br>  AWS has a Redshift database.  This is a distributed database with a massively parallel architecture.  You can load a large amount of your data into tables on multiple Redshft nodes in Amazon and perform analytical queries on large data sets.  This is not an OLTP system, where it is important for you to perform small queries on a small number of records quite often with ACID guarantees.  When working with Redshift, it is assumed that you do not have a large number of requests per unit of time, but they can count aggregates on a very large amount of data.  This system is positioned by the vendor to <a href="https://aws.amazon.com/big-data/featured-partner-data-warehouse-modernization/">upgrade your</a> data warehouse (warehouse) on AWS and promise a simple data download.  Which is not at all true. <br><br>  An excerpt from the documentation on which <a href="https://docs.aws.amazon.com/redshift/latest/dg/c_Supported_data_types.html">types of</a> Amazon Redshift <a href="https://docs.aws.amazon.com/redshift/latest/dg/c_Supported_data_types.html">supports</a> .  A rather meager set and if you need something for storing and processing data that is not listed here, it will be quite difficult for you to work.  For example GUID. <br><br>  Question from the hall "A JSON?" <br><br>  - JSON can only be written as VARCHAR and there are several functions for working with JSON. <br>  Comment from the audience "In Postgres, there is normal JSON support." <br><br>  - Yes, it has support for this type of data and functions.  But <a href="https://docs.aws.amazon.com/redshift/latest/dg/c_redshift-and-postgres-sql.html">Redshift is based</a> on PostgreSQL 8.0.2.  There was a ParAccel project, if I‚Äôm not mistaken, this 2005 technology is a fork of the postgres to which a scheduler was added for distributed queries based on a massively parallel architecture.  5-6 years have passed and this project was licensed for the Amazon Web Servces platform and called Redshift.  Something has been removed from the original Postgres, a lot has been added.  Added that is connected with authentication / authorization in AWS, with roles, security in Amazon works fine.  But if you need, for example, to connect from Redshift to another database using Foreign Data Source, then you will not find this.  There are no functions for working with XML, functions for working with JSON once or twice. <br><br>  When developing an application, you try <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25B8%25D0%25BD%25D0%25B2%25D0%25B5%25D1%2580%25D1%2581%25D0%25B8%25D0%25B8_%25D0%25B7%25D0%25B0%25D0%25B2%25D0%25B8%25D1%2581%25D0%25B8%25D0%25BC%25D0%25BE%25D1%2581%25D1%2582%25D0%25B5%25D0%25B9">not to depend on specific implementations</a> and the application code depends only on abstractions.  These facades and abstractions can be created by yourself, but in this case there are many ready-made libraries - facades.  Which abstract code from specific implementations, from specific frameworks, it is clear that they can not support all the functionality, as a "common denominator" for technology.  It is better to develop software relying on abstractions to simplify testing. <br><br>  To emulate AWS, I‚Äôll mention two options.  The first is more honest and correct, but it works more slowly.  The second is dirty and fast.  I will tell you about the hack option - we try to create the entire infrastructure in one process - the tests and the cross-platform version work with Windows (where docker can not always earn you) will work faster. <br><br>  The first method is perfect if you are developing in linux / macos and you have a docker, it will be better to use <a href="https://github.com/localstack/localstack">atlassian localstack</a> .  It is convenient to use <a href="https://github.com/testcontainers/testcontainers-java">testcontainers</a> to integrate the localstack into the JVM. <br><br>  But the same thing that stopped me from using lockalstack in docker on the project was that development was under Windows and nobody vouch for the work of the alpha version of docker when this project started ... Also, they will not be able to install a virtual machine with linux and docker in any company that is serious to information security.  I'm not talking about working in a protected environment in investment banks and prohibiting almost all of the traffic firewalls there. <br><br>  Let's consider options how to emulate Simple storage S3.  This is not a regular Amazon file system, but rather a distributed object storage.  In which you place your data as a BLOB, without the possibility of modifying and supplementing the data.  There are similar full-fledged distributed repositories from other manufacturers.  For example, Ceph distributed object storage allows you to work with its functionality using the <a href="https://github.com/ceph/s3-tests">S3 REST protocol</a> and the existing client with minimal modification.  But this is quite a heavy solution for the development and testing of java applications. <br><br>  A faster and more suitable project is the java <a href="https://github.com/gaul/s3proxy">s3proxy</a> library.  It emulates the S3 REST protocol and translates it into the corresponding <a href="https://github.com/jclouds/jclouds">jcloud</a> API calls and allows you to use many implementations for real reading and storage of data.  It can broadcast calls to the Google App Engine API, Microsoft Azure API, but for tests it is more convenient to use jcloud transient in-memory storage.  You also need to configure the AWS S3 authentication protocol version and specify the key and secret values, also configure the endpoint - the port and interface on which this S3 Proxy will listen.  Accordingly, your code using the client's AWS SDK should connect in tests to the S3 AWS endpoint, and not the AWS region.  Again, remember that s3proxy does not support all the functions of the S3 API, but all of our usage scenarios are emulated perfectly!  Even Multipart upload for large files is supported by s3proxy. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a85/65d/9ce/a8565d9ceabaa944dfc993c88e00d738.png"></div><br><br>  Amazon Simple Queue Service is a queuing service.  There is a queuing service <a href="https://github.com/softwaremill/elasticmq">elasticmq</a> , which is written in scala and can be submitted to your application using Amazon SQS protocol.  I did not use it in the project, so I will give the initialization code, trusting information from its developers. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7eb/11d/adf/7eb11dadfac303746ecc755fccee6384.png"></div><br><br>  In the project, I went the other way and the code depends on the spring-jms abstractions JmsTemplate and JmsListener and in the project dependencies the JMS driver for SQS com.amazonaws is specified: amazon-sqs-java-messaging-lib.  This is the main application code. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/08d/3ca/64b/08d3ca64b9c7f355cc3661ce692768ae.png"></div><br><br>  In the tests, we connect the Artemis-jms-server as the embedded JMS server for the tests and in the test Spring context instead of the SQS connection factory we use the connection factory Artemis.  Artemis is the next version of Apache ActiveMQ a full-fledged, timely Message Oriented Middleware - not just a test solution.  Perhaps we will move on to its use in the future, not only in autotests.  Thus, using JMS abstraction in conjunction with Spring, we have simplified both the application code and the ability to easily test it.  You just need to add the org.springframework.boot dependencies: spring-boot-starter-artemis and org.apache.activemq: artemis-jms-server. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/245/a8f/d3c/245a8fd3c8cb56a4b6fa460018d48f94.png"></div><br><br>  In some tests, PostgreSQL can be emulated by replacing with <a href="https://github.com/h2database/h2database">H2Database</a> .  This will work if the tests are not acceptance tests and do not use specific PG functions.  At the same time, H2 can emulate a subset of the PostgreSQL protocol wire without support for data types and functions.  In our project, we use Foreing Data Wrapper, so this method does not work for us. <br><br>  You can run real PostgreSQL.  <a href="https://github.com/yandex-qatools/postgresql-embedded">postgresql-embedded</a> downloads the real distribution, more precisely the archive with binary files for the platform with which we run, unpacks it.  In linux on tempfs in RAM, in windows in% TEMP%, the postgresql server process starts, configures the server settings and database settings.  Due to the distribution features of builds, versions older than PG 11 do not work under Linux.  For myself, I made a <a href="https://github.com/igor-suhorukov/postgresql-runner">wrapper library</a> that allows you to get PostgreSQL binary assemblies not only from an HTTP server but also from a maven repository.  What can be very useful when working in isolated networks and building on a CI server without access to the Internet.  Another convenience in working with my wrapper is the CDI component annotations, which makes it easy to use the component in a Spring context, for example.  The implementation of the AutoClosable server interface appeared earlier than in the original project.  No need to remember to stop the server, it will stop when you close the Spring context automatically. <br><br>  At startup, you can create a database based on scripts, complementing Spring context with appropriate properties.  We are now creating a database schema using <a href="https://github.com/flyway/flyway">flyway</a> scripts for migrating the database schema, which are run every time the database is created in the tests. <br><br>  To test the data after running the tests, use the spring-test-dbunit library.  In the annotations to the test methods, we specify with what unloadings to compare the state of the database.  This eliminates the need to write code for working with dbunit, just add the listener libraries to the test code.  You can specify in which order the data is removed from the tables, after the test method is completed, if the database context is reused between tests.  In 2019, there is a more modern approach implemented in the <a href="https://github.com/database-rider/database-rider">database-rider</a> , which works with junit5.  You can see an example of use, for example, <a href="">here</a> . <br><br>  The hardest thing turned out to be to emulate Amazon Redshift.  There is a project <a href="https://github.com/opt-tech/redshift-fake-driver">redshift-fake-driver</a> project focused on emulating batch data loading to an analytic database from AWS.  The jdbc: postgresqlredshift protocol emulator implemented the commands COPY, UNLOAD, all other commands are delegated to the regular JDBC PostgreSQL driver. <br><br>  Therefore, the tests will not work the same as in Redshift update operation, which uses another table as a data source for updating (the syntax is different in Redshift and PostgreSQL 9+. Also noticed different interpretations of quoting lines in SQL commands between these databases. <br><br>  Due to the nature of the architecture of the real Redshift database, insertion, update, and deletion of data is rather slow and expensive in terms of I / O operations.  It is possible to insert data with acceptable performance only in large ‚Äúbatches‚Äù and the COPY command just allows you to load data from the S3 distributed file system.  This command in the database supports several data formats AVRO, CSV, JSON, Parquet, ORC and TXT.  A project emulator concentrates on CSV, TXT, JSON. <br><br>  So, in order to emulate Redshift in tests, you need to launch the PostgreSQL database as mentioned before and start S3 emulation of the repository, and when creating a connection to a postgres you just need to add redshift-fake-driver to the classpath and specify the driver class jp.ne.opt.redshiftfake.postgres. FakePostgresqlDriver.  After that, you can use the same flyway to migrate the database schema, and dbunit is already familiar to compare the data after running the tests. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/17e/d0b/20a/17ed0b20a1e7bb4f4205747122a22a70.png"></div><br><br>  I wonder how many readers use AWS and Redshift?  Write in the comments about your experience. <br><br>  Using only Open Source projects, the team was able to accelerate development in the AWS environment, save money from the project budget and not stop the team‚Äôs work when the AWS subnets are locked by Roskomnadzor. </div><p>Source: <a href="https://habr.com/ru/post/444472/">https://habr.com/ru/post/444472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../444462/index.html">Testing the Samsung Galaxy S10 - when will smartphones catch up with the cameras?</a></li>
<li><a href="../444464/index.html">Another way to shoot yourself a leg is using std :: thread</a></li>
<li><a href="../444466/index.html">Sorry, but all of your databases belong to Google. Google Presentation at Game Development Conference 2019, Stadia Project</a></li>
<li><a href="../444468/index.html">Nvidia's neural network turns simple sketches into beautiful landscapes</a></li>
<li><a href="../444470/index.html">20 habits of attention hygiene: how to use technology, but do not allow them to select their time and attention</a></li>
<li><a href="../444474/index.html">Construction of the Sakhalin - Kuril communication line. Excursion on the Segero - ship-laying layer</a></li>
<li><a href="../444476/index.html">Competition from RUSNANO: take an online course on modern microelectronics, then a practical tour with FPGA, get a prize</a></li>
<li><a href="../444480/index.html">How to reduce the weight of an element of aircraft design by a third</a></li>
<li><a href="../444482/index.html">What does memory expand in Ruby?</a></li>
<li><a href="../444486/index.html">The SIRIUS-19 project is a four-month imitation of an expedition to the moon in a ground complex in Moscow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>