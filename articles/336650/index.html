<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>In a section: the news aggregator on Android with backend. Monitoring and data visualization system (InfluxDB, Grafana)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚Üí Introduction (with links to all articles) 

 Complex systems (distributed / large / with complex logic / complex data system) - as a living organism...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>In a section: the news aggregator on Android with backend. Monitoring and data visualization system (InfluxDB, Grafana)</h1><div class="post__text post__text-html js-mediator-article">  ‚Üí <a href="https://habrahabr.ru/post/334510/">Introduction (with links to all articles)</a> <br><br>  Complex systems (distributed / large / with complex logic / complex data system) - as a living organism: mobile, changeable and independent.  All this requires constant monitoring by developers / administrators / DevOps engineers. <br><br>  I came to this conclusion when the system ‚Äúbent‚Äù several times during its development, server tuning and operation.  This prompted me to the idea that monitoring should be carried out not only at the stage of production operation, but also at the development stage. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Everything in order ... <br><a name="habracut"></a><br>  When I came to the conclusion about the need to monitor the project (at least the server part), I decided that the ideal option for this would be the following scheme: ‚Äúdata collector ‚Üí <a href="https://en.wikipedia.org/wiki/Time_series_database">TSDB</a> ‚Üí web client for displaying data‚Äù. <br><br><img src="https://habrastorage.org/web/da7/3d4/d4d/da73d4d4d5dd4812b10930570986f3ee.png" alt="image"><br><br><h3>  TSDB selection </h3><br>  At the moment, there are a lot of articles dedicated to configuring <a href="http://graphiteapp.org/">Graphite</a> as TSDB, but I chose a more modern and legacy-free solution based on <a href="https://www.influxdata.com/time-series-platform/influxdb/">InfluxDB</a> .  About InfluxDB has already been written on Habr√© in the <a href="https://habrahabr.ru/company/selectel/blog/245515/">blog of the company Selectel</a> .  I don‚Äôt want to copy someone else‚Äôs text, the only thing I can say is that some of the information is no longer true, but the basis is still true - the system is productive, flexible, accessible to work for different languages ‚Äã‚Äãand supports different protocols of other TSDB and agents.  Graphite, however, scared me away by the presence of several related demons written in Python (excessive complexity and additional components). <br><br><div class="spoiler">  <b class="spoiler_title">Puppet script to install and configure InfluxDB</b> <div class="spoiler_text"><pre><code class="hljs mel">class storyline_infra::influxdb () { include stdlib $params = lookup({<span class="hljs-string"><span class="hljs-string">"name"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"storyline_infra.influxdb"</span></span>, <span class="hljs-string"><span class="hljs-string">"merge"</span></span> =&gt; {<span class="hljs-string"><span class="hljs-string">"strategy"</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">"deep"</span></span>}}) $port_http = $params[<span class="hljs-string"><span class="hljs-string">'port_http'</span></span>] $port_rpc = $params[<span class="hljs-string"><span class="hljs-string">'port_rpc'</span></span>] $pid_file = $params[<span class="hljs-string"><span class="hljs-string">'pid_file'</span></span>] $init_script = $params[<span class="hljs-string"><span class="hljs-string">'init_script'</span></span>] $dir_data = $params[<span class="hljs-string"><span class="hljs-string">'dir_data'</span></span>] $dir_logs = $params[<span class="hljs-string"><span class="hljs-string">'dir_logs'</span></span>] $enabled_auth = $params[<span class="hljs-string"><span class="hljs-string">'enabled_auth'</span></span>] $enabled_startup = $params[<span class="hljs-string"><span class="hljs-string">'enabled_startup'</span></span>] $enabled_running = $params[<span class="hljs-string"><span class="hljs-string">'enabled_running'</span></span>] $version = $params[<span class="hljs-string"><span class="hljs-string">'version'</span></span>] $dist_name = $facts[<span class="hljs-string"><span class="hljs-string">'os'</span></span>][<span class="hljs-string"><span class="hljs-string">'name'</span></span>] user { <span class="hljs-string"><span class="hljs-string">'influxdb'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">"present"</span></span>, managehome =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> { <span class="hljs-string"><span class="hljs-string">"influxdb-mkdir"</span></span>: command =&gt; <span class="hljs-string"><span class="hljs-string">"/bin/mkdir -p /data/db &amp;&amp; /bin/mkdir -p /data/logs"</span></span>, cwd =&gt; <span class="hljs-string"><span class="hljs-string">"/"</span></span>, unless =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/test -d /data/db -a -d /data/logs'</span></span>, } -&gt; # working dir <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $dir_logs: ensure =&gt; <span class="hljs-string"><span class="hljs-string">"directory"</span></span>, recurse =&gt; <span class="hljs-string"><span class="hljs-string">"true"</span></span>, owner =&gt; <span class="hljs-string"><span class="hljs-string">"influxdb"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=&gt; <span class="hljs-string"><span class="hljs-string">"influxdb"</span></span>, require =&gt; Exec[<span class="hljs-string"><span class="hljs-string">'influxdb-mkdir'</span></span>], } <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $dir_data: ensure =&gt; <span class="hljs-string"><span class="hljs-string">"directory"</span></span>, recurse =&gt; <span class="hljs-string"><span class="hljs-string">"true"</span></span>, owner =&gt; <span class="hljs-string"><span class="hljs-string">"influxdb"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=&gt; <span class="hljs-string"><span class="hljs-string">"influxdb"</span></span>, require =&gt; Exec[<span class="hljs-string"><span class="hljs-string">'influxdb-mkdir'</span></span>], } # see by <span class="hljs-string"><span class="hljs-string">"gpg --verify keyfile"</span></span> apt::key { <span class="hljs-string"><span class="hljs-string">'influxdb-key'</span></span>: id =&gt; <span class="hljs-string"><span class="hljs-string">'05CE15085FC09D18E99EFB22684A14CF2582E0C5'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">source</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'https://repos.influxdata.com/influxdb.key'</span></span>, } -&gt; # echo <span class="hljs-string"><span class="hljs-string">"deb https://repos.influxdata.com/${DISTRIB_ID,,} ${DISTRIB_CODENAME} stable"</span></span> | sudo tee /etc/apt/sources.list.d/influxdb.list apt::<span class="hljs-keyword"><span class="hljs-keyword">source</span></span> { <span class="hljs-string"><span class="hljs-string">'influxdb-repo'</span></span>: comment =&gt; <span class="hljs-string"><span class="hljs-string">'influxdb repo'</span></span>, location =&gt; <span class="hljs-string"><span class="hljs-string">"https://repos.influxdata.com/${downcase($dist_name)}"</span></span>, release =&gt; <span class="hljs-string"><span class="hljs-string">"${facts['os']['distro']['codename']}"</span></span>, repos =&gt; <span class="hljs-string"><span class="hljs-string">'stable'</span></span>, include =&gt; { <span class="hljs-string"><span class="hljs-string">'deb'</span></span> =&gt; true, }, } -&gt; package { <span class="hljs-string"><span class="hljs-string">'influxdb'</span></span>: ensure =&gt; $version, } -&gt; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { <span class="hljs-string"><span class="hljs-string">"/etc/influxdb/influxdb.conf"</span></span>: replace =&gt; true, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/influxdb.epp'</span></span>), owner =&gt; <span class="hljs-string"><span class="hljs-string">"influxdb"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">group</span></span>=&gt; <span class="hljs-string"><span class="hljs-string">"influxdb"</span></span>, notify =&gt; Service[<span class="hljs-string"><span class="hljs-string">'influxdb'</span></span>], }-&gt; <span class="hljs-keyword"><span class="hljs-keyword">file</span></span> { $init_script: replace =&gt; true, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/influxdb_startup.epp'</span></span>), mode=&gt;<span class="hljs-string"><span class="hljs-string">"ug=rwx,o=r"</span></span>, notify =&gt; Service[<span class="hljs-string"><span class="hljs-string">'influxdb'</span></span>], }-&gt; service { <span class="hljs-string"><span class="hljs-string">'influxdb'</span></span>: ensure =&gt; $enabled_running, enable =&gt; $enabled_startup, start =&gt; <span class="hljs-string"><span class="hljs-string">"${init_script} start"</span></span>, stop =&gt; <span class="hljs-string"><span class="hljs-string">"${init_script} stop"</span></span>, status =&gt; <span class="hljs-string"><span class="hljs-string">"${init_script} status"</span></span>, restart =&gt; <span class="hljs-string"><span class="hljs-string">"${init_script} restart"</span></span>, hasrestart =&gt; true, hasstatus =&gt; true, } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> $enabled_startup != true { <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> { <span class="hljs-string"><span class="hljs-string">"disable_influxdb"</span></span>: command =&gt; <span class="hljs-string"><span class="hljs-string">"/bin/systemctl disable influxdb"</span></span>, cwd =&gt; <span class="hljs-string"><span class="hljs-string">"/"</span></span>, } } logrotate::rule { <span class="hljs-string"><span class="hljs-string">'influxdb'</span></span>: path =&gt; <span class="hljs-string"><span class="hljs-string">"${dir_logs}/*.log"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">rotate</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">10</span></span>, missingok =&gt; true, copytruncate =&gt; true, dateext =&gt; true, <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'10M'</span></span>, rotate_every =&gt; <span class="hljs-string"><span class="hljs-string">'day'</span></span>, } }</code> </pre> <br></div></div><br><h3>  <a href="https://grafana.com/">Grafana</a> </h3><br>  The choice of a web client to display data was made a long time ago (I saw it in action a long time ago and always wanted to use it in my project).  Here are some screenshots from my project: <br><br><img src="https://habrastorage.org/web/f2c/7dc/8bc/f2c7dc8bccda4a1399968cbb2d8d8bc3.png" alt="image"><br><br><img src="https://habrastorage.org/web/b8d/35e/1b3/b8d35e1b3eba432f886c999fb9953033.png" alt="image"><br><br><img src="https://habrastorage.org/web/58b/228/725/58b2287252e24502b18e4c79d517b7e0.png" alt="image"><br><br>  The features of grafana are: <br><br><ul><li>  Nice appearance </li><li>  Dynamic update of all data </li><li>  Visual designer </li><li>  Connecting a large number of data source types (Graphite, InfluxDB, Prometheus, Elasticsearch ...) </li><li>  Many ways to authenticate </li><li>  Ability to send Alert `s (Slack, PagerDuty, VictorOps, OpsGenie ...) </li><li>  A large number of <a href="https://grafana.com/plugins">plug-ins to extend the functionality</a> </li></ul><br>  And the link to <a href="https://grafana.com/dashboards">ready-made dashboards</a> is a wonderful opportunity to see how others form graphics and learn something for themselves (useful and / or beautiful).  I podcherpnul :) <br><br>  The client, bundled with InfluxDB itself - <a href="https://www.influxdata.com/time-series-platform/chronograf/">Chronograf</a> is not so good in terms of functionality yet. <br><br><div class="spoiler">  <b class="spoiler_title">Puppet script for installing and configuring Grafana</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">class storyline_infra::grafana () { include stdlib <span class="hljs-string"><span class="hljs-string">$p</span></span>arams = lookup({<span class="hljs-comment"><span class="hljs-comment">"name"</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">"storyline_infra.grafana"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"merge"</span></span> =&gt; {<span class="hljs-comment"><span class="hljs-comment">"strategy"</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">"deep"</span></span>}}) <span class="hljs-string"><span class="hljs-string">$p</span></span>ort = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'port'</span></span>] <span class="hljs-string"><span class="hljs-string">$p</span></span>id_file = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'pid_file'</span></span>] <span class="hljs-string"><span class="hljs-string">$i</span></span>nit_script = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'init_script'</span></span>] <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_data = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'dir_data'</span></span>] <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_logs = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'dir_logs'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_startup'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_running = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_running'</span></span>] <span class="hljs-string"><span class="hljs-string">$v</span></span>ersion = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'version'</span></span>] user { <span class="hljs-string"><span class="hljs-string">'grafana'</span></span>: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"present"</span></span>, managehome =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, } exec { <span class="hljs-comment"><span class="hljs-comment">"grafana-mkdir"</span></span>: command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/bin/mkdir -p /data/db &amp;&amp; /bin/mkdir -p /data/logs"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, unless =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/test -d /data/db -a -d /data/logs'</span></span>, } -&gt; # working dir file { <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_logs: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, recurse =&gt; <span class="hljs-comment"><span class="hljs-comment">"true"</span></span>, owner =&gt; <span class="hljs-comment"><span class="hljs-comment">"grafana"</span></span>, group=&gt; <span class="hljs-comment"><span class="hljs-comment">"grafana"</span></span>, require =&gt; <span class="hljs-type"><span class="hljs-type">Exec</span></span>[<span class="hljs-string"><span class="hljs-string">'grafana-mkdir'</span></span>], } file { <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_data: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, recurse =&gt; <span class="hljs-comment"><span class="hljs-comment">"true"</span></span>, owner =&gt; <span class="hljs-comment"><span class="hljs-comment">"grafana"</span></span>, group=&gt; <span class="hljs-comment"><span class="hljs-comment">"grafana"</span></span>, require =&gt; <span class="hljs-type"><span class="hljs-type">Exec</span></span>[<span class="hljs-string"><span class="hljs-string">'grafana-mkdir'</span></span>], } # see by <span class="hljs-comment"><span class="hljs-comment">"gpg --verify keyfile"</span></span> apt::key { <span class="hljs-string"><span class="hljs-string">'grafana-key'</span></span>: id =&gt; <span class="hljs-string"><span class="hljs-string">'418A7F2FB0E1E6E7EABF6FE8C2E73424D59097AB'</span></span>, source =&gt; <span class="hljs-string"><span class="hljs-string">'https://packagecloud.io/gpg.key'</span></span>, } -&gt; # deb https://packagecloud.io/grafana/stable/debian/ jessie main apt::source { <span class="hljs-string"><span class="hljs-string">'grafana-repo'</span></span>: comment =&gt; <span class="hljs-string"><span class="hljs-string">'grafana repo'</span></span>, location =&gt; <span class="hljs-comment"><span class="hljs-comment">"https://packagecloud.io/grafana/stable/debian/"</span></span>, release =&gt; <span class="hljs-comment"><span class="hljs-comment">"jessie"</span></span>, repos =&gt; <span class="hljs-string"><span class="hljs-string">'main'</span></span>, include =&gt; { <span class="hljs-string"><span class="hljs-string">'deb'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, }, } -&gt; package { <span class="hljs-string"><span class="hljs-string">'grafana'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'present'</span></span>, } file { <span class="hljs-string"><span class="hljs-string">'/etc/init.d/grafana-server'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">'absent'</span></span>, } -&gt; file { <span class="hljs-string"><span class="hljs-string">'/etc/grafana'</span></span>: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, } -&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/etc/grafana/grafana.ini"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/grafana.epp'</span></span>), owner =&gt; <span class="hljs-comment"><span class="hljs-comment">"grafana"</span></span>, group=&gt; <span class="hljs-comment"><span class="hljs-comment">"grafana"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'grafana'</span></span>], } -&gt; file { <span class="hljs-string"><span class="hljs-string">$i</span></span>nit_script: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/grafana_startup.epp'</span></span>), mode=&gt;<span class="hljs-comment"><span class="hljs-comment">"ug=rwx,o=r"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'grafana'</span></span>], }-&gt; service { <span class="hljs-string"><span class="hljs-string">'grafana'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_running, enable =&gt; <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup, start =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} start"</span></span>, stop =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} stop"</span></span>, status =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} status"</span></span>, restart =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} restart"</span></span>, hasrestart =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, hasstatus =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, } if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup != <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> { exec { <span class="hljs-comment"><span class="hljs-comment">"disable_grafana"</span></span>: command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/bin/systemctl disable grafana"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, } } }</code> </pre><br></div></div><br><h3>  About data collection </h3><br>  The main source for displaying data is time-series data from InfluxDB, and into it they come from 2 sources: the <a href="http://collectd.org/">collectd</a> daemon and the java-library " <a href="https://github.com/davidB/metrics-influxdb">com.github.davidb: metrics-influxdb</a> ". <br><br><h3>  Collectd </h3><br>  Collectd is a daemon written in C that can transfer data to its network analog, the protocol of which InfluxDB can emulate.  "Out of the box" it can collect a sufficiently large number of metrics in the server environment and in terms of services, the possibility of expansion is achieved through modules written in python or Java. <br><br>  The collectd function of collecting information about the operation of the server (physical and virtual) quite suits me, but the additional settings required for collecting data from third-party services (in my case Elsticsearch, MongoDB and Apache Storm) are quite non-trivial and not always fully functional (for example, Elsticsearch does not correctly collect information on the speed of a query when there are several shard on different replicas).  Most likely you should look in the direction of the native client InfluxDB - <a href="https://www.influxdata.com/time-series-platform/telegraf/">Telegraf</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Puppet script to install and configure Collectd</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk">class storyline_infra::collectd () { include stdlib <span class="hljs-string"><span class="hljs-string">$p</span></span>arams = lookup({<span class="hljs-comment"><span class="hljs-comment">"name"</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">"storyline_infra.collectd"</span></span>, <span class="hljs-comment"><span class="hljs-comment">"merge"</span></span> =&gt; {<span class="hljs-comment"><span class="hljs-comment">"strategy"</span></span> =&gt; <span class="hljs-comment"><span class="hljs-comment">"deep"</span></span>}}) <span class="hljs-string"><span class="hljs-string">$s</span></span>erver_port = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'server_port'</span></span>] <span class="hljs-string"><span class="hljs-string">$s</span></span>erver_address = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'server_address'</span></span>] <span class="hljs-string"><span class="hljs-string">$p</span></span>id_file = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'pid_file'</span></span>] <span class="hljs-string"><span class="hljs-string">$i</span></span>nit_script = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'init_script'</span></span>] <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_data = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'dir_data'</span></span>] <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_logs = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'dir_logs'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_startup'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_running = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_running'</span></span>] <span class="hljs-string"><span class="hljs-string">$v</span></span>ersion = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'version'</span></span>] # mongo db <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_mongodb = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_mongodb'</span></span>] <span class="hljs-string"><span class="hljs-string">$m</span></span>ongodb_user = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'mongodb_user'</span></span>] <span class="hljs-string"><span class="hljs-string">$m</span></span>ongodb_password = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'mongodb_password'</span></span>] # storm db <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_storm = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_storm'</span></span>] <span class="hljs-string"><span class="hljs-string">$s</span></span>torm_ui_url = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'storm_ui_url'</span></span>] # elasticsearch <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_elasticsearch = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'enabled_elasticsearch'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>lasticsearch_host = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'elasticsearch_host'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>lasticsearch_port = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'elasticsearch_port'</span></span>] <span class="hljs-string"><span class="hljs-string">$e</span></span>lasticsearch_cluster = <span class="hljs-string"><span class="hljs-string">$p</span></span>arams[<span class="hljs-string"><span class="hljs-string">'elasticsearch_cluster'</span></span>] exec { <span class="hljs-comment"><span class="hljs-comment">"collectd-mkdir"</span></span>: command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/bin/mkdir -p /data/db &amp;&amp; /bin/mkdir -p /data/logs"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, unless =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/test -d /data/db -a -d /data/logs'</span></span>, } -&gt; # working dir file { <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_logs: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, recurse =&gt; <span class="hljs-comment"><span class="hljs-comment">"true"</span></span>, require =&gt; <span class="hljs-type"><span class="hljs-type">Exec</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd-mkdir'</span></span>], } file { <span class="hljs-string"><span class="hljs-string">$d</span></span>ir_data: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, recurse =&gt; <span class="hljs-comment"><span class="hljs-comment">"true"</span></span>, require =&gt; <span class="hljs-type"><span class="hljs-type">Exec</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd-mkdir'</span></span>], } package { <span class="hljs-string"><span class="hljs-string">'collectd'</span></span>: # ensure =&gt; <span class="hljs-string"><span class="hljs-string">$v</span></span>ersion, ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"present"</span></span>, } -&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/etc/collectd/collectd.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd.epp'</span></span>), notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd'</span></span>], }-&gt; file { <span class="hljs-string"><span class="hljs-string">$i</span></span>nit_script: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_startup.epp'</span></span>), mode=&gt;<span class="hljs-comment"><span class="hljs-comment">"ug=rwx,o=r"</span></span>, notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd'</span></span>], }-&gt; service { <span class="hljs-string"><span class="hljs-string">'collectd'</span></span>: ensure =&gt; <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_running, enable =&gt; <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup, start =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} start"</span></span>, stop =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} stop"</span></span>, status =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} status"</span></span>, restart =&gt; <span class="hljs-comment"><span class="hljs-comment">"${init_script} restart"</span></span>, hasrestart =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, hasstatus =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, } if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_startup != <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> { exec { <span class="hljs-comment"><span class="hljs-comment">"disable_collectd"</span></span>: command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/bin/systemctl disable collectd &amp; /bin/systemctl disable collectd.service"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, } } if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_mongodb { package { <span class="hljs-string"><span class="hljs-string">'python-pip'</span></span>: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"present"</span></span>, } -&gt; exec { <span class="hljs-comment"><span class="hljs-comment">"install-pymongo"</span></span>: command =&gt; <span class="hljs-comment"><span class="hljs-comment">"/usr/bin/python -m pip install pymongo"</span></span>, cwd =&gt; <span class="hljs-comment"><span class="hljs-comment">"/"</span></span>, unless =&gt; <span class="hljs-string"><span class="hljs-string">'/usr/bin/python -m pip show pymongo'</span></span>, } -&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/usr/share/collectd/mongodb"</span></span>: ensure =&gt; <span class="hljs-comment"><span class="hljs-comment">"directory"</span></span>, }-&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/usr/share/collectd/mongodb.py"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_mongodb_py.epp'</span></span>), }-&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/usr/share/collectd/mongodb/types.db"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_mongodb_types_db.epp'</span></span>), }-&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/etc/collectd/collectd.conf.d/mongodb.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_mongodb_conf.epp'</span></span>), notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd'</span></span>], } } # if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_mongodb { # https://github.com/srotya/storm-collectd if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_storm { file { <span class="hljs-comment"><span class="hljs-comment">"/usr/share/collectd/java/storm-collectd.jar"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, ensure =&gt; file, source =&gt; <span class="hljs-comment"><span class="hljs-comment">"puppet:///modules/storyline_infra/storm-collectd.jar"</span></span>, }-&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/etc/collectd/collectd.conf.d/storm.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_storm_conf.epp'</span></span>), notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd'</span></span>], } } # if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_mongodb { # https://github.com/signalfx/integrations/tree/master/collectd-elasticsearch # https://github.com/signalfx/collectd-elasticsearch if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_elasticsearch { file { <span class="hljs-comment"><span class="hljs-comment">"/usr/share/collectd/elasticsearch.py"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_elasticsearch_py.epp'</span></span>), }-&gt; file { <span class="hljs-comment"><span class="hljs-comment">"/etc/collectd/collectd.conf.d/elasticsearch.conf"</span></span>: replace =&gt; <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>, content =&gt; epp(<span class="hljs-string"><span class="hljs-string">'storyline_infra/collectd_elasticsearch_conf.epp'</span></span>), notify =&gt; <span class="hljs-type"><span class="hljs-type">Service</span></span>[<span class="hljs-string"><span class="hljs-string">'collectd'</span></span>], } } # if <span class="hljs-string"><span class="hljs-string">$e</span></span>nabled_mongodb { }</code> </pre><br></div></div><br><h3>  com.github.davidb: metrics-influxdb </h3><br>  This library is actually an adapter for the widely known <a href="http://metrics.dropwizard.io/">Metrics</a> java-library of metrics.  Supports protocol version 0.9 for InfluxDB and allows you to transfer the necessary information in full. <br><br>  Initialization is something like this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (metricsConfiguration.enabled) { String hostName = InetAddress.getLocalHost().getCanonicalHostName(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ScheduledReporter reporterInfluxDB = InfluxdbReporter.forRegistry(metricRegistry) .protocol(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpInfluxdbProtocol(<span class="hljs-string"><span class="hljs-string">"http"</span></span>, metricsConfiguration.influxdbHost, metricsConfiguration.influxdbPort, metricsConfiguration.influxdbUser, metricsConfiguration.influxdbPassword, metricsConfiguration.influxdbDB)) <span class="hljs-comment"><span class="hljs-comment">// rate + dim conversions .convertRatesTo(TimeUnit.SECONDS).convertDurationsTo(TimeUnit.MILLISECONDS) // filter .filter(MetricFilter.ALL) // don't skip .skipIdleMetrics(false) // hostname tag .tag("host", hostName) // !!! converter // al metrics must be of form: "processed_links.site_ru .crawling" -&gt; "crawling // source=site_ru, param=processed_links value=0.1" .transformer(new CategoriesMetricMeasurementTransformer("param", "source")) .build(); reporterInfluxDB.start(metricsConfiguration.reportingPeriod, TimeUnit.SECONDS); }</span></span></code> </pre><br>  In the future, use the usual Metrics API, which allows you to increase the transparency of what is being done in my software at any time. <br><br>  This system allowed not only to monitor the operation of the system in the operating mode, but also to track changes caused by the changes - how the memory consumption, processing speed, data volume, etc., increased.  Now, in principle, the page with the general dashboard is a bookmark on the kitchen laptop and the morning breakfast is always accompanied by events in the last 9 hours. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/336650/">https://habr.com/ru/post/336650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336640/index.html">UPS on lithium-ion batteries: understand the pros and cons of the example of Schneider Electric products</a></li>
<li><a href="../336642/index.html">Deep diving into Windows Server and Docker containers - Part 2 - Implementing Windows Server containers (translation)</a></li>
<li><a href="../336644/index.html">5 interesting ICO in September 2017: lead generation, online payments and search for restaurants</a></li>
<li><a href="../336646/index.html">User support, or emergency computer help. How it is done and how much it costs</a></li>
<li><a href="../336648/index.html">Applications for Tarantool. Part 2. OAuth2 authentication</a></li>
<li><a href="../336654/index.html">Cheat Sheet with Docker Teams</a></li>
<li><a href="../336656/index.html">Double bra * eyes programmer</a></li>
<li><a href="../336660/index.html">How to write when you do not know how lazy</a></li>
<li><a href="../336662/index.html">About Publish, Connect, RefCount and Share in RxSwift</a></li>
<li><a href="../336666/index.html">AngularJS Drag and Drop module. No jQueryUI</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>