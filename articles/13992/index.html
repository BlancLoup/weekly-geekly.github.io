<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL: analytics for DBA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many PostgreSQL DBMS users know that the server collects various statistics during its work, but not everyone knows that it is useful to analyze it an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL: analytics for DBA</h1><div class="post__text post__text-html js-mediator-article">  Many PostgreSQL DBMS users know that the server collects various statistics during its work, but not everyone knows that it is useful to analyze it and how to extract it for this.  This small toolkit contains several useful queries that give some insight into how to use this ‚Äúhidden knowledge‚Äù that is constantly accumulating.  These queries can be used to monitor the status of PostgreSQL (either manually or using plugins for monitoring systems like Nagios, Cacti or Zabbix), to look for bottlenecks in the server and many other similar tasks.  Remember that this is only the tip of the iceberg;  In the documentation, you can find descriptions of several dozens of system views, which may also be useful to the PostgreSQL administrator. <a name="habracut"></a><br><br>  For the toolkit to work correctly, you must enable the stats_block_level and stats_row_level options in postgresql.conf, and also configure the stats_reset_on_server_start parameter at your discretion.  If each time you restart the PostgreSQL server, you change some essential parameters of its configuration, it makes sense to reset the statistics in order to track the effect of the changes made.  If you are interested in a long-term perspective and the restart is not performed due to a PostgreSQL configuration change, set the stats_reset_on_server_start parameter to off. <br><br><h2>  Hit / read ratio </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When executing a request, PostgreSQL first looks to see if there is any data in the shared memory in the request (shared buffers).  If they are found, hit is counted; if not, a relatively slow fread system call is made to pick up data from the disk or from the operating system disk cache and read is counted.  On average, the rule is true: the greater the hit / read ratio, the better PostgreSQL is configured, since it reads very little from the disk, mainly extracting data from shared memory.  For most not very large bases, this ratio should lie between 5,000 and 10,000.  Do not strive, however, to artificially overstate the setting of shared_buffers, which directly defines hit / read: too large shared memory sizes lead to a loss of performance in databases with intensive writing.  It is also worth remembering that fread can be quite fast if the data is in the OS disk cache. <br><blockquote><pre>  SELECT 
       datname, 
       CASE 
         WHEN blks_read = 0 THEN 0 
         ELSE blks_hit / blks_read 
       END AS ratio 
     FROM 
       pg_stat_database;
</pre></blockquote><br><br><h2>  The number of modifications that occurred in the table </h2><br><br>  List by tables: how many entries have been added, changed and deleted since the last reset of statistics.  The DBA should represent which tables are the most loaded in the current database, as well as the ratio between the different types of modifying queries to them. <br><br><blockquote><pre>     SELECT 
       relname, 
       n_tup_ins, 
       n_tup_upd, 
       n_tup_del 
     FROM 
       pg_stat_user_tables 
     ORDER BY 
       n_tup_upd DESC;
</pre></blockquote><br><br><h2>  Seq scan / index scan statistics </h2><br><br>  List by tables: how many requests to them were made by sequential viewing;  how many queries were performed using indexes;  and the ratio of these two numbers.  Allows you to evaluate whether all the necessary indexes are created in this table.  If your tables contain more than several thousand rows, sequential browsing will be slower than the index scan, so ideally seqscans should not be in such tables.  If you still have them, analyze the queries for such tables and create the corresponding indexes.  At the same time, it is important not to overdo it: the more indices in the columns of the table, the more expensive the data update operations become. <br><br>  Also do not forget that after creating the index, the table needs to be done ANALYZE, otherwise the query planner will not notice changes in the table structure. <br><br><blockquote><pre>  SELECT 
       relname, 
       seq_scan, 
       idx_scan 
       CASE 
         WHEN idx_scan = 0 THEN 100 
         ELSE seq_scan / idx_scan 
       END AS ratio 
     FROM 
       pg_stat_user_tables 
     ORDER BY 
       ratio DESC;
</pre></blockquote><br><br><h2>  Index Statistics </h2><br><br>  List by index: how many records from the index were returned in queries on this index;  how many rows at the same time still had to be viewed in the parent table;  the ratio of these two numbers.  The essence of this statistic is simple: if you have a lot of fetch, it means the index is outdated and when executing a query, PostgreSQL is forced to look directly at the table as the source of the most relevant data, which slows down its work.  In this case, it is necessary to rebuild this index to match the real data in the table. <br><br><blockquote><pre>  SELECT 
       indexrelname, 
       idx_tup_read, 
       idx_tup_fetch, 
       CASE 
         WHEN idx_tup_fetch = 0 THEN 100 
         ELSE idx_tup_read / idx_tup_fetch 
       END AS ratio 
     FROM 
       pg_stat_user_indexes 
     ORDER BY 
       ratio DESC;
</pre></blockquote><br><br><h2>  Running queries with their duration </h2><br><br>  A simple list of currently executed server requests.  It is useful when you do not know the system well enough or simply did not have time to configure it - with its help you can find and interrupt a ‚Äúbad‚Äù request that interferes with the server‚Äôs work (the procpid column contains the PID of the process, which you can do kill if necessary).  Remember, however, that a simple periodic review of running queries will in no way replace the excellent pgFouine log analyzer.  Also, do not forget that the process in which you execute this query also falls into the resulting list. <br><br><blockquote><pre>  SELECT 
       datname, 
       NOW () - query_start AS duration, 
       procpid 
       current_query	
     FROM
       pg_stat_activity 
     ORDER BY duration duration DESC;
</pre></blockquote><br><br><h2>  List of current locks </h2><br><br>  A list of current locks with an indication of the type of lock, the table and database on which it is set, and the number of the transaction that set the lock.  Do not be afraid if the request gives a long list of lock-s - not all of them are critical and block the table from all possible changes and even readings.  To analyze the list of locks you should definitely get acquainted with the documentation about their types in PostgreSQL and about when and what requests they are exposed to.  One common case where a list of locks can be useful: by executing the command ps aux |  grep ^ postgres you see that waiting is written as one of the postgres processes, which means that the process is waiting for the blocking it needs to be released.  Which one - find out by running this query. <br><br><blockquote><pre>  SELECT 
       l.mode, 
       d.datname, 
       c.relname, 
       l.granted 
       l.transactionid 
     FROM 
       pg_locks AS l 
     LEFT JOIN pg_database AS d ON l.database = d.oid 
     LEFT JOIN pg_class AS c ON l.relation = c.oid;
</pre></blockquote></div><p>Source: <a href="https://habr.com/ru/post/13992/">https://habr.com/ru/post/13992/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139911/index.html">The basics of social network analysis (Social Network Analysis 101)</a></li>
<li><a href="../139914/index.html">Preparing a css sprite in Spritepad</a></li>
<li><a href="../139916/index.html">WebProject - a free program for creating and maintaining html-sites</a></li>
<li><a href="../139917/index.html">Finishing Gnome 3 under ArchLinux</a></li>
<li><a href="../139918/index.html">Russian translation of Apple presentation on March 7, 2012 - The new iPad</a></li>
<li><a href="../139922/index.html">Finishing the Ubuntu shell to Xfce</a></li>
<li><a href="../139925/index.html">Review of Kaspersky on Steve Jobs Bio</a></li>
<li><a href="../139926/index.html">We implement the protocol or how astrologers work</a></li>
<li><a href="../139927/index.html">Trafaret - library for checking and converting data</a></li>
<li><a href="../139929/index.html">Android - we filter pins on the map, depending on the distance from each other</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>