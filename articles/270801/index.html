<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Was there anyone on the server?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Tyapnitsa ... the thirteenth ... all important decided to leave on Monday, and therefore I will make some muck ... 
 In connection with the appearance...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Was there anyone on the server?</h1><div class="post__text post__text-html js-mediator-article">  Tyapnitsa ... the thirteenth ... all important decided to leave on Monday, and therefore I will make some muck ... <br>  In connection with the appearance of the <a href="http://www.itworld.com/article/2914650/linux/checking-last-logins-with-lastlog.html">article in the article,</a> I decided to balance this manual a little.  Hide your visit, of course, is not entirely trivial, but it does not make any special difficulties. <br>  So, the task: <br>  Log on to the server, perform certain actions and ‚Äúsweep‚Äù behind you. <br><br>  Hereinafter we consider that no additional tracking tools (except for the ‚Äúdefault‚Äù) are used in the system and we know the root password. <br><img align="right" width="50%" src="https://habrastorage.org/files/390/73c/459/39073c45922649a58baa934317068359.png"><br>  What we work with: <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># uname -ori FreeBSD 10.0-RELEASE GENERIC</span></span></code> </pre> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># `echo $SHELL` --version tcsh 6.18.01 (Astron)</span></span></code> </pre><br>  Described below is somewhat discordant with the article mentioned above, since  It is primarily oriented to Linux users, but the general principles are the same after the transition to FreeSD (c 9.0) for storing data in utmpx affinity became closer. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Go‚Ä¶ <br><a name="habracut"></a><br>  Visit data is stored in 3 files: <br><br>  Active users - /var/run/utx.active (replaced in 9.0 utmp) <br>  Recent Visits - /var/log/utx.lastlogin (replaced lastlog) <br>  Well, the full log is /var/log/utx.log (replaced by wtmp) <br><br>  And here we are: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># getent utmpx active getent utmpx active [1447261331.491910 -- Wed Nov 11 20:02:11 2015] system boot [1437293217.427108 -- Sun Jul 19 11:06:57 2015] user process: id="3a873cda545eff7f" pid="1288" user="root" line="ttyv1" host="" [1447311304.396008 -- Thu Nov 12 09:55:04 2015] user process: id="8084832f31000000" pid="4104" user="Alex" line="pts/1" host="10.3.1.15" [1447410352.840653 -- Fri Nov 13 13:25:52 2015] user process: id="8084832f30000000" pid="14281" user="Alex" line="pts/0" host="108.182.182.209" [1412600841.811588 -- Mon Oct 6 16:07:21 2014] user process: id="3962386266747064" pid="39819" user="swimmer" line="ftpd" host="10.34.1.23"</span></span></code> </pre><br>  We believe that the very entrance from which we want to get rid of: <br><pre> <code class="bash hljs">[1447410352.840653 -- Fri Nov 13 13:25:52 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"14281"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/0"</span></span> host=<span class="hljs-string"><span class="hljs-string">"108.182.182.209"</span></span></code> </pre><br><br>  Since  our current input is visible by <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># who who root ttyv1 Jul 19 11:06 Alex pts/1 Nov 12 09:55 (10.3.1.15) Alex pts/0 Nov 13 13:25 (108.182.182.209)</span></span></code> </pre><br>  Starting with it <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># utx rm 8084832f30000000 utx rm 8084832f30000000</span></span></code> </pre><br>  That's better <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># who who root ttyv1 Jul 19 11:06 Alex pts/1 Nov 12 09:55 (10.3.1.15)</span></span></code> </pre><br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta"># getent utmpx active getent utmpx active [1447261331.491910 -- Wed Nov 11 20:02:11 2015] system boot [1437293217.427108 -- Sun Jul 19 11:06:57 2015] user process: id="3a873cda545eff7f" pid="1288" user="root" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">="ttyv1" host="" [1447311304.396008 -- Thu Nov 12 09:55:04 2015] user process: id="8084832f31000000" pid="4104" user="Alex" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">="pts/1" host="10.3.1.15" [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id="8084832f30000000" pid="0" [1412600841.811588 -- Mon Oct 6 16:07:21 2014] user process: id="3962386266747064" pid="39819" user="swimmer" </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">line</span></span></span><span class="hljs-meta">="ftpd" host="10.34.1.23"</span></span></code> </pre><br><br>  It should be noted that this decision to delete the active session was not ideal and a small trace of it remained: <br><pre> <code class="bash hljs">[1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"0"</span></span></code> </pre><br>  How to delete the "right" consider below. <br><br>  Dirty, we decide to leave the system <br>  What is left in the logs <br><div class="spoiler">  <b class="spoiler_title">getent</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># getent utmpx lastlogin getent utmpx lastlogin [1437293217.427108 -- Sun Jul 19 11:06:57 2015] user process: id="3a873cda545eff7f" pid="1288" user="root" line="ttyv1" host="" [1447410352.840653 -- Fri Nov 13 13:25:52 2015] user process: id="8084832f30000000" pid="14281" user="Alex" line="pts/0" host="108.182.182.209" [1412600841.811588 -- Mon Oct 6 16:07:21 2014] user process: id="3962386266747064" pid="39819" user="swimmer" line="ftpd" host="10.34.1.23"</span></span></code> </pre><br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># getent utmpx log getent utmpx log [1446494176.682516 -- Mon Nov 2 22:56:16 2015] user process: id="8084832f32000000" pid="72946" user="Alex" line="pts/2" host="108.182.182.209" [1446498691.474026 -- Tue Nov 3 00:11:31 2015] dead process: id="8084832f31000000" pid="61263" [1446614492.857275 -- Wed Nov 4 08:21:32 2015] user process: id="8084832f31000000" pid="79491" user="Alex" line="pts/1" host="30.205.96.92" [1446614507.736041 -- Wed Nov 4 08:21:47 2015] dead process: id="8084832f31000000" pid="79491" [1446698146.439426 -- Thu Nov 5 07:35:46 2015] user process: id="8084832f31000000" pid="83858" user="Alex" line="pts/1" host="30.205.116.124" [1446706228.892627 -- Thu Nov 5 09:50:28 2015] dead process: id="8084832f31000000" pid="83858" [1446710834.014993 -- Thu Nov 5 11:07:14 2015] system shutdown [1446710906.311914 -- Thu Nov 5 11:08:26 2015] system boot [1446710938.817058 -- Thu Nov 5 11:08:58 2015] user process: id="8084832f30000000" pid="1313" user="Alex" line="pts/0" host="10.3.1.15" [1446721174.063221 -- Thu Nov 5 13:59:34 2015] user process: id="8084832f31000000" pid="1789" user="Alex" line="pts/1" host="108.182.182.209" [1446815955.085182 -- Fri Nov 6 16:19:15 2015] dead process: id="8084832f30000000" pid="1313" [1446906334.551710 -- Sat Nov 7 17:25:34 2015] user process: id="8084832f30000000" pid="11580" user="Alex" line="pts/0" host="108.182.182.209" [1446912588.809728 -- Sat Nov 7 19:09:48 2015] dead process: id="8084832f31000000" pid="1789" [1447045707.708080 -- Mon Nov 9 08:08:27 2015] user process: id="8084832f31000000" pid="19008" user="Alex" line="pts/1" host="mm-21-205-84-93.dynamic.pppoe.mgts.ru" [1447045911.315244 -- Mon Nov 9 08:11:51 2015] dead process: id="8084832f31000000" pid="19008" [1447052181.641530 -- Mon Nov 9 09:56:21 2015] user process: id="8084832f31000000" pid="19314" user="Alex" line="pts/1" host="10.3.1.15" [1447131335.768107 -- Tue Nov 10 07:55:35 2015] user process: id="8084832f33000000" pid="23441" user="Alex" line="pts/3" host="30.205.98.54" [1447133646.400779 -- Tue Nov 10 08:34:06 2015] dead process: id="8084832f33000000" pid="23441" [1447261331.491910 -- Wed Nov 11 20:02:11 2015] system boot [1447263839.850262 -- Wed Nov 11 20:43:59 2015] user process: id="8084832f30000000" pid="1422" user="Alex" line="pts/0" host="10.3.1.15" [1447267906.123055 -- Wed Nov 11 21:51:46 2015] user process: id="8084832f31000000" pid="1644" user="Alex" line="pts/1" host="10.3.1.15" [1447271644.777315 -- Wed Nov 11 22:54:04 2015] dead process: id="8084832f30000000" pid="1422" [1447275711.000315 -- Thu Nov 12 00:01:51 2015] dead process: id="8084832f31000000" pid="1644" [1447303224.172811 -- Thu Nov 12 07:40:24 2015] user process: id="8084832f30000000" pid="3685" user="Alex" line="pts/0" host="30.205.135.101" [1447305113.718172 -- Thu Nov 12 08:11:53 2015] dead process: id="8084832f30000000" pid="3685" [1447309547.097136 -- Thu Nov 12 09:25:47 2015] user process: id="8084832f30000000" pid="4018" user="Alex" line="pts/0" host="108.182.182.209" [1447311304.396008 -- Thu Nov 12 09:55:04 2015] user process: id="8084832f31000000" pid="4104" user="Alex" line="pts/1" host="10.3.1.15" [1447316907.634554 -- Thu Nov 12 11:28:27 2015] user process: id="8084832f32000000" pid="4373" user="Alex" line="pts/2" host="108.182.182.209" [1447322795.387121 -- Thu Nov 12 13:06:35 2015] dead process: id="8084832f30000000" pid="4018" [1447410352.840653 -- Fri Nov 13 13:25:52 2015] user process: id="8084832f30000000" pid="14281" user="Alex" line="pts/0" host="108.182.182.209" [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id="8084832f30000000" pid="0"</span></span></code> </pre><br></div></div><br><br>  All this data is stored in binary form in utmpx structures.  Thus, to delete information about the visit, you must: <br>  - either delete the log files themselves; <br>  - either score them with zeros in the hex editor; <br>  - or edit the binary log by deleting the record of our visit from it; <br>  The first two methods, of course, will delete the data on the visit, but will let the attentive admin understand that the matter is unclean.  Well let's go the most difficult way. <br>  The utmpx structure represents <br><br><pre> <code class="cpp hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">utmpx</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> ut_type; <span class="hljs-comment"><span class="hljs-comment">/* Type of entry. */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">timeval</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ut_tv</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-comment"><span class="hljs-comment">/* Time entry was made. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ut_id[]; <span class="hljs-comment"><span class="hljs-comment">/* Record identifier. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pid_t</span></span> ut_pid; <span class="hljs-comment"><span class="hljs-comment">/* Process ID. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ut_user[]; <span class="hljs-comment"><span class="hljs-comment">/* User login name. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ut_line[]; <span class="hljs-comment"><span class="hljs-comment">/* Device name. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> ut_host[]; <span class="hljs-comment"><span class="hljs-comment">/* Remote hostname. */</span></span> };</code> </pre><br>  When working with accounting databases, this structure operates with endutxent, getutxent, getutxid, getutxline, getutxuser, pututxline, setutxdb, setutxent. <br>  We are interested in two functions: <br>  getutxent - get data from the database as utmpx <br>  pututxline - makes an entry to the database <br><br>  Let's run through the database, count all the data and create a new copy of the database, excluding our visits from it? <br><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((ut = getutxent()) != <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>) { utmpxprint(ut); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(ut-&gt;ut_pid != <span class="hljs-number"><span class="hljs-number">14281</span></span>) pututxline(ut); }</code> </pre><br>  And here we expect a large OPS: <br><div class="spoiler">  <b class="spoiler_title">Oops</b> <div class="spoiler_text"><pre> <code class="bash hljs">[1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f32000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"72946"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"108.182.182.209"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"61263"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"79491"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"30.205.96.92"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"79491"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"83858"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"30.205.116.124"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"83858"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] system shutdown [1447410438.824887 -- Fri Nov 13 13:27:18 2015] system boot [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1313"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/0"</span></span> host=<span class="hljs-string"><span class="hljs-string">"10.3.1.15"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1789"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"108.182.182.209"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1313"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"11580"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/0"</span></span> host=<span class="hljs-string"><span class="hljs-string">"108.182.182.209"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1789"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"19008"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"mm-21-205-84-93.dynamic.pppoe.mgts.ru"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"19008"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"19314"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"10.3.1.15"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f33000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"23441"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/3"</span></span> host=<span class="hljs-string"><span class="hljs-string">"30.205.98.54"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f33000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"23441"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] system boot [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1422"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/0"</span></span> host=<span class="hljs-string"><span class="hljs-string">"10.3.1.15"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1644"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"10.3.1.15"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1422"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"1644"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"3685"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/0"</span></span> host=<span class="hljs-string"><span class="hljs-string">"30.205.135.101"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"3685"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"4018"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/0"</span></span> host=<span class="hljs-string"><span class="hljs-string">"108.182.182.209"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f31000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"4104"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/1"</span></span> host=<span class="hljs-string"><span class="hljs-string">"10.3.1.15"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] user process: id=<span class="hljs-string"><span class="hljs-string">"8084832f32000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"4373"</span></span> user=<span class="hljs-string"><span class="hljs-string">"Alex"</span></span> line=<span class="hljs-string"><span class="hljs-string">"pts/2"</span></span> host=<span class="hljs-string"><span class="hljs-string">"108.182.182.209"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"4018"</span></span> [1447410438.824887 -- Fri Nov 13 13:27:18 2015] dead process: id=<span class="hljs-string"><span class="hljs-string">"8084832f30000000"</span></span> pid=<span class="hljs-string"><span class="hljs-string">"0"</span></span></code> </pre><br></div></div><br>  The record 14281 disappeared, but all the records were added to the target database with the current system time! <br>  Why is this happening? <br><br>  Go to the source pututxline.c <br>  and see: <br><pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-function">struct utmpx * </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">pututxline</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> struct utmpx *utmpx)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">futx</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fu</span></span></span><span class="hljs-class">;</span></span> ... utx_to_futx(utmpx, &amp;fu); ... bad |= utx_log_add(&amp;fu); ... }</code> </pre>  those.  Before recording, our utmpx structure is transformed into some kind of futx (why it is not clear, because the structure is no different, I suspect that the ‚Äúmemory‚Äù of past formats) <br>  The most interesting thing happens when converting a time parameter <br>  <i>utmpx ut_tv</i> in <i>futx fu_tv</i> <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UTOF_TV(fu) do { \ struct timeval tv; \ gettimeofday(&amp;tv, NULL); \ (fu)-&gt;fu_tv = htobe64((uint64_t)tv.tv_sec * 1000000 + \ (uint64_t)tv.tv_usec); \ } while (0)</span></span></code> </pre><br><br>  <i>gettimeofday (&amp; tv, NULL);</i>  - WHY!? If I pass as an argument the structure already filled with time? <br>  We lead to the proper form: <br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> UTOF_TV(ut, fu) do { \ (fu)-&gt;fu_tv = htobe64((uint64_t)(ut)-&gt;ut_tv.tv_sec * 1000000 + \ (uint64_t)(ut)-&gt;ut_tv.tv_usec); \ } while (0)</span></span></code> </pre><br>  Listings of what happened below: <br><div class="spoiler">  <b class="spoiler_title">getent.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/cdefs.h&gt; __FBSDID("$FreeBSD: getent editor v 0.0.a $"); #include &lt;sys/socket.h&gt; #include &lt;sys/param.h&gt; #include &lt;arpa/inet.h&gt; #include &lt;arpa/nameser.h&gt; #include &lt;net/if.h&gt; #include &lt;netinet/if_ether.h&gt; #include &lt;netinet/in.h&gt; /* for INET6_ADDRSTRLEN */ #include &lt;rpc/rpcent.h&gt; #include &lt;assert.h&gt; #include &lt;ctype.h&gt; #include &lt;errno.h&gt; #include &lt;grp.h&gt; #include &lt;limits.h&gt; #include &lt;netdb.h&gt; #include &lt;pwd.h&gt; #include &lt;stdarg.h&gt; #include &lt;stdint.h&gt; #include &lt;stdio.h&gt; #include &lt;stdlib.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include "utmpx.h" #include "pututxline.c" static int usage(void); static int parsenum(const char *, unsigned long *); static int utmpx(int, char *[]); enum { RV_OK = 0, RV_USAGE = 1, RV_NOTFOUND = 2, RV_NOENUM = 3 }; static struct getentdb { const char *name; int (*callback)(int, char *[]); } databases[] = { { "utmpx", utmpx, }, { NULL, NULL, }, }; int main(int argc, char *argv[]) { struct getentdb *curdb; setprogname(argv[0]); if (argc &lt; 2) usage(); for (curdb = databases; curdb-&gt;name != NULL; curdb++) { if (strcmp(curdb-&gt;name, argv[1]) == 0) { exit(curdb-&gt;callback(argc, argv)); } } fprintf(stderr, "Unknown database: %s\n", argv[1]); usage(); /* NOTREACHED */ return RV_USAGE; } static int usage(void) { struct getentdb *curdb; fprintf(stderr, "Usage: %s database [key ...]\n", getprogname()); fprintf(stderr, " database may be one of:\n\t"); for (curdb = databases; curdb-&gt;name != NULL; curdb++) { fprintf(stderr, " %s", curdb-&gt;name); } fprintf(stderr, "\n"); exit(RV_USAGE); /* NOTREACHED */ } /* * printfmtstrings -- * vprintf(format, ...), * then the aliases (beginning with prefix, separated by sep), * then a newline */ static void printfmtstrings(char *strings[], const char *prefix, const char *sep, const char *fmt, ...) { va_list ap; const char *curpref; int i; va_start(ap, fmt); vprintf(fmt, ap); curpref = prefix; for (i = 0; strings[i] != NULL; i++) { printf("%s%s", curpref, strings[i]); curpref = sep; } printf("\n"); va_end(ap); } /* * utmpx */ #define UTMPXPRINTID do { \ size_t i; \ for (i = 0; i &lt; sizeof ut-&gt;ut_id; i++) \ printf("%02hhx", ut-&gt;ut_id[i]); \ } while (0) static void utmpxprint(const struct utmpx *ut) { if (ut-&gt;ut_type == EMPTY) return; printf("[%jd.%06u -- %.24s] ", (intmax_t)ut-&gt;ut_tv.tv_sec, (unsigned int)ut-&gt;ut_tv.tv_usec, ctime(&amp;ut-&gt;ut_tv.tv_sec)); switch (ut-&gt;ut_type) { case BOOT_TIME: printf("system boot\n"); return; case SHUTDOWN_TIME: printf("system shutdown\n"); return; case OLD_TIME: printf("old system time\n"); return; case NEW_TIME: printf("new system time\n"); return; case USER_PROCESS: printf("user process: id=\""); UTMPXPRINTID; printf("\" pid=\"%d\" user=\"%s\" line=\"%s\" host=\"%s\"\n", ut-&gt;ut_pid, ut-&gt;ut_user, ut-&gt;ut_line, ut-&gt;ut_host); break; case INIT_PROCESS: printf("init process: id=\""); UTMPXPRINTID; printf("\" pid=\"%d\"\n", ut-&gt;ut_pid); break; case LOGIN_PROCESS: printf("login process: id=\""); UTMPXPRINTID; printf("\" pid=\"%d\" user=\"%s\" line=\"%s\" host=\"%s\"\n", ut-&gt;ut_pid, ut-&gt;ut_user, ut-&gt;ut_line, ut-&gt;ut_host); break; case DEAD_PROCESS: printf("dead process: id=\""); UTMPXPRINTID; printf("\" pid=\"%d\"\n", ut-&gt;ut_pid); break; default: printf("unknown record type %hu\n", ut-&gt;ut_type); break; } } static int utmpx(int argc, char *argv[]) { //const struct utmpx *ut; struct utmpx *ut; const char *file = NULL; int rv = RV_OK, db = 0; assert(argc &gt; 1); assert(argv != NULL); if (argc == 3 || argc == 4 || argc == 5) { if (strcmp(argv[2], "active") == 0) db = UTXDB_ACTIVE; else if (strcmp(argv[2], "lastlogin") == 0) db = UTXDB_LASTLOGIN; else if (strcmp(argv[2], "log") == 0) db = UTXDB_LOG; else rv = RV_USAGE; if (argc == 4 || argc == 5) file = argv[3]; } else { rv = RV_USAGE; } if (rv == RV_USAGE) { fprintf(stderr, "Usage: %s utmpx active | lastlogin | log [filename]\n", getprogname()); } else if (rv == RV_OK) { if (setutxdb(db, file) != 0) return (RV_NOTFOUND); int ires = 0; printf("UTXDB_LOG result: [%d]\n", ires); if(argc == 5) { while ((ut = getutxent()) != NULL) { utmpxprint(ut); //if(strcmp(ut-&gt;ut_host, "10.34.1.155") != 0) //if(ut-&gt;ut_pid != 4373) if(ut-&gt;ut_pid != atoi(argv[4])) { pututxline(ut); } } } else puts("ut_pid(argv[4]) needed!.."); endutxent(); } return (rv); }</span></span></span></span></code> </pre></div></div><div class="spoiler">  <b class="spoiler_title">pututxline.c</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;sys/cdefs.h&gt; __FBSDID("$FreeBSD: pututxline.cv 0.0.a $"); #include &lt;sys/endian.h&gt; #include &lt;sys/stat.h&gt; #include &lt;sys/uio.h&gt; #include &lt;errno.h&gt; #include &lt;fcntl.h&gt; #include &lt;stdio.h&gt; #include &lt;string.h&gt; #include &lt;unistd.h&gt; #include &lt;utmpx.h&gt; #include "/usr/src/lib/libc/include/namespace.h" #include "/usr/src/lib/libc/gen/utxdb.h" #include "/usr/src/lib/libc/include/un-namespace.h" //----------------------------------------------------------------------------- #include &lt;sys/param.h&gt; #include &lt;sys/time.h&gt; #include &lt;stdlib.h&gt; //----------------------------------------------------------------------------- #define UTOF_STRING(ut, fu, field) do { \ strncpy((fu)-&gt;fu_ ## field, (ut)-&gt;ut_ ## field, \ MIN(sizeof (fu)-&gt;fu_ ## field, sizeof (ut)-&gt;ut_ ## field)); \ } while (0) #define UTOF_ID(ut, fu) do { \ memcpy((fu)-&gt;fu_id, (ut)-&gt;ut_id, \ MIN(sizeof (fu)-&gt;fu_id, sizeof (ut)-&gt;ut_id)); \ } while (0) #define UTOF_PID(ut, fu) do { \ (fu)-&gt;fu_pid = htobe32((ut)-&gt;ut_pid); \ } while (0) #define UTOF_TYPE(ut, fu) do { \ (fu)-&gt;fu_type = (ut)-&gt;ut_type; \ } while (0) #define UTOF_TV(ut, fu) do { \ (fu)-&gt;fu_tv = htobe64((uint64_t)(ut)-&gt;ut_tv.tv_sec * 1000000 + \ (uint64_t)(ut)-&gt;ut_tv.tv_usec); \ } while (0) //----------------------------------------------------------------------------- void utx_to_futx(const struct utmpx *ut, struct futx *fu) { memset(fu, 0, sizeof *fu); switch (ut-&gt;ut_type) { case BOOT_TIME: case OLD_TIME: case NEW_TIME: /* Extension: shutdown time. */ case SHUTDOWN_TIME: break; case USER_PROCESS: UTOF_ID(ut, fu); UTOF_STRING(ut, fu, user); UTOF_STRING(ut, fu, line); /* Extension: host name. */ UTOF_STRING(ut, fu, host); UTOF_PID(ut, fu); break; case INIT_PROCESS: UTOF_ID(ut, fu); UTOF_PID(ut, fu); break; case LOGIN_PROCESS: UTOF_ID(ut, fu); UTOF_STRING(ut, fu, user); UTOF_STRING(ut, fu, line); UTOF_PID(ut, fu); break; case DEAD_PROCESS: UTOF_ID(ut, fu); UTOF_PID(ut, fu); break; default: fu-&gt;fu_type = EMPTY; return; } UTOF_TYPE(ut, fu); UTOF_TV(ut, fu); //UTOF_TV(ut, fu); } //----------------------------------------------------------------------------- #define FTOU_STRING(fu, ut, field) do { \ strncpy((ut)-&gt;ut_ ## field, (fu)-&gt;fu_ ## field, \ MIN(sizeof (ut)-&gt;ut_ ## field - 1, sizeof (fu)-&gt;fu_ ## field)); \ } while (0) #define FTOU_ID(fu, ut) do { \ memcpy((ut)-&gt;ut_id, (fu)-&gt;fu_id, \ MIN(sizeof (ut)-&gt;ut_id, sizeof (fu)-&gt;fu_id)); \ } while (0) #define FTOU_PID(fu, ut) do { \ (ut)-&gt;ut_pid = be32toh((fu)-&gt;fu_pid); \ } while (0) #define FTOU_TYPE(fu, ut) do { \ (ut)-&gt;ut_type = (fu)-&gt;fu_type; \ } while (0) #define FTOU_TV(fu, ut) do { \ uint64_t t; \ t = be64toh((fu)-&gt;fu_tv); \ (ut)-&gt;ut_tv.tv_sec = t / 1000000; \ (ut)-&gt;ut_tv.tv_usec = t % 1000000; \ } while (0) //----------------------------------------------------------------------------- struct utmpx * futx_to_utx(const struct futx *fu) { #ifdef __NO_TLS static struct utmpx *ut; #else static _Thread_local struct utmpx *ut; #endif if (ut == NULL) { ut = calloc(1, sizeof *ut); if (ut == NULL) return (NULL); } else memset(ut, 0, sizeof *ut); switch (fu-&gt;fu_type) { case BOOT_TIME: case OLD_TIME: case NEW_TIME: /* Extension: shutdown time. */ case SHUTDOWN_TIME: break; case USER_PROCESS: FTOU_ID(fu, ut); FTOU_STRING(fu, ut, user); FTOU_STRING(fu, ut, line); /* Extension: host name. */ FTOU_STRING(fu, ut, host); FTOU_PID(fu, ut); break; case INIT_PROCESS: FTOU_ID(fu, ut); FTOU_PID(fu, ut); break; case LOGIN_PROCESS: FTOU_ID(fu, ut); FTOU_STRING(fu, ut, user); FTOU_STRING(fu, ut, line); FTOU_PID(fu, ut); break; case DEAD_PROCESS: FTOU_ID(fu, ut); FTOU_PID(fu, ut); break; default: ut-&gt;ut_type = EMPTY; return (ut); } FTOU_TYPE(fu, ut); FTOU_TV(fu, ut); return (ut); } //----------------------------------------------------------------------------- static FILE * futx_open(const char *file) { FILE *fp; struct stat sb; int fd; fd = open(file, O_CREAT|O_RDWR|O_EXLOCK|O_CLOEXEC, 0644); if (fd &lt; 0) return (NULL); /* Safety check: never use broken files. */ if (fstat(fd, &amp;sb) != -1 &amp;&amp; sb.st_size % sizeof(struct futx) != 0) { close(fd); errno = EFTYPE; return (NULL); } fp = fdopen(fd, "r+"); if (fp == NULL) { close(fd); return (NULL); } return (fp); } static int utx_active_add(const struct futx *fu) { FILE *fp; struct futx fe; off_t partial; int error, ret; partial = -1; ret = 0; /* * Register user login sessions. Overwrite entries of sessions * that have already been terminated. */ fp = futx_open(_PATH_UTX_ACTIVE); if (fp == NULL) return (-1); while (fread(&amp;fe, sizeof(fe), 1, fp) == 1) { switch (fe.fu_type) { case BOOT_TIME: /* Leave these intact. */ break; case USER_PROCESS: case INIT_PROCESS: case LOGIN_PROCESS: case DEAD_PROCESS: /* Overwrite when ut_id matches. */ if (memcmp(fu-&gt;fu_id, fe.fu_id, sizeof(fe.fu_id)) == 0) { ret = fseeko(fp, -(off_t)sizeof(fe), SEEK_CUR); goto exact; } if (fe.fu_type != DEAD_PROCESS) break; /* FALLTHROUGH */ default: /* Allow us to overwrite unused records. */ if (partial == -1) { partial = ftello(fp); /* * Distinguish errors from valid values so we * don't overwrite good data by accident. */ if (partial != -1) partial -= (off_t)sizeof(fe); } break; } } /* * No exact match found. Use the partial match. If no partial * match was found, just append a new record. */ if (partial != -1) ret = fseeko(fp, partial, SEEK_SET); exact: if (ret == -1) error = errno; else if (fwrite(fu, sizeof(*fu), 1, fp) &lt; 1) error = errno; else error = 0; fclose(fp); if (error != 0) errno = error; return (error == 0 ? 0 : 1); } static int utx_active_remove(struct futx *fu) { FILE *fp; struct futx fe; int error, ret; /* * Remove user login sessions, having the same ut_id. */ fp = futx_open(_PATH_UTX_ACTIVE); if (fp == NULL) return (-1); error = ESRCH; ret = -1; while (fread(&amp;fe, sizeof(fe), 1, fp) == 1 &amp;&amp; ret != 0) switch (fe.fu_type) { case USER_PROCESS: case INIT_PROCESS: case LOGIN_PROCESS: if (memcmp(fu-&gt;fu_id, fe.fu_id, sizeof(fe.fu_id)) != 0) continue; /* Terminate session. */ if (fseeko(fp, -(off_t)sizeof(fe), SEEK_CUR) == -1) error = errno; else if (fwrite(fu, sizeof(*fu), 1, fp) &lt; 1) error = errno; else ret = 0; } fclose(fp); if (ret != 0) errno = error; return (ret); } static void utx_active_init(const struct futx *fu) { int fd; /* Initialize utx.active with a single BOOT_TIME record. */ fd = open(_PATH_UTX_ACTIVE, O_CREAT|O_RDWR|O_TRUNC, 0644); if (fd &lt; 0) return; write(fd, fu, sizeof(*fu)); close(fd); } static void utx_active_purge(void) { truncate(_PATH_UTX_ACTIVE, 0); } static int utx_lastlogin_add(const struct futx *fu) { struct futx fe; FILE *fp; int error, ret; ret = 0; /* * Write an entry to lastlogin. Overwrite the entry if the * current user already has an entry. If not, append a new * entry. */ fp = futx_open(_PATH_UTX_LASTLOGIN); if (fp == NULL) return (-1); while (fread(&amp;fe, sizeof fe, 1, fp) == 1) { if (strncmp(fu-&gt;fu_user, fe.fu_user, sizeof fe.fu_user) != 0) continue; /* Found a previous lastlogin entry for this user. */ ret = fseeko(fp, -(off_t)sizeof fe, SEEK_CUR); break; } if (ret == -1) error = errno; else if (fwrite(fu, sizeof *fu, 1, fp) &lt; 1) { error = errno; ret = -1; } fclose(fp); if (ret == -1) errno = error; return (ret); } static void utx_lastlogin_upgrade(void) { struct stat sb; int fd; fd = open(_PATH_UTX_LASTLOGIN, O_RDWR|O_CLOEXEC, 0644); if (fd &lt; 0) return; /* * Truncate broken lastlogin files. In the future we should * check for older versions of the file format here and try to * upgrade it. */ if (fstat(fd, &amp;sb) != -1 &amp;&amp; sb.st_size % sizeof(struct futx) != 0) ftruncate(fd, 0); close(fd); } static int utx_log_add(const struct futx *fu) { struct iovec vec[2]; int error, fd; uint16_t l; /* * Append an entry to the log file. We only need to append * records to this file, so to conserve space, trim any trailing * zero-bytes. Prepend a length field, indicating the length of * the record, excluding the length field itself. */ for (l = sizeof(*fu); l &gt; 0 &amp;&amp; ((const char *)fu)[l - 1] == '\0'; l--) ; vec[0].iov_base = &amp;l; vec[0].iov_len = sizeof(l); vec[1].iov_base = __DECONST(void *, fu); vec[1].iov_len = l; l = htobe16(l); fd = open(_PATH_UTX_LOG, O_CREAT|O_WRONLY|O_APPEND|O_CLOEXEC, 0644); if (fd &lt; 0) return (-1); if (writev(fd, vec, 2) == -1) error = errno; else error = 0; close(fd); if (error != 0) errno = error; return (error == 0 ? 0 : 1); } struct utmpx * pututxline(const struct utmpx *utmpx) { struct futx fu; int bad; bad = 0; utx_to_futx(utmpx, &amp;fu); switch (fu.fu_type) { case BOOT_TIME: utx_active_init(&amp;fu); utx_lastlogin_upgrade(); break; case SHUTDOWN_TIME: utx_active_purge(); break; case OLD_TIME: case NEW_TIME: break; case USER_PROCESS: bad |= utx_active_add(&amp;fu); bad |= utx_lastlogin_add(&amp;fu); break; #if 0 /* XXX: Are these records of any use to us? */ case INIT_PROCESS: case LOGIN_PROCESS: bad |= utx_active_add(&amp;fu); break; #endif case DEAD_PROCESS: /* * In case writing a logout entry fails, never attempt * to write it to utx.log. The logout entry's ut_id * might be invalid. */ if (utx_active_remove(&amp;fu) != 0) return (NULL); break; default: errno = EINVAL; return (NULL); } bad |= utx_log_add(&amp;fu); return (bad ? NULL : futx_to_utx(&amp;fu)); }</span></span></span></span></code> </pre><br></div></div><br><br>  We collect <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># clang getent.c -o gtnt</span></span></code> </pre><br><br>  Copy the database and clear the place to write <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># cp /var/log/utx.* /tmp/ # echo -n &gt; /var/log/utx.log # echo -n &gt; /var/log/utx.lastlogin</span></span></code> </pre><br><br>  delete records <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./gtnt utmpx lastlogin /tmp/utx.lastlogin 14281 # ./gtnt utmpx log /tmp/utx.log 14281</span></span></code> </pre><br><br><div class="spoiler">  <b class="spoiler_title">results</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># getent utmpx lastlogin getent utmpx lastlogin [1437293217.427108 -- Sun Jul 19 11:06:57 2015] user process: id="3a873cda545eff7f" pid="1288" user="root" line="ttyv1" host="" [1447316907.634554 -- Thu Nov 12 11:28:27 2015] user process: id="8084832f32000000" pid="4373" user="Alex" line="pts/2" host="108.182.182.209" [1412600841.811588 -- Mon Oct 6 16:07:21 2014] user process: id="3962386266747064" pid="39819" user="swimmer" line="ftpd" host="10.34.1.23" # getent utmpx log getent utmpx log [1446494176.682516 -- Mon Nov 2 22:56:16 2015] user process: id="8084832f32000000" pid="72946" user="Alex" line="pts/2" host="108.182.182.209" [1446498691.474026 -- Tue Nov 3 00:11:31 2015] dead process: id="8084832f31000000" pid="61263" [1446614492.857275 -- Wed Nov 4 08:21:32 2015] user process: id="8084832f31000000" pid="79491" user="Alex" line="pts/1" host="30.205.96.92" [1446614507.736041 -- Wed Nov 4 08:21:47 2015] dead process: id="8084832f31000000" pid="79491" [1446698146.439426 -- Thu Nov 5 07:35:46 2015] user process: id="8084832f31000000" pid="83858" user="Alex" line="pts/1" host="30.205.116.124" [1446706228.892627 -- Thu Nov 5 09:50:28 2015] dead process: id="8084832f31000000" pid="83858" [1446710834.014993 -- Thu Nov 5 11:07:14 2015] system shutdown [1446710906.311914 -- Thu Nov 5 11:08:26 2015] system boot [1446710938.817058 -- Thu Nov 5 11:08:58 2015] user process: id="8084832f30000000" pid="1313" user="Alex" line="pts/0" host="10.3.1.15" [1446721174.063221 -- Thu Nov 5 13:59:34 2015] user process: id="8084832f31000000" pid="1789" user="Alex" line="pts/1" host="108.182.182.209" [1446815955.085182 -- Fri Nov 6 16:19:15 2015] dead process: id="8084832f30000000" pid="1313" [1446906334.551710 -- Sat Nov 7 17:25:34 2015] user process: id="8084832f30000000" pid="11580" user="Alex" line="pts/0" host="108.182.182.209" [1446912588.809728 -- Sat Nov 7 19:09:48 2015] dead process: id="8084832f31000000" pid="1789" [1447045707.708080 -- Mon Nov 9 08:08:27 2015] user process: id="8084832f31000000" pid="19008" user="Alex" line="pts/1" host="mm-21-205-84-93.dynamic.pppoe.mgts.ru" [1447045911.315244 -- Mon Nov 9 08:11:51 2015] dead process: id="8084832f31000000" pid="19008" [1447052181.641530 -- Mon Nov 9 09:56:21 2015] user process: id="8084832f31000000" pid="19314" user="Alex" line="pts/1" host="10.3.1.15" [1447131335.768107 -- Tue Nov 10 07:55:35 2015] user process: id="8084832f33000000" pid="23441" user="Alex" line="pts/3" host="30.205.98.54" [1447133646.400779 -- Tue Nov 10 08:34:06 2015] dead process: id="8084832f33000000" pid="23441" [1447261331.491910 -- Wed Nov 11 20:02:11 2015] system boot [1447263839.850262 -- Wed Nov 11 20:43:59 2015] user process: id="8084832f30000000" pid="1422" user="Alex" line="pts/0" host="10.3.1.15" [1447267906.123055 -- Wed Nov 11 21:51:46 2015] user process: id="8084832f31000000" pid="1644" user="Alex" line="pts/1" host="10.3.1.15" [1447271644.777315 -- Wed Nov 11 22:54:04 2015] dead process: id="8084832f30000000" pid="1422" [1447275711.000315 -- Thu Nov 12 00:01:51 2015] dead process: id="8084832f31000000" pid="1644" [1447303224.172811 -- Thu Nov 12 07:40:24 2015] user process: id="8084832f30000000" pid="3685" user="Alex" line="pts/0" host="30.205.135.101" [1447305113.718172 -- Thu Nov 12 08:11:53 2015] dead process: id="8084832f30000000" pid="3685" [1447309547.097136 -- Thu Nov 12 09:25:47 2015] user process: id="8084832f30000000" pid="4018" user="Alex" line="pts/0" host="108.182.182.209" [1447311304.396008 -- Thu Nov 12 09:55:04 2015] user process: id="8084832f31000000" pid="4104" user="Alex" line="pts/1" host="10.3.1.15" [1447316907.634554 -- Thu Nov 12 11:28:27 2015] user process: id="8084832f32000000" pid="4373" user="Alex" line="pts/2" host="108.182.182.209" [1447322795.387121 -- Thu Nov 12 13:06:35 2015] dead process: id="8084832f30000000" pid="4018"</span></span></code> </pre><br></div></div><br>  and correspondingly <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># lastlogin lastlogin Alex pts/2 108.182.182.209 Thu Nov 12 11:28:27 2015 root ttyv1 Sun Jul 19 11:06:57 2015 swimmer ftpd 10.34.1.23 Mon Oct 6 16:07:21 2014</span></span></code> </pre><br>  All these manipulations led to <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ls -l /var/log/utx.log ls -l /var/log/utx.log -rw-r--r-- 1 root wheel 1570 Nov 13 14:28 /var/log/utx.log</span></span></code> </pre><br>  Therefore, we edit the visit time in accordance with the last entry in the log <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># touch -t201511121306 /var/log/utx.log touch -t201511121306 /var/log/utx.log # ls -l /var/log/utx.log ls -l /var/log/utx.log -rw-r--r-- 1 root wheel 1570 Nov 12 13:06 /var/log/utx.log</span></span></code> </pre><br><br>  Repeat the same for other files ... <br><br>  It's done, it's time to leave.  Clean history <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># history -c</span></span></code> </pre><br>  and go "in English" <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># kill -9 $$</span></span></code> </pre><br><br>  Why all the above? <br>  Do not rely only on system logs, keep yours.  At least notifications on an e-mail about an input </div><p>Source: <a href="https://habr.com/ru/post/270801/">https://habr.com/ru/post/270801/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../270785/index.html">666th Post: Fears and Superstitions of IT Professionals</a></li>
<li><a href="../270787/index.html">Early detection of cyber threats in the enterprise</a></li>
<li><a href="../270791/index.html">DataTalks # 4: Predictive Analytics</a></li>
<li><a href="../270793/index.html">New formats of mobile advertising, disassembling iOS - Android, and a lot of analytics in the news of the week for mobile developers</a></li>
<li><a href="../270797/index.html">We write a simple virtual machine in Python</a></li>
<li><a href="../270803/index.html">Lab penetration testing "Test lab v.8": welcome to hell</a></li>
<li><a href="../270805/index.html">Use Carthage to manage dependencies</a></li>
<li><a href="../270807/index.html">Microsoft has released a major update for Windows 10</a></li>
<li><a href="../270809/index.html">Voice control multimedia center</a></li>
<li><a href="../270813/index.html">Online algorithms in high-frequency trading: problems of competition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>