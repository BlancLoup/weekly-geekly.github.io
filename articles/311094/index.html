<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yield: what, where and why</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The .Net developer community stood still waiting for the release of C # 7.0 and the new features it brings. Each version of the language, which next y...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yield: what, where and why</h1><div class="post__text post__text-html js-mediator-article"><p> The .Net developer community stood still waiting for the release of C # 7.0 and the new features it brings.  Each version of the language, which next year will be 15 years old, brought with it something new and useful.  And although each feature is worth a separate mention, today I want to talk about the <code>yield</code> keyword.  I noticed that novice developers (and not only) avoid using it.  In this article I will try to bring the advantages and disadvantages, as well as highlight cases where the use of <code>yield</code> appropriate. </p><br><p>  <code>yield</code> creates an iterator and allows us not to write a separate class when we implement <code>IEnumerable</code> .  C # contains two expressions using <code>yield</code> : <code>yield return &lt;expression&gt;</code> and <code>yield break</code> .  <code>yield</code> can be used in methods, operators, and properties.  I will talk about methods, since <code>yield</code> works the same everywhere. <a name="habracut"></a></p><br><p>  By applying <code>yield return</code> returns, we declare that this method returns an <code>IEnumerable</code> sequence, whose elements are the results of the expressions of each <code>yield return</code> .  And with the return value, <code>yield return</code> transfers control to the caller and continues the execution of the method after the next item is requested.  The values ‚Äã‚Äãof variables inside the <code>yield</code> method are stored between queries.  <code>yield break</code> in turn plays the role of a well-known <code>break</code> used inside loops.  The example below will return a sequence of numbers from 0 to 10: </p><br><div class="spoiler">  <b class="spoiler_title">Getnumbers</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetNumbers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> number = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (number &gt; <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number++; } }</code> </pre> </div></div><br><p>  It is important to mention that the use of <code>yield</code> has several limitations that you need to be aware of.  The <code>Reset</code> call on the iterator throws a <code>NotSupportedException</code> .  We cannot use it in anonymous methods and methods containing <code>unsafe</code> code.  Also, a <code>yield return</code> cannot be located in a <code>try-catch</code> , although nothing prevents you from placing it in the <code>try</code> section of a <code>try-finally</code> block.  <code>yield break</code> can be located in the <code>try</code> section of both <code>try-catch</code> and <code>try-finally</code> .  I will not give the reasons for such restrictions, as they are described in detail by Eric Lipert <a href="https://blogs.msdn.microsoft.com/ericlippert/2009/07/16/iterator-blocks-part-three-why-no-yield-in-finally/">here</a> and <a href="https://blogs.msdn.microsoft.com/ericlippert/2009/07/20/iterator-blocks-part-four-why-no-yield-in-catch/">here</a> . </p><br><p>  Let's see what <code>yield</code> turns into after compilation.  Each <code>yield return</code> method is a state machine that goes from one state to another as the iterator works.  Below is a simple application that displays an infinite sequence of odd numbers to the console: </p><br><div class="spoiler">  <b class="spoiler_title">Sample program</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">internal</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">var</span></span></span><span class="hljs-function"> number </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOddNumbers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)) Console.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">WriteLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">number</span></span></span><span class="hljs-function">)</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetOddNumbers</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> previous = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (++previous%<span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> previous; } }</code> </pre> </div></div><br><p>  The compiler will generate the following code: </p><br><div class="spoiler">  <b class="spoiler_title">Generated code</b> <div class="spoiler_text"><pre> <code class="hljs cpp">internal <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Program</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ IEnumerator&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; enumerator = null; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { enumerator = GetOddNumbers().GetEnumerator(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (enumerator.MoveNext()) Console.WriteLine(enumerator.Current); } finally { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (enumerator != null) enumerator.Dispose(); } } [IteratorStateMachine(typeof(CompilerGeneratedYield))] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; GetOddNumbers() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerGeneratedYield(<span class="hljs-number"><span class="hljs-number">-2</span></span>); } [CompilerGenerated] <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> sealed <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CompilerGeneratedYield</span></span></span><span class="hljs-class"> :</span></span> IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;, IEnumerable, IEnumerator&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;, IDisposable, IEnumerator { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> readonly <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _initialThreadId; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _current; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _previous; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _state; [DebuggerHidden] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CompilerGeneratedYield</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> state)</span></span></span><span class="hljs-function"> </span></span>{ _state = state; _initialThreadId = Environment.CurrentManagedThreadId; } [DebuggerHidden] IEnumerator&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt; IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.GetEnumerator() { CompilerGeneratedYield getOddNumbers; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ((_state == <span class="hljs-number"><span class="hljs-number">-2</span></span>) &amp;&amp; (_initialThreadId == Environment.CurrentManagedThreadId)) { _state = <span class="hljs-number"><span class="hljs-number">0</span></span>; getOddNumbers = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { getOddNumbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CompilerGeneratedYield(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getOddNumbers; } [DebuggerHidden] IEnumerator IEnumerable.GetEnumerator() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ((IEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;)<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>).GetEnumerator(); } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> IEnumerator&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;.Current { [DebuggerHidden] get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _current; } } object IEnumerator.Current { [DebuggerHidden] get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _current; } } [DebuggerHidden] <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IDisposable.Dispose() { } <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> IEnumerator.MoveNext() { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (_state) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>: _state = <span class="hljs-number"><span class="hljs-number">-1</span></span>; _previous = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>: _state = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { num = _previous + <span class="hljs-number"><span class="hljs-number">1</span></span>; _previous = num; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (num%<span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>); _current = _previous; _state = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } [DebuggerHidden] <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> IEnumerator.Reset() { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NotSupportedException(); } } }</code> </pre> </div></div><br><p>  From the example, you can see that the body of the method with <code>yield</code> was replaced by the generated class.  Local variables of a method turned into class fields.  The class itself implements both <code>IEnumerable</code> and <code>IEnumerator</code> .  The <code>MoveNext</code> method contains the logic of the replaced method with the only difference that it is represented as a state machine.  Depending on the implementation of the original method, the generated class may additionally contain an implementation of the <code>Dispose</code> method. </p><br><p>  Let's do two tests and measure performance and memory consumption.  I‚Äôll note right away that these tests are synthetic and are given only to demonstrate the work <code>yield</code> in comparison with the implementation "head on."  Measurements will be done using <a href="https://github.com/PerfDotNet/BenchmarkDotNet">BenchmarkDotNet</a> with the <code>BenchmarkDotNet.Diagnostics.Windows</code> diagnostic module enabled.  The first is to compare the speed of the method for obtaining a sequence of numbers (analogue of <code>Enumerable.Range(start, count)</code> ).  In the first case there will be an implementation without an iterator, in the second with: </p><br><div class="spoiler">  <b class="spoiler_title">Test 1</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Array</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> numbers = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[count]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; ++i) numbers[i] = start + i; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> numbers; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Iterator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IteratorInternal(start, count).ToArray(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> IEnumerable&lt;</span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function">&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IteratorInternal</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> start, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> count</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; count; ++i) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> start + i; }</code> </pre> </div></div><br><table><thead><tr><th>  Method </th><th>  Count </th><th>  Start </th><th>  Median </th><th>  Stddev </th><th>  Gen 0 </th><th>  Gen 1 </th><th>  Gen 2 </th><th>  Bytes Allocated / Op </th></tr></thead><tbody><tr><td>  Array </td><td>  100 </td><td>  ten </td><td>  91.19 ns </td><td>  1.25 ns </td><td>  385.01 </td><td>  - </td><td>  - </td><td>  169.18 </td></tr><tr><td>  Iterator </td><td>  100 </td><td>  ten </td><td>  1,173.26 ns </td><td>  10.94 ns </td><td>  1,593.00 </td><td>  - </td><td>  - </td><td>  700.37 </td></tr></tbody></table><br><p>  As can be seen from the results, the Array implementation is an order of magnitude faster and consumes 4 times less memory.  An iterator and a separate call <code>ToArray</code> did their job. </p><br><p>  The second test will be more difficult.  We will emulate data flow.  We will first select entries with an odd key, and then with a key multiple of 3rd.  As in the previous test, the first implementation will be without an iterator, the second with: </p><br><div class="spoiler">  <b class="spoiler_title">Test 2</b> <div class="spoiler_text"><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; List(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> odds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">var</span></span></span><span class="hljs-function"> record </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OddsArray</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ReadFromDb(start, count</span></span></span><span class="hljs-function">))) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">record.Item1%</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> == </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">) odds.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">record</span></span></span><span class="hljs-function">)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> odds; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> List&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; Iterator(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IteratorInternal(start, count).ToList(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IEnumerable&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; IteratorInternal(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">var</span></span></span><span class="hljs-function"> record </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OddsIterator</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ReadFromDb(start, count</span></span></span><span class="hljs-function">))) </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">if</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">record.Item1%</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">3</span></span></span></span><span class="hljs-function"><span class="hljs-params"> == </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">0</span></span></span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">yield</span></span></span><span class="hljs-function"> return record</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IEnumerable&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; OddsIterator(IEnumerable&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; records) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> record <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (record.Item1%<span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> record; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; OddsArray(IEnumerable&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; records) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> odds = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> record <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> records) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (record.Item1%<span class="hljs-number"><span class="hljs-number">2</span></span> != <span class="hljs-number"><span class="hljs-number">0</span></span>) odds.Add(record); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> odds; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IEnumerable&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;&gt; ReadFromDb(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> start, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> count) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = start; i &lt; count; ++i) <span class="hljs-keyword"><span class="hljs-keyword">yield</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> KeyValuePair&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(start + i, RandomString()); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RandomString</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Guid.NewGuid().ToString(<span class="hljs-string"><span class="hljs-string">"n"</span></span>); }</code> </pre> </div></div><br><table><thead><tr><th>  Method </th><th>  Count </th><th>  Start </th><th>  Median </th><th>  Stddev </th><th>  Gen 0 </th><th>  Gen 1 </th><th>  Gen 2 </th><th>  Bytes Allocated / Op </th></tr></thead><tbody><tr><td>  List </td><td>  100 </td><td>  ten </td><td>  43.14 us </td><td>  0.14 us </td><td>  279.04 </td><td>  - </td><td>  - </td><td>  4,444.14 </td></tr><tr><td>  Iterator </td><td>  100 </td><td>  ten </td><td>  43.22 us </td><td>  0.76 us </td><td>  231.00 </td><td>  - </td><td>  - </td><td>  3,760.96 </td></tr></tbody></table><br><p>  In this case, the execution speed turned out to be the same, and the memory consumption of the <code>yield</code> was even lower.  This is due to the fact that in the implementation with the iterator, the collection was calculated only once and we saved memory on the allocation of one <code>List&lt;Tuple&lt;int, string&gt;&gt;</code> . </p><br><p>  Taking into account all the above and the above tests, we can make a brief conclusion: the main disadvantage of <code>yield</code> is the additional class iterator.  If the sequence is finite and the caller does not perform complex manipulations on the elements, the iterator will be slower and will create an undesirable load on the GC.  However, it is reasonable to use <code>yield</code> in cases of processing long sequences, when each calculation of a collection results in the allocation of large memory arrays.  The lazy nature of <code>yield</code> avoids the computation of elements of a sequence that can be filtered out.  This can drastically reduce memory consumption and reduce the load on the processor. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/311094/">https://habr.com/ru/post/311094/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../311084/index.html">Taming asynchronous processes in Android with RxJava. Yandex experience</a></li>
<li><a href="../311086/index.html">NanoFL: Brief Feature Description</a></li>
<li><a href="../311088/index.html">Creating a blog engine with Phoenix and Elixir / Part 1. Introduction</a></li>
<li><a href="../311090/index.html">MapReduce in Qt Concurrent</a></li>
<li><a href="../311092/index.html">‚ÄúTrue, true truth and statistics‚Äù or ‚Äú15 probability distributions for all occasions‚Äù</a></li>
<li><a href="../311096/index.html">Javascript frameworks: there should be only one</a></li>
<li><a href="../311098/index.html">Logeek Night in Voronezh</a></li>
<li><a href="../311100/index.html">Several gradle chips for your Android application</a></li>
<li><a href="../311102/index.html">Intelligence services and not only: how to protect your application from backdoors</a></li>
<li><a href="../311104/index.html">YT: why does Yandex need its own MapReduce-system and how it works</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>