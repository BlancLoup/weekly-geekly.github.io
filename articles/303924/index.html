<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Azure Service Fabric: First Steps</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Charlie Chaplin in the movie "New Times" 

 About Azure Service Fabric has already written a lot of articles and even books, the benefit of about a ye...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Azure Service Fabric: First Steps</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fb2/5c6/57a/fb25c657ad844abd85961dd2888664f6.jpg"><br>  <i>Charlie Chaplin in the movie "New Times"</i> <br><br>  About Azure Service Fabric has already written a lot of articles and even books, the benefit of about a year the product was in the preview state.  However, on April 1, 2016, without any joke, <a href="https://azure.microsoft.com/ru-ru/updates/general-availability-azure-service-fabric/">Azure Service Fabric finally reached the state of General availability</a> , and there is reason to believe that it will linger here seriously and for a long time.  And if so - why not walk through it, if not from an applied one, then at least from academic interest?  Moreover, the information on Azure Service Fabric in Russian is clearly not enough. <br><br>  Why was Azure Service Fabric needed at all?  In the software world, there are quite a few servers associated with the ecosystems of a particular language or platform.  Historically, in the Java ecosystem, such servers are almost the most - Tomcat, JBoss, WebSphere, etc. Alas, the .NET platform cannot yet boast such a wealth of choice.  The only thing that comes to mind is IIS, Azure cloud services and their local Windows Azure Pack twin (not counting <a href="http://topshelf-project.com/">Topshelf</a> type wrappers).  Azure Service Fabric is designed to expand this short list in the direction of the currently popular SOA concept and the highly fashionable subconcept of microservices, simplifying the deployment of services and ensuring their scalability and fault tolerance.  And after this lyrical digression, we finally go on the offensive. <br><a name="habracut"></a><br><h4>  Galloping across Europe </h4><br>  The main source of knowledge about Azure Service Fabric (hereinafter ASF) is <a href="https://azure.microsoft.com/en-us/documentation/services/service-fabric">documentation</a> .  I strongly recommend and at the same time I note that the Russian translation lags behind the source text at least in the screenshots, so it‚Äôs better to focus on the original.  So, let's go - physically, ASF is a cluster of several servers running service instances.  Something like that: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/72e/be5/917/72ebe591797c4d2a8e64728213543d4c.png"><br>  <i>Drawn with <a href="http://creately.com/">creately.com</a></i> <br><br>  What is the service?  According to Wikipedia, <a href="https://en.wikipedia.org/wiki/Service-oriented_architecture">service is</a> defined as ‚ÄúA service is a self-contained unit of functionality,‚Äù in other words, it is ‚Äúa combat unit in itself,‚Äù separately and independently deployed and used.  In ASF, each such ‚Äúcombat unit‚Äù has its own manifest, in which the service name, configuration, end points, etc. are defined. Despite atomicity, the deployment unit is still not a service, but a set of services, called an application ‚Äî in the application manifest, you can , define service partitioning to maintain scalability, and for fault tolerance in case of failure of ASF servers, each partition can have multiple instances of services.  Both services and applications are versioned independently, which allows you to update the application without updating all services in it at once.  For a deployed application, ASF creates the required number of service instances, locates on cluster nodes, starts, synchronizes state between instances, re-creates instances for load balancing - for example, in the picture above, Service 1 has an end point to communicate over TCP and in two instances is placed on two nodes Service 2 has outputs on TCP and HTTP and is located on one of the three nodes in one copy, while Service 3 does not provide external communications and runs on one node in one copy.  If one of the nodes dies untimely, the ASF rebalances the load on the rest.  In general, ensuring the smooth functioning of services is the work of ASF. <br><br>  Services in ASF are divided into two types - stateful and stateless, in other words, storing their state and not having one.  You can use these types by simply spawning your services from them, or you can build more complex structures on their basis ‚Äî say, ASF Actors technology is itself built on a stateful service.  For the first acquaintance with ASF, I use the stateless service as more simple. <br><br><h4>  There will be a garden city </h4><br>  ... but not immediately.  To begin with, we set up a development environment.  <a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-get-started/">From here we</a> download and install the desired version of the SDK - you can stand-alone, or you can with elements for integration into Visual Studio.  For an integrated version, you need a Visual Studio 2015 or ‚Äú15‚Äù Preview, and the Community option is probably suitable, and the Visual Studio Enterprise 2015 Update 2 was used when writing the article, and everything is guaranteed to work in it.  After installing the SDK, the Service Fabric Application appears in the list of project templates (namely, in the Visual C # / Cloud section) and you can finally get down to business - create a new ASF application, call it MyFabric, click OK, select the type of service Stateless, call MyStateless ‚ÄúAnd stupidly see what's what‚Äù in the newly created decision.  Note that the solution is unconditionally created for x64, and in its composition: <br><br><ul><li>  MyStateless project <br><ul><li>  <i>Program.cs</i> is a service entry point.  All she does is register the service in ASF, write this significant event in the log, and then fall asleep forever. </li><li>  <i>MyStateless.cs</i> is the actual service code.  Contains a simple infinite loop, every second writing to the log and interrupted by an external CancellationToken. </li><li>  <i>ServiceEventSource.cs</i> - ASF uses ETW via EventSource.  This class describes some commonly used events, providing convenient methods for logging. </li><li>  <i>ServiceManifest.xml</i> - MyStateless service manifest for ASF. </li><li>  <i>Settings.xml</i> is the service configuration, referred to in the manifest as ConfigPackage. </li></ul></li><li>  MyFabric project <br><ul><li>  <i>ApplicationManifest.xml</i> - the manifest of the entire MyFabric application for ASF. </li><li>  <i>ApplicationParameters / (Local | Cloud) .xml</i> - override the parameters of the application manifest. </li><li>  <i>PublishProfiles / (Local | Cloud) .xml</i> - application deployment profiles in various environments.  In fact, they represent the address of the ASF cluster and the overrides from ApplicationParameters. </li></ul></li></ul><br>  Let's run the solution for execution and later build and deploy we see just such a nice picture of SF Explorer (by the way - in the settings you can change the dark scheme to light): <br><br><img src="https://habrastorage.org/files/0d0/e11/0fc/0d0e110fc24c479982ca12305d5c321a.png"><br><br>  What is in front of us?  We have before us the management of a local 5-node ASF cluster (no matter how silly this may sound) with the fabric: / MyFabric / MyStateless application deployed on it.  You should not be embarrassed by the inscription ‚Äú2 applications‚Äù - on the cluster is the default application System of 4 stateful services used by the cluster itself.  According to the MyFabric manifest, the MyStateless service is required only in one instance, and in our case this instance hit the 3rd node of the cluster.  The application can be seen in the Diagnostic Events window: <br><br><img src="https://habrastorage.org/files/228/f8d/5d3/228f8d5d357f403ea6d75304569020c9.png"><br><br>  You can have fun driving a single copy on the nodes - to do this, from the drop-down menu on the right of the Actions in the desired node, select any option Deactivate.  In this case, the VS Diagnostic Events window reflects all the details of what is happening inside the ASF, in particular the fact that the ‚Äúold‚Äù instance of MyStateless canceled and stopped, and the ‚Äúnew‚Äù started counting again. <br><br><img src="https://habrastorage.org/files/631/bf4/ca0/631bf4ca01a34e7aa2ab80f3241e240e.png"><br><br>  This is not surprising - the service has no status. <br><br>  I note here that SF Explorer itself and other cluster management is accessible from the ‚Äúdaisy‚Äù in the tray, and the Diagnostic Events window is available from the View / Other Windows menu.  If this window suddenly doesn‚Äôt display anything, <a href="http://stackoverflow.com/questions/35323790/azure-servicefabric-samples-not-logging-to-etw">add the line</a> ‚ÄúMyCompany-MyFabric-MyStateless‚Äù to the list of ETW providers under the gear. <br><br><h4>  Cycle of life </h4><br>  Having fun to break the cluster, we proceed to the analysis of the details of the functioning of our service.  In general, the life cycle of a service is determined by the set of virtual methods of the StatelssService class, from which our MyStateless is spawned, namely: <br><br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> IEnumerable&lt;ServiceInstanceListener&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateServiceInstanceListeners</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnOpenAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCloseAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAbort</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span></code> </pre> <br>  There are only five interesting methods, and to understand the sequence of their calls, we modify the service code by redefining the methods and adding logging (yes, good old debug printing): <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> IEnumerable&lt;ServiceInstanceListener&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateServiceInstanceListeners</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ServiceEventSource.Current.ServiceMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"CreateServiceInstanceListeners"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceInstanceListener[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnOpenAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { ServiceEventSource.Current.ServiceMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"OnOpenAsync"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnCloseAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { ServiceEventSource.Current.ServiceMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"OnCloseAsync"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Task.FromResult(<span class="hljs-number"><span class="hljs-number">0</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnAbort</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { ServiceEventSource.Current.ServiceMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"OnAbort"</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunAsync</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">CancellationToken cancellationToken</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> iterations = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!cancellationToken.IsCancellationRequested) { ServiceEventSource.Current.ServiceMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Working-{0}"</span></span>, ++iterations); <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task .Delay(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">1</span></span>), cancellationToken) .ContinueWith(_ =&gt; { }, TaskContinuationOptions.NotOnFaulted); } }</code> </pre><br>  RunAsync is additionally reworked for correct completion instead of throwing an exception.  Again we look at Diagnostic Events: <br><br><img src="https://habrastorage.org/files/3d1/a07/bcf/3d1a07bcf02f4f78aaedd28f3ed2a272.png"><br><br>  The first expectedly called CreateServiceInstanceListeners - in it the service creates all the necessary endpoints for communication with the outside world and within the cluster.  Behind him is expected OnOpenAsync - to yes?  So no - then comes RunAsync.  The logic of this behavior is unclear, but according to the OnOpenAsync <a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-services-advanced-usage/">documentation,</a> it is in some way an additional event, but the RunAsync call is necessary (and quite sufficient).  After it, OnOpenAsync is actually called and the service is already running until OnCloseAsync / OnAbort stops (caused, for example, by redeploying the service): <br><br><img src="https://habrastorage.org/files/a19/0d4/ef0/a190d4ef0e7c41a9bf9ce29ebe776dd2.png"><br><br><h4>  Configuration </h4><br>  There is nothing to configure in the template code, but there is something to be found - every second logging is good, but it could be more rarely.  To do this, in the Settings.xml configuration, enter the parameter: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Section</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyConfigSection"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Parameter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyFrequency"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"10"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Section</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  In the code, add the receipt of this value: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> configurationPackage = Context.CodePackageActivationContext.GetConfigurationPackageObject(<span class="hljs-string"><span class="hljs-string">"Config"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> frequencyInSeconds = <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>.Parse(configurationPackage.Settings.Sections[<span class="hljs-string"><span class="hljs-string">"MyConfigSection"</span></span>].Parameters[<span class="hljs-string"><span class="hljs-string">"MyFrequency"</span></span>].Value);</code> </pre><br>  And use the resulting value: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> Task .Delay(TimeSpan.FromSeconds(frequencyInSeconds), cancellationToken) .ContinueWith(_ =&gt; { }, TaskContinuationOptions.NotOnFaulted);</code> </pre><br>  Now the service writes to the log every 10 seconds.  Let me remind you that the service parameters can be redefined both in the application manifest and in the deployment profiles for different environments - as a rule, they are different for development environments and BETA / PROD. <br><br><h4>  Just add codes </h4><br>  A service is not a service when without communications ‚Äî let MyStateless be a-la NTP time service, and use <a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-reliable-services-communication-remoting/">ASF Remoting</a> to simplify interactions with it.  This technology allows you to communicate with the service as with a normal .NET object through the service interface.  Create an IMyStateless interface with the single Now () method: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IMyStateless</span></span> : <span class="hljs-title"><span class="hljs-title">IService</span></span> { <span class="hljs-function"><span class="hljs-function">Task&lt;DateTimeOffset&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Now</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  To create a listener, modify the CreateServiceInstanceListeners: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span>[] { <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServiceInstanceListener(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.CreateServiceRemotingListener) };</code> </pre><br>  And the usual console application will be the client: <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Console.KeyAvailable) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myStateless = ServiceProxy.Create&lt;IMyStateless&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"fabric:/MyFabric/MyStateless"</span></span>)); Console.WriteLine(myStateless.Now().Result); Thread.Sleep(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">10</span></span>)); } }</code> </pre><br>  We add only the code, the configuration is not necessary to edit.  In order to use the client, the ASF application must first be published - select Publish from the context menu of the MyFabric node, select Local.xml as the Target Profile, click Publish and wait for the message about the successful publication.  Now you can start the client and make sure that the time of the local cluster is exactly the same as the system time (which is unexpected). <br><br><h4>  We grow above ourselves </h4><br>  Strictly speaking, ASF means stateless services that do not store state using the ASF itself.  As is rightly said in the <a href="https://azure.microsoft.com/en-us/documentation/articles/service-fabric-concepts-partitioning/">documentation</a> , it makes sense to partition stateless services when they still keep their state in any other convenient way (in the database, caches, text files, etc.).  However, all services are actually partized - just stateless use a special case of SingletonPartition (and this is reflected in the application manifest).  So let's start by scaling this single partition - we‚Äôll increase the number of MyStateless instances by adjusting ApplicationParameters / Local.xml: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Parameter</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyStateless_InstanceCount"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  The node tree in SF Explorer no longer fits into the screenshot, so believe and check for yourself that five instances of the service are evenly distributed (that is, one at a time) across all five nodes of the cluster.  With this scaling, problems may arise related to unshared resources (for example, ports), but for Remoting in our case, ASF balances calls between running instances on its own.  For simplicity, let's add the InstanceId logging to the Now () method and in the Diagnostic Events window we will see that the calls fall into different MyStateless instances. <br><br>  It is speculative to assume that MyStateless still stores some state outside ASF and partition it using the partitioning scheme by name: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StatelessService</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ServiceTypeName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MyStatelessType"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">InstanceCount</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"[MyStateless_InstanceCount]"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NamedPartition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Partition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"even"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Partition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"odd"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">NamedPartition</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">StatelessService</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Redeploying and in SF Explorer we see that two partitions of five copies each again evenly (that is, one copy from the partition) are distributed over all five nodes of the cluster. <br><br>  It was our victory, but now the client does not work, falling with the exception of FabricException and the informative message "Invalid partition key / ID '{0}' for selector {1}" - we fix the client: <br><br><pre> <code class="cs hljs"> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isEven = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (!Console.KeyAvailable) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> myStateless = ServiceProxy.Create&lt;IMyStateless&gt;( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(<span class="hljs-string"><span class="hljs-string">"fabric:/MyFabric/MyStateless"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ServicePartitionKey(isEven ? <span class="hljs-string"><span class="hljs-string">"even"</span></span> : <span class="hljs-string"><span class="hljs-string">"odd"</span></span>)); Console.WriteLine(myStateless.Now().Result); isEven = !isEven; Thread.Sleep(TimeSpan.FromSeconds(<span class="hljs-number"><span class="hljs-number">10</span></span>)); }</code> </pre><br>  And at the same time logging service: <br><br><pre> <code class="cs hljs"> ServiceEventSource.Current.ServiceMessage(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"Now - "</span></span> + Context.PartitionId + <span class="hljs-string"><span class="hljs-string">" - "</span></span> + Context.InstanceId);</code> </pre><br>  Now everything is fine - the client sends a call to the desired partition, and ASF balances calls between peer service instances inside the partition.  MyStateless is remastered and made fault tolerant. <br><br><h4>  Web API </h4><br>  And in order not to get up two times, at the same time we will briefly touch upon the topic of ASF Web API services, since they are also created from templates without state.  From the context menu of the MyFabric / Services node, select Add, the service type of the Stateless Web API, call MyWebApi and get a new project with the files: <br><br><ul><li>  <i>Program.cs</i> - already recognizable contains the registration of the service in the ASF. </li><li>  <i>MyWebApi.cs</i> is a service code that, instead of implementing RunAsync, registers a listener with OwinCommunicationListener. </li><li>  <i>ServiceEventSource.cs / ServiceManifest.xml / Settings.xml</i> - play the same roles with amended content on the Web API. </li><li>  <i>OwinCommunicationListener.cs</i> - ASF's Web API templates are based on Owin, so this listener implements the ICommunicationListener methods by starting and stopping the Owin Web server. </li><li>  <i>Startup.cs</i> - configures routing in Owin </li><li>  <i>ValuesController.cs</i> - a simple test controller, the path to which is configured in <i>Startup.cs</i> </li></ul><br>  After publishing to SF Explorer, we see the second service fabric: / MyFabric / MyWebApi.  To check its performance, you can open the page in the browser at <code>http://localhost:8201/api/values</code> ‚Äî the controller's XML response from Get () is expected to appear in it, and at <code>http://localhost:8201/api/values/123</code> return the response from Get (int id). <br><br><h4>  ‚ÄúAs George put it, there was so much to chew on!‚Äù </h4><br>  And this is where our first steps end.  Obviously, this short article did not exhaust even a tenth of what can be said about ASF.  In addition to the board, besides, there is such a large-scale topic as stateful services - it requires a separate article, effort and time, but if it works, then there will be a short distance to the Actor model in ASF.  It is possible that it will come to this - as they say, write comments.  The code from the article is available in <a href="https://github.com/Caraul/MyFabric">GitHub</a> , and <a href="https://azure.microsoft.com/en-us/documentation/samples/%3Fservice%3Dservice-fabric">here</a> you can see the ‚Äúnative‚Äù examples from Microsoft. </div><p>Source: <a href="https://habr.com/ru/post/303924/">https://habr.com/ru/post/303924/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303912/index.html">Creating a library search by a young programmer - what is it?</a></li>
<li><a href="../303914/index.html">Solving Hola Javascript Challenge with LSTM</a></li>
<li><a href="../303916/index.html">How to build perfect graphics in vROps</a></li>
<li><a href="../303918/index.html">Survey: how strictly do you follow the standards and best practices in the frontend?</a></li>
<li><a href="../303922/index.html">1C.Drop.1 uses 1C to execute malicious code</a></li>
<li><a href="../303926/index.html">The structure of the Android project - an alternative way</a></li>
<li><a href="../303928/index.html">Closed gestalt and a lot of meat at the Ukrainian Cartographic Conference</a></li>
<li><a href="../303934/index.html">Flash flash strikes: new Hitachi Accelerated Flash modules</a></li>
<li><a href="../303936/index.html">How to create your own VPS hosting from scratch and start making money on it? Simple billing with WooCommerce</a></li>
<li><a href="../303938/index.html">Working with OZON (Merchants) API using PHP</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>