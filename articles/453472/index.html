<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bicycle power monitor PZEM004T and ESP8266, with people's monitoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I decided to keep my unsuccessful temperature controller project ( Fiasco. The story of one IoT homemade ) as a monitor only. And with the next step I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bicycle power monitor PZEM004T and ESP8266, with people's monitoring</h1><div class="post__text post__text-html js-mediator-article">  I decided to keep my unsuccessful temperature controller project ( <a href="https://habr.com/ru/post/426235/">Fiasco. The story of one IoT homemade</a> ) as a monitor only.  And with the next step I screwed up the PZEM004T energy monitor, for one I implemented the sending of data to the <a href="https://narodmon.ru/">People's Monitor</a> . <br>  Welcome under the category‚Ä¶ <br><a name="habracut"></a><br>  I asked the question - where does the current go from the wires?  It seems to drown the house with gas, in the house all the diode lamps, turn on the dishwasher in the night, the bath with an electric stove yet, and the electricity all the time goes somewhere.  Disorder.  We should follow him. <br><br><h2>  The first step is a general monitoring of consumption. </h2><br><h3>  Tasks </h3><br>  I decided to start hunting a herd of hares.  Hares were chosen: <br><br><ul><li>  Monitoring the electrical network via the Internet.  I have instant control of network parameters - in the corridor, there is an energy monitor PZEM061 in the dashboard, you can see the voltage, current and power on the screen.  But at the place of the display of energy consumed - some kind of abstraction, too few discharges.  But in the hallway is not convenient.  I want on the phone screen. </li><li>  Schedule of electricity consumption.  I would like to know when excessive consumption occurs? </li><li>  Meter readings via the Internet.  This pain is the transfer of meter readings to energy sales.  It is necessary to transfer testimony to them from the 15th to the 25th day of the month.  I often forget about this and they start calling the robot and writing spam.  At the same time, when they remind of themselves - I am usually at work, and the counter is on my pole on the street.  I want on the phone screen. </li><li>  Stabilizer temperature monitoring.  In our village in the winter more than 200v at the entrance to the house does not happen, comes to 140v.  Therefore, I do not have a stabilizer for 12 kW, but with such parameters and a long load of 2 kW and taking into account the location of the stabilizer in the wall niche, the stabilizer overheats and shuts down, I had to add a couple of fans (with them the temperature remains within acceptable limits) - they were previously turned on constantly, now under the dough - put the thermostats KSD9700 for 65g, waiting for the winter.  I do not want to monitor this parameter, since  I can not influence it.  But after adding thermostats - you need to control the result. </li></ul><br><h3>  Iron </h3><br>  To solve the tasks was selected: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  PZEM004T - energy monitor with UART.  It allows you to get the parameters of the power grid - one parameter every 0.6 seconds: voltage, current, power, consumed energy, as well as the frequency and power factor I do not need.  Used with measuring transformer 1: 1000. </li><li>  ESP8266 NodeMCU - a universal microcontroller with WiFi, it fits in well with the PZEM004T in size - can be connected in racks using the holes on the boards.  Also on the NodeMCU board there is a useful Flash button (connected to GPIO0) - it is convenient to use it to control the mode of operation - for example, to enable SoftAP. </li></ul><br>  Taking into account that the device will be placed in the metal case of the stabilizer - the external antenna is soldered on the ESP.  I tried to power the ESP from the PZEM004T (having soldered the wires to the round capacitor - about 7v on it) - it did not work, when the ESP is connected, the voltage drops to 2v.  But in the stabilizer there is already a power supply for 5v - for fans, it means it will be used (I thought it was for 12v, so I suffered for a long time to connect ESP to it - it didn't work in any, I tried a bunch of DC-DC converters until it turned BP and did not read the inscriptions on it). <br><br><img src="https://habrastorage.org/webt/56/8s/yz/568syzaphx5e7gg62uqjuyjqkua.png"><br><br><h3>  Firmware </h3><br>  Looked available on the net.  As usual, I did not find the right one and decided to write my own. <br>  He took his project for the Sonoff relay for the base (the simplest functionality, on HTTP and on the button, turns on and off, doesn‚Äôt know anything else; is used in conjunction with <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.arlosoft.macrodroid">MacroDroid</a> to <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.arlosoft.macrodroid">gently</a> power the phone with the screen constantly turned on - the previous one had a swelling battery from the constant charge ).  But besides the functionality of the relay, the assembly has an http server, WiFi settings, NTP, works with the GPIO0 button - different actions on the duration of the press, blinks like a light bulb (for example, counting down the seconds of pressing the button, reflecting the relay status and WiFi) ... <br><br>  Naturally somewhat modified the settings: <br><br><img src="https://habrastorage.org/webt/6n/oy/27/6noy274t8yivlrtxybopipepba4.png"><br><br>  I looked at the existing library for working with the PZEM004T - I did not like it.  She sends a request, and then waits for a response in a closed loop.  It is not correct.  I wrote my library, asynchronous - I indicate to it from the main program which parameters I want to receive, and then periodically check if the required data is received: <br><br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">static</span></span> PZEM004Tnb::flags flags = PZEM004Tnb::flags::all; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> lastReadEnergyTime = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (Pzem004t.isDataUpdated()) { setLedState(<span class="hljs-number"><span class="hljs-number">3</span></span>); <span class="hljs-comment"><span class="hljs-comment">//       // ... unsigned long currentTime = millis(); if ((currentTime - lastReadEnergyTime) &gt; 6000) { //   1    flags = PZEM004Tnb::flags::all; lastReadEnergyTime = currentTime; }else{ flags = (PZEM004Tnb::flags)(PZEM004Tnb::flags::all ^ PZEM004Tnb::flags::energy); } } Pzem004t.updateData(flags);</span></span></code> </pre> <br></div></div><br>  I took into account that the PZEM004T counts a maximum of 99kW * h, then it is reset - implemented overflow accounting.  Implemented dvukhtarifny account.  Also implemented the accounting of the average values ‚Äã‚Äãof the parameters - the readings are read out about once every 2 seconds, and it is necessary to transmit data every 5 minutes to the <a href="https://narodmon.ru/">People‚Äôs Monitoring</a> , naturally the average. <br><br>  Added to the system work with the DS18B20 sensor array.  Data is read alternately with a period of 2 seconds per sensor.  Those.  we are looking for a sensor, we have found - we receive data, after 2 seconds we are looking for the next one, etc.  Ended sensors - starting from the beginning.  Those.  when using only one sensor, the polling period is 4 seconds.  For these sensors, the average values ‚Äã‚Äãare also calculated. <br><br>  The actual data of the power monitor can be obtained via HTTP: <br><br><img src="https://habrastorage.org/webt/l_/uc/jy/l_ucjyu_dm6b55ovjt1dw2dapqe.png"><br><br>  All data is stored in integers when necessary (for example, when transmitted to <a href="https://narodmon.ru/">People's Monitor</a> ) - a point is added to the desired position. <br><br>  Implemented data publishing using <a href="https://habr.com/ru/post/429714/">MQTT / UDP protocol</a> .  Added support for this protocol and sensor PZEM004T to your <a href="https://habr.com/ru/post/426235/">monitor</a> : <br><br><img src="https://habrastorage.org/webt/88/ob/ds/88obdsb96ewvmu611ufwsxqs_ns.png"><br><br>  Implemented the publication of data on public <a href="https://narodmon.ru/">monitoring</a> : <br><br><img src="https://habrastorage.org/webt/8_/g9/me/8_g9mews2dgsubfu31gclmdnhnq.png"><br><br>  The guys from the <a href="https://narodmon.ru/">Popular Monitoring have a</a> big respect!  Data transfer to the service is elementary, there is a means to see incoming data for interaction debugging, you can simply manage the sensor data. <br>  The system can build test charts (below - porridge from charts, just an example): <br><img src="https://habrastorage.org/webt/co/o6/t1/coo6t1yfqzmmjlec0zo7qd2olfg.png"><br><br>  It is also possible to notify about the status of sensors (temporarily turned off the data transfer for the test): <br><img src="https://habrastorage.org/webt/qu/kn/b-/quknb-pfwfe1hxgtf9o_hy_ydgo.png"><br><br>  Naturally, added data publishing settings: <br><img src="https://habrastorage.org/webt/xj/5m/7f/xj5m7fdmyeolxcuxczmfoqlzmxi.png"><br><br><h3>  Results </h3><br>  As a result of monitoring in real time, one of two constantly switched on minicomputers has already been turned off, has configured child hibernation on the computer, has re-tuned the sleep mode in the BD player (used only for karaoke). <br><br>  When the statistics for schedules are typed - I will take further steps. <br><br>  Whoever wants to have such an energy monitor for himself - well in person for the firmware (Freebie, sir!). <br><br><h3>  PS </h3><br>  When developing a device, I ran into mysticism - when powering ESP from a USB computer, from any phone charging - everything works.  When powered from an embedded BP - does not work.  He <a href="https://kiloom.com.ua/simplescope">drew a</a> logical analyzer and a <a href="https://kiloom.com.ua/simplescope">simplescope</a> for investigation - the power supply from the blue block seems to be in order, the signals from ESP are correct, and the reverse is silence.  Another power supply - everything works fine. <br><br>  By scientific method, I realized that when I use an embedded power supply, I connect it to the PZEM004T power supply, that is, in this case, two devices start simultaneously (with other power supplies, simultaneous switching is not possible).  And I use a hardware UART for communication, on which ESP throws out a bunch of garbage when it starts.  PZEM004T can not digest it at startup and freezes.  If the PZEM004T is already on, ESP and the garbage in the port start it without any problems. <br>  The solution was to use SoftwareSerial, everything works fine with it. <br><br><h3>  Pps </h3><br>  For those who want to make such a device for themselves (and there are such heroes!): <br>  You will need: <br><ul><li><div class="spoiler">  <b class="spoiler_title">Energomonitor PZEM004T</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/rt/vc/et/rtvcetmk_esqtqs9htftcvump9w.jpeg"><br></div></div></li><li><div class="spoiler">  <b class="spoiler_title">Module NodeMCU (optimal in size - those that c soldered module ESP12 and not mini)</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/_t/ta/ca/_ttaca0lqb6ctwzubmnhwzag-xq.jpeg"></div></div></li><li>  Power Module for NodeMCU - this board understands power supply 3.3v, 5v, 6..12b - at different inputs. </li><li>  Wires, connectors, racks, housing, buttons, ... - to taste </li><li>  DS18B20 temperature sensors - from 0 to 20pcs </li></ul><br><br>  What to solder: <br>  <b>On the PZEM004T:</b> <br><ul><li>  we modify the resistor - so that the module understands the 3.3v logic, the resistor R17 1 kOhm should be soldered on top of another one the same, reducing the resistance to 0.5 kOhm (or you can replace R17 with 470 Ohm). </li></ul>  <b>On NodeMCU:</b> <br><ul><li>  Power supply of the module - depending on the voltage of the power supply: 3.3V to 3V3, 5V to VU, everything above 5V to Vin </li><li>  Rx and Tx for communication with the power monitor are D6 and D7 respectively.  If it does not work (see below about the light bulb) - swap places </li><li>  DS18B20 sensors - on D5, GND and 3V3 (parasitic power was not tested) </li></ul><br><br>  What does the light bulb say: <br><ul><li>  At the start - a series of three long flashes and then a pause, and so on until the first data is received. </li><li>  After a couple of seconds, data reception should start - 3 ... 4 short flashes, then it goes out - this is the normal mode.  So about every 2 sec.  Rare single flashes are possible. </li><li>  Regular single flashes - data is not accepted, some kind of trouble with an energy monitor or communication channel. </li><li>  Constantly on, or constantly off - some kind of trouble, such blinking modes are not provided. </li></ul><br><br>  What does the FLASH button do (when pressed, the bulb counts down the seconds): <br><ul><li>  Up to 4 seconds - nothing is done </li><li>  4 ... 10 seconds - the access point is turned on without a password.  Connecting to this access point and opening the address <a href="http://192.168.4.1/wifi">http://192.168.4.1/wifi</a> in the browser - you can connect to the router.  The list of available networks can be obtained at <a href="http://192.168.4.1/wifi-scan">http://192.168.4.1/wifi-scan</a> - the first call starts scanning, repeated in 3 ... 5 seconds (no need to hurry) returns the list of networks. </li><li>  More than 10 seconds - reboot. </li></ul><br>  Everything else should be intuitive - just go to the ESP browser and read the list of available services to run through them. <br>  Just in case: MAC for <a href="https://narodmon.ru/">National monitoring</a> can be found in wifi-info. <br>  Perhaps a somewhat non-obvious point - the power monitor settings: <br><img src="https://habrastorage.org/webt/s3/f2/x5/s3f2x5swozibfiahelvdx91l9mc.png"><br>  The time is indicated without separators (the time is above 7:00 and 23:00), and the correction of the counters is indicated in Wh (usually in life used <b>for</b> Wh). </div><p>Source: <a href="https://habr.com/ru/post/453472/">https://habr.com/ru/post/453472/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45346/index.html">Project bwpix - black and white pixelart</a></li>
<li><a href="../453460/index.html">When tired of virtual</a></li>
<li><a href="../453464/index.html">Quantum Future (continued)</a></li>
<li><a href="../45347/index.html">Poppies Survival Guide. Part 1</a></li>
<li><a href="../453470/index.html">Your distributed monoliths weave intrigues behind your back</a></li>
<li><a href="../453474/index.html">Computer control via remote control from the amplifier using Arduino and Node.js</a></li>
<li><a href="../453478/index.html">Studying the health of Starlink satellites Ilona Mask</a></li>
<li><a href="../45348/index.html">Start comparison on GetAFreelancer and oDesk</a></li>
<li><a href="../453480/index.html">Ill-healthy</a></li>
<li><a href="../453482/index.html">Introduction to deep learning using TensorFlow</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>