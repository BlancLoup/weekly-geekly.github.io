<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to reduce the likelihood of errors at the stage of writing code. Note N4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the fourth article where I want to share useful observations about error patterns and how to deal with them. This time I will touch on a topic...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to reduce the likelihood of errors at the stage of writing code. Note N4</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/dae/10d/dd2/dae10ddd2cad34afdb87b27b23fa0c7b.png" alt="PVS-Studio vs Firefox"><br>  This is the fourth article where I want to share useful observations about error patterns and how to deal with them.  This time I will touch on a topic such as handling rare and emergency situations in programs.  Considering many programs, I came to the conclusion that the error handling code in C / C ++ programs is one of the most unreliable places. <br>  What causes such defects?  The program, instead of displaying the message ‚Äúfile X was not found,‚Äù crashes and forces the user to guess what he is doing wrong.  The program for working with the database displays an unintelligible message, instead of reporting that one of the fields is incorrectly filled.  Let's try to fight with this kind of errors that annoy our users. <br><a name="habracut"></a><br><br><h2>  Introduction </h2><br>  Initial information for readers who are not familiar with my previous notes.  They can be found here: <br><ul><li>  <a href="http://habrahabr.ru/blogs/cpp/115143/">Note N1</a> [Miranda IM]; </li><li>  <a href="http://habrahabr.ru/blogs/cpp/116397/">Note N2</a> [Chromium, Return to Castle Wolfenstein, etc.]; </li><li>  <a href="http://habrahabr.ru/blogs/qt_software/123603/">Note N3</a> [Qt SDK]. </li></ul><br>  As always, I will not be abstract, but I'll start with examples.  This time, the examples will be taken from the <a href="http://www.viva64.com/go.php%3Furl%3D762">Firefox</a> source code.  I will try to demonstrate that even in a high-quality and well-known application with error-handling code, this is not the best way.  Defects were found by me using the <a href="http://www.viva64.com/ru/pvs-studio/">PVS-Studio</a> 4.50 analyzer. <br><br><h2>  Error examples </h2><br>  <b>Example N1.</b>  <b>Incomplete check of the integrity of the table</b> <br><pre>  int AffixMgr :: parse_convtable (..., const char * keyword)
 {
   ...
   if (strncmp (piece, keyword, sizeof (keyword))! = 0) {
       HUNSPELL_WARNING (stderr,
                        "error: line% d: table is corrupt \ n",
                        af-&gt; getlinenum ());
       delete * rl;
       * rl = NULL;
       return 1;
   }
   ...
 } </pre><br>  PVS-Studio Diagnostics: V579 for strncmp  It is possibly a mistake.  Inspect the third argument.  affixmgr.cpp 3708 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      An attempt was made here to check the integrity of the table.  Unfortunately, this check may or may not work.  To calculate the length of a keyword, use the sizeof () operator, which is naturally incorrect.  As a result, the efficiency of the code depends on a happy set of circumstances (the length of the keyword, the size of the 'keyword' pointer in the current <a href="http://www.viva64.com/ru/t/0012/">data model</a> ). <br><br>  <b>Example 2. Idle check when reading a file</b> <br><pre>  int PatchFile :: LoadSourceFile (FILE * ofile)
 {
   ...
   size_t c = fread (rb, 1, r, ofile);
   if (c &lt;0) {
     LOG (("LoadSourceFile:"
          "error reading destination file:" LOG_S "\ n",
          mFile));
     return READ_ERROR;
   }
   ...
 } </pre><br>  Diagnostics of PVS-Studio: V547 Expression 'c &lt;0' is always false.  Unsigned type value is never &lt;0. updater.cpp 1179 <br><br>  This is an example when the error handling code is written according to the principle ‚Äúto be‚Äù.  The programmer did not even think about what he actually wrote, and how it would work.  Check is incorrect.  The fread () function returns the number of bytes read using an unsigned type.  Prototype function: <br><pre>  size_t fread ( 
    void * buffer,
    size_t size,
    size_t count,
    FILE * stream 
 ); </pre><br>  Naturally, to store the result, the variable 'c' is used, which has type size_t.  As a result, the test result (c &lt;0) is always false. <br><br>  This is a good example.  At first glance, it seems that there is some kind of verification, but in practice it turns out that it is completely useless. <br><br>  A similar error can be seen in other places: <br><br>  V547 Expression 'c &lt;0' is always false.  Unsigned type value is never &lt;0. updater.cpp 2373 <br><br>  V547 Expression 'c &lt;0' is always false.  Unsigned type value is never &lt;0. bspatch.cpp 107 <br><br>  <b>Example 3. Checking a pointer to NULL after using it</b> <br><pre>  nsresult
 nsFrameSelection :: MoveCaret (...)
 {
   ...
   mShell-&gt; FlushPendingNotifications (Flush_Layout);
   if (! mShell) {
     return NS_OK;
   }
   ...
 } </pre><br>  PVS-Studio Diagnostics: V595 The mShell 'pointer has been verified against nullptr.  Check lines: 1107, 1109. nsselection.cpp 1107 <br><br>  If the pointer is zero, then we must process this special case and return NS_OK from the function.  It is embarrassing that the mShell pointer is already used up to this point. <br><br>  Most likely, this code works, since the mShell pointer is always unequal to NULL.  I give an example to show that one can make a mistake even in very simple checks.  There is a check, but there is no sense from it. <br><br>  <b>Example 4. Checking a pointer to NULL after using it</b> <br><pre>  CompileStatus
 mjit :: Compiler :: performCompilation (JITScript ** jitp)
 {
   ...
   JaegerSpew (JSpew_Scripts,
     "successfully compiled (code \"% p \ ") (size \"% u \ ") \ n",
     (* jitp) -&gt; code.m__code.executableAddress (),
     unsigned ((* jitp) -&gt; code.m_size));

   if (! * jitp)
       return Compile_Abort;
   ...
 } </pre><br>  PVS-Studio Diagnostics: V595 The '* jitp' pointer was used before it was verified against nullptr.  Check lines: 547, 549. compiler.cpp 547 <br><br>  By the way, using the pointer before the check is a common mistake.  This is another example on this topic. <br><br>  <b>Example 5. Incomplete Input Validation</b> <br><pre>  PRBool
 nsStyleAnimation :: AddWeighted (...)
 {
   ...
   if (unit [0] == eCSSUnit_Null || unit [1] == eCSSUnit_Null ||
       unit [0] == eCSSUnit_Null ||  unit [0] == eCSSUnit_URL) {
     return PR_FALSE;
   }
   ...
 } </pre><br>  PVS-Studio Diagnostics: V501 There are identical sub-expressions 'unit [0] == eCSSUnit_Null' |||  operator.  nsstyleanimation.cpp 1767 <br><br>  It seems there are 2 typos here.  It‚Äôs hard to say exactly how the code should look here, but probably they wanted to write this: <br><pre>  if (unit [0] == eCSSUnit_Null || unit [1] == eCSSUnit_Null ||
     unit [0] == eCSSUnit_URL ||  unit [1] == eCSSUnit_URL) { </pre><br>  Due to typos, the function may start processing incorrect input values. <br><br>  <b>Example 6. Incomplete Input Validation</b> <br><pre>  nsresult PresShell :: SetResolution (float aXResolution, float aYResolution)
 {
   if (! (aXResolution&gt; 0.0 &amp;&amp; aXResolution&gt; 0.0)) {
     return NS_ERROR_ILLEGAL_VALUE;
   }
   ...
 } </pre><br>  PVS-Studio diagnostics: V501 operator: aXResolution&gt; 0.0 &amp;&amp; aXResolution&gt; 0.0 nspresshell.cpp 5114 <br><br>  And here is another example of unsuccessful verification of input parameters.  This time, due to a typo, the value of the aYResolution argument is not checked. <br><br>  <b>Example 7. Untranslated pointer</b> <br><pre>  nsresult
 SVGNumberList :: SetValueFromString (const nsAString &amp; aValue)
 {
   ...
   const char * token = str.get ();
   if (token == '\ 0') {
     return NS_ERROR_DOM_SYNTAX_ERR;  // nothing between commas
   }
   ...
 } </pre><br>  Diagnostics of PVS-Studio: V528 It is odd that the pointer to the 'char' type is compared with the '\ 0' value.  Probably meant: * token == '\ 0'.  svgnumberlist.cpp 96 <br><br>  Verifying that there is nothing between the commas does not work.  To find out if the string is empty or not, you can compare the first character with '\ 0'.  But here it is not the first character that is compared with zero, but the pointer.  This pointer is always unequal to zero.  The correct check should look like this: (* token == '\ 0'). <br><br>  <b>Example 8. Incorrect type for index storage</b> <br><pre>  PRBool 
 nsIEProfileMigrator :: TestForIE7 ()
 {
   ...
   PRUint32 index = ieVersion.FindChar ('.', 0);
   if (index &lt;0)
     return PR_FALSE;
   ...
 } </pre><br>  Diagnostics of PVS-Studio: V547 Expression 'index &lt;0' is always false.  Unsigned type value is never &lt;0. nsieprofilemigrator.cpp 622 <br><br>  The function will not return PR_FALSE if there is no dot in the line and continues to work with incorrect data.  The error is that the unsigned data type is selected for the 'index' variable.  Check (index &lt;0) does not make sense. <br><br>  <b>Example 9. Forming the wrong error message</b> <br><pre>  cairo_status_t
 _cairo_win32_print_gdi_error (const char * context)
 {
   ...
   fwprintf (stderr, L "% s:% S", context, (wchar_t *) lpMsgBuf);
   ...
 } </pre><br>  Diagnostics of PVS-Studio: V576 Incorrect format.  Consider checking the fwprintf function.  Wchar_t type symbols is expected.  cairo-win32-surface.c 129 <br><br>  Even if the error is successfully detected, it still needs to be able to properly handle.  And since no one tests error handlers either, there you can see a lot of interesting things. <br><br>  The _cairo_win32_print_gdi_error () function will print the abracadabra.  As a third argument, the fwprintf () function expects a pointer to a unicode string, and instead receives a string in the format 'const char *'. <br><br>  <b>Example 10. Error writing dump</b> <br><pre>  bool ExceptionHandler :: WriteMinidumpForChild (...)
 {
   ...
   DWORD last_suspend_cnt = -1;
   ...
   // this thread may have already died
   // the handle is a non-fatal error
   if (NULL! = child_thread_handle) {
     if (0 &lt;= (last_suspend_cnt =
                 SuspendThread (child_thread_handle))) {
   ...
 } </pre><br>  Diagnostics of PVS-Studio: V547 Expression is always true.  Unsigned type value is always&gt; = 0. Exception_handler.cc 846 <br><br>  This is another example in the error handler.  Here, the result returned by the SuspendThread function is incorrectly processed.  The variable last_suspend_cnt is of type DWORD, which means it will always be greater than or equal to 0. <br><br><h2>  About other bugs in Firefox </h2><br>  I will make a small digression and tell you about the results of checking Firefox in general.  The project is qualitative, and PVS-Studio revealed few errors.  However, since it is large, there are a lot of errors in quantitative terms.  Unfortunately, I was not able to fully examine the report issued by the PVS-Studio tool.  The fact is that for Firefox there is no project file for Visual Studio.  The project was checked by the console version of PVS-Studio, called from the make-file.  By opening a report in Visual Studio, you can view all diagnostic messages.  But since there is no project, Visual Studio does not suggest where any variables are declared, does not allow to go to the place where the macros are defined, and so on.  As a result, the analysis of an unknown project is extremely time-consuming, and I was able to study only part of the messages. <br><br>  Mistakes are diverse.  For example, there is a way out of the array: <br><pre>  class nsBaseStatis: public nsStatis {
 public:
   ...
   PRUint32 mLWordLen [10]; 
   ...
   nsBaseStatis :: nsBaseStatis (...)
   {
     ...
     for (PRUint32 i = 0; i &lt;20; i ++)
        mLWordLen [i] = 0;
     ...
   }
   ...
 }; </pre><br>  Diagnostics of PVS-Studio: V557 Array overrun is possible.  The value of 'i' index could reach 19. detectcharset.cpp 89 <br><br>  Although this and similar errors are interesting, they are not related to the topic of this article.  Therefore, if interested, you can look at some other errors in this file: <a href="http://www.viva64.com/external-pictures/txt/mozilla-test.txt">mozilla-test.txt</a> . <br><br><h2>  Let's return to errors in error handlers. </h2><br>  I decided to cite not a couple, but 10 examples to convince you of the urgency of the problems of defects in error handlers.  Of course, error handlers are not the most critical and important parts of the program.  But after all, programmers write them, which means they hope to improve the behavior of the program with their help.  Unfortunately, as my observations show, very often checks and error handlers do not work.  Look, it was enough for me one, albeit a large project, to show a lot of errors of this type. <br><br>  What to do with it and what recommendations can be given? <br><br><h2>  First recommendation </h2><br>  It must be admitted that you can make a mistake even in a simple check.  This is the most difficult and important.  It is precisely because error handlers are considered to be simple code fragments, there are so many typos and other defects.  Error handlers are not tested and not tested.  They do not write tests. <br><br>  Of course, writing tests for error handlers is very difficult and often not economically feasible.  But if the programmer at least knows about the danger, this is already a lot.  Aware, it means armed.  With error handlers, you can make this analogy. <br><br>  According to statistics, climbers often fall at the end of the climb.  This happens not because of fatigue, but because the person thinks that he has very little left.  He relaxes, loses attentiveness and, as a result, makes mistakes more often.  Something similar happens to the programmer when writing code.  He spends a lot of effort and attention on the algorithm, and writes various checks without focusing, as he is sure that he cannot make a mistake in them. <br><br>  So now you are warned.  And I am sure that this is already very good and useful. <br><br>  If you say that such stupid mistakes are made only by students and inexperienced programmers, then you are wrong.  Typos are easy to do.  I offer this small note on this topic: ‚Äú <a href="http://www.viva64.com/ru/b/0116/">The second myth - professional developers do not make stupid mistakes</a> ‚Äù.  I can confirm this with many examples from various projects.  But I think that it‚Äôs quite enough to think about it. <br><br><h2>  Second recommendation </h2><br>  Dump saving mechanisms, logging functions and other similar auxiliary mechanisms deserve to be made unit tests for them. <br><br>  The non-working mechanism for saving a dump is not only useless, it only creates the appearance that in case of trouble it can be used.  If a user sends a corrupted dump-file, then it will not only not help, but it can only be misleading and more time will be spent searching for errors than if the dump-file were completely absent. <br><br>  The recommendation looks simple and obvious.  But do many of those reading this note have unit tests to test the WriteMyDump class? <br><br>
<h2>  Third recommendation </h2><br>  Use static code analyzers.  The possibility of finding defects in error handlers is one of the strengths of the <a href="http://www.viva64.com/go.php%3Furl%3D636">static analysis</a> methodology.  Static analysis covers all branches of a code, regardless of the frequency of their use in a running application.  He can identify errors that manifest themselves extremely rarely. <br><br>  In other words, with static analysis, the <a href="http://www.viva64.com/go.php%3Furl%3D760">code coverage</a> is 100%.  To achieve such code coverage with the help of other types of testing is almost impossible.  Code coverage for unit tests and regression testing is usually less than 80%.  The remaining 20% ‚Äã‚Äãis very difficult to test.  These 20% include the majority of error handlers and rare situations. <br><br><h2>  Fourth recommendation </h2><br>  You can try to use the methodology <a href="http://www.viva64.com/go.php%3Furl%3D759">for making faults</a> .  The point is that a number of functions from time to time begin to return various error codes, and the program should correctly process them.  For example, you can write your own malloc () function, which from time to time will return NULL, even if the memory is still there.  This will let you know how the program will behave when the memory really ends.  Similarly, you can do with functions such as fopen (), CoCreateInstance (), CreateDC (), and so on. <br><br>  There are special programs that allow you to automate this process and not to write your own functions, which sometimes lead to failure.  Unfortunately, I did not work with such systems, so I find it difficult to tell about them in more detail. <br><br><h2>  Conclusion </h2><br>  Defects in error handlers are common.  Unfortunately, I am not sure that the recommendations given in the article are sufficient to avoid them.  But I hope that you are interested in this problem, and you can think of ways to reduce the number of shortcomings in your programs.  Also, I and other readers will be grateful if you share your ideas and methodologies that will allow you to avoid the errors of the considered type. </div><p>Source: <a href="https://habr.com/ru/post/134571/">https://habr.com/ru/post/134571/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134564/index.html">Air cooling server DIY</a></li>
<li><a href="../134567/index.html">Node.JS on Android if Android is hired</a></li>
<li><a href="../134568/index.html">Ant + Tomcat: a little routine automation</a></li>
<li><a href="../134569/index.html">Channel.me ‚Üí co-viewing sites</a></li>
<li><a href="../134570/index.html">Google has bought a developer virtual assistant for smartphones</a></li>
<li><a href="../134572/index.html">Homemade game controller for Nokia N900</a></li>
<li><a href="../134573/index.html">Combined Forms and Defaults</a></li>
<li><a href="../134574/index.html">How to create a visual image library with HTML5 Canvas</a></li>
<li><a href="../134578/index.html">Games for CANVAS / WebGL (part two)</a></li>
<li><a href="../134580/index.html">CANVAS / WebGL Games</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>