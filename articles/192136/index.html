<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Building a provider network on Cisco switches using Option 82 and Dynamic ARP Inspection</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Prologue 
 On Habr√© there were quite a few topics describing certain options for building provider networks, including using the technologies specifie...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Building a provider network on Cisco switches using Option 82 and Dynamic ARP Inspection</h1><div class="post__text post__text-html js-mediator-article"><h4>  Prologue </h4><br>  On Habr√© there were quite a few topics describing certain options for building provider networks, including using the technologies specified in the header.  In part, they helped me in solving my task, but I had to dig a lot myself.  I want to share what happened and try to save time for followers. <br><br><br clear="all"><img src="https://habrastorage.org/getpro/habr/post_images/183/60d/d5b/18360dd5b938864a94268485cf18a8fd.jpg" alt="image"><br><br><h4>  So, the task setting: </h4><br>  It is necessary to organize a network that is as convenient for the end user as possible, and also convenient (in terms of minimum load on technical support) and safe (in terms of fraud) for the operator.  In addition, the network should be inexpensive.  Someone will argue that Cisco and ‚Äúinexpensive‚Äù are incompatible concepts, however, End of Life also suits old men, which can be purchased at very affordable prices. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To ensure user convenience, the following options were dropped: <br><ul><li>  static assignment of ip-addresses is inconvenient for the user, the address needs to be recorded somewhere, users who have lost the address are called to tech support </li><li>  dhcp with mac-address binding is inconvenient for the user, when changing the device, you need to re-register it with the provider or change the mac on it. </li><li>  all kinds of tunnels, mainly pptp - requires configuration at the client, forgotten logins and passwords </li></ul><br>  Of all the options considered for the user, the most convenient option is with DHCP, but for the provider there are a number of difficulties: <br>  Binding on mac is inconvenient, since you will have to re-register new mac-addresses.  User authentication in billing only by ip-address also seems unreliable at first glance, a cunning user can manually set his neighbor‚Äôs ip-address and introduce confusion.  However, there is a solution and it is built on technologies from the title of the article - <b>option 82</b> and <b>dynamic arp inspection</b> <br><br>  Who cares a solution - I ask under the cat <br><a name="habracut"></a><br><br><h4>  Decision </h4><br>  The DHCP server for issuing addresses will be guided by option 82, which determines from which physical port of the switch a request for an address came.  Thus, we achieve that Vasya Pupkin from the 14th apartment, whose cable is connected to the 7th port of our SW-01 switch, will always receive the address 10.10.1.7, for example, regardless of what device he connects to his cable.  This approach allows us to identify Vasya Pupkin only by IP-address, but there is a problem.  Neighbor Jora, who does not want to pay for the Internet, will put his hands on Vasya Pupkin‚Äôs address, will create an IP address conflict on the network and will use the Internet at the expense of Vasya. <br><br>  To prevent this from happening, there is Dynamic ARP Inspection technology.  The essence of the technology comes down to checking the mac + ip bundles received from the DHCP server and comparing them with ARP requests arriving at the port.  Thus, even if the neighbor Jora set himself the same mac and IP as Vasya‚Äôs, the switch will check if DHCP has sent such an IP to this port on this port.  If not issued, the packet will be dropped. <br><br><h4>  Actually setting </h4><br>  We have two switches at our disposal: <b>Cisco 2950-24</b> and <b>Cisco 2960-24-TT-L</b> <br>  Switch 2950 will be used to connect subscribers.  It is configured with Management vlan 254 for management. <br>  Switch IP - <b>10.0.254.10</b> , mac - <b>00: 11: 92: 1B: 3A: 00</b> <br><br>  The 2960 switch will act as a DHCP server and handle the ARP inspection task. <br>  Switch IP - <b>10.0.254.2</b> , mac - <b>00: 16: C8: D7: D2: 80</b> <br><br>  MAC can be viewed with the <b>show version</b> command <br><br><pre><code class="bash hljs">cisco WS-C2950-24 (RC32300) processor (revision P0) with 19911K bytes of memory. Processor board ID FOC0825Z1GD Last reset from system-reset Running Standard Image 24 FastEthernet/IEEE 802.3 interface(s) 32K bytes of flash-simulated non-volatile configuration memory. Base ethernet MAC Address: 00:11:92:1B:3A:00</code> </pre> <br>  The 2950 switch does not support Dynamic ARP Inspection, but we can solve this problem on the upstream switch.  In the example, <b>Cisco 2960-24-TT-L is</b> used as such a switch, although it is more appropriate to use an L3 switch, for example, <b>3550-12T</b> or <b>3550-12G</b> , then it can solve the Inter-VLAN Routing task too. <br><br>  And so, on the C2950, ‚Äã‚Äãwe configure the following: <br><br><ol><li>  In the global configuration mode, we indicate the need to add options to the dhcp-relay message: <br><pre> <code class="bash hljs">ip dhcp relay information option</code> </pre><br></li><li>  In the settings of the management interface, specify that DHCP requests should be sent to the 2960th switch at 10.0.254.2 <br><pre> <code class="bash hljs">interface Vlan254 ip address 10.0.254.10 255.255.255.0 ip helper-address 10.0.254.2</code> </pre><br></li><li>  In global configuration mode, enable <b>DHCP snooping</b> for all our vlans. <br><pre> <code class="bash hljs">ip dhcp snooping vlan 10 ip dhcp snooping vlan 20 ip dhcp snooping vlan 254 ip dhcp snooping</code> </pre><br></li><li>  Determine that DHCP offer is allowed only from port 24, to which the upstream 2960 with a DHCP server is connected. <br><pre> <code class="bash hljs">interface FastEthernet0/24 ip dhcp snooping trust</code> </pre><br></li></ol><br><br>  Configuration C2960 is a bit more complicated: <br><br><ol><li>  For each user, you must create an entry <b>ip dhcp class</b> <br><pre> <code class="bash hljs">ip dhcp class user01 remark SW2950-1 port 01 relay agent information relay-information hex 01060004000a0001020800060011921b3a00</code> </pre><br>  It is enough to specify only <b>relay-information</b> in the class, but for convenience it is also recommended to use the comment <b>remark</b> , in which you can write, for example, subscriber data. <br>  Here the most important thing is to understand the principle of forming the hex-string.  This is 18 bytes contained in option 82 <br>  Its content consists of two fields: <b>circuit-id</b> and <b>remote-id</b> <br>  <b>The circuit-id</b> contains the vlan number and the physical port number from which the dhcp request came. <br>  <b>The remote-id</b> contains the mac-address of the switch that sent this request. <br>  This line can be extracted with the wireshark analyzer, but it is inconvenient to do this for each subscriber, so let's consider how to generate it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f80/8a1/4e8/f808a14e8c02312e071e9d780f94e466.png" alt="image"><br></li><li>  After creating dhcp-classes for subscribers, we will configure pools of addresses for each vlan <br><br>  The rental time is 5 minutes.  This is necessary so that when a new device with a different address is connected to its port, the subscriber quickly gets the address to it.  Otherwise there will be an error that this pool is exhausted, since there is only 1 address in it.  In addition, the rest of the dhcp-pool settings, such as gateway, dns, etc., are omitted in the example. <br><br><pre> <code class="bash hljs">ip dhcp pool vlan10 network 10.0.10.0 255.255.255.0 lease 0 0 5 class user01 address range 10.0.10.11 10.0.10.11 class user02 address range 10.0.10.12 10.0.10.12</code> </pre><br></li><li>  It is necessary to configure the corresponding ip-interfaces for each pool on the switch.  This is done via <b>interface vlan</b> <br>  Despite the fact that the C2960 is a second-level switch, it allows you to keep several ip interfaces active, but cannot route traffic between them. <br><pre> <code class="bash hljs">interface Vlan10 ip address 10.0.10.2 255.255.255.0 ! interface Vlan20 ip address 10.0.20.2 255.255.255.0 ! interface Vlan254 ip address 10.0.254.2 255.255.255.0</code> </pre><br></li><li>  On this switch, we also need to configure dhcp-snooping, since this option forms the base for mapping the issued IP addresses to the mac addresses. <br>  Using the <b>ip dhcp snooping database</b> command, we will determine the storage location for the database, in the example it will be stored in the <b>dhcp</b> file on the flash.  You can also specify ftp, tftp, http, https, scp and other url as storage locations. <br>  The <b>ip dhcp snooping information option allow-untrusted</b> command allows receiving requests with option 82 from all switch ports. <br><pre> <code class="bash hljs">ip dhcp snooping vlan 10 ip dhcp snooping vlan 20 ip dhcp snooping information option allow-untrusted ip dhcp snooping database flash:dhcp ip dhcp snooping</code> </pre><br></li><li>  At the moment, we have a binding ip-address to the physical port of the switch.  It remains to configure Dynamic ARP Inspection.  This is done in one simple command: <br><pre> <code class="bash hljs">ip arp inspection vlan 10,20</code> </pre><br></li></ol><br><h4>  Proof of concept </h4><br>  Let's check the address assignment to the client connected to the 9th switch port.  The port is in the 20th vlan, according to our scheme, the client should receive the address 10.0.20.9 <br><br>  Let's <u>form the</u> value hex: 01060004 <b>0014</b> <i>0008</i> 02080006 <u>0011921b3a00</u> <br>  where <b>0014</b> is the 20th vlan, <br>  <i>0008</i> - 9th switch port <br>  <u>0011921b3a00</u> - his mac. <br><br><pre> <code class="bash hljs">ip dhcp class user09 remark SW2950-1 port 09 relay agent information relay-information hex 0106000400140008020800060011921b3a00 ip dhcp pool vlan20 network 10.0.20.0 255.255.255.0 lease 0 0 5 class user09 address range 10.0.20.9 10.0.20.9</code> </pre><br><br>  So this exchange looks like in wireshark: <br><img src="https://habrastorage.org/storage3/68c/c0f/3ff/68cc0f3ff4d4ee14b5199f40baadaf51.png"><br><br>  And this is what the output of the <b>debug ip dhcp server events</b> command looks like. <br><br><pre> <code class="bash hljs">2d00h: DHCPD: Sending notification of DISCOVER: 2d00h: DHCPD: htype 1 chaddr 000a.e45b.dcc6 2d00h: DHCPD: remote id 00060011921b3a00 2d00h: DHCPD: circuit id 000400140008 2d00h: DHCPD: interface = Vlan20 2d00h: DHCPD: class id 4d53465420352e30 2d00h: DHCPD: out_vlan_id 0 2d00h: DHCPD: DHCPOFFER notify setup address 10.0.20.9 mask 255.255.255.0 2d00h: DHCPD: Sending notification of ASSIGNMENT: 2d00h: DHCPD: address 10.0.20.9 mask 255.255.255.0 2d00h: DHCPD: htype 1 chaddr 000a.e45b.dcc6 2d00h: DHCPD: lease time remaining (secs) = 300 2d00h: DHCPD: interface = Vlan20 2d00h: DHCPD: out_vlan_id 0</code> </pre><br>  <b>000a.e45b.dcc6</b> - client mac-address <br>  Now we connect another laptop to the same port. <br><br><pre> <code class="bash hljs">2d00h: DHCPD: Sending notification of DISCOVER: 2d00h: DHCPD: htype 1 chaddr 089e.012b.6ce1 2d00h: DHCPD: remote id 00060011921b3a00 2d00h: DHCPD: circuit id 000400140008 2d00h: DHCPD: interface = Vlan20 2d00h: DHCPD: class id 4d53465420352e30 2d00h: DHCPD: out_vlan_id 0 2d00h: DHCPD: no free address within the address range <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> class user09 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> pool vlan20 2d00h: DHCPD: Sending notification of ASSIGNMENT FAILURE:</code> </pre><br>  First, we receive a message stating that there are no free addresses in the pool (since 5 minutes allocated to renting this address to another Mac have not yet expired). <br>  However, after a while we get the address we need, but already for a client with a poppy <b>08-9e-01-2b-6c-e1</b> <br><br><pre> <code class="bash hljs">2d00h: DHCPD: Sending notification of DISCOVER: 2d00h: DHCPD: htype 1 chaddr 089e.012b.6ce1 2d00h: DHCPD: remote id 00060011921b3a00 2d00h: DHCPD: circuit id 000400140008 2d00h: DHCPD: interface = Vlan20 2d00h: DHCPD: class id 4d53465420352e30 2d00h: DHCPD: out_vlan_id 0 2d00h: DHCPD: Adding binding to radix tree (10.0.20.9) 2d00h: DHCPD: Adding binding to <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span> tree 2d00h: DHCPD: assigned IP address 10.0.20.9 to client 0108.9e01.2b6c.e1. (316 0) 2d00h: DHCPD: DHCPOFFER notify setup address 10.0.20.9 mask 255.255.255.0 2d00h: DHCPD: Sending notification of ASSIGNMENT:</code> </pre><br>  Now we‚Äôll check if our client‚Äôs neighbor, connected to switch port 10, can manually set the address 10.0.20.9 <br>  Since the Cisco 2950 does not support Dynamic ARP Inspection, this technology needs to be configured on the Cisco 2960 upstream switch. <br>  The <b>show ip dhcp snooping binding</b> command on the C2960 will show the binding of IP addresses to mac <br><br><pre> <code class="bash hljs">MacAddress IpAddress Lease(sec) Type VLAN Interface ------------------ --------------- ---------- ------------- ---- -------------------- 08:9E:01:2B:6C:E1 10.0.20.9 288 dhcp-snooping 20 FastEthernet0/1 Total number of bindings: 1</code> </pre><br>  FastEthernet0 / 1 is a 2960 switch interface, which includes a downstream 2950. <br><br>  We will connect a computer with the manually configured address 10.0.20.9 to the 10th port of the C2950 <br>  And right there we will see an error notification, from which it can be seen that it occurred in the 20th vlan on the 1st switch port.  In addition, we see the ip and poppy addresses that caused the error.  <b>000a.e45b.dcc6 / 10.0.20.9 /</b> <br><br><pre> <code class="bash hljs">2d01h: %SW_DAI-4-DHCP_SNOOPING_DENY: 1 Invalid ARPs (Req) on Fa0/1, vlan 20.([000a.e45b.dcc6/10.0.20.9/0000.0000.0000/10.0.20.9/23:48:25 EEST Mon Sep 2 2013])</code> </pre><br>  You can find out who specifically tried to cheat by visiting the C2950 switch and looking at the switching table <br><br><pre> <code class="bash hljs">SW2950-1<span class="hljs-comment"><span class="hljs-comment">#show mac-address-table Mac Address Table ------------------------------------------- Vlan Mac Address Type Ports ---- ----------- -------- ----- 20 000a.e45b.dcc6 DYNAMIC Fa0/10 20 089e.012b.6ce1 DYNAMIC Fa0/9</span></span></code> </pre><br>  We see that the mac we are interested in is hanging on port 10. <br><br>  On this, perhaps, everything, additional information can be found in these articles: <br><br>  <a href="http://habrahabr.ru/post/87920/">Features and DHCP settings on Cisco routers</a> <br>  <a href="http://habrahabr.ru/post/89997/">Features and DHCP settings on Cisco routers (Part 2)</a> <br>  <a href="http://habrahabr.ru/post/108453/">IPoE, as well as Client-VLAN and DHCP Option 82</a> <br>  <a href="http://habrahabr.ru/post/170371/">IPoE problem</a> - I'd add from myself that there is just no problem if everything is set up correctly. <br>  <a href="http://habrahabr.ru/post/192022/">The link-level attack of ARP-spoofing and how to protect a Cisco switch</a> is a good article showing another benefit from Dynamic ARP Inspection - improving network security in general. </div><p>Source: <a href="https://habr.com/ru/post/192136/">https://habr.com/ru/post/192136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../192124/index.html">String interpolation. Fairy Tale</a></li>
<li><a href="../192126/index.html">OS / 2 Death: Killing or Self-Shot?</a></li>
<li><a href="../192128/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ72 (August 24 - 31, 2013)</a></li>
<li><a href="../192130/index.html">foreach</a></li>
<li><a href="../192134/index.html">We get the source code VM / 370</a></li>
<li><a href="../192140/index.html">Undocumented features of undocumented features: Transfer ref to another stream</a></li>
<li><a href="../192144/index.html">CLR Exception Filters</a></li>
<li><a href="../192146/index.html">Copy works in the public domain? National Indian hut to help you</a></li>
<li><a href="../192150/index.html">Installation Guide and Guide for Web Deploy in Windows Server 2008 R2</a></li>
<li><a href="../192152/index.html">The digest of news from the world of mobile development for the last week ‚Ññ22 (August 26 - September 1, 2013)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>