<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Writing an online game on NodeJS, Express and Socket.IO</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% habraname%! 



 *** This material contains logical errors in the game itself, but this does not affect the technical content of the article, the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Writing an online game on NodeJS, Express and Socket.IO</h1><div class="post__text post__text-html js-mediator-article"><h4>  Hi% habraname%! </h4><br><br><img src="https://habrastorage.org/storage1/b7ff2e39/1f20fdde/2e01c662/c30c3eaf.png"><br><br><h6>  *** This material contains logical errors in the game itself, but this does not affect the technical content of the article, the purpose of which is not to play, but to figure out how to work with the tools indicated in the title.  <a href="http://habrahabr.ru/blogs/nodejs/132676/">Continued.</a>  <a href="http://habrahabr.ru/blogs/nodejs/132676/">We bring the game to working condition, taking into account all the errors described in the comments</a> </h6>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Few people today can say they don‚Äôt know about NodeJS, lately they talk and write a lot about it. <br>  I started my journey of acquaintance with NodeJS six months ago, then for me it was just interesting and new, I couldn‚Äôt have thought that in six months it would become my main development tool. <br><br>  Since all the training material is either an article about asynchrony, or how to write your server or chat, I did not find anything interesting for myself in the training material.  He wrote on the sly different small applications that partially replaced the background work of php in different projects. <br><br>  But now I feel strong enough to write a full-fledged training and not dull material from a beginner to a real working application.  This is not just an application, but an online game using the most popular tools Express and Socket.IO, yes, yes, a multiplayer that any average statistical js developer can make. <br><br>  The fact that such Express and Socket.IO have already been written in many places, so I will not describe again, paying more attention to the development process. <br><br>  For a start, I wanted to choose the good old tanchiki and I didn‚Äôt choose well, it would be sad to write it second in Habr√© :) <br>  I decided not to complicate the process of developing graphics and take a simple game, so my choice fell on tic-tac-toe, but to complicate my task, it was decided to make it universally, with the ability to set any size of the playing field and any number of moves to win. <br><br>  And so it is decided!  I start to do tic-tac-toe. <br><a name="habracut"></a><br>  We will determine the structure of the future game, what we need as a result of: <br><ul><li>  Some kind of general interface with information about the game </li><li>  UI playing field with handlers </li><li>  Server part with all the logic of the game </li></ul><br><br>  I started the development as usual with the interface.  I chose the jQuery framework and jQueryUI respectively. <br><br>  Creating a page and connecting the necessary styles and libraries jquery, jqueryUI: <br><pre><code class="javascript hljs">&lt;link rel=<span class="hljs-string"><span class="hljs-string">"stylesheet"</span></span> href=<span class="hljs-string"><span class="hljs-string">"http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/themes/vader/jquery-ui.css"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="undefined"></span><span class="hljs-tag"><span class="xml"><span class="undefined"></span><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;script src=<span class="hljs-string"><span class="hljs-string">"http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  The interface is a status line, a sidebar of statistics and the playing field itself, everything is done with simple tables: <br><pre> <code class="javascript hljs">&lt;table border=<span class="hljs-string"><span class="hljs-string">"0"</span></span> width=<span class="hljs-string"><span class="hljs-string">"100%"</span></span>&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">colspan</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"status"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"ui-widget ui-state-hover ui-corner-all"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">  ...</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;tbody&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"stats"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"ui-widget"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">valign</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"top"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"reload"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">button</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">br</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;td id=<span class="hljs-string"><span class="hljs-string">"board"</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"ui-widget"</span></span> valign=<span class="hljs-string"><span class="hljs-string">"top"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"masked"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"ui-widget-shadow ui-corner-all ui-widget-overlay"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;table <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span></span>=<span class="hljs-string"><span class="hljs-string">"ui-widget ui-corner-all"</span></span> cellpadding=<span class="hljs-string"><span class="hljs-string">"0"</span></span> cellspacing=<span class="hljs-string"><span class="hljs-string">"0"</span></span> align=<span class="hljs-string"><span class="hljs-string">"left"</span></span> id=<span class="hljs-string"><span class="hljs-string">"board-table"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">table</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;<span class="hljs-regexp"><span class="hljs-regexp">/td&gt; &lt;/</span></span>tbody&gt; <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">table</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  I think there is nothing to comment on, everything is more than clear.  Next, CSS was quickly sketched and I started writing client event handling. <br><br>  All the code tried to write as clean and logical as possible with the expectation that this is educational material that should teach only good things even in small things :) <br><br>  A game object has been created: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> TicTacToe = { <span class="hljs-attr"><span class="hljs-attr">gameId</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-comment"><span class="hljs-comment">//      ID . turn: null, //    ,   X  O i: false, //   ,    init: function() { ... }, //         startGame: function (gameId, turn, x, y) { ... }, //         mask: function(state) { ... }, //    ,            :) move: function (id, turn, win) { ... }, //      endGame: function (turn, win) { ... } //  ,   }</span></span></code> </pre> <br><br>  Now we will consider each function in turn, commented as much as possible, and so Init (): <br><pre> <code class="javascript hljs">$(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// UI    $('#reload').button({icons:{primary:'ui-icon-refresh'}}).click(function(){window.location.reload();}); //    nodejs  socket.io var socket = io.connect(window.location.hostname + ':1337', {resource: 'api'}); //   event' ()   socket.io //  socket.on('connect', function () { $('#status').html('    '); }); //  socket.on('reconnect', function () { $('#connect-status').html(',  '); }); //   socket.on('reconnecting', function () { $('#status').html('   , ...'); }); //  socket.on('error', function (e) { $('#status').html(': ' + (e ? e : ' ')); }); //        //   socket.on('wait', function(){ $('#status').append('...  ...'); }); //   socket.on('exit', function() { //           TicTacToe.endGame(TicTacToe.turn, 'exit'); }); //    ,   //  ID ,        xy socket.on('ready', function(gameId, turn, x, y) { $('#status').html('   !  ! ' + (turn == 'X' ? '   ' : '  ') + '!'); //        TicTacToe.startGame(gameId, turn, x, y); //     ,    :) $('#stats').append($('&lt;div/&gt;').attr('class', 'turn ui-state-hover ui-corner-all').html(' : &lt;b&gt;' + (turn=='X'?'':'') + '&lt;/b&gt;')); //       ,   $("#board-table td").click(function (e) { //  ,      ID   ID  ,    XxY if(TicTacToe.i) socket.emit('step', TicTacToe.gameId, e.target.id); //        }).hover(function(){ $(this).toggleClass('ui-state-hover'); }, function(){ $(this).toggleClass('ui-state-hover'); }); }); //   socket.on('step', function(id, turn, win) { //  ID ,      . win          TicTacToe.move(id, turn, win); }); //  socket.on('stats', function (arr) { var stats = $('#stats'); stats.find('div').not('.turn').remove(); for(val in arr) { stats.prepend($('&lt;div/&gt;').attr('class', 'ui-state-hover ui-corner-all').html(arr[val])); } }); });</span></span></code> </pre><br><br>  Now let's take a closer look at how the game starts: <br><pre> <code class="javascript hljs">startGame: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gameId, turn, x, y</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ID  this.gameId = gameId; //    this.turn = turn; //   ,  X        :) this.i = (turn == 'X'); //    var table = $('#board-table').empty(); //      for(var i = 1; i &lt;= y; i++) { var tr = $('&lt;tr/&gt;'); for(var j = 0; j &lt; x; j++) { //        ID  X  Y  (id="2x3") tr.append($('&lt;td/&gt;').attr('id', (j+1) + 'x' + i).addClass('ui-state-default').html(' ')); } table.append(tr); } //   $("#board").show(); //     ,   this.mask(!this.i); },</span></span></code> </pre> <br><br>  I will not describe the function of the mask, everything is trite there. <br>  Further function get the player's turn: <br><pre> <code class="javascript hljs">move: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, turn, win</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  : ID    ,  ,     this.i = (turn != this.turn); //    $("#" + id).attr('class', 'ui-state-hover').html(turn); //     if (!win) { //   ,   this.mask(!this.i); //        $('#status').html(' ' + (this.i ? ' ' : ' ')); //   } else { this.endGame(turn, win); //    ,   } },</span></span></code> </pre> <br><br>  Completion of the game: <br><pre> <code class="javascript hljs">endGame: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">turn, win</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  :   ,    var text = ''; //     3  switch(win) { case 'none': text = '!'; break; //     case 'exit': text = '    !  '; break; //    default: text = ' ' + (this.i ? '! =(' : '! =)'); //   } //        $("&lt;div/&gt;").html(text).dialog({ title: ' ', modal: true, closeOnEscape: false, resizable: false, buttons: { "  ": function() { $(this).dialog("close"); window.location.reload(); }}, close: function() { window.location.reload(); } }); }</span></span></code> </pre> <br><br>  That's all!  All created files put in a new folder named public. <br><br><h5>  Was the client part too easy?  The server part is a bit more complicated! </h5><br><br>  Install the necessary modules: <br><pre> <code class="javascript hljs">npm install express npm install socket.io</code> </pre> <br><br>  Create a starting index.js file, so far simple, let's deal with it: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    var express = require('express'), socketio = require('socket.io'); //      express var app = express.createServer(); //        express  //      ,      var io = socketio.listen(app); //   express    app.use(express.static(__dirname + '/public')); //       app.listen(80); //     socket.io       3,     io.set('log level', 3); //     ,     /socket.io io.set('resource', '/api');</span></span></code> </pre> <br><br>  Now we write the same thing but without comments and in a simplified form, so cleaner: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>), app = express.createServer(), io = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>).listen(app), TicTacToe = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./models/tictactoe'</span></span>); app.use(express.static(__dirname + <span class="hljs-string"><span class="hljs-string">'/public'</span></span>)); app.listen(<span class="hljs-number"><span class="hljs-number">1337</span></span>); io.set(<span class="hljs-string"><span class="hljs-string">'log level'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); io.set(<span class="hljs-string"><span class="hljs-string">'resource'</span></span>, <span class="hljs-string"><span class="hljs-string">'/api'</span></span>);</code> </pre> <br><br>  If you noticed here I also added a model <br><pre> <code class="javascript hljs">TicTacToe = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./models/tictactoe'</span></span>);</code> </pre> <br>  we will write it now, create a folder next to index.js with the name models and create a file tictactoe.js in it <br>  This is a regular module in nodejs and will be used by the export function, it will be the heart of our game, all the logic. <br><br>  Since we are writing an online game, we should initially have the architecture of the server application in the form of user objects, the game and their collections. <br><br>  Create the main objects: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,  ,          var TicTacToe = module.exports = function() { //  id  =   this.games = []; //    = id  this.users = []; //        this.free = []; //   this.x = 6; this.y = 6; //    this.stepsToWin = 4; } //  ,       var GameItem = function(user, opponent, x, y, stepsToWin) { //        this.board[id  ] =   this.board = []; //  this.user = user; // X this.opponent = opponent; // O //   this.x = x; this.y = y; //    this.stepsToWin = stepsToWin; // -   this.steps = 0; }</span></span></code> </pre><br><br>  Thus, when our server is launched, it creates the TicTacToe game, and when users connect, we will create for them personal GameItem games within the TicTacToe collection, in which it will be seen who plays with whom and on what parameters. <br><br>  Now consider the function of creating these same games in the collection: <br><pre> <code class="javascript hljs">TicTacToe.prototype.start = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     -    //     Object.keys      if(Object.keys(this.free).length &gt; 0) { //       ID var opponent = Object.keys(this.free).shift(); //      var game = new GameItem(user, opponent, this.x, this.y, this.stepsToWin); //   ID   ID  var id = user + opponent; //      this.games[id] = game; //       this.users[user] = id; //      this.users[opponent] = id; //  callback    cb(true, id, opponent, this.x, this.y); } else { //  ,    this.free[user] = true; //  callback    cb(false); } }</span></span></code> </pre><br><br>  As you can see, we use change through prototypes, so we increase our module with necessary functionality. <br>  I will also use the callback function (callbacks) in the whole game. This gives us the opportunity to write asynchronous code. <br><br>  I will quickly explain again why this is necessary on a simple example, if someone has not yet read one of the dozens of articles about asynchrony :) <br><br>  So suppose the user has accessed the server and wants to start the game.  The server is happy to answer ok, I start to start your game and does it like this: <br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> --&gt;    <span class="hljs-number"><span class="hljs-number">2.</span></span> TicTacToe.start(); <span class="hljs-number"><span class="hljs-number">3.</span></span> &lt;--  </code> </pre><br><br>  So in this case, after step 1, steps 2 and 3 will work synchronously, that is, at the same time, the user will receive an answer before the game is actually created.  Therefore, we use the callback function, changing the logic as follows: <br><br><pre> <code class="javascript hljs"><span class="hljs-number"><span class="hljs-number">1.</span></span> --&gt;    <span class="hljs-number"><span class="hljs-number">2.</span></span> TicTacToe.start(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-number"><span class="hljs-number">3.</span></span> &lt;--   });</code> </pre><br><br>  Now, after step 1, we only run the function in step 2, and only after the callback does it work out the anonymous function and goes to step 3 to answer the result to the user. <br><br>  Let's go back to our game.  We taught her to determine the queue of gaming sites and connect pairs of users for the game. <br><br>  Now consider how we will end the game: <br><pre> <code class="javascript hljs">TicTacToe.prototype.end = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//          delete this.free[user]; //      ,     if(this.users[user] === undefined) return; //  ID      var gameId = this.users[user]; //     ,  if(this.games[gameId] === undefined) return; //      ID var game = this.games[gameId]; //      var opponent = (user == game.user ? game.opponent : game.user); //    delete this.games[gameId]; //   game = null; //     delete this.users[user]; //  ID   ID     cb(gameId, opponent); }</span></span></code> </pre> <br><br>  Now we will move on to the most interesting part, how tic tac toe works. <br><br>  This time we will add functionality not only for the collection, but also for the game object itself, let's make a player's move: <br><pre> <code class="javascript hljs">TicTacToe.prototype.step = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">gameId, x, y, user, cb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     proxy             this.games[gameId].step(x, y, user, cb); } GameItem.prototype.step = function(x, y, user, cb) { //        if(this.board[x + 'x' + y] !== undefined) return; //   X  Y    ,          this.board[x + 'x' + y] = this.getTurn(user); //     this.steps++; //            cb(this.checkWinner(x, y, this.getTurn(user)), this.getTurn(user)); }</span></span></code> </pre> <br>  Let's stop and consider this function in more detail.  There are calls to the other two functions in it, this.getTurn (). It is responsible for returning what the user who made the move goes to, passing the user ID to it, and here is the function itself that is added to the game object: <br><pre> <code class="javascript hljs">GameItem.prototype.getTurn = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (user == <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.user ? <span class="hljs-string"><span class="hljs-string">'X'</span></span> : <span class="hljs-string"><span class="hljs-string">'O'</span></span>); }</code> </pre> <br><br>  It's simple, if this is the user who created the game, then it is obvious that he is walking X, and if the opponent is O. <br><br>  The second function called in callback is a check for the winner: <br><pre> <code class="javascript hljs">GameItem.prototype.checkWinner = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">x, y, turn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   ,      if(this.steps == (this.x * this.y)) { //  return 'none'; //    } else if( //      this.checkWinnerDynamic('-', x, y, turn) || this.checkWinnerDynamic('|', x, y, turn) || this.checkWinnerDynamic('\\', x , y, turn) || this.checkWinnerDynamic('/', x, y, turn) ) { //   return true; } else { //   return false; } }</span></span></code> </pre><br><br>  We again added functionality to our game object.  In the function, we again get the coordinates of the move and what went.  Immediately check how many moves are made with it and see how many moves are available by counting it by multiplying the size of the field with each other. <br><br>  If we still have free cells, then the game is not over yet, maybe there is a winner.  Checking the winner is the most difficult function in the whole game, we will look at it a little lower.  In cases where there is no winner, then return false. <br><br>  Now about the check function on the winner, it has 4 parameters: <br>  1 - Search algorithm, can have values ‚Äã‚Äã-, |, / and \ (yes, one backslash, because in the code escaping quotes) why icons you ask, it‚Äôs all very simple guides for checking, for clarity, I decided to use their. <br>  2,3 - stroke coordinates <br>  4 - what went <br><br>  Now it‚Äôs a powerful and inimitable function, I advise you to look at it for the beginning and note that each case has almost a standard form, and what is the difference I‚Äôll tell you after the code: <br><pre> <code class="javascript hljs">GameItem.prototype.checkWinnerDynamic = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a, x, y, turn</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    4 : ,   2  //          ,,     4  var win = 1; switch(a) { //    case '-': var toLeft = toRight = true, min = x - this.stepsToWin, max = x + this.stepsToWin; min = (min &lt; 1) ? 1 : min; max = (max &gt; this.x) ? this.x : max; for(var i = 1; i &lt;= this.stepsToWin; i++) { if(win &gt;= this.stepsToWin) return true; if(!toLeft &amp;&amp; !toRight) return false; if(toLeft &amp;&amp; min &lt;= (xi) &amp;&amp; this.board[(xi) + 'x' + y] == turn) { win++; } else { toLeft = false; } if(toRight &amp;&amp; (x+i) &lt;= max &amp;&amp; this.board[(x+i) + 'x' + y] == turn) { win++; } else { toRight = false; } } break; //    case '|': var toUp = toDown = true, min = y - this.stepsToWin, max = y + this.stepsToWin; min = (min &lt; 1) ? 1 : min; max = (max &gt; this.y) ? this.y : max; for(var i = 1; i &lt;= this.stepsToWin; i++) { if(win &gt;= this.stepsToWin) return true; if(!toUp &amp;&amp; !toDown) return false; if(toUp &amp;&amp; min &lt;= (yi) &amp;&amp; this.board[x + 'x' + (yi)] == turn) { win++; } else { toUp = false; } if(toDown &amp;&amp; (y+i) &lt;= max &amp;&amp; this.board[x + 'x' + (y+i)] == turn) { win++; } else { toDown = false; } } break; //      case '\\': var toUpLeft = toDownRight = true, minX = x - this.stepsToWin, maxX = x + this.stepsToWin, minY = y - this.stepsToWin, maxY = y + this.stepsToWin; minX = (minX &lt; 1) ? 1 : minX; maxX = (maxX &gt; this.x) ? this.x : maxX; minY = (minY &lt; 1) ? 1 : minY; maxY = (maxY &gt; this.y) ? this.y : maxY; for(var i = 1; i &lt;= this.stepsToWin; i++) { if(win &gt;= this.stepsToWin) return true; if(!toUpLeft &amp;&amp; !toDownRight) return false; if(toUpLeft &amp;&amp; minX &lt;= (xi) &amp;&amp; minY &lt;= (yi) &amp;&amp; this.board[(xi) + 'x' + (yi)] == turn) { win++; } else { toUpLeft = false; } if(toDownRight &amp;&amp; (x+i) &lt;= maxX &amp;&amp; (y+i) &lt;= maxY &amp;&amp; this.board[(x+i) + 'x' + (y+i)] == turn) { win++; } else { toDownRight = false; } } break; //      case '/': var toDownLeft = toUpRight = true, minX = x - this.stepsToWin, maxX = x + this.stepsToWin, minY = y - this.stepsToWin, maxY = y + this.stepsToWin; minX = (minX &lt; 1) ? 1 : minX; maxX = (maxX &gt; this.x) ? this.x : maxX; minY = (minY &lt; 1) ? 1 : minY; maxY = (maxY &gt; this.y) ? this.y : maxY; for(var i = 1; i &lt;= this.stepsToWin; i++) { if(win &gt;= this.stepsToWin) return true; if(!toDownLeft &amp;&amp; !toUpRight) return false; if(toDownLeft &amp;&amp; minX &lt;= (xi) &amp;&amp; (y+i) &lt;= maxY &amp;&amp; this.board[(xi) + 'x' + (y+i)] == turn) { win++; } else { toDownLeft = false; } if(toUpRight &amp;&amp; (x+i) &lt;= maxX &amp;&amp; (yi) &lt;= maxY &amp;&amp; this.board[(x+i) + 'x' + (yi)] == turn) { win++; } else { toUpRight = false; } } break; default: return false; break; } return(win &gt;= this.stepsToWin); }</span></span></code> </pre><br><br><h5>  Algorithmization </h5><br><br>  Each case is a separate check for different algorithms, but they all have one thing in common, this is a common shift in the game field from the current position and checking the values ‚Äã‚Äãof these fields. <br>  Since I initially complicated my task and the game can have any field size, as well as any number of moves to win, we have a universal algorithm consisting of the following checks: <br><br><ul><li><h6>  Horizontal search </h6>  At the beginning, we declare the variable boundaries left and right for the cycle, as well as the minimum and maximum size along the X axis. <br>  That is, this value of the current move + value with the number of moves for victory. <br>  Then we give the values ‚Äã‚Äãof the maximum and minimum to the real, if the minimum is less than 1, then we set 1. <br>  If the maximum is greater than the field in the X axis, then set the field length value. <br>  Further in the cycle we will go through all the neighboring fields starting from the last ones and go further to the required number for victory. <br>  At each iteration in the cycle, we will check whether the required number of cells with the same turn to win has accumulated, if so, then we exit the functions and pass true - there is a winner. <br>  We will also check if not to the left not to the right, the displacement is no longer possible, then the cycle is stopped and we exit the function but already with false - there is no winner. <br>  Then there is a check from the beginning of the left side, whether it is possible to check the cell on the left and whether its value is greater than the minimum, and whether this cell has the value of the current move or not.  If all the conditions match, then we mark that we have a coincidence in the variable win increasing its value.  If a condition does not match, then we mark that the left side, we will no longer look.  After all, the winning conditions when the values ‚Äã‚Äãgo in a row. <br>  We will use the same algorithm for checking the right side, only there the test conditions change to the maximum value of the shift to the right. </li><li><h6>  Vertical search </h6>  In the beginning, in the same way, we will declare variable boundaries and limits. <br>  Only this time we will work with the Y axis and its values.  Offsets will also take place along the Y axis. <br>  Everything else is no different. </li><li><h6>  A diagonal from top to bottom <strike>(from left to right should usually be why I don‚Äôt write about it :)</strike> </h6>  In the beginning, in the same way, we will declare variable borders and limits, but now we have different limits, we will look at both axes. <br>  We will work with both axes at offset.  For up and left, we will decrease XY for offset, and also check the minimum X and minimum Y values.  And for the down and the right to increase the XY doing the appropriate checks for maximum offset values. </li><li><h6>  Diagonal bottom up </h6>  Here, almost everything is the same except for one little thing with offset and verification. <br>  Offset down to the left is a decrease along the X axis and an increase along the Y axis, which means checking for a minimum value of X and a maximum Y. <br>  When shifting up and to the right, this is an increase along the X axis and a decrease along the Y axis with a check for maximum X and minimum Y. </li></ul><br><br>  We have completed describing our game module.  All features are ready!  Now we will hang up the server handlers to interact with client handlers and look at all this in action. <br><br>  Save the file and return to our main index.js, we will add the work with socket.io to it, add the necessary events, as well as common game variables: <br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//    ,      ,        var countGames = onlinePlayers = onlineGames = 0, countPlayers = [], Game = new TicTacToe(); //   ,         Game.x = Game.y = 6; // Default: 6 //  -      Game.stepsToWin = 4; // Default: 4 //         io.sockets.on('connection', function (socket) { //          ID  IP  console.log('%s: %s - connected', socket.id.toString(), socket.handshake.address.address); //       stats       io.sockets.emit('stats', [ ' : ' + countGames, ' : ' + Object.keys(countPlayers).length, ' : ' + onlineGames, ' : ' + onlinePlayers ]); //       5 ,    setInterval(function() { io.sockets.emit('stats', [ ' : ' + countGames, ' : ' + Object.keys(countPlayers).length, ' : ' + onlineGames, ' : ' + onlinePlayers ]); }, 5000); //    ,  ID     ID   md5  Game.start(socket.id.toString(), function(start, gameId, opponent, x, y){ //  callback'       ,      //       ,       null if(start) { //        ID  ID  //      socket.io socket.join(gameId); //   ()        io.sockets.socket(opponent).join(gameId); //          socket.emit('ready', gameId, 'X', x, y); //     io.sockets.socket(opponent).emit('ready', gameId, 'O', x, y); //          countGames++; onlineGames++; } else { //  ,      io.sockets.socket(socket.id).emit('wait'); } //        ip     if(countPlayers[socket.handshake.address.address] == undefined) countPlayers[socket.handshake.address.address] = true; //     onlinePlayers++; }); //     socket.on('step', function (gameId, id) { //   ID   XxY var coordinates = id.split('x'); //       ,   proxy        Game.step(gameId, parseInt(coordinates[0]), parseInt(coordinates[1]), socket.id.toString(), function(win, turn) { //     ,  ,             //       in()        io.sockets.in(gameId).emit('step', id, turn, win); //      if(win) { //      ,     Game.end(socket.id.toString(), function(gameId, opponent) { //          socket.leave(gameId); //     io.sockets.socket(opponent).leave(gameId); }); } }); }); //             socket.on('disconnect', function () { //     ,      //       ,   Game.end(socket.id.toString(), function(gameId, opponent) { //     ,    Game.end       , ID  io.sockets.socket(opponent).emit('exit'); //     socket.leave(gameId); //     io.sockets.socket(opponent).leave(gameId); //     onlineGames--; }); //    onlinePlayers--; //      console.log('%s: %s - disconnected', socket.id.toString(), socket.handshake.address.address); }); });</span></span></code> </pre> <br><br>     !   NodeJS,     ,    socket.io,     express   . <br><br>  Now you can play, to start the game, you need to click "New game": <br>  <a href="http://ivan.zhuravlev.name/game">ivan.zhuravlev.name/game</a> - 6x6 field with 4 moves to win <br>  <a href="http://ivan.zhuravlev.name/game3">ivan.zhuravlev.name/game3</a> - 3x3 field with 3 moves to win <br>  View sources: <a href="https://github.com/intech/TicTacToe">github.com/intech/TicTacToe</a> <br>     -,  proxy nginx  ,       1337 <br>    ,     ,    8  1   ,   :) <br> ‚Äî     : 12  22 . <br>   : 3 ,     <br><br><h5>  Statistics </h5><br><img src="http://habrastorage.org/storage1/8ae894a8/c618f9ac/0059fae6/feb58a55.png"><br>  CPU <br><img src="http://habrastorage.org/storage1/5b694409/b5a4bb57/f79be6ca/7be7c76d.png"><br>  Memory <br><img src="http://habrastorage.org/storage1/55ee60d9/acd90f4c/ef6ced75/d7b30752.png"><br>   google analytics           . <br>        30  50   ,        ,             . </div><p>Source: <a href="https://habr.com/ru/post/132544/">https://habr.com/ru/post/132544/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132537/index.html">Interview with the creators of Angry Birds</a></li>
<li><a href="../132539/index.html">IFling can pick up ping-pong balls and throw them precisely</a></li>
<li><a href="../132540/index.html">Saber-toothed squirrels really existed</a></li>
<li><a href="../132541/index.html">And one-click screenshots (C #) again</a></li>
<li><a href="../132543/index.html">Runner Monetizes Windows Phone Applications</a></li>
<li><a href="../132545/index.html">Wanted.VC Digest # 22</a></li>
<li><a href="../132546/index.html">She drowned ...</a></li>
<li><a href="../132547/index.html">Diaspora co-founder Ilya Zhytomyr died at the age of 22</a></li>
<li><a href="../132549/index.html">TradingView is an online HTML5 technical analysis platform and social network for traders. We start</a></li>
<li><a href="../132551/index.html">What is effective management?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>