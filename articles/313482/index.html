<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a blog engine with Phoenix and Elixir / Part 2. Authorization</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="From the translator: ‚Äú Elixir and Phoenix are a great example of where modern web development is heading. Already, these tools provide high-quality ac...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a blog engine with Phoenix and Elixir / Part 2. Authorization</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/bab/544/80a/bab54480ad8d41418519f4b2d5a79a71.png"><br><br>  From the translator: ‚Äú <i>Elixir and Phoenix are a great example of where modern web development is heading.</i>  <i>Already, these tools provide high-quality access to real-time technologies for web applications.</i>  <i>Sites with increased interactivity, multiplayer browser games, microservices - those areas in which these technologies will serve a good service.</i>  <i>The following is a translation of a series of 11 articles that describe in detail the aspects of development on the Phoenix framework that would seem such a trivial thing as a blog engine.</i>  <i>But do not hurry to sulk, it will be really interesting, especially if the articles encourage you to pay attention to the Elixir or become its followers.</i> <i><br><br></i>  <i>In this part, we will refine the basis for the blog, dive a little deeper into testing and finally add authorization.</i>  <i>I apologize for the slight delay, then I will try to keep to a clear schedule, or go ahead of the curve!</i>  " <br><a name="habracut"></a><br>  At the moment, our application is based on: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  <b>Elixir</b> : v1.3.1 </li><li>  <b>Phoenix</b> : v1.2.0 </li><li>  <b>Ecto</b> : v2.0.2 </li><li>  <b>Comeonin</b> : v2.5.2 </li></ul><br><h2>  Fix some bugs </h2><br>  If you followed the first part, you should have <s><i>a somewhat</i></s> functioning blogging engine running on Elixir / Phoenix.  If you are like me, then even such a seemingly small part of the work done will excite and make you move further, causing a desire to polish the code even more. <br><br>  If you want to follow the progress of the work, I poured all the code for you <a href="https://github.com/Diamond/pxblog/tree/part_1">into the repository on Github</a> . <br><br>  The first bug is fairly easy to reproduce by going to <a href="http://localhost:4000/sessions/new">http: // localhost: 4000 / sessions / new</a> and clicking the <b>Submit</b> button.  You should see an error message similar to: <br><br><pre><code class="bash hljs">nil given <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> :username, comparison with nil is forbidden as it always evaluates to <span class="hljs-literal"><span class="hljs-literal">false</span></span>. Pass a full query expression and use is_nil/1 instead.</code> </pre> <br>  If we take a look at the <b>create</b> function in <b>SessionController,</b> it becomes immediately clear what's the matter. <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"user" =&gt; user_params}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> user = Repo.get_by(User, <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> user_params[<span class="hljs-string"><span class="hljs-string">"username"</span></span>]) user <span class="hljs-params"><span class="hljs-params">|&gt; sign_in(user_params["password"], conn) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br>  So, if we send in the parameters instead of <b>username a</b> string containing an empty value (or nothing), then we get an error.  Let's quickly fix it.  Fortunately, this is done easily using guard clauses and <i>pattern matching</i> .  Replace the current <b>create</b> function with the following: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"user" =&gt; %{"username" =&gt; username, "password" =&gt; password}</span></span></span></span><span class="hljs-function"><span class="hljs-params">})</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> is_nil(username) <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> is_nil(password) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> user = Repo.get_by(User, <span class="hljs-symbol"><span class="hljs-symbol">username:</span></span> username) sign_in(user, password, conn) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">_</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> failed_login(conn) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  We replace the <b>params</b> argument in the second <b>create</b> function with an underscore, since we don't need to use it anywhere.  We also refer to the <b>failed_login</b> function, which needs to be added as a private one.  In the <b>web / controllers / session_controller.ex</b> file, change the <b>Comeonin</b> import: <br><br><pre> <code class="ruby hljs">import Comeonin.Bcrypt, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">checkpw:</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">dummy_checkpw:</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>]</code> </pre><br>  We need to call <b>dummy_checkpw ()</b> so that no one can carry out an attack on time by simply iterating over the users.  Next, we add the <b>failed_login</b> function: <br><br><pre> <code class="ruby hljs">defp failed_login(conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> dummy_checkpw() conn <span class="hljs-params"><span class="hljs-params">|&gt; put_session(:current_user, </span><span class="hljs-literal"><span class="hljs-params"><span class="hljs-literal">nil</span></span></span><span class="hljs-params">) |</span></span>&gt; put_flash(<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, <span class="hljs-string"><span class="hljs-string">"Invalid username/password combination!"</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; redirect(to: page_path(conn, :index)) |</span></span>&gt; halt() <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Again, notice the <b>dummy_checkpw ()</b> call above!  We also clear our <b>current_user</b> session, set a flash message telling the user to enter a wrong username and password and redirect back to the main page.  Finally, we call the <b>halt</b> function, which is a reasonable defense against double-rendering problems.  And then we replace all similar code with calls of our new function. <br><br><pre> <code class="ruby hljs">defp sign_in(user, _password, conn) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> is_nil(user) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> failed_login(conn) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp sign_in(user, password, conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> checkpw(password, user.password_digest) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_session(:current_user, %{id: user.id, username: user.username}) |</span></span>&gt; put_flash(<span class="hljs-symbol"><span class="hljs-symbol">:info</span></span>, <span class="hljs-string"><span class="hljs-string">"Sign in successful!"</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; redirect(to: page_path(conn, :index)) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">else</span></span></span><span class="hljs-params"> failed_login(conn) </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br>  These edits should take care of all existing strange bugs with the entrance, so that we can move on to associate posts with users adding them. <br><br><h2>  Add migration </h2><br>  Let's start by adding a link to the <b>users</b> table to the <b>posts</b> table.  To do this, we will create a migration through the <b>Ecto-generator</b> : <br><br><pre> <code class="bash hljs">$ mix ecto.gen.migration add_user_id_to_posts</code> </pre><br>  Conclusion: <br><br><pre> <code class="bash hljs">Compiling 1 file (.ex) * creating priv/repo/migrations * creating priv/repo/migrations/20160720211140_add_user_id_to_posts.exs</code> </pre><br>  If we open the file we just created, we won't see anything in it.  So add the following code to the <b>change</b> function: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">change</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">do</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">alter</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">table</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-symbol"><span class="hljs-function"><span class="hljs-params"><span class="hljs-symbol">:posts</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> add <span class="hljs-symbol"><span class="hljs-symbol">:user_id</span></span>, references(<span class="hljs-symbol"><span class="hljs-symbol">:users</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> create index(<span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>, [<span class="hljs-symbol"><span class="hljs-symbol">:user_id</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  This will add a <b>user_id</b> column that <b>refers</b> to the user table, as well as an index for it.  <code>mix ecto.migrate</code> and start editing our models. <br><br><h2>  Associate posts with users </h2><br>  Let's open the <b>web / models / post.ex file</b> and add a link to the <b>User</b> model.  Inside the <b>posts</b> scheme we place the line: <br><br><pre> <code class="ruby hljs">belongs_to <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, Pxblog.User</code> </pre><br>  We need to add feedback to the <b>User</b> model that points back to the <b>Post</b> model.  Inside the <b>users</b> schema in the <b>web / models / user.ex</b> file <b>we</b> place the line: <br><br><pre> <code class="ruby hljs">has_many <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>, Pxblog.Post</code> </pre><br>  We also need to open the <b>Posts</b> controller and directly link posts to users. <br><br><h2>  We change ways </h2><br>  Let's start with updating the router by specifying posts within users.  To do this, open the <b>web / router.ex file</b> and replace the <b>/ users</b> and <b>/ posts</b> paths with: <br><br><pre> <code class="ruby hljs">resources <span class="hljs-string"><span class="hljs-string">"/users"</span></span>, UserController <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> resources <span class="hljs-string"><span class="hljs-string">"/posts"</span></span>, PostController <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><h2>  We fix the controller </h2><br>  If we try to execute the <code>mix phoenix.routes</code> right now, we get an error.  This is the norm!  Since we changed the structure of the paths, the <b>post_path</b> helper, the new version of which is called <b>user_post_path</b> and refers to the embedded resource, is lost.  Nested helpers allow us to gain access to the paths represented by resources that require the availability of another resource (for example, posts require a user). <br><br>  So, if we have the usual <b>post_path</b> helper, we call it this way: <br><br><pre> <code class="ruby hljs">post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, post)</code> </pre><br>  The <b>conn</b> object is a connection object, an atom <b>: show</b> is an action to which we refer, and the third argument can be either a model or an object identifier.  From here we have the opportunity to do so: <br><br><pre> <code class="ruby hljs">post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)</code> </pre><br>  At the same time, if we have a nested resource, helpers will change along with changing our routes file.  In our case: <br><br><pre> <code class="ruby hljs">user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, user, post)</code> </pre><br>  Please note that the third argument now represents an external resource, and each nested one comes next. <br><br>  Now that we understand why errors occur, we can fix them.  We need to have access to the requested user in each of the controller actions.  The best way to get it is to use the plug.  To do this, open the <b>web / controllers / post_controller.ex file</b> and at the very top add a call to the new plug: <br><br><pre> <code class="ruby hljs">plug <span class="hljs-symbol"><span class="hljs-symbol">:assign_user</span></span></code> </pre><br>  And we will write it a little lower: <br><br><pre> <code class="ruby hljs">defp assign_user(conn, _opts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> conn.params <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-string"><span class="hljs-string">%{"user_id" =&gt; user_id}</span></span> -&gt; user = Repo.get(Pxblog.User, user_id) assign(conn, <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, user) <span class="hljs-number"><span class="hljs-number">_</span></span> -&gt; conn <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  And then replace <b>post_path</b> with <b>user_post_path everywhere</b> : <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"post" =&gt; post_params}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = Post.changeset(%Post{}, post_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.insert(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, _post} -&gt; conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:info, "Post created successfully.") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>])) {<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, changeset} -&gt; render(conn, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"id" =&gt; id, "post" =&gt; post_params}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(Post, id) changeset = Post.changeset(post, post_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.update(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, post} -&gt; conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:info, "Post updated successfully.") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], post)) {<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, changeset} -&gt; render(conn, <span class="hljs-string"><span class="hljs-string">"edit.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> post, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"id" =&gt; id}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(Post, id) <span class="hljs-comment"><span class="hljs-comment">#    delete! (  ),     #      (  ). Repo.delete!(post) conn |&gt; put_flash(:info, "Post deleted successfully.") |&gt; redirect(to: user_post_path(conn, :index, conn.assigns[:user])) end</span></span></code> </pre><br><h2>  Putting in order templates </h2><br>  Our controller stopped ‚Äúspitting out‚Äù the error message, so now let's work on our templates.  We went a short way by implementing the plug-in, which is accessible from any controller action.  Using the <b>assign</b> function on the connection object, we define a variable with which we can work in the template.  Now we will change the templates a bit, replacing post_path helper with user_post_path and making sure that the argument following the name of the action is the user ID.  In the <b>web / templates / post / index.html.eex</b> file we will write: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Listing posts<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"table"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Title<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span>Body<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">th</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thead</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">for</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag"> &lt;</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">-</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">posts</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post.title</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post.body</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text-right"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Show</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:show</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag">), </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-default</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-xs</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Edit</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:edit</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag">), </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-default</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-xs</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Delete</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:delete</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag">), </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">method:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:delete</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data:</span></span></span><span class="hljs-tag"> [</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">confirm:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Are</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">you</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sure</span></span></span><span class="hljs-tag">?"], </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class:</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-danger</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">btn-xs</span></span></span><span class="hljs-tag">" %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">td</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">tbody</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">table</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">New</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:new</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">) %&gt;</span></span></code> </pre><br>  In the <b>web / templates / post / show.html.eex</b> file: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Show post<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>Title:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post.title</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>Body:<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post.body</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Edit</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:edit</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag">) %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Back</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:index</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">) %&gt;</span></span></code> </pre><br>  In the <b>web / templates / post / new.html.eex file</b> : <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>New post<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">render</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">form.html</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">changeset:</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">changeset</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:create</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">) %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Back</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:index</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">) %&gt;</span></span></code> </pre><br>  In the <b>web / templates / post / edit.html.eex file</b> : <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>Edit post<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">render</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">form.html</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">changeset:</span></span></span><span class="hljs-tag"> @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">changeset</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:update</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">post</span></span></span><span class="hljs-tag">) %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">link</span></span></span><span class="hljs-tag"> "</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Back</span></span></span><span class="hljs-tag">", </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">to:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user_post_path</span></span></span><span class="hljs-tag">(@</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">conn</span></span></span><span class="hljs-tag">, </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">:index</span></span></span><span class="hljs-tag">, @</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">user</span></span></span><span class="hljs-tag">) %&gt;</span></span></code> </pre><br>  Now, as a health check, if we run <code>mix phoenix.routes</code> , we should see the output of the paths and the successful compilation! <br><br><pre> <code class="bash hljs">Compiling 14 files (.ex) page_path GET / Pxblog.PageController :index user_path GET /users Pxblog.UserController :index user_path GET /users/:id/edit Pxblog.UserController :edit user_path GET /users/new Pxblog.UserController :new user_path GET /users/:id Pxblog.UserController :show user_path POST /users Pxblog.UserController :create user_path PATCH /users/:id Pxblog.UserController :update PUT /users/:id Pxblog.UserController :update user_path DELETE /users/:id Pxblog.UserController :delete user_post_path GET /users/:user_id/posts Pxblog.PostController :index user_post_path GET /users/:user_id/posts/:id/edit Pxblog.PostController :edit user_post_path GET /users/:user_id/posts/new Pxblog.PostController :new user_post_path GET /users/:user_id/posts/:id Pxblog.PostController :show user_post_path POST /users/:user_id/posts Pxblog.PostController :create user_post_path PATCH /users/:user_id/posts/:id Pxblog.PostController :update PUT /users/:user_id/posts/:id Pxblog.PostController :update user_post_path DELETE /users/:user_id/posts/:id Pxblog.PostController :delete session_path GET /sessions/new Pxblog.SessionController :new session_path POST /sessions Pxblog.SessionController :create session_path DELETE /sessions/:id Pxblog.SessionController :delete</code> </pre><br><h2>  We connect the remaining parts to the controller </h2><br>  Now, all we need is to finish the work on the controller to use the new associations.  We <code>iex -S mix</code> start by launching the interactive console with the <code>iex -S mix</code> command to learn a little about how to select user posts.  But before that we need to set up a list of standard imports / aliases that will be loaded each time the iex console is loaded inside our project.  Create a new <b>.iex.exs</b> file in the project root (note the point at the beginning of the file name) and fill it with the following content: <br><br><pre> <code class="ruby hljs">import Ecto.Query <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Post <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Repo import Ecto</code> </pre><br>  Now, when running iex, we don‚Äôt need to do anything like this every time: <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">1</span></span>)&gt; import Ecto.Query <span class="hljs-literal"><span class="hljs-literal">nil</span></span> iex(<span class="hljs-number"><span class="hljs-number">2</span></span>)&gt; <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User <span class="hljs-literal"><span class="hljs-literal">nil</span></span> iex(<span class="hljs-number"><span class="hljs-number">3</span></span>)&gt; <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Post <span class="hljs-literal"><span class="hljs-literal">nil</span></span> iex(<span class="hljs-number"><span class="hljs-number">4</span></span>)&gt; <span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.Repo <span class="hljs-literal"><span class="hljs-literal">nil</span></span> iex(<span class="hljs-number"><span class="hljs-number">5</span></span>)&gt; import Ecto <span class="hljs-literal"><span class="hljs-literal">nil</span></span></code> </pre><br>  Now we need to have at least one user in the repository.  If not, add it.  Then we can run: <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">8</span></span>)&gt; user = Repo.get(User, <span class="hljs-number"><span class="hljs-number">1</span></span>) [debug] SELECT u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"username"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"email"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"password_digest"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"users"</span></span> AS u<span class="hljs-number"><span class="hljs-number">0</span></span> WHERE (u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = $1) [<span class="hljs-number"><span class="hljs-number">1</span></span>] OK query=<span class="hljs-number"><span class="hljs-number">8.2</span></span>ms %Pxblog.User{<span class="hljs-symbol"><span class="hljs-symbol">__meta__:</span></span> <span class="hljs-comment"><span class="hljs-comment">#Ecto.Schema.Metadata&lt;:loaded&gt;, email: "test", id: 1, inserted_at: #Ecto.DateTime&lt;2015-10-06T17:47:07Z&gt;, password: nil, password_confirmation: nil, password_digest: "$2b$12$pV/XBBCRl0RQhadQd9Y4mevOy5y0j4bCC/LjGgx7VJMosRdwme22a", posts: #Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;, updated_at: #Ecto.DateTime&lt;2015-10-06T17:47:07Z&gt;, username: "test"} iex(10)&gt; Repo.all(assoc(user, :posts)) [debug] SELECT p0."id", p0."title", p0."body", p0."user_id", p0."inserted_at", p0."updated_at" FROM "posts" AS p0 WHERE (p0."user_id" IN ($1)) [1] OK query=3.5ms []</span></span></code> </pre><br>  While we have not created a single post for this user, so it is logical to get an empty list here.  We used the <b>assoc</b> function from <b>ecto</b> to get the request linking posts with the user.  We can also do the following: <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">14</span></span>)&gt; Repo.all from p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Post, ...(<span class="hljs-number"><span class="hljs-number">14</span></span>)&gt; <span class="hljs-symbol"><span class="hljs-symbol">join:</span></span> u <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> assoc(p, <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>), ...(<span class="hljs-number"><span class="hljs-number">14</span></span>)&gt; <span class="hljs-symbol"><span class="hljs-symbol">select:</span></span> p [debug] SELECT p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"title"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"body"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"posts"</span></span> AS p<span class="hljs-number"><span class="hljs-number">0</span></span> INNER JOIN <span class="hljs-string"><span class="hljs-string">"users"</span></span> AS u1 ON u1.<span class="hljs-string"><span class="hljs-string">"id"</span></span> = p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span> [] OK query=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span>ms</code> </pre><br>  This creates a query with an inner join instead of a direct condition for a selection by user ID.  Pay particular attention to what the queries generated in both cases look like.  It is very useful to understand the SQL that is created ‚Äúbehind the scenes‚Äù whenever you work with the code that generates queries. <br><br>  We can also use the <b>preload</b> function when fetching posts to preload users as well, as shown below: <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">18</span></span>)&gt; Repo.all(from u <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> User, <span class="hljs-symbol"><span class="hljs-symbol">preload:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>]) [debug] SELECT u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"username"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"email"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"password_digest"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"users"</span></span> AS u<span class="hljs-number"><span class="hljs-number">0</span></span> [] OK query=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">9</span></span>ms [debug] SELECT p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"title"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"body"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"posts"</span></span> AS p<span class="hljs-number"><span class="hljs-number">0</span></span> WHERE (p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span> IN ($1)) ORDER BY p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span> [<span class="hljs-number"><span class="hljs-number">1</span></span>] OK query=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span>ms iex(<span class="hljs-number"><span class="hljs-number">20</span></span>)&gt; Repo.all(from p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Post, <span class="hljs-symbol"><span class="hljs-symbol">preload:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>]) [debug] SELECT p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"title"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"body"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"posts"</span></span> AS p<span class="hljs-number"><span class="hljs-number">0</span></span> [] OK query=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">8</span></span>ms []</code> </pre><br>  We need to add posts to make it possible to tinker with requests.  So for this we are going to use the Ecto function called <b>build_assoc</b> .  This function takes as the first argument the model for which we want to add an association, and the second - the association itself as an atom. <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">1</span></span>)&gt; user = Repo.get(User, <span class="hljs-number"><span class="hljs-number">1</span></span>) iex(<span class="hljs-number"><span class="hljs-number">2</span></span>)&gt; post = build_assoc(user, <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>, <span class="hljs-string"><span class="hljs-string">%{title: "Test Title", body: "Test Body"}</span></span>) iex(<span class="hljs-number"><span class="hljs-number">3</span></span>)&gt; Repo.insert(post) iex(<span class="hljs-number"><span class="hljs-number">4</span></span>)&gt; posts = Repo.all(from p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Post, <span class="hljs-symbol"><span class="hljs-symbol">preload:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>])</code> </pre><br>  And now, having completed the last query, we should get the following output: <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">4</span></span>)&gt; posts = Repo.all(from p <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Post, <span class="hljs-symbol"><span class="hljs-symbol">preload:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>]) [debug] SELECT p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"title"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"body"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, p<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"posts"</span></span> AS p<span class="hljs-number"><span class="hljs-number">0</span></span> [] OK query=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>ms [debug] SELECT u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"username"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"email"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"password_digest"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"inserted_at"</span></span>, u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"updated_at"</span></span> FROM <span class="hljs-string"><span class="hljs-string">"users"</span></span> AS u<span class="hljs-number"><span class="hljs-number">0</span></span> WHERE (u<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-string"><span class="hljs-string">"id"</span></span> IN ($1)) [<span class="hljs-number"><span class="hljs-number">1</span></span>] OK query=<span class="hljs-number"><span class="hljs-number">0</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>ms [%Pxblog.Post{<span class="hljs-symbol"><span class="hljs-symbol">__meta__:</span></span> <span class="hljs-comment"><span class="hljs-comment">#Ecto.Schema.Metadata&lt;:loaded&gt;, body: "Test Body", id: 1, inserted_at: #Ecto.DateTime&lt;2015-10-06T18:06:20Z&gt;, title: "Test Title", updated_at: #Ecto.DateTime&lt;2015-10-06T18:06:20Z&gt;, user: %Pxblog.User{__meta__: #Ecto.Schema.Metadata&lt;:loaded&gt;, email: "test", id: 1, inserted_at: #Ecto.DateTime&lt;2015-10-06T17:47:07Z&gt;, password: nil, password_confirmation: nil, password_digest: "$2b$12$pV/XBBCRl0RQhadQd9Y4mevOy5y0j4bCC/LjGgx7VJMosRdwme22a", posts: #Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;, updated_at: #Ecto.DateTime&lt;2015-10-06T17:47:07Z&gt;, username: "test"}, user_id: 1}]</span></span></code> </pre><br>  And we just quickly check the first result: <br><br><pre> <code class="ruby hljs">iex(<span class="hljs-number"><span class="hljs-number">5</span></span>)&gt; post = List.first posts %Pxblog.Post{<span class="hljs-symbol"><span class="hljs-symbol">__meta__:</span></span> <span class="hljs-comment"><span class="hljs-comment">#Ecto.Schema.Metadata&lt;:loaded&gt;, body: "Test Body", id: 1, inserted_at: #Ecto.DateTime&lt;2015-10-06T18:06:20Z&gt;, title: "Test Title", updated_at: #Ecto.DateTime&lt;2015-10-06T18:06:20Z&gt;, user: %Pxblog.User{__meta__: #Ecto.Schema.Metadata&lt;:loaded&gt;, email: "test", id: 1, inserted_at: #Ecto.DateTime&lt;2015-10-06T17:47:07Z&gt;, password: nil, password_confirmation: nil, password_digest: "$2b$12$pV/XBBCRl0RQhadQd9Y4mevOy5y0j4bCC/LjGgx7VJMosRdwme22a", posts: #Ecto.Association.NotLoaded&lt;association :posts is not loaded&gt;, updated_at: #Ecto.DateTime&lt;2015-10-06T17:47:07Z&gt;, username: "test"}, user_id: 1} iex(6)&gt; post.title "Test Title" iex(7)&gt; post.user.username "test"</span></span></code> </pre><br>  Cool!  Our experiment showed exactly what we expected, so let's go back to the controller ( <b>web / controllers / post_controller.ex file</b> ) and begin to edit the code.  In the <b>index</b> action, we want to receive all posts related to the user.  Let's start with it: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">index</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, _params)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> posts = Repo.all(assoc(conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>)) render(conn, <span class="hljs-string"><span class="hljs-string">"index.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">posts:</span></span> posts) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Now we can go see the list of posts for the first user!  But if we try to get a list of posts for a user that doesn't exist, we will get an error message, which is a bad UX, so let's tidy up our <b>assign_user plugin</b> : <br><br><pre> <code class="ruby hljs">defp assign_user(conn, _opts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> conn.params <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-string"><span class="hljs-string">%{"user_id" =&gt; user_id}</span></span> -&gt; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.get(Pxblog.User, user_id) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-literal"><span class="hljs-literal">nil</span></span> -&gt; invalid_user(conn) user -&gt; assign(conn, <span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>, user) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-number"><span class="hljs-number">_</span></span> -&gt; invalid_user(conn) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp invalid_user(conn) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:error, "Invalid user!") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>)) <span class="hljs-params"><span class="hljs-params">|&gt; halt </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br>  Now, when we open the list of posts for a non-existent user, we will receive a nice flash message and will be kindly redirected to <b>page_path</b> .  Next, we need to change the <b>new</b> action: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">new</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, _params)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>] <span class="hljs-params"><span class="hljs-params">|&gt; build_assoc(:posts) |</span></span>&gt; Post.changeset() render(conn, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  We take the <b>user</b> model, pass it to the <b>build_assoc</b> function, say we need to create a post, and then pass the resulting empty model to the <b>Post.changeset</b> function to get an empty revision.  We will go the same way for the create method (except for adding <b>post_params</b> ): <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"post" =&gt; post_params}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>] <span class="hljs-params"><span class="hljs-params">|&gt; build_assoc(:posts) |</span></span>&gt; Post.changeset(post_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.insert(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, _post} -&gt; conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:info, "Post created successfully.") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>])) {<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, changeset} -&gt; render(conn, <span class="hljs-string"><span class="hljs-string">"new.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  And then change the <b>show</b> , <b>edit</b> , <b>update,</b> and <b>delete</b> actions: <br><br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">show</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"id" =&gt; id}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(assoc(conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>), id) render(conn, <span class="hljs-string"><span class="hljs-string">"show.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> post) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">edit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"id" =&gt; id}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(assoc(conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>), id) changeset = Post.changeset(post) render(conn, <span class="hljs-string"><span class="hljs-string">"edit.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> post, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">update</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"id" =&gt; id, "post" =&gt; post_params}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(assoc(conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>), id) changeset = Post.changeset(post, post_params) <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Repo.update(changeset) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, post} -&gt; conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:info, "Post updated successfully.") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], post)) {<span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>, changeset} -&gt; render(conn, <span class="hljs-string"><span class="hljs-string">"edit.html"</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> post, <span class="hljs-symbol"><span class="hljs-symbol">changeset:</span></span> changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(conn, </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">%{"id" =&gt; id}</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = Repo.get!(assoc(conn.assigns[<span class="hljs-symbol"><span class="hljs-symbol">:user</span></span>], <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>), id) <span class="hljs-comment"><span class="hljs-comment">#    delete! (  ),     #      (  ). Repo.delete!(post) conn |&gt; put_flash(:info, "Post deleted successfully.") |&gt; redirect(to: user_post_path(conn, :index, conn.assigns[:user])) end</span></span></code> </pre><br>  After running all the tests, we should see that everything works.  Except that ... any user has the ability to delete / edit / create a new post under any user he wants! <br><br><h2>  We limit the creation of posts by users </h2><br>  We cannot release a blog engine with such a security hole.  Let's fix this by adding another plugin that ensures that the resulting user is also the current user. <br><br>  Add a new function to the end of the <b>web / controllers / post_controller.ex file</b> : <br><br><pre> <code class="ruby hljs">defp authorize_user(conn, _opts) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> user = get_session(conn, <span class="hljs-symbol"><span class="hljs-symbol">:current_user</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> user &amp;&amp; Integer.to_string(user.id) == conn.params[<span class="hljs-string"><span class="hljs-string">"user_id"</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> conn <span class="hljs-params"><span class="hljs-params">|&gt; put_flash(:error, "You are </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">not</span></span></span><span class="hljs-params"> authorized to modify that post!") |</span></span>&gt; redirect(<span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>)) <span class="hljs-params"><span class="hljs-params">|&gt; halt() </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br>  And at the very top, add a call to the plug: <br><br><pre> <code class="ruby hljs">plug <span class="hljs-symbol"><span class="hljs-symbol">:authorize_user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> action <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:edit</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>]</code> </pre><br>  Now everything should work fine!  Users must be registered to leave posts, and then work only with them.  All we have to do is update the test suite to handle these changes, and everything will be ready.  To start, just run the <b>mix test</b> to evaluate the current situation.  Most likely you will see this error: <br><br><pre> <code class="bash hljs">** (CompileError) <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/controllers/post_controller_test.exs:14: <span class="hljs-keyword"><span class="hljs-keyword">function</span></span> post_path/2 undefined (stdlib) lists.erl:1337: :lists.foreach/2 (stdlib) erl_eval.erl:669: :erl_eval.do_apply/6 (elixir) lib/code.ex:363: Code.require_file/2 (elixir) lib/kernel/parallel_require.ex:50: anonymous fn/4 <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> Kernel.ParallelRequire.spawn_requires/5</code> </pre><br>  Unfortunately, we need to change each <b>post_path</b> call to <b>user_post_path</b> again.  And in order to do this, we need to radically change our tests.  Let's start by adding a settings block to the file <b>test / controllers / post_controller_text.exs</b> : <br><br><pre> <code class="ruby hljs"><span class="hljs-keyword"><span class="hljs-keyword">alias</span></span> Pxblog.User setup <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> {<span class="hljs-symbol"><span class="hljs-symbol">:ok</span></span>, user} = create_user conn = build_conn() <span class="hljs-params"><span class="hljs-params">|&gt; login_user(user) {:ok, conn: conn, user: user} </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span><span class="hljs-params"> defp create_user </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">do</span></span></span><span class="hljs-params"> User.changeset(%User{}, %{email: "test@test.com", username: "test", password: "test", password_confirmation: "test"}) |</span></span>&gt; Repo.insert <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> defp login_user(conn, user) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post conn, session_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>), <span class="hljs-symbol"><span class="hljs-symbol">user:</span></span> <span class="hljs-string"><span class="hljs-string">%{username: user.username, password: user.password}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  There is a lot going on here.  The first thing we did was add a call to the <b>create_user</b> function, which we need to write.  We need some helpers for the tests, so let's add them.  The <b>create_user</b> function simply adds a test user to the <b>Repo</b> , which is why we use the <b>{: ok, user}</b> pattern matching when calling this function. <br><br>  Next we call <b>conn = build_conn ()</b> , as well as before.  Then we pass the result of <b>conn</b> to the <b>login_user</b> function.  This connects posts with our login function, since all basic actions with posts require a user.  It is very important to understand that we need to return <b>conn</b> and carry it with us to each individual test.  If we do not do this, the user will not be logged in. <br><br>  Finally, we changed the return of that function to returning the standard values <b>: ok</b> and <b>: conn</b> , but now we will also include another entry <b>: user</b> in the dictionary.  Let's take a look at the first test that will change: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"lists all entries on index"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = get conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, user) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Listing posts"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Please note that we have changed the second argument of the <b>test</b> method so that using pattern matching we can obtain a dictionary containing, in addition to the key <b>: conn</b> , also the key <b>: user</b> .  This ensures that we use the key <b>: user</b> , which we work with in the <b>setup</b> block.  In addition, we changed the <b>post_path</b> helper call to <b>user_post_path</b> and added a user with the third argument.  Let's run this test right now.  This can be done by specifying a tag, or by specifying the number of the desired line by executing the command as follows: <br><br><pre> <code class="bash hljs">$ mix <span class="hljs-built_in"><span class="hljs-built_in">test</span></span> <span class="hljs-built_in"><span class="hljs-built_in">test</span></span>/controller/post_controller_test.exs:[line number]</code> </pre><br>  Our test should turn green!  Sumptuously!  Now let's change this piece: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"renders form for new resources"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = get conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, user) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"New post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  There is nothing new here, except for changing the <b>setup</b> handler and the path, so go ahead. <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"creates resource and redirects when data is valid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = post conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>, user), <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> @valid_attrs assert redirected_to(conn) == user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, user) assert Repo.get_by(assoc(user, <span class="hljs-symbol"><span class="hljs-symbol">:posts</span></span>), @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Don't forget that we had to receive every post associated with a user, so we‚Äôll change all the <b>post_path</b> calls. <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"does not create resource and renders errors when data is invalid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = post conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>, user), <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> @invalid_attrs assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"New post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Another slightly modified test.  There is nothing to watch, so let's move on to the next more interesting one.  Recall again that we create / get posts belonging to a user association, so proceed to changing the <b>‚Äúshows chosen resource‚Äù</b> test: <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"shows chosen resource"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = build_post(user) conn = get conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, user, post) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Show post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Earlier we added posts using simple <code>Repo.insert! %Post{}</code>  <code>Repo.insert! %Post{}</code> .  This will no longer work, so now we need to create them with the correct association.  Since this line is used quite often in the remaining tests, we will write a helper to facilitate its use. <br><br><pre> <code class="ruby hljs">defp build_post(user) <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> changeset = user <span class="hljs-params"><span class="hljs-params">|&gt; build_assoc(:posts) |</span></span>&gt; Post.changeset(@valid_attrs) Repo.insert!(changeset) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  This method creates a valid post model associated with the user, and then inserts it into the database.  Please note that <b>Repo.insert!</b>  returns not <b>{: ok, model}</b> , but returns the model itself! <br><br>  Let us return to our test, which we have changed.  I want to lay out the rest of the tests, and you just repeat the appropriate changes one by one, until all the tests begin to pass. <br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"renders page not found when id is nonexistent"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> assert_raise Ecto.NoResultsError, fn -&gt; get conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, user, -<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test <span class="hljs-string"><span class="hljs-string">"renders form for editing chosen resource"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = build_post(user) conn = get conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:edit</span></span>, user, post) assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Edit post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test <span class="hljs-string"><span class="hljs-string">"updates chosen resource and redirects when data is valid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = build_post(user) conn = put conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span>, user, post), <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> @valid_attrs assert redirected_to(conn) == user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:show</span></span>, user, post) assert Repo.get_by(Post, @valid_attrs) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test <span class="hljs-string"><span class="hljs-string">"does not update chosen resource and renders errors when data is invalid"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = build_post(user) conn = put conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:update</span></span>, user, post), <span class="hljs-symbol"><span class="hljs-symbol">post:</span></span> <span class="hljs-string"><span class="hljs-string">%{"body" =&gt; nil}</span></span> assert html_response(conn, <span class="hljs-number"><span class="hljs-number">200</span></span>) =~ <span class="hljs-string"><span class="hljs-string">"Edit post"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> test <span class="hljs-string"><span class="hljs-string">"deletes chosen resource"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> post = build_post(user) conn = delete conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:delete</span></span>, user, post) assert redirected_to(conn) == user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, user) refute Repo.get(Post, post.id) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When you fix them all, you can run the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mix test</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> command </font><font style="vertical-align: inherit;">and get green tests! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, we wrote a bit of new code, such as plugins for processing user searches and authorization, and we tested the successful cases fairly well, but we need to add tests for negative cases. </font><font style="vertical-align: inherit;">We will start with a test of what will happen when we try to gain access to posts of a user that does not exist.</font></font><br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"redirects when the specified user does not exist"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> conn = get conn, user_post_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, -<span class="hljs-number"><span class="hljs-number">1</span></span>) assert get_flash(conn, <span class="hljs-symbol"><span class="hljs-symbol">:error</span></span>) == <span class="hljs-string"><span class="hljs-string">"Invalid user!"</span></span> assert redirected_to(conn) == page_path(conn, <span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>) assert conn.halted <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We did not include </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">: user</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in comparison with the sample from the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">setup</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> block </font><font style="vertical-align: inherit;">, </font><font style="vertical-align: inherit;">since </font><font style="vertical-align: inherit;">we do not use it here. </font><font style="vertical-align: inherit;">We also check that the connection is closed at the end. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, we need to write a test in which we will try to edit someone else's post.</font></font><br><br><pre> <code class="ruby hljs">test <span class="hljs-string"><span class="hljs-string">"redirects when trying to edit a post for a different user"</span></span>, <span class="hljs-string"><span class="hljs-string">%{conn: conn, user: user}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> other_user = User.changeset(%User{}, <span class="hljs-string"><span class="hljs-string">%{email: "test2@test.com", username: "test2", password: "test", password_confirmation: "test"}</span></span>) <span class="hljs-params"><span class="hljs-params">|&gt; Repo.insert! post = build_post(user) conn = get conn, user_post_path(conn, :edit, other_user, post) assert get_flash(conn, :error) == "You are </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">not</span></span></span><span class="hljs-params"> authorized to modify that post!" assert redirected_to(conn) == page_path(conn, :index) assert conn.halted </span><span class="hljs-keyword"><span class="hljs-params"><span class="hljs-keyword">end</span></span></span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We create another user who will become our </font></font><i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">bad user</font></font></i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> and add it to </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Repo</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">Then we try to access the </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">edit</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> action </font><font style="vertical-align: inherit;">for the post of our first user. </font><font style="vertical-align: inherit;">This will make the negative case of our plugin </font></font><b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">authorize_user work</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ! </font><font style="vertical-align: inherit;">Save the file, run the command </font></font><code>mix test</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">and wait for the results:</font></font><br><br><pre> <code class="bash hljs">....................................... Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> 0.4 seconds 39 tests, 0 failures Randomized with seed 102543</code> </pre><br>  That's it!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Done a lot! </font><font style="vertical-align: inherit;">But now we have a functional (and more secure blog) with posts created by users. </font><font style="vertical-align: inherit;">And we still have good test coverage! </font><font style="vertical-align: inherit;">It's time to take a break. </font><font style="vertical-align: inherit;">We will continue this series of training materials by adding the role of administrator, comments, support for Markdown, and finally we will break into channels with a live commenting system!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> An important conclusion from the translator </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I have done a great job of translating both this article and the translation of the entire series. </font><font style="vertical-align: inherit;">What I continue to do now. </font><font style="vertical-align: inherit;">Therefore, if you liked the article itself or initiatives in popularizing Elixir in runet, please support the article with pluses, comments and reposts. </font><font style="vertical-align: inherit;">This is incredibly important both for me personally and for the whole </font></font><a href="http://wunsh.ru/%3Futm_source%3Dhabrahabr%26utm_medium%3Dcontent%26utm_campaign%3Dblog-phoenix-2"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Elixir community</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> as a whole.</font></font><br><br><h2>  Other series articles </h2><br><ol><li>  <a href="https://habrahabr.ru/post/311088/">Introduction</a> </li><li>  Authorization </li><li>  <a href="https://habrahabr.ru/post/315252/">Adding Roles</a> </li><li>  <a href="https://habrahabr.ru/post/316368/">Process roles in controllers</a> </li><li>  <a href="https://habrahabr.ru/post/316996/">We connect ExMachina</a> </li><li>  <a href="https://habrahabr.ru/post/317550/">Markdown support</a> </li><li>  <a href="https://habrahabr.ru/post/318790/">Add comments</a> </li><li>  <a href="https://habrahabr.ru/post/323462/">We finish with comments</a> </li><li>  <a href="https://habrahabr.ru/post/332094/">Channels</a> </li><li>  <a href="https://habrahabr.ru/post/333020/">Channel testing</a> </li><li>  <a href="https://habrahabr.ru/post/335048/">Conclusion</a> </li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">About all inaccuracies, errors, poor translation, please write personal messages, I will promptly correct. </font><font style="vertical-align: inherit;">Thanks in advance to everyone involved.</font></font></div><p>Source: <a href="https://habr.com/ru/post/313482/">https://habr.com/ru/post/313482/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313472/index.html">Slideshow without JS</a></li>
<li><a href="../313474/index.html">Short and simple about the complex - the service "8-800" (Freephone)</a></li>
<li><a href="../313476/index.html">Simplify Excel binary search - Double VLOOKUP Trick implementation using UDF</a></li>
<li><a href="../313478/index.html">GPU in the clouds</a></li>
<li><a href="../313480/index.html">Grandstream IP phones and Avaya Aura PBX</a></li>
<li><a href="../313484/index.html">Recall all: Java JET conference. April 25, 2016. Report number 2</a></li>
<li><a href="../313486/index.html">Another way to display strings in Go</a></li>
<li><a href="../313488/index.html">Laziness is the engine of progress. Task generator Part 1</a></li>
<li><a href="../313490/index.html">Connecting oled display with controller SSD1306 to STM32 via I2C</a></li>
<li><a href="../313494/index.html">Any technological infrastructural toys for public places - say hello to Skynet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>