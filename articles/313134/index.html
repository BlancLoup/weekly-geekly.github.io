<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Acyclic Visitor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we will look at one of the options for implementing the Acyclic Visitor behavioral design pattern without using RTTI. 



 The main p...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Acyclic Visitor</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, we will look at one of the options for implementing the Acyclic Visitor behavioral design pattern without using RTTI. </p><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5c9/2bd/02e/5c92bd02e999479485082b802abe93bd.jpeg"></div><a name="habracut"></a><br><p>  The main purpose of <a href="https://en.wikipedia.org/wiki/Visitor_pattern">Visitor's</a> behavioral design pattern is the introduction of abstract functionality for the hierarchical structure of objects. </p><br><p>  The implementation of the template can be divided into two categories. </p><br><ul><li>  <strong>Cyclic Visitor</strong> .  It is based on the function overloading mechanism.  Due to the cyclical dependency (the visited hierarchy requires clarification of the type of visitor, the visitor needs to refine all classes in the hierarchy), the scope is limited only to stable hierarchies (to which new classes are rarely added). </li><li>  <strong>Acyclic Visitor</strong> .  Based on a dynamic data type identification ( <a href="https://en.wikipedia.org/wiki/Run-time_type_information">RTTI</a> ) mechanism.  There are no restrictions on visited hierarchies, but performance decreases due to the use of dynamic identification. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Typical implementation of Cyclic Visitor</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entity</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visitor</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entity &amp;)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(geometry &amp;)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(model &amp;)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entity</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~entity() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(visitor &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ obj.visit(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class"> :</span></span> entity { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(visitor &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ obj.visit(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> :</span></span> geometry { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(visitor &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ obj.visit(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test_visitor</span></span></span><span class="hljs-class"> :</span></span> visitor { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entity &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// something } void visit(geometry &amp; obj) { // something } void visit(model &amp; obj) { // something } };</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">Typical implementation of Acyclic Visitor with RTTI</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Visitable&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visitor</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_Visitable &amp;)</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-number"><span class="hljs-number">0</span></span>; }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visitor_base</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~visitor_base(){} }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entity</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~entity() {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(visitor_base &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> entity_visitor = visitor&lt;entity&gt;; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(entity_visitor * ev = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;entity_visitor*&gt;(&amp;obj)) ev-&gt;visit(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class"> :</span></span> entity { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(visitor_base &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> geometry_visitor = visitor&lt;geometry&gt;; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(geometry_visitor * gv = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;geometry_visitor*&gt;(&amp;obj)) gv-&gt;visit(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> :</span></span> geometry { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">accept</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(visitor_base &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> model_visitor = visitor&lt;model&gt;; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(model_visitor * mv = <span class="hljs-keyword"><span class="hljs-keyword">dynamic_cast</span></span>&lt;model_visitor*&gt;(&amp;obj)) mv-&gt;visit(*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test_visitor</span></span></span><span class="hljs-class"> :</span></span> visitor_base, visitor&lt;entity&gt;, visitor&lt;geometry&gt;, visitor&lt;model&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(entity &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// something } void visit(geometry &amp; obj) { // something } void visit(model &amp; obj) { // something } };</span></span></code> </pre> </div></div><br><h4>  Performance </h4><br><p>  Perform a simple operation on an array of three million items </p><br><table><thead><tr><th>  Pattern </th><th>  Time (ms) </th></tr></thead><tbody><tr><td>  Cyclic visitor </td><td>  11.3 </td></tr><tr><td>  Acyclic visitor (RTTI) </td><td>  220.4 </td></tr></tbody></table><br><p>  It can be seen that the visitor with dynamic identification is much inferior in performance to the usual pattern.  Our main task will be to preserve the acyclicity of the template, but to bring its performance closer to the version without RTTI. </p><br><h3>  Implementation </h3><br><p>  The basic idea is that for a set of visited classes from the hierarchy, the visitor generates a special late-binding table ( <a href="https://en.wikipedia.org/wiki/Virtual_method_table">vtbl</a> ) containing conversion methods that call the corresponding methods on the visitor, based on a unique identifier of the type of class being visited. </p><br><p>  So, we have two subtasks </p><br><ul><li>  Get a unique type identifier </li><li>  Generate late binding table </li></ul><br><h4>  Unique type identifier </h4><br><p>  To solve this problem, we will use the small header-only <a href="https://manu343726.github.io/2016/03/13/the-road-for-reflection-tagging-types.html">CTTI</a> library.  As a unique identifier we will use a hash calculated on the basis of a unique string type name. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> detail { <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> hash_type = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">uint64_t</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Base, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Specific&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tag</span></span></span><span class="hljs-class"> {</span></span>}; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Base, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Specific&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> hash_type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_hash</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> tag_type = tag&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::remove_cv&lt;_Base&gt;::type, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::remove_cv&lt;_Specific&gt;::type&gt;; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ctti::unnamed_type_id&lt;tag_type&gt;().hash(); } } <span class="hljs-comment"><span class="hljs-comment">/* detail */</span></span></code> </pre> <br><p>  Considering that we will process our objects polymorphically and the exact type of object will not be known to us, each class in the hierarchy should take care of the mechanism for obtaining its unique identifier.  We will add a virtual method that returns an identifier. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Base&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visitable</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> base_type = _Base; }; <span class="hljs-comment"><span class="hljs-comment">//    //       #define VISITABLE(Specific) \ static constexpr detail::hash_type hash__ = detail::get_hash&lt;base_type, Specific&gt;(); \ virtual detail::hash_type get_hash() const \ {\ return hash__; \ }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entity</span></span></span><span class="hljs-class"> :</span></span> visitable&lt;entity&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISITABLE(entity); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~entity() {} }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class"> :</span></span> entity { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISITABLE(geometry); }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> :</span></span> geometry { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISITABLE(model); };</code> </pre> </div></div><br><h4>  Generating a late link table </h4><br><p>  As a container for the converter methods, we will use the standard associative container <a href="http://en.cppreference.com/w/cpp/container/map">map</a> with a unique identifier of the visited type as the key. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> detail { <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Visitor, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Base&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vtbl_traits</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">//    . //        using base_type = _Base; //   using visitor_type = _Visitor; //    -  using function_type = void(visitor_type::*)(base_type &amp;); }; template&lt;typename _Traits&gt; struct vtbl { using base_type = typename _Traits::base_type; using function_type = typename _Traits::function_type; using visitor_type = typename _Traits::visitor_type; //        template&lt;typename _Specific&gt; void put(function_type function) { vtbl_[get_hash&lt;base_type, _Specific&gt;()] = function; } //         function_type get(const hash_type &amp; hash) const { auto it = vtbl_.find(hash); return it != vtbl_.end() ? it-&gt;second : nullptr; } private: std::map&lt;hash_type, function_type&gt; vtbl_; }; } /* detail */</span></span></code> </pre> <br><p>  Dale we need to generate a table for the list of classes that we will attend </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> detail { <span class="hljs-comment"><span class="hljs-comment">// _Traits   // _Specifics     template&lt;typename _Traits, typename... _Specifics&gt; struct vtbl_builder { //   using vtbl_type = vtbl&lt;_Traits&gt;; //   using visitor_type = typename _Traits::visitor_type; //    using base_type = typename _Traits::base_type; template&lt;typename... _Targets&gt; struct targets {}; vtbl_builder() { //    put_thunk(targets&lt;_Specifics...&gt;()); } const auto * get_vtbl() const { return &amp;vtbl_; } private: template&lt;typename _Specific, typename... _Tail&gt; void put_thunk(targets&lt;_Specific, _Tail...&gt;) { //        //      . //         using specific_type = constancy_t&lt;base_type, _Specific&gt;; using is_put = typename has_visit_method&lt;visitor_type, specific_type&gt;::type; put_thunk(targets&lt;_Specific, _Tail...&gt;(), is_put()); } //          //   thunk      template&lt;typename _Specific, typename... _Tail&gt; void put_thunk(targets&lt;_Specific, _Tail...&gt;, std::true_type) { vtbl_.template put&lt;_Specific&gt;(&amp;visitor_type::template thunk&lt;base_type, _Specific&gt;); put_thunk(targets&lt;_Tail...&gt;()); } //          //   ,     template&lt;typename _Specific, typename... _Tail&gt; void put_thunk(targets&lt;_Specific, _Tail...&gt;, std::false_type) { put_thunk(targets&lt;_Tail...&gt;()); } void put_thunk(targets&lt;&gt;) {} private: vtbl_type vtbl_; }; //         template&lt;typename _Traits, typename... _Specifics&gt; inline const auto * get_vtbl() { static vtbl_builder&lt;_Traits, typename std::remove_cv&lt;_Specifics&gt;::type...&gt; builder; return builder.get_vtbl(); } } /* detail */</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Add constancy to type based on constancy of another type</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _From, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _To&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constancy_t</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::conditional&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::is_const&lt;_From&gt;::value, <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> _To, _To&gt;::type;</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">We check the availability of the method</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Visitor, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Specific&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has_visit_method</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Class, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Param&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">auto</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(_Param * p)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decltype</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::declval&lt;_Class&gt;().visit(*p), </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::true_type())</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span>&gt; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">false_type </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">test</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(...)</span></span></span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> type = <span class="hljs-keyword"><span class="hljs-keyword">decltype</span></span>(test&lt;_Visitor, _Specific&gt;(<span class="hljs-literal"><span class="hljs-literal">nullptr</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> value = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::is_same&lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::true_type, type&gt;::value; };</code> </pre> </div></div><br><p>  It remains for us to define the converter methods and describe the object's processing mechanism. </p><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Base&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">visitor_traits</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">//      using base_type = _Base; }; //     template&lt;typename _Visitor, typename _Traits&gt; struct visitor { using visitor_type = _Visitor; using traits_type = _Traits; // -,       template&lt;typename _Base, typename _Specific&gt; void thunk(_Base &amp; base) { using specific_type = detail::constancy_t&lt;_Base, _Specific&gt;; static_cast&lt;visitor_type*&gt;(this)-&gt;visit(static_cast&lt;specific_type&amp;&gt;(base)); } //    template&lt;typename _Base&gt; void operator()(_Base &amp; base) { // ,      //    . static_assert(std::is_base_of&lt;typename traits_type::base_type, _Base&gt;::value, ""); //   . //  _Base     //     using base_type = detail::constancy_t&lt;_Base, typename traits_type::base_type&gt;; using traits_type = detail::vtbl_traits&lt;visitor_type, base_type&gt;; //      . //   get_vtbl     const auto * vtbl = static_cast&lt;visitor_type*&gt;(this)-&gt;template get_vtbl&lt;traits_type&gt;(); //       , //      ,  if(auto thunk = vtbl-&gt;get(base.get_hash())) (static_cast&lt;visitor_type*&gt;(this)-&gt;*thunk)(base); } }; //          //    - #define VISIT(...) \ template&lt;typename _Traits&gt; \ const auto * get_vtbl() const \ { \ return detail::get_vtbl&lt;_Traits, __VA_ARGS__&gt;(); \ }</span></span></code> </pre> <br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">entity</span></span></span><span class="hljs-class"> :</span></span> visitable&lt;entity&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISITABLE(entity); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ~entity() {} }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">geometry</span></span></span><span class="hljs-class"> :</span></span> entity { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISITABLE(geometry); }; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">model</span></span></span><span class="hljs-class"> :</span></span> geometry { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISITABLE(model); }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>&lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> _Visitor&gt; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> visitor_entities = visitor&lt;_Visitor, visitor_traits&lt;entity&gt;&gt;; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">test_visitor</span></span></span><span class="hljs-class"> :</span></span> visitor_entities&lt;test_visitor&gt; { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: VISIT(entity, geometry, model); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">visit</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> entity &amp; obj)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// something } void visit(const geometry &amp; obj) { // something } void visit(const model &amp; obj) { // something } }; int main() { const entity &amp; ref_entity = entity(); const entity &amp; ref_model = model(); const entity &amp; ref_geometry = geometry(); test_visitor test; test(ref_entity); test(ref_model); test(ref_geometry); }</span></span></code> </pre> </div></div><br><h4>  Performance </h4><br><p>  Performance on the same dough with different standard containers for late binding table </p><br><table><thead><tr><th>  Pattern </th><th>  Time (ms) </th></tr></thead><tbody><tr><td>  Cyclic visitor </td><td>  11.3 </td></tr><tr><td>  Acyclic visitor (RTTI) </td><td>  220.4 </td></tr><tr><td>  Acyclic visitor with map </td><td>  23.2 </td></tr><tr><td>  Acyclic visitor with unordered_map </td><td>  44.5 </td></tr><tr><td>  Acyclic visitor with sort vector </td><td>  31.1 </td></tr></tbody></table><br><hr><br><p>  The project code can be found on <a href="https://github.com/PkXwmpgN/snape">github</a> . </p><br><p>  I would be happy for comments and suggestions (you can mail yegorov.alex@gmail.com) <br>  Thank! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/313134/">https://habr.com/ru/post/313134/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../313124/index.html">Backup with Open Source Solution - Bareos</a></li>
<li><a href="../313126/index.html">How to get into gamedev and become a sought-after specialist. Part 2</a></li>
<li><a href="../313128/index.html">From Jquery UI to Ext.js: a review of javascript UI libraries for the SPA. Part 1</a></li>
<li><a href="../313130/index.html">Dive into the blockchain technology: Ecosystem of digital dentistry</a></li>
<li><a href="../313132/index.html">VK rake SDK for Android</a></li>
<li><a href="../313136/index.html">Karate Motivation: How to stop worrying about inefficient employees?</a></li>
<li><a href="../313138/index.html">Kinematics modeling is not difficult</a></li>
<li><a href="../313142/index.html">Joker 2016 Java Conference: More, More, More Interesting</a></li>
<li><a href="../313144/index.html">QEMU / KVM and Windows installation</a></li>
<li><a href="../313146/index.html">OpenShift + Jenkins + Bitbucket, continuous integration and publishing out of the box</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>