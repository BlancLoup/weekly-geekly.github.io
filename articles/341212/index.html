<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hacking Bitcoin on TV: obfuskuy, not obfuskuy, still get QR</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story about how the secret key for Bitcoin in the form of a QR code was restored from the smeared picture 


 We could just call this post ‚ÄúHow go...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hacking Bitcoin on TV: obfuskuy, not obfuskuy, still get QR</h1><div class="post__text post__text-html js-mediator-article"><h3>  The story about how the secret key for Bitcoin in the form of a QR code was restored from the smeared picture </h3><br><img src="https://habrastorage.org/webt/5s/1x/kz/5s1xkzvlk1cic5dmnnwzeu53lbm.jpeg" alt="image"><br><br>  We could just call this post ‚ÄúHow good is the QR code and how we restored it from almost nothing.‚Äù  But it is much more interesting when the QR code is the key to the wallet worth $ 1000 in cue ball. <br><a name="habracut"></a><br><iframe width="560" height="315" src="https://www.youtube.com/embed/hN0_1pU4U5w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <i>Part of a documentary film where Roger Ver talks about Bitcoin wallets.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>Before we begin, I will answer: we do not know the journalists who recorded the interview, and we do not know Roger W.</b>  <b>Anyone who had access to this video could get the secret key.</b> <br><br>  Bitcoin, Ethereum, Litecoin, Dash, Neo ... <br>  Cryptocurrencies are everywhere and are developing rapidly.  As for me, I‚Äôve been watching bitcoin since 2013 (but that doesn‚Äôt mean I‚Äôm buying).  I had to read ‚ÄúMastering Bitcoin‚Äù 3 times to understand how each part of it really functions and to be able to explain it to others.  Still, I cannot keep up with the modern market, new cryptocurrencies, algorithms, new ICOs are everywhere and appear every day. <br><br>  It is easy to start using cryptocurrency by following online tutorials.  You simply download any wallet application, create a pair of keys and buy a cryptocurrency on one of the exchangers, but at the same time, the cryptocurrency learning curve is rather complicated. <br><br>  And if you do not fully understand how each part of this mechanism functions, you should avoid working with cryptocurrency, otherwise you risk losing your money if you fall into one of the many traps.  One of them, keeping your secret key safe, is the topic of this post. <br><br>  The basic rule of the "Cryptographic Club": <b>do not share your secret key with others.</b> <br><br>  The most important thing you have when working with cryptocurrency is your secret security key.  If you lost it, you can say you lost your money.  If someone gains access to your security key, you will also lose your money.  It's simple. <br><br>  Using a real example, we will show you how step by step we restored the secret key $ 1000 of a bitcoin wallet created by @rogerkver for the French TV show ‚ÄúCompl√©ment d'enqu√™te‚Äù, although it was smeared. <br><br><h3>  Introduction </h3><br>  Last week, France 2 broadcast a bitcoin documentary.  They interviewed @rogerkver, who decided to offer $ 1,000 in Bitcoins for the fastest viewer.  Unfortunately, the QR code and the secret key were smeared by France 2. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/e33/2fb/aef/e332fbaef82fbdf2ad99414c70d167a9.png" alt="image"></div><br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f02/d73/1ca/f02d731ca3f0c6ed01de7f33b6b479ff.png" alt="image"></div><br>  <i>Figure 1. Difficult QR code and secret key.</i> <br><br>  I saw several people complaining about this on Twitter, and some even left tweets claiming that ‚ÄúFrance 2‚Äù decided to keep Bitcoins for themselves.  This is an erroneous assumption, ‚ÄúFrance 2‚Äù closed the QR code not because it wanted to hold Bitcoins, but because it was legally obliged. <br><br>  You can try to scan the QR code with as many applications as you can but you will not be able to decrypt it because of the strong blurring. <br><br>  The story could end at this point, $ 1000 would be lost forever, because I do not think that Roger Werth kept a copy of the secret key.  Only interview journalists can buy out the bitcoins. <br><br>  But, at the very end of the interview, they showed a small part of the QR code.  Did they do it on purpose, knowing that $ 1,000 would be lost if no one could find the secret key?  Or was it one of the mistakes you can make when starting to use cryptocurrency? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2cc/68f/601/2cc68f601e5b207f577b35e25a03bc61.png" alt="image"><br><br>  <i>Figure 2. The open part of the QR code and the smeared string with the key below.</i> <br><br>  I was going to write to my friend <a href="https://twitter.com/clementstorck">@clementstorck</a> when I received a screenshot of the QR code he took.  We decided to work in order to find out whether it is possible to obtain the secret key with such a small amount of information. <br><br>  <b>Let's be honest, the chances of finding the secret key using only brute-force search were close to zero.</b>  <b>We knew the properties of QR codes and their resistance to damage.</b>  <b>Our goal was to gather as much information as possible, in order to reduce the number of unknown parameters to a minimum.</b>  <b>We knew that at some step, let's resort to busting.</b>  <b>After all the steps below, we had to go through a total of 2,097,152 combinations =).</b> <br><br>  So where do we start?  Below are all the steps we took to get the secret key. <br><br><ol><li>  Collection of information </li><li>  Let's poshaman.  Image processing. </li><li>  Standard QR code, part 1 </li><li>  QR code reconstruction </li><li>  Standard QR code, part 2 </li><li>  QR code decoding </li><li>  Error correction code </li><li>  Python Brutus </li></ol><br><h3>  1. Collecting information </h3><br>  The first step was to collect as much information from the interview as possible.  We observed the playback frame by frame and took several pictures, such as: <br><br>  The public key that leads us to the (almost) <a href="https://www.blocktrail.com/BTC/address/17Qgadvc7pm51mV9r9zUAs4xU1XXwDRr8o">empty BTC wallet</a> .  Roger Ver lied?  Many people talked about this on Twitter.  He did not lie, on his twitter post is posted, where he talked <a href="https://twitter.com/rogerkver/status/913705294546341888">about the sale</a> .  We had to look for a <a href="https://cashexplorer.bitcoin.com/address/17Qgadvc7pm51mV9r9zUAs4xU1XXwDRr8o">bch wallet</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/fc9/45d/86f/fc945d86f89dc948137e539a7239c071.png" alt="image"></div><br>  <i>Figure 3. Public key and QR code: 17Qgadvc7pm51mV9r9zUAs4xU1XXwDRr8o</i> <br><br>  Blurred part of the line with the access key.  We will use it at the stage of image analysis to get the first 6 letters.  The error correction step will give us the next 7 letters. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7a3/413/fdf/7a3413fdfd09450d29056b7d4e0c6ff6.png" alt="image"><br><br>  <i>Figure 4. An anointed part of the string with a secret key.</i>  <i>You can make out a few words, but basically the picture is not clear.</i> <br><br>  The last letter of the secret key will also be useful for unlocking the 8 extreme characters of the key. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/320/1b8/ab1/3201b8ab1f7541db6c4b404ed4d7e077.jpg" alt="image"></div><br>  <i>Figure 5. The last letter is well distinguishable V.</i> <br><br>  Screenshots of poor quality at the top and bottom of the QR code.  They will also be useful to get (some) more data and fill in the QR code during the recovery phase. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4ef/8b8/d74/4ef8b8d748c08ca9896204089214f21d.png" alt="image"><br><br>  <i>Figure 6. Top of the QR code, the first line can be used.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ace/aeb/159/aceaeb1594e0a2e43499d09b1a443ed9.png" alt="image"></div><br>  <i>Figure 7. What, seriously ??</i>  <i>The left part of the QR code, the first two columns, can also be (partially) used.</i> <br><br>  The tool he used to create public and private keys is the <a href="https://tools.bitcoin.com/paper-wallet/">Single Wallet</a> tool <a href="https://tools.bitcoin.com/paper-wallet/">on Bitcoin.com</a> .  This gave us information about the data inside the QR code: 32 Bitcoin wallet tivol key similar to this. <br><br><blockquote>  KwjiU4CVAmdyxyDbvkbx2XbSoU1nxZgyXz7usqAemvsd4RdGHoPF </blockquote><br><br>  The next step is to recreate a QR code. <br><br><h3>  2. Poshaman.  Image processing </h3><br>  Well, at this stage we have less than 1/3 of the QR code, we are still far from the secret key.  What can we learn from screenshots? <br><br>  We decided to focus on 2 screenshots, the first is a blurred QR-code of the secret key, we wanted to know if QR-code applications can read it after processing. <br><br>  The second screenshot we wanted to work on had a small part of the secret key.  We knew that we needed to have at least a small amount of data if we wanted the Error Correction Code (ECC) to work. <br><br>  We decided to send screenshots to our experts.  With a lot of results :) <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/LhF_56SxrGk" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  This is what we got after partially removing the blur effect. <br><br>  The version of the QR code after processing was also not decoded by any of the applications for reading the QR code.  We decided to try, because this guy conducted some tests on QR codes, and in the comments confirmed that they are scanned <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/a7e/bcd/189/a7ebcd189a2206a8b0783a4727e9bc7e.png" alt="image"></div><br>  <i>Figure 8. We did not find anything in this photo.</i>  <i>Only confirmation of the last letter.</i> <br><br>  Two non-blurred versions of the secret key string.  The first gives us the first four letters (we clearly do not see "K"), and the second gives the first six letters (we do not see the "z"). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/75e/8f2/80f/75e8f280f229bb297321a914dd0b1f36.png" alt="image"></div><br>  <i>Figure 9. The photo is not clear, but you can see ‚ÄúyUz‚Äù.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/5a6/6f1/4d8/5a66f14d8345b909039f7eedbbe34e85.png" alt="image"></div><br>  <i>Figure 10. You can read the first 6 characters of ‚ÄúKyU? SR‚Äù</i> <br><br>  Leave this information for later.  She will help us make up a few bits later. <br><br><h3>  3. Standard QR code, part 1 </h3><br>  It was important to understand how QR codes work and the limitations of their ECC capabilities in restoring a damaged QR code. <br><br>  <a href="https://en.wikipedia.org/wiki/QR_code">Wikipedia</a> is a good start, but all we needed was in <a href="https://www.iso.org/standard/62021.html">ISO / IEC 18004</a> (there is a free version of the first edition on <a href="http://www.swisseduc.ch/">Swisseduc</a> ).  We also found this <a href="http://www.thonky.com/qr-code-tutorial/introduction">treasure</a> online. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/674/30d/c18/67430dc1862e96338dad5a955779354b.png" alt="image"></div><br>  <i>Figure 11. Error Correction Level and the QR Code Mask can be extracted from this screenshot.</i> <br><br>  Before we begin to reconstruct the QR code, let's see what we can extract from this image using the ISO standard and the structure of the QR code. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ae4/8a2/ef5/ae48a2ef596fddef5aa97684d6695e11.png" alt="image"><br><br>  <i>Figure 12.</i> <br><br>  Interesting for us was the blue bar (x: 8, y: 22-28). <br><br>  This is part of the format information line (15-bit sequence, 5 data bits and 10 <a href="https://en.wikipedia.org/wiki/BCH_code">BCH</a> error correction bits).  The bits located at (x: 8, y: 22-28) are bits 8-14 lines.  We had only 7 bits out of 15, but that was enough to find the information we need. <br><br>  The format information line encodes the error correction (EC) level and mask pattern applied to the QR code.  There are 4 possible EC levels (L, M, Q, H) and 8 possible mask patterns =&gt; 32 possible information formats of information. <br><br>  Details on how to create an information line can be found on page 76 of the standard (Appendix C - Format Information).  A list of 32 options can be found <a href="http://www.thonky.com/qr-code-tutorial/format-version-tables">here</a> . <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/78e/f6f/5b1/78ef6f5b1ac69399c12aae0ac5f77997.png" alt="image"></div><br>  <i>Figure 13.</i> <br><br>  Top down.  We have bits from 8 to 14 of the information line.  Bit 14 is the most significant.  In screenshot No. 11 we can read it. <br><br><blockquote>  0011001XXXXXXXX </blockquote><br><br>  Quick search in the table of information format lines.  The only combination that corresponds to the one that corresponds to the ECC level: And has a mask: 3 <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/dd2/b8c/253/dd2b8c2535a04e7c14d8a86650b48062.png" alt="image"></div><br>  <i>Figure 14.</i> <br><br>  We also needed to find a QR code coding format.  There are five different encoding formats (each of them uses its own method for converting text into bits): <br><br><ul><li>  Numeric (0-9) </li><li>  Alphanumeric (0-9; AZ; nine other characters: space $% * + -. / :) </li><li>  8-bit byte (JIS character set 8 bit. <a href="https://en.wikipedia.org/wiki/JIS_X_0201">JIS X 0201</a> Japanese version os <a href="https://en.wikipedia.org/wiki/ISO/IEC_646">ISO 646</a> ) </li><li>  Kanji (JIS Shift character, can encode each kanji character in 2 bytes) </li><li>  ECI (Extended Channel Interpretation, if you need special / custom encoding) </li></ul><br>  <b>The QR code coding format is an 8-bit Byte type</b> , the numeric and alphanumeric type are not supported by the alphabet of the secret key (no lowercase letters), Kanji encodes 2 bytes each (we need only one), and ECI is brute force . <br><br>  We were almost ready to begin the reconstruction of the QR code, the last thing we needed to know the size of the QR code. <br><br>  There are 40 varieties of QR code sizes (called versions).  They can start from 21x21 pixels (version 1) to 177x177 pixels (version 40).  They grow by 4x4 pixels each time they increase their version number.  Each version has a maximum capacity based on the coding format and error correction level. <br><br>  The capacity of each QR code depends on its version and error correction level.  Details can be found on page 28 of the ISO standard. <br>  We knew that the QR code should have stored 52 characters (416 bits) with an error correction level of H. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/ac1/802/046/ac1802046c1681ee0e207b105c9624de.png" alt="image"></div><br>  <i>Figure 15. V6 is the smallest size that can hold a 416-bit key with an error correction level of H. V5 is too small, V7 is too large.</i> <br><br>  Size of QR code 6th version 41x41px. <br><br>  Now we had all the information necessary to start the reconstruction of the QR code. <br><br><h3>  4. Reconstruction of the QR code </h3><br>  We know that we had to restore a QR code of 41x41 pixels.  We decided to work on the Google spreadsheet (where it is easy to draw and use functions such as masking a QR code). <br><br>  We completed the following steps: <br><br><ol><li>  Draw each template that is part of the standard (positioning template, alignment template (only one from QR code version 6), synchronization template and dividers, as shown in Figure 12) </li><li>  Add bits from the format information string found in the previous step. </li><li>  Fill in the rest of the QR code based on the screenshot 11 we took. </li></ol><br>  Let's also use the top and left screenshots of the QR code.  It is not so much, but at this stage every bit matters. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8d3/b67/71f/8d3b6771f841da55fd459135963e66b4.png" alt="image"></div><br>  <i>Figure 16. As we collected a few more bits in the upper rows.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/f9e/4fc/618/f9e4fc618a3663e9a108624408c50aeb.png" alt="image"></div><br>  <i>Figure 17. The same process for the left side of the QR code (rotate 90 ¬∞)</i> <br><br>  Below is a QR code that we were able to recover.  The next step is to define a sequence of bits to extract the code words and error correction code words. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/7b5/d5b/204/7b5d5b204798fb5dfc0c746cff6ddfed.gif" alt="image"></div><br>  <i>Fig.</i>  <i>18. Step-by-step reconstruction of the QR code.</i> <br><br><h3>  5. Standard QR code, part 2 </h3><br>  We needed to understand how to read a QR code if we want to extract more bits from it. <br><br>  A QR code consists of <b>data code words</b> and <b>error correction code blocks</b> . <br>  Each block has a length of 8 bits, and each bit is represented by a module (black or white square).  You cannot say just looking at a QR code that a specific white square is ‚Äú0‚Äù or ‚Äú1‚Äù, because, as we will see later, a mask is applied to the QR code before its visualization. <br><br>  <b>The data code words</b> contain the message / data encapsulated in a simple protocol, shown below (details can be found on page 17 of the ISO standard): <br><br><ul><li>  Mode Indicator: 4 bit identifier indicating in which encoding mode the message / data sequence is encoded. </li><li>  Number of characters indicator: a sequence of bits that indicates the length of the message.  Changes according to the coding mode and the version of the QR code. </li><li>  Message / data flow (secret key).  (8 bits per character) </li><li>  Terminator: 4 bits used to complete the bit string representing the message. </li><li>  Fill bits: used to fill empty bitstream positions. </li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/886/7ce/83d/8867ce83de77333d4a4b587c609e570f.png" alt="image"><br><br>  <i>Fig.</i>  <i>19. A bitstream containing data codewords.</i> <br><br>  ECC code words (error-correcting code) are added to a sequence of data code words to detect and correct data code words in case of errors or erasures.  These are <a href="https://en.wikipedia.org/wiki/Reed%25E2%2580%2593Solomon_error_correction">Reed-Solomon</a> codes created from data code words.  We'll talk a little more about them in step 7. <br><br>  The number of data codes and error correction codes (ECC) depends on the version and level of error correction.  They are divided into groups (1 or 2) and into blocks (from 1 to 67) depending on the version and level of error correction. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/bc2/cdd/bf8/bc2cddbf80e9f6a7aa3d00fa16f07f35.png" alt="image"></div><br>  <i>Fig.</i>  <i>20. Error Correction Characteristics for Version 6 (p. 35 of the ISO standard)</i> <br><br>  In our case (version 6, H level) we will have 15 data code words and 28 ECC code words for each block.  The QR code will contain 1 group of 4 blocks for a total of 172 code words. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/d9f/251/358/d9f2513586697c213656ff3797aca2a1.png" alt="image"></div><br>  <i>Fig.</i>  <i>21. Blocks of data codes.</i>  <i>Each Codeword has a length of 8 bits.</i>  <i>They carry part of the bitstream from Figure 19.</i> <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b92/31f/07d/b9231f07d28d8886269f1f34497177fe.png" alt="image"></div><br>  <i>Figure 22. ECC Codewords blocks.</i>  <i>They are 8-bit Reed-Solomon codes obtained from data blocks.</i> <br><br><h3>  6. QR code decoding </h3><br>  The next step was to read the QR code and fill out as many tables of data code words and ECC from step 5. <br><br>  The first step was to unmask (unmask) a QR code.  We used the Google spreadsheet to create a mask and used the BITXOR function to apply it. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/b1f/efa/b98/b1fefab9802f10f70980682099bb188d.png" alt="image"></div><br>  <i>Figure 23. When applied to the QR code, each green mask module inverts the color of the module.</i> <br><br>  The result of the masking process is a readable QR code.  How to read a QR code and where to start?  The ISO standard explains how code words are mapped to a QR code and how to read them (p. 46: Placing a code word in a matrix). <br><br>  Let's put code words on a QR code. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/1de/c78/ce5/1dec78ce5b49c1fbb18b624fa892f876.png" alt="image"></div><br>  <i>Figure 24. Position of data codewords and error correction codes.</i>  <i>You can see regular and irregular characters.</i> <br><br>  Now let's read each of them.  Each character must be read differently depending on its shape and reading direction, as shown below, and as described on page 47 of the ISO standard. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0ee/f9a/10a/0eef9a10a56b44ddeb8b2a64514e105c.png" alt="image"></div><br>  <i>Figure 25.</i> <br><br>  Below is a readable QR code, where every X is an unknown bit. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/4f1/e48/6ff/4f1e486ff4beafbe62b56897d6a21416.png" alt="image"></div><br>  <i>Figure 26. Manual decoding, one bit at a time.</i>  <i>It looks funny, right?</i> <br><br>  We then read and populated the data tables and ECC from step 4. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/763/755/759/763755759d3a340a5c98a9fb0f678978.png" alt="image"></div><br>  <i>Fig. 27. Data code words after we read the QR code, filled in the protocol bits and those that we obtained using image analysis.</i> <br><br>  The code words # 1 and # 2 are known, since they are part of the protocol (mode indicator + number of characters indicator). <br><br>  The code words 3, 4, 6 and 7 are known based on the image analysis that we did in step 2 (‚ÄúKyUzsR‚Äù) <br><br>  Code words No. 54 to No. 60 are also known, since they are part of the protocol (Terminator + Padding bits). <br><br>  Each open "X" increases our chances of success in the ECC phase and divides by 2 the number of opportunities that we will have to overcome in the future. <br><br>  You may be wondering why the entire 5th bit of all codewords carrying the message / data is set to ‚Äú0‚Äù.  This is because we know the alphabet of the private key ( <a href="https://en.bitcoin.it/wiki/Base58Check_encoding">Base58Check</a> ), and all the characters in this alphabet begin with "0" when encoding to 8 bits.  (The 5th bit in each codeword is the first bit of each letter of the message due to the shift introduced by the bits of the first 12th protocol). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3eb/a2c/5d4/3eba2c5d45069cab58a67ba93ce94cbe.png" alt="image"><br><br>  <i>Fig. 28. Table of ECC code words after we read the QR code.</i>  <i>Here we can do nothing, since all of them are determined by the Reed-Solomon decoder.</i> <br><br>  Let's now use the magic of the error correction code to recover as much data as possible. <br><br><h3>  7. Error Correction Code </h3><br>  At this stage, we were still far from the full key value, but soon we were able to find out if we collected enough data to recover the key using ECC. <br><br>  <a href="https://en.wikipedia.org/wiki/Error_detection_and_correction">ECC</a> (Error Correction Code) is a technology that provides reliable communication over unreliable channels.  It can restore the original data, detecting and correcting errors and erasing. <br><br>  QR codes implement Reed-Solomon codes (a subtype of the BCH code, which we saw when decoding a format information line in step 3). <br>  We will not explain in detail how to encode or decode Reed-Solomon codes.  There are many good resources on the Internet, but in short: <br><br>  The Reed-Solomon coding device generates the ECC code words.  They are the remainder of the division between the polynomial representing the message and the irreducible generator polynomial. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/3e4/3d8/739/3e43d87392ace1f4210c832a9ae0c4a8.png" alt="image"></div><br>  <i>Figure 29. Irreducible generator polynomial for 28 EC code words</i> <br><br>  The Reed-Solomon decoder is a bit more complicated, because there are many ways to decode a message.  For this task there are various decoding algorithms, <a href="https://en.wikiversity.org/wiki/Reed%25E2%2580%2593Solomon_codes_for_coders">this page is</a> very useful for understanding the decoding process. <br><br>  The Reed-Solomon decoder can simultaneously decode erase and error.  Unfortunately, there is a limit called <a href="https://en.wikipedia.org/wiki/Singleton_bound">Singleton Bound</a> . <br><br>  The risk that we had had to exceed this limit.  Reed-Solomon is an optimal <a href="https://en.wikipedia.org/wiki/Forward_error_correction">FEC</a> and ‚Äúvulnerable‚Äù to <a href="https://en.wikipedia.org/wiki/Cliff_effect">the cliff effect</a> .  This means that if you exceed the limit, you cannot get anything from the EU codes, and this is where we needed to resort to brute force. <br><br>  The limit (number of corrections and error corrections) is determined by the formula below, as defined on page 33 of the ISO standard: <br><br>  e + 2 * t ‚â§ d - p <br><br>  Where: <br><br><ul><li>  e: number of corrections </li><li>  t: number of errors </li><li>  d: number of error correcting words </li><li>  p: number of code words for protection against incorrect coding (0 in our case: 6-H) </li></ul><br>  This formula means that you can correct up to 14 errors or 28 erasures per block (or their combination, if the sum does not exceed 28).  We used the fact that we knew where the erasures on the QR code were, in order to have the highest level of error correction (28 code words per block). <br><br>  Let's check each block if we are below or above the limit: <br><br><ul><li>  Block 1: data contains 6 erasures, ECC contains 22 erasures </li><li>  Block 2: data contains 12 erase, ECC contains 21 erase </li><li>  Block 3: data contains 10 erase, ECC contains 18 erase </li><li>  Block 4: data contains 6 erasures, ECC contains 21 erasures </li></ul><br>  With 28 erasures, block 3 and block 1 are at the limit, and can be restored to 100%.  The same for block 4, total 27 erasures. <br><br>  With 33 erasures, block 2 is above the limit, and we will have to resort to brute force.  Fortunately, brute force will be made on a small number of combinations. <br><br><h3>  8. Python and brute force </h3><br>  We decided to use the <a href="https://github.com/tomerfiliba/reedsolomon">Python Reed-Solomon codec</a> to decode the message. <br><br>  We will use a combination of Python code and pseudocode to describe the steps we have taken to find the final result. <br><br>  Let's start with the best scenario when we are below the limit and decode block 3, 4 and 1. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/18d/45c/484/18d45c484cf7108ababab0196dbd4da1.png" alt="image"><br><br>  <i>Figure 30. Decoding unit 3 using a Reed-Solomon decoder.</i> <br><br>  Decoding result of the 3rd block: <br><blockquote>  [115, 22, 181, 6, 151, 103, 118, 229, 22, 133, 167, 39, 101, 164, 87] </blockquote><br>  The same process for block 4, just change the values ‚Äã‚Äãof the variables mess, ecc and error_pos.  Result: <br><blockquote>  [118, 132, 183, 38, 36, 99, 116, 53, 96, 236, 17, 236, 17, 236, 17] </blockquote><br>  Block 1 decoding result: <br><blockquote>  [67, 68, 183, 149, 87, 167, 53, 39, 86, 71, 4, 230, 180, 196, 182] </blockquote><br>  So far, so good.  Unfortunately, if we try to do the same with block 2, the decoding will fail because we will increase the limit. <br><br>  The only solution we had was brute force.  We had a negative margin of 5 (33 erase instead of 28), so the goal was to restore (brute-force) 5 code words and see what result decryption gave us. <br><br>  To reduce the amount of potential, we looked at tables 27 and 28 for bytes with fewer unknown bits.  Interesting were the code words 17, 19, 20, 27 and the EC code word 50. <br><br>  21 unknown bits add up to 2¬≤¬π (2,097,152) combinations.  Not so much.  Below is the brute force pseudocode. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2bb/a68/a94/2bba68a94d48f1df46ecce4ce3a8c37b.png" alt="image"><br><br>  <i>Figure 31. The brute force of the second block gives us the last bits needed.</i> <br><br>  My i5-6600K processor was able to calculate about 30,000 keys per minute on a single core.  It took 30 minutes and 838,849 samples to find the first solution that was suitable for recovering the secret key (of these 2,097,152 combinations, there were only 2 solutions that matched the filters). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/618/2e8/953/6182e89536a09935d519bd71591f9d7b.png" alt="image"></div><br>  <i>Figure 32. Bruteforce block 2.</i> <br><br>  Result for the second block: <br><blockquote>  [85, 99, 35, 131, 19, 84, 181, 99, 148, 87, 165, 38, 99, 116, 84] </blockquote><br>  Now we have all the code words, the last step is to convert all these code words to binary, fill in table 27, trim the first 12 bits, the last 52 bits, decode and voila! <br><br>  The end result is a secret key: <br><blockquote>  KyUzsRudpNkLKeV2815KV9EzRf7EG1kPivwnQhZrvZEwhKrbF7CV </blockquote><br>  It goes without saying that you should not use this secret key, since it is no longer relevant! <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/81b/335/f76/81b335f7698a52cf9c928be59b7e5b11.png" alt="image"></div><br>  <i>QR code of the secret key is restored.</i> <br><br>  Roger, thank you for the sale.  The BCH redemption process was not as simple as scanning a QR code on TV, but it was difficult and fun. <br><br>  <i>Translation: Vyacheslav Bukatov</i> <br><br><hr><br>  <em><font color="#999999">The translation was carried out with the support of the company <a href="https://www.edsd.ru/">EDISON Software</a> , which professionally develops accounting systems for enterprises, for example, <a href="https://www.edsd.ru/formirovanie-zakaza-na-izgotovlenie-na-1s-upravlenie-proizvodstvennym-predpriyatiem">accounting of production and sales of typographic products</a> and <a href="https://www.edsd.ru/uchet-poseshhenij-bassejna-na-1s-predpriyatie">accounting of pool visits</a> .</font></em> <em><br><br></em> <h3>  <em>Read more</em> </h3> <em><br></em> <ul><li>  <em><a href="https://habrahabr.ru/company/edison/blog/341060/">UX design: 50 things you probably forgot to do</a></em> </li><li>  <em><a href="https://habrahabr.ru/company/edison/blog/340892/">How to lead people who have more technical experience than you</a></em> </li><li>  <em><a href="https://habrahabr.ru/company/edison/blog/340602/">How I stopped selling food on the street and started working in top technology companies</a></em> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/341212/">https://habr.com/ru/post/341212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../341198/index.html">Some features of programming time events in games</a></li>
<li><a href="../341200/index.html">2.Check Point to the maximum. HTTPS Inspection</a></li>
<li><a href="../341202/index.html">MockK - library for mocking in Kotlin</a></li>
<li><a href="../341206/index.html">The digest of interesting materials for the mobile developer # 227 (October 23 - October 29)</a></li>
<li><a href="../341208/index.html">Barnes-Hut t-SNE and LargeVis: visualization of large amounts of data</a></li>
<li><a href="../341216/index.html">How to create multiple VMFS datastores on a single disk device</a></li>
<li><a href="../341218/index.html">Android and custom fonts or ‚ÄúLong live API 26‚Äù</a></li>
<li><a href="../341220/index.html">Improving the quality of staff selection based on data</a></li>
<li><a href="../341226/index.html">Broo - lossless compression algorithm. Improvements</a></li>
<li><a href="../341228/index.html">VPS hosting: how to choose?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>