<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Direct work with the MTS SMS-service: the history of one integration</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many believe that SMS is one of the reasons that Twitter ‚Äúshot‚Äù so well in the West. In the United States and several European countries, tweets can b...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Direct work with the MTS SMS-service: the history of one integration</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/fd3/d6c/fca/fd3d6cfca5053dd6a071a02ce74c3bb5.jpg" align="left">  Many believe that SMS is one of the reasons that Twitter ‚Äúshot‚Äù so well in the West.  In the United States and several European countries, tweets can be both published and received via SMS, while the price of outgoing tweets is equal to the price of an ordinary SMS, and incoming messages are free.  For users without smartphones (most of which), this significantly reduces the threshold for entry. <br><br>  In this article, I will share the experience of direct integration with a large Russian mobile operator (note: it is directly, and not through gateways), as well as at an introductory level, I discuss about SMS technology and the SMPP protocol - without boring tables and specifications, in the style of short detective story. <a name="habracut"></a><br><br><h2>  Plot plot </h2><br>  Once we ( <a href="http://rutwit.ru/">Rutvit</a> ) addressed a proposal to the largest telecoms operator, MTS.  We understood that in order to make the price of a tweet indistinguishable from the price of a regular SMS, we need direct integration with the PPSA (by the way, this word stands for ‚ÄúCellular Operator‚Äù).  MTS is a huge company, sharpened to cooperate with major partners, so I thought that our proposal would not be considered soon, and did not particularly count on success.  What was our joy when MTS not only quickly responded, but also, as a result of constructive negotiations, decided to launch a joint project with Rutvit. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We all know that large companies are often slow and cumbersome, but this does not seem to apply to MTS.  The working group we contacted during the integration process quickly responded to our questions, and we moved forward.  This was especially valuable in the context that direct integration with the cellular operator turned out to be an order of magnitude more difficult than connecting some popular SMS gateway: I‚Äôll also talk about technical details near the end of the article. <br><br>  And here we first launched the alpha version of the SMS service on Rutvit (read the <a href="">press release</a> on the PRIME-TASS website <a href="">together with MTS</a> ), and today we replace the alpha icon with a beta in this service, which we report in this article .  The service, among other things, allows you to send tweets via SMS at a regular cost (according to the subscriber‚Äôs tariff plan) not only to Rutvit, but also to big Twitter via the export mechanism. <br><br>  So, you can send tweets via SMS for exactly the same money for which you send any other SMS.  For the same purpose, we decided to use not a short number, but a more familiar, long one: <b>+7 916 140-0-140</b> .  People often do not trust short numbers, because  they are not sure how much money will be taken from them for SMS: it‚Äôs as if there is no such problem with a long number. <br><br><h3>  How to start writing tweets by SMS? </h3><br>  To start writing tweets via SMS, enter your phone number on the Rutwit website: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/866/f06/1da/866f061da69914d5b34b8d077174acb7.png"><br><br>  Then send the word ‚Äúyes‚Äù (the register is not important) to the Rutvit number <b>+7 916 140-0-140</b> .  As soon as the robot sees this message, it will link your number to your account, and all subsequent SMS messages to +7 916 140-0-140 will be perceived as tweets on your behalf. <br><br><h3>  And you can also write SMS at cost to Twitter, FriendFeed, Facebook, LiveJournal, Buzz </h3><br>  If you are a Twitter fan, set up Rutweet -&gt; Twitter message export (or FriendFeed, Facebook, LiveJournal, Buzz) and tweet (FriendFeed, Facebook, LiveJournal, Buzz) SMS at cost using Ruth as a gateway: <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/e4b/1ea/fb0/e4b1eafb007630e87592b9206a30f2d6.png"><br><br>  (For justice, it is worth noting that you can send SMS to Twitter via foreign gateways, but in Russia it turns out to be much more expensive: after all, SMS to the British number + 44xxxx, provided by Twitter, is more expensive than SMS to the Russian number Ruthwit 9 916 140-0-140 .) <br><br>  Now a spoon of tar present in the beta version.  One of our goals is to make sure that the user can not only send SMS to Rootvit at the price of an ordinary SMS, but also receive free SMS tweets to a mobile phone.  Some microblogging services simply buy a GSM modem (or a smartphone with Linux) and receive / send SMS through it, but this method works only on small amounts of traffic: it doesn‚Äôt scale well.  Nevertheless, we want to save social network users from additional costs when activating and using this service.  But only technical integration and conclusion of a contract directly with the operator will allow this to be achieved.  In the meantime, negotiations are in progress, the beta version does not implement the ability to receive SMS on the phone: you can only send tweets to the system.  In this issue, we are betting on the future. <br><br><h3>  Technical details of direct integration </h3><br>  We have never worked with SMS and <a href="http://ru.wikipedia.org/wiki/SMPP">SMPP</a> before.  And, when we signed an agreement with MTS, we were faced with a choice: <ul><li>  or make an SMPP client manually (using modules for Perl, for example); </li><li>  or use a ready-made industrial-scale SMPP server (the most popular of them is <a href="http://www.kannel.org/">Kannel</a> ). </li></ul>  As a result, it was decided to dwell on the second version, and we did not regret it, because in the process of integration we stepped on a mass of underwater rakes, many of which were successfully resolved by Kannel. <br><br><h4>  A little bit about SMPP, SMS messaging protocol </h4><br>  The <a href="http://ru.wikipedia.org/wiki/SMPP">SMPP</a> protocol (stands for ‚ÄúShort Message Peer to Peer‚Äù) is itself quite complex.  It is very low-level (specifications occupy 170 pages).  The difficulty is mainly due to historical reasons.  The group of protocols for voice transmission was developed in 1975. At that time there were no SMS yet (there were not even LCD displays for cell phones, like the cell phones themselves).  And so, in 1985, they decided to ‚Äúshove‚Äù support of text messages into standard voice packets.  But there was little useful space in these packets, so the messages were short, only 160 characters - Short Messages. <br><br>  The useful amount of data that can be transmitted in an SMPP packet is 140 bytes.  This is not a typo.  How do they fit 160 characters?  You probably already guessed: 1 ASCII character can be encoded with 7 bits.  Thus, it turns out 160 * 7 = 1120 bits, or 140 bytes. <br><br>  If we lived in the USA, where the ASCII encoding "should be enough for everyone", then we would calmly write tweets of 160 characters.  However, when sending Russian letters via SMS, they are packaged in UTF-16 encoding, i.e.  2 bytes per 1 Russian letter.  Therefore, in 1 message can fit no more than 140/2 = 70 characters of the Russian alphabet.  If the text is longer, it is packed into 2 or more SMS messages, which are then ‚Äúglued together‚Äù when displayed on the phone. <br><br>  But that is not all.  In 2 SMS messages, you can deliver not only 70 * 2 = 140 Russian letters, but only 134. Extra space is required to encode service information, in particular, information on the number of SMS in the chain and the number of the current SMS in it. <br><br><h4>  Kannel associates </h4><br>  The Kannel server we used actually has a wider range of applicability.  It is intended for content provisioning, when the request is an SMS, and the answer is some SMS content: melodies, pictures, etc.  We use only the part that organizes the reception and transmission of SMS: Kannel receives an SMPP message, unpacks / decrypts it and sends us a phone number and text using an HTTP request.  In response, we do not send any content. <br><br>  True, it was not without surprises.  MTS has a very scrupulous testing scheme: we not only have to correctly receive messages, but also fit into all possible time-outs when placing requests in a queue, support throttling, send delivery confirmation messages in time with an explosive increase in load.  On the test bench, we encountered a problem, to solve which we had to patch Kannel a bit (it is written in C).  In short, it can be described as follows: suppose that 2 SMPP packets arrived on Kannel, and the third one ran into limiting the throughput capacity set by the MTS, and therefore got stuck in the queue.  If the restriction has now been lifted, but the 4th message immediately arrived, then in the standard version, Kannel will deliver this 4th message to all previously stuck.  Therefore, the 3rd message will again be at the end of the queue and will move further and further as new SMS arrives.  It turns out that for MTS load tests this behavior matters - like many other aspects that had to be taken into account in direct integration. <br><br>  We had no experience with SMPP before, but Kannel allowed us to scramble out.  Fortunately for us, Kannel even in the base configuration handles a lot of what was needed by the PPSC.  But, hand on heart, now, having already ‚Äúeaten a dog‚Äù on SMPP, we would start to do everything using Perl and modules with CPAN, and not Kannel.  But that would be possible only because of the experience we received with Kannel.  Without this experience, programming direct integration with POPOS on Perl is the same as teaching a person to swim by throwing him off the cliff: maybe he will learn, or maybe he will drown.  MTS is especially scrupulous when testing error handling, maintaining a variety of timeouts.  For example, the time for sending acknowledgments * _resp to SMPP messages is clearly regulated: delays should fit into the specified MTS time intervals.  If you decide to work with SMPP directly, study Kannel first: I would recommend making your own solution, repeating the Kannel architecture, especially the message buffering aspects. </div><p>Source: <a href="https://habr.com/ru/post/98702/">https://habr.com/ru/post/98702/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../98695/index.html">Having Fun with VS2010 Ultimate: SQL Data Comparison</a></li>
<li><a href="../98696/index.html">A selection of large Drupal sites</a></li>
<li><a href="../98697/index.html">Announced Trillian for Android</a></li>
<li><a href="../98698/index.html">Network officials</a></li>
<li><a href="../98699/index.html">We save money on domain name registration, but keep the quality</a></li>
<li><a href="../98703/index.html">American cyber squad logo decoded</a></li>
<li><a href="../98704/index.html">Simple rss client on Android</a></li>
<li><a href="../98706/index.html">My Kyivstar forgot part of accounts</a></li>
<li><a href="../98709/index.html">Guide - translate!</a></li>
<li><a href="../98712/index.html">All inclusive or all in one</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>