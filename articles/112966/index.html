<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Rewrite project from Zend Framework to Rails</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="About five months ago, I tied up with the zend framework and moved onto rails. Then he began to rewrite his project www.okinfo.ru . Now it is already ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Rewrite project from Zend Framework to Rails</h1><div class="post__text post__text-html js-mediator-article">  About five months ago, I tied up with the zend framework and moved onto rails.  Then he began to rewrite his project <a href="http://www.okinfo.ru/">www.okinfo.ru</a> .  Now it is already finished and sloccount showed that the number of lines in the project decreased from 15,000 to 4,000. My familiar php developers asked for a success story and eventually this article was born.  In it, I will describe how it was, as well as talk a little about my transition to ruby. <br><a name="habracut"></a><br><br><h4>  Prehistory </h4><br>  Having worked as the main developer of <a href="http://www.starlook.ru/">www.starlook.ru for</a> about two years, I reached a point where you understand that it is time to move on.  The architecture of the application is well-established, scaling is inherent, the code as a whole is fine and in general the whole development process was clear and debugged.  In fact, we continued to increase the functionality and maintain already written.  At this time for interest, I began to look closely at django and rails.  Despite the fact that the python as a language I liked, but that django was not impressed.  And with the rails and cut the situation was completely different.  It can be called love at first sight.  And literally after a month of study, a letter came to My Circle offering a vacancy for a ruby ‚Äã‚Äãdeveloper, although it was an accident, since  sending for some reason thought that I know ruby.  In general, I decided that this was fate, and after passing a bunch of interviews, they still took me to <s>chop</s> for a new place. <br><br><h4>  What for? </h4><br>  After getting acquainted with the rails, it was very difficult to continue writing a project on ZF, too much had to be done by hand and practically for each task (tags, trees, deploy, migrations, etc.) to write our own solutions.  Given that there is not much free time on the project, it was decided to rewrite it, killing two birds with one stone.  Firstly, to simplify your development and support, and secondly, to tighten the knowledge of the relevant technologies. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Setting up the environment </h4><br>  <a href="http://rvm.beginrescueend.com/">rvm.beginrescueend.com</a> - installation of several versions of ruby ‚Äã‚Äãand gemset support. <br>  <a href="http://ru.wikipedia.org/wiki/RubyGems">ru.wikipedia.org/wiki/RubyGems</a> - gems <br><br><pre><code class="bash">sudo apt-get install rubygems
gem install rails
rails s
</code></pre><br>
<br>
       ,     .     .<br>
<br>
<h4></h4><br>
         . <br>
<br>
            .        tail -f log/development.log (http://habrastorage.org/storage/29abc841/af70206c/2794fbe5/5d1f434f.png).       , , , ,    ..<br>
<br>
<pre><code class="bash">rails c
</code></pre><br>
<br>
      irb    .          .    .<br>
<br>
<img src="https://habrastorage.org/storage/c477166a/0002f196/ffba09c2/ebd8f3e8.png" alt="image"><br>
<br>
    netbeans  vim.<br>
<br>
<h4>  REST</h4><br>
<a href="http://habrahabr.ru/blogs/webdev/38730/">habrahabr.ru/blogs/webdev/38730</a><br>
<a href="http://guides.rubyonrails.org/routing.html">guides.rubyonrails.org/routing.html</a><br>
<br>
     ,        .   REST           .<br>
<br>
: <a href="http://pastebin.com/x0bA3siH">pastebin.com/x0bA3siH</a><br>
<br>
:<br>
<br>
<pre><code class="ruby">namespace :admin do
  resources :brands do
    resources :systems
  end
end
</code></pre><br>
<br>
   rake routes : <a href="http://pastebin.com/mPSvzkAJ">pastebin.com/mPSvzkAJ</a><br>
<br>
             .      :<br>
<br>
<pre><code class="ruby">admin_brand_systems_path(@brand) #    
admin_brand_systems_url(@brand) #    
</code></pre><br>
<br>
        .     Zend_Controller_Router_Route_Hostname. <br>
<br>
    ,          .     rails3   ,   :<br>
<br>
<pre><code class="ruby">#       ZF
match "/company/:id" =&gt; redirect("/companies/%{id}")
</code></pre><br>
<br>
 ZF  Zend_Rest_Controller  Zend_Rest_Route,           ,           :<br>
<br>
<pre><code class="php">$restRoute = new Zend_Rest_Route($front, array(), array(
    'api',
    'backlog' =&gt; array('task'),
));
$router-&gt;addRoute('rest', $restRoute);
</code></pre><br>
<br>
      ,                 .<br>
<br>
<h4></h4><br>
<a href="http://guides.rubyonrails.org/action_controller_overview.html">guides.rubyonrails.org/action_controller_overview.html</a><br>
<br>
: <a href="http://pastebin.com/TYhYAWEQ">pastebin.com/TYhYAWEQ</a><br>
: <a href="http://pastebin.com/seJzhYMq">pastebin.com/seJzhYMq</a><br>
<br>
        .       ZF,     ,         . <br>
<br>
          (  ) ‚Äî    ApplicationController (    ).            .    .<br>
<br>
<h4>  (ThinkingSphinx)</h4><br>
    .      <a href="http://www.okinfo.ru/">www.okinfo.ru</a>.<br>
<br>
  ,    ,      <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B5%25D0%25B4%25D0%25BC%25D0%25B5%25D1%2582%25D0%25BD%25D0%25BE-%25D0%25BE%25D1%2580%25D0%25B8%25D0%25B5%25D0%25BD%25D1%2582%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25BD%25D1%258B%25D0%25B9_%25D1%258F%25D0%25B7%25D1%258B%25D0%25BA_%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B8%25D1%2580%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D1%258F">DSL</a>.<br>
<br>
<pre><code class="ruby">define_index do
    indexes title
    indexes body
    indexes sub_categories(:title)

    has created_at
    has taggings(:tag_id), :as =&gt; :tag_ids, :facet =&gt; true
    has companies_sub_categories :sub_category_id
    has addresses :city_id
    has :calculator_page # :without =&gt; {:calculator_page =&gt; 0}
    has :site
    has :reviews_count
  end
</code></pre><br>
<br>
     sphinx,   .     :<br>
<br>
<pre><code class="bash">rake ts:rebuild
</code></pre><br>
<br>
 :<br>
<br>
<pre><code class="ruby">Company.search ‚Äò‚Äô
</code></pre><br>
<br>
      sphinx,       . thinking-sphinx     ,      .       ,               .<br>
<br>
<h4>ActiveRecord</h4><br>
<a href="http://guides.rubyonrails.org/association_basics.html">guides.rubyonrails.org/association_basics.html</a><br>
<a href="http://guides.rubyonrails.org/active_record_querying.html">guides.rubyonrails.org/active_record_querying.html</a><br>
<br>
<pre><code class="ruby">class Company &lt; ActiveRecord::Base
  acts_as_taggable

  devise :database_authenticatable, :registerable,
    :recoverable, :rememberable, :validatable, :trackable

  belongs_to :image
  has_many :weekly_newsletters, :class_name =&gt; 'Notice', :conditions =&gt; { :notice_type =&gt; 'weekly_newsletter' }
  has_many :addresses
  has_many :sub_categories, :through =&gt; :companies_sub_categories

  validates :site, 
    :uniqueness =&gt; true,
    :format =&gt; { :with =&gt; URI::regexp(%w(http https)) },
    :allow_blank =&gt; true
  validates :title, :presence =&gt; true, :uniqueness =&gt; true
  validates :twitter_page, :format =&gt; { :with =&gt; URI::regexp(%w(http https)) },
    :allow_blank =&gt; true

  scope :by_rating, order('ratings_sum DESC')
  scope :with_logo, where('image_id IS NOT NULL').includes(:image)
</code></pre><br>
<br>
      .         .   ,  orm         .<br>
<br>
<h4>State Machine </h4><br>
<a href="https://github.com/pluginaweek/state_machine">github.com/pluginaweek/state_machine</a><br>
<br>
      /   ..           .<br>
<br>
<pre><code class="ruby"># ActiveRecord model
 state_machine :state, :initial =&gt; :moderate do
    state :off, :human_name =&gt; ''
    state :moderate, :human_name =&gt; ' '
    state :published, :human_name =&gt; '' do
      validates :uri, :presence =&gt; true
    end

    event :publish, :human_name =&gt; '' do
      transition :off =&gt; :published
      transition :moderate =&gt; :published
    end

    event :off, :human_name =&gt; '' do
      transition :published =&gt; :off
    end
  end
</code></pre><br>
<br>
<h4>     (Rake, cron)</h4><br>
<a href="http://ru.wikipedia.org/wiki/Rake">ru.wikipedia.org/wiki/Rake</a><br>
<a href="http://wiki.agiledev.ru/doku.php%3Fid%3Dautomation:build_package_deploy">  </a><br>
<br>
            rake. , ,          <a href="http://pastebin.com/MavWT7JA">pastebin.com/MavWT7JA</a>. , .   rake   ruby.  php   ‚Äî <a href="https://github.com/indeyets/pake/wiki">pake</a>.<br>
<br>
<pre><code class="ruby">#     
namespace :app do
  namespace :notice do
    desc 'Weekly newsletter'
    task :weekly_for_company =&gt; :environment do
      Company.state.find_each do |company| # find_each  batch
        	last_notice = company.weekly_newsletters.last
	        next if last_notice &amp;&amp; (Time.now - last_notice.created_at &lt; 1.week)
        notice = company.weekly_newsletters.create
        notice.save
        CompanyMailer.weekly_newsletter(company).deliver
        sleep(1)
      end
    end
  end
end
</code></pre><br>
<br>
:<br>
<br>
<pre><code class="bash">rake app:notice:weekly_for_company
</code></pre><br>
<br>
    php,            .    .<br>
<br>
<h4>Deploy (capistrano)</h4><br>
<a href="https://github.com/capistrano/capistrano/wiki">github.com/capistrano/capistrano/wiki</a><br>
<a href="http://habrahabr.ru/blogs/webdev/110021/">habrahabr.ru/blogs/webdev/110021</a><br>
<br>
      .        (    <a href="http://pastebin.com/LYXbuftG"></a>):<br>
<br>
<pre><code class="bash">cap deploy:migrations
</code></pre><br>
<br>
    ,  ,  ,  , ,       .     .<br>
<br>
<h4>   (Bundler)</h4><br>
<a href="http://gembundler.com/">gembundler.com</a><br>
<br>
       <a href="http://habrahabr.ru/blogs/ruby/85201/">bundler</a>.    .   , ,  ( )    .   .      : <a href="http://pastebin.com/50pe40Sb">pastebin.com/50pe40Sb</a>.<br>
<br>
 ‚Äî Ancestry (use Materialized path)<br>
  ‚Äî breadcrumbs_on_rails<br>
 ‚Äî graticule<br>
 ‚Äî acts-as-taggable-on<br>
 ‚Äî paperclip<br>
  ‚Äî foreigner<br>
 ‚Äî rspec, factory_girl_rails, rcov<br>
 ‚Äî capistrano, capistrano-ext, capistrano_colors<br>
<br>
<h4> (Devise)</h4><br>
<a href="https://github.com/plataformatec/devise">github.com/plataformatec/devise</a><br>
: Omniauthable, Confirmable, Recoverable, Registerable, Rememberable, Trackable, Timeoutable, Validatable, Lockable, Encryptable, Database Authenticatable, Token Authenticatable.<br>
<br>
  .          .               .<br>
<br>
<h4> (Simple_Form)</h4><br>
<a href="https://github.com/plataformatec/simple_form">github.com/plataformatec/simple_form</a><br>
<br>
   ZF, Django,       .                 .     Zend_Form (  zend_form    ).<br>
<br>
<pre><code class="ruby">&lt;%= simple_form_for(resource, :url =&gt; company_registration_path) do |f| %&gt;
    &lt;%= f.input :email %&gt;
    &lt;%= f.input :password %&gt;
    &lt;%= f.input :password_confirmation %&gt;
    &lt;%= f.association :forma, :label_method =&gt; :title %&gt;
    &lt;%= f.input :title %&gt;
    &lt;%= f.association :sub_categories, :label_method =&gt; :title %&gt;

    &lt;%= f.simple_fields_for :address do |address| %&gt;
      &lt;%= address.association :city, :as =&gt; :select, :collection =&gt; cities(@company.address),
        :input_html =&gt; { :id =&gt; "city_id" } %&gt;
      &lt;%= address.input :street %&gt;
      &lt;%= address.input :house, :required =&gt; false %&gt;
    &lt;% end %&gt;
    &lt;%= f.submit '' %&gt;
&lt;% end %&gt;
</code></pre><br>
<br>
        .<br>
<br>
<h4> (Rspec, FactoryGirl, Rcov)</h4><br>
<a href="http://habrahabr.ru/blogs/testing/52929/">habrahabr.ru/blogs/testing/52929</a><br>
<a href="https://github.com/thoughtbot/factory_girl">github.com/thoughtbot/factory_girl</a><br>
<br>
: <a href="http://pastebin.com/3tEctqmT">pastebin.com/3tEctqmT</a><br>
: <a href="http://pastebin.com/VmawXxbc">pastebin.com/VmawXxbc</a><br>
<br>
     FactoryGirl ,  ,  ,  .         (        ).            assert‚Äô.<br>
<br>
       php.     ,      .<br>
<br>
<h4>  </h4><br>
<a href="http://guides.rubyonrails.org/action_mailer_basics.html">guides.rubyonrails.org/action_mailer_basics.html</a><br>
<a href="http://rusrails.ru/action-mailer-basics">rusrails.ru/action-mailer-basics</a><br>
<br>
   rails   .        rails g mailer MailerName.       .        .   : CompanyMailer.after_registration(@company).deliver<br>
<br>
     . Rails environment    ,     ZF,     : , ,             env.     dev  (    )        .<br>
<br>
  (  ):<br>
<br>
<pre><code class="ruby">describe ColumnistMailer do
  describe "after_registration" do
    let(:mail) { ColumnistMailer.after_registration }

    it "renders the headers" do
      mail.subject.should eq("After registration")
      mail.to.should eq(["to@example.org"])
      mail.from.should eq(["from@example.com"])
    end

    it "renders the body" do
      mail.body.encoded.should match("Hi")
    end
  end
end
</code></pre><br>
<br>
<h4> </h4><br>
<a href="http://github.com/">github.com</a> ( ) ‚Äî  .<br>
<a href="http://newrelic.com/">newrelic.com</a> ‚Äî .<br>
<a href="https://hoptoadapp.com/pages/home">hoptoadapp.com/pages/home</a> ‚Äî    .          ,    php.           (  ),      ‚Äî  ,      ,    .      ,      .     ,       ,         .    .  ,        must have.         js.<br>
<br>
    <a href="https://github.com/jdpace/errbit">github.com/jdpace/errbit</a> (Errbit is an open source, self-hosted error catcher. It is Hoptoad API compliant so you can just point the Hoptoad notifier at your Errbit server if you are already using Hoptoad).<br>
      php <a href="https://github.com/rich/php-hoptoad-notifier">github.com/rich/php-hoptoad-notifier</a><br>
<br>
<h4></h4><br>
           .         .         ,      .<br>
<br>
       ,     ,    .          ,      .</div><p>Source: <a href="https://habr.com/ru/post/112966/">https://habr.com/ru/post/112966/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../112961/index.html">Microsoft Data Center Security</a></li>
<li><a href="../112962/index.html">Prefixes for Microsoft business critical applications</a></li>
<li><a href="../112963/index.html">Google launched a website with painting</a></li>
<li><a href="../112964/index.html">Is the trademark owner always right?</a></li>
<li><a href="../112965/index.html">Making a PDF book from a web comic with C # using the example of xkcd</a></li>
<li><a href="../112968/index.html">Moving from SVN to Mercurial: personal experience</a></li>
<li><a href="../112969/index.html">So we put a factory into your algorithm or how not to consider factorials</a></li>
<li><a href="../112973/index.html">33needs allows you to become a startup investor</a></li>
<li><a href="../112974/index.html">ACM ICPC World Programming Championship Final moved</a></li>
<li><a href="../112976/index.html">LSB steganography</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>