<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Efficient client-server interaction in Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="StrictMode and the fight against ANR 
 Starting with the Gingerbread version, Google has added a mechanism to Android that allows you to track long-te...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Efficient client-server interaction in Android</h1><div class="post__text post__text-html js-mediator-article"><h4>  StrictMode and the fight against ANR </h4><br>  Starting with the Gingerbread version, Google has added a mechanism to Android that allows you to track long-term operations performed in the UI stream.  The name for this mechanism is StrictMode.  What was it done for? <br><br>  Each of you may have come across an Application Not Responding dialog box (the application is not responding) or ANR in applications.  This happens when the application does not respond to input events (keystrokes, touch on the screen) for 5 seconds.  To track the processes blocking the UI stream, the StrictMode mechanism was introduced.  And, starting with Android 3.0, StrictMode stops attempts to perform a network request in the UI stream. <br><br>  So, what mechanisms does Android provide for accessing the network outside the UI stream? <br><a name="habracut"></a><br><h4>  AsyncTask </h4><br>  Probably one of the most common mechanisms to help perform network operations is AsyncTask.  Consider an example: <br><img src="https://habrastorage.org/getpro/habr/post_images/a89/403/c2e/a89403c2e8bba313b59327a063c19d97.png" alt="image"><br>  At first glance, everything is fine, but there are several drawbacks: <br><ul><li>  When changing the orientation of the device, the network flow (Worker Thread) will lose the context of the Activity within which it was launched.  And when receiving result - IllegalStateException.  Usually, to solve this problem, cancel the network flow in the Activity.onStop method (as an option in onPause) and start up again in Activity.onStart (onResume).  But with this approach, the user can simply not wait for the result, not to mention the increase in traffic. </li><li>  The need to save the result of the query between the change of configurations. </li><li>  If the application is in the background, the system can complete it along with all its threads. </li></ul><br>  Starting from 3.0, a mechanism comes to our rescue that allows us to solve most of the problems described above.  But what if the platform requirements are below 3.0?  Do not despair and use the support-library in which this mechanism was backported. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Loaders </h4><br>  What is so good about this mechanism: <br><ul><li>  Available from Activity and Fragment </li><li>  Tracks the current state of the application (apparently the user is in the background, etc.) </li><li>  Provides asynchronous data loading. </li><li>  Controls the data source </li><li>  Automatically returns the result of the last query when changing the configuration.  Thus, there is no need to re-request </li></ul><br>  Let's look at how you can use the Loader to request data over the network: <br><img src="https://habrastorage.org/getpro/habr/post_images/631/ae5/3a0/631ae53a0ce5a7f25680309472762fbe.png" alt="image"><br>  How it works?  Inside the Loader, the network stream is started, the result is parsed and sent to the ContentProvider, which saves them to the DataStorage (it can be memory, file system, sqlite database) and notifies the Loader that the data has been changed.  The loader, in turn, polls the ContentProvider for new data and returns it to the Activity (Fragment).  If we replace the network flow with a service, we can guarantee that the user will receive the data even if the application has been minimized (as the Service has a higher priority than the background process). <br><br>  What is the advantage of this approach: <br><ul><li>  Ability to implement query caching </li><li>  Transparent network layer </li><li>  The ability to easily eliminate the network layer and get an offline application. </li><li>  Independence from the <b>format of the</b> returned <b>data</b> , we are <b>directly</b> important <b>data</b> that must be visualized. </li><li>  One entry point for accessing data </li></ul><br><div class="spoiler">  <b class="spoiler_title">Implementation example</b> <div class="spoiler_text"><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AbstractRestLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Loader</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cursor</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CORE_POOL_SIZE = Android.getCpuNumCores() * <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> MAX_POOL_SIZE = CORE_POOL_SIZE * <span class="hljs-number"><span class="hljs-number">4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> POOL_KEEP_ALIVE = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> BlockingQueue&lt;Runnable&gt; sPoolWorkQueue; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ThreadFactory sThreadFactory; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ExecutorService sThreadPoolExecutor; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AsyncHttpClient sDefaultHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Handler sUiHandler; <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> { sPoolWorkQueue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedBlockingQueue&lt;Runnable&gt;(CORE_POOL_SIZE * <span class="hljs-number"><span class="hljs-number">2</span></span>); sThreadFactory = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LoaderThreadFactory(); sThreadPoolExecutor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ThreadPoolExecutor( CORE_POOL_SIZE, MAX_POOL_SIZE, POOL_KEEP_ALIVE, TimeUnit.SECONDS, sPoolWorkQueue, sThreadFactory ); sDefaultHttpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncHttpClient(); sUiHandler = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Handler(Looper.getMainLooper()); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AsyncHttpClient mHttpClient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> HttpMethod mRestMethod; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Uri mContentUri; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> ContentObserver mObserver; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String[] mProjection; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mWhere; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String[] mWhereArgs; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String mSortOrder; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> mLoadBeforeRequest; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FutureTask&lt;?&gt; mLoaderTask; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> AsyncHttpRequest mRequest; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Cursor mCursor; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> mContentChanged; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AbstractRestLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, HttpMethod request, Uri contentUri)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(context); mHttpClient = onInitHttpClient(); mRestMethod = request; mContentUri = contentUri; mObserver = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CursorObserver(sUiHandler); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Uri </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getContentUri</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> mContentUri; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AbstractRestLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setProjection</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] projection)</span></span></span><span class="hljs-function"> </span></span>{ mProjection = projection; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AbstractRestLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setWhere</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String where, String[] whereArgs)</span></span></span><span class="hljs-function"> </span></span>{ mWhere = where; mWhereArgs = whereArgs; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AbstractRestLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSortOrder</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String sortOrder)</span></span></span><span class="hljs-function"> </span></span>{ mSortOrder = sortOrder; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> AbstractRestLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setLoadBeforeRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> load)</span></span></span><span class="hljs-function"> </span></span>{ mLoadBeforeRequest = load; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverResult</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Cursor cursor)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Cursor oldCursor = mCursor; mCursor = cursor; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mCursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mCursor.registerContentObserver(mObserver); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isStarted()) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.deliverResult(cursor); mContentChanged = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (oldCursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; oldCursor != cursor &amp;&amp; !oldCursor.isClosed()) { oldCursor.unregisterContentObserver(mObserver); oldCursor.close(); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onStartLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mCursor == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || mContentChanged) { forceLoad(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { deliverResult(mCursor); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onForceLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ cancelLoadInternal(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mLoadBeforeRequest) { reloadCursorInternal(); } restartRequestInternal(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onReset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ cancelLoadInternal(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mCursor != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !mCursor.isClosed()) { mCursor.close(); } mCursor = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> AsyncHttpClient </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onInitHttpClient</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sDefaultHttpClient; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCancelLoad</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception e)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverResultBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Cursor cursor)</span></span></span><span class="hljs-function"> </span></span>{ sUiHandler.post(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ deliverResult(cursor); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverExceptionBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> Exception e)</span></span></span><span class="hljs-function"> </span></span>{ sUiHandler.post(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ onException(e); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onParseInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpHead head, InputStream is)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> Cursor </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoadInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Uri contentUri, String[] projection, String where, String[] whereArgs, String sortOrder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getContext().getContentResolver().query(contentUri, projection, where, whereArgs, sortOrder); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reloadCursorInternal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mLoaderTask != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mLoaderTask.cancel(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } mLoaderTask = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FutureTask&lt;Void&gt;(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Callable&lt;Void&gt;() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Void </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ deliverResultBackground(onLoadInBackground(mContentUri, mProjection, mWhere, mWhereArgs, mSortOrder)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }); sThreadPoolExecutor.execute(mLoaderTask); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restartRequestInternal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mRequest != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mRequest.cancel(); } mRequest = mHttpClient.execute(mRestMethod, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncHttpCallback() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onSuccess</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpHead head, InputStream is)</span></span></span><span class="hljs-function"> </span></span>{ onParseInBackground(head, is); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(URI uri, Exception e)</span></span></span><span class="hljs-function"> </span></span>{ deliverExceptionBackground(e); } }); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">cancelLoadInternal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ onCancelLoad(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mLoaderTask != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mLoaderTask.cancel(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); mLoaderTask = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (mRequest != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { mRequest.cancel(); mRequest = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoaderThreadFactory</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ThreadFactory</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AtomicLong mId = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AtomicLong(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Thread </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">newThread</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Runnable r)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> Thread thread = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(r); thread.setName(<span class="hljs-string"><span class="hljs-string">"LoaderThread #"</span></span> + mId.getAndIncrement()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> thread; } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CursorObserver</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentObserver</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CursorObserver</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Handler handler)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(handler); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deliverSelfNotifications</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> selfChange)</span></span></span><span class="hljs-function"> </span></span>{ onChange(selfChange, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onChange</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> selfChange, Uri uri)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isStarted()) { reloadCursorInternal(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { mContentChanged = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } } } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Usage example</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FragmentActivity</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoaderManager</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LoaderCallbacks</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Cursor</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ListView mListView; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> CursorAdapter mListAdapter; <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bundle savedInstanceState)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onCreate(savedInstanceState); setContentView(R.layout.ac_message_list); mListView = (ListView) findViewById(android.R.id.list); mListAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CursorAdapterImpl(getApplicationContext()); getSupportLoaderManager().initLoader(R.id.message_loader, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Loader&lt;Cursor&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onCreateLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id, Bundle args)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AbstractRestLoader(getApplicationContext(), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpGet(<span class="hljs-string"><span class="hljs-string">"API URL"</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onParseInBackground</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(HttpHead head, InputStream is)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { getContext().getContentResolver().insert( Messages.BASE_URI, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageParser().parse(IOUtils.toString(is)) ); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { deliverExceptionBackground(e); } } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onException</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Exception e)</span></span></span><span class="hljs-function"> </span></span>{ Logger.error(e); } }.setLoadBeforeRequest(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoadFinished</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Loader&lt;Cursor&gt; loader, Cursor data)</span></span></span><span class="hljs-function"> </span></span>{ mListAdapter.swapCursor(data); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onLoaderReset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Loader&lt;Cursor&gt; loader)</span></span></span><span class="hljs-function"> </span></span>{ mListAdapter.swapCursor(<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); } }</code> </pre><br></div></div><br><br>  PS <br>  <a href="http://goo.gl/j6eW2">Developing Android REST client applications</a> <br>  <a href="http://developer.android.com/guide/components/loaders.html">Android Developers - Loaders</a> <br>  <a href="http://developer.android.com/guide/components/processes-and-threads.html">Android Developers - Processes and Threads</a> </div><p>Source: <a href="https://habr.com/ru/post/175455/">https://habr.com/ru/post/175455/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175445/index.html">Intel provides new opportunities for game developers</a></li>
<li><a href="../175447/index.html">The largest Bitcoin exchange Mt. Gox under DDoS attack - owners suspect that attackers want to provoke panic</a></li>
<li><a href="../175449/index.html">How to tie a BitTorrent tracker to a Python site: integration with XBT Tracker</a></li>
<li><a href="../175451/index.html">GPS monitoring auto or homework for the evening</a></li>
<li><a href="../175453/index.html">Using design patterns in javaScript: Spawning patterns</a></li>
<li><a href="../175457/index.html">Admin in 10 minutes</a></li>
<li><a href="../175459/index.html">Data migration from MySQL to PostgreSQL</a></li>
<li><a href="../17546/index.html">How much does it cost to make a website?</a></li>
<li><a href="../175461/index.html">How it works: CAPTCHA</a></li>
<li><a href="../175465/index.html">M in MVC: why models are misunderstood and undervalued (translation)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>