<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Developer Cookbook: DDD Recipes (Part 5, Processes)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 


 In the framework of the previous articles we described: scope , methodological foundations , example of architecture and structure . ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Developer Cookbook: DDD Recipes (Part 5, Processes)</h1><div class="post__text post__text-html js-mediator-article"><h1 id="vvedenie">  Introduction </h1><br><p>  In the framework of the previous articles we described: <a href="https://habr.com/post/426663/">scope</a> , <a href="https://habr.com/post/428209/">methodological foundations</a> , <a href="https://habr.com/ru/post/429750/">example of architecture</a> and <a href="https://habr.com/ru/post/435920/">structure</a> .  In this article, I would like to tell you how to describe processes, about the principles of requirements gathering, how business requirements differ from functional ones, how to move from requirements to code.  Explain how the Use Case is applied and how they can help us.  Sample examples of the implementation of Interactor and Service Layer design patterns. </p><br><p><img src="https://habrastorage.org/webt/wo/je/ct/woject0sgeuwc_4xnnzugty-5jg.png" alt="likeyourgrandmom"></p><br><p>  The examples given in the article are given using our <a href="http://lunapark.dev/">LunaPark</a> solution, it will help you with the first steps in the described approaches. </p><br><h1 id="otdelyaem-funkcionalnye-trebovaniya-ot-biznes-trebovaniy">  Separate functional requirements from business requirements. </h1><br><p>  Again and again it happens that many business ideas do not really turn into the final, intended product.  Often this is due to the inability to understand the difference between business requirements and functional requirements, which ultimately leads to inappropriate collection of requirements, unnecessary documentation, project delays and major project failures. </p><br><p>  Or sometimes we are confronted with situations in which, although the final decision meets the needs of customers, but somehow the business goals are not achieved. </p><br><p>  Therefore, it is extremely important to separate business requirements and functional requirements, before you begin to define them.  Let's take an example. </p><a name="habracut"></a><br><p>  Suppose we are writing an application for a pizza delivery company, and we decided to make a courier tracking system.  Business requirements are as follows: </p><br><p>  <em>"Implement a web-based mobile tracking system for employees based on mobile devices that captures couriers on their routes and increases efficiency by monitoring courier activity, their absence from work and productivity."</em> </p><br><p>  Here you can select a number of characteristic features that will indicate that these are requirements from the business: </p><br><ul><li>  business requirements are always written from the client‚Äôs point of view; </li><li>  these are broad, high-level requirements, but still detail-oriented; </li><li>  they are not company goals, but help the company achieve goals; </li><li>  answer the questions " <strong>why</strong> " and " <strong>what</strong> ".  What does the company want to get?  And why does she need it. </li></ul><br><p>  Functional requirements are <em>Actions</em> that the system must perform in order to implement business requirements.  Thus, the functional requirements are associated with the developed solution or software.  We formulate the functional requirements for the above example: </p><br><ul><li>  the system should display the employee longitude and latitude via GPS / GLONASS; </li><li>  the system should display the positions of employees on the map; </li><li>  the system should allow managers to send notifications to their subordinates in the field. </li></ul><br><p>  Highlight the following features: </p><br><ul><li>  functional requirements are always written from the point of view of the system; </li><li>  they are more specific and detailed; </li><li>  thanks to the fulfillment of functional requirements, an effective solution is developed that meets the needs of the business and the goals of the client; </li><li>  answer the question " <strong>how</strong> ."  How the system solves business requirements. </li></ul><br><p>  A few words should be said about non-functional requirements (also known as ‚Äúquality requirements‚Äù) that impose restrictions on the design or implementation (for example, requirements for performance, safety, accessibility, reliability).  Such requirements answer the question " <strong>what</strong> " should be the system. </p><br><p>  Development is the translation of business requirements into functional ones.  Application programming is the implementation of functional requirements, and system programming is non-functional. </p><br><h1 id="varianty-ispolzovaniya-use-cases">  Use Cases </h1><br><p>  The implementation of functional requirements is often the most difficult in commercial systems.  In a <a href="https://www.amazon.com/Clean-Architecture-Craftsmans-Software-Structure-ebook/dp/B075LRM681">pure architecture,</a> functional requirements are implemented through the <em>Use Case</em> layer. </p><br><p>  But for starters, I want to turn to the source.  Ivar Jacobson, the author of the definition of <em>Use Case</em> , one of the authors of the UML, and the RUP methodology, in his article <a href="https://www.ivarjacobson.com/sites/default/files/field_iji_file/article/use-case_2.0_final_rev3.pdf">Use-Case 2.0 The Hub of Software Development</a> identifies 6 principles of application Use <em>cases</em> : </p><br><ol><li>  make them simple through narration; </li><li>  have a strategic plan, be aware of the whole picture; </li><li>  focus on the meaning; </li><li>  line up the system; </li><li>  deliver the system step by step; </li><li>  meet the needs of the team. </li></ol><br><p>  We briefly consider each of these principles, they will be useful to us for further understanding.  Below is my free translation, with abbreviations and inserts, I strongly recommend that you familiarize yourself with the original. </p><br><h3 id="prostota-cherez-povestvovanie">  Simplicity through narration </h3><br><p>  <em>Narration is part of our culture;</em>  <em>This is the easiest and most effective way to transfer knowledge, information from one person to another.</em>  <em>This is the best way to communicate what the system should do and help the team focus on common goals.</em> </p><br><p>  <em>Use cases reflect the purpose of the system.</em>  <em>To understand the Usage Option, we tell, tell a certain story.</em>  <em>The story tells how to achieve goals and how to solve problems arising on the way.</em>  <em>Use cases, like a storybook, provide a way to identify and capture all of the different, but related stories in a simple, comprehensive way.</em>  <em>This makes it easy to collect, distribute and understand system requirements.</em> </p><br><p>  This principle correlates with the partern <a href="http://habr.com/ru/post/428209/">Common Language</a> (Ubiques language) from the DDD approach. </p><br><h3 id="ponimanie-kartiny-v-celom">  Understanding the whole picture </h3><br><p>  <em>Regardless of which system you are developing, large, small, software, hardware, or a business system, understanding the big picture is very important.</em>  <em>Without understanding the system as a whole, you will not be able to make the right decisions about what to include in the system, what to exclude, how much it will cost and what benefits it will bring.</em> </p><br><p>  Ivar Jacobson suggests using <a href="https://ru.wikipedia.org/wiki/%25D0%2594%25D0%25B8%25D0%25B0%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B0_%25D0%25BF%25D1%2580%25D0%25B5%25D1%2586%25D0%25B5%25D0%25B4%25D0%25B5%25D0%25BD%25D1%2582%25D0%25BE%25D0%25B2">a use-case diagram</a> , which is very convenient for gathering requirements.  If the requirements are collected and clear, then the best option would be the <a href="https://habr.com/ru/post/428209/">Context Map</a> (Context map) of Eric Evans.  Often, the Scrum approach is interpreted in such a way that people do not spend time on a strategic plan, considering planning, more than two weeks later, a relic of the past.  Jeff Sutherland‚Äôs propaganda descended on the waterflow, and the people who completed the two-week scram master training courses that were admitted to project management did their job.  But common sense is aware of the importance of strategic planning.  No need to make a detailed strategic plan, but it should be. </p><br><h3 id="fokus-na-znachenii">  Focus on meaning </h3><br><p>  <em>Trying to understand how the system will be used, it is always important to focus on the value that it will provide to its users and other interested parties.</em>  <em>Value is formed only when the system is used.</em>  <em>Therefore, it is much better to focus on how the system will be applied than on the long lists of functions or features that it can offer.</em> </p><br><p>  <em>The use cases provide this focus, helping you concentrate on how the system will be used by a particular user to achieve his goal.</em>  <em>The use cases cover a variety of ways to use the system: those that successfully achieve their goals, and those that solve any difficulties that arise.</em> </p><br><p>  Further, the author presents a remarkable scheme, to which one should pay the closest attention: </p><br><p><img src="https://habrastorage.org/webt/5g/nk/ma/5gnkmae4chv6_azevvzhg2euglc.png"></p><br><p>  The diagram shows the use case, "Cash withdrawal at an ATM".  The easiest way to achieve a goal is described in the Basic Flow.  Other cases are described as <em>Alternative</em> Flows.  These directions help with narration, structure the system and help with writing tests. </p><br><h3 id="posloynoe-postroenie">  Layering </h3><br><p> <em>Most systems require a lot of work before they are ready to use.</em>  <em>They have many requirements, most of which depend on other requirements, they must be implemented before the requirements are met and evaluated.</em> </p><br><p>  <em>Big mistake to create such a system at a time at a time.</em>  <em>The system should be built of pieces, each of which has a clear value for users.</em> </p><br><p>  These ideas have something in common with approaches of flexible development and with ideas of <em>Domains</em> (Domain). </p><br><h3 id="poshagovyy-vyvod-produkta-na-rynok">  Step-by-step product launch </h3><br><p>  <em>Most software systems have evolved over many generations.</em>  <em>They are not produced at one time;</em>  <em>they are built as a series of issues, each of which is built on a previous release.</em>  <em>Even the releases themselves often do not go beyond once, but develop through a series of intermediate versions.</em>  <em>Each step provides a visual, usable version of the system.</em>  <em>This is the way all systems should be created.</em> </p><br><h3 id="udovletvoryat-potrebnosti-komandy">  Meet the needs of the team </h3><br><p>  <em>Unfortunately, there is no universal solution to software development problems;</em>  <em>different teams and different situations require different styles and different levels of detail.</em>  <em>Regardless of which methods and techniques you choose, you must ensure that they are adaptable enough to meet the current needs of the team.</em> </p><br><p>  Eric Evans in his book urges not to spend a lot of time describing all the processes through UML.  Enough to use any visual schemes.  Different teams, different projects require different levels of detail, the UML author himself speaks about this. </p><br><h1 id="realizaciya">  Implementation </h1><br><p>  In pure architecture, Robert Martin gives the following definition of <em>Use Options</em> : </p><br><blockquote>  This is a case in point. </blockquote><p>  Let's try to translate these ideas into code.  Let's remember the scheme from the third principle of using the Use <em>Options</em> and take it as a basis.  Consider a really complex business process: "Cooking a pie with cabbage." </p><br><p>  Let's try to decompose it: </p><br><ul><li>  check product availability; </li><li>  take them from the warehouse; </li><li>  knead the dough; </li><li>  let the dough rise; </li><li>  prepare the filling; </li><li>  make a pie; </li><li>  bake a cake. </li></ul><br><p>  We will implement this whole sequence through <em>Interactor</em> , and each step will be implemented through a function or Functional Object on the Service Layer. </p><br><h1 id="posledovatelnost-deystviy-interactor">  Sequence of actions (Interactor) </h1><br><p><img src="https://habrastorage.org/webt/6b/vk/ra/6bvkra2chr3b8d43dmtxebpjaj4.png" alt="step-by-step"></p><br><p>  I highly recommend starting the development of a complex business process with the <em>Sequence of Action</em> .  More precisely not so, you should define the <em>Domain area</em> to which the business process belongs.  Clarify all business requirements.  Identify all <a href="http://habr.com/ru/post/435920/"><em>Entities</em></a> that are involved in the process.  Document the requirements and definitions of each <em>Entity</em> in the knowledge base. </p><br><p>  Paint everything on paper in steps.  Sometimes a sequence diagram is required.  Its author is the same who invented Use Cases (Use Case) - Ivar Jacobson.  The diagram was invented by him when he developed a telephone service system for Erickson, based on a relay circuit.  I really like this diagram, and the term <em>Sequence</em> , in my opinion, is more expressive than the term <em>Interactor</em> .  But due to the greater prevalence of the latter, we will use the familiar term - <em>Interactor</em> . </p><br><p>  A small hint, when you describe a business process as a good help for you, can be, the basic rule of workflow: "As a result of any economic activity, a document must be drawn up."  For example, we are developing a discount system.  Providing a discount, we in fact, from the point of view of business, conclude an agreement between the company and the client.  This contract must contain all the conditions.  That is, in the DiscountSystem domain, you will have Entites :: Contract.  Do not tie a discount to the client, but create an <em>Entity</em> Contract, which describes the rules for its provision. </p><br><p>  Back to the description of our business process, after it has become transparent to all the people involved in its development, and all your knowledge is recorded.  I recommend starting to write the code with a <em>sequence of actions</em> . </p><br><p>  The <em>Sequence</em> Design Pattern is responsible for: </p><br><ul><li>  sequence of <em>actions</em> ; </li><li>  coordination of data transferred between <em>Actions</em> ; </li><li>  error handling committed by <em>actions</em> during their execution; </li><li>  the return of the result of the set of <em>actions</em> taken; </li><li>  <strong>IMPORTANT</strong> : the main responsibility of this design pattern is the implementation of business logic. </li></ul><br><p>  I would like to dwell on the latter responsibility in more detail if we have a complicated process - we must describe it in such a way that it is clear what is happening without going into technical details.  <strong>You should describe it as expressively as your programming skills allow</strong> .  Entrust this class to the most experienced member of your team. </p><br><p>  Returning to the cake: try to describe the process of cooking through <em>Interactor</em> . </p><br><h2 id="realizaciya-1">  Implementation </h2><br><p>  I give an example of implementation, with our solution <a href="https://lunapark.dev/">LunaPark</a> , which we presented in a previous article. </p><br><pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Kitchen</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequences</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CookingPieWith</span></span></span><span class="hljs-class"></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">abbage</span></span></span><span class="hljs-class"> &lt; LunaPark::Interactors::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequence</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TEMPERATURE</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Temperature</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(180, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">unit</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cel</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call!</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services::CheckProductsAvailability</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ingredients</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dough</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services::BeatDough</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository::Products</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beat_ingredients</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filler</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services::Make</span></span></span><span class="hljs-class"></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">abbageFiller</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">from</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repository::Products</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">get</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filler_ingredients</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pie</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services::MakePie</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dough</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bake</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services::BakePie</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pie</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">temp</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TEMPERATURE</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sleep</span></span></span><span class="hljs-class"> 5.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">min</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">until</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bake</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pie</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beat_ingredients</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filler_ingredients</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_accessor</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pie</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ingredients_list</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">beat_ingredients_list</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filler_ingredients_list</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  As we can see, the <code>call!</code> method <code>call!</code>  describes the whole business logic of the baking process.  And it is convenient to use it to understand the logic of the application. </p><br><p>  Also, we can easily describe the process of baking fish pie, replacing <code>MakeabbageFiller</code> with <code>MakeFishFiller</code> .  Thereby, we very quickly change the business process, without significant code modifications.  And also, we can leave both <em>sequences</em> at the same time, scaling business cases. </p><br><h3 id="dogovorennosti">  Arrangements </h3><br><ul><li>  Method <code>call!</code>  is an obligatory method, it describes the order of <em>Actions</em> . </li><li>  Each initialization parameter can be described via a setter or <code>attr_acessor</code> : </li></ul><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Foo</span></span></span><span class="hljs-class"> &lt; LunaPark::Interactors::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequence</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... private attr_accessor :bar end Foo.call(bar: 42)</span></span></span></span></code> </pre> <br><ul><li>  The rest of the methods should be private. </li></ul><br><h2 id="primer-ispolzovaniya">  Usage example </h2><br><pre> <code class="ruby hljs">beat_ingredients = [ Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:flour</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:gr</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:oil</span></span>, <span class="hljs-number"><span class="hljs-number">50</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:gr</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:salt</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:spoon</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:milk</span></span>, <span class="hljs-number"><span class="hljs-number">150</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:ml</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:egg</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:unit</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:yeast</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:spoon</span></span> ] filler_ingredients = [ Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:cabbage</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:gr</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:salt</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:spoon</span></span>, Entity::Product.new <span class="hljs-symbol"><span class="hljs-symbol">:pepper</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:spoon</span></span> ] cooking = CookingPieWithabbage.call( <span class="hljs-symbol"><span class="hljs-symbol">beat_ingredients:</span></span> beat_ingredients, <span class="hljs-symbol"><span class="hljs-symbol">filler_ingredients:</span></span> filler_ingredients ) <span class="hljs-comment"><span class="hljs-comment">#   : cooking.success? # =&gt; true cooking.fail # =&gt; false cooking.fail_message # =&gt; '' cooking.data # =&gt; Entity::Pie #   : cooking.success? # =&gt; false cooking.fail # =&gt; true cooking.fail_message # =&gt; 'The pie burned out' cooking.data # =&gt; nil</span></span></code> </pre> <br><p>  The process is represented through an object and we have all the necessary methods to call it - did the call pass successfully, did any error occur during the call process, and if so, which one? </p><br><h2 id="obrabotka-oshibok">  Error processing </h2><br><p>  If we now recall the third principle of using the Use Case, let us pay attention to the fact that in addition to the <em>Main Direction</em> , we also had <em>Alternative</em> Directions.  These are errors that we must handle.  Consider an example: we certainly don‚Äôt want events to go this way, but we can‚Äôt do anything about it, the harsh reality is that the cakes are burned occasionally. </p><br><p>  <em>Interactor</em> intercepts all errors inherited from the class <code>LunaPark::Errors::Processing</code> . </p><br><p>  How do we keep track of the cake?  To do this, we define the <code>Burned</code> error in <code>BakePie</code> <em>Action</em> . </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Kitchen</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Errors</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Burned</span></span></span><span class="hljs-class"> &lt; LunaPark::Errors::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Processing</span></span></span><span class="hljs-class">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  And during baking, check that our cake is not burned: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Kitchen</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BakePie</span></span></span><span class="hljs-class"> &lt; LunaPark::Callable </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... rescue Errors::Burned, 'The pie burned out' if pie.burned? # ... end end end end</span></span></span></span></code> </pre> <br><p>  In this case, the error interceptor will work, and we will be able to deal with them in the <code></code> . <br>  Errors that are not inherited from <code>Processing</code> are perceived as systemic and will be intercepted at the server level.  If not indicated other conditions, the user will receive 500 ServerError. </p><br><h2 id="praktika-ispolzovaniya">  Practice use </h2><br><h3 id="1-staraytes-opisyvat-vse-vyzovy-v-metode-call">  1. Try to describe all calls in the call method! </h3><br><p>  Each <em>Action</em> should not be implemented by a separate method, it makes the code more bloated.  You have to look through the whole class several times to understand how it works.  Let's spoil the recipe for baking the cake: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CookingPieWith</span></span></span><span class="hljs-class"></span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">abbage</span></span></span><span class="hljs-class"> &lt; LunaPark::Interactors::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequence</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call!</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check_products_availability</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make_cabbage_filler</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">make_pie</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bake</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">check_products_availability</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services::CheckProductsAvailability</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">list</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ingredients</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end</span></span></span></span></code> </pre> <br><p>  Use the action call right in the classroom.  This approach from the point of view of ruby ‚Äã‚Äãmay seem unusual, so it looks more readable: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DrivingStart</span></span></span><span class="hljs-class"> &lt; LunaPark::Interactors::</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sequence</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call!</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service::CheckEngine</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service::StartUpTheIgnition</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">car</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">key</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service::ChangeGear</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">car</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gear_box</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">to</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">drive</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service::StepOnTheGas</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">car</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pedals</span></span></span><span class="hljs-class">[:</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">right</span></span></span><span class="hljs-class">] </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><h3 id="2-po-vozmozhnosti-ispolzuyte-metod-klassa-call">  2. If possible, use the call class method. </h3><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># good - ,   ,  . #    . Sequence::RingingToPerson.call(params) # good -   ,      e, #    ,     , #    . ring = Sequence::RingingToPerson.new(person) unless ring.success? ring.call sleep 5.min end</span></span></code> </pre><br><h3 id="3-ne-sozdavayte-_funkcionalnye-obekty_-radi-tipizacii-koda-smotrite-po-situacii">  3. Do not create <em>Functional Objects</em> for the sake of code typing, see the situation. </h3><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># bad -        ,  #     . module Services class BuildUser &lt; LunaPark::Callable def initialize(first_name:, last_name:, phone:) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@first</span></span></span><span class="hljs-comment">_name = first_name </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@last</span></span></span><span class="hljs-comment">_name = last_name </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@phone</span></span></span><span class="hljs-comment"> = phone end def call Entity::User.new( first_name: first_name, last_name: last_name, phone: phone ) end private attr_reader :first_name, :last_name, :phone end end module Sequences class RegisteringUser &lt; LunaPark::Interactors::Sequence attr_accessor :first_name, :last_name, :phone def call! user = Service::BuildUser.call(first_name: first_name, last_name: last_name, phone: phone) end end end # good -     ,  . #        , #       . module Sequences class RegisteringUser &lt; LunaPark::Interactors::Sequence attr_accessor :first_name, :last_name, :phone def call! user #... end private def user </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@user</span></span></span><span class="hljs-comment"> = Entity::User.new( first_name: first_name, last_name: last_name, phone: phone ) end end end</span></span></code> </pre> <br><h1 id="servisnyy-sloy-service-layer">  Service Layer </h1><br><p><img src="https://habrastorage.org/webt/1-/qv/ip/1-qvipbbxxz2i0cveslcf02b7c0.png" alt="lsd"></p><br><p>  <em>The order of actions</em> (Interactor), as we said, describes the business logic at the top level.  <em>The service layer</em> (Service layer) already reveals the details of the implementation of functional requirements.  If we are talking about making a cake, then at the level of the <em>Order of Action</em> (Interactor) we simply say ‚Äúknead the dough‚Äù, without going into details on how to knead it.  The kneading process is described at the <em>Service level</em> .  Let's return to the original source, the <a href="https://www.oreilly.com/library/view/domain-driven-design-tackling/0321125215/">big blue book</a> : </p><br><p>  <em>In the applied domain, there are such operations that cannot find a natural place in an object of Entity or Value object.</em>  <em>They are in essence not objects, but activities.</em>  <em>But since our modeling paradigm is based on an object-based approach, we will try to turn them into objects.</em> </p><br><p>  <em>At this point, it is easy to make a common mistake: to abandon the attempt to place an operation in an object suitable for it, and thus come to procedural programming.</em>  <em>But if you forcibly place an operation in an object with a definition that is alien to it, the object itself will lose the purity of the plan, it will become harder to understand and refactor.</em>  <em>If in a simple object to implement a lot of complex operations, it can turn into an incomprehensible thing, it is not clear what is busy</em>  <em>Other domain objects are often involved in such operations, and they are coordinated to perform a joint task.</em>  <em>Additional responsibility creates chains of dependencies between objects, mixing concepts that could be considered independently.</em> </p><br><p>  When choosing a place to implement a particular functionality, always use common sense.  Your task is to make the model more expressive.  Let's look at an example, "We need to chop firewood": </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Wood</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chop</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end end</span></span></span></span></code> </pre> <br><p>  This method will be an error.  Firewood does not chop itself, we will need an ax: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Axe</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chop</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sacrifice</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end end</span></span></span></span></code> </pre> <br><p>  If we use a simplified business model, that will be enough.  But if the process needs to be modeled in more detail, we will need a person who will cut this wood, and perhaps some log that will be used as a support for the process. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Entities</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Human</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chop_firewood</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wood</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">axe</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">chock</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end end</span></span></span></span></code> </pre><br><p>  As you may have guessed, this is not a good idea.  Not all of us are engaged in cutting wood, it is not a direct duty of man.  We often see how overloaded are models in Ruby on Rails that store similar logic in them: getting a discount, adding a product to the cart, withdrawing money to the balance.  This logic does not refer to an entity, but to a process in which this entity is involved. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ChopFirewood</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end</span></span></span></span></code> </pre> <br><p>  After we figured out what logic we store in the <em>Services</em> we will try to implement one of them.  Most often services are implemented through methods or functional objects. </p><br><h2 id="funkcionalnye-obekty">  Functional objects </h2><br><p>  A functional object fulfills one functional requirement.  In its most primitive form, a functional object has one single public method - <code>call</code> . </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Serivices</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sum</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">self</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">,</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class">).</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">x</span></span></span><span class="hljs-class">, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">y</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  Such objects have several advantages: they are concise, they are very easy to test.  There is a drawback, such objects can get a large number.  There are several ways to group such objects, we divide them by type in part of our projects: </p><br><ul><li>  <em>Service object</em> (Service) - an object that creates a new object; </li><li>  <em>Command</em> (Command) - changes the current object; </li><li>  <em>Watchman</em> (Guard) - returns an error if something went wrong. </li></ul><br><h2 id="servisnyy-obekt-service">  Service Object (Service) </h2><br><p>  In our service implementation, it implements a functional requirement and always returns a value. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KorovaMilkBar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FindMilk</span></span></span><span class="hljs-class"> &lt; LunaPark::Callable </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GLASS_SIZE</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Values::Unit</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">wrap</span></span></span><span class="hljs-class"> '200</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">g</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class">:) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shelfs</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">find</span></span></span><span class="hljs-class"> { |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shelf</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">shelf</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">has?</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GLASS_SIZE</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">of</span></span></span><span class="hljs-class">: :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">milk</span></span></span><span class="hljs-class">) } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FindMilk</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">the_red_one</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; #&lt;Glass: ... &gt;</span></span></span></span></code> </pre> <br><h2 id="komanda-command">  Command (Command) </h2><br><p>  In our implementation, the <em>Command</em> executes one <em>Action</em> , modifies the object, and returns true if successful.  In fact, the <em>Team</em> does not create an object, but modifies an existing one. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KorovaMilkBar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Commands</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FillGlass</span></span></span><span class="hljs-class"> &lt; LunaPark::Callable </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">glass</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class">:) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">glass</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">glass</span></span></span><span class="hljs-class"> @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">content</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">with</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">glass</span></span></span><span class="hljs-class"> &lt;&lt; content </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">true</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attr_reader</span></span></span><span class="hljs-class"> :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fridge</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">glass</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Glass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">empty</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">milk</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Milk</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">new</span></span></span><span class="hljs-class">(200, :</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">gr</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">glass</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">empty?</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># =&gt; true FillGlass.call glass, with: milk # =&gt; true glass.empty? # =&gt; false</span></span></span></span></code> </pre> <br><h2 id="vahter-guard">  Watchman (Guard) </h2><br><p>  <em>Watchman</em> , performs a logical check, and in case of failure, gives a processing error.  This type of object does not affect the <em>Main direction</em> in any way, but it switches us to the <em>Alternative direction</em> if something went wrong. </p><br><p>  When serving milk, it is important to make sure that it is fresh: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">KorovaMilkBar</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Guards</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IsFresh</span></span></span><span class="hljs-class"> &lt; LunaPark::Callable </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">product</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">products</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">products</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">products</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">each</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">do</span></span></span><span class="hljs-class"> |</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">product</span></span></span><span class="hljs-class">| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">raise</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Errors::Rotten</span></span></span><span class="hljs-class">, "</span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment">#{product.title} is not fresh" if product.expiration_date &gt; Date.today end nil end private attr_reader :products end end end</span></span></span></span></code> </pre> <br><p>  You may find it convenient to separate functional objects by type.  You can add your own, for example, <em>Builder</em> - creates an object based on parameters. </p><br><h3 id="dogovorennosti-1">  Arrangements </h3><br><ul><li>  The <code>call</code> method is the only required public method. </li><li>  The <code>initialize</code> method is the only optional public method. </li><li>  The rest of the methods should be private. </li><li>  Logical errors must be inherited from the <code>LunaPark::Errors::Processing</code> class. </li></ul><br><h2 id="obrabotka-oshibok-1">  Error processing </h2><br><p>  It is necessary to separate 2 types of errors that can occur during the operation of an <em>Action</em> . </p><br><h5 id="oshibki-processa-vypolneniya">  Execution errors </h5><br><p>  Such errors may occur as a result of violation of processing logic. </p><br><p>  For example: </p><br><ul><li>  when creating a user email is reserved; </li><li>  when you try to drink milk, it ended; </li><li>  another microservice rejected the action (for a logical reason, and not because the service is unavailable). </li></ul><br><p>  In all likelihood, the user will want to know about these errors.  Also probably these are the mistakes <br>  which we can foresee. </p><br><p>  Such errors should be inherited from <code>LunaPark::Errors::Processing</code> </p><br><h5 id="sistemnyy-oshibki">  System errors </h5><br><p>  Errors that occurred as a result of a system failure. </p><br><p>  For example: </p><br><ul><li>  DB does not work; </li><li>  something shared on zero. </li></ul><br><p>  In all likelihood, we cannot foresee these errors and cannot say anything to the user, except that everything is very bad, and send the developers a report calling for action.  Such errors should be inherited from <code>SystemError</code> </p><br><p>  There are also <strong>validation errors</strong> , which we will discuss in more detail in the next article. </p><br><h2 id="praktika-ispolzovaniya-1">  Practice use </h2><br><h3 id="1-ispolzuyte-peremennye-chtoby-povysit-chitaemost">  1. Use variables to increase readability. </h3><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Fishing</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># bad -   Serivices::Catch.call(fish, rod) # bad -  Serivices::Catch.call(fish: fish, rod: rod) # good -   Serivices::Catch.call(fish, with: rod) module Serivices class Catch def initialize(fish, with:) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@fish</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = fish </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@rod</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = with #      #   . end # ... private attr_reader :fish, :rod end end end</span></span></span></span></code> </pre> <br><h3 id="2-peredavayte-obekty-a-ne-parametry">  2. Pass objects, not parameters </h3><br><p>  Try to make the initializer simple if parameter handling is not its goal. <br>  Pass objects, not parameters. </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Service</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># bad -        -.  #      ,   . class Foo def initialize(foo_params:, bar_params:) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@foo</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Values::Foo.new(*foo_params) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@bar</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = Values::Bar.new(*bar_params) end # ... end Services::Foo.call(foo: {a: 1, b: 2}, bar: 34) # good -   -. class Bar def initialize(foo:, bar:) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@foo</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = foo </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@bar</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> = bar # ... end end foo = Values::Foo.new(a: 1, b: 2) bar = Values::Bar.new(34) Services::Bar.call(foo: foo, bar: bar) # good -       - Builder. class BuildFoo def initialize(param_1:, param_2:) </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_1 = param_1 </span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span></span><span class="hljs-class"><span class="hljs-comment">_1 = param_1 end def call Foo.new( param_1: param_1.foo, param_2: param_2.bar, param_3: some_magick ) end # ... end end</span></span></span></span></code> </pre> <br><h3 id="3-ispolzuyte-v-nazvanie-deystviya---glagol-deystviya-i-obekt-vozdeystviya">  3. Use in the name of the Action - the verb of action and the object of impact. </h3><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># bad module Services class Milk; end class Work; end class FooBuild; end class PasswordGenerator; end end # good module Services class GetMilk; end class WorkOnTable; end class BuildFoo; end class GeneratePassword; end end</span></span></code> </pre> <br><h3 id="4-po-vozmozhnosti-ispolzuyte-metod-klassa-call">  4. If possible, use the call class method. </h3><br><p>  Usually an instance of the class <em>Action</em> is rarely used except to write to make a call. </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># good -    . Services::BuildFoo.call(params) # good -     Services::BuildFoo.(params) # good -   ,      , #    ,     ,   #  . ring = Services::RingToPhone.new(phone: neighbour) 10.times do ring.call end</span></span></code> </pre> <br><h3 id="5-obrabotka-oshibok-ne-yavlyaetsya-zadachey-servisa">  5. Error handling is not a service task. </h3><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># bad -    ,   . def call #... rescue SystemError =&gt; e return false end</span></span></code> </pre> <br><h2 id="moduli">  Modules </h2><br><p>  Up to this point we have considered the implementation of the <em>Service layer</em> as a set of functional objects.  But we can easily place methods on this layer: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">sum</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">a</span></span></span><span class="hljs-class"> + </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">b</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">end</span></span></span></span></code> </pre> <br><p>  Another problem that confronts us is a large number of service facilities.  Instead of those who scored the rails fat model, we get the services fat folder.  There are several ways to organize the structure to reduce the scale of the tragedy.  Eric Evans solves this by combining a series of functions into one class.  Imagine that we need to model the business processes of a nanny, Arina Rodionovna, she can feed Pushkin and put him to sleep: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">NoonService</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initialize</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">arina_radionovna</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">pushkin</span></span></span><span class="hljs-class">) </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end def to_feed # ... end def to_sleep # ... end end</span></span></span></span></code> </pre> <br><p>  This approach is more correct in terms of OOP.  But we suggest to refuse it, at least, at the initial stages.  Not very experienced programmers begin to write a lot of code in this class, which ultimately leads to an increase in connectivity.  Instead, you can use the module, representing the activity of some abstraction: </p><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Services</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">module</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Noon</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ToFeed</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">def</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">call!</span></span></span><span class="hljs-class"> </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># ... end end class &lt;&lt; self #    ,   #    def to_feed(arina_radionovna, pushkin) ToFeed.new(arina_radionovna, pushkin).call end #    ,    def to_sleep(arina_radionovna, pushkin) arina_radionovna.tell_story pushkin pushkin.state = :sleep end end end end</span></span></span></span></code> </pre> <br><p>  When dividing into modules, low external dependence (low coupling) should be observed with high internal cohesion, we use such modules as Services, or Interactors, this also goes against the ideas of pure architecture.  This is a conscious choice that facilitates perception.  By the file name, we understand which design pattern a particular class implements, if it‚Äôs obvious to an experienced programmer, this is not always the case for a beginner.  After your team is ready, discard this overkill. </p><br><p>  I will quote another small excerpt from the big blue book: </p><br><p>  <em>Choose such modules that tell the story of the system and contain coherent sets of concepts.</em>  <em>From this, the low dependence of the modules on each other often occurs by itself.</em>  <em>But if this is not the case, find a way to change the model in such a way as to separate the concepts from each other, or look for the concept missing in the model, which could become the basis for the module and thus bring the elements of the model together in a natural, meaningful way.</em>  <em>Achieve low dependence of modules on each other in the sense that concepts in different modules could be analyzed and perceived independently of each other.</em>  <em>Modify the model until natural boundaries arise in it in accordance with the high-level concepts of the domain, and the corresponding code is not split accordingly.</em> </p><br><p>  <em>Give the modules the names that will be included in the ONE LANGUAGE.</em>  <em>Both the MODULES themselves and their names should reflect the knowledge and understanding of the subject area.</em> </p><br><p>  The topic of the modules is large and interesting, but in full it clearly goes beyond the topic of this article.  Next time we will talk to you about <em>repositories</em> and <em>adapters</em> .  We opened a <a href="https://t.me/lunapark_dev">cozy telegram channel</a> where I would like to share materials on the topic of DDD.  We will be glad to your questions and feedback. </p><br><hr><br><div class="spoiler">  <b class="spoiler_title">sources of inspiration</b> <div class="spoiler_text"><ul><li>  <a href="https://www.netsolutions.com/insights/business-and-functional-requirements-what-is-the-difference-and-why-should-you-care/">https://www.netsolutions.com/insights/business-and-functional-requirements-what-is-the-difference-and-why-should-you-care/</a> </li><li>  <a href="http://magazines.russ.ru/nz/2007/54/gi3.html">http://magazines.russ.ru/nz/2007/54/gi3.html</a> </li><li>  <a href="https://www.microtool.de/en/knowledge-base/how-use-case-2-0-works/">https://www.microtool.de/en/knowledge-base/how-use-case-2-0-works/</a> </li><li>  <a href="https://www.researchgate.net/publication/220059381_Use_cases_-_Yesterday_today_and_tomorrow">https://www.researchgate.net/publication/220059381_Use_cases_-_Yesterday_today_and_tomorrow</a> </li><li>  Problem-Oriented Design, Eric J. Evans </li></ul></div></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/454668/">https://habr.com/ru/post/454668/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../454652/index.html">Jet engine on a home 3D printer</a></li>
<li><a href="../454656/index.html">How to catch 4G-Internet in the village</a></li>
<li><a href="../454658/index.html">Beauty Gadgets - Serious Business</a></li>
<li><a href="../454662/index.html">Careful transfer to the Netherlands with his wife and mortgage. Part 1: Job Search</a></li>
<li><a href="../454666/index.html">Software Defined Radio - how does it work? Part 7</a></li>
<li><a href="../45467/index.html">How to promote your video on YouTube</a></li>
<li><a href="../454670/index.html">The series "Chernobyl": watch and think</a></li>
<li><a href="../454674/index.html">Poor man's monitoring or monitor server from console</a></li>
<li><a href="../454676/index.html">GPS clock on Arduino</a></li>
<li><a href="../454678/index.html">The idiomatic programming of a GPU on Rust: The Emu Library</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>