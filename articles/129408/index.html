<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parsing attacks into pieces: SYN-flood</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Spoofed SYN is an attack in which packet headers are faked so that the real sender is replaced by an arbitrary or non-existent IP address. 
 Since, in...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parsing attacks into pieces: SYN-flood</h1><div class="post__text post__text-html js-mediator-article"><blockquote>  Spoofed SYN is an attack in which packet headers are faked so that the real sender is replaced by an arbitrary or non-existent IP address. </blockquote><br>  Since, in essence, SYN is a frequent tool of ‚Äú <i>intense competition</i> ‚Äù and - at the same time - most DDoS mitigation solutions show impressive effectiveness precisely on this type of attack, we will start a SYN-flood, considering the spoofed-type attack as terrible of them. <br><a name="habracut"></a><br><h4>  Disclaimers </h4><br><h5>  Disclaimer # 1 </h5><br>  Everything described in this and subsequent topics is in fact not know-how.  All methodologies are open, and at one time or another (some from 2003) were published in open sources.  I took the trouble only to reduce them to one and describe a ‚Äú <i>global strategy</i> ‚Äù of protection focused on system administrators serving small projects located on dedicated servers (the described strategy can be applied in shared projects, but the implementation will be so <i>prohibitively</i> terrible that There is no desire to write about it) <br><br><h5>  Disclaimer # 2 </h5><br>  In the topic hardware protection solutions are <i>not considered</i> - firstly, they are well reviewed in numerous articles by the manufacturers of these same solutions, and secondly, projects that have one server can not often afford them (roughly speaking, the price of working solutions starts from 20 thousand euros ), thirdly, the author does not have sufficient data and experience in working with such specialized hardware to draw global conclusions about the methods and effectiveness of such protection - it is hardly interesting for anyone to review the solutions from two vendors  of a dozen, not supported by major operating statistics for their use.  But it is worth noting that both hardware solutions that I had to use are usually very effective on SYN attacks <i>when certain conditions are met</i> . <br><br><h5>  Disclaimer ‚Ññ3 </h5><br>  The topic <i>does not consider</i> providers of protection against DDoS attacks - the service engineers of these organizations will be able to describe their working methods better and in more detail.  It would probably be worthwhile to review the providers themselves as such - from the client‚Äôs point of view (at different times the projects in which I participated were clients of Dragonara, Blacklotus, Gigenet, Vistnet (at the moment), Prolexic (at the moment) and a number of sellers of services of the above companies), but this is out of the scope of the topic, try to talk about it later.  Again, it is worth noting that all the protection providers with which the author‚Äôs projects are working or working cope with the problem of SYN-attacks, showing good efficiency. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Some mechanics and wikipedia </h4><br>  I would not like to turn the topic into a kind of RFC and quote well known truths, so we limit ourselves to what TCP is interesting from the point of view of a SYN attack and go over the tops. <br><br>  First, TCP is one of the most used transport protocols, on top of which most application protocols reside.  Secondly, it has a number of special features (clearly confirming the start and end of the connection, flow control, etc.) - which make its implementation relatively complex and resource-intensive. <br><br>  In the context of the article, it is interesting to consider the mechanism for establishing a TCP connection ‚Äî a three-way handshake.  In the first approximation at the ‚Äúclient-server‚Äù level, it looks like this: the client sends a SYN-packet to the server, to which the SYN + ACK responds. The client sends an ACK to the server's SYN in response and the connection enters the established state. <br><br>  SYN-attack ‚Äî Sending a mass of SYN-packets to an open port of a server that does not establish a real connection for one reason or another, which entails creating ‚Äúhalf-open connections‚Äù that overwhelm the connection queue, forcing the server to deny service to other clients.  Plus, TCP RFC requires the server to respond to each incoming SYN, which additionally hits both server resources and the data transfer channel.  In other matters, if you have already encountered - in fact - any DDoS attacks - you know the above described without me.  Go to the specific recommendations. <br><br><h4>  Alone in the field </h4><br>  Use what is at hand, and do not look for something else for yourself - what can be done while alone with the attack?  Honestly, not much, but it happens that there is enough of that.  The following describes what to do with FreeBSD, since in our projects in 90% of cases this system is used.  However, from OS to OS, the difference will be small - the principles are the same. <br><br>  <b>The first</b> is that you need to access the server (yes, this can also be a difficulty, especially if the attack is large-scale and / or long-lasting - the server simply chose all buffers or has 100% CPU).  Usually, it is enough to close the attacked service with a firewall or simply its service to extinguish (however, if an attack is detected, this must be done anyway, at least in order to be able to do something else on the server). <br><br>  <b>The second</b> is to get the first information about the attack.  If you have already monitored incoming traffic - fine, if not - we open the firewall / raise the service and use the good old tcpdump and netstat to find out what exactly is attacking and what is the size of the attack in packets per second.  Along the way, you can quickly see the networks from which mass requests come - whether they belong to a typical audience for your service.  All this will come in handy in the future. <br><br>  <b>The third</b> is on the interface where the attacked IP address is located should remain only one.  Each alias will decrease system performance.  This is expressed in different numbers for different systems, but these numbers are serious, each alias can cost an additional 2-3 thousand packets per second. <br><br>  <b>Fourth</b> , if you use any firewall for incoming traffic at the attacked address, all rules except blocking should be disabled ‚Äî for example, when a SYN attack is spoofed, the likelihood that the PF SYN-proxy from PF will go to zero and CPU it will take very seriously. <br><br>  <b>Fifth</b> , we set up the system.  Miracles will not be here, they need a piano in the bushes in the form of trained drivers and specially purchased network cards, and the only two general recommendations that seriously affect the ability to receive SYN-attacks have long been known to all: <br>  - Smudge interrupt handling on server processors; <br>  - Enable syn-cookies and disable syn-cache. <br><br>  The rest of the tuning system will help squeeze out an additional 5-10 thousand packages, which is unlikely to be decisive in the conditions of attack.  In case he comes in handy to someone, this is the most common config (without including options that require rebuilding the kernel or specialized drivers): <br><br><pre><code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.isr.direct=<span class="hljs-number"><span class="hljs-number">1</span></span> kern.ipc.nmbclusters=<span class="hljs-number"><span class="hljs-number">400000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.nolocaltimewait=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.recvspace=<span class="hljs-number"><span class="hljs-number">16384</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.sendspace=<span class="hljs-number"><span class="hljs-number">32768</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.msl=<span class="hljs-number"><span class="hljs-number">5000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.blackhole=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.ip.intr_queue_maxlen=<span class="hljs-number"><span class="hljs-number">3000</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.blackhole=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.udp.blackhole=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.icmp.log_redirect=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.ip.redirect=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.icmp.maskrepl=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.tcp.syncookies_only=<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.route.netisr_maxqlen=<span class="hljs-number"><span class="hljs-number">4096</span></span> kern.ipc.maxsockbuf=<span class="hljs-number"><span class="hljs-number">83886080</span></span> <span class="hljs-built_in"><span class="hljs-built_in">net</span></span>.inet.ip.intr_queue_maxlen=<span class="hljs-number"><span class="hljs-number">10240</span></span></code> </pre> <br>  The system of the level of the desktop computer, configured in accordance with these recommendations: <br><br><pre> <code class="hljs lisp">first# netstat -w1 -h -d      input     (<span class="hljs-name"><span class="hljs-name">Total</span></span>)      output packets  errs idrops    bytes   packets  errs    bytes colls drops   <span class="hljs-number"><span class="hljs-number">260</span></span>K  <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-number"><span class="hljs-number">0</span></span>     <span class="hljs-number"><span class="hljs-number">15</span></span>M    <span class="hljs-number"><span class="hljs-number">230</span></span>K   <span class="hljs-number"><span class="hljs-number">0</span></span>     <span class="hljs-number"><span class="hljs-number">13</span></span>M   <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  System level IBM System x3630 M3, configured in accordance with these recommendations: <br><br><pre> <code class="hljs lisp">second# netstat -w1 -h -d      input     (<span class="hljs-name"><span class="hljs-name">Total</span></span>)      output packets  errs idrops    bytes   packets  errs    bytes colls drops   <span class="hljs-number"><span class="hljs-number">477</span></span>K  <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-number"><span class="hljs-number">0</span></span>     <span class="hljs-number"><span class="hljs-number">36</span></span>M    <span class="hljs-number"><span class="hljs-number">457</span></span>K   <span class="hljs-number"><span class="hljs-number">0</span></span>     <span class="hljs-number"><span class="hljs-number">25</span></span>M   <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Detailed configurations of the OS and machines, and, in fact, how we came to them - I will try to tell you in the next topic. <br><br><h4>  One thing we do </h4><br>  What to do besides tuning the system In principle, there is something to do. <br><br>  It is worth making a small digression - most hosting companies will be extremely reluctant to help in the fight against the attack, if they help at all, and they are hard to blame for this.  But at least they will provide information about the attack - if you have to work with defense providers, this, together with the information you collected during the attack, will make your life a lot easier. <br><br>  If the hoster has got an understanding (which is really a <i>big rarity</i> ) - then we work according to the following algorithm - <i>parallel and block, block and parallel</i> : <br>  If we have several network cards (if not, please put them) ‚Äîincluding them in <a href="http://en.wikipedia.org/wiki/Link_aggregation">LACP</a> mode (you will need to enable similar options on the host switch) ‚Äîit will actually give you a one-and-a-half increase in performance (we will consider some subtleties of the process later - to comprehend the immense topic does not work) We leave here to this performance: <br><br><pre> <code class="hljs lisp">second# netstat -w1 -h -d      input     (<span class="hljs-name"><span class="hljs-name">Total</span></span>)      output packets  errs idrops    bytes   packets  errs    bytes colls drops   <span class="hljs-number"><span class="hljs-number">1.2</span></span>M  <span class="hljs-number"><span class="hljs-number">16</span></span>K   <span class="hljs-number"><span class="hljs-number">0</span></span>     <span class="hljs-number"><span class="hljs-number">65</span></span>M    <span class="hljs-number"><span class="hljs-number">1.1</span></span>M   <span class="hljs-number"><span class="hljs-number">0</span></span>     <span class="hljs-number"><span class="hljs-number">59</span></span>M   <span class="hljs-number"><span class="hljs-number">0</span></span>   <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre> <br>  Please block all unused ports and protocols - a SYN-attack can easily be replaced by a UDP attack. <br>  Virtually any hosting company is capable of these actions.  But if you are lucky enough to work with a serious company - ask to block traffic from a region where most of your project‚Äôs audience (for example, China) doesn‚Äôt live - this usually means a blackhole announcement for your network for backbone providers of a particular region.  As a rule, a SYN-attack is made from Asia, because of its cheapness and mass character, and, therefore, such an announcement can seriously help in the fight against the attack or rule out its possibility altogether. <br><br>  In addition to the measures described above, it is advisable to use a GeoDNS-like service ‚Äî under some conditions (an attack is carried out on a domain, for example) this will work in the same way as announcing blackhole for certain networks. <br><br><h4>  At last </h4><br>  I hope the article will help you cope with the problem of SYN-flood, not exceeding the annual budget of some African countries.  Of course, only the most general recommendations are given here, but believe me - in 90% of cases they are quite enough.  And most importantly - don't panic! <br><br>  UPD.  Continuation is in the process of writing, and will soon be posted here.  Stay with us! </div><p>Source: <a href="https://habr.com/ru/post/129408/">https://habr.com/ru/post/129408/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../129402/index.html">And what is your last completed project?</a></li>
<li><a href="../129403/index.html">Review of the "sleeping" laptop Samsung 350U2B</a></li>
<li><a href="../129404/index.html">Princeton will be struggling with a paid subscription to scientific articles</a></li>
<li><a href="../129406/index.html">Plugin sliding panel with icons of social networks</a></li>
<li><a href="../129407/index.html">Animated graphics with gnuplot + bash + Avidemux</a></li>
<li><a href="../129409/index.html">The basics of Dojo on the example of a self-made Habr-parser</a></li>
<li><a href="../129411/index.html">Review of the BlackBerry Bold 9900 and Torch 9810, 9860 - prospects?</a></li>
<li><a href="../129413/index.html">Habra Informer</a></li>
<li><a href="../129414/index.html">Anonymous predicted delisting of company stock</a></li>
<li><a href="../129419/index.html">Do you use "regular" software that is distributed with a laptop (PC)?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>