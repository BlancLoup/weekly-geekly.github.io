<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>OS Development on Go + asm Part 0x00</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day% username%. 

 I wanted to pee something abnormal. The choice fell on the OS, in the end, each programmer must write his own OS, even if only...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>OS Development on Go + asm Part 0x00</h1><div class="post__text post__text-html js-mediator-article">  Good day% username%. <br><br>  I wanted to pee something abnormal.  The choice fell on the OS, in the end, each programmer must write his own OS, even if only a training one. <br><br>  As some people know, I really like Go language well, and decided to try writing on it.  What came out of it is under the habrakat. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Part 0x00 <br>  <a href="http://habrahabr.ru/post/259839/">Part 0x01</a> <br><a name="habracut"></a><br><br><h1>  Step 0x00 </h1><br>  I will not write my bootloader; not for that, smart people came up with the multiboot spec. <br><br>  First, let's write the initial load code (file multiboot.s) <br><pre><code class="hljs pgsql">MBOOT_PAGE_ALIGN equ <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">0</span></span> MBOOT_MEM_INFO equ <span class="hljs-number"><span class="hljs-number">1</span></span>&lt;&lt;<span class="hljs-number"><span class="hljs-number">1</span></span> MBOOT_HEADER_MAGIC equ <span class="hljs-number"><span class="hljs-number">0x1BADB002</span></span> MBOOT_HEADER_FLAGS equ MBOOT_PAGE_ALIGN | MBOOT_MEM_INFO MBOOT_CHECKSUM equ -(MBOOT_HEADER_MAGIC + MBOOT_HEADER_FLAGS) [BITS <span class="hljs-number"><span class="hljs-number">32</span></span>] [<span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> mboot] [EXTERN code] [EXTERN bss] [EXTERN <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>] mboot: dd MBOOT_HEADER_MAGIC dd MBOOT_HEADER_FLAGS dd MBOOT_CHECKSUM dd mboot dd code dd bss dd <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> dd <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">GLOBAL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>] extern go.kernel.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> ;  ,        Go <span class="hljs-keyword"><span class="hljs-keyword">start</span></span>: push ebx cli <span class="hljs-keyword"><span class="hljs-keyword">call</span></span> go.kernel.<span class="hljs-keyword"><span class="hljs-keyword">Load</span></span> ;  ,      jmp $</code> </pre> <br><br>  Now we will create a kernel.go file with the following content: <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> kernel <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">func</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Load</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-comment"><span class="hljs-comment">//        }</span></span></code> </pre><br><br>  Create a file link.ld <br><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">ENTRY</span></span>(start) <span class="hljs-type"><span class="hljs-type">SECTIONS</span></span> { .text <span class="hljs-number"><span class="hljs-number">0x100000</span></span> : { code = .; _code = .; __code = .; *(.text) . = <span class="hljs-type"><span class="hljs-type">ALIGN</span></span>(<span class="hljs-number"><span class="hljs-number">4096</span></span>); } .<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">data</span></span></span><span class="hljs-class"> : { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class"> = .; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_data</span></span></span><span class="hljs-class"> = .; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__data</span></span></span><span class="hljs-class"> = .; *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">data</span></span></span><span class="hljs-class">) *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">rodata</span></span></span><span class="hljs-class">) . = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ALIGN(4096)</span></span></span><span class="hljs-class">; } .bss : { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bss</span></span></span><span class="hljs-class"> = .; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">_bss</span></span></span><span class="hljs-class"> = .; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">__bss</span></span></span><span class="hljs-class"> = .; *(.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">bss</span></span></span><span class="hljs-class">) . = </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ALIGN(4096)</span></span></span><span class="hljs-class">; } end = .; _end = .; __end = .; }</span></span></code> </pre><br><br>  and makefile <br><pre> <code class="hljs mel">SOURCES=multiboot.o kernel.go.o GOFLAGS= -nostdlib -nostdinc -fno-stack-protector -fno-split-stack -static -m32 -g -I. GO=gccgo ASFLAGS= -felf NASM= nasm $(ASFLAGS) OBJCOPY=objcopy LDFLAGS=-T link.ld -m elf_i386 all: $(SOURCES) link clean: rm *.o kernel link: ld $(LDFLAGS) -o kernel $(SOURCES) %.go.o: %.go $(GO) $(GOFLAGS) -o $@ -c $&lt; %.o: %.s $(NASM) $&lt;</code> </pre><br><br>  Now, after running make in the project directory, you will get the kernel file, which can be loaded using qemu: <br><br>  <b>qemu-system-i386 -kernel ./kernel</b> <br><br>  The kernel will successfully boot and will not do anything) <br><br><h1>  Step 0x01 </h1><br><br>  It is time to say hello to the world. <br><br>  First, add the following lines to multiboot.s: <br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">global</span></span> __go_runtime_error <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> __go_register_gc_roots <span class="hljs-keyword"><span class="hljs-keyword">global</span></span> __unsafe_get_addr __unsafe_get_addr: push ebp mov ebp, esp mov eax, [ebp+<span class="hljs-number"><span class="hljs-number">8</span></span>] mov esp, ebp pop ebp ret __go_register_gc_roots: __go_runtime_error: ret</code> </pre><br><br>  the __unsafe_get_addr function is needed so that we can convert uint32 to pointers inside Go <br><br>  The other two functions are just plugs for the compiler. <br><br>  Now create the screen.go file <br><pre> <code class="go hljs"><span class="hljs-keyword"><span class="hljs-keyword">package</span></span> screen <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ( frameBuffer *[totalMax]<span class="hljs-keyword"><span class="hljs-keyword">uint16</span></span> <span class="hljs-comment"><span class="hljs-comment">// 8  - ,  -   cursorX, cursorY uint8 ) const ( frameBufferAddr = 0xB8000 maxX = 80 maxY = 25 totalMax = maxX * maxY whiteOnBlack = 0x07 ) //     Go    __unsafe_get_addr //extern __unsafe_get_addr func getAddr(addr uint32) *[totalMax]uint16 func Init() { cursorX = 0 cursorY = 0 frameBuffer = getAddr(frameBufferAddr) //    } // ,      func Clear() { for i := 0; i &lt; totalMax; i++ { frameBuffer[i] = 0 } cursorX = 0 cursorY = 0 } //   func SetCursor(x, y uint8) { cursorX = x cursorY = y } //     func scroll() { if cursorY &gt;= maxY { for i := 0; i &lt; 24*maxX; i++ { frameBuffer[i] = frameBuffer[i+80] //      } for i := 24 * 80; i &lt; totalMax; i++ { //   frameBuffer[i] = 0x20 | (((0 &lt;&lt; 4) | (15 &amp; 0x0F)) &lt;&lt; 8) frameBuffer[i] = 0 } cursorY = 24 cursorX = 0 } } //  func putChar(c byte) { switch c { case 0x08: //backspace if cursorX &gt; 0 { cursorX-- } case 0x09: //tab cursorX = (cursorX + 8) &amp; (8 - 1) case '\r': //return cursorX = 0 case '\n': //new line cursorX = 0 cursorY++ default: if c &gt;= 0x20 { //   frameBuffer[cursorY*80+cursorX] = uint16(c) | (((0 &lt;&lt; 4) | (15 &amp; 0x0F)) &lt;&lt; 8) cursorX++ } } if cursorX &gt;= 80 { //    cursorX = 0 cursorY++ } scroll() } //  func PrintStr(s string) { for i := 0; i &lt; len(s); i++ { putChar(s[i]) } }</span></span></code> </pre><br><br>  Now we need to connect our screen module to the kernel - add import "screen" to kernel.go, and in the Load () function, we also write: <br><pre> <code class="go hljs"> screen.Init() screen.Clear() screen.PrintStr(<span class="hljs-string"><span class="hljs-string">"Hello Habrahar!"</span></span>)</code> </pre><br><br>  Now we need to tell the compiler how to collect the whole thing; we will need to add the following lines to the Makefile: <br><pre> <code class="hljs mel">%.gox: %.go.o $(OBJCOPY) -j .go_export $&lt; $@</code> </pre><br>  And there, in the variable SOURCES between multiboot.o and kernel.go.o add screen.go.o and screen.gox <br><br>  After all the manipulations, we invoke the make command and run qemu with our kernel.  Wait for the download and enjoy <br><br>  PS Please forgive me for typos, if any.  I pledge to fix it. <br>  <s>PPS The other day the code will be posted on github</s> <br>  <a href="https://github.com/t0pep0/Daria/tree/Part0x00">github.com/t0pep0/Daria/tree/Part0x00</a> <br><br>  _____________________________________ <br><br>  Discussion on osdev.ru: <br>  <a href="http://osdev.ru/viewtopic.php%3Ff%3D4%26t%3D1100">http://osdev.ru/viewtopic.php?f=4&amp;t=1100</a> <br>  Chat in slug (in golang-ru): <br>  <a href="https://golang-ru.slack.com/messages/daria/">https://golang-ru.slack.com/messages/daria/</a> </div><p>Source: <a href="https://habr.com/ru/post/259719/">https://habr.com/ru/post/259719/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259683/index.html">Autopilot system for radio-controlled helicopter. Part 2: Takeover</a></li>
<li><a href="../259691/index.html">Battle "Listener vs Visitor" at the stadium antlr4</a></li>
<li><a href="../259701/index.html">Vim in full: Introduction</a></li>
<li><a href="../259709/index.html">Port i2cdevlib on STM32 HAL</a></li>
<li><a href="../259717/index.html">Start using GTKD</a></li>
<li><a href="../259721/index.html">SIP phone from stm32f4-discovery</a></li>
<li><a href="../259723/index.html">How to create Pixel Perfect images in Adobe Illustrator</a></li>
<li><a href="../259725/index.html">Vim in full: Plugin Manager without fatal flaws</a></li>
<li><a href="../259727/index.html">Python and D</a></li>
<li><a href="../259729/index.html">SQL Server 2016 RC0</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>