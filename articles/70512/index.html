<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Ubuntu, KVM and proxy_arp - how to fool an evil provider</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One company located a server for internal use at a kolokeyshnik and immediately bought / 30 addresses for their needs. Configured as aliases (eth0: 0,...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Ubuntu, KVM and proxy_arp - how to fool an evil provider</h1><div class="post__text post__text-html js-mediator-article"> One company located a server for internal use at a kolokeyshnik and immediately bought / 30 addresses for their needs.  Configured as aliases (eth0: 0, eth0: 1, etc.).  Everything worked great, until after some time there was a sensible idea of ‚Äã‚Äãspreading different services to different virtual machines.  Since Ubuntu Server was used as a host, the choice of KVM as a virtualizer happened by itself.  Both here and the rest of the net there are already a lot of clever words written about installing and configuring KVM and the network environment, I will not stop here, I‚Äôll tell you only about the little children‚Äôs rakes conveniently planted by the provider. <a name="habracut"></a><br>  First of all, it should be noted that everything happened on a lively actively used technological machine, where the breaks in the provision of the service were undesirable, because all reconfigurations were done at night with the corresponding brain state;) <br>  So, leaving eth0 intact (so that important production services are not interrupted), extinguish all aliases, create a bridge br0, stick eth0 into it and start virtual machines, just like in all KVM letters written in, tapX into the same bridge. <br>  Voila - IPs are visible, each other's cars are pinging, it's time to open champagne when it turns out that only the host is available from the Internet.  Lowering the subtleties of searching for a problem, I immediately turn to the point - at the provider, where the server was located at the collocation, the switch is configured with port security, i.e.  released out only nailed when installing the MAC.  The provider refused to let in poppies of virtual machines, for which I do not blame him, and this is his right to establish an internal technical policy.  In response to the confused question: ‚ÄúWhat about us?‚Äù Was answered again from the KVM primer: leave aliases on the interface, specify the tenth grid on the virtual machines and then ‚Äúiptables -j DNAT bla-bla-bla‚Äù <br>  Having grieved a little about some clumsiness of such a solution and thoughtfully smoked Google, an alternative variant was found with the keyword proxy_arp. <br>  First of all we do <code>apt-get install uml-utilities</code> <br>  In <code>/etc/network/interfaces</code> register: <br> <code>auto eth0 <br> iface eth0 inet static <br> address 1.2.3.1 <br> netmask 255.255.255.0 <br> network 1.2.3.0 <br> broadcast 1.2.3.255 <br> gateway 1.2.3.254 <br> post-up sysctl -w net.ipv4.ip_forward=1 <br> post-up sysctl -w net.ipv4.conf.eth0.proxy_arp=1 <br> pre-down sysctl -w net.ipv4.ip_forward=0 <br> <br> auto qtap1 <br> iface qtap1 inet manual <br> tunctl_user root <br> uml_proxy_arp 1.2.3.2 <br> uml_proxy_ether eth0 <br> up ip link set qtap1 up <br> down ip link set qtap1 down <br> <br> auto qtap2 <br> iface qtap2 inet manual <br> tunctl_user root <br> uml_proxy_arp 1.2.3.3 <br> uml_proxy_ether eth0 <br> up ip link set qtap2 up <br> down ip link set qtap2 down <br></code> <br>  We start virtual computers: <br><br>  <code>kvm -m 512 -hda image.img -net nic,macaddr=00:01:02:03:04:05 -net tap,ifname=qtap1,macaddr=00:01:02:03:04:05,script=no -daemonize -vnc :1</code> , etc. <br><br>  Further, in virtual machines as gw, we write the address of the host 1.2.3.1 and we get a working bunch of virtual machines, which were hidden from the provider behind the MAC host. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For those who do not yet consider themselves to be a network guru, a few words about proxy_arp and how it differs from the bridge. <br><br>  By default, a regular bridge simply transmits packets from one interface to another unchanged.  It only considers the hardware address of the packet to determine in which direction the packet should be sent.  This means that Linux can forward any kind of traffic, even one that it does not know, if the packets have a hardware address. <br><br>  A pseudo-bridge works somewhat differently and is more like a hidden router than a bridge, but like a bridge it has some influence on the network architecture.  True, this is not exactly a bridge, since the packets actually pass through the core and can be filtered, modified, redirected, or sent along a different route. <br><br>  Another advantage of the pseudo-bridge is that it cannot transmit packets of protocols that ‚Äúdo not understand‚Äù - which prevents the network from being filled with any kind of ‚Äúgarbage‚Äù. <br><br>  In this scheme, when a provider switch wants to establish a connection with a virtual machine located behind the host, it sends the ARP request packet to the host, which, translated into human language, may sound like this: ‚ÄúWho has the address 1.2.3.2 installed?  Report at 1.2.3.254. "  In response to the request, 1.2.3.1 will respond with a short package ‚ÄúI am here!  My hardware address is xx: xx: xx: xx: xx: xx. " <br><br>  When 1.2.3.254 receives a response, it will remember the hardware address 1.2.3.2 and will keep it in the cache for a while. <br><br>  When configuring proxy_arp, we told the eth0 interface to respond to ARP requests.  This will force the router to send packets to the bridge, which will then process them and transfer them to the appropriate virtual machine. <br><br>  Thus, whenever a provider router on one side of the bridge requests the hardware address of a computer on the other side, the bridge responds to the request, as if to say ‚Äúpass everything through me‚Äù, as a result of which all traffic will fall on eth0 and will be transferred to necessary virtualku. <br><br>  <i>In preparing the article, materials from the Linux Advanced Routing &amp; Traffic Control HOWTO were used.</i> </div><p>Source: <a href="https://habr.com/ru/post/70512/">https://habr.com/ru/post/70512/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../70501/index.html">Cairo Desktop Milestone 1</a></li>
<li><a href="../70504/index.html">Meet Gnome 2.28</a></li>
<li><a href="../70508/index.html">We accelerate 1C-Bitrix to the maximum!</a></li>
<li><a href="../70510/index.html">Buy one startup per month</a></li>
<li><a href="../70511/index.html">Interview with Microsoft Patterns & Practices team (mp3)</a></li>
<li><a href="../70514/index.html">The number of Opera Mini users has exceeded 30 million</a></li>
<li><a href="../70515/index.html">Humanity tests</a></li>
<li><a href="../70516/index.html">The smallest post office in the world</a></li>
<li><a href="../70517/index.html">Wii fell to $ 200</a></li>
<li><a href="../70518/index.html">The history of the development of Habr in the video</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>