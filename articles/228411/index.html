<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Django widgets and a couple more tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Everyone knows that Django is a great development framework, with a bunch of powerful batteries. Personally for me, when I first met django, everythin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Django widgets and a couple more tricks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/3bf/3a2/567/3bf3a256702850a7fb4b0217f4b5dbf9.jpg"><br><br>  Everyone knows that Django is a great development framework, with a bunch of powerful batteries.  Personally for me, when I first met django, everything seemed to be extremely convenient - all for the convenience of the developer, I thought.  But those who are forced to work with him for a long time know that not everything is as fabulous as it seems to a beginner.  As time went on, projects became larger, more difficult, writing views became inconvenient, and understanding the relationship between models became more difficult and more difficult.  But work is work, the project was large and complex, and, besides, it was necessary to have a page management system like in cms, and, it seems, there is a wonderful django cms, to which all you need is to write plug-ins.  But it turned out that the whole process can be made somewhat more convenient by adding a couple of features and some code. <a name="habracut"></a><br><br>  In this small article, you will not see ready-made recipes, the purpose of the article is to share your ideas.  The code examples serve only to help in explaining the key elements; without significant improvements, this will not be enough to repeat the functionality.  But if the topic turns out to be interesting, it can be continued in the next article.  Or even put in open source. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Models </h4><br>  Suppose we have 2 models with common fields: title, description, and tags.  If we just need to print the latest materials from both models sorted by date of creation, then the easiest way is to combine them into one model.  And in order that they do not merge into one entity in the admin area, we can use the <a href="https://docs.djangoproject.com/en/dev/ref/contrib/contenttypes/">Generic Foreign Key</a> . <br>  For the admin, set up inline editing Info and immediately add a <a href="https://djangosnippets.org/snippets/1773/">GFKManager</a> snippet for optimizing queries: <br><br><pre><code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> models <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> core.container.manager <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> GFKManager <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Info</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> objects = GFKManager() title = models.CharField( max_length=<span class="hljs-number"><span class="hljs-number">256</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> ) header = models.TextField( max_length=<span class="hljs-number"><span class="hljs-number">500</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> ) tags = models.ManyToManyField( <span class="hljs-string"><span class="hljs-string">'self'</span></span>, symmetrical=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">content_type_name</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.content_type.model_class()._meta.verbose_name <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Model</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> info = CustomGenericRelation( <span class="hljs-string"><span class="hljs-string">'Info'</span></span>, related_name=<span class="hljs-string"><span class="hljs-string">"%(class)s_info"</span></span> ) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">A</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Model)</span></span></span><span class="hljs-class">:</span></span> field = models.CharField( max_length=<span class="hljs-number"><span class="hljs-number">256</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span> ) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Model)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">pass</span></span></code> </pre> <br><br>  Note that you may get an error when deleting objects of models A and B if you use generic.GenericRelation.  Unfortunately I can not find the source: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- from django.contrib.contenttypes import generic from django.db.models.related import RelatedObject from south.modelsinspector import add_introspection_rules class CustomGenericRelation(generic.GenericRelation): def contribute_to_related_class(self, cls, related): super(CustomGenericRelation, self).contribute_to_related_class(cls, related) if self.rel.related_name and not hasattr(self.model, self.rel.related_name): rel_obj = RelatedObject(cls, self.model, self.rel.related_name) setattr(cls, self.rel.related_name, rel_obj) add_introspection_rules([ ( [CustomGenericRelation], [], {}, ), ], ["^core\.ext\.fields\.generic\.CustomGenericRelation"])</span></span></code> </pre><br><br>  Now you can easily execute the query: <br><pre> <code class="python hljs">Info.objects.filter(content_type__in=(CT.models.A, CT.models.B))</code> </pre><br><br>  For convenience, I use the ContentType map: <br><pre> <code class="python hljs">rom django.contrib.contenttypes.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ContentType <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.db <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> models <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Model <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Inner</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getattr(self.name) <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ContentTypeMap</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(object)</span></span></span><span class="hljs-class">:</span></span> __raw__ = {} <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, obj, addr)</span></span></span><span class="hljs-function">:</span></span> path = addr.pop(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> hasattr(obj, path): setattr(obj, path, type(path, (object,), {<span class="hljs-string"><span class="hljs-string">'parent'</span></span>: obj})) attr = getattr(obj, path) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.__get__(attr, addr) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> addr <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> attr <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> model <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> X: issubclass(X, Model), models.get_models()): content_type = ContentType.objects.get_for_model(model) obj = self.__get__(self, model.__module__.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)) self.__raw__[content_type.model] = content_type.id setattr(obj, <span class="hljs-string"><span class="hljs-string">'%s'</span></span> % model.__name__, content_type) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> obj <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> X: self.__get__(self, X.__module__.split(<span class="hljs-string"><span class="hljs-string">'.'</span></span>)), filter(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> X: issubclass(X, Model), models.get_models())): setattr(obj.parent, obj.__name__, obj()) CT = ContentTypeMap()</code> </pre><br><br>  If we need to organize a search (sphinx) then we can connect django-sphinx to Info.  Now, in one request, we can get the tape, search, selection by tags and so on.  The disadvantage of this approach is that all fields for which it is necessary to filter queries should be stored in Info, and in the models themselves only those fields for which the filter is not needed, for example, pictures. <br><br><h4>  Django CMS, plugins and widgets </h4><br>  With the help of CMS, we can add new pages, edit and delete old ones, add widgets to the page, form sidebars and so on.  But sometimes, more precisely, quite often there is a need to permanently add a plugin to a template so that it is visible on all pages.  <a href="https://github.com/smyrman/django-jquery-widgets">django widgets</a> is a solution to our problems, with the help of the include_widget tag we will be able to add everything we need and where we need it.  Even more often, it is necessary to get some data in a plugin with ajax.  Use <a href="https://django-tastypie.readthedocs.org/en/latest/">tastypie</a> . <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf.urls.defaults <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.http <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> HttpResponseForbidden <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django_widgets.loading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> registry <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> sekizai.context <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> SekizaiContext <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tastypie.resources <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Resource <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tastypie.utils <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> trailing_slash <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> tastypie.serializers <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Serializer <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> core.widgets.cms_plugins <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> PLUGIN_TEMPLATE_MAP <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> core.ext.decorator <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> api_require_request_parameters <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HtmlSreializer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Serializer)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">to_html</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, data, options=None)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">WidgetResource</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Resource)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Meta</span></span></span><span class="hljs-class">:</span></span> resource_name = <span class="hljs-string"><span class="hljs-string">'widget'</span></span> include_resource_uri = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> serializer = HtmlSreializer(formats=[<span class="hljs-string"><span class="hljs-string">'html'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">prepend_urls</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ url(<span class="hljs-string"><span class="hljs-string">r"^(?P&lt;resource_name&gt;%s)/render%s$"</span></span> % (self._meta.resource_name, trailing_slash()), self.wrap_view(<span class="hljs-string"><span class="hljs-string">'render'</span></span>), name=<span class="hljs-string"><span class="hljs-string">"api_render"</span></span>) ] @api_require_request_parameters([<span class="hljs-string"><span class="hljs-string">'template'</span></span>]) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">render</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, request, **kwargs)</span></span></span><span class="hljs-function">:</span></span> data = dict(request.GET) template = data.pop(<span class="hljs-string"><span class="hljs-string">'template'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'widget'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> data: widget = registry.get(data.pop(<span class="hljs-string"><span class="hljs-string">'widget'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> template <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> PLUGIN_TEMPLATE_MAP: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HttpResponseForbidden() widget = PLUGIN_TEMPLATE_MAP[template] data = dict(map(<span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span> (K, V): (K.rstrip(<span class="hljs-string"><span class="hljs-string">'[]'</span></span>), V) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> K.endswith(<span class="hljs-string"><span class="hljs-string">'[]'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> (K.rstrip(<span class="hljs-string"><span class="hljs-string">'[]'</span></span>), V[<span class="hljs-number"><span class="hljs-number">0</span></span>]), data.items())) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.create_response( request, widget.render(SekizaiContext({<span class="hljs-string"><span class="hljs-string">'request'</span></span>: request}), template, data, relative_template_path=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>) ) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">obj_get_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, bundle, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> []</code> </pre><br>  By passing the parameters of the widget name and template in the request, we can get a rendered context.  Here I use the variable PLUGIN_TEMPLATE_MAP so that I can only transmit the name of the template. <br><br>  It remains to link widgets and plugins.  There is quite a big piece, but the most important one. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> forms <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django.conf <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> settings <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> django_widgets.loading <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> registry <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cms.models <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CMSPlugin <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cms.plugin_base <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CMSPluginBase <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cms.plugin_pool <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> plugin_pool <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> core.widgets.widgets <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> ItemWidget PLUGIN_MAP = {} PLUGIN_CT_MAP = {} PLUGIN_TEMPLATE_MAP = {} <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PluginWrapper</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(CMSPluginBase)</span></span></span><span class="hljs-class">:</span></span> admin_preview = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FormWrapper</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(forms.ModelForm)</span></span></span><span class="hljs-class">:</span></span> widget = <span class="hljs-keyword"><span class="hljs-keyword">None</span></span> templates_available = () <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> super(FormWrapper, self).__init__(*args, **kwargs) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> self.fields[<span class="hljs-string"><span class="hljs-string">'template'</span></span>].initial: <span class="hljs-comment"><span class="hljs-comment"># TODO self.fields['template'].initial = self.widget.default_template self.fields['template'].help_text = 'at PROJECT_ROOT/templates/%s' % self.widget.get_template_folder() if self.templates_available: self.fields['template'].widget = forms.Select() self.fields['template'].widget.choices = self.templates_available self.__extra_fields__ = set(self.fields.keys()) - set(self._meta.model._meta.get_all_field_names()) data = json.loads(self.instance.data or '{}') if self.instance else {} for key, value in data.items(): self.fields[key].initial = value def clean(self): cleaned_data = super(FormWrapper, self).clean() cleaned_data['data'] = json.dumps(dict( map( lambda K: (K, cleaned_data[K]), filter( lambda K: K in cleaned_data, self.__extra_fields__ ) ) )) return cleaned_data class Meta: model = CMSPlugin widgets = { 'data': forms.HiddenInput() } def get_templates_available(widget): template_folder = widget.get_template_folder() real_folder = os.path.join(settings.TEMPLATE_DIRS[0], *template_folder.split('/')) result = () if os.path.exists(real_folder): for path, dirs, files in os.walk(real_folder): if path == real_folder: choices = filter(lambda filename: filename.endswith('html'), files) result = zip(choices, choices) rel_folder = '%(template_folder)s%(inner_path)s' % { 'template_folder': template_folder, 'inner_path': path.replace(real_folder, '') } for filename in files: PLUGIN_TEMPLATE_MAP['/'.join((rel_folder, filename))] = widget return result def register_plugin(widget, plugin): plugin_pool.register_plugin(plugin) PLUGIN_MAP[widget.__class__] = plugin if issubclass(widget.__class__, ItemWidget): for content_type in widget.__class__.content_types: if content_type not in PLUGIN_CT_MAP: PLUGIN_CT_MAP[content_type] = [] PLUGIN_CT_MAP[content_type].append(plugin) def get_plugin_form(widget, widget_name): return type('FormFor%s' % widget_name, (FormWrapper,), dict(map( lambda (key, options): (key, (options.pop('field') if 'field' in options else forms.CharField)(initial=getattr(widget, key, None), **options)), getattr(widget, 'kwargs', {}).items() ) + [('widget', widget), ('templates_available', get_templates_available(widget))])) def register_plugins(widgets): for widget_name, widget in widgets: if getattr(widget, 'registered', False): continue name = 'PluginFor%s' % widget_name plugin = type( name, (PluginWrapper,), { 'name': getattr(widget, 'name', widget_name), 'widget': widget, 'form': get_plugin_form(widget, widget_name) } ) register_plugin(widget, plugin) register_plugins(registry.widgets.items())</span></span></code> </pre><br><br><h4>  Some more tasty batteries </h4><br><ul><li>  <a href="http://django-sekizai.readthedocs.org/en/latest/">django-sekizai</a> - django cms dependency, but, of course, can be used without it </li><li>  <a href="https://readthedocs.org/projects/django-localeurl/">django-localeurl</a> - handy pieces for an international site </li><li>  <a href="https://github.com/deschler/django-modeltranslation">django-modeltranslation</a> - as an option, but there are equally tasty alternatives </li><li>  <a href="https://github.com/sebleier/django-redis-cache">django-redis-cache</a> - cache in radish, you can also shove sessions there, especially if you haven‚Äôt been cleaning MySQL sessions for years </li><li>  <a href="https://github.com/django-admin-bootstrapped/django-admin-bootstrapped">django-admin-bootstrapped</a> - more modern admin panel (you need to install bootstrap-modeltranslation if you use modeltranslation) </li><li>  <a href="https://github.com/NElias/django-sorl-cropping">django-sorl-cropping</a> - for working with thumbnail </li></ul><br><br>  Well, quite banal things: <br><ul><li>  <a href="https://github.com/omab/django-social-auth">django-social-auth</a> </li><li>  <a href="http://django-registration.readthedocs.org/en/latest/">django-registration</a> </li><li>  <a href="http://django-debug-toolbar.readthedocs.org/en/1.2/">django-debug-toolbar</a> </li><li>  <a href="https://bitbucket.org/izi/django-admin-tools/wiki/Home">django-admin-tools</a> </li></ul><br><br><h4>  Conclusion </h4><br>  I tried to explain two key points that can be simplified in working with django, I wanted to explain more, but the article is too voluminous.  Other interesting points are the processing and the formation of dynamic URLs, as well as the two main widgets - the ribbon widget and the entity widget, but this is next time.  So with this concept, I <br><ul><li>  I create new models and add them to the tape in a couple of minutes (when there are about 50 such tapes on a project it matters); </li><li>  I never write views, I customize widgets, occasionally I write new ones; </li><li>  I do not create new templates for url, django cms does it for me; </li><li>  I'm not worried with ajax, I just pass the parameters, and get the result; </li><li>  made life easier for himself, on three projects among which one is very big; </li><li>  I spend a lot more time on js than on django, but that's another story. </li></ul><br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/228411/">https://habr.com/ru/post/228411/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../228395/index.html">UNET - new network technology in Unity 3D</a></li>
<li><a href="../228397/index.html">Brave Octopus Adventure - the brave octopus is ready to conquer your Android smartphones</a></li>
<li><a href="../228401/index.html">Gaming Conferences: DevGamm, White Nights and Health Industry</a></li>
<li><a href="../228405/index.html">Receive notifications from Zabbix in WhatsApp</a></li>
<li><a href="../228409/index.html">Values ‚Äã‚Äãof using email for small and medium businesses</a></li>
<li><a href="../228413/index.html">Return Mail is a simple way to increase the number of customers by more than 13%.</a></li>
<li><a href="../228415/index.html">Transoceanic Submarine Communication Cables</a></li>
<li><a href="../228417/index.html">Published a single rating of seo-companies in 2014</a></li>
<li><a href="../228419/index.html">Features of using Sails for beginners (Part 2)</a></li>
<li><a href="../228421/index.html">Dynamic magnetic stripe as the main element of an electronic card</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>