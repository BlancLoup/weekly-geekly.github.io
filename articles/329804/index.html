<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Git: many useful and different hooks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is a free translation of this material . Fans of long and abstruse original sources can immediately read the original. 

 When we are give...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Git: many useful and different hooks</h1><div class="post__text post__text-html js-mediator-article">  The article is a free translation of <a href="http://krisjordan.com/essays/setting-up-push-to-deploy-with-git">this material</a> .  Fans of long and abstruse original sources can immediately read the original. <br><br>  When we are given the task of changing the codebase, for example, in the Github repository, to rebuild / restart an application on some of our environments, the first thing that comes to mind as a possible trigger for such a reassembly is the mechanism provided by the same github Web Hooks: when an event occurs with our remote repository (since the appearance of a new commit in some of its tracked branches), the githab uses the corresponding web hook and ‚Äúpulls‚Äù the service specified in its settings, which  Start the process of rebuilding / restart of the application.  This is a standard, widely used and simple mechanism for such cases, everyone is doing it, and so on ... <br><br>  But what if our application lives on a host that, for some reason, is not supposed to be accessed by a githaba?  For example, is the host on a closed network or behind a NAT and unavailable from the Internet? <br><a name="habracut"></a><br>  In this case, you can use the mechanism of local hooks of Git itself, about which (the mechanism), as it turns out, very few people know even those who have been using Git for quite some time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When we create a local repository (we initialize an empty one, we clone a remote one, ...), then in the .git folder, which is in its root, or at the very root, if it is a bare-repository, the hooks folder is present.  After the repository is initialized, the hook templates for various events are saved in this folder, such as, for example: post-merge, post-receive, post-update, etc. <br><br>  A full description of supported events for hooks can be found, for example, <a href="http://git-scm.com/book/ru/v1/%25D0%259D%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-Git-%25D0%259F%25D0%25B5%25D1%2580%25D0%25B5%25D1%2585%25D0%25B2%25D0%25B0%25D1%2582%25D1%2587%25D0%25B8%25D0%25BA%25D0%25B8-%25D0%25B2-Git">here</a> . <br><br>  We will use this mechanism and implement a simple push-to-deploy scheme for our hapless application. <br><br>  We need two local repositories.  Create them, for example, along the specified paths: <br><br>  1. / opt / repo-dev / example-repo / <br>  2. /opt/repo-remote.git/ <br><br>  The first repository is a clone of our example-repo remote repository on the github. <br>  The second is the bare repository, a copy of the first, which will serve us exclusively to handle the post-update event when updates appear in the remote repository.  So, how do we realize this? <br><br>  The scheme is very simple (suppose we are tracking the test branch, and our application is the node.js, managed by the manager pm2): <br><br>  1. Periodically update the first local repository to a state that fully corresponds to the state of the remote repository. <br>  2. Update the second from the first local repository. <br>  3. As soon as HEAD has moved - a new commit has appeared - the post-update hook will be activated in the second repository, which is performed when any changes appear in the repository, and which will perform the necessary actions to rebuild and restart the application. <br><br>  To do this, we do the following: <br><br>  1. In the first local repository add remote - the second local repository: <br><br><pre><code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /opt/repo-dev/example-repo/ &amp;&amp; git remote add prod /opt/repo-remote.git</code> </pre> <br>  Now we can execute git push from the first local repository to the second. <br><br>  2. In the /opt/repo-remote.git/hooks/ folder, create a post-update file and make it executable: <br><br><pre> <code class="bash hljs">touch /opt/repo-remote.git/hooks/post-update &amp;&amp; chmod +x /opt/repo-remote.git/hooks/post-update</code> </pre> <br>  This is a regular shell script, but according to the internal Git convention <i>without the .sh extension</i> ! <br>  Let's add some commands to it: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash cd /opt/repo-remote.git /usr/bin/git --work-tree=/opt/repo/example-repo/ checkout -f origin/test cd /opt/repo/example-repo/ /usr/bin/npm install /usr/local/bin/pm2 restart all</span></span></code> </pre><br>  What does the script do?  At first, it simply unloads the working tree of our bare repository into the folder with our running application, and then recompiles the dependencies and restarts the pm2 services.  As you can see, no magic. <br><br>  3. Configure cron, which will update the first repository from the remote repository every n minutes: <br><br><pre> <code class="bash hljs">git fetch origin &amp;&amp; git reset --hard -f origin/<span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br>  So  Now our host will be the regular initiator of checking the remote repository - but have there been any updates? <br><br>  Please note that we are updating the local repository not by git pull, but by git reset --hard.  This is done in order to eliminate the need for merdzhey with a certain content of the next commit - we make the local repository a complete copy of the remote. <br><br>  4. Immediately after synchronizing the first local repository with the remote one, we push all changes to our pseudo-remote second local repository: <br><br><pre> <code class="bash hljs">git push prod <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br>  That's all.  As soon as our pseudo-remote local repository receives non-zero changes, Git pulls its post-update hook, which executes the corresponding script.  And we get a simple push-to-deploy workflow, which, if desired, can be further improved according to our needs. <br><br>  ‚ÄúWhy make such an indigestible monstrous scheme ?!‚Äù - you ask.  I first asked the same question, but it turned out that with the existing list of Git hooks, it is only in this way that we can call up the necessary processing whenever we update our branch in the remote repository.  The post-update hook we need is designed to run on the remote repository (and some of the hooks are intended to run on the local repository).  And we are such a not very elegant way, this pseudo-remote repository and emulated.  Perhaps some other convenient hook running locally will appear soon, and the scheme can be simplified.  But so far. <br><br>  In conclusion, I want to give some advice to those who decide to implement it and, faced with the problems of a non-working hook or some parts of it, will furiously curse me, Git, the author of the original article and everyone else on the list: <br><br>  1. Remember about the specifics of cron work - the programs in it, by default, are not run in the environment that you probably expect. <br>  2. Check the versions of your utilities (npm, node etc) when calling them from scripts and using cron - they may not be the same as during manual start due to the difference in the paths to executable files in environment variables, for example.  And the launch of their other versions can lead to unpredictable results. <br>  3. Spend 20 minutes watching the next Simpsons series and return to experimenting with new powers and good mood. <br><br>  I will welcome any comments and clarifications on the merits. <br><br>  Have a nice day! </div><p>Source: <a href="https://habr.com/ru/post/329804/">https://habr.com/ru/post/329804/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../329788/index.html">HexRaysPyTools: decompile with pleasure</a></li>
<li><a href="../329792/index.html">SCCM Inventory</a></li>
<li><a href="../329794/index.html">Once again about storing logs in Zabbix</a></li>
<li><a href="../329796/index.html">Many pointless conversations</a></li>
<li><a href="../329798/index.html">Constructor</a></li>
<li><a href="../329806/index.html">Co-marketing as a way to monetize mobile applications</a></li>
<li><a href="../329808/index.html">Porting MIPSfpga to other cards and integrating peripherals into the system. Part 1</a></li>
<li><a href="../329810/index.html">Organization of events - a niche for IT solutions</a></li>
<li><a href="../329812/index.html">Comparison of contextual advertising automation services (part 2)</a></li>
<li><a href="../329814/index.html">SQL101: Why restoring from a backup is slower than creating it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>