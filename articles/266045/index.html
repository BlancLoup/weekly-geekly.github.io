<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mobile application design patterns. Command processor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúWrite the code as if it would be accompanied by a violent psychopath who knows where you live.‚Äù 
 Martin golding 

 When developing one of the projec...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mobile application design patterns. Command processor</h1><div class="post__text post__text-html js-mediator-article">  <i>‚ÄúWrite the code as if it would be accompanied by a violent psychopath who knows where you live.‚Äù</i> <br>  Martin golding <br><br>  When developing one of the projects using GooglePlacesAPI, I had a problem organizing network interaction between my Android ‚Äì application and server API.  Intuition and ‚Äúnoodles‚Äù from AsyncTask'ov suggested that there should be other ways of organizing this kind of interaction.  So I came across the CommandProcessor design pattern.  I want to tell you about the use of this design pattern in Android applications. <br><a name="habracut"></a><br>  To begin with, I will describe the task that needed to be solved.  It was required to write an application using the Google Places API, showing previews of any place on the map that the user chose, and then, if the user wants to get more information (for example, view more pictures), then upload pictures by the specified Id of the selected place, and show all the pictures already related to the selected location.  The most obvious way for me at that time was to use AsyncTask.  But after some attempts, it became clear that there must be other, more convenient ways.  Using AsyncTask's was awkward because: <br><br>  <b>1)</b> To get a preview of a place, you had to first make a request to get information about all the places that were near the place chosen by the user. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>2)</b> According to the received Id, form and send a request for receiving a photo preview. <br><br>  <b>3)</b> When clicking on the preview, get all the pictures related to this place. <br><br>  Thus, using AsyncTask, a kind of "waterfall" was obtained and one would have to use AsyncTask inside another.  And then, googling, I found information about the Command Processor pattern, which does an excellent job with the tasks described above. <br><br>  The CommandProcessor design pattern separates requests to the service from their execution.  The main component of the pattern is the CommandProcessor, which manages requests, schedules their execution, and also provides an additional service, for example, storing requests for late execution or cancellation of a request.  The diagram borrowed from [1] shows the relationship between the components of the pattern: <br><br><img src="https://habrastorage.org/files/49a/d96/295/49ad962952e448bd9b4ae14a3c663703.jpg"><br><br><h2>  The scope of the pattern </h2><br><ul><li>  Programs in which the user interacts with the system through a graphical interface.  For example: text editors, office applications.  Commands (hereinafter, commands are the same as requests) are used to perform a task after the user has pressed the mouse button, hot key, menu button, etc.  Commands are objects that are passed to the processor for execution. </li><li>  Distributed or Parallel systems.  Using this pattern, you can send commands for execution in a separate thread.  Create a queue of commands, etc. </li><li>  Applications that interact with the network. </li></ul><br><h2>  Implementation </h2><br>  Now, we will consider how this pattern can be applied in the development of mobile applications, and specifically, Android ‚Äì applications.  There are a lot of ways to implement it; you can use the IntentService or HaMeR framework (Handler, Messages, Runnable). Let's look at how I implemented this pattern in a test application.  So, the test application shows routes and a list of places that are contained in a particular route.  Accordingly, we have two types of requests (commands): TracksRequest and PlacesRequest.  Both classes are inheritors of the CommonRequest base class in order to be processed by our processor (CommandProcessor). <br><br><pre><code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  CommonRequest   public abstract class CommonRequest { public abstract void sendRequest(int i); public int requestId; }</span></span></code> </pre> <br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  PlaceRequest public class PlacesRequest extends CommonRequest{ private MessageController handler_; public PlacesRequest(MessageController handler){ this.handler_ = handler; } public void sendRequest(int id){ sendAsyncPlaceRequest(id); } }</span></span></code> </pre><br><pre> <code class="java hljs"><span class="hljs-comment"><span class="hljs-comment">//  TracksRequest public class TracksRequest extends CommonRequest { private MessageController handler_; public TracksRequest(MessageController handler) { this.handler_ = handler; } public void sendRequest(int id) { sendAsyncTracksRequest(); } }</span></span></code> </pre><br>  In the sendAsyncPlaceRequest method, all the work happens: it can be creating a URL for a request to an API, creating a new Thread, parsing a response and sending the result of the work to the controller using a Handler. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendAsyncPlaceRequest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span></span>{ Thread background = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Thread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String response = sendRequest(getUrl(id)); List&lt;Place&gt; places = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList&lt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { places = getPlacesFromJson(response); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (JSONException e) { Log.e(<span class="hljs-string"><span class="hljs-string">"JSONException"</span></span>, e.getMessage()); } handler_.sendMessage(handler_.obtainMessage(States.PLACES_WERE_FOUND,places)); } }); background.start(); }</code> </pre><br>  Next, you need to implement the CommandProcessor class, which will manage our requests and execute them: <br><pre> <code class="java hljs">publicclassRequestProcessor { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> UpdateCallbackListener clientActivity_; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestProcessor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UpdateCallbackListener clienActivity)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.clientActivity_ = clienActivity; } <span class="hljs-comment"><span class="hljs-comment">//         public void execute(CommonRequest request, int id) { request.sendRequest(id); } public void updateActivity(List&lt;? extends Result&gt; results) { clientActivity_.onUpdate(results); } }</span></span></code> </pre><br>  Now we need a controller that, depending on the state, will send various commands to the processor.  The result of the request is sent from the stream using Handler: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MessageController</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Handler</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> MessageController instance = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> RequestProcessor processor_; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(UpdateCallbackListener listener)</span></span></span><span class="hljs-function"> </span></span>{ processor_ = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestProcessor(listener); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> MessageController </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getInstance</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (instance == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ instance = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MessageController(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> instance; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handleMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Message msg)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (msg.what) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> States.INIT_REQUEST: CommonRequest request = (CommonRequest)msg.obj; processor_.execute(request); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> States.REQUEST_COMPLETED: List&lt;Result&gt; results = (List&lt;Result&gt;)msg.obj; processor_.updateActivity(results); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br>  In order to now return the result of the work to the activation, and call some updateUI () to update the user interface (ListView filling, drawing markers on the map, etc.) you need to define the UpdateCallbackListener interface: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UpdateCallbackListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;? extends Result&gt; results)</span></span></span></span>; }</code> </pre><br>  And implement it in our activism: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onUpdate</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(List&lt;? extends Result&gt; results)</span></span></span></span>{ tracks_ = (List&lt;Track&gt;) results; TrackAdapter trackAdapter = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TrackAdapter(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>,tracks_); listView_.setAdapter(trackAdapter); }</code> </pre><br>  After the result returns in response to the request (for example, a request to get all the places along this route), we need to update the assets and transfer the Place objects to the adapter.  We can do this through the processor_.updateActivity (places) method, which will call onUpdate () in the activity that implemented this method.  The following diagram, also taken from [1], shows the pattern dynamics: <br><br><img src="https://habrastorage.org/files/087/f6b/6e5/087f6b6e57304707a2f5546030a1093e.png"><br><br>  To initiate a request, we need to create a TracksRequest object in the activation and transfer it to the controller: <br><br><pre> <code class="java hljs"> controller_ = MessageController.getInstance(); controller_.init(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>); TracksRequest tracksRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TracksRequest(controller_); controller_.sendMessage(controller_.obtainMessage(States.INIT_REQUEST,tracksRequest));</code> </pre><br><h2>  Implementing with the IntentService </h2><br>  Using the IntentService also perfectly allows you to implement this pattern.  Consider the chart: <br><br><img src="https://habrastorage.org/files/492/0b0/d65/4920b0d653b942c78fe4017c6243bf7f.png"><br><br>  As a command object, you can use an Intent and transfer it to our processor.  Creator is our activity, which creates a command object and passes this object to the executor, that is, to the IntentService in our case.  Thus, the role of the CommandProcessor is performed by the CustomIntentService class, namely the onHandleIntent () method which, depending on the data contained in the Intent, can perform various operations.  To return the result to the activation, in this case you can use the BroadcastReceiver. <br><br><h2>  Step-by-step instruction </h2><br>  So, to summarize, to implement this pattern, you must do the following: <br><br><ul><li>  Define the abstract command interface.  The interface encapsulates the implementation of each individual command.  In our case, it was the sendRequest method (int i) which each of the commands (requests) implemented differently. </li><li>  Determine the way the team returns the result to the one who called it.  As shown for this, we defined the UpdateCallbackListener interface, with an onUpdate () method for each of the activations. </li><li>  Implement each of the teams.  We had two kinds of requests - one for getting information about routes (TracksRequest), the second for getting information about places (PlacesRequest). </li><li>  Implement a controller that will send commands.  Creating and sending commands can be implemented using Abstract Factory or Prototype.  However, it is not necessary for the controller to be the creator of the commands.  As you can see from the example, request objects were created in activti. </li><li>  Implement a class of processor that will accept the command and process.  For each request, the RequestProcessor class executes the execute () method. </li></ul><br><br><h2>  The advantages and disadvantages of the pattern. </h2><br>  <b>Advantages:</b> <br><br><ul><li>  In applications such as a text editor, different interface elements can use the same commands.  For example, a button in the ‚ÄúCreate‚Äù menu, and a button with the same name in the context menu can refer to the same command. </li><li>  Ability to send asynchronous requests, control the order of calls, depending on the result of the request. </li><li>  Flexibility when adding a new functionality in the form of a new command (request), without violating the existing functionality.  Changing or adding a new command will not affect the command handler. </li><li>  Different clients (in our case, activites) can use the same commands.  For example, a request to download an image by Id, can be used for different activations. </li></ul><br>  <b>Disadvantages:</b> <br><br><ul><li>  Additionally, you need to track each state and handle it appropriately. </li><li>  The number of teams can be very large </li><li>  Two-way communication.  After the activation has initiated the creation of the request, and the response has been received, the result must be returned to the activation. </li></ul><br><br><h2>  Conclusion </h2><br>  Most likely, you have already seen the implementation of the pattern in one form or another.  But since the theme of the architecture of mobile applications is quite relevant, I hope the article was useful.  In the future, we plan to consider several more patterns used in the development of mobile applications.  Write questions in the comments, see you soon. <br><br><h2>  List of sources </h2><br>  [1] PATTERN-ORIENTED SOFTWARE ARCHITECTURE VOLUME 1. Douglas Schmidt, Michael Stal, Hans Rohnert, Frank Buschmann <br>  [2] Command Revisited <a href="https://www.dre.vanderbilt.edu/~schmidt/PDF/CommandRevisited.pdf">www.dre.vanderbilt.edu/~schmidt/PDF/CommandRevisited.pdf</a> <br>  Test project on github: <a href="https://github.com/GregaryMaster/CommandProcessor">github.com/GregaryMaster/CommandProcessor</a> </div><p>Source: <a href="https://habr.com/ru/post/266045/">https://habr.com/ru/post/266045/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266035/index.html">The course "Basics of effective work with Wolfram technologies". Session 1: Wolfram Mathematica and Wolfram Cloud Review</a></li>
<li><a href="../266037/index.html">Ruby Go shared library connections</a></li>
<li><a href="../266039/index.html">Underground carders market. Translation of the book "KingPIN". Chapter 12. ‚ÄúFree Amex!‚Äù</a></li>
<li><a href="../266041/index.html">How to estimate the depth of the game mechanics. Part one</a></li>
<li><a href="../266043/index.html">The ability to restore physical machines from backups using Veeam Endpoint Backup FREE</a></li>
<li><a href="../266047/index.html">Private mode and list of entered addresses in the new build Vivaldi 1.0.264.3</a></li>
<li><a href="../266051/index.html">RailsClub 2015: Interview with Timofey Tsvetkov</a></li>
<li><a href="../266053/index.html">How to become a partner Host-Tracker</a></li>
<li><a href="../266055/index.html">Techniques for using mask registers in the AVX512 code</a></li>
<li><a href="../266059/index.html">First look at Scaleway</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>