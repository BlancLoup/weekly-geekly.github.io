<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hierarchical (recursive) queries</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="To understand recursion, you first need to understand recursion. Perhaps that is why recursive queries are used so rarely. Surely you imagine what a S...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hierarchical (recursive) queries</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/cfc/f33/772/cfcf3377290c3d48c7dec466e7f57c63.png" alt="Object Tree"><br><br>  To understand recursion, you first need to understand recursion.  Perhaps that is why recursive queries are used so rarely.  Surely you imagine what a SQL query is, I will tell you how recursive queries differ from ordinary ones.  Subject turned voluminous, get ready for a long reading.  Basically it will be about Oracle, but other DBMS are mentioned. <br><br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  The essence of the problem </h4><br><br>  Most modern DBMSs (Database Management System) are relational, i.e.  present data in the form of a two-dimensional table, in which there are rows (records) and columns (fields of records).  But in practice, we often encounter a different data organization, namely hierarchical. <br><br>  Take a look at the list of files on your computer: they are all organized in a tree.  Similarly, you can submit books in the library: Library-&gt; Hall-&gt; Wardrobe-&gt; Shelf-&gt; Book.  The same and articles on the site: Site-&gt; Section-&gt; Subsection-&gt; Article.  Examples can be given for a long time.  However, it is still possible to divide everything into separate tables: a table for storing the list of libraries, another table for the list of halls, a third for cabinets, etc.  But if the nesting depth is not known in advance, or this nesting can change, then you can‚Äôt get rid of the hierarchy. <br><br>  The problem is that data that has a hierarchical structure is very poorly represented in the relational model.  The SQL-92 standard does not have the means to process them. <br><br>  But such tools appeared in the standard SQL-1999.  True, by that time Oracle already had its own CONNECT BY operator.  Despite this, in SQL-1999 the syntax of recursive queries is completely different from the syntax CONNECT BY in Oracle and uses the keyword WITH.  The implementation of recursive queries in other DBMSs was somewhat delayed, as it appeared in MS SQL Server only in version 2005. <br><br>  Just as in the syntax, there are differences in terminology.  In Oracle, queries that are commonly discussed are called ‚Äúhierarchical,‚Äù while for others, ‚Äúrecursive‚Äù.  The essence of this does not change, I will use both. <br><br><h4>  From words to deeds! </h4><br><br>  For the demonstration we will use the directory structure, we will need a test table consisting of 3 fields: <br>  <b>id</b> - id <br>  <b>pid</b> is the parent ID (refers to the id of another entry in the same table), <br>  <b>title</b> - the name of the directory (instead, it can be anything, even a few fields or links to other tables). <br><br><blockquote><code><font color="black"><font color="#0000ff">create</font> <font color="#0000ff">table</font> test_table (<br>
&nbsp;&nbsp;id <font color="#0000ff">int</font>,<br>
&nbsp;&nbsp;pid <font color="#0000ff">int</font>,<br>
&nbsp;&nbsp;title <font color="#0000ff">varchar</font>(256)<br>
);</font></code></blockquote><br>
<br>
    mySQL,      . ,  Oracle    :  int ‚Äî number,   varchar ‚Äî varchar2.<br>
<br>
      .    ,        .  ,      ,  ,  ,  . <br>
<br>
<blockquote><code><font color="black">insert into test_table values (1, <font color="#0000ff">null</font>, <font color="#A31515">''</font>);</font></code></blockquote><br>
<br>
,      .     ,     .     -,   SELECT * FROM test_table    :<br>
<br>
<pre>  ID        PID TITLE
---- ---------- --------------------
   1            
   2          1 
   3          2  "  "
   4          1 
   5          1 
   6          3  
   7          3  1
   8          3  2
   9          8  1
  10          5 
</pre><br>
<br>
  .   .<br>
<br>
<h4>mySQL</h4><br>
<br>
   mySQL ‚Äì            ,   php (   ,    ,  <a href="http://www.codenet.ru/webmast/php/tree.php"></a>,     ‚ÄúmySQL tree‚Äù  ..). <br>
<br>
,  <a href="http://dev.e-taller.net/dbtree/"> </a>,          ,   .     ,   .<br>
<br>
-         php.     mySQL.     ,        ,       ( ).             ,      AJAX.      pid  ,     . ,    ,      .<br>
<br>
<h4>SQL-1999</h4><br>
<br>
     SQL-92,       ,        .   :-),     (LOB),   SIMILAR  DISTINCT,   ,    ,   .      ,      .<br>
<br>
      ,    <strong>WITH</strong>.        .      :<br>
<br>
<pre>WITH [recursive] __ [ ( ) ]
AS () 
 
</pre><br>
<br>
 MS SQL    <strong>RECURSIVE</strong>,   .       .     DB2, Sybase iAnywhere, MS SQL,    2005,     ,    SQL 1999.<br>
<br>
       :<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">WITH</font> <font color="#0000ff">RECURSIVE</font><br>
&nbsp;Rec (id, pid, title)<br>
&nbsp;<font color="#0000ff">AS</font> (<br>
&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font> id, pid, title <font color="#0000ff">FROM</font> test_table<br>
&nbsp;&nbsp;&nbsp;<font color="#0000ff">UNION</font> <font color="#0000ff">ALL</font><br>
&nbsp;&nbsp;&nbsp;<font color="#0000ff">SELECT</font> Rec.id, Rec.pid, Rec.title<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">FROM</font> Rec, test_table<br>
&nbsp;&nbsp;&nbsp;&nbsp;<font color="#0000ff">WHERE</font> Rec.id = test_table.pid<br>
&nbsp;&nbsp; )<br>
&nbsp;<font color="#0000ff">SELECT</font> * <font color="#0000ff">FROM</font> Rec <br>
&nbsp;<font color="#0000ff">WHERE</font> pid <font color="#0000ff">is</font> <font color="#0000ff">null</font>;</font></code></blockquote><br>
<br>
    Rec,    ,      test_table.   Rec  ,   : WHERE Rec.id = test_table.pid.     ,     ,   pid  , ..   .<br>
<br>
 ,      MS SQL Server 2005   ,   .        .   ,     .<br>
<br>
 MS SQL 2008      <a href="http://habrahabr.ru/blogs/sql/27774/">hierarchyid</a>.  <a href="https://habrahabr.ru/users/xaoccps/" class="user_link">XaocCPS</a>   .<br>
<br>
<h4>Oracle</h4><br>
<br>
-    Oracle!        .  Oracle     8- ,    .        .           . ,  ,   .<br>
<br>
     :       .         ?<br>
<br>
<img src="https://habrastorage.org/getpro/habr/post_images/fb0/a97/4b4/fb0a974b419ac607c69338fb202f2cac.gif" alt="     Oracle"><br>
<br>
 ,         ‚Äì   <strong>CONNECT BY</strong>,  ‚Äú‚Äù   . <br>
<br>
  <strong>START WITH</strong>      , ..   ( )  .     ,       : pid is null,  id = 1,   substr(title, 1, 1) = ‚Äò‚Äô.<br>
<br>
  CONNECT BY   .    ,    . -   while    . ,      10 : rownum&lt;=10 ‚Äì        10  .  ?         ,      ‚Äì     1-    .  , <strong>rownum</strong>  ,    ,   1    .        .     .<br>
<br>
    ?    ,   <strong>PRIOR</strong>.    ,     +  -. ‚Äú ‚Äù ‚Äì  ,      .       pid = PRIOR id ( PRIOR id = pid,  ,   ‚Ä¶).<br>
<br>
 ?    ,    START WITH,    .          PRIOR.     ,     ,          (pid)   ,   id   .        .     ,        ,     . <br>
<br>
     ,      Oracle.      ,     .    ,      ,           -  .    id  pid.  , Oracle      <strong>LEVEL</strong>.   ,         . , 1-     1,    2,   ‚Äî 3  ..<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> <font color="#0000ff">level</font>, id, pid, title <br>
<font color="#0000ff">FROM</font> test_table<br>
<font color="#0000ff">START</font> <font color="#0000ff">WITH</font> pid <font color="#0000ff">is</font> <font color="#0000ff">null</font><br>
<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">PRIOR</font> id = pid;</font></code></blockquote><br>
<br>
<pre>LEVEL         ID        PID TITLE
------ ---------- ---------- -------------------
     1          1            
     2          2          1 
     3          3          2  "  "
     4          6          3  
     4          7          3  1
     4          8          3  2
     5          9          8  1
     2          4          1 
     2          5          1 
     3         10          5 
</pre><br>
<br>
.       .    ,       -,   .  ,   :      ORDER BY title.<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> <font color="#0000ff">level</font>, id, pid, title <br>
<font color="#0000ff">FROM</font> test_table<br>
<font color="#0000ff">START</font> <font color="#0000ff">WITH</font> pid <font color="#0000ff">is</font> <font color="#0000ff">null</font><br>
<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">PRIOR</font> id = pid<br>
<font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> title;</font></code></blockquote><br>
<br>
<pre>LEVEL         ID        PID TITLE
------ ---------- ---------- -------------------
     2          2          1 
     4          6          3  
     2          5          1 
     3         10          5 
     2          4          1 
     3          3          2  "  "
     4          7          3  1
     4          8          3  2
     1          1            
     5          9          8  1
</pre><br>
<br>
, !   .   ?         (     level),       ORDER BY.   ,         ,        <strong>SIBLINGS</strong>.      ORDER SIBLINGS BY title ‚Äì      .<br>
<br>
,     ,      .    ‚Äú‚Äù    ,   :<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> lpad(<font color="#A31515">' '</font>, 3*<font color="#0000ff">level</font>)||title <font color="#0000ff">as</font> Tree<br>
<font color="#0000ff">FROM</font> test_table<br>
<font color="#0000ff">START</font> <font color="#0000ff">WITH</font> pid <font color="#0000ff">is</font> <font color="#0000ff">null</font><br>
<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">PRIOR</font> id = pid<br>
<font color="#0000ff">ORDER</font> SIBLINGS <font color="#0000ff">BY</font> title;</font></code></blockquote><br>
<br>
<pre>TREE
-----------------------------
   
      
          "  "
             
             1
             2
                1
      
         
      
</pre><br>
<br>
 ,    ,       .<br>
<br>
,       ,    : /home/maovrn/documents/  ..?        .       :   Oracle     .      <strong>SYS_CONNECT_BY_PATH()</strong>.      :      -.   ,  : SYS_CONNECT_BY_PATH(title, ‚Äò/‚Äô).<br>
<br>
  ,    .  ,  ,    WHERE.          .      ,   FROM.      ‚Äú 1‚Äù,      id=9:<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> SYS_CONNECT_BY_PATH(title, <font color="#A31515">'/'</font>) <font color="#0000ff">as</font> <font color="#0000ff">Path</font><br>
<font color="#0000ff">FROM</font> test_table<br>
<font color="#0000ff">WHERE</font> id=9<br>
<font color="#0000ff">START</font> <font color="#0000ff">WITH</font> pid <font color="#0000ff">is</font> <font color="#0000ff">null</font><br>
<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">PRIOR</font> id = pid;</font></code></blockquote><br>
<br>
<pre>PATH
----------------------------------------------------
/// "  "/ 2/ 1
</pre><br>
<br>
     <strong>CONNECT_BY_ISLEAF</strong>.     ,  LEVEL.        0  1.    ‚Äì  0.   ,      ‚Äú‚Äù,      CONNECT_BY_ISLEAF   1.<br>
<br>
?  ,    .     PRIOR,     .       <strong>CONNECT_BY_ROOT</strong>,   (    !)   , ..     . <br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> id, pid, title, <font color="#0000ff">level</font>, <br>
&nbsp;CONNECT_BY_ISLEAF <font color="#0000ff">as</font> IsLeaf, <br>
&nbsp;<font color="#0000ff">PRIOR</font> title <font color="#0000ff">as</font> Parent, <br>
&nbsp;CONNECT_BY_ROOT title <font color="#0000ff">as</font> Root<br>
<font color="#0000ff">FROM</font> test_table<br>
<font color="#0000ff">START</font> <font color="#0000ff">WITH</font> pid <font color="#0000ff">is</font> <font color="#0000ff">null</font><br>
<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">PRIOR</font> id = pid<br>
<font color="#0000ff">ORDER</font> SIBLINGS <font color="#0000ff">BY</font> title;</font></code></blockquote><br>
<br>
<pre>ID PID TITLE                LEVEL LEAF PARENT               ROOT
-- --- -------------------- ----- ---- -------------------- ------
1                     1     0    
2  1                 2     0                   
3  2    "  "  3     0                  
6  3             4     1     "  "  
7  3    1               4     1     "  "  
8  3    2               4     0     "  "  
9  8    1             5     1     2               
5  1                   2     0                   
10 5              3     1                    
4  1                  2     1                   
</pre><br>
<br>
 ,        , Oracle  .  ,   ,       ‚Äì   ,     .    ‚Äú‚Äù     <strong>NOCYCLE</strong>  CONNECT BY ‚Äì     .     .    ‚Äú‚Äù ,   <strong>CONNECT_BY_ISCYCLE</strong> ‚Äì         0,   ,    ,    1.<br>
<br>
  ,    .       ;   ,      (   commit ‚Äì   ):<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">update</font> test_table <font color="#0000ff">set</font> pid=10 <font color="#0000ff">where</font> id=5;</font></code></blockquote><br>
<br>
   -   , ,   ,     ,    .   ,      , ..        .   START WITH,      ‚Äì  .              .  :<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> CONNECT_BY_ISCYCLE <font color="#0000ff">as</font> cycl, id, pid, title <br>
<font color="#0000ff">FROM</font> test_table<br>
<font color="#0000ff">START</font> <font color="#0000ff">WITH</font> id=5<br>
<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> NOCYCLE <font color="#0000ff">PRIOR</font> id = pid;</font></code></blockquote><br>
<br>
<pre>CYCL         ID        PID TITLE
---- ---------- ---------- ----------
   0          5         10 
   1         10          5 
</pre><br>
<br>
<h4> </h4><br>
<br>
      ,    .<br>
<br>
,   <i>     </i>.   ,     id      1,     .     .   ,     .<br>
<br>
  .      :<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">DELETE</font> <font color="#0000ff">FROM</font> test_table <font color="#0000ff">WHERE</font> id <font color="#0000ff">IN</font> (3, 5);</font></code></blockquote><br>
<br>
  ? -,         1      ,     .    id  , ,    :<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> <font color="#0000ff">max</font>(id) <font color="#0000ff">FROM</font> test_table</font></code></blockquote><br>
<br>
      1  max      .          !     ‚Äì    .<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> rownum <font color="#0000ff">as</font> rn <font color="#0000ff">FROM</font> dual<br>
&nbsp;<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">level</font> &lt;= (<font color="#0000ff">SELECT</font> <font color="#0000ff">max</font>(id) <font color="#0000ff">FROM</font> test_table);</font></code></blockquote><br>
<br>
 ‚ÄúSELECT ‚Ä¶ FROM dual‚Äù ,     ,      . <strong>Dual</strong> ‚Äì   ,       .          ‚ÄòX‚Äô.    ,        .<br>
<br>
 ,        ,    ,  <strong>pivot</strong>.         ,    .   dual  Oracle    .<br>
<br>
,      ,      ,       :<br>
<br>
<blockquote><code><font color="black"><font color="#0000ff">SELECT</font> sq.rn <br>
<font color="#0000ff">FROM</font> (<font color="#0000ff">SELECT</font> rownum <font color="#0000ff">as</font> rn <font color="#0000ff">FROM</font> dual<br>
&nbsp;<font color="#0000ff">CONNECT</font> <font color="#0000ff">BY</font> <font color="#0000ff">level</font> &lt;= (<font color="#0000ff">SELECT</font> <font color="#0000ff">max</font>(id) <font color="#0000ff">FROM</font> test_table)) sq<br>
<font color="#0000ff">WHERE</font> sq.rn <font color="#0000ff">not</font> <font color="#0000ff">in</font> (<font color="#0000ff">SELECT</font> id <font color="#0000ff">FROM</font> test_table)<br>
<font color="#0000ff">ORDER</font> <font color="#0000ff">BY</font> rn;</font></code></blockquote><br>
<br>
<pre>  RN
----
   3
   5
</pre><br>
<br>
.    ,      .     ROLLBACK. COMMIT!</div><p>Source: <a href="https://habr.com/ru/post/43955/">https://habr.com/ru/post/43955/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../43948/index.html">We write an accordion plugin in 618 bytes</a></li>
<li><a href="../43950/index.html">Vista</a></li>
<li><a href="../43951/index.html">New version of LiveStreet 0.2</a></li>
<li><a href="../43952/index.html">Access.xml</a></li>
<li><a href="../43953/index.html">Komodo IDE / Komodo Edit 5.0</a></li>
<li><a href="../43958/index.html">How to buy Google Mail accounts?</a></li>
<li><a href="../43960/index.html">Mobile WiMAX in Russia - October Results</a></li>
<li><a href="../43961/index.html">Startup on a note</a></li>
<li><a href="../43962/index.html">‚ÄúIPod Chief‚Äù no longer works for Apple</a></li>
<li><a href="../43966/index.html">You work (program) in the same room with employees. Radio turned on</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>