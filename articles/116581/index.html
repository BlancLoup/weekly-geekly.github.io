<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Waiting for several events in nodejs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone who begins to learn nodejs has difficulty switching to event-oriented programming. Everything is simple, as long as we can perform a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Waiting for several events in nodejs</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone who begins to learn nodejs has difficulty switching to event-oriented programming.  Everything is simple, as long as we can perform actions sequentially: start the next, waiting for the final event from the previous one.  But what to do if there are many such actions and they are long in time?  And if we can not continue until we wait for the completion of each of them? <br><br><a name="habracut"></a><br><h2>  Everything is simple </h2><br>  A small digression.  Any event in the nodejs can be associated with a handler function that will be called when the event occurs.  Moreover, it does not matter how it will be transferred to the process that triggers the event: as a parameter of the asynchronous function or by ‚Äúbinding‚Äù the function to this event.  One thing is important: we need to wait for the completion of each of our handler functions. <br>  To begin with, consider the simplest example.  We have several long actions (we will use the setTimeout function) and we will run the next action only after the previous one is completed. <br>  So, an example: <br><pre><code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"begin"</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"2000ms timeout"</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1500ms timeout"</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1000ms timeout"</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"final"</span></span>); }, <span class="hljs-number"><span class="hljs-number">500</span></span>); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); }, <span class="hljs-number"><span class="hljs-number">1500</span></span>); }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"end"</span></span>);</code> </pre> <br>  We start some process with a length of 2000 ms, after its completion we launch the second one for 1500 ms, then the third one for 1000 ms and, finally, the last one, for 500 ms.  The result will be as follows: <br><pre> begin
 end
 2000ms timeout
 1500ms timeout
 1000ms timeout
 final
</pre><br>  Everything is bad if the actions performed by the program really have to be performed sequentially, and there is no way to start the second action before the end of the first one, and the third - before the second one.  But if it is possible, then it is not possible, but necessary! <br><br><h3>  Why is it necessary? </h3><br>  What is the point of suspending the whole process and waiting for the slow subsystem to do everything we want from it, if we have something to do besides waiting?  No  Therefore, the simultaneous launch of several long operations, and these may include work with the network, disk subsystem, can significantly speed up the execution of the program. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  A little harder </h2><br>  Suppose that all our operations are independent of each other.  Then they can be run in parallel: <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"begin"</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"2000ms timeout"</span></span>); }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1500ms timeout"</span></span>); }, <span class="hljs-number"><span class="hljs-number">1500</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1000ms timeout"</span></span>); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"final"</span></span>); }, <span class="hljs-number"><span class="hljs-number">500</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"end"</span></span>);</code> </pre><br>  Result of performance: <br><pre> begin
 end
 final
 1000ms timeout
 1500ms timeout
 2000ms timeout
</pre><br>  The main program completed its execution, and then began to consistently work out callback functions for each of the ‚Äúlong actions‚Äù.  But the main thing - the program execution time has decreased by almost two and a half times! <br>  Again, there is nothing difficult in this example, but only as long as one of the actions does not have to wait until the others are completed. <br><br><h2>  Even harder </h2><br>  Suppose we can start the last action only after waiting for the completion of all the previous ones.  The first thing that comes to mind is the organization of the counter.  First, its value will be equal to the number of our callback functions, which must be waited for.  At the end of each of them, the counter will decrease, and when the last one reaches zero, our ‚Äúwaiting function‚Äù will be called. <br>  For example, like this: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> counter = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"begin"</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"2000ms timeout"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-- counter == <span class="hljs-number"><span class="hljs-number">0</span></span>) final(); }, <span class="hljs-number"><span class="hljs-number">2000</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1500ms timeout"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-- counter == <span class="hljs-number"><span class="hljs-number">0</span></span>) final(); }, <span class="hljs-number"><span class="hljs-number">1500</span></span>); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1000ms timeout"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (-- counter == <span class="hljs-number"><span class="hljs-number">0</span></span>) final(); }, <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">final</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"final"</span></span>); }, <span class="hljs-number"><span class="hljs-number">500</span></span>); } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"end"</span></span>);</code> </pre><br>  Result: <br><pre> begin
 end
 1000ms timeout
 1500ms timeout
 2000ms timeout
 final
</pre><br>  All perfectly! <br>  The problems will begin when one day we forget to add one to the counter or add a modification to the callback function and a call to the ‚Äúwaiting function‚Äù. <br>  ‚ÄúAll work with the meter must be wrapped in some object!‚Äù - I thought.  But, as it turned out, I‚Äôm not the only one: Tim Caswell has already <a href="http://groups.google.com/group/nodejs/browse_thread/thread/7571be00a54a3a6d">proposed</a> something similar, and I took his idea as a basis. <br>  Wrapper: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Combo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">finalCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finalCallback = finalCallback; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result = []; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } Combo.prototype = { <span class="hljs-string"><span class="hljs-string">"add"</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> that = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter ++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ that.result[that.counter - <span class="hljs-number"><span class="hljs-number">1</span></span>] = callback.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); that.check(); }; }, <span class="hljs-string"><span class="hljs-string">"check"</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> that = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter --; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter == <span class="hljs-number"><span class="hljs-number">0</span></span>) process.nextTick(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ that.finalCallback.call(that, that.result); }); } };</code> </pre><br>  When an object is created, the constructor, as a parameter, receives a ‚Äúwaiting function‚Äù, which the wrapper will launch upon completion of all ‚Äúexpected functions‚Äù.  The add method increments the counter and creates a wrapper function for the user ‚Äúexpected function‚Äù.  The created wrapper function runs the corresponding ‚Äúexpected function‚Äù, passing all the parameters received to it, and then runs the check method.  The check method, in turn, reduces the counter and, when the latter reaches zero, starts the ‚Äúwaiting function‚Äù passed in the constructor.  In this case, just in case, the results of the work of ‚Äúexpected functions‚Äù are saved, which are transmitted as a parameter of the ‚Äúwaiting function‚Äù. <br>  Example: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Combo( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"final"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> result) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">" \""</span></span> + i + <span class="hljs-string"><span class="hljs-string">"\" : \""</span></span> + result[i] + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"begin"</span></span>); setTimeout(test.add(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"2000ms"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"2000ms"</span></span>; }), <span class="hljs-number"><span class="hljs-number">2000</span></span>); setTimeout(test.add(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1500ms"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"1500ms"</span></span>; }), <span class="hljs-number"><span class="hljs-number">1500</span></span>); setTimeout(test.add(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1000ms"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"1000ms"</span></span>; }), <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"end"</span></span>);</code> </pre><br>  Result of work: <br><pre> begin
 end
 1000ms
 1500ms
 2000ms
 final
 result:
   "0": "2000ms"
   "1": "1500ms"
   "2": "1000ms"
</pre><br>  Beauty! <br>  Now we can slip the closing events (for example, the end event for threads) to the wrapper function created by the add method and our ‚Äúwaiting function‚Äù will be launched only after all the ‚Äúexpected functions‚Äù have completed. <br>  The main thing is not to forget to wrap up the new ‚Äúexpected functions‚Äù. <br><br><h2>  Most difficult </h2><br>  But what if one of the actions failed?  For asynchronous functions that take a callback function as a parameter, there will be no problems: the first parameter of the callback function is passed a special variable containing error information, if any.  But, for example, in the event of a failure, the threads ‚Äúthrow out‚Äù the error event.  At the same time, the final event ‚Äúend‚Äù will not be thrown out, which means that one of the ‚Äúexpected functions‚Äù will not be launched either.  As a result, the ‚Äúwaiting function‚Äù will never be started. <br>  If you can complete the program with the release of an exception - very good.  But what to do if such a situation should be processed and continued?  You need to add a mechanism to remove the "expected features"! <br>  For example: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Combo</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">finalCallback</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.finalCallback = finalCallback; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result = {}; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter = <span class="hljs-number"><span class="hljs-number">0</span></span>; } Combo.prototype = { <span class="hljs-string"><span class="hljs-string">"add"</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">callback, id</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> that = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!id) id = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter ++; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!that.result.hasOwnProperty(id)) { that.result[id] = callback.apply(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); that.check(); } }; }, <span class="hljs-string"><span class="hljs-string">"remove"</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.result[id] = result; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.check(); }, <span class="hljs-string"><span class="hljs-string">"check"</span></span> : <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> that = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter --; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.counter == <span class="hljs-number"><span class="hljs-number">0</span></span>) process.nextTick(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ that.finalCallback.call(that, that.result); }); } };</code> </pre><br>  As a second, optional parameter, the add method is passed an identifier by which, if necessary, you can remove the ‚Äúexpected function‚Äù.  And besides, the result of the ‚Äúexpected function‚Äù is now stored in the field with the specified identifier.  The remove method is passed the identifier of the ‚Äúexpected function‚Äù and ‚Äúthe result by mistake‚Äù, which will be stored in the object-keeper of the results. <br>  Example: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> test = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Combo(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">result</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"final"</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"result:"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> result) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">" \""</span></span> + i + <span class="hljs-string"><span class="hljs-string">"\" : \""</span></span> + result[i] + <span class="hljs-string"><span class="hljs-string">"\""</span></span>); } }); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"begin"</span></span>); setTimeout(test.add(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"2000ms"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"2000ms"</span></span>; }), <span class="hljs-number"><span class="hljs-number">2000</span></span>); setTimeout(test.add(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1500ms"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"1500ms"</span></span>; }, <span class="hljs-string"><span class="hljs-string">"1500ms"</span></span>), <span class="hljs-number"><span class="hljs-number">1500</span></span>); setTimeout(test.add(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"1000ms"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"1000ms"</span></span>; }), <span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-comment"><span class="hljs-comment">// error setTimeout(function () { console.log("something wrong in 1500ms on 1250ms"); test.remove("1500ms", "error in 1500ms"); }, 1250); console.log("end");</span></span></code> </pre><br>  Result: <br><pre> begin
 end
 1000ms
 something wrong in 1500ms on 1250ms
 2000ms
 final
 result:
  "0": "2000ms"
  "2": "1000ms"
  "1500ms": "error in 1500ms"
</pre><br><br><h2>  Conclusion </h2><br>  Of course, the wrapper can and should be improved, but for me the development of this object has become a very good warm-up.  If everything is done leisurely and thoughtfully, event-oriented programming is not so difficult. <br>  And, of course, do not forget about the help of the community: perhaps, someone has already solved problems similar to yours. </div><p>Source: <a href="https://habr.com/ru/post/116581/">https://habr.com/ru/post/116581/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../116575/index.html">Determine your location via WiFi network</a></li>
<li><a href="../116576/index.html">April 1</a></li>
<li><a href="../116577/index.html">Using the singleton pattern</a></li>
<li><a href="../116578/index.html">How to deal with pauses GC</a></li>
<li><a href="../116579/index.html">OpenCL: How to make this thing work</a></li>
<li><a href="../116582/index.html">Ubuntu 11.04 Beta released</a></li>
<li><a href="../116583/index.html">Mobile thumbnails</a></li>
<li><a href="../116584/index.html">Custom social buttons</a></li>
<li><a href="../116585/index.html">New sights appeared in Google Street View</a></li>
<li><a href="../116586/index.html">Update JetBrains PhpStorm 2.0.1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>