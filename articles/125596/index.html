<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Software RAID-6 under Linux: 16TB array recovery experience</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few days ago one of the hard drives on a budget array of 16x1TB drives failed. Array level: RAID 6. The situation was complicated by the fact that (...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Software RAID-6 under Linux: 16TB array recovery experience</h1><div class="post__text post__text-html js-mediator-article">  A few days ago one of the hard drives on a budget array of 16x1TB drives failed.  Array level: RAID 6. The situation was complicated by the fact that (as it turned out) a cooler was also installed on the video card of the same server, which was not noticed before, and after replacing the HDD, as a result of a change in the cooling mode of the case - this began to manifest itself in the form of synchronization time, which in itself is very unpleasant.  This resulted in the fact that the array ceased to auto-assemble, and several more disks were marked as failed, and I had to deal with it seriously, smoking wikis, manuals and forums (forums are the most useful because they describe the experience of specific people in specific situations) . <br><a name="habracut"></a><br>  The structure of my array: <br><br>  16x1TB HDD <br><br>  sections: <br>  md0 - / root 8x1 GB, RAID 6 <br>  md1 - / data: 16x999GB, RAID 6 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At first, all the assembly experiments were set up on md0, i.e., on the rudimentary partition, which in itself does not have much value, except that it is a tuned system. <br><br>  So, I booted from Debian Disc 1 in Resque mode <br><br>  Attempting to auto-array through <br><br><pre> mdadm --assemble --scan
</pre><br>  led to the conclusion of the error "not enough disks to build an array." <br><br>  Continuing on science: <br><br>  1. It is necessary to preserve the description information for arrays that contain information which disk specifically is which number in the array.  In case you have to collect "dangerous methods": <br><br><pre> mdadm --examine / dev / sd [abcdefghijklmnop] 1&gt; / mnt / raid_layout1
 mdadm --examine / dev / sd [abcdefghijklmnop] 2&gt; / mnt / raid_layout2
</pre><br>  These files contain something similar to the one below for all HDDs that have a superblock on the sdX1 partition (in my case only 8 of 16 for md0 have a superblock on sdX1) <br><br>  Below is an example of the output of one of the sections: <br><br><pre> / dev / sdp1:
         Version: 0.90.00
      Raid Level: raid6
   Used Dev Size: 975360 (952.66 MiB 998.77 MB)
    Raid Devices: 8
   Total Devices: 8

       Number Major Minor RaidDevice State
 this 4 8 177 4 active sync / dev / sdl1

    0 0 8 97 0 active sync / dev / sdg1
    1 1 8 113 1 active sync / dev / sdh1
    2 2 8 129 2 active sync / dev / sdi1
    3 3 8 145 3 active sync / dev / sdj1
    4 4 8 177 4 active sync / dev / sdl1
    5 5 8 193 5 active sync / dev / sdm1
    6 6 8 209 6 active sync / dev / sdn1
    7 7 8 225 7 active sync / dev / sdo1
</pre><br>  Briefly about what this means: <br><br>  sdf2 - current parsed partition <br>  Version 0.90.00 - Superblock Version <br>  You will also see a bunch of useful information - the size of the array, UUID, Level, Size of the array, Number of devices, etc. <br><br>  But the most important thing for us now is the table at the bottom of the list, the first line in it indicates what the HDD in the array is in our array: <br><br><pre> this 4 8 177 4 active sync / dev / sdl1
</pre><br>  Also pay close attention to the superblock version!  In my case, it is 0.90.00. <br><br>  Here we see its number in the array, i.e. 4 - you will find the same numbers in the output for all other devices from the list.  Please note that the disk letter in the status line is different - sdl1 - this means that the disk was initialized on another SATA port, then moved.  This is noncritical information, but may be useful. <br><br>  The device name and its number in the array are critical (they will change when devices are transferred from port to port). <br><br>  We save the created raid_layout file (for example, on a flash drive) so as not to get lost, and proceed to the next step: <br><br>  2. Trying to build an array <br><br>  You can assemble an array in 2 ways: automatic and manual. <br><br>  Auto: <br><br><pre> mdadm --assemble --scan -v
</pre><br>  If it is automatically assembled, consider you lucky, you just need to check whether all the HDDs in the array, and if not, add the missing ones, and then you can not read.  But, in my case, the automatic build fails with the error that insufficiently working devices: <br><br><pre> mdadm: / dev / md2 assembled from 4 drives - not enough to start the array.
</pre><br>  and the array was created on 4 of 8 disks.  Of course, it will not work, since Raid6 allows only 2 disks to be missing. <br><br>  Checking array status <br><br><pre> cat / proc / mdstat

 md2: inactive sdn1 [3] (S) sdk1 [7] (S) sdj1 [6] (S) sdp1 [4] (S)
       3907264 blocks
</pre><br>  There is a subtlety - if in the HDD list there is an uninitialized or flagged as failed, then the assembly stops immediately, so the ‚Äú-v‚Äù flag is useful - to see on which of the HDD the assembly got up. <br><br>  Manual assembly: <br><br><pre> mdadm --assemble / dev / sd [abcdefgh] 1 -v
</pre><br>  The same, but we specified specifically which HDDs to use for assembly. <br><br>  Most likely the array will not build as well as in the case of the automatic assembly.  But, collecting by hand, you begin to better understand the very essence of what is happening. <br><br>  The array is also not collected if the disk is marked as ‚Äúfaulty‚Äù in the section metadata. <br><br>  Here I am jumping on how I started the array with the data, because / root array I lost, why and how - described below.  To build an array ignoring the ‚Äúfaulty‚Äù status ‚Äî you can add the ‚Äú-f‚Äù (force) flag ‚Äî in my case, this solved the problem of assembling the main partition with data, that is, the partition was successfully rebuilt with the following command: <br><br><pre> mdadm --assemble / dev / md3 / dev / sd [abcdefghijklmnop] 2 -f
</pre><br>  for sure, a simple way to assemble it would be as follows: <br><br><pre> mdadm ‚Äîassemble ‚Äîscan -f -v
</pre><br>  But since I got to the "-f" flag through thorns, this is now understandable. <br>  That is, sections marked as failed or obsolete were added to the array, and not ignored.  It is likely that a bad or outdated partition may be marked with a bad, or not tightly fitting SATA cable, which is not uncommon. <br><br>  Nevertheless, I got an array in degraded mode, on 14 disks out of 16. <br><br>  Now, to restore the normal performance of the array and not be afraid for it, you need to add 2 missing disks to it: <br><br><pre> mdadm --add / dev / md3 / dev / sdX2
</pre><br>  where X is the letter of the new HDD partition <br><br>  Below I will cite the difficulties that I encountered in order to save others from attacking my rake: <br><br>  I used WIKI recommendations - Linux RAID Recovery ( <a href="https://raid.wiki.kernel.org/index.php/RAID_Recovery">raid.wiki.kernel.org/index.php/RAID_Recovery</a> ) for working with the Linux RAID array WIKI - I advise you to be careful with them, because the page describes the process very briefly, and thanks to these recommendations, I destroyed / root (md0) of my array. <br><br>  Until this line at the very bottom of the WIKI article, everything is very useful: <br><br><pre> mdadm --create --assume-clean --level = 6 --did-devices = 10 / dev / md0 / dev / sdb1 / dev / sdc1 / dev / sdd1 / dev / sde1 / dev / sdf1 missing / dev / sdl1 / dev / sdk1 / dev / sdj1
</pre><br>  This line demonstrates how to re-create an array, knowing which devices in which order it is included.  It is very important to take into account the version of your superblock, since the new mdadm create a superblock 1.2 and it is located at the beginning of the section, 0.90 is located at the end.  Therefore, you need to add the flag "--metadata = 0.90". <br>  After I built the array using ‚Äú--create‚Äù, the file system was destroyed, and neither the main ext4 superblock nor the backup superclock was found.  At first, I discovered that the new superblock was not 0.90 and 1.2, which could have caused the partition to be destroyed, but it didn‚Äôt appear, because changing the RAID version of the superblock to 0.90 and searching the backup of the ext4 superblock was unsuccessful. <br>  Since the / root partition is not the most important part, I decided to experiment - the array was reformatted and then stopped: <br>  mdadm ‚Äîstop / dev / md2 <br>  and immediately created again through ‚Äú--create‚Äù: the result is that the file system is destroyed again, although this should not have happened, I am sure that I did not confuse the order of the devices for the first time, and especially the 2nd one. <br>  Perhaps someone successfully restored partitions, through "--create", I will be happy to add to this article what exactly I did wrong, and why FS was destroyed.  Perhaps it was also collected with other parameters of the block size (chunk size). <br><br>  <i>It is obvious that any recommendations from this article should be used at your own risk and risk, no one guarantees that in your case everything will work exactly as in mine.</i> </div><p>Source: <a href="https://habr.com/ru/post/125596/">https://habr.com/ru/post/125596/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125589/index.html">Combined Russian-Ukrainian typographical keyboard layout for Mac OS X 10.6</a></li>
<li><a href="../125590/index.html">Nokia creatively promotes the N8</a></li>
<li><a href="../125591/index.html">The news of IE's low IQ users turned out to be a hoax</a></li>
<li><a href="../125592/index.html">Silverlight cookbook: drag & drop recipe</a></li>
<li><a href="../125594/index.html">50 more Nokia N950 are waiting for developers</a></li>
<li><a href="../125597/index.html">Writing PHP extension</a></li>
<li><a href="../125599/index.html">Node.JS for Windows: node.exe</a></li>
<li><a href="../125603/index.html">The second breath of a budget Android-smartphone</a></li>
<li><a href="../125605/index.html">HotMilk is a library for conveniently organizing Mustache templates.</a></li>
<li><a href="../125607/index.html">Quality assurance management</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>