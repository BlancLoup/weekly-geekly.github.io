<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Setting up a SoftEtherVPN VPN server under Linux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As it was already written in Habr√©, literally at the beginning of January of this year, under the GPL2 license, a very interesting and, in its way, un...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Setting up a SoftEtherVPN VPN server under Linux</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/013/252/f46/013252f46e369335b88284ce3b10ca61.jpg"><br>  As it was already <a href="http://habrahabr.ru/post/208782/">written</a> in Habr√©, literally at the beginning of January of this year, under the GPL2 license, a very interesting and, in its way, unique project, <a href="http://www.softether.org/">SoftEther VPN, was transferred</a> .  It was written by students of the Japanese University of Tsukuba.  This product positions itself as a VPN server with support for a huge number of tunneling protocols: L2TP, L2TP / IPsec, L2TPv3 / IPsec, MS-SSTP, EtherIP / IPsec, OpenVPN, SSL-VPN (proprietary), L2VPN, and such clever things like tunneling through ICMP and DNS.  It supports tunneling at the third and at the second level, can VLAN and IPv6.  It works on almost all known platforms (even ARM and MIPS) and, moreover, does not require root rights.  The full specification can be found <a href="http://www.softether.org/3-spec">here</a> .  To be honest, when I saw the list of features of this program - I just could not believe my eyes and thought: ‚ÄúIf THIS works, then I MUST test it!‚Äù <br>  This article will describe the process of installing and configuring SoftEther VPN Server under Linux.  In the next article I will try to draw beautiful comparative performance graphs. <a name="habracut"></a><br>  This software has an extremely pleasant <a href="http://www.softether.org/3-screens/1.vpnserver">interface</a> for Windu, but under Linux all configuration is done through the CLI.  <a href="http://www.softether.org/4-docs/1-manual">The manual is</a> certainly good, but for example it seemed to me too detailed, and besides with a bias towards the graphical interface and excessively colorful Japanese pictures.  Therefore, I decided to lay out the main CLI commands for those who are too lazy to shovel a lot of English letters. <br><br>  For starters, let's install this miracle.  I had a VPS with a 64-bit Debian 7 on board, so the choice was obvious.  Immediately I warn you: you need to install only from <a href="https://github.com/SoftEtherVPN/SoftEtherVPN/">GitHub</a> (at the moment release version 4.04 build 9412)!  On the official <a href="http://www.softether-download.com/">website,</a> you can download the source code for different platforms, but the ambush is that the makefiles are generated there in some sadistic-Western way, and you get only two files at the output - the server binary itself and its CLI scale.  No copying to / usr / bin / and other civilized things is written there.  In contrast, the Github makefile behaves much more friendly (although the init script still doesn‚Äôt, the infection). <br><br>  Before you install the program, I recommend to go <a href="http://www.softether.org/4-docs/1-manual/7._Installing_SoftEther_VPN_Server/7.3_Install_on_Linux_and_Initial_Configurations">here</a> and find out what it needs for installation.  For example, I needed to install a number of libraries (then they can be demolished): <br><blockquote><code># apt-get install libreadline-dev libssl-dev libncurses5-dev zlib1g-dev</code> </blockquote>  Further installation is not easy, but very simple, but I want to note that instead of ‚Äúmake install‚Äù I write ‚Äúcheckinstall‚Äù so that the apt package manager knows about the new program and could then remove it correctly (more <a href="https://debian.pro/628">here</a> ). <br><blockquote> <code><a href=""></a> # git clone github.com/SoftEtherVPN/SoftEtherVPN.git</code> <br> <code># cd SoftEtherVPN\</code> <br> <code># ./configure</code> <br> <code># make</code> <br> <code># checkinstall</code> </blockquote>  During the process, the installer will ask you to read the License Agreement, as well as indicate your platform and OS bitness.  By the way, he will install the prog anyway in / usr / vpnserver /, and binaries in / usr / bin /, keep in mind.  If the installation path is not liked, it can be changed by hand in the makefile.  At the end of the installation, he will say: <br><blockquote>  - Installation completed successfully. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Execute 'vpnserver start' to run the SoftEther VPN Server background service. <br>  Execute the SoftEther VPN Bridge background service. <br>  Execute 'vpnclient start' to run the SoftEther VPN Client background service. <br>  Execute 'vpncmd' to run SoftEther VPN Command-Line Utility to configure VPN Server, VPN Bridge or VPN Client. <br>  -------------------------------------------------- ------------------ </blockquote>  From here you can logically understand how this magic starts and stops.  You can leave and so, but you can take off.  Site simple <a href="http://www.softether.org/4-docs/1-manual/7._Installing_SoftEther_VPN_Server/7.3_Install_on_Linux_and_Initial_Configurations">init-script</a> , which will be more familiar to us the way to do the same. <br><br>  So, the VPN server is installed and you can start it: <br><blockquote> <code># vpnserver start</code> <br> <code>SoftEther VPN Server Service Started.</code> </blockquote>  We start the configuration.  In general, the manual offers us two ways to do this: through its own command line <b>vpncmd</b> or through the configuration file <b>vpn_server.config</b> , with great preference given to the first method.  The manufacturer considers the operations with the configuration file to be a risky exercise and in every possible way tries to <a href="http://www.softether.org/4-docs/1-manual/3._SoftEther_VPN_Server_Manual/3.3_VPN_Server_Administration">discourage</a> us from this.  The fact is that the server continuously reads this file and any changes in it instantly affect the operation of the server.  The only case when setting from the config file is justified is when the VPN server is turned off.  I do not know why this is done, but the author, in any case, knows better.  And in general, the program has a good CLI, after working with which you simply forget about the existence of a config file as unnecessary. <br><br>  By the way, immediately after the installation I noticed that the program for some reason knocked at 130.158.6.77:80.  It turned out that there is nothing suspicious, just in this way the server sends keepalive packages to its website (keepalive.softether.org:80) so that different PPP sessions do not break on timeout.  Immediately after installation, I disabled this feature with the <b>KeepDisable</b> command. <br><br>  So, immediately after starting the VPN server is already running and accepts connections to TCP ports 443 (SSL VPN), 992, 1194 (OpenVPN) and 5555 (you can change the port numbers with the <b>ListenerCreate</b> and <b>ListenerDelete</b> commands), but to start using it you need to make a number of settings.  Go to the CLI with the <b>vpncmd</b> command: <br><blockquote> <code># vpncmd</code> <br> <code>vpncmd command - SoftEther VPN Command Line Management Utility</code> <br> <code>SoftEther VPN Command Line Management Utility (vpncmd command)</code> <br> <code>Version 4.04 Build 9412 (English)</code> <br> <code>Compiled 2014/01/15 17:22:14 by yagi at pc25</code> <br> <code>Copyright (c) SoftEther VPN Project. All Rights Reserved.</code> <br> <br> <code>By using vpncmd program, the following can be achieved.</code> <br> <br> <code>1. Management of VPN Server or VPN Bridge</code> <br> <code>2. Management of VPN Client</code> <br> <code>3. Use of VPN Tools (certificate creation and Network Traffic Speed Test Tool)</code> <br> <br> <code>Select 1, 2 or 3:</code> </blockquote>  Choice 1 will take us to the server editing mode, choice 2 to the client properties editing mode, and choice 3 will take us to the test and create server certificates mode.  Selecting 1, the server will offer to enter the ip address of the server to which we want to connect (Hostname of IP Address of Destination :), just press Enter, because  going to edit the local server.  For the third and last time, the program will ask us the name of the virtual hub (Specify Virtual Hub Name :), with which we will work.  We are not going to work with virtual hubs yet, so again press Enter and get into the command line of the server itself. <br><br>  It is necessary to clarify what virtual hubs are in the terminology of the developer.  A virtual hub is a kind of rather independent instance of a VPN server that has its own set of settings for virtual interfaces, security policies, and VPN protocols.  In total, you can create up to 4096 virtual hubs, while they will not intersect with each other either at the 2nd or 3rd level - that is, they will be completely isolated from each other.  Each virtual hub works with its own set of users and knows nothing about the users of another virtual hub, even though they are on the same physical server.  On the other hand, if we want, we can configure their interaction with each other, in the author‚Äôs terminology this is called Virtual bridge / router.  Thus, the virtual hub is what we will work with after specifying certain global server settings. <br><br>  After logging in to vpncmd, we will receive an invitation: <br><blockquote> <code>Connection has been established with VPN Server "localhost" (port 443).</code> <br> <br> <code>You have administrator privileges for the entire VPN Server.</code> <br> <br> <code>VPN Server&gt;</code> </blockquote>  You can enter help and read the list of commands. <br>  The first thing we need to do is set the root password of the server.  This is done by the <b>ServerPasswordSet</b> command.  Further, as I wrote with the <b>KeepDisable</b> command, <b>we</b> disable the keepalive packages. <br>  Next, create a virtual hub with the <b>HubCreate &lt;virtual hub name&gt;</b> command, for example <br><blockquote> <code>VPN Server&gt;hubcreate vpn</code> <br> <code>HubCreate command - Create New Virtual Hub</code> <br> <code>Please enter the password. To cancel press the Ctrl+D key.</code> <br> <br> <code>Password:</code> </blockquote>  You can set the admin password for the new hub, then you can delegate the administration of this hub to another person.  And for simplicity, you can press Enter and do not do this (for this, in the future there is the <b>SetHubPassword</b> command).  After creating the hub, we must go into the administration mode of this hub with the <b>Hub vpn</b> command.  You can view the status of the hub using the <b>StatusGet</b> command.  I will not give the output of this command here, because  It is long and fairly clear.  The hub can be turned off with the <b>Offline</b> command and returned back with the <b>Online</b> command. <br><br>  I liked the <b>SetEnumDeny</b> team.  The fact is that when in the VPN client you enter the address of the VPN server, it immediately gives you the names of all the virtual hubs registered on the server, as in the picture.  This command prohibits displaying the name of this hub in the list.  Type a small, but a bonus to security. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6e/187/3b5/e6e1873b5a9d74cc9e26e9bfc595079c.png"><br><br>  Okay, let's do some more interesting things.  Create a user with the <b>UserCreate</b> command and set a password for it using the <b>UserPasswordSet</b> .  The commands are very simple, just a minimum of English is enough to understand the conversational server messages.  At this stage, for simplicity, we will not bother with the certificates, but rather trust the self-signed server certificate that it generated during the installation phase. <br><br>  That's basically all, the minimum installation is complete and we can cling to our server by specifying its IP address and any of the <b>ListenerList</b> ports.  The author recommends port 5555, since this port does not require root rights in the system.  I already quoted the VPN client window above, everything is intuitive and very beautiful there.  Authentication passes and establishes a VPN tunnel.  However, in this form of use of the tunnel is small, because  it allows you to access only the server itself and nowhere else. <br><br>  Let's say our task is wider, and we want to use a VPN server to access the corporate network.  For this we need to configure NAT.  This is done quite simply with the <b>SecureNATEnable</b> command.  Automatically along with NAT and DHCP is enabled. <br><br>  In general, SecureNAT is quite an interesting technology from the authors SoftEtherVPN.  As we know, the translation of network addresses in * NIX-systems is carried out in the kernel, respectively, to configure NAT you need to have superuser rights.  The creators of SoftEtherVPN decided that it was too redundant and wrote their own custom TCP / IP stack for filtering and rubbing into userspace.  Cool idea, I do not know whether it was worth it, but it works - it is a fact! <br>  You can change the <b>SecureNatHostSet</b> interface address (by default 192.168.30.1/24), and the range of issued addresses and other DHCP options (for example, the default gateway and DNS server) - with the <b>DhcpSet</b> command.  Isn't it friendly CLI?  For example, if you enter ‚Äúsecure?‚Äù And press Enter, then a list of possible autocompletions will appear: <br><blockquote> <code>VPN Server/vpn&gt;secure?</code> <br> <code>"secure": The command-name is ambiguous.</code> <br> <code>The specified command name matches the following multiple commands.</code> <br> <code>SecureNatDisable - Disable the Virtual NAT and DHCP Server Function (SecureNat Function)</code> <br> <code>SecureNatEnable - Enable the Virtual NAT and DHCP Server Function (SecureNat Function)</code> <br> <code>SecureNatHostGet - Get Network Interface Setting of Virtual Host of SecureNAT Function</code> <br> <code>SecureNatHostSet - Change Network Interface Setting of Virtual Host of SecureNAT Function</code> <br> <code>SecureNatStatusGet - Get the Operating Status of the Virtual NAT and DHCP Server Function (SecureNat Function)</code> <br> <code>Please re-specify the command name more strictly.</code> </blockquote>  By default, no packet filtering is applied, i.e.  VPN clients can unlimitedly go to the corporate subnet and use the corporate Internet, if there is one.  If you wish, you can add firewall rules with the <b>AccessAdd</b> command.  As criteria for a firewall, you can specify the user name, MAC and IP addresses of the source and destination, ports, protocols and TCP flags.  And the most important thing is that it works, I checked!  Consider also that the filtering rules of different virtual hubs do not affect each other in any way, which allows you to flexibly control access to the corporate environment. <br><br>  Dynamic DNS from softether.net is available as a nice bonus.  You can register your VPN server in DDNS with the <b>DynamicDnsSetHostname</b> command, after which you need to enter the desired domain name of the 3rd level.  It will turn out something like myvpn.softether.net.  Agree, a trifle, but nice and, moreover, completely free! <br><br>  Let's talk about VPN protocols.  I tested L2TP / IPsec and OpenVPN.  Setting up two seemingly such different protocols turned out to be quite simple.  OpenVPN is enabled initially on port 1194 UDP, but in order for it to work, you need to enter the global server mode ( <b>Hub</b> command without parameters), enter <b>IPsecEnable</b> , and then answer a number of questions to see if we want to enable Naked L2TP, encrypted L2TP / IPsec, and L2TPv3 / IPsec.  The most important questions are the Pre-shared key (PSK) for IPsec and Default Hub.  With PSK, everything is clear, this is the key that needs to be entered on the client device, but I'll tell you more about Default Hub. <br><br>  The fact is that the same OpenVPN does not work through IPsec, but inherits the account policy from IPsec.  Therefore, when trying to connect using the OpenVPN protocol, a username and password will be requested.  The username must be entered in the format "user @ hub", but if we specify which hub to use by default, then the "@ hub" can be omitted. <br><br>  You can generate a config file for OpenVPN using the <b>OpenVpnMakeConfig</b> command, and then specify the location where to save the generated file.  This file can be immediately fed to the OpenVPN client and the connection will go.  The file is provided in two options at once - Layer2VPN and Layer3VPN, that is, a VPN server as a switch, and a VPN server as a router.  Both works great.  Conveniently! <br><br>  Setting up L2TP / IPsec turned out to be generally trivial: after the <b>IPsecEnable</b> command, <b>you</b> don‚Äôt need to change anything, and in the settings for example the Windows built-in VPN client you need to specify the ‚ÄúL2TP IPsec VPN‚Äù protocol, specify the pre-shared key (PSK) in the advanced settings, which we already installed, well, of course, enter the credentials in the format I mentioned above. <br>  Similarly, everything is configured on Android.  It was tested on 4.2.1, everything works using only standard tools. <br><br>  <b><u>Conclusion:</u></b> SoftEtherVPN is a very powerful and, most importantly, convenient tool for building VPN tunnels.  Of course, I have tested far from all the possibilities, but in most cases there are enough of those that I wrote.  In the near future I will try to lay out comparative tests of performance, as well as tests of such funny pieces like VPN over ICMP and DNS.  I don‚Äôt want to communicate with SSL VPN and MS SSTP, because  reluctance to mess with certificates, besides, we still need to look at features such as Load Balancing aka clustering, fault tolerance, authorization from RADIUS and AD and Layer2 VPN, including VLAN trunking! <br><br>  So, it seems to me, the software is, at least, in order to look at it more closely.  The manufacturer positions its product as in everything superior OpenVPN, even promises throughput under gigabit.  In general, it is necessary to test!  At this stage, I really like this thing. </div><p>Source: <a href="https://habr.com/ru/post/211136/">https://habr.com/ru/post/211136/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211122/index.html">Full analysis of Apple Macintosh 128K</a></li>
<li><a href="../211124/index.html">Updated + code: Own "VBoxManage list ip" - a list of addresses of running virtual machines</a></li>
<li><a href="../211126/index.html">Radio-controlled switch do it yourself. Part 1 - Hardware</a></li>
<li><a href="../211128/index.html">Oona R√§is√§nen determined the GPS coordinates of the helicopter from YouTube‚Äôs sound</a></li>
<li><a href="../211132/index.html">NASA has launched a new program to develop private landing modules for the moon.</a></li>
<li><a href="../211140/index.html">Creating the game on your eyes - part 2: Shaders for styling images under the CRT / LCD</a></li>
<li><a href="../211144/index.html">UICollectionView or dancing with wolves</a></li>
<li><a href="../211146/index.html">RPKI integration into BGP on Juniper routers</a></li>
<li><a href="../211148/index.html">Podcasts Devops Deflope - Issue 005</a></li>
<li><a href="../211150/index.html">MMU in pictures (part 1)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>