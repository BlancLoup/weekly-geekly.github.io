<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sberbank or round trip</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CHAPTER 1. Unexpected guests. 
 It all started on that ill-fated morning, when the Project Manager announced that the project timeline should be quick...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sberbank or round trip</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/si/bq/2u/sibq2unjy0i1yoy_7sa0qljphae.jpeg"><br><br><h2>  CHAPTER 1. Unexpected guests. </h2><br>  It all started on that ill-fated morning, when the Project Manager announced that the project timeline should be quickly and decisively reduced by a month.  More precisely, the project should be ready in 4 days.  No, our PO is not a beast, and not at all like an <a href="https://twitter.com/toonsxander/status/1069105064529268737">owl</a> (except a little bit like a crow), it just happened.  Well, if it is necessary, it is necessary, especially since the team (and I am the leading developer of the ‚ÄúC‚Äù team) was promised something tasty.  The clock and calendar was Thursday, 11:00, by Monday the project should be ready. <br><br>  To begin with, what we do.  We are engaged in cinema automation - automatic and remote control of equipment, cinema automation, monitoring, video panels, and now also ticket and bar sales terminals.  Specifically, the last point and is devoted to this article. <br><a name="habracut"></a><br>  The project itself, which had to be completed before Monday, is a kind of layer between the main server on Scala and the iron payment terminal VeriFone VX 820 (in fact, there are more terminals, but for example we take only it).  It is clear that no one will give us transactions just like that through him, therefore utilities and libraries of Sberbank / Arcus and UCS are used.  Thus, the scheme of work in the end should be as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/ak/k4/do/akk4do9scie61w_tobeuwpk6liu.png"><br><br>  Outwardly, it looks like this: <br><br><img src="https://habrastorage.org/webt/oh/ul/ts/ohultstzocyw8za06mbxqwmnrma.jpeg"><br><br>  Also, this subsystem should be used on standard cash register machines that are all seen in any cinema at the cashiers. <br><br>  According to internal tradition, we call each project of our team a name from the Norse mythology, the name Gefjon was chosen for this subsystem - the name of the goddess of fertility and abundance (a good name for a payment server, isn't it? Well, the legend about bulls cutting off the island ideally falls on the current architecture, cutting off work with equipment from a high-level language). <br><br>  The format of incoming and outgoing messages is an HTTP server with JSON load.  This is the best compromise between Scala, which is difficult to descend to isolating binary data from socket-threads and C, which is difficult to rise to transfer objects through the network.  There are not so many possible operations that need to be operated on: payment, cancellation, refund, various types of reports, opening the service menu and ping.  It looks nothing complicated.  Since there are three banking systems (and the completion of the family is expected later), it was decided to divide the project into components: <br><br><img src="https://habrastorage.org/webt/rk/vm/sc/rkvmscw9ret9atfnts-nezxtaqg.png"><br><br>  Green painted blocks that we needed to do, blue - those that can not be changed and that the bank provides. <br><br>  Since the main problems arose only with software from Sberbank, the article as a whole will be devoted to the pitfalls that we recounted with our rook. <br><br><h2>  CHAPTER 2. Lamb Roast </h2><br><img src="https://habrastorage.org/webt/zr/-d/ez/zr-dez83p56hekuceyiiqka2rdi.jpeg"><br>  (photo: heaclub.ru) <br><br>  ... looks like this.  The code of the prototype, which was written a few months ago to make it clear to all superiors, that we can work with banking applications, looked just like that. <br><br><pre><code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buf[BUF_KB * <span class="hljs-number"><span class="hljs-number">2</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * null; <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> * grep; <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT char * ptr; null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"nul"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"findstr"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">else</span></span></span><span class="hljs-meta"> null = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"/dev/null"</span></span></span><span class="hljs-meta">; grep = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"grep"</span></span></span><span class="hljs-meta">; #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> sprintf(buf, </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"%s %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"= %sops.ini &gt;%s 2&gt;%s || "</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"echo %"</span></span></span><span class="hljs-meta">PRIi32</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"=9,6,PINPAD_TEST &gt;&gt; %sops.ini"</span></span></span><span class="hljs-meta">, grep, TERM_ARCUS_TEST_PINPAD, TERM_PATH, null, null, TERM_ARCUS_TEST_PINPAD, TERM_PATH); #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> _WIN32_WINNT ptr = buf; while (*ptr) { </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (*ptr == </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'/'</span></span></span><span class="hljs-meta">) *ptr = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'\\'</span></span></span><span class="hljs-meta">; ptr++; } #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br>  It is clear that for the Production option it was no good, so it was necessary in essence to write everything anew. <br><br>  Each bank that provides libraries for working with the terminal usually provides two connection options: through the library functions (.so / .dll) or through a ready-made utility, which only needs to pass two values ‚Äã‚Äã‚Äî the type of operation and the amount (when needed).  In theory, nothing complicated, just <br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">char</span></span> buffer[<span class="hljs-number"><span class="hljs-number">100</span></span>]; <span class="hljs-built_in"><span class="hljs-built_in">sprintf</span></span>(buffer, <span class="hljs-string"><span class="hljs-string">"%d %d"</span></span>, atoi(argv[<span class="hljs-number"><span class="hljs-number">1</span></span>]), atoi(argv[<span class="hljs-number"><span class="hljs-number">2</span></span>])); system(buffer);</code> </pre> <br>  The result of the operation will be placed in the file ‚Äúe‚Äù, and the slip-check - in the file ‚Äúp‚Äù.  Just send these files to stdout with conversion to JSON, so that the HTTP server simply sends them up as payload without thinking about what is there. <br><br>  But this article would not have been published if everything was so simple. <br><br><h2>  CHAPTER 4. Through the mountain and under the mountain </h2><br>  The initial implementation was a simple application call ‚Äî the HTTP server called the necessary wrapper with unified parameters (for example, the X report was 4), and the utility, for example, gfj_pilot, ran sb_pilot with the parameter required for this operation (for example, the X report was 9) .  Then the utility wrapper read from the e-file the result of the operation (for example, 2000 - ‚Äúpayment failure, repeat the operation‚Äù) and converted it into a universal error (for example, 3 - ‚ÄúError reading or processing the card / account, repeat the operation‚Äù).  After that, the ‚Äúp‚Äù file was converted to base64 to avoid formatting and sent along with the result to stdout as JSON. <br><br>  All this worked fine, until one day we were informed that ... <br><br>  ... it does not work under Windows. <br><br><img src="https://habrastorage.org/webt/yp/44/t_/yp44t_qwokissyt75mayl71mcdm.jpeg"><br><br>  Well, more precisely, Windows itself has no problems (except that the slip is generated in Cp-1251 encoding, and the console works in CP866).  Just did not generate the "e" file.  We launched the banking utility directly: <br><br><pre> <code class="plaintext hljs">C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 01.02.2019 16:51 91 646 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 20  5 659 718  2  37 567 004 672   #    (1)  10  (1000 ) C:\banks\sber\sb_pilot&gt;loadparm.exe 1 1000 C:\banks\sber\sb_pilot&gt;dir    C   .   : B401-6B9D   C:\banks\sber\sb_pilot 04.02.2019 12:28 &lt;DIR&gt; . 04.02.2019 12:28 &lt;DIR&gt; .. 04.02.2019 12:28 216 commerr.log 31.01.2019 17:12 10 832 F12X24.BIN 31.01.2019 17:12 128 000 gate.dll 31.01.2019 17:12 72 192 loadparm.exe 31.01.2019 17:12 36 204 OPT0.R 31.01.2019 17:12 20 716 OPT1.R 31.01.2019 17:12 1 806 OPT3.R 01.02.2019 18:51 1 349 p 31.01.2019 17:12 388 608 pilot_nt.dll 31.01.2019 23:06 463 pinpad.ini 31.01.2019 17:12 91 136 posScheduler.exe 31.01.2019 17:12 418 printers.ini 04.02.2019 12:28 92 218 sbkernel1902.log 31.01.2019 17:12 653 312 sbrf.dll 31.01.2019 17:12 840 192 SBRFCOM.dll 31.01.2019 17:12 3 142 656 sb_kernel.dll 01.02.2019 16:51 9 SESS.D 01.02.2019 16:51 715 SPLC.D 31.01.2019 17:12 72 192 upwin.exe 19  5 659 029  2  37 567 008 768   C:\banks\sber\sb_pilot&gt;</code> </pre> <br>  Indeed, there is no ‚Äúe‚Äù file.  Stone in the direction of Sberbank # 1.  We are writing a letter to the Savings Bank (later we received the answer that this should be so), and since there is no time for correspondence and we need to start right now, we are looking for workarounds for obtaining the result. <br><br><pre> <code class="plaintext hljs">04.02 12:28:55 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Failed to open device \\.\COM1, err 2 04.02 12:28:56 SBKRNL: Result = 0 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 GATE: lock:'00000054' 'UPOSWINMUTEX2' 04.02 12:28:56 GATE: unlock:'00000054' 04.02 12:28:56 LOADPARM: Unloading GATE.DLL... 04.02 12:28:56 GATE: SB_KERNEL.DLL is unloaded 04.02 12:28:56 LOADPARM: GATE.DLL unloaded</code> </pre> <br>  Yeah, the result can be obtained from the log sbkernelGGMM.log.  It‚Äôs inconvenient, plus there isn‚Äôt a card hash to subsequently tie up ‚ÄúThank you‚Äù from the savings bank.  No good. <br><br>  You will have to connect to the pilot_nt.dll library and import functions from it.  Everything would be fine, but ... Stone towards Sberbank # 2: under Linux there is no such library, you will have to create two different applications for different platforms - for linux you need to call the utility sb_pilot (analog loadparm.exe, by the way stone # 3 for the different name of the utility under different platforms ) under windows connect to pilot_nt.dll library. <br><br><h2>  CHAPTER 5. Riddles in the dark </h2><br>  On the clock 19:00. <br><br>  Sberbank is a large company, most software solutions are manufactured according to GOST and formal documents.  We climb into the catalog that Sberbank supplies with libraries: <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs  30160 drwx------ 2 alex alex 4096  17 19:31 FAQ -rw-rw-r-- 1 alex alex 3398465  9 2018   UPOS    ().docx -rw-rw-r-- 1 alex alex 1182078  9 2018   UPOS  .docx -rw-rw-r-- 1 alex alex 853504  9 2018   .doc drwx------ 3 alex alex 4096  31 17:11     -rw-rw-r-- 1 alex alex 5280787  9 2018    POS-.docx -rw-rw-r-- 1 alex alex 1149640  9 2018  .docx drwx------ 2 alex alex 4096  28 2018  UPOS drwx------ 2 alex alex 4096  28 2018    -rw-rw-r-- 1 alex alex 3451601  9 2018     ().docx -rw-rw-r-- 1 alex alex 1956196  9 2018   .docx -rw-rw-r-- 1 alex alex 1043161  9 2018       ()_().docx -rw-rw-r-- 1 alex alex 4348157  9 2018  POS-.docx -rw-rw-r-- 1 alex alex 3970267  9 2018   .docx drwx------ 3 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 2644702  9 2018    POS-.docx drwx------ 2 alex alex 4096  28 2018   -rw-rw-r-- 1 alex alex 1558211  9 2018   .png</code> </pre> <br>  A lot of good, but we are only interested in the directory for developers: <br><br><pre> <code class="plaintext hljs">Sberbank$ ls -l Docs/\ \ \ /  8704 -rw-rw-r-- 1 alex alex 47105  9 2018 1C.docx -rw-rw-r-- 1 alex alex 1824  9 2018 cardtype.h -rw-rw-r-- 1 alex alex 2590378  9 2018 cr_ttk_protocol_ru.rtf -rw-rw-r-- 1 alex alex 208  9 2018 deprtmnt.h -rw-rw-r-- 1 alex alex 16681  9 2018 errors.h drwx------ 6 alex alex 4096  28 2018 examples -rw-rw-r-- 1 alex alex 58575  9 2018 gate.h -rw-rw-r-- 1 alex alex 4218  9 2018 paramsln.h -rw-rw-r-- 1 alex alex 61693  9 2018 pilot_nt.h -rw-rw-r-- 1 alex alex 28160  9 2018 ReadTrack2.doc -rw-rw-r-- 1 alex alex 7417  9 2018 sbkernel.h -rw-rw-r-- 1 alex alex 144896  9 2018 sb_pilot.doc -rw-rw-r-- 1 alex alex 3525323  9 2018     ole- sbrf.dll.rtf -rw-rw-r-- 1 alex alex 46683  9 2018      gate.dll.chi -rw-rw-r-- 1 alex alex 255414  9 2018      gate.dll.chm -rw-rw-r-- 1 alex alex 814653  9 2018      gate.dll.pdf -rw-rw-r-- 1 alex alex 41618  9 2018      pilot_nt.chi -rw-rw-r-- 1 alex alex 241716  9 2018      pilot_nt.chm -rw-rw-r-- 1 alex alex 968753  9 2018      pilot_nt.pdf -rw-rw-r-- 1 alex alex 81  9 2018  .txt</code> </pre> <br>  A lot of waste paper, just in case, once again reread pilot_nt, from which we learn the following: <br><blockquote>  Table 1. Supported sb_pilot OS. <br><div class="scrollable-table"><table><tbody><tr><th>  OS </th><th>  Digit </th><th>  Module name </th></tr><tr><td>  Windows </td><td>  32 </td><td>  sb_pilot.exe </td></tr><tr><td>  Linux </td><td>  32 </td><td>  sb_pilot </td></tr><tr><td>  Dos </td><td>  sixteen </td><td>  sb_pilot.exe </td></tr></tbody></table></div></blockquote><br>  It turns out the utility under windows should still be called sb_pilot.  Well, a stone in the direction of Sberbank # 4 for the discrepancy of its own documentation. <br><blockquote>  Transfer the results of the program. <br><br>  At the end of the program, two text files are created - the exchange file and the check file. <br><br>  The first is named e and is intended to pass the parameters of the operation to the calling program.  The first line in this file contains the result code of the operation, and a comma-separated explanatory text message.  Code 0 means successful payment, any other value - refusal or impossibility of payment. </blockquote><br><br><img src="https://habrastorage.org/webt/c8/7f/m2/c87fm26nwcdjtfol6m0vamuvk8e.jpeg"><br><br>  Lazily we throw another stone and begin to study the documentation for connecting the library directly. <br><blockquote>  <b>The order of the functions of the library</b> <br><br>  When paying (returning) a purchase with a bank card, the cash program should call the function card_authorize () from the Sberbank library by filling in the TType and Amount fields and specifying zero values ‚Äã‚Äãin the other fields.  At the end of the function, it is necessary to analyze the RCode field.  If it contains the value "0" or "00", the authorization is considered successful, otherwise rejected.  In addition, you need to check the value of the Check field. <br><br>  If it is not NULL, it must be sent to print (in non-fiscal mode) and then <br>  delete by calling the GlobalFree () function.  When closing the shift, the cash program should call the close_day () function from the Sberbank library by filling in the TType = 7 field and specifying zero values ‚Äã‚Äãin the remaining fields.  Upon completion of the function, you must check the value of the Check field. <br><br>  If the Check field is not NULL, it must be sent to print (in non-fiscal mode) and then deleted by calling the GlobaFree () function. </blockquote>  It sounds easy, even a header file is provided.  Well, we connect it, we compile and ... <br><br><pre> <code class="cpp hljs">$ cat main.c &amp;&amp; i686-w64-mingw32-gcc main.c -o main.a <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"pilot_nt.h"</span></span></span><span class="hljs-meta"> int main(void) { return 0; } In file included from main.c:1:0: pilot_nt.h:525:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:544:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:567:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:590:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:627:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span><span class="hljs-meta"> ^ pilot_nt.h:668:3: </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">error</span></span></span><span class="hljs-meta">: unknown type name </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">'auth_answer'</span></span></span><span class="hljs-meta"> auth_answer ans; </span><span class="hljs-comment"><span class="hljs-meta"><span class="hljs-comment">/**&lt; [in, out]                            .   . ::auth_answer */</span></span></span></span></code> </pre> <br>  Ummm ... What?  Open pilot_nt.h: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">ifdef</span></span></span><span class="hljs-meta"> __cplusplus extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta">{ #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;...&gt; /** *    * ,         . */ struct auth_answer{ int TType; /**&lt; [in]  .  ::OpetationTypes */ unsigned long Amount; /**&lt; [in]    */ char RCode[3]; /**&lt; [out]    */ char AMessage[16]; /**&lt; [out]    */ int CType; /**&lt; [in,out]   */ char* Check; /**&lt; [out]  ,   GlobalFree    */ }; &lt;...&gt; struct auth_answer7{ auth_answer auth_answ; /**&lt; [in, out]   . . ::auth_answer */ &lt;---- THIS char AuthCode[MAX_AUTHCODE]; /**&lt; [out]  . 7 . */ char CardID [CARD_ID_LEN]; /**&lt; [out]  . 25 . */ int SberOwnCard; /**&lt; [out]     */ };</span></span></span></span></code> </pre> <br>  Immediately, without looking at the stone for comments in Russian encoded in CP1251. <br><br>  Well, the most serious stone: dear C ++ developers.  If you write extern "C" - this means that the code inside the block must be compiled by the C-compiler.  If you have NOT made a `typedef` structure, then each time it is mentioned as a type indication, you must write the` struct` keyword. <br><br>  Patches a file for developers, substituting wherever the word `struct` is needed.  Link to the `pilot_nt.dll` library.  Victory, no?  Run our application. <br><br><h2>  CHAPTER 6. From fire to the fire </h2><br>  Well, you understand, right?  The app just crashes.  Immediately, before the main.  We meditate; we add the NIH analogue of the errno function for windows: GetLastError (stone # 3 towards Microsoft, the first two for encodings). <br><br><pre> <code class="plaintext hljs">C:\banks\sber\WIN&gt;sb_pilot.exe 1 1000 E: !g_sblibrary (0xc0000096)</code> </pre> <br>  0xc0000096?  Shouldn't GetLastError return an adequate error code? <br><blockquote>  For a complete list of error codes, see System Error Codes. </blockquote>  Yeah, open the article at the <a href="https://docs.microsoft.com/ru-ru/windows/desktop/Debug/system-error-codes">link</a> : <br><blockquote>  The following topics provide lists of system error codes.  These values ‚Äã‚Äãare defined in the WinError.h header file. <br><br><ul><li>  System Error Codes (0-499) (0x0-0x1f3) </li><li>  System Error Codes (500-999) (0x1f4-0x3e7) </li><li>  System Error Codes (1000-1299) (0x3e8-0x513) </li><li>  System Error Codes (1300-1699) (0x514-0x6a3) </li><li>  System Error Codes (1700-3999) (0x6a4-0xf9f) </li><li>  System Error Codes (4000-5999) (0xfa0-0x176f) </li><li>  System Error Codes (6000-8199) (0x1770-0x2007) </li><li>  System Error Codes (8200-8999) (0x2008-0x2327) </li><li>  System Error Codes (9000-11999) (0x2328-0x2edf) </li><li>  System Error Codes (12000-15999) (0x2ee0-0x3e7f) </li></ul></blockquote>  Great, we got an undocumented error, throw a stone and open the all-knowing google: <br><br><ul><li>  <a href="http://forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%25D0%25BE%25D1%2582%25D0%25BB%25D0%25B0%25D0%25B4%25D0%25BA%25D0%25B0.html">forum.vingrad.ru/forum/topic-346194/kw-dll-loadlibrary-%D0%BE%D1%82%D0%BB%D0%B0%D0%B4%D0%BA%D0%B0.html</a> </li><li>  <a href="https://bbs.csdn.net/topics/80078275">bbs.csdn.net/topics/80078275</a> </li><li>  <a href="http://forums.codeguru.com/showthread.php%3F179566-0xC0000096-Privileged-Instruction">forums.codeguru.com/showthread.php?179566-0xC0000096-Privileged-Instruction</a> </li><li>  <a href="https://www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html">www.unknowncheats.me/forum/general-programming-and-reversing/97763-privileged-instruction-error.html</a> </li><li>  <a href="https://cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html">cboard.cprogramming.com/windows-programming/146130-prallel-port-programming.html</a> </li><li>  <a href="http://computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm">computer-programming-forum.com/82-mfc/dc2481c0ecead2f2.htm</a> </li></ul><br>  The essence of the error is that some subroutine uses one of the instructions. <br><br><ul><li>  _inp () </li><li>  _inpw () </li><li>  _inpd () </li><li>  _outp () </li><li>  _outpw () </li><li>  _outpd () </li></ul><br>  The use of which is prohibited under NT-cores, as they are trying to work with the parallel port directly.  Apparently, this code is called in the library initializer, i.e.  the library at startup wants to poll the ports for the presence of devices, but the NT core requires work through the driver. <br><br>  Hopeless situation? <br><br><h2>  CHAPTER 8. Spiders and flies </h2><br>  22:00  Just in case, the idea arises to check that this is not due to the fact that we are using cross-compilation with Linux using mingw.  At the same time, we understand that Sberbank supplies only a 32-bit application, so linking with a 64-bit application will not work, okay, but we still run the stone in the direction of Sberbank for the 32-only version in 2019m. <br><br>  <b>It is given</b> : installed in virtualbox windows 7; <br>  <b>Necessary</b> : install Visual Studio and copy MVP. <br><br>  We go to the Microsoft website, download Visual Studio 2017. We take a community license, as we take it for verification, for business a license will be purchased if it takes off. <br>  Download a few hundred megabytes and ... <br><br>  We see that our version of the OS (Windows 7) is not supported. <br><br>  Ok, we go to all sorts of obscene sites, we are looking for Visual Studio 2008, download a few hundred megabytes again and ... <br><br>  Get the iso file. <br><br>  Okay, let's try to install Daemon Tools 10 (as this is the version that the site offers) to insert this virtual disk. <br><br>  Run the downloaded binary.  Misfire, requires .NET Framework 4.5, download, set. <br>  We launch the downloaded binary, the installation has begun, the bootloader says that it needs 4.5.2, download, install. <br>  We launch the downloaded binary, the installation has begun, the bootloader says that it will not go anywhere until we install security update KB3033929, download, install. <br><br>  And we get a slap in the face from Microsoft in the form of a message: <br><br><img src="https://habrastorage.org/webt/r6/qe/de/r6qedenl5w3dez4ysscvod8rmjw.png"><br><br>  We violently throw a very sharp stone in the direction of Microsoft, download the old Daemon Tools from the torrents, successfully unpack Visual Studio, install, finally (00:00) compile MVP, we get the same error.  Well, the version was good, but it didn't grow together. <br><br><h2>  CHAPTER 11. On the threshold </h2><br>  We write to the second programmer, who at this moment urgently completes the server and the registration procedure.  He recalls that there is a git <a href="https://github.com/vyacheslafka/sb_pilot_nt">repository</a> that on the NT connects this library and works with it. <br><br>  Suspiciously looking at the repository, download it, compile and run.  Works. <br><br><img src="https://habrastorage.org/webt/mt/gl/q-/mtglq-c68eyegv74wjnzjvpmddi.png"><br><br>  Look at the code even more suspiciously.  The code is identical, except that it is written in C ++ and not C. <br>  We understand that the language has nothing to do with it.  We look at the Sberbank libraries, which are pulling code behind them. <br>  We see the last commit. <br><br>  And here we are waiting for another surprise. <br><br>  It turns out that the versions of the Sberbank library may be different.  The last commit increases the version from 23 to 27.  We copy to our test computer the version from the book - WORKS! <br><br>  We check all the archives sent by Sberbank, compare versions and build a label: <br><div class="scrollable-table"><table><tbody><tr><th>  Version </th><th>  Works </th></tr><tr><td>  26.0.15 - Basic </td><td>  not </td></tr><tr><td>  27.4.12 - From the repository </td><td>  Yes </td></tr><tr><td>  23.0.13 - From the repository </td><td>  Yes </td></tr><tr><td>  29.0.9 - The latest from the Security Council </td><td>  Yes </td></tr><tr><td>  23.0.13 - With the patch for the system "Crypter" </td><td>  Yes </td></tr></tbody></table></div><br>  Ok, now we will live.  On those systems where it costs 26, we will upgrade to 29 or 27 and everything will take off. <br>  We throw a stone # 9 in the direction of Sberbank for having broken behavior on NT systems. <br><br><h2>  CHAPTER 12. What was waiting for them inside </h2><br>  Not enough "e" file?  It does not matter, we take patched headers, we dynamically link with the library to correctly return an error, write a code that simply writes the return code from the function to the file ‚Äúe‚Äù, let's call the binary sb_pilot.exe and ... <br><br>  To work it works. <br><br>  That's just the version for the system "Kriptera" does not create a "p" file. <br><br>  <i>Sad look at the dripping blood on the knuckles and on the dent in the wall.</i> <br><br>  To begin with, what is the system "Kriptera." <br><br>  Cryptera is a Danish company that produces encryption equipment / security equipment / keys, etc. I think you all saw one of the copies of their products: <br><br><img src="https://habrastorage.org/webt/pb/dz/85/pbdz85atzxiscdkdkq0z97ahhsm.png"><br><br>  So, Sberbank uses their crypto module for pinpads and releases a special ‚Äúpatched‚Äù library, in which, as we already understood, the file ‚Äúp‚Äù is not created.  We write about this in Sberbank and in a few days we will receive the answer that ‚Äúunder the original system, the file‚Äú p ‚Äùwill be created, but under the patched system on the Crypter - no‚Äù.  We'll give them a stone # 10 in a few days, because you need to work now. <br><br>  Fortunately, or unfortunately, the functions that we use to conduct operations return the structure already mentioned: <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer</span></span></span><span class="hljs-class">{</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br>  Oh, great, the check is already there, we can save it to a file on our own or directly output it to JSON <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, answer.Check);</code> </pre> <br>  And we get the crash of the application due to treatment by invalid pointer. <br><br><h2>  CHAPTER 14. Fire and Water </h2><br>  4:00  We carry out Seth Bandha Sarvangasana to calm down, and carefully read the manual: <br><blockquote>  [out] check image, GlobalFree should be released in the calling program </blockquote>  What does this give us?  A lot of things.  First, once the pointer needs to be cleaned with GlobalFree, it is sallocated with <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winbase/nf-winbase-globalalloc">GlobalAlloc</a> .  Therefore, it does not issue a pointer to memory, as it was in the 16bit version, but an object number with the semantically declared type HGLOBAL, which can be fed in the GlobalSize function to get the size of the selected block and GlobalLock to block the piece of memory, but get the original pointer.  By the way, Stone # 6 in the direction of Microsoft for NIH malloc and free, which are in the standard library. <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%s\n"</span></span>, GlobalLock(answer.Check));</code> </pre> <br>  And still get the fall.  Okay, so what is GlobalSize?  Zero?  Kind of weird. <br><br>  We check other functions that should also give a slip - we see the same picture. <br><br>  It comes to mind that it is possible to independently generate a slip according to the data that the coolest payment function can issue (yes, Sberbank‚Äôs functions are called card_authorize2..14, I won‚Äôt throw a stone for it): <br><br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">auth_answer14</span></span></span><span class="hljs-class"> {</span></span> auth_answer ans; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]   . . ::auth_answer */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AuthCode[MAX_AUTHCODE]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 7 . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardID[CARD_ID_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . 25 .     ,   6   4,    '*'.*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> ErrorCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> TransDate[TRANSDATE_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TransNumber; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    . , .    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> SberOwnCard; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Hash[CARD_HASH_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in, out]  SHA1   ,   ASCII     . 40 .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> Track3[CARD_TRACK3_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]   */</span></span> DWORD RequestID; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   .  PCI DSS .*/</span></span> DWORD Department; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     0  14-, .      0xFFFFFFFF,          .        ,      4191. */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RRN[MAX_REFNUM]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   ,  .    ,     .   12-  .       (   pilot_nt.dll),     ‚Äì  (     ;     ,   ).*/</span></span> DWORD CurrencyCode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    (810, 643, 840, 978  ..) */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardEntryMode; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    ('D'-., 'M'- , 'C'-, 'E'- EMV, 'R'- magstripe, 'F'-fallback)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> CardName[MAX_CARD_NAME_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AID[MAX_AID_ASCII_LEN]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out] Application ID   (   ASCIIZ-)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> FullErrorText[MAX_FULL_ERROR_TEXT]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]     */</span></span> DWORD GoodsPrice; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    ,  (34.99-&gt;3499)*/</span></span> DWORD GoodsVolume; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  ,  .  (30.234-&gt;30234)*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsCode[MAX_GOODS_CODE+<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     .*/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> GoodsName[MAX_GOODS_NAME]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]     . !   auth_answer14         gate.dll TGoodsData.     */</span></span> }; <span class="hljs-comment"><span class="hljs-comment">/** @brief     * @param[in] track2      .  NULL,     . * @param[in,out] auth_answer . ::auth_answer14 * @param[in,out] payinfo     * @return int  . */</span></span> <span class="hljs-function"><span class="hljs-function">PILOT_NT_API </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">card_authorize14</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">char</span></span></span></span><span class="hljs-function"><span class="hljs-params"> *track2, struct auth_answer14 *auth_answer, struct payment_info_item *payinfo )</span></span></span></span>;</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We try to select fields ... We find out that only one thing separated us from happiness - the Last Name and First Name of the card carrier. </font><font style="vertical-align: inherit;">Without them, a slip is not considered </font></font><a href="http://www.consultant.ru/cons/cgi/online.cgi%3Freq%3Ddoc%26base%3DLAW%26n%3D175637%26rnd%3D8BB65931EED9BDFCF1D781478730CD71"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">legal</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Details: ID of an ATM, electronic terminal or other technical device intended for making transactions using payment cards; </font><font style="vertical-align: inherit;">type of operation; </font><font style="vertical-align: inherit;">transaction date; </font><font style="vertical-align: inherit;">transaction amount; </font><font style="vertical-align: inherit;">currency of operation; </font><font style="vertical-align: inherit;">amount of commission authorization code; </font><font style="vertical-align: inherit;">payment card details.</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is a pity, but to form a legitimate slip with the data that we have will fail. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will rummage in the documentation once again. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Find an example that Sberbank supplies in the ‚Äúexamples‚Äù directory</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Authorization completion finished with code '"</span></span> &lt;&lt; result &lt;&lt; <span class="hljs-string"><span class="hljs-string">"'"</span></span> &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-function"><span class="hljs-function">ofstream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">file</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(CHEQUE_FILENAME)</span></span></span></span>; file &lt;&lt; argument.auth_answ.Check; file.close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (argument.auth_answ.Check) { <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">cout</span></span> &lt;&lt; <span class="hljs-string"><span class="hljs-string">"Cheque saved to file "</span></span> &lt;&lt; CHEQUE_FILENAME &lt;&lt; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">endl</span></span>; <span class="hljs-comment"><span class="hljs-comment">//GlobaFree(argument.auth_answ.Check); }</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Just displays the text, located on the index. </font><font style="vertical-align: inherit;">But after all, we have already seen that it does not work like this ... Just in case, let's compile their example and run. </font><font style="vertical-align: inherit;">Departure at the line `file &lt;&lt; argument.auth_answ.Check;`, well, Sberbank, hold the stone # 11 for non-working examples. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Seven o'clock </font><font style="vertical-align: inherit;">You can already write to the developers of another wrapper, which several years ago was written in Delphi. </font><font style="vertical-align: inherit;">We get the answer that everything works for them. </font><font style="vertical-align: inherit;">We look for the basis of their wrappers and find it on </font></font><a href="https://github.com/kutsoff/pilot_nt.sberbank"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">github</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> :</font></font><br><br><pre> <code class="cpp hljs">TAuthAnswer = packed record TType: integer; Amount: UINT; <span class="hljs-comment"><span class="hljs-comment">// IN     Rcode: array [0 .. 2] of AnsiChar; AMessage: array [0 .. 15] of AnsiChar; CType: integer; Check: PAnsiChar; end; Result := Func(nil, @FAuthAnswer); FLastError := Result; FCheque := PAnsiChar(FAuthAnswer.Check);</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Simple type conversion to pointer without any function calls. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We begin to suspect evil spirits.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CHAPTER 17. Thunderstorm erupted. </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">People are starting to return to the office, nodding sympathetically. </font><font style="vertical-align: inherit;">PO doesn‚Äôt look very funny after hearing the latest news. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here I recall one detail. </font><font style="vertical-align: inherit;">When we displayed the fields of structure # 14 to see their values, then one byte of each line was cut off. </font><font style="vertical-align: inherit;">On the one hand it is, on the other</font></font><br><blockquote>  Attention!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the auth_answer14 structure, the product name is one character shorter than the gate.dll TGoodsData. </font><font style="vertical-align: inherit;">Fix this error as standard</font></font></blockquote><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Maybe this is still connected with ... A </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">terrible guess overshadows the brain like lightning. </font><font style="vertical-align: inherit;">We declare the structure as</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">typedef</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> __</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">attribute__</span></span></span><span class="hljs-class">((</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">packed</span></span></span><span class="hljs-class">)) {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> TType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]  .  ::OpetationTypes */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> Amount; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> RCode[<span class="hljs-number"><span class="hljs-number">3</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> AMessage[<span class="hljs-number"><span class="hljs-number">16</span></span>]; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]    */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CType; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [in,out]   */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* Check; <span class="hljs-comment"><span class="hljs-comment">/**&lt; [out]  ,   GlobalFree    */</span></span> };</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And ... </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Nothing changes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All the same Size = 0, Still Lock = NULL. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Pain. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Ashes. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Involuntarily you are looking for a comfortable beam on the ceiling with your eyes, such as to withstand the weight. After so many non-stop hours of coding and studying the documentation, slender rows of bytes float before your eyes. And what if the output bytes, which are generally returned?</font></font><br><br><pre> <code class="cpp hljs"> u32 i; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(answ); i++) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%02x "</span></span>, *((u8 *)&amp;answ + i)); } <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"\n"</span></span>); C:\banks\sber\sb_pilot&gt;sb_pilot.exe <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">1000</span></span> <span class="hljs-number"><span class="hljs-number">01</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> e8 <span class="hljs-number"><span class="hljs-number">03</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> ce e4 ee e1 f0 e5 ed ee <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">02</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span> f8 <span class="hljs-number"><span class="hljs-number">6</span></span>c <span class="hljs-number"><span class="hljs-number">7</span></span>a <span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">00</span></span></code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">`30 00 00 ce` - which means that Sberbank still uses Packed structures. </font><font style="vertical-align: inherit;">That's just in the headers about this is not a word. </font><font style="vertical-align: inherit;">Therefore, the examples do not work, so it is impossible to get a pointer to the text at the end - because it is broken due to a shift of 1 byte. </font><font style="vertical-align: inherit;">A huge and spiny stone in the direction of Sberbank! </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And then one maaaalen little thing caught my eye. </font><font style="vertical-align: inherit;">4 + 4 + 3 + 16 + 4 + 4 = 35. And then there are 36 bytes, Obelix. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Once it is 36 bytes, the compiler still aligns the structure. </font><font style="vertical-align: inherit;">So an extra byte is still inserted between RCode and AMessage. </font><font style="vertical-align: inherit;">But why? </font><font style="vertical-align: inherit;">After all, we specified `__packed__`!</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CHAPTER 18. Return journey </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The reasons that the alignment is still included appeared in 2012: </font></font><a href="https://gcc.gnu.org/bugzilla/show_bug.cgi%3Fid%3D52991"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">https://gcc.gnu.org/bugzilla/show_bug.cgi?id=52991</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font><font style="vertical-align: inherit;">A bug was fixed only in GCC 8 (a stone for 6 years of failure!), Which is not yet possible to upgrade to. </font><font style="vertical-align: inherit;">Fortunately, there is a workaround:</font></font><br><br><pre> <code class="cpp hljs">-mno-ms-bitfields</code> </pre> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">We will not now disassemble the mechanism of this flag, just give it to the compiler: </font></font><br><br><img src="https://habrastorage.org/webt/ve/tr/d4/vetrd4m4rsdhmkyxkgrvxbkepko.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Slip! </font><font style="vertical-align: inherit;">Darling! </font><font style="vertical-align: inherit;">I missed you, I will not even swear because of krakozyabr, I already threw a stone for it. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And finally, we‚Äôll feed a stone to Microsoft, for giving GlobalSize / Lock zeroes to invalid pointers.</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CHAPTER 19. The Last Chapter </font></font></h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">To minimize the number of ifdefs for the sb_pilot interlayer, we wrote a separate application that completely simulates the linux version of sb_pilot. </font><font style="vertical-align: inherit;">Thus, leaving the code of layer # 1 the same, leaving only one condition:</font></font><br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> defined(BXI_OS_GLX) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">elif</span></span></span><span class="hljs-meta"> defined(BXI_OS_WIN) #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> GFJ_PILOT_EXECUTABLE </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"./sb_pilot.exe"</span></span></span><span class="hljs-meta"> #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">endif</span></span></span></span></code> </pre> <br><img src="https://habrastorage.org/webt/wo/eu/2g/woeu2gk8m1mvtibiepfxwiijrbo.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Battle results: </font></font><br><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Sberbank: 12 stones </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Microsoft: 7 stones </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> GCC: 1 stone </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Achivka memory on our command board: </font></font><br><br><img src="https://habrastorage.org/webt/ko/im/3y/koim3ykfftmlltegcqh_rkdkgxc.jpeg"></div><p>Source: <a href="https://habr.com/ru/post/451188/">https://habr.com/ru/post/451188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../451178/index.html">Accident when testing the Crew Dragon parachute landing system</a></li>
<li><a href="../451180/index.html">PCB replaces two linear motors</a></li>
<li><a href="../451182/index.html">How the dimensions of C arrays became part of the library's binary interface</a></li>
<li><a href="../451184/index.html">Blue Origin Blue Origin Project: People on the Moon by 2024</a></li>
<li><a href="../451186/index.html">LINSTOR repository and its integration with OpenNebula</a></li>
<li><a href="../451196/index.html">Separation of customer profiles and freelancer</a></li>
<li><a href="../4512/index.html">Google is interested in weddings</a></li>
<li><a href="../451204/index.html">Free text editors for collaboration</a></li>
<li><a href="../451206/index.html">What is happening with RDF repositories?</a></li>
<li><a href="../451208/index.html">"Topological" sorting graph with cycles</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>