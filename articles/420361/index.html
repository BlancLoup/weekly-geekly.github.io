<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Bug when working TextBox.GetLineText in .NET WPF</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There are many different tools for conducting research on the operation of programs and operating systems. Virtual machines, IDE, smart notebooks, IDA...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Bug when working TextBox.GetLineText in .NET WPF</h1><div class="post__text post__text-html js-mediator-article">  There are many different tools for conducting research on the operation of programs and operating systems.  Virtual machines, IDE, smart notebooks, IDA, radare, hex editors, pe editors, and even more than a hundred Sysinternals utilities are all done to facilitate many routine operations.  But sometimes a moment comes when you realize that among all this variety you lack a small utility that just does the banal and simple work.  You can write scripts on python or Powershell on your knee, but often you can‚Äôt look at such crafts without tears and share it with your colleagues. <br><br>  Recently, this situation has come to me again.  And I decided it was time to just take and write a neat utility.  I will tell you about the utility itself in one of the upcoming articles, but I‚Äôll tell you about one of the problems during development. <br><br>  The error manifests itself in the following way: if in a WPF application, sticking many lines of text into the standard TextBox control, then calls to the <i>GetLineText ()</i> function starting from a certain index will return incorrect lines. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/webt/lp/9r/yh/lp9ryh02toec7dfzs40ue4oqao0.png"></div><br>  The flaw is that even though the lines will be from the set text, but located further, in fact, <i>GetLineText ()</i> will simply skip some lines.  The error manifests itself with a very large number of lines.  So I met her - I tried to display 25 megabytes of text in TextBox.  Working with the latest lines revealed an unexpected effect. <br><br>  Google <a href="https://social.msdn.microsoft.com/Forums/sharepoint/en-US/e973795d-83a0-4abe-b9b9-ade2a8e485dc/textbox-problems-with-line-indices%3Fforum%3Dwpf">suggests that the error exists since 2011</a> and Microsoft is not particularly in a hurry to fix something. <br><a name="habracut"></a><br><h2>  <font color="orange">Example</font> </h2><br>  There are no requirements for the .NET version.  Create a standard WPF project and populate the files like this: <br>  MainWindow.xaml <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">x:Class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"wpf_textbox.MainWindow"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml/presentation"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:x</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/winfx/2006/xaml"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:d</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.microsoft.com/expression/blend/2008"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:mc</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://schemas.openxmlformats.org/markup-compatibility/2006"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:local</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"clr-namespace:wpf_textbox"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">mc:Ignorable</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"d"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Title</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"WTF, WPF?"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"350"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"525"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.RowDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"*"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">RowDefinition</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"20"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid.RowDefinitions</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TextBox</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Margin</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"5"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"txt"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AcceptsReturn</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"True"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">AcceptsTab</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"True"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Fire 1!"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn_OnClick"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Button</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Grid.Row</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Content</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Fire 2!"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">Click</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"btn2_OnClick"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Grid</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Window</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  MainWindow.cs (skipping using and namespace) <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">partial</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">MainWindow</span></span> : <span class="hljs-title"><span class="hljs-title">Window</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MainWindow</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { InitializeComponent(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btn_OnClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">90009</span></span>; i++) sb.AppendLine(<span class="hljs-string"><span class="hljs-string">$"</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">{i}</span></span></span><span class="hljs-string">"</span></span>); txt.Text = sb.ToString(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">btn2_OnClick</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, RoutedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; i++) sb.AppendLine(<span class="hljs-string"><span class="hljs-string">"req: "</span></span> + <span class="hljs-number"><span class="hljs-number">150</span></span> * i + <span class="hljs-string"><span class="hljs-string">", get: "</span></span> + txt.GetLineText(<span class="hljs-number"><span class="hljs-number">150</span></span> * i).Trim()); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; <span class="hljs-number"><span class="hljs-number">7</span></span>; i++) sb.AppendLine(<span class="hljs-string"><span class="hljs-string">"req: "</span></span> + <span class="hljs-number"><span class="hljs-number">15000</span></span> * i + <span class="hljs-string"><span class="hljs-string">", get: "</span></span> + txt.GetLineText(<span class="hljs-number"><span class="hljs-number">15000</span></span> * i).Trim()); txt.Text = sb.ToString(); } }</code> </pre><br>  The application consists of a TextBox and two buttons.  First, click ‚ÄúFire 1!‚Äù (Fill in the TextBox with numbers), then ‚ÄúFire 2!‚Äù (Ask for lines by numbers and output). <br><br>  Expected Result: <br><blockquote>  req: 150, get: 150 <br>  req: 300, get: 300 <br>  req: 450, get: 450 <br>  req: 600, get: 600 <br>  req: 750, get: 750 <br>  req: 900, get: 900 <br>  req: 15000, get: 15000 <br>  req: 30000, get: 30000 <br>  req: 45000, get: 45000 <br>  req: 60000, get: 60000 <br>  req: 75000, get: 75000 <br>  req: 90000, get: 90000 </blockquote><br>  Reality: <br><br><img src="https://habrastorage.org/webt/d7/6j/qq/d76jqqy-o9ve3ih_krtbrk7jj9a.png"><br><br>  It can be seen that for indexes less than 1000 - everything is fine, and for large 15,000 - shifts have begun.  And the further, the more. <br><br><h2>  <font color="orange">Investigate the bug</font> </h2><br>  We uncover that part of the resharper, which is responsible for viewing the .NET source code and the special class ‚ÄúExtender of capabilities and override of restrictions based on Reflection‚Äù <br><br><div class="spoiler">  <b class="spoiler_title">Extender of opportunities and override of restrictions on the basis of Reflection</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ReflectionExtensions</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T GetFieldValue&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> obj, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> name) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bindingFlags = BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> field = obj.GetType().GetField(name, bindingFlags); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (field == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) field = obj.GetType().BaseType.GetField(name, bindingFlags); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (T)field?.GetValue(obj); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">object</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokeMethod</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">this</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> obj, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> methodName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">params</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] methodParams</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> methodParamTypes = methodParams?.Select(p =&gt; p.GetType()).ToArray() ?? <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Type[] { }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bindingFlags = BindingFlags.NonPublic | BindingFlags.Public | BindingFlags.Instance | BindingFlags.Static; MethodInfo method = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> type = obj.GetType(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (method == <span class="hljs-literal"><span class="hljs-literal">null</span></span> &amp;&amp; type != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { method = type.GetMethod(methodName, bindingFlags, Type.DefaultBinder, methodParamTypes, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intfs = type.GetInterfaces(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> intf <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> intfs) { method = intf.GetMethod(methodName, bindingFlags, Type.DefaultBinder, methodParamTypes, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (method != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } type = type.BaseType; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> method?.Invoke(obj, methodParams); } }</code> </pre><br></div></div><br>  It is established experimentally that in a given example, the problem begins in the region of 8510 lines.  If you request <i>txt.GetLineText (8510)</i> , then ‚Äú8510‚Äù will return.  For 8511 - 8511, and for 8512 - suddenly, 8513. <br><br>  We look at the <i>TextBox GetLineText ()</i> implementation: <br><br><img src="https://habrastorage.org/webt/eg/xi/dh/egxidhjcehum7gie4b-kcks-8z8.png"><br>  We skip the checks in the first lines and see the call to <i>GetStartPositionOfLine ()</i> .  It seems that the problem should be in this function, because for the wrong line the wrong position of the beginning of the line should return. <br><br>  Call in your code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o00 = txt.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetStartPositionOfLine"</span></span>, <span class="hljs-number"><span class="hljs-number">8510</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o01 = txt.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetStartPositionOfLine"</span></span>, <span class="hljs-number"><span class="hljs-number">8511</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o02 = txt.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetStartPositionOfLine"</span></span>, <span class="hljs-number"><span class="hljs-number">8512</span></span>);</code> </pre><br>  And the truth is that the offset of the first object (the beginning of the 8510th line) is indicated as 49950 characters, for the second object - 49956, and the third - 49968. Between the first two 6 characters, and between the next 12. Disorder - this is the missing line. <br><br>  Go inside <i>GetStartPositionOfLine ()</i> : <br><br><img src="https://habrastorage.org/webt/3w/he/17/3whe17kxjlb1ncjbxchfxgl-ysi.png"><br><br>  Again we skip the initial checks and look at the real actions.  First, the point is calculated, which should fall on the line number <i>lineIndex</i> .  The height of all lines is taken and a half of the line height is added - in order to get to its center.  <i>We</i> do not look at <i>this.VerticalOffset</i> and <i>this.HorizontalOffset</i> - they are by zeros. <br><br>  We consider in our code: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lineHeight = (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>) txt.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetLineHeight"</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y0 = lineHeight * (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)<span class="hljs-number"><span class="hljs-number">8510</span></span> + lineHeight / <span class="hljs-number"><span class="hljs-number">2.0</span></span> - txt.VerticalOffset; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y1 = lineHeight * (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)<span class="hljs-number"><span class="hljs-number">8511</span></span> + lineHeight / <span class="hljs-number"><span class="hljs-number">2.0</span></span> - txt.VerticalOffset; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y2 = lineHeight * (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)<span class="hljs-number"><span class="hljs-number">8512</span></span> + lineHeight / <span class="hljs-number"><span class="hljs-number">2.0</span></span> - txt.VerticalOffset;</code> </pre><br>  Values ‚Äã‚Äãare reasonable, correlated with logic, everything is in order.  Go ahead with the <i>GetStartPositionOfLine ()</i> code - we are interested in the next meaningful line (the first one inside the condition), which is similar to a crocodile and ends with a call to <i>GetTextPositionFromPoint ()</i> . <br><br>  We reveal the challenges and pull them through reflection.  Note that some interfaces are not available to us due to the restriction of visibility, so you have to refer to them using the same Reflection. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> renderScope = (txt.GetFieldValue&lt;FrameworkElement&gt;(<span class="hljs-string"><span class="hljs-string">"_renderScope"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> IServiceProvider); <span class="hljs-comment"><span class="hljs-comment">// 7 -   ITextView var textView = renderScope.GetService(renderScope.GetType().GetInterfaces()[7]); var o10 = textView.InvokeMethod("GetTextPositionFromPoint", new Point(-txt.HorizontalOffset, y0), true); var o11 = textView.InvokeMethod("GetTextPositionFromPoint", new Point(-txt.HorizontalOffset, y1), true); var o12 = textView.InvokeMethod("GetTextPositionFromPoint", new Point(-txt.HorizontalOffset, y2), true);</span></span></code> </pre><br>  The resulting objects show all the same offsets - 49950, 49956, 49568. Going deeper into the implementation of <i>GetTextPositionFromPoint ()</i> inside TextBoxView. <br><br><img src="https://habrastorage.org/webt/cu/bz/su/cubzsusmp8w7yljcb36xmadksae.png"><br>  In, <i>GetLineIndexFromPoint ()</i> looks promising.  Call in your code. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o20 = textView.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetLineIndexFromPoint"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(-txt.HorizontalOffset, y0), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o21 = textView.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetLineIndexFromPoint"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(-txt.HorizontalOffset, y1), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o22 = textView.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"GetLineIndexFromPoint"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(-txt.HorizontalOffset, y2), <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  We get 8510, 8511 and 8513 - bingo!  To implementation: <br><br><img src="https://habrastorage.org/webt/9i/lp/q9/9ilpq9myefgvsnyxjkdv7oiirds.png"><br><br>  Even with the naked eye it is clear that this is a binary search.  <i>_lineMetrics</i> - list of characteristics of lines (beginning, length, width of the border).  I happily rub my hands - I thought that, as is often the case, somewhere we forgot to stick a <i>+1</i> or set <i>&gt;</i> instead of <i>&gt; =</i> .  Copy the function into the code and debug it.  Because of the closeness of the <i>_lineMetrics</i> types, <i>we</i> pull out through the reflections, we already got <i>_lineHeight</i> earlier.  Total: <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lm = textView.GetFieldValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"_lineMetrics"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> c = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)lm.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"get_Count"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lineMetrics = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>,<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; c; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> arr_o = lm.InvokeMethod(<span class="hljs-string"><span class="hljs-string">"get_Item"</span></span>, i); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> contLength = arr_o.GetFieldValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"_contentLength"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> length = arr_o.GetFieldValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"_length"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> offset = arr_o.GetFieldValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"_offset"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> width = arr_o.GetFieldValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"_width"</span></span>); lineMetrics.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Tuple&lt;<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;(contLength, length, offset, width)); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o30 = GetLineIndexFromPoint(lineMetrics, lineHeight, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(-txt.HorizontalOffset, y0), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o31 = GetLineIndexFromPoint(lineMetrics, lineHeight, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(-txt.HorizontalOffset, y1), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> o32 = GetLineIndexFromPoint(lineMetrics, lineHeight, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Point(-txt.HorizontalOffset, y2), <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">/*&lt;...&gt;*/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetLineIndexFromPoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">List&lt;Tuple&lt;</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params">&gt;&gt; lm, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> _lineHeight, Point point, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">bool</span></span></span></span><span class="hljs-function"><span class="hljs-params"> snapToText</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (point.Y &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> !snapToText ? <span class="hljs-number"><span class="hljs-number">-1</span></span> : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (point.Y &gt;= _lineHeight * (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)lm.Count) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!snapToText) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> lm.Count - <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> index = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num1 = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num2 = lm.Count; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (num1 &lt; num2) { index = num1 + (num2 - num1) / <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lineMetric = lm[index]; <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> num3 = _lineHeight * (<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>)index; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (point.Y &lt; num3) num2 = index; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (point.Y &gt;= num3 + _lineHeight) { num1 = index + <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!snapToText &amp;&amp; (point.X &lt; <span class="hljs-number"><span class="hljs-number">0.0</span></span> || point.X &gt;= lineMetric.Item4)) { index = <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (num1 &gt;= num2) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">-1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> index; }</code> </pre><br>  We do not get to debug.  o30, o31, and o32 are 8510, 8511, and 8512, respectively.  Such as they should be!  But o20, o21 and o22 do not agree with them.  How so?  We almost did not change the code.  Nearly?  And here comes the insight. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> lh = textView.GetFieldValue&lt;<span class="hljs-keyword"><span class="hljs-keyword">double</span></span>&gt;(<span class="hljs-string"><span class="hljs-string">"_lineHeight"</span></span>);</code> </pre><br><img src="https://habrastorage.org/webt/v6/tv/ar/v6tvarxvg-sz-da4znxe7nnzigo.png"><br><br>  Here it is the reason - the difference is <b>0.0009375</b> .  And if we estimate the accumulation of the error - we multiply by 8511, then we get 7.9790625.  This is just about half of the lineHeight, and therefore, when calculating the coordinates, the point flies out beyond the limits of the desired line and falls on the next.  The same variable (meaning) was calculated in two different ways and, suddenly, did not match. <br><br>  On this I decided to stop.  It is possible to really get to the bottom of why the height of the column turned out to be different, but I do not see much point.  It is doubtful that Microsoft will fix this, so we are looking at crutches for workarounds.  Reflection Crutch - Install the correct <i>_lineHeigh in</i> either one or the other.  It sounds dumb, probably slowly and most likely unreliable.  Or you can maintain your own set of lines, parallel to TextBox and take lines from it, the benefit of getting the line number for the cursor position works correctly. <br><br><h2>  <font color="orange">Conclusion</font> </h2><br>  From novice programmers, you can often hear something about errors in the compiler or standard components.  In reality, they are not as common, but none of them are insured.  Do not be afraid to look inside the tool that you need - it's fun and interesting. <br><br>  Write a good code! <br><br><h2>  <font color="orange">Other blog articles</font> </h2><br>  ‚Üí <a href="https://habr.com/company/pm/blog/419617/">Machine Training in Offensive Security</a> <br>  No car will replace me.  Muhaha-ha.  I hope. <br><br>  ‚Üí <a href="https://habr.com/company/pm/blog/417285/">Where to insert quotation mark in IPv6</a> <br>  The guys know where and what to shove in order to become good.  After such words, they will replace me with a robot, for sure.  Wed!  UHF! </div><p>Source: <a href="https://habr.com/ru/post/420361/">https://habr.com/ru/post/420361/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../420351/index.html">How to search for users on GitHub using Vue</a></li>
<li><a href="../420353/index.html">Making Shrimp More Useful: Adding Recoding Images to Other Formats</a></li>
<li><a href="../420355/index.html">Pebble smartwatch: how to become a rarity overnight</a></li>
<li><a href="../420357/index.html">Vuex: structuring large projects and working with modules</a></li>
<li><a href="../420359/index.html">Var, let or const? Problems scopes variables and ES6</a></li>
<li><a href="../420363/index.html">HPE webinars in August-October: new topics (+ storage, AI practice, turnkey petabyte storage)</a></li>
<li><a href="../420367/index.html">Air-conditioned apocalypse: blackout scenario of the grid using smart climate instruments</a></li>
<li><a href="../420369/index.html">Extreme Extended Edge, or IEEE 802.1BR based switching</a></li>
<li><a href="../420371/index.html">To the issue of bicycle engineering in the field of electromail posting</a></li>
<li><a href="../420373/index.html">Almost OCR to get VPNBook password. PHP + Mikrotik</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>