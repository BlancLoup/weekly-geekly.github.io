<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Running local ssh / telnet / vnc clients using the link from the Zabbix card</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many racks, each tightly packed with servers, routers, switches and other kvm'ami. 
 We need some convenient way to steer all this, quickly connect to...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Running local ssh / telnet / vnc clients using the link from the Zabbix card</h1><div class="post__text post__text-html js-mediator-article">  Many racks, each tightly packed with servers, routers, switches and other kvm'ami. <br>  We need some convenient way to steer all this, quickly connect to the necessary equipment and <br>  set it up.  Right to a couple of mouse clicks and op - in front of you the console of the desired switch. <br><br>  To monitor our charges we use Zabbix. <br>  So why not adapt this marvelous tool for this task. <br>  After all, it would be very convenient to poke the necessary rack in the Zabbix map, go to its submap and, choosing a piece of metal, <br>  run local ssh / telnet / vnc client on your computer. <br><br>  Puzzled by the idea, I began to torment the search engines in the hope of finding options for implementation. <br>  <a href="https://www.zabbix.com/forum/showthread.php%3Ft%3D12916">This thread</a> was found on the Zabbix forum, but I wanted to run local programs on my machine by clicking the link in the map. <br>  For some time, wandering around the back streets of the world wide web and torturing familiar programmers with stupid questions, I remembered about ... Python. <br>  Yes, Python, not once came to the rescue in a difficult moment. <br>  I feed very tender feelings for this language for its simplicity and pleasant warm syntax. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And so, the attack vector changed and the search engines froze in anticipation of a new injection of thought patterns ... <br>  After some time, I had a clear idea how I would solve the problem - I will write a client-server application! <br>  On my computer, the server side will wait for commands, and on the monitoring server, when the user clicks on the link, the client will start and transfer the necessary command. <br><br>  The result of the research was a cross-platform application that works on both Linux and Windows. <br>  The epic of trial and error on the way to the cherished goal is waiting for you under the habrakat. <br><a name="habracut"></a><br><br><h4>  Prologue </h4><br>  The beginning of the way. <br><br>  First of all, I note that the syntax is valid for Python version 2.7. <br>  And the Zabbix version counted three twos - <code>Zabbix 2.2.2</code> <br>  Responsible for client and server communication is entrusted to <a href="http://docs.python.org/2.7/library/socket.html">the socket library Python</a> . <br>  In addition to the documentation, the following sources were helpful to me: <br>  1. <a href="http://www.binarytides.com/python-socket-programming-tutorial/">www.binarytides.com/python-socket-programming-tutorial</a> <br>  2. <a href="http://www.binarytides.com/code-chat-application-server-client-sockets-python/">www.binarytides.com/code-chat-application-server-client-sockets-python</a> <br>  3. <a href="http://java-developer.livejournal.com/6920.html">java-developer.livejournal.com/6920.html</a> <br><br>  Having played enough with examples, we will prepare the basis of the future application. <br>  Customer: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket sock = socket.socket() sock.connect(('localhost', 9090)) sock.send('/usr/bin/konsole -e mc') sock.close()</span></span></code> </pre><br>  And the server: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import subprocess sock = socket.socket() sock.bind(('localhost', 9090)) sock.listen(1) while True: conn, addr = sock.accept() data = conn.recv(1024) if not data: break subprocess.call(data, shell=True) conn.close()</span></span></code> </pre><br>  The running server ‚Äúlistens‚Äù to port 9090 on the loopback interface, having executed the client, we send the command to start the new console, and the <code>-e mc</code> parameter indicates that the midnight commander file manager should be started in the console. <br><div class="spoiler">  <b class="spoiler_title">Brief demonstration</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/Aov4lP9XTWo%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhjCHUNxRZDQXU2bQYPz6dztnWbZXQ" frameborder="0" allowfullscreen=""></iframe><br></div></div><br>  * The main OS for me is Linux, and DE is KDE, but don't let that bother you, the final version of the scripts will not be tied to the OS. <br><br>  The basis is laid, moving on! <br><br><h4>  Chapter 1 </h4><br>  In this chapter, the client will learn to understand the command line arguments and we will send the first command to the server from the Zabbix map. <br><br>  The server part code has not yet undergone any changes, but the import of the sys library has been added to the client code. <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import sys sock = socket.socket() sock.connect(('localhost', 9090)) sock.send('/usr/bin/konsole -e ssh root@'+ sys.argv[1]) sock.close()</span></span></code> </pre><br>  The server will have to start the console and initiate an ssh connection to IP from the first argument passed to the client. <br>  Login is <code>root</code> . <br><br>  And now it's time to put the client script on the monitoring server. <br>  In my case, he comfortably settled here - /usr/local/bin/client.py <br>  In the Zabbix web interface, go to Administration -&gt; Scripts. <br><img src="https://habrastorage.org/getpro/habr/post_images/710/03c/011/71003c011276bd73497522e2e94edc47.png"><br>  Create a new script (Create new). <br><img src="https://habrastorage.org/getpro/habr/post_images/2c5/c1c/19a/2c5c1c19a493ad93b32b027448f80dd5.png"><br>  Through Zabbix, the macro {HOST.IP} passes the IP of the client to the connection. <br>  Turning to the map, we will see that the hosts have a menu with the name of the newly created script. <br><img src="https://habrastorage.org/getpro/habr/post_images/397/c40/e5b/397c40e5bd2371d9ea920b052cead7b5.png"><br>  Many will rightly notice - ‚ÄúThe client script is still connected to localhost, but is it already on the server ?!‚Äù <br>  That's right!  But to protect the interaction between the server and the client, an ssh tunnel is used. <br>  All connections established on localhost: 9090 Zabbix server are actually established with the server script on our local machine. <br>  To achieve such a "mirroring" on the local computer, run the command: <br><pre> <code class="bash hljs">ssh -f -N -R 9090:127.0.0.1:9090 zabbix</code> </pre><br>  Read more about ssh, and tunnels in the above privacy, you can read in the wonderful articles on Habr√© - <a href="http://habrahabr.ru/post/122445/">1</a> , <a href="http://habrahabr.ru/post/122445/">2</a> <br><div class="spoiler">  <b class="spoiler_title">Video illustration for the first chapter</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/qd9yOpMJLi0%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhgZL0_pvJPf13Cg6GuLHwuqorz-rQ" frameborder="0" allowfullscreen=""></iframe><br></div></div><br><br><h4>  Chapter 2 </h4><br>  In this chapter, the scripts will widen a little more and learn to distinguish between Windows and Linux. <br><br>  The idea is that the client, when connecting to the server, first of all find out on which OS it is running. <br>  And, having received this information, I gave the right command. <br>  The code for both scripts has changed. <br><br>  Customer: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import sys sock = socket.socket() sock.connect(('localhost', 9090)) os = sock.recv(64) if os == "Windows": sock.send('C:\\apps\\putty.exe -ssh root@' + sys.argv[1]) elif os == "Linux": sock.send('/usr/bin/konsole -e ssh root@'+ sys.argv[1]) sock.close()</span></span></code> </pre><br>  Server: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import subprocess OS = "Linux" sock = socket.socket() sock.bind(('127.0.0.1', 9090)) sock.listen(1) while True: conn, addr = sock.accept() conn.sendall(OS) data = conn.recv(1024) print data if not data: break subprocess.call(data, shell=True) conn.close()</span></span></code> </pre><br>  * for Windows, the OS variable must be changed accordingly. <br>  As you can see, when connecting to the server, the client first of all receives a string with the name of the OS, and only then sends the command. <br>  Please note that backslashes in paths for Windows OS need to be escaped, i.e.  put double <code>\\</code> <br><br><div class="spoiler">  <b class="spoiler_title">Video to the second chapter</b> <div class="spoiler_text"><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/LcRHA4iLssA%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhiP3tvuawc1gtI92J5MgO9fCu2-lg" frameborder="0" allowfullscreen=""></iframe><br>  In the video: <br>  "Mirror" the port in Windows by running putty <br>  we start the server <br>  click the link to connect to the host <br>  disable everything in Windows and do the same in Linux <br></div></div><br><br><h4>  Chapter 3 </h4><br>  In this chapter we will slightly correct the code of the Zabbix frontend. <br>  We will teach him to transfer to the script client the second argument the login of the administrator / operator registered on the web interface. <br><br>  It seems to be all great and now you can use the operating time to connect to servers, routers, switches. <br>  But what if there are more than one administrators using Zabbix? <br>  We need to somehow make it clear to the script who launched it, simply speaking, who ‚Äúpoked‚Äù the link in the web interface. <br><br>  We will decide in stages. <br><ul><li>  We assign a specific port to each administrator. </li><li>  We will teach the script client to choose a port depending on the second argument - the login. </li><li>  We will change the Zabbix code to pass the second argument when clicking on a link from the web interface. </li></ul><br>  Ports: <br>  Admin - 9090 <br>  Admin1 - 9091 <br>  etc. <br><br>  The script code of the client with the necessary changes: <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import sys if sys.argv[2] == 'Admin': PORT=9090 elif sys.argv[2] == 'Admin1': PORT=9091 sock = socket.socket() sock.connect(('localhost', PORT)) os = sock.recv(64) if os == "Windows": sock.send('C:\\apps\\putty.exe -ssh root@' + sys.argv[1]) elif os == "Linux": sock.send('/usr/bin/konsole -e ssh root@'+ sys.argv[1]) sock.close()</span></span></code> </pre><br><br>  But to solve the last problem, in the framework of this chapter, it was not so easy. <br>  I had to significantly increase the coffee limit for this shift, and even snitch a cat from my wife from under my side. <br>  The coffee was drunk, the cat, having become purred, had long since been dumped, but I didn‚Äôt come close to a decision a jot ... <br>  But the feeling of closeness otgadki did not give me rest, it firmly grabbed my brain with its claws, and I knew that the apple was about to fall on my head. <br>  And it fell! (Not in the literal sense of course) <br>  The working option, as is often the case, was practically on the surface. <br>  To execute all the scripts called from the web interface, use scripts_exec.php located in the root directory of the installed Zabbix. <br>  The description of the scripts is stored in the MySQL database. <br><img src="https://habrastorage.org/getpro/habr/post_images/9d8/51e/922/9d851e922d8e1dfff33426fa35802902.png"><br>  So by correcting scripts_exec.php properly, we will be able to pass the login as the second argument for our client script when clicking on the link. <br><div class="spoiler">  <b class="spoiler_title">Code of the corrected scripts_exec.php:</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ** Zabbix ** Copyright (C) 2001-2014 Zabbix SIA ** ** This program is free software; you can redistribute it and/or modify ** it under the terms of the GNU General Public License as published by ** the Free Software Foundation; either version 2 of the License, or ** (at your option) any later version. ** ** This program is distributed in the hope that it will be useful, ** but WITHOUT ANY WARRANTY; without even the implied warranty of ** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the ** GNU General Public License for more details. ** ** You should have received a copy of the GNU General Public License ** along with this program; if not, write to the Free Software ** Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA. **/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/include/config.inc.php'</span></span>; $page[<span class="hljs-string"><span class="hljs-string">'title'</span></span>] = _(<span class="hljs-string"><span class="hljs-string">'Scripts'</span></span>); $page[<span class="hljs-string"><span class="hljs-string">'file'</span></span>] = <span class="hljs-string"><span class="hljs-string">'scripts_exec.php'</span></span>; define(<span class="hljs-string"><span class="hljs-string">'ZBX_PAGE_NO_MENU'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/include/page_header.php'</span></span>; $NewCommand4Run = <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/client_ssh.py {HOST.IP} '</span></span>. CWebUser::$data[<span class="hljs-string"><span class="hljs-string">'alias'</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// VAR TYPE OPTIONAL FLAGS VALIDATION EXCEPTION $fields = array( 'hostid' =&gt; array(T_ZBX_INT, O_OPT, P_ACT, DB_ID, null), 'scriptid' =&gt; array(T_ZBX_INT, O_OPT, null, DB_ID, null) ); check_fields($fields); ob_flush(); flush(); $scriptId = getRequest('scriptid'); $hostId = getRequest('hostid'); $data = array( 'message' =&gt; '', 'info' =&gt; DBfetch(DBselect('SELECT s.name FROM scripts s WHERE s.scriptid='.zbx_dbstr($scriptId))) ); if ($scriptId == 5) { DBexecute('update zabbix.scripts set command='."'".$NewCommand4Run."'".' where scriptid=5;'); } $result = API::Script()-&gt;execute(array( 'hostid' =&gt; $hostId, 'scriptid' =&gt; $scriptId )); $isErrorExist = false; if (!$result) { $isErrorExist = true; } elseif ($result['response'] == 'failed') { error($result['value']); $isErrorExist = true; } else { $data['message'] = $result['value']; } if ($isErrorExist) { show_error_message( _('Cannot connect to the trapper port of zabbix server daemon, but it should be available to run the script.') ); } // render view $scriptView = new CView('general.script.execute', $data); $scriptView-&gt;render(); $scriptView-&gt;show(); require_once dirname(__FILE__).'/include/page_footer.php';</span></span></code> </pre><br></div></div><br>  Variable <br><pre> <code class="php hljs">$NewCommand4Run = <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/client.py {HOST.IP} '</span></span>. CWebUser::$data[<span class="hljs-string"><span class="hljs-string">'alias'</span></span>];</code> </pre><br>  after clicking the link, it will contain the path to the script + macro {HOST.IP} + admin login. <br>  A condition <br><pre> <code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($scriptId == <span class="hljs-number"><span class="hljs-number">5</span></span>) { DBexecute(<span class="hljs-string"><span class="hljs-string">'update zabbix.scripts set command='</span></span>.<span class="hljs-string"><span class="hljs-string">"'"</span></span>.$NewCommand4Run.<span class="hljs-string"><span class="hljs-string">"'"</span></span>.<span class="hljs-string"><span class="hljs-string">' where scriptid=5;'</span></span>); }</code> </pre><br>  will replace the command in the MySQL table with the one we need. <br>  For example, like this: <br><img src="https://habrastorage.org/getpro/habr/post_images/d28/0a3/543/d280a354302d8821612d25db95f1c185.png"><br><br>  And now the script client will be able to transfer the command to the desired server script. <br><br><div class="spoiler">  <b class="spoiler_title">And this is how it looks.</b> <div class="spoiler_text">  Look better without sound, I have a lot of laptop.) <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/9cm6L--wMIk%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhjoFP85-9DM_eF3X-wZhwWdyVI4tg" frameborder="0" allowfullscreen=""></iframe><br></div></div><br><h4>  Chapter 4 </h4><br>  In this chapter, we will teach Zabbix to run vnc and telnet clients. <br><br>  Let's talk about client scripts for other protocols listed in the header. <br>  Listing of the / usr / local / bin directory on Zabbix server: <br><pre> <code class="bash hljs">-rwxr-xr-x 1 root staff 429 Mar 17 03:06 client_ssh.py -rwxr-xr-x 1 root staff 418 Mar 17 04:58 client_telnet.py -rwxr-xr-x 1 root staff 412 Mar 17 05:00 client_vnc.py</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Listing of each client script</b> <div class="spoiler_text">  client_ssh.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import sys if sys.argv[2] == 'Admin': PORT=9090 elif sys.argv[2] == 'Admin1': PORT=9091 sock = socket.socket() sock.connect(('localhost', PORT)) os = sock.recv(64) if os == "Windows": sock.send('C:\\apps\\putty.exe -ssh root@' + sys.argv[1]) elif os == "Linux": sock.send('/usr/bin/konsole -e ssh root@'+ sys.argv[1]) sock.close()</span></span></code> </pre><br>  client_vnc.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import sys if sys.argv[2] == 'Admin': PORT=9090 elif sys.argv[2] == 'Admin1': PORT=9091 sock = socket.socket() sock.connect(('localhost', PORT)) os = sock.recv(64) if os == "Windows": sock.send('c:\\apps\\vnc.exe ' + sys.argv[1]) elif os == "Linux": sock.send('/usr/bin/X11/gvncviewer '+ sys.argv[1]) sock.close()</span></span></code> </pre><br>  client_telnet.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import sys if sys.argv[2] == 'Admin': PORT=9090 elif sys.argv[2] == 'Admin1': PORT=9091 sock = socket.socket() sock.connect(('localhost', PORT)) os = sock.recv(64) if os == "Windows": sock.send('C:\\apps\\putty.exe -telnet ' + sys.argv[1]) elif os == "Linux": sock.send('/usr/bin/konsole -e telnet '+ sys.argv[1]) sock.close()</span></span></code> </pre><br></div></div><br>  We will not dwell on the code in detail; this has already been done in previous chapters. <br>  Let me just say that for Windows I downloaded the portable version of the vnc client and put everything in <code>c:\apps\</code> <br><br>  For telnet and vnc from the scripts, you need to repeat the steps from Chapter 1, in the Zabbix web interface, and for ssh you just need to correct the name. <br>  The scripts_exe.php file also needs to be modified. <br><div class="spoiler">  <b class="spoiler_title">The newly modified code scripts_exes.php</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/* ** Zabbix ** Copyright (C) 2001-2014 Zabbix SIA ** ** This program is free software; you can redistribute it and/or modify ** it under the terms of the GNU General Public License as published by ** the Free Software Foundation; either version 2 of the License, or ** (at your option) any later version. ** ** This program is distributed in the hope that it will be useful, ** but WITHOUT ANY WARRANTY; without even the implied warranty of ** MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the ** GNU General Public License for more details. ** ** You should have received a copy of the GNU General Public License ** along with this program; if not, write to the Free Software ** Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA 02110-1301, USA. **/</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/include/config.inc.php'</span></span>; $page[<span class="hljs-string"><span class="hljs-string">'title'</span></span>] = _(<span class="hljs-string"><span class="hljs-string">'Scripts'</span></span>); $page[<span class="hljs-string"><span class="hljs-string">'file'</span></span>] = <span class="hljs-string"><span class="hljs-string">'scripts_exec.php'</span></span>; define(<span class="hljs-string"><span class="hljs-string">'ZBX_PAGE_NO_MENU'</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> dirname(<span class="hljs-keyword"><span class="hljs-keyword">__FILE__</span></span>).<span class="hljs-string"><span class="hljs-string">'/include/page_header.php'</span></span>; $NewCommand4RunSSH = <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/client_ssh.py {HOST.IP} '</span></span>. CWebUser::$data[<span class="hljs-string"><span class="hljs-string">'alias'</span></span>]; $NewCommand4RunVNC = <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/client_vnc.py {HOST.IP} '</span></span>. CWebUser::$data[<span class="hljs-string"><span class="hljs-string">'alias'</span></span>]; $NewCommand4RunTELNET = <span class="hljs-string"><span class="hljs-string">'/usr/local/bin/client_telnet.py {HOST.IP} '</span></span>. CWebUser::$data[<span class="hljs-string"><span class="hljs-string">'alias'</span></span>]; <span class="hljs-comment"><span class="hljs-comment">// VAR TYPE OPTIONAL FLAGS VALIDATION EXCEPTION $fields = array( 'hostid' =&gt; array(T_ZBX_INT, O_OPT, P_ACT, DB_ID, null), 'scriptid' =&gt; array(T_ZBX_INT, O_OPT, null, DB_ID, null) ); check_fields($fields); ob_flush(); flush(); $scriptId = getRequest('scriptid'); $hostId = getRequest('hostid'); $data = array( 'message' =&gt; '', 'info' =&gt; DBfetch(DBselect('SELECT s.name FROM scripts s WHERE s.scriptid='.zbx_dbstr($scriptId))) ); if ($scriptId == 5) { DBexecute('update zabbix.scripts set command='."'".$NewCommand4RunSSH."'".' where scriptid=5;'); } if ($scriptId == 6) { DBexecute('update zabbix.scripts set command='."'".$NewCommand4RunVNC."'".' where scriptid=6;'); } if ($scriptId == 7) { DBexecute('update zabbix.scripts set command='."'".$NewCommand4RunTELNET."'".' where scriptid=7;'); } $result = API::Script()-&gt;execute(array( 'hostid' =&gt; $hostId, 'scriptid' =&gt; $scriptId )); $isErrorExist = false; if (!$result) { $isErrorExist = true; } elseif ($result['response'] == 'failed') { error($result['value']); $isErrorExist = true; } else { $data['message'] = $result['value']; } if ($isErrorExist) { show_error_message( _('Cannot connect to the trapper port of zabbix server daemon, but it should be available to run the script.') ); } // render view $scriptView = new CView('general.script.execute', $data); $scriptView-&gt;render(); $scriptView-&gt;show(); require_once dirname(__FILE__).'/include/page_footer.php';</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Already traditional video.</b> <div class="spoiler_text">  Here, too, better without sound. <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/VvwELEAGw5k%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhgfImwbxkfmAxTspF9M6MMsOujzXg" frameborder="0" allowfullscreen=""></iframe><br></div></div><br><br><h4>  Conclusion </h4><br>  We will restore order and give some gloss to our design. <br><br>  Strictly speaking, this is where the cross-platform ends. <br><br>  For Linux, from a variety of examples, a demon was built in Python. <br>  He performs a double fork and calmly waits for commands from client scripts. <br>  In Windows, everything was more complicated, but, first things first. <br><br>  Listing directory with the necessary scripts for Linux OS: <br><pre> <code class="bash hljs">fessae@workbook:~/sh/python &gt; <span class="hljs-built_in"><span class="hljs-built_in">pwd</span></span> /home/fessae/sh/python fessae@workbook:~/sh/python &gt; ll total 12 -rwxr-xr-x 1 fessae fessae 2880 Feb 28 02:56 daemon.py* -rwxr-xr-x 1 fessae fessae 710 Mar 17 03:36 server.py* -rwxr-xr-x 1 fessae fessae 1122 Mar 13 04:59 ZabbixTeams.py*</code> </pre><br><div class="spoiler">  <b class="spoiler_title">Code for each of the Linux server-side scripts.</b> <div class="spoiler_text">  daemon.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python import sys, os, time, atexit from signal import SIGTERM class Daemon: """ A generic daemon class. Usage: subclass the Daemon class and override the run() method """ def __init__(self, pidfile, stdin='/dev/null', stdout='/dev/null', stderr='/dev/null'): self.stdin = stdin self.stdout = stdout self.stderr = stderr self.pidfile = pidfile def daemonize(self): """ do the UNIX double-fork magic, see Stevens' "Advanced Programming in the UNIX Environment" for details (ISBN 0201563177) http://www.erlenstar.demon.co.uk/unix/faq_2.html#SEC16 """ try: pid = os.fork() if pid &gt; 0: # exit first parent sys.exit(0) except OSError, e: sys.stderr.write("fork #1 failed: %d (%s)\n" % (e.errno, e.strerror)) sys.exit(1) # decouple from parent environment os.chdir("/") os.setsid() os.umask(0) # do second fork try: pid = os.fork() if pid &gt; 0: # exit from second parent sys.exit(0) except OSError, e: sys.stderr.write("fork #2 failed: %d (%s)\n" % (e.errno, e.strerror)) sys.exit(1) # redirect standard file descriptors sys.stdout.flush() sys.stderr.flush() si = file(self.stdin, 'r') so = file(self.stdout, 'a+') se = file(self.stderr, 'a+', 0) os.dup2(si.fileno(), sys.stdin.fileno()) os.dup2(so.fileno(), sys.stdout.fileno()) os.dup2(se.fileno(), sys.stderr.fileno()) # write pidfile atexit.register(self.delpid) pid = str(os.getpid()) file(self.pidfile,'w+').write("%s\n" % pid) def delpid(self): os.remove(self.pidfile) def start(self): """ Start the daemon """ # Check for a pidfile to see if the daemon already runs try: pf = file(self.pidfile,'r') pid = int(pf.read().strip()) pf.close() except IOError: pid = None if pid: message = "pidfile %s already exist. Daemon already running?\n" sys.stderr.write(message % self.pidfile) sys.exit(1) # Start the daemon self.daemonize() self.run() def stop(self): """ Stop the daemon """ # Get the pid from the pidfile try: pf = file(self.pidfile,'r') pid = int(pf.read().strip()) pf.close() except IOError: pid = None if not pid: message = "pidfile %s does not exist. Daemon not running?\n" sys.stderr.write(message % self.pidfile) return # not an error in a restart # Try killing the daemon process try: while 1: os.kill(pid, SIGTERM) time.sleep(0.1) except OSError, err: err = str(err) if err.find("No such process") &gt; 0: if os.path.exists(self.pidfile): os.remove(self.pidfile) else: print str(err) sys.exit(1) def restart(self): """ Restart the daemon """ self.stop() self.start() def run(self): """ You should override this method when you subclass Daemon. It will be called after the process has been daemonized by start() or restart(). """</span></span></code> </pre><br>  server.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import subprocess import sys OS = "Linux" def main(): sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM) print 'Socket created' try: sock.bind(('127.0.0.1', 9090)) except socket.error , msg: print 'Bind failed. Error Code : ' + str(msg[0]) + ' Message ' + msg[1] sys.exit() print 'Socket bind complete' sock.listen(1) print 'Socket now listening' while True: conn, addr = sock.accept() conn.sendall(OS) data = conn.recv(1024) print 'Connected with ' + addr[0] + ':' + str(addr[1]) print data if not data: break subprocess.call(data, shell=True) conn.close() if __name__ == "__main__": main()</span></span></code> </pre><br>  ZabbixTeams.py <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#/usr/bin/env python #-*- coding: utf-8 -*- import sys sys.path.append("/home/fessae/sh/python") from daemon import Daemon import server class ZabbixTeams(Daemon): def run(self): while True: server.main() if __name__ == "__main__": daemon = ZabbixTeams('/tmp/zabbixteams.pid',stdout='/tmp/zabbixteams.log',stderr='/tmp/zabbixteamserr.log') if len(sys.argv) == 2: if 'start' == sys.argv[1]: daemon.start() elif 'stop' == sys.argv[1]: daemon.stop() elif 'restart' == sys.argv[1]: daemon.restart() else: print "Unknown command" sys.exit(2) sys.exit(0) else: print "usage: %s start|stop|restart" % sys.argv[0] sys.exit(2)</span></span></code> </pre><br></div></div><br>  To start the daemon we type <br><pre> <code class="bash hljs">python ZabbixTeams.py start</code> </pre><br>  To stop accordingly <br><pre> <code class="bash hljs">python ZabbixTeams.py stop</code> </pre><br>  Pay attention to the line <br><pre> <code class="python hljs">sys.path.append(<span class="hljs-string"><span class="hljs-string">"/home/fessae/sh/python"</span></span>)</code> </pre><br>  from ZabbixTeams.py, it connects the ability to import scripts from this directory. <br>  Correct it according to your environment. <br><br>  The resulting demon can be started by hand, stick the icon to start it, wrap in Austostart DE or OS. <br>  This is someone as you like. <br><br>  OS Windows. <br>  For writing / correcting the code, I used Python IDE PyCharm, so the scripts were located along the path: <br><img src="https://habrastorage.org/getpro/habr/post_images/d7d/8aa/a78/d7d8aaa7845c070ae706d9be0864d2ca.jpg"><br><br>  It would be more correct, of course, to write a service for this OS using <a href="http://sourceforge.net/projects/pywin32/">pywin32</a> . <br>  But the scripts used blocking sockets and I didn‚Äôt get a full service without abandoning them. <br>  Maybe later I will take on <a href="http://docs.python.org/2/library/asyncore.html">asyncore</a> or even rewrite everything in twisted, but so far I did not want to complicate things. <br><div class="spoiler">  <b class="spoiler_title">Therefore, running the daemon on Windows looks like this.</b> <div class="spoiler_text"><ul><li>  on the desktop is the server.bat file containing: <br><pre> <code class="dos hljs"><span class="hljs-function"><span class="hljs-function"> c:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Python27</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">python.exe</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">C</span></span></span><span class="hljs-function">:\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Users</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">FessAectan</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">PycharmProjects</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ZabbixTeams</span></span></span><span class="hljs-function">\</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">daemon.py</span></span></span></span></code> </pre><br></li><li>  daemon.py, in turn, looks like this: <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> sys <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> subprocess CREATE_NO_WINDOW = <span class="hljs-number"><span class="hljs-number">0x8000000</span></span> subprocess.Popen([<span class="hljs-string"><span class="hljs-string">"c:\Python27\python.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">"-O"</span></span>,<span class="hljs-string"><span class="hljs-string">"C:\Users\FessAectan\PycharmProjects\ZabbixTeams\server.py"</span></span>], shell=<span class="hljs-keyword"><span class="hljs-keyword">False</span></span>, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, creationflags = CREATE_NO_WINDOW)</code> </pre><br></li><li>  and, of course, server.py itself <br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- import socket import subprocess OS = "Windows" def main(): sock = socket.socket() print "Socket created" try: sock.bind(('127.0.0.1', 9091)) except socket.error , msg: print "Bind failed. Error Code : " + str(msg[0]) + " Message " + msg[1] sys.exit() print "Socket bind complete" sock.listen(1) print "Socket now listening" while True: conn, addr = sock.accept() conn.sendall(OS) data = conn.recv(1024) print "Connected with " + addr[0] + ":" + str(addr[1]) if not data: break subprocess.Popen(data, shell=False, stdin=subprocess.PIPE, stdout=subprocess.PIPE, stderr=subprocess.PIPE, creationflags = 0x00000008) conn.close() if __name__ == "__main__": main()</span></span></code> </pre><br>  For Windows, subprocess.call has been replaced by subprocess.Popen. <br></li></ul><br><br></div></div><br>  The final video. <br>  * sound is all right;) <br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/jxjz9H1zv_0%3Ffeature%3Doembed&amp;xid=17259,15700021,15700186,15700191,15700253&amp;usg=ALkJrhiYsbqzDnfpAmz-_ntOxfZjGlF2Vw" frameborder="0" allowfullscreen=""></iframe><br><br>  <b>Thank you for attention.</b> <br>  by <a href="https://habrahabr.ru/users/fessaectan/" class="user_link">FessAectan</a> <br><br>  <a href="http://serverclub.ru/">Serverclub</a> </div><p>Source: <a href="https://habr.com/ru/post/217161/">https://habr.com/ru/post/217161/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217145/index.html">Imagenary open mobile photo blogs for everyone</a></li>
<li><a href="../217147/index.html">How to calculate the time to design interfaces online store</a></li>
<li><a href="../217151/index.html">Highly loaded systems: solving basic problems</a></li>
<li><a href="../217155/index.html">Are you still chasing clients in social networks?</a></li>
<li><a href="../217159/index.html">New from Synology inc. at CeBIT 2014</a></li>
<li><a href="../217163/index.html">YotaDevices: What have we been silent for so long?</a></li>
<li><a href="../217167/index.html">Get a grant and stay alive</a></li>
<li><a href="../217169/index.html">How to become a "golden sponsor" of the Olympic Games</a></li>
<li><a href="../217171/index.html">Portal porting to Android</a></li>
<li><a href="../217173/index.html">UX in e-Commerce: 3 positive and negative design trends</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>