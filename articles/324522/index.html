<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Guess the filter by impulse response</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="On some site, in some forum, a good young man nicknamed SciFi puzzled his team with history. 
 He found in the technical guidance materials of a forei...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Guess the filter by impulse response</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/8fe/c20/977/8fec2097777a4e728dfde6cf861a01ad.gif"><br><br>  On some site, in some forum, a good young man nicknamed SciFi puzzled his team with history. <br>  He found in the technical guidance materials of a foreign company Texas Instruments [FSK Modulation and Demodulation With the MSP430 Microcontroller] the digital filter he needed.  But foreigners were very cunning, and in the source code they gave the following: <br><a name="habracut"></a><br><pre><code class="hljs markdown"><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span> <span class="hljs-bullet"><span class="hljs-bullet">* Running this filter takes 113 cycles *</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">**** ;**</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-bullet"><span class="hljs-bullet">* ; New simpler filter at following specification ; Freq_Stop: 2.5KHz, Attenuation_Stop: 40dB ; Freq_Pass: 1.4KHz, Attenuation_Pass: 1dB ; Order of filter = 5 ;*</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span><span class="hljs-strong"><span class="hljs-strong">*****</span></span>** filters: bis #INTERRUPT<span class="hljs-emphasis"><span class="hljs-emphasis">_TOGGLE,global_</span></span>status mov #WDF<span class="hljs-emphasis"><span class="hljs-emphasis">_PARMS,mem_</span></span>ptr .word 4f16h .word 0000h .word 498fh .word 0000h .word 4f17h .word 0008h .word 8607h .word 4708h .word 1108h .word 4806h .word 1108h .word 1108h .word 1108h .word 1108h .word 1108h . . .</code> </pre> <br><br>  Encrypted the demons!  But the good fellow of SciFi, also did not miss.  Overpowered their tricks and translated their secret writing into C: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">signed</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">short</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">filter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">signed</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">short</span></span></span></span><span class="hljs-function"><span class="hljs-params"> x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> fltmem[<span class="hljs-number"><span class="hljs-number">5</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">signed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">short</span></span> r6, r7, r9; r7 = fltmem[<span class="hljs-number"><span class="hljs-number">4</span></span>] - fltmem[<span class="hljs-number"><span class="hljs-number">0</span></span>]; fltmem[<span class="hljs-number"><span class="hljs-number">0</span></span>] = x; r6 = (r7 &gt;&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>) - (r7 &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>) - fltmem[<span class="hljs-number"><span class="hljs-number">4</span></span>]; fltmem[<span class="hljs-number"><span class="hljs-number">4</span></span>] = fltmem[<span class="hljs-number"><span class="hljs-number">3</span></span>]; fltmem[<span class="hljs-number"><span class="hljs-number">3</span></span>] = r6; r6 -= r7; r7 = fltmem[<span class="hljs-number"><span class="hljs-number">2</span></span>] - x; r9 = (r7 &gt;&gt; <span class="hljs-number"><span class="hljs-number">3</span></span>) - (r7 &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>) + fltmem[<span class="hljs-number"><span class="hljs-number">2</span></span>]; r7 -= r9; fltmem[<span class="hljs-number"><span class="hljs-number">2</span></span>] = fltmem[<span class="hljs-number"><span class="hljs-number">1</span></span>]; fltmem[<span class="hljs-number"><span class="hljs-number">1</span></span>] = r7; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (r6 - r9)&gt;&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br><br>  As it turned out, the demons were encrypted twice.  This code was obtained explicitly using a compiler, so only the compiler can use relative addressing.  But the code itself deserves interest and respect.  As you can see, it does not contain multiplication operations and can be effectively executed even on the simplest processors.  The good fellow SciFi, and all the others, had a question: ‚ÄúWhat kind of filter is it?‚Äù. <br>  To restore the block diagram of the filter on such a code, if possible, it is very time consuming.  Therefore, we will go the other way.  The conclusion about the type and parameters of the filter will be done on the amplitude-frequency characteristic (AFC).  How to get it?  Yes, how to send two bytes. <br>  Immediately, we note that this filter is a filter with an infinite impulse response.  This is guessed in the source code, the state of the filter is stored in the static array signed short fltmem [5]; <br>  We remove 60 samples of the filter impulse response, that is, the filter response to a single impulse.  But in the conditions of integer arithmetic, in order to get the final result with the best accuracy, we will input not 1 but 10000 values ‚Äã‚Äãto the filter input. More precisely, the maximum possible number that does not cause overflow must be supplied. <br>  Test code for removing impulse response: <br><br><pre> <code class="cpp hljs"><span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d\r\n"</span></span>, filter(<span class="hljs-number"><span class="hljs-number">10000</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i=<span class="hljs-number"><span class="hljs-number">1</span></span>;i&lt;<span class="hljs-number"><span class="hljs-number">100</span></span>;i++) { <span class="hljs-built_in"><span class="hljs-built_in">printf</span></span>(<span class="hljs-string"><span class="hljs-string">"%d\r\n"</span></span>, filter(<span class="hljs-number"><span class="hljs-number">0</span></span>)); }</code> </pre> <br><br>  The result obtained, using copy-pasting, will be processed in the mathematical package MathCad. <br>  Construct a graph of impulse response.  On the interval of 0-20 counts, it looks like this: <br><br><img src="https://habrastorage.org/files/01b/d38/70b/01bd3870b3f34975bd4e1063d3359669.gif"><br><br>  And on the interval of 20-60 samples, it looks like this: <br><br><img src="https://habrastorage.org/files/b45/16b/473/b4516b4737484aba89fba71ab2b0f036.gif"><br><br>  From the analysis of the impulse response it is clear that the filter is not without flaws.  The impulse response contains continuous oscillations of amplitude one discrete.  In the theory of the synthesis of filters with an infinite characteristic [Goldenberg LM and others. Digital signal processing.  M .: Radio and Communications, 1985] it is accepted to call such oscillations limit cycles, which arise due to the rounding error of integers. <br>  The complex transfer coefficient of the filter under study can be defined as the Fourier transform of the impulse response.  Only in the case of a discrete impulse response, integration over the time axis can be replaced by addition over all nonzero samples.  In our case, the complex ratio of the transmission case is determined by the expression: <br><br><img src="https://habrastorage.org/files/6fd/acf/aa9/6fdacfaa9cb14f898e6391107ca01eda.gif"><br><br>  Where H is an array of impulse response samples; <br>  f is the frequency normalized to the sampling rate; <br><br>  We construct a graph of the modulus of the complex transmission coefficient, amplitude-frequency characteristic, in a logarithmic scale (LAFC).  Here and below, when plotting graphs, the frequency normalized to the sampling frequency is used. <br><br><img src="https://habrastorage.org/files/c8f/66d/583/c8f66d583873422381db2d0a1902380e.gif"><br><br>  Using the built-in tools of the mathematical package, we define the key points of the frequency response: <br><ul><li>  Filter cut-off frequency by -3dB level - 0.25 </li><li>  The transmission coefficient at a frequency of 0.3 - -13.266dB </li><li>  The transmission coefficient at a frequency of 0.4 - -37.013dB </li></ul><br>  Accordingly, the slope of the characteristic outside the passband is: <br><br><img src="https://habrastorage.org/files/9cf/3d9/d04/9cf3d9d0469d44afb4dfb0b5320c92c1.gif">  DB / decade <br><br>  For completeness, we give the phase-frequency characteristic (phase response): <br><br><img src="https://habrastorage.org/files/00b/5ce/239/00b5ce2393e447228c67f5c8a60c4fac.gif"><br><br>  The phase shift at a frequency of 0.48 is (180 + 180 + 87) = 447 degrees.  Breaking a phase on a graph can be puzzling if you forget about the ambiguity of the arctangent. <br>  Also, for the sake of completeness, we give the group delay time (GDT). <br><br><img src="https://habrastorage.org/files/66e/e14/cc0/66ee14cc0c224679a66ca2874c477fbc.gif"><br><br>  Now, deep in thought, you can answer the question <i>‚ÄúWhat is this filter?‚Äù</i> . <br><br>  <b>The order of the filter.</b>  From the analysis of the logarithmic amplitude-frequency characteristic, it can be assumed that this filter is a 10 order link, the characteristic slope outside the passband is about 20 * 10 = 200 dB / decade.  But from the analysis of the phase characteristics it can be seen that the phase shift tends to 90 * 5 = 450 degrees.  Here, the inexperienced ‚Äúfilter guesser‚Äù involuntarily has thoughts about the non-minimal phase property of this link.  But do not forget that the ‚Äúanalog‚Äù frequency is displayed in the ‚Äúdigital‚Äù through the tangent and, therefore, the laws of the analog world (20 dB / decade, etc.) work only at frequencies much less than the sampling frequency.  In our case, we consider LAFH in the area close to half the sampling rate, and the laws of the analog world do not work. <br>  Thus, by the form of the phase characteristic, it can be concluded that this link is a link of 5th order. <br><br>  <b>Type of filter.</b>  Taking into account the form of LAFC (in the bandwidth of LAFC is as flat as possible) and the type of graph of the HRT (extremum near the cut-off frequency), it can be assumed that this link is a Butterworth filter.  To confirm our assumption, we construct LAFC, PFH and GHZ of an ideal digital Butterworth filter with a cut-off frequency of 0.25 synthesized by the bilinear transformation method [ <a href="https://ru.wikipedia.org/wiki/%25D0%2591%25D0%25B8%25D0%25BB%25D0%25B8%25D0%25BD%25D0%25B5%25D0%25B9%25D0%25BD%25D0%25BE%25D0%25B5_%25D0%25BF%25D1%2580%25D0%25B5%25D0%25BE%25D0%25B1%25D1%2580%25D0%25B0%25D0%25B7%25D0%25BE%25D0%25B2%25D0%25B0%25D0%25BD%25D0%25B8%25D0%25B5">Wikipedia</a> ]. <br>  On the graphs, a red solid line indicates the values ‚Äã‚Äãcorresponding to the filter under investigation, a blue dashed line - an ideal digital Butterworth filter synthesized by the bilinear transformation method <br><br><img src="https://habrastorage.org/files/34d/e9e/301/34de9e30123f4e019fb981eaa4ecb78c.gif"><br><br><img src="https://habrastorage.org/files/cb6/2c4/b4d/cb62c4b4d3b74e5db212654b7c2b0da3.gif"><br><br><img src="https://habrastorage.org/files/98c/d2c/1e8/98cd2c1e82c145538a4203b2e0630fd0.gif"><br><br>  As can be seen from the graphs, the almost complete coincidence of the parameters of the studied filter with the parameters of an ideal digital Butterworth filter synthesized by the bilinear transformation method. <br><br>  <b>Conclusion</b> <br>  In this paper, we investigated the remarkable implementation of the 5-order Butterworth digital filter.  This implementation of the filter, despite its shortcomings in the form of a limit cycle, deserves great respect.  Texas Instruments engineers managed to implement a fairly complex filter algorithm of 5 order in integers, not using the multiplication and division operations, while ensuring acceptable stability and consistency of the filter characteristics to the prototype. <br>  Your humble servant sincerely hopes that the method used to analyze the code of digital filters used in this work will be interesting and useful to the reader. </div><p>Source: <a href="https://habr.com/ru/post/324522/">https://habr.com/ru/post/324522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../324510/index.html">Badoo time-series storage: so she was called Cassandra</a></li>
<li><a href="../324512/index.html">Fighting beaver with donkey, or Adapting MSVC code under gcc</a></li>
<li><a href="../324514/index.html">Parametric modeling in CAD SolveSpace: Sketch</a></li>
<li><a href="../324516/index.html">Event for Unity-developers in Kharkov</a></li>
<li><a href="../324518/index.html">Functional programming and c ++ in practice</a></li>
<li><a href="../324524/index.html">Spring aggravation: design school in Innopolis, methodological intensive and informational information meeting</a></li>
<li><a href="../324528/index.html">Yandex.Money staged a vote for the abolition of the commission for transfers between wallets</a></li>
<li><a href="../324530/index.html">A little bit about the privacy of real Git repositories.</a></li>
<li><a href="../324532/index.html">Unpredictable effects of Chrome performance optimization</a></li>
<li><a href="../324534/index.html">Why 90% of landings do not sell? How to close customer objections 2 times more effective than competitors</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>