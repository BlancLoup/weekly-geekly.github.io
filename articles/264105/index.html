<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Each host branch with capistrano</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I think many people are familiar with the notion of ‚Äústruggle for staging‚Äù, when all the developers at the same time the day before the release want t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Each host branch with capistrano</h1><div class="post__text post__text-html js-mediator-article">  I think many people are familiar with the notion of ‚Äústruggle for staging‚Äù, when all the developers at the same time <s>the day before the release</s> want to share their achievements so that the tester checks them as soon as possible <s>and does not have to edit bugs all night</s> , right?  Who is interested to see how we solve this problem for RoR-projects with the help of Capistrano? I ask under cat. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/492/406/3c4/4924063c43c44b13a8bb372a26fa7f0c.png"></div><br><a name="habracut"></a><br><h2>  <font color="#00a9c0">Little about tools</font> </h2><br>  Every new ticket we make in a separate thread, as advised by this <a href="http://habrahabr.ru/post/106912/">git-flow</a> .  We use JIRA as the task manager / bug tracker, so the ticket number in JIRA = branch name.  We use Jenkins CI not at full capacity, so far only for deploying code on the staging development version after merge into it for integration testing. <br><br><h2>  <font color="#00a9c0">The essence of the problem</font> </h2><br>  I wanted to be able to check each ticket in isolation, and take only verified tickets to the release, and leave those that contain bugs to the next. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <font color="#00a9c0">What other than Capistrano?</font> </h2><br>  Considered various options from sharinga working machine using <a href="https://ngrok.com/">ngrok</a> to SaaS like <a href="https://teatro.io/">teatro</a> .  The first option turned out to be inconvenient, and the second one was dropped because not all projects have the opportunity to send to a third party.  Therefore, since all our RoR projects are deployed using capistrano, it was decided to write a small extension that will deploy the project from a specific branch to its host (for example, <a href="http://jira-123.example.com/">jira-123.example.com</a> ). <br><br><h2>  <font color="#00a9c0">Process</font> </h2><br>  In short, the development process looks like this: after running the ticket, the developer pours it onto the demo host, after checking the tester creates a merge request, after closing which Jenkins pours a future release on staging. <br><br><h2>  <font color="#00a9c0">What makes capistrano-demo</font> </h2><br>  All that the developer does during development is pouring code, rolling in migrations and starting third-party services (sidekiq, resque, etc.). <br><br>  This plugin has a number of limitations, the most important thing is that it works only for RoR projects, and only with git. <br><br><h2>  <font color="#00a9c0">Configuration</font> </h2><br><pre><code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#        ,    , #         set :demo_db, -&gt; { demo_default_db } # ,      - set :demo_host, -&gt; { fetch(:application) } #       . #      ,    unicorn, nginx  sidekiq: # invoke 'unicorn:restart' # invoke 'sidekiq:restart' # execute :sudo, :service, 'nginx restart' # execute :rake, 'cache:clear' set :demo_restart_cmd, -&gt; { raise 'You must specify "demo_restart_cmd" proc' } # ,     ,    # : # File.expand_path("../../../../config/stages/#{fetch(:stage)}/templates", __FILE__) set :demo_templates_dir, nil # ,        ,    .erb # : # set :demo_templates_entries, [ # {template: '/nginx.conf.erb', file: demo_path.join('config', 'nginx.conf')}, # {template: '/database.yml.erb', file: demo_path.join('config', 'database.yml')}, # {template: '/unicorn.rb.erb', file: demo_path.join('config', 'unicorn.rb')}, # {template: '/settings.local.yml.erb', file: demo_path.join('config', 'settings.local.yml')}] set :demo_templates_entries, []</span></span></code> </pre> <br><h2>  <font color="#00a9c0">How to use</font> </h2><br>  This plugin has only three commands: <br><br><ul><li>  demo: create - create / update demo host </li><li>  demo: restart - reboot </li><li>  demo: destroy - Stop processes (configured using before / after) and delete directories. </li></ul><br>  To create a demo host you just need to type <b>cap staging demo: create</b> from the working directory and that's it.  By default, you will be prompted to cast the current branch. <br><br><h2>  <font color="#00a9c0">Conclusion</font> </h2><br>  At the moment, the biggest problem is a long assembly of assets, you need to force it not to recompile everything, but only differential.  And also, someone's migration can break other people's hosts, so at staging we keep a clean base, in such a case.  There were attempts to make a separate database for each branch, but then you had to create either an empty database or copy it.  The first option is bad because you would have to fill in content for testing, and the second one does not have a universal means for copying data for several DBMS, but in the future we plan to make adapters for SqlLite, MySql and Postgres. <br><br>  We laid out our developments in <a href="https://github.com/atconsulting/capistrano-demo">open access</a> , so everyone can read and use, pull requests are welcome. <br><br>  PS: I am ready to answer your questions in the comments, listen to alternative solutions and constructive criticism. </div><p>Source: <a href="https://habr.com/ru/post/264105/">https://habr.com/ru/post/264105/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264093/index.html">Social login: strengths</a></li>
<li><a href="../264097/index.html">Digest of grocery design, July 2015</a></li>
<li><a href="../264099/index.html">The magic of tensor algebra: Part 17 - Sketch of nut Janibekova</a></li>
<li><a href="../264101/index.html">Can information security increase revenue, increase customer loyalty, and solve other business problems?</a></li>
<li><a href="../264103/index.html">Application Development with NexStreaming NexPlayer SDK</a></li>
<li><a href="../264109/index.html">Starkon 2015 through the eyes of an indie developer</a></li>
<li><a href="../264113/index.html">Code contracts vs incoming data validation</a></li>
<li><a href="../264115/index.html">Creating a game on Blend4Web. Programmer's path</a></li>
<li><a href="../264117/index.html">Passing the Experience: The Jedi Path</a></li>
<li><a href="../264119/index.html">"All Tolstoy in one click": how we did it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>