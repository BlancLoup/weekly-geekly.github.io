<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Installing and configuring a VPN server with AbillS billing system on Ubuntu 7.10</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone knows that the situation with the prices of the Internet in Moscow and in Russia is strikingly different. 
 For comparison, in Tolya...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Installing and configuring a VPN server with AbillS billing system on Ubuntu 7.10</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone knows that the situation with the prices of the Internet in Moscow and in Russia is strikingly different. <br>  For comparison, in Tolyatti (Samara region), unlimited access at a speed of 512kbit / s for a month costs 2300 rubles. <br>  In the capital for the same amount you can probably take already 20Mbps. <br><br>  So, no matter how wild it may sound, but I'm going to, to reduce costs, share this channel (512kbit / s) with several more people in the local home network =) <br><br>  The provider gives access to the Internet through its VPN server. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Users in LAN have access to urban resources for free and without traffic control. <br>  Vneshka was decided to release them through a VPN connection to a server on the local network. <br><br>  The system was tested and has been working for almost half a year, no complaints have been received in the work, everything is stable. <br><br>  Server configuration: Pentium III 1000MHz, SDRAM 512Mb <br><br>  To reduce the load on the server, it was decided not to use compression and encryption, therefore, the clients need to additionally uncheck the ‚Äúrequire encryption‚Äù option in the VPN settings in Windows <br><br>  In this manual, it was decided to collect all the experience of installation and configuration. <br>  Initially I wrote for myself, but I think the public can also be useful. <br><br><a name="habracut"></a><br>  So let's proceed to installing a VPN server with <a href="http://abills.net.ua/">abills</a> billing <br><br>  Installing Ubuntu 7.10 <br>  It makes no sense to describe it, so go to the setting.  =) Well, the only thing I can see is that you should install the server version of Ubuntu without graphics. <br><br>  OS Setup <br>  So, we need to configure NAT on the server in order to release local clients to the insider network. <br>  In /etc/rc.local we set the following lines for automatic restoration of settings after failures. <br><blockquote><pre>  echo "1"&gt; / proc / sys / net / ipv4 / ip_dynaddr
 echo "1"&gt; / proc / sys / net / ipv4 / ip_forward
 iptables-restore /etc/iptables.conf </pre></blockquote>  The iptables settings will be stored in the /etc/iptables.conf file <br>  Next, we add the following lines to the / etc / modules file. <br><blockquote><pre>  ip_conntrack
 ip_gre
 ip_nat_pptp
 ip_conntrack_ftp
 ip_nat_ftp </pre></blockquote>  To apply all these parameters, you can run the /etc/rc.local script and give the commands <br><blockquote><pre>  modprobe ip_conntrack
 modprobe ip_gre
 modprobe ip_nat_pptp
 modprobe ip_conntrack_ftp
 modprobe ip_nat_ftp </pre></blockquote>  After that, to raise the NAT is enough to register the command <br><blockquote><pre>  iptables -t nat -A POSTROUTING -o!  eth1 -j MASQUERADE </pre></blockquote>  Interface eth1 - looking to LAN <br>  Everything, now all users from LAN can go to the internal network of the provider. <br>  Do not forget to save the firewall settings <br><blockquote><pre>  iptables-save&gt; /etc/iptables.conf </pre></blockquote>  Configuring VPN (pptp) client for server access to the Internet. <br>  If you have a DVD or internet connection, you can simply give the command <br><blockquote><pre>  apt-get install pptp-linux </pre></blockquote>  if there is no possibility of automatic installation, then you need to download the package to the folder and start the installation manually. <br><blockquote><pre>  dpkg -i pptp-linux_1.7.0-2ubuntu2_i386.deb </pre></blockquote>  Now let's start setting up the VPN, for this we go to the / etc / ppp / peers folder and create a file for example aist there <br><blockquote><pre>  vim / etc / ppp / peers / aist </pre></blockquote>  and we are already writing in it <br><blockquote><pre>  mtu 1400
 mru 1500
 persist
 maxfail 0
 lcp-echo-interval 60
 lcp-echo-failure 4
 pty "pptp address of the provider's vpn server --nolaunchpppd"
 name login
 password password
 remotename PPTP
 require-mppe-128
 defaultroute
 replacedefaultroute </pre></blockquote>  Now, before raising the VPN, it is necessary to prescribe the routing for the provider's internal network, since  through VPN there is no access to it. <br>  We edit the / etc / network / interfaces file to get something like the following <br><blockquote><pre>  auto lo eth1 eth0
 iface lo inet loopback

 iface eth1 inet static
    address 192.168.110.1
    netmask 255.255.255.0

 iface eth0 inet dhcp
    up route add-net 172.16.0.0 netmask 255.240.0.0 dev eth0
    up route add -net 10.0.0.0 netmask 255.0.0.0 dev eth0
    up route add -net 192.168.0.0 netmask 255.255.255.0 dev eth0
    up pon aist
    pre-down poff aist </pre></blockquote>  To check, you can use the command <br><blockquote><pre>  /etc/init.d/networking restart </pre></blockquote>  after that, all interfaces will be restarted.  VPN will connect automatically. <br>  If everything went well, then you can check with the ifconfig command whether the ppp0 interface appeared. <br>  !!!  Attention, at this moment you have configured NAT on your server and raise the Internet, i.e.  All users from LAN have unlimited access to the Internet. !!! <br><br>  Vpn can be disabled using the poff aist command <br>  Connect - pon aist <br><br>  Freeradius installation <br><blockquote><pre>  apt-get install freeradius </pre></blockquote>  Editing / etc / freeradius / users leaving only the following lines <blockquote><pre> DEFAULT Auth-Type = Accept
   Exec-Program-Wait = "/usr/abills/libexec/rauth.pl" </pre></blockquote>  The rest is commented out or deleted. <br><br>  Next, edit / etc / freeradius / acct_users append to the end <br><blockquote><pre>  DEFAULT Acct-Status-Type == Start
   Exec-Program = "/usr/abills/libexec/racct.pl"

 DEFAULT Acct-Status-Type == Alive
   Exec-Program = "/usr/abills/libexec/racct.pl"

 DEFAULT Acct-Status-Type == Stop
   Exec-Program = "/usr/abills/libexec/racct.pl" </pre></blockquote>  Edit /etc/freeradius/clients.conf, comment everything, add to the end <br><blockquote><pre>  client localhost {
   secret = radsecret
   shortname = shortname
 } </pre></blockquote>  And also I don `t know why, but when I set up I had such a glitch and I had to add this line with the address to eth0 <br><blockquote><pre>  client 172.16.102.72 {
   secret = radsecret
   shortname = shortname
 } </pre></blockquote>  In /etc/freeradius/radiusd.conf, we comment on the mschap and eap lines in the authorize section <br><blockquote><pre>  authorize {
   preprocess
   #chap
   #counter
   #attr_filter
   #eap
   suffix
   files
   #etc_smbpasswd
   #sql
   #mschap
 } </pre></blockquote>  Moving on to editing the / etc / freeradius / dictionary file is added to the end. <br><blockquote><pre>  # Limit session traffic
 ATTRIBUTE Session-Octets-Limit 227 integer
 # What to assume as limit - 0 in + out, 1 in, 2 out, 3 max (in, out)
 ATTRIBUTE Octets-Direction 228 integer
 # Connection Speed ‚Äã‚ÄãLimit
 ATTRIBUTE PPPD-Upstream-Speed-Limit 230 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit 231 integer
 ATTRIBUTE PPPD-Upstream-Speed-Limit-1 232 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit-1 233 integer
 ATTRIBUTE PPPD-Upstream-Speed-Limit-2 234 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit-2 235 integer
 ATTRIBUTE PPPD-Upstream-Speed-Limit-3 236 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit-3 237 integer
 ATTRIBUTE Acct-Interim-Interval 85 integer </pre></blockquote>  After this restart the radius <br>  /etc/init.d/freeradius restart <br><br>  Radiusclient setting <br>  Install Radiusclient <br><blockquote><pre>  apt-get install radiusclient1 </pre></blockquote>  Edit the /etc/radiusclient/radiusclient.conf file: <br><blockquote><pre>  authserver 127.0.0.1
 acctserver 127.0.0.1 </pre></blockquote>  Editing / etc / radiusclient / servers <br><blockquote><pre>  127.0.0.1 radsecret </pre></blockquote>  Add to / etc / radiusclient / dictionary <br><blockquote><pre>  ATTRIBUTE Acct-Interim-Interval 85 integer
 ATTRIBUTE Session-Octets-Limit 227 integer
 ATTRIBUTE Octets-Direction 228 integer

 ATTRIBUTE PPPD-Upstream-Speed-Limit 230 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit 231 integer
 ATTRIBUTE PPPD-Upstream-Speed-Limit-1 232 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit-1 233 integer
 ATTRIBUTE PPPD-Upstream-Speed-Limit-2 234 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit-2 235 integer
 ATTRIBUTE PPPD-Upstream-Speed-Limit-3 236 integer
 ATTRIBUTE PPPD-Downstream-Speed-Limit-3 237 integer </pre></blockquote>  Download the billing system AbillS unpack it <br><blockquote><pre>  tar -xf abills-0.37.tgz </pre></blockquote>  Transfer it to the / usr / abills folder <br><blockquote><pre>  mv abills / usr / </pre></blockquote>  MySQL setup <br>  Install <br><blockquote><pre>  apt-get install mysql-server </pre></blockquote>  Next, you need to create a database for AbillS <br><blockquote><pre>  mysql -u root -p
 CREATE DATABASE abills; </pre></blockquote>  Now the dump of the database from the directory with abills must be entered into the database <blockquote><pre>  mysql -u root -p abills &lt;abills.sql </pre></blockquote><br>  Install Apache <br><br><blockquote><pre>  apt-get install apache2 </pre></blockquote><br>  Add support for mod_rewrite. <br><br><blockquote><pre>  ln -s /etc/apache2/mods-available/rewrite.load /etc/apache2/mods-enabled/rewrite.load </pre></blockquote><br>  Edit / etc / apache2 / sites-enabled / 000-default <br><blockquote><pre> &lt;VirtualHost *&gt;  
    DocumentRoot / usr / abills / cgi-bin /
     Alias ‚Äã‚Äã/ abills "/ usr / abills / cgi-bin /"
     &lt;Directory "/ usr / abills / cgi-bin"&gt;  
   &lt;IfModule mod_rewrite.c&gt;  
       RewriteEngine on   
         RewriteCond% {HTTP: Authorization} ^ (. *) 
        RewriteRule ^ (. *) - [E = HTTP_CGI_AUTHORIZATION:% 1]  
       Options Indexes ExecCGI SymLinksIfOwnerMatch   
      &lt;/ IfModule&gt;    
     AddHandler cgi-script .cgi   
     Options Indexes ExecCGI FollowSymLinks   
     AllowOverride none    
     DirectoryIndex index.cgi    
     #Options ExecCGI       
    &lt;Files ~ "\. (Db | log) $"&gt;      
      Order allow, deny       
     Deny from all      
   &lt;/ Files&gt;  
  &lt;/ Directory&gt;      
 #Admin interface   
  &lt;Directory "/ usr / abills / cgi-bin / admin"&gt;  
   AddHandler cgi-script .cgi   
    Options Indexes ExecCGI FollowSymLinks    
     AllowOverride none  
   DirectoryIndex index.cgi  
   order deny, allow  
   allow from all   
  &lt;/ Directory&gt;    
 &lt;/ Virtualhost&gt;    
</pre></blockquote><br>  * Here habr eats some tags, you can take a plot <a href="http://iglooom.livejournal.com/3739.html">from here</a> <br><br>  Now install the packages for perl <br><blockquote><pre>  apt-get install libdbi-perl libdbd-mysql-perl libdigest-md4-perl libdigest-sha1-perl libcrypt-des-perl </pre></blockquote>  Restart apache <br>  /etc/init.d/apache2 restart <br><br>  Setting abills <br>  In the / usr / abills / libexec folder, run cp config.pl.default config.pl, then edit config.pl <br>  Specify the correct details of access to the database, also change <br><blockquote><pre>  $ conf {MAX_SESSION_TRAFFIC} = 2047;
 $ conf {periodic_check} = 'yes';
 $ conf {ERROR_ALIVE_COUNT} = 10; </pre></blockquote>  Next, edit / etc / sudoers add the line <br><blockquote><pre>  www-data ALL = NOPASSWD: / usr / abills / misc / pppd_kill </pre></blockquote>  In / etc / crontab we bring <br><blockquote><pre>  * / 5 * * * * root / usr / abills / libexec / billd -all
 1 0 * * * root / usr / abills / libexec / periodic daily
 1 0 1 * * root / usr / abills / libexec / periodic monthly </pre></blockquote>  Set read and write permissions by webserver for web interface files <br><blockquote><pre>  chown -Rf www-data / usr / abills / cgi-bin </pre></blockquote>  Create the missing directories: <br><blockquote><pre>  mkdir / usr / abills / backup
 chown www-data / usr / abills / backup
</pre></blockquote><br>  Run apt-get install snmp <br><br>  Edit the file /usr/abills/Abills/defs.conf <br><blockquote><pre>  $ SNMPWALK = '/ usr / bin / snmpwalk';
 $ Gzip = '/ bin / gzip';
 $ MYSQLDUMP = '/ usr / bin / mysqldump'; </pre></blockquote>  2.9 Installing pptpd <br><blockquote><pre>  apt-get install pptpd </pre></blockquote><br><br>  Editing / etc / ppp / options <br><blockquote><pre>  + chap </pre></blockquote><br>  Editing / etc / ppp / pptpd-options <br><blockquote><pre>  # require-mppe-128
 # require-mschap-v2
 plugin radius.so
 plugin radattr.so
 debug
 ms-dns 192.168.160.1 </pre></blockquote><br>  Editing /etc/pptpd.conf <br><blockquote><pre>  ppp / usr / sbin / pppd
 option / etc / ppp / pptpd-options
 debug
 localip 192.168.160.1 </pre></blockquote><br>  Restart pptpd /etc/init.d/pptpd restart <br><br>  For speed limiter operation, add to / etc / ppp / ip-up <br><blockquote><pre> if [-f /var/run/radattr.$1]
 then
 DOWNSPEED = `/ usr / bin / awk '/ PPPD-Downstream-Speed-Limit / {print $ 2}' / var / run / radattr. $ 1`
 UPSPEED = `/ usr / bin / awk '/ PPPD-Upstream-Speed-Limit / {print $ 2}' / var / run / radattr. $ 1`
 FILTERS = `/ usr / bin / awk '/ Filter-Id / {print $ 2}' / var / run / radattr. $ 1`
 #echo $ DOWNSPEED
 #echo $ UPSPEED
 #echo $ FILTERS
 / sbin / tc qdisc del dev $ 1 root&gt; / dev / null
 / sbin / tc qdisc del dev $ 1 ingress&gt; / dev / null

 ##### speed server-&gt; client
 if ["$ UPSPEED"! = "0"];
 then
 / sbin / tc qdisc add dev $ 1 root handle 1: htb default 20 r2q 1
 / sbin / tc class add dev $ 1 parent 1: classid 1: 1 htb rate $ {UPSPEED} kbit burst 4k
 / sbin / tc class add dev $ 1 parent 1: 1 classid 1:10 htb rate $ {UPSPEED} kbit burst 4k prio 1
 / sbin / tc class add dev $ 1 parent 1: 1 classid 1:20 htb rate $ {UPSPEED} kbit burst 4k prio 2
 / sbin / tc qdisc add dev $ 1 parent 1:10 handle 10: sfq perturb 10 quantum 1500
 / sbin / tc qdisc add dev $ 1 parent 1:20 handle 20: sfq perturb 10 quantum 1500
 / sbin / tc filter add dev $ 1 parent 1: 0 protocol ip prio 10 u32 match ip tos 0x10 0xff flowid 1:10
 / sbin / tc filter add dev $ 1 parent 1: 0 protocol ip prio 10 u32 match ip protocol 1 0xff flowid 1:10
 / sbin / tc filter add dev $ 1 parent 1: protocol ip prio 10 u32 match ip protocol 6 0xff match u8 0x05 0x0f at 0 match u160x0000 0xffc0 at 2 match u8 0x10 0xff at 33 flowid 1:10
 fi

 ##### speed client-&gt; server
 if ["$ DOWNSPEED"! = "0"];
 then
 / sbin / tc qdisc add dev $ 1 handle ffff: ingress
 / sbin / tc filter add dev $ 1 parent ffff: protocol ip prio 50 u32 match ip src 0.0.0.0/0 police rate $ {DOWNSPEED} kbit burst 12k drop flowid: 1
 fi
 fi </pre></blockquote><br><br>  3 AbillS Settings <br>  Open the admin web interface at your <a href="http://xn--80ad1bmfpu/admin">host / admin</a> <br>  Username / password abills / abills can then be changed. <br><br>  Go to System configuration-&gt; NAS <br>  Ip write 127.0.0.1 <br>  Select the type of pppd: pppd + Radius <br>  Alive (sec.): 120 <br>  RADIUS Parameters (,): Acct-Interim-Interval = 60 <br><br>  Now add IP POOLs <br>  we set 192.168.160.2-192.168.160.254 <br><br>  It remains to create tariffs and users, enjoy;) <br>  <a href="http://iglooom.livejournal.com/3739.html">Crosspost from my blog</a> <br></div><p>Source: <a href="https://habr.com/ru/post/23650/">https://habr.com/ru/post/23650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../236489/index.html">Version Control Systems: Fossil Part II</a></li>
<li><a href="../23649/index.html">Habroyashchik, Wednesday - April 16.</a></li>
<li><a href="../236491/index.html">Cheat sheet for comparing Twitter Bootstrap and Zurb Foundation classes</a></li>
<li><a href="../236493/index.html">DigiSole smart insoles will teach how to put a foot correctly and will monitor the owner‚Äôs physical activity</a></li>
<li><a href="../236499/index.html">New Berlin: Lumia accessories</a></li>
<li><a href="../236501/index.html">Raffle in honor of the Day of programmer</a></li>
<li><a href="../236503/index.html">Analyzing Weird Correlations</a></li>
<li><a href="../236505/index.html">Wearable electronics at IFA 2014</a></li>
<li><a href="../236507/index.html">Summation of divergent series by the methods of Abel, Borel, Cesaro and Dirichlet</a></li>
<li><a href="../236509/index.html">Epson Photo Contest - not just yet another photo contest</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>