<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MVC 5 Owin authorization on the example of Vkontakte</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Not so long ago, mvc 5 was released and one of the key changes is the authorization system. When creating an ‚Äúempty‚Äù mvc 5 project, it is possible to ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MVC 5 Owin authorization on the example of Vkontakte</h1><div class="post__text post__text-html js-mediator-article">  Not so long ago, mvc 5 was released and one of the key changes is the authorization system.  When creating an ‚Äúempty‚Äù mvc 5 project, it is possible to connect authorization for Facebook, Google, Twitter and Microsoft accounts.  I immediately found it helpful to understand how this all works and the result was the ‚Äúmiddleware‚Äù module for the Vkontakte network.  You can put it through nuget packages by searching ‚ÄúDuke.Owin.VkontakteMiddleware‚Äù and view the source: <a href="https://github.com/DukeNuken/Duke.Owin.VkontakteMiddleware">github.com/DukeNuken/Duke.Owin.VkontakteMiddleware</a> <br><br>  There are many articles on the <a href="http://blogs.msdn.com/b/webdev/archive/2013/07/03/understanding-owin-forms-authentication-in-mvc-5.aspx">Internet</a> about <a href="http://blogs.msdn.com/b/webdev/archive/2013/07/03/understanding-owin-forms-authentication-in-mvc-5.aspx">owin authorization</a> and the katana project with which you can read and even download the <a href="http://katanaproject.codeplex.com/SourceControl/latest">source code</a> . <br><a name="habracut"></a><br>  And now I propose to discuss in general terms how it all works.  A bit of history.  Once upon a time, about 6 years ago, one customer asked me to make beautiful links like "/ account / register" on the site and since the project was on asp.net, the only solution was to install the UrlRewriting module for IIS and everything worked well on the site, but In the studio, such links clearly did not open, which caused some inconvenience.  Since Microsoft released mvc, the UrlRewriting logic is implemented on the project side (RouteConfig), the same is done on the project side and script optimization (BundleConfig).  This allows the project to work correctly all server dependencies.  By the same principle authorization was added to mvc 5. <br><br>  The Startup class is in the project / App_Start and there is only one ConfigureAuth function (IAppBuilder app) in it.  It twitches at the start of the project and loads the so-called middleware modules.  What is it and how do they work?  In essence, these are classes that inherit from AuthenticationMiddleware.  In this class there is a constructor and a method CreateHandler ().  This method is called each time a page is accessed, and all it has to do is create an AuthenticationHandler which, in turn, has 2 methods.  Consider them in more detail. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1) <b>protected override Task ApplyResponseChallengeAsync ()</b> - this method is called <b>after</b> testing the logic in the controls and before sending the response to the user.  He takes 3 important steps.  Checks the http code of the response - whether 401 (not autorized) is equal, if yes, then a special helper checks if this module should do authorization, if so, redirect to the authorization site and as a result, the user sees this form: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4f0/454/0d9/4f04540d98932ea37b5442889a681dd1.png" alt="image"><br><br>  That is, the first method actually works only after the user clicks on the Vknotakte button on the login page.  An example of the page can be seen <a href="http://freemusiclib.com/Account/Login">here</a> , in all other cases it simply transfers control further. <br><br>  After confirmation, the user will be transferred back to your site on the module return page.  Approximately such '/ signin-vkontakte? Code = 8e40fbe05c7ec232c0' (this return page is set in the module parameters) and at this moment the second method is working <br><br>  2) <b>public override async Task &lt;bool&gt; InvokeAsync ()</b> - this method is twitching on each page <b>before</b> working on the controls and checking its ‚Äúbasic‚Äù link with the request.  If they match, then authorization takes place.  On the example of a module for VKontakte, this method essentially waits for the '/ signin-vkontakte' link from the first method. <br><br>  Inside the InvokeAsync method, the ‚Äú <a href="https://oauth.vk.com/access_token">oauth.vk.com/access_token</a> ‚Äù page <a href="https://oauth.vk.com/access_token">twitches</a> and gets the token, then the Vkontakte API is accessed and information about the user is received - the name and id.  Based on this data, an <b>AuthenticationTicket</b> is created.  In turn, the AuthenticationTicket is used to create the ReturnEndpointContext object and save the information through the Microsoft.Owin.Security.AuthenticationManager.  After that, the user is transferred to / Account / ExternalLoginCallback and can <b>complete the registration by</b> specifying what name he wants to register on the site. <br><br><h5>  I would like to note a few things: </h5><br>  1) The behavior of the ‚Äúmiddleware‚Äù module is very similar to the usual http module, which gets control at the beginning and end of the request. <br><img src="https://habrastorage.org/getpro/habr/post_images/1c5/871/d81/1c5871d81cb1bdbb9800d198b19420da.png" alt="image"><br><br>  2) It would seem that there are two types of registration - registration on the site and registration through the owin modules, but eventually when after logging in on Vkontakte the user will be returned to the site page "/ Account / ExternalLoginCallback" (on the page there will be a message that he has logged in successfully, a text field for specifying the name and the Register button), then only when you click on Register, a normal account will be created and it will indicate that it belongs to the ‚ÄúVkontakte‚Äù provider and there will be a userid as a parameter.  In the database, it looks like this <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6b/74b/e8a/e6b74be8ae11dce5c9bbdacde0987e68.png" alt="image"><br><br>  That is, owin authorization on the site itself does nothing, but only provides information for regular registration. <br><br>  Thanks for attention. <br><br>  Live example here <a href="http://freemusiclib.com/Account/Login">freemusiclib.com/Account/Login</a> </div><p>Source: <a href="https://habr.com/ru/post/202344/">https://habr.com/ru/post/202344/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../202324/index.html">DDR4 will be available next month.</a></li>
<li><a href="../202328/index.html">Could there be too much automation on the plane?</a></li>
<li><a href="../202332/index.html">25th anniversary of the Buran flight</a></li>
<li><a href="../202334/index.html">The monitoring system in the car for him on the Raspberry Pi. Part 2</a></li>
<li><a href="../202340/index.html">Google rolled out a replacement Javascript - Dart language</a></li>
<li><a href="../202348/index.html">Scripts for managing virtual hosts on a Debian web server</a></li>
<li><a href="../202350/index.html">The history of the startup and its subsequent transformation into an outsourcing office</a></li>
<li><a href="../202354/index.html">How to assess the quality of user experience in data transfer?</a></li>
<li><a href="../202358/index.html">Hardware accelerated rendering in Chrome browser</a></li>
<li><a href="../202360/index.html">Sony PlayStation 4 Full review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>