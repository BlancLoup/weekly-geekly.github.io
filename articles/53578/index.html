<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A couple of words about UTF-8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Perl didn't know anything about encodings for a long time. The string was just a sequence of bytes, everyone kept everything they wanted, and only occ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A couple of words about UTF-8</h1><div class="post__text post__text-html js-mediator-article">  Perl didn't know anything about encodings for a long time.  The string was just a sequence of bytes, everyone kept everything they wanted, and only occasionally had to think about what kind of encoding this data had.  Times have changed, UTF has appeared;  perists had to support him.  As is usually the case, in a perl way.  I hope this article will save some health for those who are still in the dark about how to implement UTF-8 in Perl. <br><a name="habracut"></a><br>  Actually, the implementation of UTF-8 in Perl was two.  The first appeared in Perl 5.6, but was rather raw and uncomfortable.  Beginning with Perl 5.8, the unicode mechanism was radically revised, and the modules on CPAN were filled with amusing checks on the interpreter version.  Everything that is written below refers specifically to this second implementation. <br><br><h4>  Pros and cons </h4><br>  If you still haven‚Äôt thought about encodings, quietly developed monolingual applications and are going to continue in the same vein, you almost certainly don‚Äôt need a unicode.  Data in single-byte encodings is in any case more compact, they are processed faster, and it is easy and pleasant to deal with them. <br><br>  You will probably need UTF-8 if you do not know in advance what form the next portion of data will come to the application, or develop an international project.  After all, even if your site is in English, any German with umlauts in your full name, or even a resident of heaven, can easily register on it.  The easiest way to not think about what happens after this in the database (well, how you will show the name of the Chinese in your favorite latin-1) is to work in an encoding that supports many languages. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And one more case, when you cannot do without familiarity with Perl UTF - integration with third-party components working in this format.  For example, the <code>XML::LibXML</code> returns the results of parsing XML files in this format. <br><br><h4>  The perl way </h4><br>  Probably, the maintainers argued something like this: <i>we stored <b>byte</b> strings in variables, now we need to learn how to store <b>characters</b> there.</i>  <i>The length of a character in UTF-8 is variable and may be more than one byte.</i>  <i>If regulars and functions for working with strings (such as <code>length</code> , <code>substr</code> ) start behaving differently, they won't thank us.</i>  <i>So, you need to make two types of strings - for working in the old scheme, with <b>bytes</b> , and for working with the new scheme, with <b>characters</b> .</i>  <i>How to do it?</i>  <i>And let's introduce a hidden flag for scalars.</i>  <i>If the flag is set, the string is perceived as consisting of logical characters (let's call it <b>Perl Internal Format</b> ), if not - bytes.</i> <br><br>  If you take two identical unicode variables and one of them simply omits the flag, the variables will be processed by pearl differently (for example, they will most likely have different lengths).  However, the data itself does not change - it can be seen, for example, if both variables are output to a file, or to the screen. <br><br>  It is worth mentioning that UTF-8 <b>characters</b> are often called <b>wide characters</b> in Perl terminology.  If you come across varnings with these words, then it comes to unicode strings. <br><br>  There are several options for working with unicode data in Perl.  The main ones are: <br><ol><li>  the compulsory indication of unicode characters in a string is through a construct of the form <code>\x{0100}</code> ; </li><li>  manual transcoding of a string using the <code>Encode</code> module, or functions from the <code>utf8</code> package; </li><li>  including the <code>use utf8</code> pragma - the flag is raised for all constants that are encountered in the code; </li><li>  reading from the I / O descriptor indicating IO-Layers <code>:encoding</code> or <code>:utf8</code> - all data is automatically recoded into internal format. </li></ol>  With point number 1, I hope everything is clear and it does not cause questions.  Just in case, mention that curly braces are required.  The remaining options will take a closer look. <br><br><h5>  <code>Encode</code> module </h5><br>  The module is included in the delivery of Perl 5.8, so it makes sense to use it not only for Unicode, but also for any other encoding transformations.  Working with the module is not too complicated.  The only problem is to learn not to confuse the function <code>encode</code> with the function <code>decode</code> :-).  Their interface is the same, and the logic of the name is not as obvious as we would like.  Since the format of strings with a unicode flag is considered an <i>internal format</i> , it is necessary to <i>decode</i> data from arbitrary encoding (including UTF-8 without a flag), and vice versa, if you want to convert the data to some external encoding, you need to encode them from internal format her  It looks like this: <br><br> <code>$bytes = encode('cp1251', $string); #       cp1251 <br> $string = decode('cp1251', $bytes); #  </code> <br> <br>  Since not all characters can be lost without loss from one encoding to another, there is also a third parameter that determines how to behave in case of problems.  You can read about it in the <a href="http://perldoc.perl.org/Encode.html">documentation for the <code>Encode</code> module</a> , a whole section is devoted to it. <br><br>  If you are sure that your variable contains bytes in UTF-8, you can simply raise the flag of the variable without recoding and checking it with <code>_utf8_on</code> .  The <code>is_utf8</code> function will help determine whether a line has a flag (and, if desired, check the validity of the data lying there).  Well, the flag is reset, as you might guess, through <code>_utf8_off</code> .  The only "but" - these functions are marked as <i>INTERNAL</i> , and you should not count on their immutability. <br><br>  Beginning with Perl 5.8.1, some of the functions of the <code>Encode</code> module became available in the <code>utf8::</code> namespace <code>utf8::</code> these are <code>is_utf8</code> , <code>encode</code> , <code>decode</code> .  The last two differ from the synonyms from the <code>Encode</code> module in that they change the value of the passed variable instead of returning the result, and do not require encoding (it is understood that the work takes place with UTF-8 data without a raised flag).  All these functions are built into the interpreter, and you do not need to write <code>use utf8</code> to access them - moreover, this can lead to additional effects (about them a bit later). <br><br><h5> <code>use utf8;</code> </h5> <br>  The <code>use utf8</code> tells the interpreter that all constants and regular expressions written in its range and having non-ASCII characters should be treated as unicode and automatically converted to internal format.  To cancel the pragma action, as usual, use the <code>no utf8</code> construction. <br><br>  There is also an opposite by sense <code>use bytes</code> pragma, in the coverage of which even data with the UTF-8 flag are treated as consisting of bytes. <br><br><h5>  Perlio </h5><br>  The <i>Perl IO Layers</i> theme basically deserves a separate article.  The idea is that for some time now the good old <code>open</code> function has acquired a three-argument syntax: <br><br> <code>open $fh, $mode, $filename</code> <br> <br>  In addition to the standard values ‚Äã‚Äãof the type <code>'&gt;'</code> and <code>'&lt;'</code> in <code>$mode</code> you can also specify the file encoding.  At the same time, the loaded data is automatically converted into the internal Perl format: <br><br> <code>open $fh, "&lt;:encoding(cp1251)", $filename</code> <br> <br>  If we are talking about a file that contains data in UTF-8, the code can be slightly simplified: <br><br> <code>open $fh, "&lt;:utf8", $filename</code> <br> <br>  Of course, these modifiers can also be used to modify files - the effect will be the opposite. <br><br>  By the way, in Perl it is possible to make I / O streams unicode once and for all using the <code>-C</code> command line key.  Details can be seen, as always, in <a href="http://perldoc.perl.org/perlrun.html">perldoc</a> . <br><br><h4>  Rake </h4><br>  Of course they are.  <s>In general, sometimes there is a feeling that at each turn of development Perl scatters around a lot of different rakes, which programmers then diligently collect (sometimes twice, if the first rakes were experimental).</s> <br><br>  First, some functions by definition work with bytes, not characters, and the lines in the internal representation get them across the throat.  These functions include frequently used functions from the <code>Digest::MD5</code> module.  So, the given example will fall off with the <code>Wide character in subroutine entry at test.pl line 3.</code> .: <br><br> <code>use Digest::MD5 'md5_hex'; <br> print md5_hex("\x{400}");</code> <br> <br>  Secondly, the data do not always come in the form in which the program expects to be seen.  It would be naive to expect, for example, that valid UTF-8 will always come to an HTML form handler.  The results of excessive trust in the sources can be quite diverse, starting with data corruption and ending with fatal errors when trying to recode them to a different encoding (for example, when creating an email). <br><br>  Finally, the most frequent and interesting problem occurs when you try to concatenate two strings, only one of which is stored in the internal pearl-barley format.  Suppose we have such a file (recorded in UTF-8): <br><br> <code>use Encode; <br> $a = decode('utf8', "  "); #     <br> $b = " "; #   15  <br> $c = $a.$b;</code> <br> <br>  In the last line, Perl tries to bring the lines to a common <s>denominator</s> format.  Since he sees <code>$b</code> as a chain of bytes, each byte of this string is encoded in UTF-8.  The result will be approximately the same porridge (with the flag raised, by the way): <br><br> <code>$c = "  √ê¬Ω√ê¬∞ √ê¬•√ê¬∞√ê¬±√ë‚Ç¨√ê¬µ"</code> <br> <br>  The glitch is quite clearly visible with the naked eye on unicode-specific krakozyabram - you will not confuse with anything. <br><br><h4>  Conclusion </h4><br>  The article remained undisclosed, many subtleties.  A number of utilities from the <code>Encode</code> modules, <code>utf8</code> remained behind the scenes.  There was no place for mentioning a variation of the internal format that is sensitive to UTF-8 characters that are not valid from the point of view of UTF-8.  The questions related to regular expressions are completely omitted.  If you want to understand this topic to the end, pay attention to the manuals: <br><ul><li>  <a href="http://perldoc.perl.org/utf8.html">perldoc utf8</a> ; </li><li>  <a href="http://perldoc.perl.org/Encode.html">perldoc Encode</a> ; </li><li>  <a href="http://perldoc.perl.org/perluniintro.html">perldoc perluniintro</a> ; </li><li>  <a href="http://perldoc.perl.org/perlunitut.html">perldoc perlunitut</a> ; </li><li>  <a href="http://perldoc.perl.org/perlunifaq.html">perldoc perlunifaq</a> ; </li><li>  <a href="http://perldoc.perl.org/perlunicode.html">perldoc perlunicode</a> . </li></ul>  If you have any questions, I will try to answer them. <br><br>  <b>UPD:</b> codesign <a href="https://habrahabr.ru/users/codesign/" class="user_link">habrayuser has</a> sent links to their developments on the same topic, I recommend: <ul><li>  the article " <a href="http://www.nestor.minsk.by/sr/2008/09/sr80902.html">UTF Perl Practice, or how to use UTF-8 in pearl</a> "; </li><li>  <a href="">presentation to the report</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/53578/">https://habr.com/ru/post/53578/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../53566/index.html">ZyXEL went too far with his device.</a></li>
<li><a href="../53567/index.html">A good 22-inch monitor is now there. Even two</a></li>
<li><a href="../53569/index.html">OpenMW 0.6 released</a></li>
<li><a href="../53571/index.html">Need For Speed ‚Äã‚ÄãSHIFT - first details</a></li>
<li><a href="../53576/index.html">Unexpected deceitfulness of default parameters or my language is my enemy</a></li>
<li><a href="../53579/index.html">Co.cc domain name registrar carelessly applies to privacy</a></li>
<li><a href="../53580/index.html">Do not be a chode. Your Beeline :)</a></li>
<li><a href="../53581/index.html">Three and a half levels of project structure</a></li>
<li><a href="../53583/index.html">Hallow your desk working!</a></li>
<li><a href="../53584/index.html">Support the Russian woman!</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>