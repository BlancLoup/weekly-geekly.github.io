<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Picture Factory - how does it work? Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Finally I was going to write the second part as promised in the first . In this part I want to talk about the client side of the project. 

 What is u...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Picture Factory - how does it work? Part 2</h1><div class="post__text post__text-html js-mediator-article">  Finally I was going to write the second part as promised in the <a href="https://habr.com/post/147829/">first</a> .  In this part I want to talk about the client side of the project. <br><br><h2>  What is used: </h2><br>  As said before the project is completely written in Python (with Cython inserts).  All information about images, users, statistics - is stored in the MySQL database. <br><br>  Sphinx server is used to search (main) and filter.  Client written for twisted <a href="https://github.com/p0is0n/txsphinx">txsphinx</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For likes, number of image views and number of downloads, Redis is used.  Also in Redis top images (home page) and ‚Äúsimilar images‚Äù (page of the image itself) are stored.  For twisted client txredis, found in the open spaces and slightly modified by itself (not yet in public). <br><br>  Web: TwistedWeb with the Jinja2 template engine, all Bootsrap and Jquery are drawn.  The end of the chain is Nginx. <a name="habracut"></a><br><br><h2>  The interesting part: </h2><br>  The first (and most interesting) was to make an image <a href="http://picsfab.com/filter">filter</a> .  To begin with, a list of search fields was compiled: <br><ul><li>  Categories </li><li>  Minimum image resolution </li><li>  Keywords </li><li>  Colors </li></ul><br>  It was decided to make the filter using Sphinx.  Indexing occurs via xmlpipe.  The definition in sphinx is very simple: <br><br><pre><code class="hljs scala">source images { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span></span>= xmlpipe2 xmlpipe_command = bin/sphinx.py --indexer=images } index images { source = images path = /<span class="hljs-keyword"><span class="hljs-keyword">var</span></span>/lib/sphinx/data/images morphology = stem_enru charset_type = utf<span class="hljs-number"><span class="hljs-number">-8</span></span> min_word_len = <span class="hljs-number"><span class="hljs-number">2</span></span> min_infix_len = <span class="hljs-number"><span class="hljs-number">3</span></span> enable_star = <span class="hljs-number"><span class="hljs-number">1</span></span> docinfo = extern html_strip = <span class="hljs-number"><span class="hljs-number">1</span></span> index_exact_words = <span class="hljs-number"><span class="hljs-number">1</span></span> expand_keywords = <span class="hljs-number"><span class="hljs-number">0</span></span> wordforms = images_wordforms.txt }</code> </pre> <br>  Categories: MVA attribute, list ID.  Also, the text attribute is a list of category names (for proper search, adding weight to the results). <br><br>  Minimum image resolution: Two attributes <strong>width</strong> and <strong>height</strong> .  It‚Äôs also simple, search by the range of each attribute, from user-defined to maximum (magic number 10,000). <br><br>  Keywords: Three text attribute <strong>title</strong> <strong>tags</strong> <strong>keywords</strong> .  Title - the title of the image, the results are given the maximum weight when hit.  Tags - image tag list, average weight.  Keywords - a set of keywords (the user does not see them), taken on the image page, may contain garbage.  Little weight. <br><br>  Colors: It was the most difficult, I will tell in more detail.  A color palette {ID =&gt; RGB} was created.  When adding an image to the database, we get a list of the dominant colors and equate them to our palette.  The colors of the image are stored in the database with two values: the color ID and the percentage occupied in the image.  The index contains ten MVA-attributes ‚Äúc_X‚Äù where X is a number from 0 to 9. All colors of the image fall into c_0, colors with percent&gt; = 10 in c_1, colors with percent&gt; = 20 in c_2, etc. <br><br>  Filter by color: When searching for images by color, all images whose color is in the index c_1 are taken, then the weight of the color is considered.  When searching by color with ID 2 (pseudocode): <br><br><pre> <code class="hljs lisp">setSelect('(IN(c_1,<span class="hljs-number"><span class="hljs-number">2</span></span>)*1) + (IN(c_2,2)*<span class="hljs-number"><span class="hljs-number">1</span></span>) + (<span class="hljs-name"><span class="hljs-name">IN</span></span>(<span class="hljs-name"><span class="hljs-name">c_3</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)*1) + (IN(c_4,2)*<span class="hljs-number"><span class="hljs-number">1</span></span>) + (<span class="hljs-name"><span class="hljs-name">IN</span></span>(<span class="hljs-name"><span class="hljs-name">c_5</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)*1) + (IN(c_6,2)*<span class="hljs-number"><span class="hljs-number">1</span></span>) + (<span class="hljs-name"><span class="hljs-name">IN</span></span>(<span class="hljs-name"><span class="hljs-name">c_7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)*1) + (IN(c_8,2)*<span class="hljs-number"><span class="hljs-number">1</span></span>) + (<span class="hljs-name"><span class="hljs-name">IN</span></span>(<span class="hljs-name"><span class="hljs-name">c_9</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>)*1) AS colors_weight') setOrder('colors_weight DESC')</code> </pre><br>  Perhaps the search for colors made not the most optimal way, but this is the most successful of what I came up with. <br><br><h2>  Total: </h2><br>  The filter speed makes me happy, now it's about 50-80 milliseconds with 70,000 images.  If something else is interesting on the project, please ask, I will be happy to tell.  Again, the project itself: <a href="http://picsfab.com/">http://picsfab.com</a> </div><p>Source: <a href="https://habr.com/ru/post/188034/">https://habr.com/ru/post/188034/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../188020/index.html">Scientists have managed to stop the light for one minute.</a></li>
<li><a href="../188022/index.html">Free translation of executive summary from The Innovator's Solution book on the innovator's dilemma and its possible solution</a></li>
<li><a href="../188024/index.html">Do you use a universal password for client sites?</a></li>
<li><a href="../188026/index.html">Morphology and computational linguistics for the smallest</a></li>
<li><a href="../188032/index.html">Mamba Hiring: DIY statistics</a></li>
<li><a href="../188038/index.html">Where do gethashcode's hands grow in .NET</a></li>
<li><a href="../188042/index.html">How HTTPS Secures Your Connection: What Every Web Developer Should Know</a></li>
<li><a href="../188044/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ67 (July 21 - 27, 2013)</a></li>
<li><a href="../188046/index.html">Design Patterns in Ruby: A Template Method</a></li>
<li><a href="../188048/index.html">DALER: and crawls and flies (remote control)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>