<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Interception and editing of http-traffic files on the example of a torrent</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A couple of years ago, the idea arose to make a local bittorrent-retreker for users of our ‚Äúhome‚Äù city network so that users download faster and we ha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Interception and editing of http-traffic files on the example of a torrent</h1><div class="post__text post__text-html js-mediator-article">  A couple of years ago, the idea arose to make a local bittorrent-retreker for users of our ‚Äúhome‚Äù city network so that users download faster and we have less traffic.  The installation of the retreker itself has just begun, it was necessary to somehow announce it for downloadable torrents.  In the process of finding out the ways and mechanisms of the announcement, I came to a fairly general and universal algorithm, with which I propose to get acquainted. <br><br>  So first: <br><a name="habracut"></a><br><h4>  What to do </h4><br>  There are three ways to announce the existence of a tracker in the local network: <br><ul><li>  Use add some trackers address retracker.local </li><li>  Announce a local tracker through the <a href="http://bittorrent.org/beps/bep_0022.htm">mechanism isp.bep22</a> </li><li>  Intercept downloaded torrent files and edit them, adding the address of our torrent, on the fly </li></ul><br>  Each of them has its advantages and disadvantages, respectively: <br><ul><li>  Using the .local zone contradicts the <a href="http://files.multicastdns.org/draft-cheshire-dnsext-multicastdns.txt">Multicast DNS</a> RFC draft and causes problems for Linux and Apple zeroconf services;  added by only a few trackers </li><li>  Isp.bep22 works, as far as I know, only in the ¬µTorrent client and that is turned off by default. </li><li>  There is no reference to intercepting traffic with success stories, except for the only <a href="http://forum.cifracom.ru/viewtopic.php%3Ff%3D1%26t%3D21365%26start%3D15">experience of a friendly network.</a> </li></ul><br>  To begin with, support was made for the first two options, since no special efforts were required for this: it was <i>easy to</i> add several records to the DNS ( <i>retracker.local IN A</i> and <i>retracker.smarthome.spb.ru _SRV_</i> ).  <s>In this case, you can close your eyes to the incompatibility of .local with zeroconf, since ideally DNS client requests with zeroconf enabled should not even reach our server.</s>  <strong>Update</strong> : An important <a href="http://habrahabr.ru/blogs/sysadm/106131/">remark of</a> <strong>cadmi</strong> is that in order for the user to work with .local and our retreker, you need to create a zone not .local, but <em>.retracker.local</em> , which will allow you to combine both options. <br><br>  But still the third option looked the most interesting and tempting, so I decided to look for information on the general technique of changing downloaded files on the fly.  Server requirements were simple: <br><ul><li>  FreeBSD work </li><li>  Open source </li><li>  Transparency (stealth) work for the client </li><li>  Detection of traffic level 7 and recovery of files from the http stream </li><li>  Transfer these files to the editing script and get them back </li><li>  Transferring the edited files to the client </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  What to do </h4><br>  To my surprise, I discovered that there is practically no technician and open source software for such interception and editing of files.  By and large, there are only two of them: this is Squid with experimental <a href="http://wiki.squid-cache.org/Features/ICAP">ICAP</a> / <a href="http://wiki.squid-cache.org/Features/eCAP">ECAP modules</a> and some kind of filtering proxy called " <a href="http://www.freshports.org/www/middleman/">MiddleMan</a> ", the last release of which was released back in 2004, but which continues to be maintained in ports. <br><br>  I refused to use Squid almost immediately: despite the presence of two experimental modules for working with passing traffic, the solution turned out to be extremely ‚Äúcrooked‚Äù and unstable even in installation and configuration, not to mention work. <br><br>  Moved to middleman.  Amazingly, but the fact is that the old program turned out to be more functional and more convenient than the modern monster Squid.  In essence, it satisfies all the requirements, except for full transparency for the user - the user's source ip corresponds to the ip server with the proxy.  I note that only <a href="http://wiki.squid-cache.org/Features/Tproxy4">Squid with TPROXY module under Linux</a> can leave source ip.  Moreover, it has a unique option - if the configured timeout exceeds a waiting time, the proxy gives the user an unchanged source file. <br><br><h4>  How to do </h4><br><h5>  1. Identify the most popular torrent servers </h5><br>  To begin with, I wrote a small <a href="http://pastie.org/700734">perl script</a> that listens to port 80 via pcap and collects ip-addresses that are sent to requests from Content-Type: application / x-bittorrent.  This is necessary in order to intercept not all http-traffic, but only the one that belongs to the large trackers. <br><br>  Then, by simple manipulations, these ip-addresses are entered into the ipfw table used when redirecting to our proxy: <br><br> <code>${ipfw} add fwd ${proxy_ip}, ${proxy_port} tcp from $lan_customers to 'table(15)' dst-port 80 in via ${int_if}</code> <br> <br><h5>  2. Configuration of the proxy server middleman </h5>  The section responsible for uploading files to the editing script is called external in <a href="http://www.pastie.org/754733">mman.xml</a> . <br><br><h5>  3. Editing "external" script </h5><br><br>  The mypatcher.pl <a href="http://pastie.org/1212793">script</a> transfers files with the mime type "application / x-bittorrent", it adds a local tracker entry to it (removing retracker.local if there is one there, which solves client problems with zeroconf) and sends the contents back to the proxy , simultaneously saving the file also to disk, in this form: <br><br> <code>#for i in `find /home/torrents/patched/ -type d`; do echo -n "$i" &amp;&amp; ls -1 $i| wc -l; done | awk '{print $2" "$1}' | sort -rn | head -n 10 <br> <br> 24103 /home/torrents/patched/dl.rutracker.org <br> 7817 /home/torrents/patched/dl.torrents.ru <br> 6184 /home/torrents/patched/tfile.ru <br> 3744 /home/torrents/patched/kinozal.tv <br> 2928 /home/torrents/patched/rutor.org <br> 2872 /home/torrents/patched/torrents.thepiratebay.org <br> 2583 /home/torrents/patched/www.tfile.ru <br> 2582 /home/torrents/patched/www.torrentino.ru <br> 2531 /home/torrents/patched/pornolab.net <br> 1032 /home/torrents/patched/www.rutor.org <br></code> <br><br>  The result of the work: on a server that performs NAT, shaping and routing a network of 3000 users, the load of mman is generally not noticeable.  On the day, about 200-400 files are being edited now.  There were no complaints for almost a year of work, everyone is happy. <br><br>  <strong>Update 1</strong> .  "Saving files to disk" is used exclusively for collecting anonymous statistics in the form specified above.  Well, I simply forgot to disable this script debugging mechanism.  :) Cadm </div><p>Source: <a href="https://habr.com/ru/post/106131/">https://habr.com/ru/post/106131/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../106123/index.html">The creators of an unpretentious accessory for iPhone 4 are financed 10 times more than requested.</a></li>
<li><a href="../106124/index.html">Bing integrates support for Facebook Like It</a></li>
<li><a href="../106126/index.html">Rutracker.org unavailable, unavailable and the tracker itself</a></li>
<li><a href="../106128/index.html">Change the shape and proportions of the body on video</a></li>
<li><a href="../106130/index.html">Apple shares for the first time became more expensive than $ 300 apiece</a></li>
<li><a href="../106132/index.html">ABBYYOnline - Architect's View</a></li>
<li><a href="../106133/index.html">System reviews and ratings for product online stores</a></li>
<li><a href="../106134/index.html">End of the world tunnel</a></li>
<li><a href="../106139/index.html">How to deal with customer loyalty using the website</a></li>
<li><a href="../106140/index.html">Opera 11 will support extensions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>