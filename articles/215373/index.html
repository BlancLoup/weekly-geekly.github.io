<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Make life easier</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When developing projects, we use the PostgreSQL database, due to its openness, free of charge, and rather large functionality. According to the adopte...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Make life easier</h1><div class="post__text post__text-html js-mediator-article">  When developing projects, we use the PostgreSQL database, due to its openness, free of charge, and rather large functionality.  According to the adopted architecture, we create views for tables (views) and applications already work with them.  In many cases, one-to-one views copy tables, but each of them needs to create and write rules for updating, deleting and inserting records, which takes time. <br>  And then one of the wonderful days, I got tired of it and I decided to automate this process.  This is how the following function appeared: <br><a name="habracut"></a><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pg_createview(table_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, schema_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> obj <span class="hljs-built_in"><span class="hljs-built_in">record</span></span>; num integer; _schema alias for $2; _tablelike alias for $1; _table character varying; sql character varying; sqlclm1 character varying; sqlclm2 character varying; sqlclmkey character varying; _col text; exist_view character varying; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>; FOR obj IN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class c <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace ns <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (c.relnamespace = ns.oid) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> relkind =<span class="hljs-string"><span class="hljs-string">'r'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> nspname = $<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> $<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> _table=obj.relname; <span class="hljs-comment"><span class="hljs-comment">--  --SELECT relname INTO exist_view FROM pg_class WHERE relname=_schema||'.v'||_table; SELECT relname INTO exist_view FROM pg_class c JOIN pg_namespace ns ON (c.relnamespace = ns.oid) WHERE nspname = _schema AND relname='v'||_table; IF exist_view IS NOT NULL THEN EXECUTE 'DROP VIEW '||_schema||'.v' || _table; END IF; --  EXECUTE 'CREATE OR REPLACE VIEW '||_schema||'.v' || _table || ' as select * from ' || $2 || '.' || _table; --   (,    .          ) sqlclmkey=''; --SELECT column_name into sqlclmkey FROM INFORMATION_SCHEMA.KEY_COLUMN_USAGE where table_schema=_schema and table_name=_table and ordinal_position=1; SELECT pg_attribute.attname into sqlclmkey FROM pg_index, pg_class, pg_attribute WHERE pg_class.oid = (_schema||'.'||_table)::regclass AND indrelid = pg_class.oid AND pg_attribute.attrelid = pg_class.oid AND pg_attribute.attnum = any(pg_index.indkey) AND indisprimary; --    sqlclm1=''; sqlclm2=''; FOR _col IN execute 'select column_name from information_schema.columns where table_schema='||quote_literal(_schema)||' and table_name='||quote_literal(_table) Loop sqlclm1=sqlclm1||_col||','; sqlclm2=sqlclm2||'new.'||_col||','; end loop; sqlclm1=substring(sqlclm1 from 1 for (length(sqlclm1)-1) ); sqlclm2=substring(sqlclm2 from 1 for (length(sqlclm2)-1) ); sql='CREATE RULE "v'||_table||'_ins" AS ON INSERT TO "'||_schema||'"."v'||_table||'" DO INSTEAD ('; sql=sql||'INSERT INTO '||_schema||'.'||_table||'('||sqlclm1||') VALUES ('||sqlclm2||'););'; EXECUTE sql; --   update sqlclm1=''; sqlclm2=''; FOR _col IN execute 'select column_name from information_schema.columns where table_schema='||quote_literal(_schema)||' and table_name='||quote_literal(_table) Loop sqlclm1=sqlclm1||_col||'=new.'||_col||','; end loop; sqlclm1=substring(sqlclm1 from 1 for (length(sqlclm1)-1) ); sql='CREATE RULE "v'||_table||'_upd" AS ON UPDATE TO "'||_schema||'"."v'||_table||'" DO INSTEAD ('; sql=sql||' UPDATE '||_schema||'.'||_table||' SET '||sqlclm1||' WHERE '||sqlclmkey||'=old.'||sqlclmkey||';);'; EXECUTE sql; --   delete sql='CREATE RULE "v'||_table||'_del" AS ON DELETE TO "'||_schema||'"."v'||_table||'" DO INSTEAD ('; sql=sql||'DELETE FROM '||_schema||'.'||_table||' WHERE '||sqlclmkey||'=old.'||sqlclmkey||';);'; EXECUTE sql; num := num + 1; END LOOP; RETURN num; END; $BODY$ LANGUAGE 'plpgsql' VOLATILE COST 100; ALTER FUNCTION pg_createview(text, text) OWNER TO postgres;</span></span></code> </pre> <br><br>  At once I will make a reservation that it works only with tables, where there is one key field. <br>  Example number 1.  The function call for the users table in the main scheme: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_createview( <span class="hljs-string"><span class="hljs-string">'users'</span></span>, <span class="hljs-string"><span class="hljs-string">'main'</span></span>);</code> </pre><br>  at the output we get a view vusers with all the rules. <br><br>  Example number 2.  The function call for tables whose names begin with "gz_" in the main scheme: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_createview( <span class="hljs-string"><span class="hljs-string">'gz_%'</span></span>, <span class="hljs-string"><span class="hljs-string">'main'</span></span>);</code> </pre><br>  at the output we get views for all specified tables with all the rules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I also use it with this function: <br>  1. For mass assignment of the owner to tables and views: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pg_owner(user_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, table_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, schema_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> obj <span class="hljs-built_in"><span class="hljs-built_in">record</span></span>; num integer; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>; FOR obj IN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class c <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace ns <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (c.relnamespace = ns.oid) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> relkind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'r'</span></span>,<span class="hljs-string"><span class="hljs-string">'v'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> nspname = $<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> $<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'ALTER TABLE '</span></span> || $<span class="hljs-number"><span class="hljs-number">3</span></span> || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || obj.relname || <span class="hljs-string"><span class="hljs-string">' OWNER TO '</span></span> || $<span class="hljs-number"><span class="hljs-number">1</span></span>; num := num + 1; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN num; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $BODY$ LANGUAGE 'plpgsql' VOLATILE COST 100; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pg_owner(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) OWNER <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> postgres;</code> </pre><br><br>  The call is similar to the previous function: <br>  Example.  The function call for tables whose names begin with "gz_" in the main scheme for the user umain: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_owner( <span class="hljs-string"><span class="hljs-string">'umain'</span></span>, <span class="hljs-string"><span class="hljs-string">'gz_%'</span></span>, <span class="hljs-string"><span class="hljs-string">'main'</span></span>);</code> </pre><br>  for views created by the previous function <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_owner( <span class="hljs-string"><span class="hljs-string">'umain'</span></span>, <span class="hljs-string"><span class="hljs-string">'vgz_%'</span></span>, <span class="hljs-string"><span class="hljs-string">'main'</span></span>);</code> </pre><br>  and if there are no contradictions in the names, then you can do with one call for tables and views: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">select</span></span> pg_owner( <span class="hljs-string"><span class="hljs-string">'umain'</span></span>, <span class="hljs-string"><span class="hljs-string">'%gz_%'</span></span>, <span class="hljs-string"><span class="hljs-string">'main'</span></span>);</code> </pre><br><br>  2. For mass assignment of privileges to tables and views: ( <a href="http://kennii.wordpress.com/2007/09/21/postgres-grant-privileges-to-all-tables-in-a-database/">source of function</a> ) <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pg_grant(user_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, action_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, table_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, schema_ <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $<span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span>$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> obj <span class="hljs-built_in"><span class="hljs-built_in">record</span></span>; num integer; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">num</span></span>:=<span class="hljs-number"><span class="hljs-number">0</span></span>; FOR obj IN <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> pg_class c <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> pg_namespace ns <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (c.relnamespace = ns.oid) <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> relkind <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> (<span class="hljs-string"><span class="hljs-string">'r'</span></span>,<span class="hljs-string"><span class="hljs-string">'v'</span></span>,<span class="hljs-string"><span class="hljs-string">'S'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> nspname = $<span class="hljs-number"><span class="hljs-number">4</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> relname <span class="hljs-keyword"><span class="hljs-keyword">LIKE</span></span> $<span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-string"><span class="hljs-string">'GRANT '</span></span> || $<span class="hljs-number"><span class="hljs-number">2</span></span> || <span class="hljs-string"><span class="hljs-string">' ON '</span></span> || $<span class="hljs-number"><span class="hljs-number">4</span></span> || <span class="hljs-string"><span class="hljs-string">'.'</span></span> || obj.relname || <span class="hljs-string"><span class="hljs-string">' TO '</span></span> || $<span class="hljs-number"><span class="hljs-number">1</span></span>; num := num + 1; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN num; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $BODY$ LANGUAGE 'plpgsql' VOLATILE COST 100; <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> pg_grant(<span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">text</span></span>) OWNER <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> postgres;</code> </pre><br><br>  P | S function pg_createview can be modified to fit your needs, for example <br>  - create views without rules if there are no key fields <br>  - if there are more than one key fields, then create rules for all of them, and not only for the first key field. </div><p>Source: <a href="https://habr.com/ru/post/215373/">https://habr.com/ru/post/215373/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../215361/index.html">Turn Zalman into Noctua (or fan upgrade)</a></li>
<li><a href="../215363/index.html">Automation of system integration testing</a></li>
<li><a href="../215367/index.html">Proxmox 3.1: installation details out of the box</a></li>
<li><a href="../215369/index.html">TFS Build Sequences</a></li>
<li><a href="../215371/index.html">Pitfalls of technology company</a></li>
<li><a href="../215375/index.html">StarCraft disassembled and launched on ARM</a></li>
<li><a href="../215381/index.html">How to take back music and video from VC using Chrome browser using its extension</a></li>
<li><a href="../215383/index.html">My implementation of the automatic inclusion of light in the toilet (and without Arduino)</a></li>
<li><a href="../215385/index.html">The prosecutor's office of Surgut is preparing materials to convict a person for 4 years for the purchase of smart watches</a></li>
<li><a href="../215387/index.html">Timekeeping on Mars</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>