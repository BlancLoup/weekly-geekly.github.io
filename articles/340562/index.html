<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We need to go deeper: bypass the script that bypasses the adblock</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A little Friday post. Recently, I noticed that there is an advertisement that immediately breaks through 2 (!) Extensions blocking it. And usually thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We need to go deeper: bypass the script that bypasses the adblock</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/59/e9/b8/59e9b8c7362d2110274674.jpeg"></div><br>  A little Friday post.  Recently, I noticed that there is an advertisement that immediately breaks through 2 (!) Extensions blocking it.  And usually this is a very low-quality and intrusive advertisement.  I decided to find out how it was, and maybe even try to overcome this rubbish.  Who cares - please under the cat (carefully, a lot of pictures). <br><a name="habracut"></a><br><h3>  And what hinders that? </h3><br>  I am an ardent supporter of ad blocking.  Especially - low quality.  If I don‚Äôt want to watch ads on a specific site, then such ads are a waste of money for the advertiser (useless display), disrespect towards me, and zero profit for anyone at all.  I will make a reservation right away - there are sites on which I deliberately cut down adbloki (the same habr, for example).  These are sites that choose thematic advertising, and not ‚ÄúIPHONES FROM THE WAREHOUSE 70% DISCOUNT!‚Äù. <br><br>  And here the other day on one friendly site for me (the news portal in my city) appears well sooo low-level advertising in the style of "electricians have been hiding for a long time - to save electricity you just have to ...".  At first, I thought that they had been hacked, but then it turned out that the admin of this site just got involved in some kind of affiliate program that runs on top of the adblock.  And not only that such an advertisement is just a shame, so she also broke the layout in some places.  Close it has become a matter of principle. <br><br><h3>  Attempt 1 - stupid, or ... </h3><br>  ... "pff, yes I'll write a custom filter for the adblock."  We write the filter, save, test ... And the page then breaks, straight at all.  And cosmetic filters (blocking by css) also do not work.  How so?  But, apparently, therefore, there was no such filter out of the box.  As it turns out later, our ‚Äúmalware‚Äù is cunning and in-line, and chrome browsers do not allow extensions to block inline scripts.  Well well‚Ä¶ 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Attempt 2 - change adblock </h3><br>  The word "adblock" has long become a household name, like a jeep or copier.  So in fact, I don‚Äôt have adblock but ublock (I hope this will not be considered an advertisement?).  Therefore, to begin with, we will test the work of various blockers from the issuance top, who promised to hide from sly-assured scripts, and even block them.  Exhaust, in fact, it did not, and part of the advertising continued to creep in (although not all, but still). <br><br><h3>  Attempt 3 - look the enemy in the eye </h3><br>  And no, I do not mean the admin resource :) Let's get down to the most interesting.  We climb to watch the source of the page, in the hope of finding our crap.  And ... Bingo! <br><br><img src="https://habrastorage.org/webt/59/e9/b8/59e9b8c95373e532586399.jpeg"><br><br>  A huge obfuscated codin, which is clearly not surprising.  We look at similar sites (in terms of advertising) - yes, this is clearly it.  And obfustsirovanno soundly, not banal packer th. <br><br>  Unpack a little to understand where the dog is buried.  If you look at the monster, you will notice that this is a self-invoking function, within which there are three main parts - a large function, some kind of array with numbers and a small processing of it, and a call to the first function.  Copy the array and its processing, run, look output. <br><br><img src="https://habrastorage.org/webt/59/e9/b8/59e9b8c7043bd839269111.jpeg"><br><br>  The variable "a" we keep the entire set of words that could not be replaced with one-letter.  And in the first part we see a lot of fragments of the form a [42], a [69], etc.  Obfuscation was not so difficult.  We make a replacement that does not guarantee us a working code, but it will greatly facilitate reading. <br><br><img src="https://habrastorage.org/webt/59/e9/b8/59e9b8c5d83e2395650250.jpeg"><br><br>  Already seen more or less readable code.  We skip through the beautifier, and find the desired piece of code (I deleted the unimportant code to fit in one screenshot). <br><br><img src="https://habrastorage.org/webt/59/e9/b8/59e9b8c54dfcc299044347.jpeg"><br><br>  This infection makes a request for a specific legal entity, and in the case of a heap (falling into an adblock filter, for example), it calls window.stop (), which breaks the entire page.  Pretty clever, and the built-in functionality of the adblock is, like, not solvable.  And blocking the whole script does not allow chrome, for inline. <br><br>  What to do? <br><br>  After some thought, I got a browser extension (another one, yes, yes) that deals purely with blocking this advertisement.  So far it has been sharpened specifically for this network, because I don‚Äôt know others.  If anyone wants - fork, throw pull requests, or write in the comments - add a field to add your addresses. <br><br>  It works as follows - we intercept a request for a ‚Äúverification‚Äù address, with the help of <s>acorns and matches of an</s> elegant crutch we delay it for 5 seconds, and at this time we quickly and quickly send a message to the page.  The page accepts this message and immediately overrides window.stop to an empty function.  In the meantime, the malware is rejected, smiling maliciously, pounding on window.stop, and ... nothing.  The script is satisfied (it is sure that everything broke and the user will disable the adblock), the extension is pretty (because, as my colleague says, for every tricky ass there is a cunning male sexual organ), the user (that is, we) is pleased.  Probably, soon the developers of this infection will come up with something and this, but, for now, the advertisement is successfully minted. <br><br>  Expansion did not fill up anywhere, because you need a paid account, this is a proof-of-concept, today is Friday, and another 1000 and 1 minor excuse.  So the <a href="https://github.com/VladReshet/no-ads-forever">githab</a> code. <br><br>  UPD.  Questions have arisen in the comments, so the thesis is: <br>  Why not block all inline scripts - because it will break the logic of many sites, does not fit <br>  Why not return 200 (to deceive) - because chrome does not know how.  Either 500 or skip <br>  Why not redefine window.stop right away - because you need to catch a time when the DOM head block already exists, but the Ajax has not yet returned.  This is an extensions API restriction. </div><p>Source: <a href="https://habr.com/ru/post/340562/">https://habr.com/ru/post/340562/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../340550/index.html">Code review humanly (part 1)</a></li>
<li><a href="../340552/index.html">How we updated the search tips in Yandex and found the correct metric for them</a></li>
<li><a href="../340554/index.html">Determination of the stability of automatic control systems for industrial robots</a></li>
<li><a href="../340556/index.html">First TypeScript Demo</a></li>
<li><a href="../340558/index.html">Why do you need to stop using git rebase</a></li>
<li><a href="../340564/index.html">Work with videos in Full Throttle Remastered</a></li>
<li><a href="../340566/index.html">Useful scripts when migrating from Oracle to PostgreSQL</a></li>
<li><a href="../340568/index.html">Creating a sky for 3D games</a></li>
<li><a href="../340574/index.html">NLTK parse</a></li>
<li><a href="../340576/index.html">Why IT and Business Network Factory and Cisco SD-Access</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>