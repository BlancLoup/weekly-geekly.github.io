<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>HAPRoxy for Percona or Galera on CentOS. Its configuration and monitoring in Zabbix</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A very short article about how HAProxy can be used as a balancer for multi-master MySQL servers, such as Percona or Galera. 

 I want to note that thi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>HAPRoxy for Percona or Galera on CentOS. Its configuration and monitoring in Zabbix</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/687/a95/321/687a9532176415b2444ba2046be343ab.png"><br><br><h4>  A very short article about how HAProxy can be used as a balancer for multi-master MySQL servers, such as Percona or Galera. </h4><br><br>  <b>I want to note that this instruction was born in the process of implementing Zabbix in the walls of <a href="http://habrahabr.ru/company/acronis/">Acronis</a> .</b> <b><br></b>  <b>In the process of examination and the research I conducted, she proved her right to life and safely serves us faithfully day by day.</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>For those who are not familiar with HAProxy, a quote about the purpose of the product:</b> <br><blockquote>  When increasing the load or attendance of the project, sooner or later vertical scaling (increase in server resources, such as memory, disk speed, etc.) rests on a certain limit and does not give a noticeable increase.  In this case, horizontal scaling is used - adding new servers with load redistribution between them. <br>  In addition to increasing power, horizontal scaling adds reliability to the system ‚Äî if one of the servers fails, the load will be balanced between those working and the application will live. </blockquote><br><br>  <b>From words to business, installation and configuration are very simple:</b> <br><a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/comment_images/a0d/c8d/6de/a0dc8d6dede9c986e6e9dbdd21a09bc0.png"><br><br>  In the previous article, I described in detail what preliminary operations I did on pure CentOS 6.4, my recommendations are up-to-date and here, all the packages will be indicated taking into account the recommendations in the <a href="http://habrahabr.ru/post/198354/">previous material</a> : <br><br>  <b>Repositories are connected, the system is up to date, go to the installation of HAProxy:</b> <br><br>  <b># We put haproxy</b> <br><blockquote>  yum install haproxy mariadb-client php-mysql php-cli -y </blockquote><br><br>  <b># Writing configs</b> <br><blockquote>  mv /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.old </blockquote><br>  <b>[root @ rs-haproxy ~] # nano /etc/haproxy/haproxy.cfg</b> <br><blockquote>  global <br>  daemon <br>  maxconn 4096 <br><br>  <b># If you want to see debug information, then this item should be commented out.</b> <br>  quiet <br><br>  <b># And this is opposite, uncomment</b> <br>  # debug <br><br>  user haproxy <br>  group haproxy <br><br>  <b># We will use this socket for monitoring in zabbix</b> <br>  stats socket / var / run / haproxy <br><br>  pidfile /var/run/haproxy.pid <br><br>  defaults <br>  mode http <br>  option tcplog <br>  log global <br>  option dontlognull retries 3 option redispatch <br>  maxconn 2000 <br>  contimeout 5000 <br>  clitimeout 50,000 <br>  srvtimeout 50,000 <br>  option tcplog <br><br>  <b># Indicate the valid address on the server and the port on which our haproxy will listen</b> <br>  listen MySQL address-on-which we listen-: 3306 <br><br>  mode tcp <br><br>  <b># roundrobin - consistently writes to all servers, it is good in read mode but can cause problems if it is written to the database</b> <br>  # balance roundrobin <br><br>  <b># leastconn this mode is great when using haproxy as a failover proxy, using the last working server and only it</b> <br>  balance leastconn <br><br>  <b># httpchk makes haproxy check the server for its readiness before sending each of the requests</b> <br>  option httpchk <br><br>  <b># Below is a list of servers, their port and the port to which the connection will be made to test viability</b> <br>  server address address: 3306 check port 50005 inter 12000 rise 3 fall 3 <br>  server address address: 3306 check port 50005 inter 12000 rise 3 fall 3 <br><br>  <b># Servers with backup flag are used only if other servers are not available.</b> <br>  server address address: 3306 check port 50005 inter 12000 rise 3 fall 3 backup </blockquote><br><br>  <b>Now let's go to our percona or galera servers</b> <br><br>  <b># We configure the mechanism for checking our databases, for this we need xinetd</b> <br><blockquote>  yum install -y xinetd </blockquote><br><br>  <b>[root @ xtrabackup-node-01 ~] # nano /etc/xinetd.d/mysqlchk</b> <br><blockquote>  # default: on <br>  # description: mysqlchk <br>  service mysqlchk <br>  { <br>  disable = no <br>  flags = REUSE <br>  socket_type = stream <br><br>  <b># verification port that we specified above</b> <br>  port = 50005 <br><br>  wait = no <br>  user = nobody <br>  server = / usr / bin / clustercheck <br>  log_on_failure + = USERID <br><br>  <b># Addresses with which MySQL service status checking is allowed</b> <br>  only_from = 10.100.100.0/24 <br><br>  per_source = UNLIMITED <br>  } </blockquote><br><br>  <b># It is very important to add this entry, otherwise it will not work.</b> <br>  <b>root @ xtrabackup-node-01 ~] # nano / etc / services</b> <br><blockquote>  mysqlchk 50005 / tcp # mysqlchk </blockquote><br><br>  <b># Add service to autoload and run it</b> <br><blockquote>  chkconfig xinetd on <br>  /etc/init.d/xinetd start </blockquote><br><br>  <b># Allow access to port verification</b> <br><blockquote>  iptables -A INPUT -p tcp -m state --state NEW -m tcp --dport 50005 -j ACCEPT <br>  service iptables save </blockquote><br><br>  <b># Add permissions for clustercheck access</b> <br><blockquote>  GRANT PROCESS ON *. * TO 'clustercheckuser' @ 'localhost' IDENTIFIED BY 'clustercheckpassword!'; <br>  flush privileges; </blockquote><br><br>  <b># We check everything we did, it should work out something like</b> <br>  <b>[root @ xtrabackup-node-01 ~] # / usr / bin / clustercheck</b> <br><blockquote>  HTTP / 1.1 200 OK <br>  Content-Type: text / plain <br>  Connection: close <br>  Content-Length: 40 <br><br>  Percona XtraDB Cluster Node is synced. </blockquote><br><br>  <b># Now let's check work with our haproxy host</b> <br><blockquote>  [root @ rs-haproxy ~] # telnet address 50005 <br>  Trying the address ... <br>  Connected to address. <br>  Escape character is '^]'. <br>  HTTP / 1.1 200 OK <br>  Content-Type: text / plain <br>  Connection: close <br>  Content-Length: 40 <br><br>  Percona XtraDB Cluster Node is synced. <br>  Connection closed by foreign host. <br></blockquote><br><br>  <b>Done!</b>  <b>need to do this operation on all the nodes of percona / galera</b> <br><br><h4>  <b>Monitoring HAProxy for MYSQL in Zabbix</b> </h4><br><br>  <b># This is the main tool for our script, install it</b> <br><blockquote>  yum install -y socat </blockquote><br><br>  <b># Configure sudo for zabbix if it hasn‚Äôt been done before</b> <br><blockquote>  usermod -s / bin / bash zabbix <br>  echo 'zabbix ALL = (ALL) NOPASSWD: ALL' &gt;&gt; / etc / sudoers <br>  sed -i 's / Defaults \ requireti / # Defaults \ requiretty / g' / etc / sudoers </blockquote><br><br>  <b># Create a folder for our scripts</b> <br><blockquote>  mkdir -p / etc / zabbix / scripts / <br>  chmod 750 / etc / zabbix / scripts / </blockquote><br><br>  <b># Actually the script itself</b> <br>  <b>rm -f /etc/zabbix/scripts/haproxy.mysql</b> <b><br></b>  <b>nano /etc/zabbix/scripts/haproxy.mysql</b> <br><br><pre><code class="bash hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ -z <span class="hljs-variable"><span class="hljs-variable">$1</span></span> || -z <span class="hljs-variable"><span class="hljs-variable">$2</span></span> ]]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> servers=`<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"show stat"</span></span> | sudo socat /var/run/haproxy stdio | sed <span class="hljs-string"><span class="hljs-string">'s/,/\ /g'</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $2}'</span></span> | grep -v -e <span class="hljs-string"><span class="hljs-string">"pxname"</span></span> -e <span class="hljs-string"><span class="hljs-string">'^$'</span></span>` <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> [[ -n <span class="hljs-variable"><span class="hljs-variable">${servers}</span></span> ]]; <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> JSON=<span class="hljs-string"><span class="hljs-string">"{ \"data\":["</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> DEV <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-variable"><span class="hljs-variable">${servers}</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> JSON=<span class="hljs-variable"><span class="hljs-variable">${JSON}</span></span><span class="hljs-string"><span class="hljs-string">"{ \"{#SRV}\":\"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DEV}</span></span></span><span class="hljs-string">\"},"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> JSON=<span class="hljs-variable"><span class="hljs-variable">${JSON}</span></span><span class="hljs-string"><span class="hljs-string">"]}"</span></span> <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">${JSON}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">fi</span></span> <span class="hljs-built_in"><span class="hljs-built_in">exit</span></span> 0 <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> server=<span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">"</span></span> <span class="hljs-comment"><span class="hljs-comment"># echo $server if [ ${1} = "qcur" ]; then # echo $1 echo "show stat" | sudo socat /var/run/haproxy stdio | grep "MySQL,${server}"| sed 's/,/\ /g' | awk '{print $3}' exit 0 fi if [ ${1} = "qmax" ]; then echo "show stat" | sudo socat /var/run/haproxy stdio | grep "MySQL,${server}" | sed 's/,/\ /g' | awk '{print $4}' exit 0 fi if [ ${1} = "scur" ]; then echo "show stat" | sudo socat /var/run/haproxy stdio | grep "MySQL,${server}" | sed 's/,/\ /g' | awk '{print $5}' exit 0 fi if [ ${1} = "smax" ]; then echo "show stat" | sudo socat /var/run/haproxy stdio | grep "MySQL,${server}" | sed 's/,/\ /g' | awk '{print $6}' exit 0 fi if [ ${1} = "econ" ]; then echo "show stat" | sudo socat /var/run/haproxy stdio | grep "MySQL,${server}" | sed 's/,/\ /g' | awk '{print $14}' exit 0 fi if [ ${1} = "qlimit" ]; then echo "show stat" | sudo socat /var/run/haproxy stdio | grep "MySQL,${server}" | sed 's/,/\ /g' | awk '{print $26}' exit 0 fi fi</span></span></code> </pre> <br><br>  <b>The script itself detects the available servers and transfers them to zabbix</b> <b><br></b>  <b>Check it out:</b> <br><br><blockquote>  [root @ rs-haproxy ~] # echo ‚Äúshow stat‚Äù |  sudo socat / var / run / haproxy stdio |  sed 's /, / \ / g' |  awk '{print $ 2}' |  grep -v -e "pxname" -e '^ $' <br>  FRONTEND <br>  10.100.100.246 <br>  BACKEND </blockquote><br><br>  <b># Minimal settings for our zabbix-agent</b> <br><blockquote>  echo Timeout = 30 &gt;&gt; /etc/zabbix/zabbix_agentd.conf <br>  echo Include = / etc / zabbix / zabbix_agentd.d / &gt;&gt; /etc/zabbix/zabbix_agentd.conf </blockquote><br><br>  <b># Apply rights to execute a new script</b> <br><blockquote>  chown zabbix: zabbix -R / etc / zabbix / scripts / <br>  chmod + x /etc/zabbix/scripts/haproxy.mysql </blockquote><br><br>  # We pass our UserParameter zabbix <br><blockquote>  mkdir -p /etc/zabbix/zabbix_agentd.d/ <br>  rm -f /etc/zabbix/zabbix_agentd.d/haproxy.mysql.conf <br>  touch /etc/zabbix/zabbix_agentd.d/haproxy.mysql.conf </blockquote><br><blockquote>  echo 'UserParameter = haproxy.mysql [*], / etc / zabbix / scripts / haproxy.mysql "$ 1" "$ 2"' &gt;&gt; /etc/zabbix/zabbix_agentd.d/haproxy.mysql.conf </blockquote><br><br>  <b>Now check if our script works correctly:</b> <br><blockquote>  su zabbix </blockquote><br>  <b>This is how our automatic server detection works.</b> <b><br></b>  <b>bash-4.1 $ /etc/zabbix/scripts/haproxy.mysql</b> <br><blockquote>  {"Data": [{"{#SRV}": "FRONTEND"}, {"{#SRV}": "10.100.100.246"}, {"{#SRV}": "BACKEND"},]} </blockquote><br><br>  <b># Ask any data</b> <br><blockquote>  bash-4.1 $ /etc/zabbix/scripts/haproxy.mysql qcur FRONTEND <br>  115 <br></blockquote><br><br>  <b>It seems that everything is in order!</b>  <b>Restart the service and admire the logs</b> <br><blockquote>  /etc/init.d/zabbix-agent restart &amp;&amp; tail -f -n 100 /var/log/zabbix/zabbix_agentd.log </blockquote><br><br>  <b>This is how our haproxy template looks like.</b> <br><img src="https://habrastorage.org/getpro/habr/post_images/228/a2a/d9c/228a2ad9cb1bd5da53f55365a08b1afc.png"><br><br>  <a href="">Here you can download the template for import into zabbix</a> <br><br><h4>  Thanks for attention! </h4></div><p>Source: <a href="https://habr.com/ru/post/198448/">https://habr.com/ru/post/198448/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../198430/index.html">Give users the power over the sites!</a></li>
<li><a href="../198436/index.html">Secret Buyers. Need a restructuring?</a></li>
<li><a href="../198438/index.html">How to configure COLT + IntelliJ IDEA integration</a></li>
<li><a href="../198444/index.html">Changing the keyboard layout of the Apple mb110, when using it under Windows</a></li>
<li><a href="../198446/index.html">How to choose a business idea for an IT startup</a></li>
<li><a href="../198450/index.html">Active Record vs. Data Mapper to save data</a></li>
<li><a href="../198452/index.html">Problem solving web server settings when publishing web applications</a></li>
<li><a href="../198454/index.html">Gadgets Inspired by Doctor Who</a></li>
<li><a href="../198456/index.html">Multifunctional Robot for washing windows of skyscrapers</a></li>
<li><a href="../198458/index.html">Switch to Selenium 2 + PhantomJS</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>