<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Refinement of the standard error handling mechanism in CodeIgniter</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="CodeIgniter provides quite good error handling capabilities, but they seemed to me insufficient for the following reasons: 


- there is no exception ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Refinement of the standard error handling mechanism in CodeIgniter</h1><div class="post__text post__text-html js-mediator-article">  CodeIgniter provides quite good error handling capabilities, but they seemed to me insufficient for the following reasons: <br><ul><li>  there is no exception handling </li><li>  there is no possibility to notify the site administrator of any errors through the mail </li><li>  quite scarce information about errors that occur (in the framework with which I worked before, the error text is supplemented with a dump of global variables, which greatly simplifies the debugging process, I would like to see a similar scheme in CodeIgniter) </li></ul><br>  We will fix it =) <br><a name="habracut"></a><br><h4>  Exception handling (see below option without editing kernel files) </h4><br>  Specify the exception handler in the file <b><i>/system/codeigniter/CodeIgniter.php</i></b> <br><pre> set_exception_handler ('_ exception_handler2');
</pre><br>  next to the line <br><pre> set_error_handler ('_ exception_handler');
</pre><br>  Now, when an exception occurs, the <b><i>_exception_handler2</i></b> method from the <b><i>/system/codeigniter/Common.php</i></b> file will be called. <br><br>  But the actual method itself: <br><pre> / **
 * Exception handler
 *
 * /
 function _exception_handler2 ($ errstr)
 {
	 $ error = &amp; load_class ('Exceptions');
	
	 // Display the exception text on the screen
    echo $ error-&gt; show_error ('error', nl2br ($ errstr));

	 // Should we log the error?  No?  We're done ...
	 $ config = &amp; get_config ();
	 if ($ config ['log_threshold'] == 0)
	 {
		 return;
	 }
	
	 // Write a message to the log
	 $ error-&gt; log_exception ('Exception', $ errstr, '', '');
	
	 exit;
 }
</pre><br><br><h4>  Notification by mail and additional information on errors </h4><br>  In order for the adminstrator to receive notification of errors on the website to the mailbox, it is necessary in the file <b><i>/system/application/config/config.php</i></b> to specify the email address of the administrator: <br><pre> / *
 | ------------------------------------------------- -------------------------
 |  Notification administrator about errors on the site
 | ------------------------------------------------- -------------------------
 |
 |  If you want the administrator to receive letters about errors and exceptions
 |  Specify the following address with the address of the mailbox administrator
 |
 * /
 $ config ['log_to_email'] = 'admin@site.ru';
</pre><br>  If you do not want messages to be sent - do not specify this parameter or leave it blank. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Extend base class <b><i>Exceptions</i></b> - in the directory <b><i>/ system / application / libraries /</i></b> <br>  create the file MY_Exceptions.php with the following contents: <br><pre> class MY_Exceptions extends CI_Exceptions
 {
	 / **
	  * Exception Logger
	  *
	  * Method replaces basic adding features
	  * send error message to site administrator
	  * and display additional information in the log
	  *
	  * @access private
	  * @param string the error severity
	  * @param string the error string
	  * @param string the error filepath
	  * @param string the error line number
	  * @return string
	  * /
	 function log_exception ($ severity, $ message, $ filepath, $ line)
	 {
		 // Send a message to the site administrator
		 $ this-&gt; adminmail ($ message);
		
		 $ severity = (! isset ($ this-&gt; levels [$ severity]))?  $ severity: $ this-&gt; levels [$ severity];
		
		 // Supplement the message text with dumps of environment variables
		 $ message. = "\ n".  $ this-&gt; GetGlobalVariables ().  $ filepath. '  '. $ line.  "\ n \ n";
		
		 log_message ('error', 'Severity:'. $ severity. '-&gt;'. $ message, TRUE);
	 }
	
	
	 / **
	  * 404 Page Not Found Handler
	  * 
	  * The method complements the basic ability to send a message to the administrator
	  * in case of an error
	  *
	  * @access private
	  * @param string
	  * @return string
	  * /
	 function show_404 ($ page = '')
	 {	
		 // Send the message
		 $ message = '404 Page Not Found -&gt;'. $ page;
		 $ this-&gt; adminmail ($ message);
		
		 parent :: show_404 ($ page);
	 }
	
	
	 / **
     * Returns a dump of environment variables
     *
     * @return string dump environment variables
     * /    
     function GetGlobalVariables ()
     {
		 $ content = 'REMOTE_ADDR ='. $ _ SERVER ["REMOTE_ADDR"]. "\ n";
		
		 if (isset ($ _ SERVER ["HTTP_REFERER"]))
		 {
			 $ content. = 'HTTP_REFERER ='. $ _ SERVER ["HTTP_REFERER"]. "\ n";
		 }

		 $ content. = 'USER_AGENT ='. $ _ SERVER ["HTTP_USER_AGENT"]. "\ n";		
		 $ content. = '$ _SERVER [\' REQUEST_URI \ '] =';
         $ content. = var_export (@ $ _ SERVER ['REQUEST_URI'], true);
         $ content. = "\ n". '$ _ GET =';
         $ content. = var_export (@ $ _ GET, true);
         $ content. = "\ n". '$ _ POST =';
         $ content. = var_export (@ $ _ POST, true);
         $ content. = "\ n";
		
         return $ content;
     }
	
	
	 / **
	  * The method sends an error message to the mail administrator
	  * 
	  * @return 
	  * @param object $ message
	  * /
	 function adminmail ($ message)
	 {
		 $ CI = &amp; get_instance ();
		
		 // If the config is not loaded - we load
		 if (! isset ($ CI-&gt; config))
		 {
			 $ CI-&gt; config = &amp; load_class ('Config');
		 }

		 // If the bootloader is not loaded - load
		 if (! isset ($ CI-&gt; load))
		 {
			 $ CI-&gt; load = &amp; load_class ('Loader');
		 }
		
		 // Load the class email
		 if (! isset ($ CI-&gt; email))
		 {
			 $ CI-&gt; email = &amp; load_class ('Email');
		 }
		
		 // For the mail class, the Language class is required.
		 if (! isset ($ CI-&gt; lang))
		 {
			 $ CI-&gt; lang = &amp; load_class ('Language');
		 }
		
		 // Email address of the administrator
		 $ email = $ CI-&gt; config-&gt; item ('log_to_email');
		
		 // If the address is not specified - do nothing
		 if (! strlen ($ email))
		 {
			 return;
		 }
		
		
		
		 // Sending
		 $ CI-&gt; email-&gt; from ('noreply');
		 $ CI-&gt; email-&gt; to ($ email);
		 $ CI-&gt; email-&gt; subject ('There was an error on the site');
		 $ CI-&gt; email-&gt; message ($ message);

		 $ CI-&gt; email-&gt; send ();
	 }
 }
</pre><br><br>  Do not forget.  that in order to enable the logging mechanism it is necessary in the <b><i>/system/application/config/config.php</i></b> file <b><i>to</i></b> specify the value '1' for the parameter log_threshold. <br><br>  You can download the <a href="">source code</a> ( <b><i>CodeIgniter.php</i></b> and <b><i>Common.php files</i></b> from <b><i>CodeIgniter 1.7.2</i></b> ) <br><br>  The code is pretty simple - I think everything is clear by source. <br>  If all the same questions arise - I will be happy to answer in the comments. <br><br><h4>  UPDATE: Adding an exception handler using hooks </h4><br>  In the comments, <a href="https://habrahabr.ru/users/mordred/" class="user_link">Mordred</a> advised to use hooks instead of editing the kernel files to invoke the installation code of the exception handler and the handler itself - thanks for the advice, I did. <br><br>  First you need to turn on the cookie mechanism. To do this, in the <b><i>/system/application/config/config.php</i></b> file, <b><i>enable_hooks</i></b> parameter <b><i>is</i></b> set to <b><i>TRUE</i></b> : <br><pre> $ config ['enable_hooks'] = TRUE;
</pre><br><br>  Then we install the hook itself in the <b><i>/system/application/config/hooks.php</i></b> file, <b><i>we</i></b> write: <br><pre> $ hook ['pre_system'] = array (
                                 'class' =&gt; '',
                                 'function' =&gt; 'addExceptionHandler',
                                 'filename' =&gt; 'exception_hook.php',
                                 'filepath' =&gt; 'hooks'
                                 );
</pre><br><br>  This code means that when the system starts, the addExceptionHandler method will be <b><i>called</i></b> from the file <b><i>/system/application/hooks/exception_hook.php</i></b> .  Here is the contents of this file: <br><pre> if (! defined ('BASEPATH')) exit ('No direct script access allowed');

	 / **
	 * Install an exception handler
	 *
	 * /
	 function addExceptionHandler ()
	 {
		 set_exception_handler ('_ exception_handler2');
	 }
	
	
	 / **
	 * Exception handler
	 *
	 * /
	 function _exception_handler2 ($ errstr)
	 {
		 $ error = &amp; load_class ('Exceptions');
		
		 $ error-&gt; adminmail ('1');
		
		 // Display the exception text on the screen
	     echo $ error-&gt; show_error ('error', nl2br ($ errstr));
		
		 // Should we log the error?  No?  We're done ...
		 $ config = &amp; get_config ();
		 if ($ config ['log_threshold'] == 0)
		 {
			 return;
		 }
		
		 // Write a message to the log
		 $ error-&gt; log_exception ('Exception', $ errstr, '', '');
		
		 exit;
	 }
</pre><br><br>  As a result, the framework core files remain intact. <br>  Download the new sources <a href="">here</a> . <br><br>  Minor improvements were made at the same time - if an error occurred before loading the controller - sending notifications to the admin did not work, since the necessary classes were not loaded for this, now there is a check and if the required class is not loaded, then we load it, plus minor changes. <br><br>  <a href="http://snippy.ru/snippet/1857-Dorabotka_standartnogo_mehanizma_obrabotki_oshibok_v_CodeIgniter/">Original article</a> </div><p>Source: <a href="https://habr.com/ru/post/74381/">https://habr.com/ru/post/74381/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../74374/index.html">How to take my money from the Yandex wallet. Part 2.1. Running</a></li>
<li><a href="../74376/index.html">Fasting divine spark</a></li>
<li><a href="../74377/index.html">Windows Seven and many layouts</a></li>
<li><a href="../74379/index.html">radikal.ru has once again banned the use of the service on torrents.ru</a></li>
<li><a href="../74380/index.html">Actual threat data for 2009</a></li>
<li><a href="../74382/index.html">Adding scripting to a program using Lua</a></li>
<li><a href="../74385/index.html">Installing SVN on almost any hosting (static svn)</a></li>
<li><a href="../74388/index.html">mtp - not so bad</a></li>
<li><a href="../74390/index.html">Light VPS image</a></li>
<li><a href="../74391/index.html">VLC: Stream and Stream Server # 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>