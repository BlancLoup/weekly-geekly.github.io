<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We are preparing a web application for the zoo versions of Android</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="More recently, and quite unexpectedly for myself, I was responsible for developing a program for Android. But I didn‚Äôt have to write to Java or Androi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We are preparing a web application for the zoo versions of Android</h1><div class="post__text post__text-html js-mediator-article">  More recently, and quite unexpectedly for myself, I was responsible for developing a program for Android.  But I didn‚Äôt have to write to Java or Android at all before.  It was necessary to make a web application, like phonegap and others, which almost completely works in the browser component.  And all this under version 2.2 - 4.3 (SDK 8 - 18). <br><br>  About some Android frills and crutches for them from the point of view of the person who saw all this for the first time, I would like to tell you.  I hope it went off without HelloWorld, ‚ÄúOMG!  Java ", etc. <br><br>  <a href="https://habr.com/ru/post/196546/">Screen rotation / orientation change</a> <br>  <a href="https://habr.com/ru/post/196546/">Network unreachable</a> <br>  <a href="https://habr.com/ru/post/196546/">Ship local resources</a> <br>  <a href="https://habr.com/ru/post/196546/">Bridge between java and javascript</a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br>  The entire program is essentially one WebView, in which local resources (assets) are loaded, and additional binding to it in Java.  What JS cannot accomplish on its own is jerking over a Java &lt;=&gt; JS bridge synchronously / asynchronously.  The latter can also ‚Äúquietly‚Äù on the page. <br><br><a name="orientation"></a><h4>  Screen rotation </h4><br>  In Android, changing the orientation of the device leads to a <i>re-creation of</i> Activity (UI).  For WebView, this causes the current page to be reloaded.  Accordingly, the padding of input fields, the current scroll position, the state of JS, etc. are lost. <br>  On the Internet, there are a lot of ways to deal with this situation, with different degrees of performance and taking into account different versions of the SDK.  As a result, the following option came up working for all the necessary SDK versions: <br><br>  In the manifest for the desired activity, we specify in android: configChanges "screenSize | orientation".  It is both, otherwise there will be a version where nothing will work. <br>  In layout, we do NOT describe WebView at all.  In the place where our browser will be, we describe the stub: <br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">FrameLayout</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">android:id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"@+id/webViewPlaceholder"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre> <br>  No browser - no problem with it :) <br><br>  Now in the class of our Activity: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> FrameLayout mWebViewPlaceholder; <span class="hljs-comment"><span class="hljs-comment">//    protected WebView mWebView; //  -    @Override protected void onCreate(Bundle savedInstanceState) { super.onCreate(savedInstanceState); setContentView(R.layout.activity_main); initUI(); } protected void initUI() { mWebViewPlaceholder = ((FrameLayout)findViewById(R.id.webViewPlaceholder)); if (mWebView == null) { mWebView = new WebView(this); mWebView.loadUrl("file:///android_asset/index.html"); } mWebViewPlaceholder.addView(mWebView); } @Override public void onConfigurationChanged(Configuration newConfig) { if (mWebView != null) { mWebViewPlaceholder.removeView(mWebView); //     WebView  UI } super.onConfigurationChanged(newConfig); setContentView(R.layout.activity_main); initUI(); //  WebView   UI } @Override protected void onSaveInstanceState(Bundle outState) { super.onSaveInstanceState(outState); mWebView.saveState(outState); } @Override protected void onRestoreInstanceState(Bundle savedInstanceState) { super.onRestoreInstanceState(savedInstanceState); mWebView.restoreState(savedInstanceState); }</span></span></code> </pre><br>  What is the result? <br>  When processing turn events and resolution changes, we temporarily pull out the WebView from the UI.  At the same time, we independently save and restore the state of the WebView, since  activity is destroyed when you go to the main screen of the system / another program, or open another activity in our program. <br>  By the way, if you want to preserve the values ‚Äã‚Äãof the page elements (of the same input), then they should be assigned an id.  Otherwise it will not be saved. <br><br><a name="network_unreachable"></a><h4>  Network unreachable </h4><br>  If you open the page from your external servers in WebView, then the situation with the disconnected network on the device (airplane mode, wifi off ...) is quite funny.  It seems to be catching WebViewClient.onReceivedError and swear.  And if everything is calm and the WebViewClient.onPageFinished is called, then the page has loaded.  This worked fine before, but on 4.3 (sdk 18) onReceivedError is called 2 <i>minutes</i> after the start of the download.  I just didn‚Äôt try to find and change the settings for timeouts ... onPageStarted works, and then everything, silence for 2 minutes ... <br>  Decision?  Open a local resource, and from it already pump up the necessary from the server. <br>  <i>If anyone knows what's the matter - write in the comments, maybe even when it is useful.</i> <br><br><a name="loadSmth"></a><h4>  Ship local resources </h4><br>  In WebView, without accessing the network, data can be loaded by passing either the loadData string ("...") or the address of the local resource loadUrl ("file: /// ...").  The first version with loadData unexpectedly showed itself with Cyrillic UTF-8.  Despite the fact that loadData takes one of the parameters of the string encoding, in Android from 4.1+ (in 4.0 still, as far as I remember, it didn‚Äôt manifest), the page is clearly rendered in a single-byte encoding.  And neither meta charset = utf-8, nor webView.getSettings (). SetDefaultTextEncodingName ("utf-8") did not correct the situation. <br>  Decision?  Load from file via loadUrl. <br><br><a name="j2js_workaround"></a><h4>  Bridge between java and javascript </h4><br>  To open a page in a standard browser component is, of <s>course, an extremely heavy task,</s> only preparation.  Important is the interaction of JS code with Java, and at the initiative of any of the parties. <br>  And there seems to be a handy thing - addJavascriptInterface (an example from the off documentation): <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JsObject</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"injectedObject"</span></span>; } } webView.addJavascriptInterface(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JsObject(), <span class="hljs-string"><span class="hljs-string">"injectedObject"</span></span>); webView.loadData(<span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"text/html"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); webView.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript:alert(injectedObject.toString())"</span></span>);</code> </pre><br>  We set "bridge" and its name for JS and everything, we use.  Calling loadData without page content may seem strange, but the interaction interface is not initialized (injectedObject is not created in JS) until at least something is loaded (you can even have an empty string). <br>  Passing parameters from JS to Java is also possible; the main match is the number and types of parameters. <br>  We write, run in emulators and real devices: 4.3 - works, 4.2 - works, ... 2.3 - the application falls into the crust (crashes to the OS start screen) ... wait WHAT? ... 2.2 - works.  Again 2.3 - in the crust. <br>  A crash occurs when accessing injectedObject.toString (even without calling).  The call to injectedObject is easy. <br>  The appearance of ‚ÄúcallJNIMethod &lt;&gt;‚Äù in the backtrace promises interesting leisure activities in the near future ... <br>  Googling and SO scanning shows that the problem is massive and occurs with a probability close to 100% on the entire 2.3. * Line (sdk 9 - 10).  It seems even sometimes on 2.2 (sdk 8), but I have met only a couple of such messages, but I don‚Äôt have a real device on this version, so I can‚Äôt confirm.  And both on emulators and real devices.  The main thing is to use WebView as a non-V8 JS engine. <br>  The cries of the masses and the requests to Google to fix the bug began in 2010, but they did not release the official correction. <br><br>  Over the years, several options have emerged for at least some workaround of the problem, workaround specifically under 2.3. *.  Without considering the options, when the program cursed and refused to work under the affected versions, the solutions can be divided into the following approaches: <br><br>  1. Instead of direct requests to Java, we perform, figuratively, the following: <br><pre> <code class="javascript hljs"> <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location = <span class="hljs-string"><span class="hljs-string">'http://OurMegaPrefix:MethodName:Param0:Param1'</span></span>;</code> </pre><br>  Then in Java such a request is processed through <br><pre> <code class="java hljs">webView.setWebViewClient(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebViewClient() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">shouldOverrideUrlLoading</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WebView view, String url)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!url.startsWith(<span class="hljs-string"><span class="hljs-string">"OurMegaPrefix"</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">//  :  ,     ,   } //    : public void onPageFinished(WebView view, String url) { super.onPageFinished(view, url); if (javascriptInterfaceBroken) { String handleGingerbreadStupidity = "javascript:function openQuestion(id) { window.location='http://jshandler:openQuestion:'+id; }; " + "javascript: function handler() { this.openQuestion=openQuestion; }; " + "javascript: var jshandler = new handler();"; webView.loadUrl(handleGingerbreadStupidity); } } }); if (!javascriptInterfaceBroken) { webView.addJavascriptInterface(new JsObject(), "jshandler"); }</span></span></code> </pre><br>  After the page is loaded into onPageFinished, we inject the code into the page to implement the proxy object we need. <br>  In addition to the frankly crutch decision, this method also does not allow making a synchronous call with obtaining a result.  You can pass the name of the callback function ... But we will not do that, let's go further. <br><br>  2. Another option is to use the standard javascript interface for receiving a synchronous (for js) response from the user: prompt ().  The main thing to catch him :) <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = prompt(<span class="hljs-string"><span class="hljs-string">'OurMegaPrefix:meth:param0:param1'</span></span>);</code> </pre><br>  In res, somehow you need to save the result of the call from Java.  And showing nothing to the user. <br><pre> <code class="java hljs">webView.setWebChromeClient(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebChromeClient() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onJsPrompt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String prefix = JSAPI.class.getSimpleName(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!message.startsWith(prefix)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.onJsPrompt(view, url, message, defaultValue, result); } <span class="hljs-comment"><span class="hljs-comment">//  return true; //   prompt   } });</span></span></code> </pre><br>  Here, JSAPI is the name of the proxy class (called ‚ÄúJsObject‚Äù above). <br>  Having received one way or another the name of the method and the parameters (if any) it remains to call the corresponding method in JSAPI. <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> jsapi = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSAPI();</code> </pre><br>  The article is not about reflection in Java, so in short we do it this way: <br><pre> <code class="java hljs">Method method = JSAPI.class.getMethod(methodName, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Class[] {String.class});</code> </pre><br>  to call a method with one string parameter. <br>  Or just search by name: <br><pre> <code class="java hljs">Method method = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Method meth : JSAPI.class.getMethods()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (meth.getName().equals(methodName)) { method = meth; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } }</code> </pre><br>  Then we call the found method (again, an example for one parameter): <br><pre> <code class="java hljs">method.invoke(jsapi, parameter);</code> </pre><br><br>  In general, this is enough for interfacing to bypass addJavascriptInterface.  But I will offer my wrapper on all this business. <br>  <i>I myself am a backend (php, python, bash, C, etc.) and my JS is not so cool that it is not a shame for him.</i>  <i>I will accept suggestions for improving the code :)</i> <br><br>  To transfer more complex objects than strings, use json: <br><ul><li>  on the js side via JSON.stringify and JSON.parse; </li><li>  on the java side via JSONObject and JSONArray. </li></ul><br>  And by DOMContentLoaded: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> JSAPI == <span class="hljs-string"><span class="hljs-string">'object'</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } (<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> JSAPI = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">bridge</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> args = <span class="hljs-built_in"><span class="hljs-built_in">Array</span></span>.prototype.slice.call(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>.callee.caller.arguments, <span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = prompt(<span class="hljs-string"><span class="hljs-string">'JSAPI.'</span></span>+func, <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(args)); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { res = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(res); res = (res &amp;&amp; res.result) ? res.result : <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e) { res = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getUserAccounts = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    return bridge('getUserAccounts'); } }; window['JSAPI'] = new JSAPI(); })(window);</span></span></code> </pre><br>  If JSAPI is not declared (addJavascriptInterface was not called) - form a wrapper. <br>  The essence of the wrapper - form the call prompt ('JSAPI.getUserAccounts', '[]'), where the second parameter is the json array of call parameters. <br>  And the result of the prompt should return to us {result: ANSWER}. <br><br>  Now, regardless of the Android SDK version, we call our method: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> res = JSAPI.getUserAccounts(); <span class="hljs-comment"><span class="hljs-comment">//       json   : console.log(JSON.parse(res)[0]);</span></span></code> </pre><br><br>  On the Java side: <br><pre> <code class="java hljs">webView.setWebChromeClient(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebChromeClient() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onJsPrompt</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(WebView view, String url, String message, String defaultValue, JsPromptResult result)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//     prompt(message='JSAPI.method', defaultValue='params') final String prefix = JSAPI.class.getSimpleName() + "."; if (!message.startsWith(prefix)) { return super.onJsPrompt(view, url, message, defaultValue, result); } final String meth_name = message.substring(prefix.length()); String json_result = null; try { //    json  final JSONArray params = new JSONArray(defaultValue); final int len = params.length(); final Object []paramValues = new Object[len]; for (int i = 0; i &lt; len; ++i) { paramValues[i] = params.opt(i); } //  ,      Method method = null; for (Method meth : JSAPI.class.getMethods()) { if (meth.getName().equals(meth_name)) { method = meth; break; } } if (null == method) { throw new NoSuchMethodException(); } //      "{\"result\":}" final JSONObject res = new JSONObject(); res.put("result", method.invoke(new JSAPI(), paramValues)); json_result = res.toString(); } catch (JSONException e) { // ... } catch (NoSuchMethodException e) { // ... } catch (InvocationTargetException e) { // ... } catch (IllegalAccessException e) { // ... } result.confirm(json_result); return true; } });</span></span></code> </pre><br>  And the method itself for the integrity of the example: <br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">JSAPI</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@JavascriptInterface</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getUserAccounts</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JSONArray json = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONArray(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String emailPattern = Patterns.EMAIL_ADDRESS.pattern(); <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> AccountManager am = AccountManager.get(getApplicationContext()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (am != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (Account ac : am.getAccounts()) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ac.name.matches(emailPattern)) { <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> JSONArray item = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> JSONArray(); item.put(ac.type); item.put(ac.name); json.put(item); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.toString(); } }</code> </pre><br>  If the method accepts parameters, they must be specified.  The result I always have for unification is set as a String, regardless of the returned result. <br>  Annotation @JavascriptInterface needed for fresh versions of the SDK.  In the old and without it worked. <br><br>  As a conclusion, I also want to say that often the ‚Äúbroken android‚Äù condition included a code that checks Build.VERSION.RELEASE == "2.3".  Bad check, better through Build.VERSION.RELEASE.startsWith ("2.3").  Better yet, IMHO, check the SDK version directly: (Build.VERSION.SDK_INT == 9) ||  (Build.VERSION.SDK_INT == 10). <br><br>  Those who wish to check the JS assembly (on V8, I repeat, the bug is not reproduced) I suggest to google, everything is simple there. <br><br><br>  And for a snack call initiated by Java: when needed, or as a callback. <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callJS</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">final</span></span></span></span><span class="hljs-function"><span class="hljs-params"> String jsCode)</span></span></span><span class="hljs-function"> </span></span>{ runOnUiThread(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Runnable() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ webView.loadUrl(<span class="hljs-string"><span class="hljs-string">"javascript:"</span></span> + jsCode); } }); } jsapi.callJS(<span class="hljs-string"><span class="hljs-string">"alert('Hello, Habr!');"</span></span>);</code> </pre><br>  runOnUiThread is required if callJS is not called in the UI stream (almost as it will be). <br>  But :) In 2.2, it worked without me.  In older versions, it became more logical to fix. <br><br>  This is how I write the first Java application :) I hope someone was interested or, suddenly, even useful. <br><br>  PS Android Studio has recently grown to 0.2.11, and it is already quite possible to use it if you like JetBrains products.  Not without unpleasant flaws, but quite functional. <br><br>  PPS Some changes were made to the code samples based on the comments received. </div><p>Source: <a href="https://habr.com/ru/post/196546/">https://habr.com/ru/post/196546/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../196532/index.html">RuSSIR Music Hackathon 2013: notes of the organizer</a></li>
<li><a href="../196536/index.html">Promo of new Zoloo game for fun friends groups</a></li>
<li><a href="../196538/index.html">The digest of interesting news and materials from the world of PHP for the last two weeks, No. 27 (September 22 - October 6, 2013)</a></li>
<li><a href="../196542/index.html">NVIDIA Shield - the best portable boom console</a></li>
<li><a href="../196544/index.html">Stored Functions on C in PostgreSQL</a></li>
<li><a href="../196548/index.html">Lock-free data structures. The basics: where did the memory barriers go from?</a></li>
<li><a href="../196550/index.html">Configuring Vim to work with Python code</a></li>
<li><a href="../196556/index.html">Test of the prototype of the iLook Media Center</a></li>
<li><a href="../196560/index.html">Introduction to the analysis of the complexity of algorithms (part 1)</a></li>
<li><a href="../196562/index.html">Wi-Fi Mesh networks for the smallest</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>