<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto-update program through MSSQL server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In order not to run on their work to each person who uses my program it is reasonable to make an auto-update, which will update the program if you upl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto-update program through MSSQL server</h1><div class="post__text post__text-html js-mediator-article">  In order not to run on their work to each person who uses my program it is reasonable to make an auto-update, which will update the program if you upload a new version to the server.  Having tried many ways, I found the easiest to use (although not the most correct) <br>  So the algorithm: <br><ol><li>  When turned on, the program checks the latest version on the server. </li><li>  If on the server above the current one, then download the Zip-archive with the program. </li><li>  We rename the application file to another (for the sake of backup and accessibility to the file), for example from program.exe to program.backup. </li><li>  Unpack the archive by replacing the files in the folder. </li><li>  Delete the archive with the update. </li><li>  Restart the program. </li></ol><br><a name="habracut"></a><br>  But before all this, we first create the <b>Updater</b> table (for example) in MSSQL with fields: <br>  <b>name</b> - the varchar type; <br>  <b>version ‚Äî</b> type varchar; <br>  <b>files</b> - type varbinary (max) (or any other blob-field). <br>  It is better to immediately create a record in the table, where program will be in the name field. <br>  Add this procedure to the code to extract the program version number: <br><pre><code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetMyVersion</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TVerInfo=<span class="hljs-keyword"><span class="hljs-keyword">packed</span></span> <span class="hljs-keyword"><span class="hljs-keyword">record</span></span> Nevazhno: <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>[<span class="hljs-number"><span class="hljs-number">0</span></span>..<span class="hljs-number"><span class="hljs-number">47</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> byte; <span class="hljs-comment"><span class="hljs-comment">//   48  Minor,Major,Build,Release: word; //    end; var s:TResourceStream; v:TVerInfo; begin result:=''; try s:=TResourceStream.Create(HInstance,'#1',RT_VERSION); //   if s.Size&gt;0 then begin s.Read(v,SizeOf(v)); //     result:=IntToStr(v.Major)+IntToStr(v.Minor)+ //   ... IntToStr(v.Release)+IntToStr(v.Build); end; s.Free; except; end; end;</span></span></code> </pre> <br>  Now we need a library to unpack the archives, because I will store the update in a zip archive, use the <a href="http://yadi.sk/d/hQ4IaJrxsfIw">SevenZip</a> library, add the path to the library sources in Delphi in the library. <br>  Now we need to download the archive itself with the new version of the program into the database.  I made a form with downloading updates to the server: <br><img src="http://panda-kun.ru/pictures/3434343434.PNG" alt="image"><br>  On opening <b>OpenDialog</b> I think everything is clear, we rewrite the path to edit <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> OpenDialog1.Execute <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> cxButtonEdit1.Text:=OpenDialog1.FileName;</code> </pre> <br><br>  The version number is best entered in <b>MaskEdit</b> with a mask - <b>! 9.9.9.0; 1; _</b> <br>  Click the save button to upload the file with the procedure: <br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blobF: TBlobField; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> FileExists(OpenDialog1.FileName) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'  !'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> cxButtonEdit1.Text:=OpenDialog1.FileName; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> ADOTable1.TableName:=Updater; <span class="hljs-comment"><span class="hljs-comment">//       ADOTable1.Close; ADOTable1.Open; //  name   program ADOTable1.Filtered := False; ADOTable1.Filter := 'name='+#39+'program'+#39; ADOTable1.Filtered := True; ADOTable1.Edit; blobF := ADOTable1.FieldByName('files') as TBlobField; blobF.LoadFromFile(OpenDialog1.FileName); ADOTable1.FieldByName('version').AsString:=cxMaskEdit1.Text; ADOTable1.Post; except Showmessage(' !'); end;</span></span></code> </pre> <br>  This is a slightly wrong method; it is best to make it a separate stream, especially if the archive is large. <br><br>  It is necessary to add to Uses - <b>SevenZip</b> and <b>ShellAPI</b> . <br>  Now create the most important update procedure, calling it Update: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="delphi hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">Procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TForm1</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Update</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path,fullpath,Ourversion,LastVersion:<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>; blobF: TBlobField; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-comment"><span class="hljs-comment">//     adoquery4.Active:=false; adoquery4.sql.text:='SELECT version FROM [dbo].[Updater] WHERE name='+#39+'program'+#39; adoquery4.Active:=true; //        ,    Ourversion:=GetMyVersion; LastVersion:=adoquery4.FieldByName('version').Value; while pos('.',LastVersion)&lt;&gt;0 do delete(LastVersion,pos('.',LastVersion),1); //             if strtoint(LastVersion)&gt;strtoint(Ourversion) then If messageBox(Handle,'   . ?','?', mb_YesNo or mb_iconquestion)=mrYes then try path:=ExtractFileDir(ParamStr(0)); if FileExists(path+'\Program.backup') then DeleteFile(path+'\Project2.backup'); RenameFile(path+'\Program.exe', path+'\Program.backup'); //   // //ADOTable1    Updater ADOTable1.Close; ADOTable1.Open; ADOTable1.Filtered := False; ADOTable1.Filter := 'name='+#39+'program'+#39; ADOTable1.Filtered := True; ADOTable1.Active:=true; //  blobF := ADOTable1.FieldByName('files') as TBlobField; if blobF.Value = nil then Exit; blobF.SaveToFile(path+'\Update_ARMTitan.zip'); ADOTable1.Active:=false; //   with CreateInArchive(CLSID_CFormatZip) do begin OpenFile(ExtractFilePath(ParamStr(0)) + 'Update_ARMTitan.zip'); ExtractTo(ExtractFilePath(ParamStr(0))); Close; end; //    DeleteFile(path+'\Update_ARMTitan.zip'); //  fullpath:=path+'\Project2.exe'; ShellExecute(0, 'open', PWideChar(fullpath), '', nil, SW_SHOW); //WinExec(PAnsiChar(fullpath), SW_SHOW); Application.Terminate; // or: Close; finally end; end;</span></span></code> </pre> <br>  Here, too, there is a flaw, it is better to unpack each file individually and check for errors, and not the entire archive as I did. <br>  There are 2 little things that must be observed: <br>  1. In the program directory there should be a 7z.dll file, so it is better to check: <pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> FileExists(path+<span class="hljs-string"><span class="hljs-string">'\7z.dll'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ShowMessage(<span class="hljs-string"><span class="hljs-string">'  7z.dll'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>;</code> </pre>  or something else on the other. <br>  2. In the archive with the update should not be present file 7z.dll, as it is used, or unpack everything separately as I wrote above and do not unpack only this file. <br><br>  That's all.  The main thing is not to forget before compiling the finished program for updating, before adding it to the archive, change the version number of the program. <br><br>  There are some shortcomings in this way and I know it.  But so far I have been using it and have not experienced any problems, although it should be refined. </div><p>Source: <a href="https://habr.com/ru/post/152285/">https://habr.com/ru/post/152285/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../152273/index.html">Mobile automation of bell ringing</a></li>
<li><a href="../152275/index.html">IT Compote # 24 Programming and Technology Podcast</a></li>
<li><a href="../152277/index.html">Do you use Pinterest or Pinme for personal or business purposes?</a></li>
<li><a href="../152279/index.html">Android - Continuous Integration. Part 2</a></li>
<li><a href="../152283/index.html">Position changes in the App Store: in fact, everything still depends on downloads</a></li>
<li><a href="../152287/index.html">uRPF (anti-spoofing protection data plane)</a></li>
<li><a href="../152289/index.html">ObjectScript - a new programming language</a></li>
<li><a href="../152291/index.html">Installing SilkJS on Centos 6</a></li>
<li><a href="../152297/index.html">The pitfalls of creating a mini Contact Center on Asterisk</a></li>
<li><a href="../152299/index.html">Multichannel software PWM to AVR</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>