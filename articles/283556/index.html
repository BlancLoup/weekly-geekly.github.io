<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Angular 2 Beta, training course "Tour of Heroes" part 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part 1 Part 2 Part 3 Part 4 
 Services 


 A tour of heroes is evolving, and we look forward to adding new components in the near future. 


 Several ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Angular 2 Beta, training course "Tour of Heroes" part 4</h1><div class="post__text post__text-html js-mediator-article"><p>  <a href="https://habrahabr.ru/post/281190/">Part 1</a> <a href="https://habrahabr.ru/post/281727/">Part 2</a> <a href="https://habrahabr.ru/post/282634/">Part 3</a> <a href="https://habrahabr.ru/post/283556/">Part 4</a> </p><br><h3>  Services </h3><br><p>  A tour of heroes is evolving, and we look forward to adding new components in the near future. </p><br><p>  Several components need access to the data of the characters, and we do not want to copy and paste the same code over and over again.  Instead, we will create one data service that can be reused later on and learn how to use it in the components that need it. <a name="habracut"></a></p><br><p>  Refactoring data access to a separate service helps to not ‚Äúinflate‚Äù the components and aims to support the display.  In addition, the use of the mok service (mock - stub, allows you not to access the real data from the server) facilitates unit testing of the component (unit-tests). </p><br><p>  Since the data received by the service will always be asynchronous, we will end this chapter with a version of the service based on the promise (promise). </p><br><p>  <a href="https://angular.io/resources/live-examples/toh-4/ts/plnkr.html">Run the application, part 4</a> </p><br><h3>  Where we stayed </h3><br><p>  Before continuing our tour of heroes, let's check that our project has the following structure.  If this is not the case, you will need to return to the previous chapters. </p><br><pre><code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">angular2-tour-of-heroes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.component</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hero</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hero-detail</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.component</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">node_modules</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">typings</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.html</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.json</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">styles</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.css</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">systemjs</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.config</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.js</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tsconfig</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.json</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">typings</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.json</span></span></code> </pre> <br><h4>  Support code conversion and application execution </h4><br><p>  Open a terminal / console window.  Start the TypeScript compiler, which will monitor the changes, and the server by entering the command: </p><br><pre> <code class="bash hljs"> npm start</code> </pre> <br><p>  The application will start and will be updated automatically while we create the Tour of Heroes. </p><br><h3>  Creating service heroes </h3><br><p>  Our customers shared their vision of our application.  They say they want to display heroes in different ways on different pages.  We can already choose a hero from the list.  Soon we will add a panel to display the best characters, and create a separate view for editing the details of the hero.  All these representations need data heroes. </p><br><p>  Currently, <code>AppComponent</code> contains fictitious hero data.  We have at least two objections.  First, the definition of these heroes is not the responsibility of the component.  Secondly, we cannot easily provide access to this data to other components and views. </p><br><p>  We can refactor the logic of obtaining data about heroes into one service, which will provide access to data about heroes and give access to this service to those components that need heroes. </p><br><h4>  Create HeroService </h4><br><p>  Create a file in the <code>app</code> folder named <code>hero.service.ts</code> . </p><br><blockquote>  We have adopted a convention in which the service is referred to as lowercase letters with the addition of <code>.service</code> .  If the service name consists of several words, the name ‚Äúlower case with a dash‚Äù is used for naming.  For example, the <code>SpecialSuperHeroService</code> service will be defined by the file name <code>special-super-hero.service.ts</code> . </blockquote><br><p>  <code>HeroService</code> class <code>HeroService</code> and mark it exported so that other classes can import it. </p><br><p>  <strong>hero.service.ts (exported class)</strong> </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Injectable } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeroService</span></span></span><span class="hljs-class"> {</span></span> }</code> </pre> <br><h4>  Service implementation </h4><br><p>  Notice that we imported the Angular <code>Injectable</code> function and used the <code>@Injectable()</code> decorator. </p><br><blockquote>  Do not forget the parentheses!  Ignoring them leads to a difficult to diagnose error. </blockquote><br><p>  TypeScript sees the <code>@Injectable()</code> decorator and makes available metadata about our service, the metadata that Angular may need to be embedded into other dependencies of this service. </p><br><p>  <code>HeroService</code> has no dependencies at the moment.  Add a decorator anyway.  This is an example of "best practice" - use the <code>@Injectable()</code> decorator <em>from the very beginning</em> to show its purpose in perspective. </p><br><h5>  Getting heroes </h5><br><p>  Add a <code>getHeroes</code> stub <code>getHeroes</code> . </p><br><p>  <strong>hero.service.ts (getHeroes stub)</strong> </p><br><pre> <code class="cpp hljs"> @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeroService</span></span></span><span class="hljs-class"> {</span></span> getHeroes() { } }</code> </pre> <br><p>  Let's wait a little bit with implementation to make an important remark. </p><br><p>  The consumer of our service does not know how the service receives data.  Our <code>HeroService</code> can get <code>Hero</code> data from anywhere.  He could get data from a web service or local storage device or from the wet method that returns some dummy data. </p><br><p>  This is the beauty of making data access from a component.  We can change implementations as often as we like and when it is needed, without affecting the components that need data about the characters. </p><br><h5>  Bogus data of heroes </h5><br><p>  We already have <code>Hero</code> dummy data that is in the <code>AppComponent</code> .  But <em>here</em> they have no place.  We will move this dummy data to a separate file. </p><br><p>  Cut the <code>HEROES</code> array from <code>app.component.ts</code> and paste it into the new file in the <code>app</code> folder called <code>heroes.ts</code> .  In addition, you need to copy the <code>import {Hero} ...</code> because the array of heroes uses the <code>Hero</code> class. </p><br><p>  <strong>mock-heroes.ts (array of heroes)</strong> </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Hero } from <span class="hljs-string"><span class="hljs-string">'./hero'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> var HEROES: Hero[] = [ {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Mr. Nice"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Narco"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bombasto"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celeritas"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Magneta"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"RubberMan"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dynama"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dr IQ"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Magma"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tornado"</span></span>} ];</code> </pre> <br><p>  We export the <code>HEROES</code> array as a constant, so we can import it elsewhere ‚Äî for example, as our <code>HeroService</code> . </p><br><p>  In the meantime, in <code>app.component.ts</code> , from where we cut the <code>HEROES</code> array, we leave the <code>heroes</code> non-initialized property: </p><br><p>  <strong>app.component.ts (heroes property)</strong> </p><br><pre> <code class="cpp hljs"> heroes: Hero[];</code> </pre> <br><h5>  Return fictitious list of heroes </h5><br><p>  Returning to <code>HeroService</code> we import our <code>HEROES</code> stub and return it in the <code>getHeroes</code> method.  Our <code>HeroService</code> service looks like this: </p><br><p>  <strong>hero.service.ts</strong> </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Injectable } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HEROES } from <span class="hljs-string"><span class="hljs-string">'./mock-heroes'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeroService</span></span></span><span class="hljs-class"> {</span></span> getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HEROES; } }</code> </pre> <br><h5>  Using the service of heroes </h5><br><p>  We are ready to use <code>HeroService</code> in other components.  Let's start with the <code>AppComponent</code> . </p><br><p>  At the beginning, as usual, we import what we want to use, that is, <code>HeroService</code> . </p><br><p>  <strong>app.component.ts (import HeroService)</strong> </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HeroService } from <span class="hljs-string"><span class="hljs-string">'./hero.service'</span></span>;</code> </pre> <br><p>  Import service allows you to <em>refer</em> to it in our code.  How should an <code>AppComponent</code> get a specific instance of <code>HeroService</code> at runtime? </p><br><h5>  Should we use <em>new HeroService</em> ?  In no case! </h5><br><p>  We could create a new instance of HeroService using <code>new</code> , for example, like this ( <strong>no need to do that!</strong> ): </p><br><pre> <code class="cpp hljs"> heroService = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HeroService(); <span class="hljs-comment"><span class="hljs-comment">// don't do this</span></span></code> </pre> <br><p>  This is a bad idea for several reasons. </p><br><ul><li>  Our component needs to know how to create <code>HeroService</code> .  If we ever change the <code>HeroService</code> constructor, we need to find each place where the service is created and make edits.  Such edits can lead to errors, and add additional burden on testing. </li><li>  We create a new service every time we use "new".  What if the service needs to cache the heroes and share the cache with others?  We will not be able to do this. </li><li>  In <code>AppComponent</code> we are tied to a specific implementation of <code>HeroService</code> .  It will be difficult to switch implementations for different scenarios.  Can we work offline?  Do we need different versions of fictitious implementations when testing?  It is not simple. </li></ul><br><p>  <em>What if ... what if ... Hey, we have work to do!</em> </p><br><p>  We will do it.  Avoiding these problems is so easy that there is no excuse for doing it wrong. </p><br><h5>  Introduction of <em>HeroService</em> </h5><br><p>  Two lines instead of the one using <em>new</em> : </p><br><ol><li>  We will add a constructor. </li><li>  We will add the <code>providers</code> metadata to the component. </li></ol><br><p>  Here is the constructor: </p><br><p>  <strong>app.component.ts (constructor)</strong> </p><br><pre> <code class="cpp hljs"> constructor(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> heroService: HeroService) { }</code> </pre> <br><p>  By itself, the constructor does nothing.  The parameter simultaneously determines the private property <code>heroService</code> and identifies it as a place <code>HeroService</code> implemented. </p><br><p>  Angular will now know to transfer a copy of <code>HeroService</code> when it creates a new <code>AppComponent</code> . </p><br><p>  Angular should get this copy from somewhere.  This is the function of the Angular Dependency Injector (dependency "implementer" - further Injector).  <strong>The injector</strong> has a <strong>container of</strong> previously created services.  Either it finds and returns a previously existing <code>HeroService</code> instance from the container, or it creates a new instance, adds it to the container, and returns it to Angular. </p><br><blockquote>  Read more about dependency injection in Dependency <a href="https://angular.io/docs/ts/latest/guide/dependency-injection.html">Injection</a> . </blockquote><br><p>  <em>The injector</em> does not yet know how to create a <code>HeroService</code> .  If we run our code now, Angular will give an error: </p><br><pre> <code class="hljs pgsql"> <span class="hljs-keyword"><span class="hljs-keyword">EXCEPTION</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> provider <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> HeroService! (AppComponent -&gt; HeroService)</code> </pre> <br><p>  We have to teach the <em>injector</em> how to create <code>HeroService</code> by registering the provider <code>HeroService</code> .  To do this, you need to add the property array <code>providers</code> at the bottom of the component metadata in the <code>@Component</code> call. </p><br><p>  <strong>app.component.ts (providing HeroService)</strong> </p><br><pre> <code class="cpp hljs"> providers: [HeroService]</code> </pre> <br><p>  The <code>providers</code> array indicates Angular to create a new <code>HeroService</code> instance when it creates a new <code>AppComponent</code> .  <code>AppComponent</code> can use this service to get heroes, and in addition, each descendant of a component in the tree of this component can receive it. </p><br><blockquote>  <strong>Services and component tree</strong> </blockquote><br><p>  Recall that <code>AppComponent</code> creates an instance of <code>HeroDetail</code> , based on the <code>&lt;my-hero-detail&gt;</code> at the bottom of its template.  <code>HeroDetail</code> is a descendant of <code>AppComponent</code> . </p><br><p>  If <code>HeroDetailComponent</code> component requires the <code>HeroService</code> parent component, it will ask Angular to inject the service into its constructor, which will look the same as for AppComponent: </p><br><p>  <strong>hero-detail.component.ts (constructor)</strong> </p><br><pre> <code class="cpp hljs">constructor(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> heroService: HeroService) { }</code> </pre> <br><p>  The <code>HeroDetailComponent</code> component <code>HeroDetailComponent</code> <em>not</em> repeat the array of its parent's <code>providers</code> !  Think why.  In the annex below, this will be discussed in more detail. </p><br><p>  <code>AppComponent</code> is a component of the highest level of our application.  The application should have only one copy of this component and only one copy of <code>HeroService</code> in our entire application. </p><br><h5>  <em>getHeroes</em> in <em>AppComponent</em> </h5><br><p>  We have a service in the private variable <code>heroService</code> .  Let's use her. </p><br><p>  Let's pause to think.  We can call the service and get the data in one line. </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroes = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroService.getHeroes();</code> </pre> <br><p>  In fact, we do not need a special method to wrap one string.  We write this anyway: </p><br><p>  <strong>app.component.ts (getHeroes)</strong> </p><br><pre> <code class="cpp hljs"> getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroes = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroService.getHeroes(); }</code> </pre> <br><h5>  Hook <em>ngOnInit</em> life cycle </h5><br><p>  <code>AppComponent</code> should receive and display heroes without <code>AppComponent</code> fuss.  Where should we call <code>getHeroes</code> ?  In the constructor?  <em>Do</em> n't do that! </p><br><p>  Years of experience and bitter tears have taught us to make complex logic from the constructor, especially the one that can use the server as a data source. </p><br><p>  The constructor is intended for simple initializations, like assigning constructor parameters to properties.  But not for heavy things.  We should be able to create a component in the test and not worry that it can do real work ‚Äî such as calling the server!  - until we tell him to do it. </p><br><p>  If there is no constructor, then someone should make a call to the <code>getHeroes</code> method. </p><br><p>  Angular will do this if we implement the <strong>ngOnInit</strong> <em>Lifecycle Hook</em> (the ngOnInit life cycle hook).  Angular offers a number of interfaces to participate in the critical moments of the component life cycle: during creation, after each change, and during its final destruction. </p><br><p>  Each interface has one method.  When a component implements this method, Angular makes it call at the appropriate time. </p><br><blockquote>  Learn more about the life cycle of hooks in the chapter <a href="https://angular.io/docs/ts/latest/guide/lifecycle-hooks.html">Life cycle of hooks</a> . </blockquote><br><p>  Here is a brief description of the OnInit interface: </p><br><p>  <strong>app.component.ts (OnInit protocol)</strong> </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { OnInit } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class"> {</span></span> ngOnInit() { } }</code> </pre> <br><p>  We write the <code>ngOnInit</code> method with our initialization logic inside and let Angular call it at the right time.  In our case, the initialization is to call <code>getHeroes</code> . </p><br><p>  <strong>app.component.ts (OnInit protocol)</strong> </p><br><pre> <code class="cpp hljs"> ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getHeroes(); }</code> </pre> <br><p>  Our application, as expected, shows a list of heroes and a view with detailed information about the hero when we click on the name of the hero. </p><br><p>  We are getting closer.  But something else is not quite right. </p><br><h3>  Asynchronous services and promises (promises) </h3><br><p>  Our <code>HeroService</code> returns a list of bogus heroes immediately.  This is the <code>getHeroes</code> synchronous signature signature: </p><br><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroes = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroService.getHeroes();</code> </pre> <br><p>  It is necessary to request heroes, and they are in the returned result. </p><br><p>  In the future we are going to get heroes from a remote server.  For now, we will not use HTTP, but we will strive for this in the next chapters. </p><br><p>  When we make a call, we need to wait for the server to respond, and we will not be able to block the user interface while we wait, even if we want (although we should not), since the browser will not block. </p><br><p>  We will have to use some kind of asynchronous data retrieval method that will change the signal of our <code>getHeroes</code> method. </p><br><p>  We will use <em>promises</em> . </p><br><h5>  Service heroes make a promise </h5><br><p>  A promise ... well, a promise to make our call later when the results are ready.  We ask the asynchronous service to do some work and give the callback function.  It does this work (somewhere) and eventually it calls our function with the results of the work or with an error. </p><br><blockquote>  This is a simplified description.  Learn about ES2015 promises <a href="http://exploringjs.com/es6/ch_promises.html">here</a> and elsewhere on the Internet. </blockquote><br><p>  Update <code>HeroService</code> using the getHeroes promise method: </p><br><p>  <strong>hero.service.ts (getHeroes)</strong> </p><br><pre> <code class="cpp hljs"> getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.resolve(HEROES); }</code> </pre> <br><p>  We still use dummy data.  We imitate the behavior of the superhigh-speed, zero-latency server, returning the already allowed (fulfilled) promise with a fictitious list of our heroes, as a result. </p><br><h5>  Keeping the promise </h5><br><p>  Returning to the <code>AppComponent</code> component and the <code>getHeroes</code> method, we see that it still looks like this: </p><br><p>  <strong>app.component.ts (getHeroes - old version)</strong> </p><br><pre> <code class="cpp hljs"> getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroes = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroService.getHeroes(); }</code> </pre> <br><p>  As a result of our change in <code>HeroService</code> , we will redo <code>this.heroes</code> to work with a promise, instead of an array of heroes. </p><br><p>  We have to change our implementation in order to <em>fulfill the promise when it is allowed (fulfilled)</em> .  When the promise is resolved successfully, <em>then</em> we will have heroes for display. </p><br><p>  We pass our callback function as an argument to the <strong>then</strong> promise method: </p><br><p>  <strong>app.component.ts (getHeroes - new version)</strong> </p><br><pre> <code class="cpp hljs"> getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroService.getHeroes().then(heroes =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroes = heroes); }</code> </pre> <br><blockquote>  <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Functions/Arrow_functions">The ES2015 arrow function</a> in the callback is more powerful than using the equivalent function, and works elegantly with <em>this</em> . </blockquote><br><p>  Our callback assigns the <code>heroes</code> component property an array of heroes that the service returned.  That's all! </p><br><p>  Our application should still show a list of heroes, and display a detailed view of the hero when choosing from the list. </p><br><blockquote>  Go to the "Get it Slow" app to see what data retrieval with a bad connection will look like (delayed response). </blockquote><br><h4>  Application structure overview </h4><br><p>  Let's check that we have the following structure after our wonderful refactoring in this chapter: </p><br><pre> <code class="hljs css"> <span class="hljs-selector-tag"><span class="hljs-selector-tag">angular2-tour-of-heroes</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">app</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.component</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hero</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hero-detail</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.component</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">hero</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.service</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">main</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mock-heroes</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.ts</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">node_modules</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">typings</span></span> ... <span class="hljs-selector-tag"><span class="hljs-selector-tag">index</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.html</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">package</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.json</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tsconfig</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.json</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">typings</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.json</span></span></code> </pre> <br><p>  The code files that we discussed in this chapter. </p><br><div class="spoiler">  <b class="spoiler_title">app / hero.service.ts</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Injectable } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Hero } from <span class="hljs-string"><span class="hljs-string">'./hero'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HEROES } from <span class="hljs-string"><span class="hljs-string">'./mock-heroes'</span></span>; @Injectable() <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HeroService</span></span></span><span class="hljs-class"> {</span></span> getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Promise.resolve(HEROES); } <span class="hljs-comment"><span class="hljs-comment">// See the "Take it slow" appendix getHeroesSlowly() { return new Promise&lt;Hero[]&gt;(resolve =&gt; setTimeout(()=&gt;resolve(HEROES), 2000) // 2 seconds ); } }</span></span></code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">app / app.component.ts</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Component, OnInit } from <span class="hljs-string"><span class="hljs-string">'@angular/core'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Hero } from <span class="hljs-string"><span class="hljs-string">'./hero'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HeroDetailComponent } from <span class="hljs-string"><span class="hljs-string">'./hero-detail.component'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { HeroService } from <span class="hljs-string"><span class="hljs-string">'./hero.service'</span></span>; @Component({ selector: <span class="hljs-string"><span class="hljs-string">'my-app'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">template</span></span>:` &lt;h1&gt;{{title}}&lt;/h1&gt; &lt;h2&gt;My Heroes&lt;/h2&gt; &lt;ul class=<span class="hljs-string"><span class="hljs-string">"heroes"</span></span>&gt; &lt;li *ngFor=<span class="hljs-string"><span class="hljs-string">"let hero of heroes"</span></span> [class.selected]=<span class="hljs-string"><span class="hljs-string">"hero === selectedHero"</span></span> (click)=<span class="hljs-string"><span class="hljs-string">"onSelect(hero)"</span></span>&gt; &lt;span class=<span class="hljs-string"><span class="hljs-string">"badge"</span></span>&gt;{{hero.id}}&lt;/span&gt; {{hero.name}} &lt;/li&gt; &lt;/ul&gt; &lt;my-hero-detail [hero]=<span class="hljs-string"><span class="hljs-string">"selectedHero"</span></span>&gt;&lt;/my-hero-detail&gt; `, styles:[` .selected { background-color: #CFD8DC !important; color: white; } .heroes { margin: <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span>em <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">list</span></span>-style-type: none; padding: <span class="hljs-number"><span class="hljs-number">0</span></span>; width: <span class="hljs-number"><span class="hljs-number">15</span></span>em; } .heroes li { cursor: pointer; position: relative; left: <span class="hljs-number"><span class="hljs-number">0</span></span>; background-color: #EEE; margin: <span class="hljs-number"><span class="hljs-number">.5</span></span>em; padding: <span class="hljs-number"><span class="hljs-number">.3</span></span>em <span class="hljs-number"><span class="hljs-number">0</span></span>; height: <span class="hljs-number"><span class="hljs-number">1.6</span></span>em; border-radius: <span class="hljs-number"><span class="hljs-number">4</span></span>px; } .heroes li.selected:hover { background-color: #BBD8DC !important; color: white; } .heroes li:hover { color: #<span class="hljs-number"><span class="hljs-number">607</span></span>D8B; background-color: #DDD; left: <span class="hljs-number"><span class="hljs-number">.1</span></span>em; } .heroes .text { position: relative; top: <span class="hljs-number"><span class="hljs-number">-3</span></span>px; } .heroes .badge { display: <span class="hljs-keyword"><span class="hljs-keyword">inline</span></span>-block; font-size: small; color: white; padding: <span class="hljs-number"><span class="hljs-number">0.8</span></span>em <span class="hljs-number"><span class="hljs-number">0.7</span></span>em <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0.7</span></span>em; background-color: #<span class="hljs-number"><span class="hljs-number">607</span></span>D8B; line-height: <span class="hljs-number"><span class="hljs-number">1</span></span>em; position: relative; left: <span class="hljs-number"><span class="hljs-number">-1</span></span>px; top: <span class="hljs-number"><span class="hljs-number">-4</span></span>px; height: <span class="hljs-number"><span class="hljs-number">1.8</span></span>em; margin-right: <span class="hljs-number"><span class="hljs-number">.8</span></span>em; border-radius: <span class="hljs-number"><span class="hljs-number">4</span></span>px <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">4</span></span>px; } `], directives: [HeroDetailComponent], providers: [HeroService] }) <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AppComponent</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OnInit</span></span></span><span class="hljs-class"> {</span></span> title = <span class="hljs-string"><span class="hljs-string">'Tour of Heroes'</span></span>; heroes: Hero[]; selectedHero: Hero; constructor(<span class="hljs-keyword"><span class="hljs-keyword">private</span></span> heroService: HeroService) { } getHeroes() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroService.getHeroes().then(heroes =&gt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.heroes = heroes); } ngOnInit() { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.getHeroes(); } onSelect(hero: Hero) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.selectedHero = hero; } }</code> </pre> </div></div><br><div class="spoiler">  <b class="spoiler_title">app / mock-heroes.ts</b> <div class="spoiler_text"><pre> <code class="cpp hljs"> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> { Hero } from <span class="hljs-string"><span class="hljs-string">'./hero'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> var HEROES: Hero[] = [ {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">11</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Mr. Nice"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">12</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Narco"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">13</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Bombasto"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">14</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Celeritas"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">15</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Magneta"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"RubberMan"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">17</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dynama"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">18</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Dr IQ"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">19</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Magma"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">"name"</span></span>: <span class="hljs-string"><span class="hljs-string">"Tornado"</span></span>} ];</code> </pre> </div></div><br><h3>  The path that we have passed </h3><br><p>  Let's summarize what we have created. </p><br><ul><li>  We have created a service class that can be accessed by several components. </li><li>  We used the <code>ngOnInit</code> lifecycle hook to get our heroes when activating the <code>AppComponent</code> . </li><li>  We identified our <code>HeroService</code> as a provider for <code>AppComponent</code> . </li><li>  We created fictitious data of heroes and imported them into our service. </li><li>  We designed our service so that it returns the promise, and our component, so that it gets our data from the promise. </li></ul><br><p>  <a href="https://angular.io/resources/live-examples/toh-4/ts/plnkr.html">Run the application, part 4</a> </p><br><h4>  The way ahead </h4><br><p>  Our Heroes Tour has become more reusable using common components and services.  We want to create an information panel, add menu links, for routing between views, and also format the data in a template.  As our application develops, we will learn how to design it in order to simplify its expansion and support. </p><br><p>  We will learn about the Angular routing component and navigation between views in the <a href="https://angular.io/docs/ts/latest/tutorial/toh-pt5.html">next chapter</a> . </p><br><h3>  Application: Get it slow </h3><br><p>  We can emulate a slow connection. </p><br><p>  Import the <code>Hero</code> type and add the following <code>getHeroesSlowly</code> method to <code>HeroService</code> </p><br><p>  <strong>hero.service.ts (getHeroesSlowy)</strong> </p><br><pre> <code class="cpp hljs"> getHeroesSlowly() { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Promise&lt;Hero[]&gt;(resolve =&gt; setTimeout(()=&gt;resolve(HEROES), <span class="hljs-number"><span class="hljs-number">2000</span></span>) <span class="hljs-comment"><span class="hljs-comment">// 2 seconds ); }</span></span></code> </pre> <br><p>  Like <code>getHeroes</code> , this method returns a promise.  But this promise makes a delay of 2 seconds until resolved with a dummy list of heroes. </p><br><p>  Back in <code>AppComponent</code> , replace <code>heroService.getHeroes</code> with <code>heroService.getHeroesSlowly</code> and see how the application behaves. </p><br><h3>  Appendix: Shadow Cloning of the Parent Service </h3><br><p>  We said earlier that if we include the parent <code>AppComponent</code> <code>HeroService</code> in <code>HeroDetailComponent</code> , <em>we should not add an array of providers to the</em> <code>HeroDetailComponent</code> <em>metadata</em> . </p><br><p>  Why?  Because with this we will tell Angular to create a new <code>HeroService</code> instance at the <code>HeroDetailComponent</code> level.  The <code>HeroDetailComponent</code> component <code>HeroDetailComponent</code> not need its own copy of the service;  he needs a copy of his <em>parent's</em> service.  Adding an array of <code>providers</code> creates a new service instance that is a clone of the parent instance. </p><br><p>  Think carefully about where and when you need to register a supplier.  Understand the scope of this registration.  Be careful not to create a new instance of the service at the wrong level. </p><br><blockquote>  <strong>Important note.</strong>  With the release of the next release in Angular there have been changes in the ngFor directive. <br>  Instead of, for example, <code>*ngFor="#hero of heroes"</code> you need to use the new syntax <code>*ngFor="let hero of heroes"</code> . </blockquote><br><p>  So far, when using the old syntax, only a warning appears. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/283556/">https://habr.com/ru/post/283556/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../283546/index.html">Benefits of Juniper Stacking</a></li>
<li><a href="../283548/index.html">Doomsday: What are the hidden errors of asynchronous data processing with increasing load</a></li>
<li><a href="../283550/index.html">Distribute pictures by rails after disabling Google‚Äôs svn repositories</a></li>
<li><a href="../283552/index.html">Reduce the size of published npm modules</a></li>
<li><a href="../283554/index.html">Adding Unreal Engine support for dxf format</a></li>
<li><a href="../283560/index.html">Delete your dead code</a></li>
<li><a href="../283570/index.html">Objective-C, static libraries, categories, -ObjC, pain‚Ä¶</a></li>
<li><a href="../283572/index.html">PyNSK # 8 - May meeting of the Novosibirsk Python community</a></li>
<li><a href="../283576/index.html">IOS TEAM Developer Portfolio</a></li>
<li><a href="../283580/index.html">The digest of interesting materials for the mobile # 153 developer (May 10-15)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>