<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Easy integration of the site and 1C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I came across several different articles about the integration of the site and 1C. In the comments often began disputes about different appr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Easy integration of the site and 1C</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/aba/7f8/3de/aba7f83deda5940abf43aaa6d8e6b68f.jpg" alt="image" align="right"><br>  Recently, I came across several different articles about the integration of the site and 1C.  In the comments often began disputes about different approaches, and I decided to share the way that once happened to realize me.  Of course, the method described below does not pretend to universality and uniqueness, but I think it will be useful to those who are just going to write their own version. <br><a name="habracut"></a><br><br><h2>  Choppers, rakes and shovels </h2><br>  Not a very big store (nomenclature of about 5000 products). <br>  Ordinary, file 1C 8 UT.  The configuration is fully supported and cannot be removed from support. <br>  The base lies on one of the desktop machines, which in turn is used to work as one of the employees. <br>  It is enough to upload a minimum of information: name, description, photo, several types of prices. <br>  Breaking an already established ecosystem was also extremely undesirable. <br>  Under the site is allocated an ordinary virtual hosting, which means that you need to take into account the limited resources of such. <br>  Unloading can occur not often, it is enough 1 time in 3 hours. <br>  Subsequently, it became necessary to add unloading of the price list in xls. <br>  Modest budget for the project. <br><br>  A machine that performs the role of a ‚Äúserver‚Äù was already not fast, and the presence of permanent connections to the 1C database only aggravated the situation.  But it suited the customer, which means there were no heaps of money for the purchase of a separate server and the re-equipment of the rest of the park. <br>  Due to budget constraints, the variant with Bitrix and its type integration disappeared immediately.  Yes, and the interest was more sporty, to implement everything yourself.  It was decided to use the framework previously used for the product catalog.  The framework was made on CodeIgniter, so adding a small module of labor was not.  Solved. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  Let's start </h2><br>  The first thing was the question of the frequency of information upload, and the hands reached for the routine tasks ... but stop.  First, the configuration cannot be removed from support, which means that we cannot edit the configuration itself, and secondly, all copies of 1C are launched only when necessary, which means whether 1C will be launched at the right time or not is unknown .  Yes, it would be possible to oblige the customer, when starting the "server", always run 1C and always keep it running, but this will create unnecessary inconvenience to the customer, which means the solution is not the most convenient.  Alas, routine tasks today will not be able to help us.  Obviously, we need the help of a third-party application to start the upload process at a certain moment.  Here we recall the fact that 1C allows you to run yourself from the command line, moreover, we can immediately perform the external processing we need and, if necessary, there is even the possibility to pass some parameter to it. <br><br>  Here are the main keys that will be used: <br><pre><code class="hljs pgsql">"  1" enterprise /F"  " /N"" /P"" /<span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>" " /C"" /DisableStartupMessages</code> </pre> <br><br>  Now it remains to configure the launch of this design on a schedule.  Windows Scheduler?  Customize, check ... works! <br>  But there is one serious flaw.  When the scheduler launches a 1C schedule, then, of course, it opens above all applications, and if someone is working on a computer at that time, then, firstly, it will distract him, and secondly, he may close it new window.  Not order ... What to do?  We start to dig in the direction of launch under a different account.  Thanks to Google, we quickly find the possibility of batch launching under another user.  Create a new Windows user, enable batch launch in security policies, reconfigure the scheduler, check ... voila!  Everything worked, but we did not see any annoying windows!  Well, it means that this option suits us ... now we turn to the actual unloading of the data itself. <br><br><h2>  Unloading </h2><br>  First of all, of course, I began to look towards CommerceML, but after reading the documentation, it became clear that for our rather basic unloading it was too long to fence the whole garden, and the budget was not rubber.  So, we will look for an alternative way.  Why not just upload text information in xml, and upload images to a separate directory?  Resolved, so doing.  We get a fairly simple xml-file structure: inside, first go records for groups, and then nomenclature units themselves. <br><br>  This is how the groups look: <br><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Code</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Code</span></span></span><span class="hljs-tag">&gt;</span></span> /*-  1*/ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Name</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Name</span></span></span><span class="hljs-tag">&gt;</span></span> /* ,  */ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ParentCode</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ParentCode</span></span></span><span class="hljs-tag">&gt;</span></span> /*   ,    */ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">group</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  And so the goods: <br><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Code</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Code</span></span></span><span class="hljs-tag">&gt;</span></span> /* -  1 */ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ParentCode</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ParentCode</span></span></span><span class="hljs-tag">&gt;</span></span> /*  ,     */ <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Name</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Descr</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Descr</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Article</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Article</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypePrice</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">TypePrice</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Price</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Price</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">urrency</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">urrency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Remains</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Remains</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit</span></span></span><span class="hljs-tag">&gt;</span></span>//<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Unit</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Img</span></span></span><span class="hljs-tag">&gt;</span></span>img_dae5eacd-7d88-11de-8856-0024213f1c89.jpg<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">Img</span></span></span><span class="hljs-tag">&gt;</span></span> /*           1 */ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">item</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Not a tricky request, we receive information on all product groups and products, then we form an xml-ku.  We also make a separate sample and pull out the information for the price list, and then store the received information in xls. <br>  After that, go to upload images.  Due to the limitations of the hosting site, it seemed not the most rational to process images on the hosting side, so it was decided to do image processing + creating previews at the stage of uploading.  1C is of course a combine, but I did not find an opportunity to process a pack of photos.  But do we have ImageMagick?  An excellent, cross-platform set of everything we need for image processing ... download, unpack ... it remains only to write bat'nik, which will perform the necessary manipulations: <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> c:\ <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> thePATH=      <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /R "<span class="hljs-variable"><span class="hljs-variable">%thePATH%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (*.jpg) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ImageMagick-<span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>\<span class="hljs-built_in"><span class="hljs-built_in">convert</span></span>.exe <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> -resize x^&gt; -quality <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> /R "<span class="hljs-variable"><span class="hljs-variable">%thePATH%</span></span>" <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (*.jpg) <span class="hljs-keyword"><span class="hljs-keyword">DO</span></span> ImageMagick-<span class="hljs-number"><span class="hljs-number">6</span></span>.<span class="hljs-number"><span class="hljs-number">7</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-<span class="hljs-number"><span class="hljs-number">10</span></span>\<span class="hljs-built_in"><span class="hljs-built_in">convert</span></span>.exe <span class="hljs-variable"><span class="hljs-variable">%%a</span></span> -resize x^&gt; -gravity center -extent x -quality <span class="hljs-number"><span class="hljs-number">70</span></span> <span class="hljs-variable"><span class="hljs-variable">%thePATH%</span></span>mini\<span class="hljs-variable"><span class="hljs-variable">%%~</span></span>nxa</code> </pre><br><br>  We start this bat'nik from our processing and get the result. <br><br>  All information is unloaded, it remains to pack everything neatly into zip and upload via FTP to the server, which 1C does well with standard tools. <br><br>  At first glance, everything, but ... Are we going to pull out the entire nomenclature every time, with all the pictures, and load this whole machine into the server?  No, this picture is not for the faint of heart ... And what to do?  Make flags and mark which item has changed?  No, we can not edit the configuration ... But there are plans for the exchange?  Who forbade us to use them?  No one!  Create an exchange plan, customize.  Next, we modify our upload, now during the upload we create a new message in terms of exchange, upload only the units that have been changed since the last message ... Excellent! <br><br><h2>  Server part </h2><br>  It's still more transparent here.  We hang up the launch of the script on the crown.  In the script we look in the right directory, we search for the required archive by mask.  If there is one, then unpack, parse xml, write information to the database.  We have pictures inside with another archive, we also unpack it, right on top of the directory with the existing pictures.  If such a picture already exists, rewrite it with a new one.  Copy xls-file with the replacement in the desired directory.  We write to the database information about what made such an update, then, with such a number, and then clean the temporary files.  Everything. <br><br><h2>  Straw from failures </h2><br>  If in the process of uploading information, image processing, archiving, uploading to a remote FTP, errors occur, we may lose some updates, and as a result, the information on the site and in the 1C base will be out of sync.  Below I described the main sharp corners for which it was necessary to lay straws: <br><br>  <b>1. So, what will happen if, for example, at the moment of downloading via FTP, the connection is broken?</b> <br>  If we have already recorded a message in the exchange plan, it turns out that 1C believes that it has successfully unloaded these changes and is now collecting new ones, but they did not get to the site!  That's right, so we end up writing to the exchange plan only after successfully completing all the upload steps, including uploading files via FTP!  And if in the process of uploading an exception occurs, then we interrupt the recording of the message in terms of the exchange and write the error in the error-log. <br><br>  <b>2. And what if our script on the server starts processing the not yet uploaded archive?</b> <br>  We first give it one name (for example, export.zip_), but only upon completion we rename it and give it a name that will search for the script on the server. <br><br>  <b>3. And what if the server fails and the script does not have time to process our archive, 1C will wipe it with a new one?</b> <br>  No, for this, each archive contains in the title a message number from the exchange plan (for example, export_1.zip).  The script on the server in turn, when it detects several archives, processes them in ascending order of numbers. <br><br>  <b>4. And the logs are not overcrowded?</b> <br>  Because  when uploading, information about the results of each action is written to the log in detail, then the logs grow quite quickly, so we don‚Äôt forget to check their size with each upload and, if necessary, delete the old ones. <br><br>  <b>5. And what if 1C does not have time to perform the unloading, and at this time the process starts for a new unloading?</b> <br>  In the settings of the scheduler, set up so that the new task is not executed if the previous one is not completed. <br><br><h2>  PS </h2><br>  So, in just such a simple way, in a fairly short period of time, the unloading of the nomenclature / prices / balances to the site was implemented.  Of course, this option has a number of drawbacks and does not claim the only true laurels, but at the same time we managed to fully fit into the restrictions set by the customer‚Äôs ecosystem.  All this design works on weak machines, does not require a constantly running copy of 1C, works on the most ordinary virtual hosting, does not distract employees at all, and most importantly, allows 1C to serve unhindered.  Underlay straw turned out to be enough, and for almost a year, fortunately, not one of our interventions in the operation of the system was required. </div><p>Source: <a href="https://habr.com/ru/post/139657/">https://habr.com/ru/post/139657/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../139651/index.html">Demo that no one has ever seen</a></li>
<li><a href="../139652/index.html">55 channels on one carrier frequency: breakthrough of the Swedish-Italian group of scientists</a></li>
<li><a href="../139653/index.html">Startup Space Monkey offers 1 Terabyte in the cloud for $ 10 per month</a></li>
<li><a href="../139655/index.html">Python and C ++ integration</a></li>
<li><a href="../139656/index.html">Variation on the subject: weather forecast by phone</a></li>
<li><a href="../139660/index.html">Based on the realities of communication in Russia and the memory requirements, which iPad ‚Äú3‚Äù would you buy?</a></li>
<li><a href="../139663/index.html">How I invented the time machine - Photo Time Machine</a></li>
<li><a href="../139665/index.html">Reducing the lag of touch screens from 100 ms to 1 ms</a></li>
<li><a href="../139666/index.html">Hiding bash scripts</a></li>
<li><a href="../139667/index.html">The right approach to security issues on github</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>