<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Yandex Mail. Preventing hakostrofy</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In November last year, Yandex held a competition on the topic of searching for vulnerabilities in its service. I was lucky to find a couple of holes t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Yandex Mail. Preventing hakostrofy</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/7f7/e32/e08/7f7e32e088df1438f21ee428790dee9c.png" align="left">  In November last year, Yandex held a <a href="http://habrahabr.ru/company/yandex/blog/131199/">competition</a> on the topic of searching for vulnerabilities in its service.  I was lucky to find a couple of holes there and get second place for it.  Since I haven‚Äôt published any details in these six months (except at the <a href="https://defcon-russia.ru/">Defcon-Russia</a> meeting, but this was orally for a narrow circle of visitors), I decided to fill this gap now.  So there will be a story about one of the holes, which was discovered in the framework of the competition and promptly closed by Yandex.  I believe that the competition fully justified itself and allowed to prevent the terrible consequences, so the idea is clearly successful, some advantages.  Actually, the story will be about the banal absence of verification of authorization in one of the scripts, which could lead to a partial compromise of more than a billion letters only on one node ... <br><a name="habracut"></a><br><h4>  Start </h4><br>  When the competition was announced, I, as the head of the audit department at Digital Security, did not want to participate in it (I‚Äôm afraid of competitions in general, and the heads have other important things - an order to give someone or report to demand ... 8)), but , curiosity and thirst for profit dictated their terms.  I decided to look for something interesting and fun, so I decided not to waste time searching for vulnerabilities such as XSS and CSRF.  First, they are found automatically when examining any script (in fact, a pair of XSS was found right away).  Secondly - uninteresting (although dangerous, as shown by <a href="https://habrahabr.ru/users/kyprizel/" class="user_link">kyprizel</a> in the same <a href="http://www.youtube.com/watch%3Fv%3DE0anE1R_OJI">competition</a> ).  In addition, since the competition area (scope) was gigantic, I decided to confine myself to the most interesting service for me - mail.  At the same time, I decided not to spend more than one working day in order not to be distracted from work.  This allowed me not to worry that I would not find anything, because there is no time (self-justification, aha!), And to look for something really carbon-fueled.  In any case, for the beginning it was necessary to simply study the structure and logic of the web interface.  This was done <a href="http://portswigger.net/burp/">tritely</a> - with the help of <a href="http://portswigger.net/burp/">BurpSuite</a> and the developer interface built into Google Chrome. <br><br><img src="https://habrastorage.org/storage2/735/676/632/735676632682b1e9fb8cf53b465f755e.png"><br>  Anton Karpov aka <a href="https://habrahabr.ru/users/tokza/" class="user_link">toxa</a> ( <a href="https://habrahabr.ru/users/tokza/" class="user_link">tokza</a> ) tells how the found bugs will be assessed. <br><br><h4>  FrontEnd </h4>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The main script for delivering mail content is some handlers.jsx.  It is noteworthy that the developers themselves willingly share information on the mail architecture, so we know that in this case we are dealing with <a href="http://download.yandex.ru/company/experience/subbotnik/chel_androsov.pdf">server-side JavaScript</a> .  However, I didn‚Äôt need all these subtleties, since the very first vulnerability found there turned out to be so classic that the implementation details are not so significant.  But first, the general details: <br><br><ul><li>  A request to handlers.jsx can be either POST or GET </li><li>  The request indicates the desired module and the corresponding parameters </li><li>  XML is received in response to a request. </li></ul><br><br>  Some modules and their meaning: <br><ul><li>  ‚ÄúFolders‚Äù - the contents of folders </li><li>  ‚ÄúMessage-body‚Äù - the body of the letter </li><li>  ‚ÄúNearest-messages‚Äù - neighboring letters </li></ul><br><br>  To make it clearer, I will provide a screenshot from the same presentation by Alexei Androsov. <br><br><img src="https://habrastorage.org/storage2/719/a84/2f0/719a842f081e4b4d31e9a2017489ee1d.png"><br><br>  That is, it is clear that all the content is collected into a common interface using AJAX requests and rendered into a ‚Äúhuman‚Äù form thanks to XSL templates. <br>  Well, an example of a request from the same prezy: <br><br>  /handlers.jsx?_handlers.0=message&amp;ids=1234567890&amp;_handlers.1=message&amp;ids=1234567891 <br><br>  The answer is in the form of XML: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äùmessage‚Äù</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">‚Äù_h</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">message&amp;ids</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">1234567890‚Äù</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_h=message&amp;ids=1234567891"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><br>  It seems simple.  The _handlers parameter will determine the data we need (handler module), and ids is the identifier.  That is, this example of the request loads letters with identifiers 1234567890 and 1234567891. Naturally, the first thing I tried was to replace ids and substitute there, for example, 123431337, which, ideally, would have returned me an email with this identifier, even not mine. <br><br>  I did not succeed.  By the way, the same action was taken by my colleague and friend - <a href="https://habrahabr.ru/users/chipik/" class="user_link">chipik</a> .  Last year, we‚Äôve already broken Google for a couple (and we wrote about <a href="http://habrahabr.ru/company/dsec/blog/140882/">how it was</a> ).  But he also failed.  But here's a funny thing: there is such a thing - ‚Äúcode cover‚Äù.  That is, by taking some kind of verification action, we checked part of the code.  It is logical to assume that if you try to replace the module name, it is still the same code that is responsible for checking access authorization by ids identifier.  But a little luck helped to understand that it is not. <br><br><h4>  Baga </h4><br><br>  After some time, I again decided to replace ids, but for another module - ‚Äú <b>nearest-messages</b> ‚Äù, and about a miracle ... At first I didn‚Äôt even understand how it happened, but later I became convinced that this is the only module that does not check, Does ids belong to the current user?  This means that with the help of this module I could load the ‚Äúneighboring letters‚Äù of other server users!  Let's analyze the legitimate request: <br><br> <code>http:// mail.yandex.ru/neo2/handlers/handlers.jsx?_handlers=message-nearest&amp;ids=2020000002590081157</code> <br> <br>  2020000002590081157 are the ids of my letter, quite specific and definite.  The Yandex server returns to this request: <br><br>  (... - cut to reduce volume) <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"message-nearest"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">gid</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">key</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"_handler=message-nearest&amp;ids=2020000002590081157"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message-nearest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000002590182740"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thread</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000001499988536"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">folder</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000650059912118"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">date</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timestamp</span></span></span><span class="hljs-tag">&gt;</span></span>1320143331000<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timestamp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iso</span></span></span><span class="hljs-tag">&gt;</span></span>2011-11-01T14:28:51<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iso</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">short</span></span></span><span class="hljs-tag">&gt;</span></span>01.11.11<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">short</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">full</span></span></span><span class="hljs-tag">&gt;</span></span>1 . 2011  14:28<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">full</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">date</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>2 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">last_status</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">fwd</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Fwd:"</span></span></span><span class="hljs-tag">&gt;</span></span>TEST<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span>,     2<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">to</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>ne_eik01110d111@yandex.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> . . . <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">to</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">from</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>SSS AAA<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> . . . <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">from</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000002590081157"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thread</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000001499929723"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">folder</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000650059912118"</span></span></span><span class="hljs-tag">/&gt;</span></span> . . . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span>1,8 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">size</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">last_status</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">re</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Re[2]:"</span></span></span><span class="hljs-tag">&gt;</span></span>TEST<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span> ,  ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Ä¶ <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000002590076913"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">thread</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000001499929723"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">folder</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2020000650059912118"</span></span></span><span class="hljs-tag">/&gt;</span></span> . . . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">full</span></span></span><span class="hljs-tag">&gt;</span></span>1 . 2011  14:01<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">full</span></span></span><span class="hljs-tag">&gt;</span></span> . . . <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag">&gt;</span></span>TEST<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">subject</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span> 1<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">from</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>Alexey Sintsov<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3cab8cda1a132a2d17803cc47cd55d91"</span></span></span><span class="hljs-tag">&gt;</span></span>ddookie1@inbox.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">from</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reply-to</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span>ddookie1@inbox.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"3cab8cda1a132a2d17803cc47cd55d91"</span></span></span><span class="hljs-tag">&gt;</span></span>ddookie1@inbox.ru<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">email</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">reply-to</span></span></span><span class="hljs-tag">&gt;</span></span> . . . <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">list</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timer_db</span></span></span><span class="hljs-tag">&gt;</span></span>266<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timer_db</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timer_logic</span></span></span><span class="hljs-tag">&gt;</span></span>175197<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timer_logic</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">message-nearest</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handler</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">login</span></span></span><span class="hljs-tag">&gt;</span></span>ne_eik01110d111<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">login</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">actual-version</span></span></span><span class="hljs-tag">&gt;</span></span>5.11.55<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">actual-version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timestamp</span></span></span><span class="hljs-tag">&gt;</span></span>1335882564270<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">timestamp</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">handlers</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The server returns XML with three objects.  Each object is information about the letter: <br><br><ul><li>  When </li><li>  From whom </li><li>  To whom </li><li>  Headline </li><li>  The first line of the body of the letter </li></ul><br><br>  And the message, the ids of which is indicated in the request, is the second object.  The first and third objects are adjacent messages in the same folder as the requested object.  Changing ids, for example, by one, we receive <b>three</b> alien messages.  Rather, the date of receipt, headers, recipients, ids identifier and the first line of the letter.  But actually the first line is not just the first line!  Experience has shown that there may be <b>several</b> lines, and the main thing here is the volume and number of line feeds.  In my experiments there were results and 5 lines each!  That is, the volume is large enough to talk about the real threat. <br><br>  Sent in body: <br><br> <code> ‚Äì  1 <br> <br> ,   ‚Äì  3 <br> ----- ‚Äì  4 <br>  ‚Äì  5 <br>  ‚Äì  6 <br> <br>  ‚Äì 8 <br>  ! ‚Äì 9 <br> <br></code> <br><br>  Intercepted using handlers.jsx: <br><br><pre> <code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span> ‚Äì  1 ,   ‚Äì  3 ----- ‚Äì  4  ‚Äì  5  ‚Äì  6  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">firstline</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  As you can see, this amount of data is enough to violate confidentiality and even to steal acca from services that send registration data to e-mail (for example, Facebook). <br><br><h4>  Little little </h4><br><br>  In general, everything is clear - the simplest bug, but there are a couple of questions: <br><br><ul><li>  How to get access to the right box? </li><li>  How to get the right letter in the box? </li></ul><br><br>  These are the questions that any adequate cracker who is interested in more targeted and targeted attacks would ask.  After all, we are dealing with ids, and to know the ids of the enemy letter is not always given to us (almost never).  Thus, the attack becomes a little more dangerous and interesting from the point of view of technology (almost everyone can replace ids, but to calculate it ...) <br><br>  And there are some other details that have also been clarified by experience.  It turns out that ids is not just an identifier of a letter or folder, it is actually an object. <br><br>  The first 4 digits are the node number (I don‚Äôt know how it is properly called, so I‚Äôll call it that) on which the box is hosted.  If you pay attention, you will notice that all your letters and folders have this number permanently.  Therefore, using the identified vulnerability, you can read letters only from the node where your mailbox is located.  There are several billion letters on one node!  There are many nodes, and two users who register at the same time can go to different nodes. <br><br>  In the middle, the type identifier is a folder or message (for message 00, for a folder like 65), and the last digits is the identifier for the message on the node.  That's just the last change and you can.  That is, in my example, the current message was with the number 259008115 <b>7</b> .  Now you roughly represent the volume of messages on a single node. <br><br>  The second funny fact: the message identifier is an absolute, incremental value.  That is, the next letter processed (received) by the current node will be 259008115 <b>8</b> .  Even if this letter is not sent to me.  Now you can solve both problems.  That is, perform a targeted attack, and not stupidly dump a billion letters 8) <br><br><h4>  Attack </h4><br><br>  It is necessary to create a mailbox on the same node as the victim.  The task is difficult to solve if the victim's box is registered for a long time.  You can buy or hijack boxes from different nodes and register the boxes on those nodes where possible.  But if the victim's mailbox was created recently, then the attack has an absolute probability of success.  For example, we will attack the <b>target-mail1</b> @ yandex.ru box.  We have created it recently.  Therefore, the success of the attack is high.  So, create a bunch of mailboxes: <b>check-mail1</b> , <b>check-mail2</b> , <b>check-mail3</b> , etc.  The main thing is that all created mailboxes should be on different nodes.  Then we send the letter to target-mail1 and in a copy we put all the boxes we created. <br><br><img src="https://habrastorage.org/storage2/f28/8f7/468/f288f7468bb17b997483d8a6a2aaf184.png"><br><br>  What is humor?  When we see ids letters in our ‚Äúcheck-mail‚Äù accounts, we will try to increment and decrement this value by 5 units.  And on the node where check-mailN coincided with target-mail1, we will see our letter.  See an example: <br><br><img src="https://habrastorage.org/storage2/504/979/ed6/504979ed69380a730ac6537aa246d839.png"><br><br>  So we can access the target box.  And what about the target letter?  But if you remember, the module through which we exploit the vulnerability shows us neighboring letters in the same folder of the same box (remember that the script shows <b>three</b> messages: what is indicated in ids, and two adjacent ones from the same box).  If the selected letter is the last one, then only two letters will be shown to us: the current one and the previous one, including its ids.  This means that we can choose this ids for the next query: then we will see it as the second object in the XML response, and the third will be an even older letter.  Then we take it already ids and so ‚Äúslide‚Äù down until we read all the letters stored in the folder and find the desired one. <br><br><h4>  findings </h4><br><br>  Code coverage in penetration tests and fuzzing is sometimes a key parameter.  Here we saw a great example, when everyone tried to change the ids for the message-body module, saw that the request did not roll, and therefore did not begin to do similar tests with other, less obvious modules. <br><br>  Although the vulnerability is simple, the attack itself is quite complex and requires analysis of the generation of ids and node architecture.  Exploiting vulnerability is more interesting than just looking for a ‚Äúhole‚Äù.  It was an interesting challenge for hijacking a specific letter from a specific mailbox.  It is difficult for old boxes, but still possible, and for newly created boxes, the probability of success is 100%.  For old ones, it depends on the ability to start a mailbox on the same node.  Statistics on fresh regams: every third or fourth created box falls on the same node.  The period of registration at the node since its launch is about six months (that is, a ‚Äúnew‚Äù / ‚Äúnewly created‚Äù box, this is a box created no more than half a year ago).  In theory, then, after six months, to register on this node is already, as I guess, you can not-overloaded. <br><br>  Thanks: <br><br>  Anton Karpov ( <a href="https://habrahabr.ru/users/tokza/" class="user_link">tokza</a> ) and Yandex company - for an interesting challenge and competition, and for second place.  After all, vulnerabilities are everywhere, and such a contest has helped to close many of them! <br>  Dmitry Chastukhin ( <a href="https://habrahabr.ru/users/chipik/" class="user_link">chipik</a> ) - for not being very upset when he found out about a bug that he ‚Äúalready checked‚Äù ... <br>  <a href="https://habrahabr.ru/users/d0znpp/" class="user_link">d0znpp</a> , <a href="https://habrahabr.ru/users/kyprizel/" class="user_link">kyprizel</a> , <a href="https://habrahabr.ru/users/ptsecurity/" class="user_link">ptsecurity</a> - for participating in the competition and for finding terrible holes, which did not allow me to relax the whole month (I hate contests). <br><br>  Finally proof video ... <br><br><iframe width="560" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/WWU7MXYT5D8%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253,15700255,15700259&amp;usg=ALkJrhjiWwfyj9qLJIn1MvKA7G08xlR_tA" frameborder="0" allowfullscreen=""></iframe><br><br>  Bye everyone! <br><br>  PS: Since I am not an employee of Yandex, the details of the architecture, algorithms and names may be unreliable.  All conclusions about the Yandex.Mail device are based on the author‚Äôs inner feelings and intuitive vision. </div><p>Source: <a href="https://habr.com/ru/post/143921/">https://habr.com/ru/post/143921/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143913/index.html">Where and how do e-mails go? Google's online explanation</a></li>
<li><a href="../143915/index.html">Foursquare checks are now displayed on Facebook Timeline cards</a></li>
<li><a href="../143917/index.html">The long-awaited Diablo III has been released</a></li>
<li><a href="../143919/index.html">Sviaz-Expocomm 2012</a></li>
<li><a href="../143920/index.html">Once again about the documentation</a></li>
<li><a href="../143923/index.html">Landing page that works</a></li>
<li><a href="../143925/index.html">Why do we need delegates in C #?</a></li>
<li><a href="../143926/index.html">M13 synthetic virus converts kinetic energy into electricity</a></li>
<li><a href="../143927/index.html">How to open your online store Ecwid on Facebook and Google Sites</a></li>
<li><a href="../143928/index.html">Grape multitouch</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>