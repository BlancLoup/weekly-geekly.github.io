<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asterisk. Start</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Writing this article led me to a virtually complete lack of how-to on setting up Asterisk, with examples clear to the beginner. On the network, you ca...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asterisk. Start</h1><div class="post__text post__text-html js-mediator-article">  Writing this article led me to a virtually complete lack of how-to on setting up Asterisk, with examples clear to the beginner.  On the network, you can find a lot of information on setting up IVR, on setting up authorization of SIP users via LDAP, manuals on creating HA clusters with Asterisks inside, etc., but there is not a single article on how to start it from scratch, and even from examples.  Almost everywhere it is proposed to immediately use all the possibilities offered by Asterisk, and if you remove some of the functionality offered in the manual, in most cases this will result in an inoperable design.  This article is the result of <s>walking a rake</s> ... reading manuals.  If you are in the same situation as I was a couple of years ago - welcome under cat. <br><a name="habracut"></a><br>  And so, the situation: you just found out about Asterisk and its capabilities, and you wanted to use it at home, or your management wanted IP telephony to the office. <br><br>  The first thing we need is a server with an installed OS.  For a number of reasons, I chose CentOS 6 for my servers. All the examples will be linked to this OS, since it is on it that the most stable servers are obtained.  However, I am in no way trying to limit you to a choice.  Aster will normally start under Debian, Arch, and even on FreeBSD.  I note: it is desirable not to use hypervisors at the initial stage, since you can get a ‚Äúmetallic‚Äù voice, or its complete absence.  About timers and interruptions will tell in the next article, as their description and configuration is beyond the scope of this article.  In the event that you do not have a free server and you cannot do without a virtual machine, be sure to install the x86 guest. <br><br>  After you have installed the OS on the server, you can proceed with the installation of Asterisk.  Add the Didgium repositories: <br><pre>  rpm -Uvh http://packages.asterisk.org/centos/6/current/i386/RPMS/asterisknow-version-3.0.1-2_centos6.noarch.rpm
 yum update </pre><br>  Install dnsmasq: <br><pre>  yum install dnsmasq </pre><br>  Install Asterisk: <br><pre>  yum install asterisk asterisk-configs --enablerepo = asterisk-12 </pre><br>  Important note: the number at the end of the line indicates the major version of Asterisk.  The example will install the most recent version of the 12th branch, available in the repositories. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After installation, restart the server and go to the Asterisk shell: <br><pre>  asterisk -rv </pre><br>  Pay attention to the keys that run the shell.  The number of keys "v" affects the amount of information displayed when you call, their number varies from 1 to 14. <br><br>  If the installation was successful and Asterisk was launched, you will see this invitation: <br><pre>  asterisk * CLI&gt; </pre><br>  Congratulations, Asterisk is established and ready to go.  But for now, we don‚Äôt need a shell, so we‚Äôre writing exit. <br><br>  In order to save your time and make the material understandable, we will look at the theory with a concrete example, and also analyze the main terms that you will have to operate on when setting up, when communicating with the support of the operator and your colleagues.  For example, we will get two internal users with numbers 100 and 101, and two telephony operators.  One of the operators will provide us with city numbers through a trunk with registration, the other will provide access to long-distance lines using a trunk without registration. <br><br>  The first thing you need to do is create peers in the /etc/asterisk/sip.conf file.  Open it: <br><pre>  nano /etc/asterisk/sip.conf </pre><br>  And immediately go to the end of the file.  Insert the following text: <br><pre>  [internal] (!)
 type = friend
 insecure = invite, port
 context = office
 fromdomain = &lt;domain name or IP&gt;
 host = dynamic
 disallow = all
 allow = alaw
 qualify = yes
 canreinvite = no
 nat = no

 [100] (internal)
 secret = XXX
 [101] (internal)
 secret = XXX </pre><br>  We have got two internal peers with numbers 100 and 101. Let us examine these settings, since their understanding is the key to the successful implementation of Asterisk. <br><br>  <b>[internal] (!)</b> <br><br>  [internal] is the name of the template, and (!) is the template pointer. <br>  Why do we immediately start using templates?  Because they reduce setup time and reduce the amount of text with the configuration file, and for understanding they are very simple. <br><br>  <b>type = friend</b> <br><br>  Available options: ‚Äúpeer‚Äù, ‚Äúuser‚Äù and ‚Äúfriend‚Äù.  There is often an erroneous opinion about how they differ.  Many people think that the ‚Äúuser‚Äù parameter allows only outgoing, ‚Äúpeer‚Äù - only incoming calls, and ‚Äúfriend‚Äù allows calls to both sides.  This is not true.  The use of the ‚Äúpeer‚Äù key disables the validation of the username and password when making a call.  When using the ‚Äúpeer‚Äù parameter, Asterisk only matches the IP address and port number of the call source, when using ‚Äúuser‚Äù, the username field is checked, and the source address is not checked.  The "friend" parameter forces the username field and source IP address to be verified. <br><br>  <b>insecure = invite, port</b> <br>  invite - authentication is disabled for an incoming call. <br>  port - source port checking is disabled. <br><br>  At the initial setting list both keys. <br><br>  <b>context = office</b> <br><br>  The context in which outgoing calls from this device will be processed.  Details below. <br><br>  <b>fromdomain = &lt;domain name or IP&gt;</b> <br><br>  SIP domain name.  For the initial setup, specify the IP address of the server with Asterisk. <br><br>  <b>host = dynamic</b> <br><br>  IP address of the peer.  In the case of using login and password authentication, set dynamic.  A specific IP is indicated only if the peer settings are used for a trunk without registration. <br><br>  <b>disallow = all</b> <b><br></b>  <b>allow = alaw</b> <br><br>  Specify the allowed codecs. <br><br>  In our example, the first line prohibits the use of all codecs, and the second allows g711-a.  The codec settings are individual for each case, however, most Russian and Ukrainian providers use g711a and g729.  The latter is propietary, and Asterisk is supported only in Passthrough mode (that is, transcoding is not possible). <br><br>  <b>qualify = yes</b> <br><br>  This line causes Asterisk to poll the device or softphone with OPTIONS packets.  Required for monitoring and troubleshooting. <br><br>  <b>canreinvite = no</b> <br><br>  Forbids to send media directly between devices.  I recommend to put "no", to simplify the settings. <br><br>  <b>nat = no</b> <br><br>  We say Asterisku that the feast is not for naty.  The description of keys and options for their use, if the server is behind it, is beyond the scope of the article.  About the crawl options in the next article. <br><br>  <b>[100] (internal)</b> <b><br></b>  <b>secret = XXX</b> <b><br></b>  <b>[101] (internal)</b> <b><br></b>  <b>secret = XXX</b> <br><br>  Here we set the name of the feast and take the settings from the template.  The only unique parameters in our example are the peer name and password. <br>  At this point, we finished setting up internal peers, moving on to setting up the interface with the operators.  Add 2 entries to the end of sip.conf: <br><pre>  [operator1]
 fromdomain = &lt;domain name or IP&gt;
 host = 1.2.3.4
 insecure = invite, port
 port = 5060
 qualify = yes
 type = friend
 username = YourLogin
 secret = YourPass
 disallow = all
 allow = alaw
 context = operator1 </pre><br>  I will not paint the values ‚Äã‚Äãof each line, because  all settings are identical to those of the internal peers, with the exception of the host field.  In the event that Asterisk acts as a client (and for the server of the operator our asterisk is a client), we need to specify the address of the server of the operator or its dns-name. <br><br>  Add the second operator: <br><pre>  [operator2]
 fromdomain = &lt;domain name or IP&gt;
 host = 5.6.7.8
 insecure = invite, port
 port = 5060
 qualify = yes
 type = friend
 disallow = all
 allow = alaw. 
 context = operator2 </pre><br>  There are no differences either, except for the absence of the username and secret lines, since, I remind you, the second operator does not use the registration. <br><br>  It remains to configure the registration on the server operator number 1.  To do this, in the sip.conf file, before the section describing the operator settings, insert the following line: <br><pre>  register =&gt; udp: // YourLogin: YourPass: YourLogin@1.2.3.4/YourLogin </pre><br>  The syntax for an unprepared person looks complicated, so don‚Äôt bother and just call the provider's support and ask them how to register on the server with Asterisk, or ask them to send the settings.  As a rule, the majority of operators without any problems send a configuration example for their soft switches. <br><br>  Surely you have edited the configuration files under a user with limited rights.  If this is so, then Asterisk will not be able to access the configuration file, so we write: <br><pre>  chown asterisk: asterisk /etc/asterisk/sip.conf </pre><br>  This completes the setting of peers, it is enough to work in the minimum configuration, save and close the file and return to the Asterisk shell with the command: <br><pre>  asterisk -rv </pre><br>  In the shell of Asterisk write the command: <br><pre>  sip reload </pre><br>  Now you can register users with logins 100 and 101 on your Asterisk. Check the registration status with the following command: <br><pre>  sip show peers </pre><br>  If you configured everything correctly, you will see something like this: <br><pre> asterisk * CLI&gt; sip show Formersport / ACN Port Status Description 100/100 10.0.0.52 D Yes Yes 59080 OK (1 ms) 101/101 10.0.0.57 D Yes Yes 49973 OK (1 ms) operator1 1.2 .3.4 No No 5060 OK (22 ms) operator2 5.6.7.8 No No 5060 OK (22 ms) </pre><br>  If you see this, then congratulations, your devices or softphones have successfully registered and Asterisk saw the servers of the operators. <br><br>  Registration status is checked by the command: <br><pre>  sip show registry </pre><br>  If registration was successful, then you should see the following conclusion: <br><pre>  asterisk * CLI&gt; sip show registry
 Host dnsmgr Username Refresh State Reg.Time
 1.2.3.4:5060 N YourLogin 120 Registered
 1 SIP registrations. </pre><br>  This completes the setting of peers, let's move on to setting up the dialplan.  Dialplan is the heart of Asterisk, with the help of it all calls are processed.  Asterisk understands several languages, but in our example we will use the standard one that appeared in the very first Asterisk releases.  The configuration file is stored in the /etc/asterisk/extensions.conf file. <br><br>  Open it with the command: <br><pre>  nano /etc/asterisk/extensions.conf </pre><br>  Standard configuration files store many default rules.  We do not need them, so we will clear the contents and write the following: <pre>  [general]
 static = yes
 writeprotect = no

 [globals] </pre><br>  These are the parameters necessary for the normal reading of the dialplan, so they should not be changed. <br><br>  Let's start with the simple.  We need to call from number 100, to number 101. To do this, you need to write a rule immediately after the globals section: <br><pre>  [office]
 exten =&gt; _1XX, 1, Dial (SIP / $ {EXTEN}) </pre><br>  Let's sort this line. <br>  <b>[office]</b> is the name of the context in which calls from the peer are processed. <br>  <b>exten =&gt;</b> - pointer to the beginning of the step. <br>  <b>_1XX</b> - mask.  On the mask dwell a little more.  With the help of it, all calls that fall into the context of the dialplan are sorted. <br><br>  The mask uses a set of patterns to sort caller-id calls: <br><pre>  X - any digit from 0-9
 N - any number from 2-9
 [234-6] - numbers 2, 3, 4 and 6
 .  - any possible characters </pre><br>  The mask begins with the character "_", which means that it is a template.  In case you forget to specify it, Asterisk will take 1XX for the called number and transmit the Dial-pattern instead of the phone number, and the call will not take place. <br>  <b>1</b> - action number. <br><br>  <b>Dial</b> is an application.  In the dialplan, you can use more than 200 different applications that are used for manipulating calls.  Now, at the very beginning, we will use only one application - Dial.  From the name it is clear that it is used for making calls. <br><br>  <b>(SIP / $ {EXTEN})</b> - arguments for the application.  In our example, for internal peers, we use the SIP protocol, so the first argument that we give to dial-y is the signaling protocol used.  $ {EXTEN} is the current extension, its value is taken from the header (from the destination field). <br><br>  <b>/</b> - separator for passed arguments. <br><br>  Each of the parameters is separated by commas.  In our example, three-digit numbers are used, so the mask should have 3 patterns.  In case you want to use a different numbering length, write the required number of patterns in the mask.  Now save the file, open the asterisk shell and write the command: <br><pre>  dialplan reload </pre><br>  If there are problems with access to the file, then we write: <br><pre>  chown asterisk: asterisk /etc/asterisk/extensions.conf </pre><br>  And again we restart the dialplan through the Asterisk shell. <br><br>  Now we try to call.  If you set everything up correctly, then peer with number 100 will reach the peer with number 101. Now we can call inside the office, between peers, who work in the office context.  In order to call the city, we need to write a rule for outgoing calls through the first operator.  We register it in the office context, it looks like this: <br><pre>  exten =&gt; _XXXXXXX, 1, Dial (SIP / $ {EXTEN} @ operator1) </pre><br>  Restart the dialplan and try to call the city. <br><br>  Now we need to take an incoming call.  Make a new context in the dialplan, write to the end of the file: <br><pre>  [operator1]
  exten =&gt; s, 1, Dial (SIP / 100 &amp; SIP / 101) </pre><br>  Let me explain what it means "s".  This is a standard mask in Asterisk, under which absolutely all the challenges fall.  That is, if we use a trunk with registration, the incoming caller-id will be ‚Äús‚Äù. <br><br>  Save and restart the dialplan.  Now we can take an incoming call through the operator providing us a landline number. <br><br>  Now we needed to call a cell phone with a federal number.  Let's add one more line to the [office] context: <br><pre>  exten =&gt; _89XXXXXXXXX, 1, Dial (SIP / $ {EXTEN} @ operator1) </pre><br>  Save, restart the dialplan and call.  Everything.  Now we can fully use the services of the operator providing the city number. <br><br>  However, here lies a small problem that will arise when calling to mobile phones in other regions.  Since the phone number is federal, all calls will go through the first operator.  Therefore, it is appropriate to reduce the size of the masks in the dialplan.  For example: <br><pre>  exten =&gt; _8909 [89] [2-9] [1-3] XXXX, 1, Dial (SIP / $ {EXTEN} @ operator1)
 exten =&gt; _8901 [456] [2-5] 1XXXX, 1, Dial (SIP / $ {EXTEN} @ operator1)
 exten =&gt; _XXXXXXX, 1, Dial (SIP / $ {EXTEN} @ operator1) </pre><br>  With this design, all calls to phones with the codes from the ranges 890982XXXXX-890999XXXXX and 8901421XXXX-8901651XXXX will go through the first operator.  Not quite comfortable, agree with that.  In future articles I will lay out the configuration of the dialplan for automatic selection of the operator depending on the direction of the call, since this again goes beyond the scope of this article. <br>  Now we have to make long-distance calls through the second operator.  Add a line to the [office] context: <br><pre>  exten =&gt; _ [78] [3-689] XXXXXXXXX, 1, Set (CALLERID (num) = 74991234567)
 same =&gt; n, Dial (SIP / $ {EXTEN} @ operator2) </pre><br>  As you noticed, there are new applications that handle calls.  <b>Set (CALLERID (num) = 74991234567)</b> - since we use a trunk without registration, this means that we have to send the caller-id operator.  This number does not have to exist.  Here we simply introduce ourselves to the provider and no more.  Which number to substitute depends on the operator.  Some provide a caller-id substitution service to another operator‚Äôs number, for making outgoing long-distance calls or for calling.  For details, contact the operator.  <b>same =&gt; n</b> - a pointer that allows you not to write every time a mask and action number.  For example: <br><pre>  exten =&gt; 78121234567,1, Answer
 exten =&gt; 78121234567,1, Set (CALLERID (name) = Trunk_1
 exten =&gt; 78121234567,1, Dial (SIP / 1000) </pre><br>  Can be replaced by: <br><pre>  exten =&gt; 78121234567,1, Answer
 same =&gt; n, Set (CALLERID (name) = Trunk_1
 same =&gt; n, Dial (SIP / 1000) </pre><br>  In the second case, everything is much simpler, isn't it? <br><br>  That's all, we set up Asterisk.  Now we can call to the city, to the cellular, to the intercity and we have an internal connection between the feasts.  We get this, quite working dialplan: <br><pre>  [general]
 static = yes
 writeprotect = no

 [globals]

 [office]
 exten =&gt; _8909 [89] [2-9] [1-3] XXXX, 1, Dial (SIP / $ {EXTEN} @ operator1)
 exten =&gt; _8901 [456] [2-5] 1XXXX, 1, Dial (SIP / $ {EXTEN} @ operator1)
 exten =&gt; _ [78] [3-689] XXXXXXXXX, 1, Set (CALLERID (num) = 74991234567)
 same =&gt; n, Dial (SIP / $ {EXTEN} @ operator2)
 exten =&gt; _XXXXXXX, 1, Dial (SIP / $ {EXTEN} @ operator1)
 exten =&gt; _1XX, 1, Dial (SIP / $ {EXTEN})

 [operator1]
 exten =&gt; s, 1, Dial (SIP / 100 &amp; SIP / 101)
</pre><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/264981/">https://habr.com/ru/post/264981/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../264967/index.html">How-to: Techniques for creating interactive emails using CSS</a></li>
<li><a href="../264969/index.html">My view on yii 2 configuration files</a></li>
<li><a href="../264973/index.html">A look at Angry Birds 2, Niki Minaj and Jason Statham as new stars of Glu, the rise in price of a loyal user - and other news of the week for a mobile developer</a></li>
<li><a href="../264975/index.html">Intervals in C ++, part 3: we represent incrementors (Iterable)</a></li>
<li><a href="../264977/index.html">The University of Innopolis opened a school of high-performance computing in scientific and engineering problems</a></li>
<li><a href="../264983/index.html">In search of an analogue of first-order functions in the Cach√© DBMS</a></li>
<li><a href="../264985/index.html">Sync CI Notifications with Telegram</a></li>
<li><a href="../264987/index.html">Median: precisely, sometimes precisely and almost exactly</a></li>
<li><a href="../264989/index.html">Cartesius - a method of storing and retrieving tree structures in relational databases or SQL trees without worms and cockroaches</a></li>
<li><a href="../264991/index.html">Total Mobilization with MobilizeToday</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>