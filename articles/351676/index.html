<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How professional interest stole my weekend</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day to all! After reading this article ( online flower shop, or how we screwed up on Valentine's Day ) decided to share the experience of optimiz...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How professional interest stole my weekend</h1><div class="post__text post__text-html js-mediator-article">  Good day to all!  After reading this article ( <a href="https://habrahabr.ru/post/351396/">online flower shop, or how we screwed up on Valentine's Day</a> ) decided to share the experience of optimizing one of the sites on Bitrix.  For some unknown reason, it was this article that gave a decisive kick to share its experience.  I want to believe that my story will save someone precious time (because of my ‚Äúcomplete everything‚Äù feature, I spent 2 days off to achieve the goal. I didn‚Äôt want to leave the client without a working site on the weekend), and I hope that the more experienced colleagues will point out my mistakes. <br><br>  On Friday I got a website on Bitrix with a catalog of auto parts and a database of 3.2 GB in size.  Problem: the site either did not give the page at all, or during the waiting time you could forget why you visited this site.  What attempts I made and what I managed to achieve in the end I will tell under the cut. <br><a name="habracut"></a><br>  So, more specifically, the parameters of the old hosting: <br><br><ul><li>  VDS; </li><li>  8 GB of RAM (on a new 4GB hosting); </li><li>  40GB SSD; </li><li>  bitrix environment 5. * (on a new hosting net version 7.0); </li><li>  PHP 5.6 (on the new PHP 7.0 hosting); </li><li>  MySql 5.5. *; </li><li>  file bitrix caching; </li><li>  agents run on hits. </li></ul><br>  Usually I take the following steps to optimize the Bitrix site (VDS), but this time it didn‚Äôt give any tangible results: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  transfer performance of agents from hits to crowns ( <a href="https://dev.1c-bitrix.ru/learning/course/index.php%3FCOURSE_ID%3D43%26LESSON_ID%3D2943%26LESSON_PATH%3D3913.4776.4620.4978.2943">more</a> ); </li><li>  setting memcached ( <a href="https://dev.1c-bitrix.ru/learning/course/index.php%3FCOURSE_ID%3D32%26LESSON_ID%3D5505">more</a> ); </li><li>  This time a transfer was added to a new hosting with updated components (php, mysql, etc.) </li></ul><br>  When I decided to deploy a local version, I was greatly surprised by the 3.2 GB site <b>database</b> , especially the <b>b_sale_fuser</b> table (2.4 GB), which is responsible for the visitor baskets.  As it turned out, it contained data from 2014.  When I looked inside this table, I noticed several features: <br><br><ul><li>  80% of the data was only for the last month (total 17+ million records); </li><li>  records were created at intervals of several seconds.  The standard method of cleaning abandoned baskets simply did not cope; </li><li>  there are three indices in the table, which means that when the data in it changes, the indices will be updated, which entails additional costs for resources; </li></ul><br><img src="https://habrastorage.org/webt/up/pj/sd/uppjsdxohtbghkmn0zzvd1eljvi.png"><br><br><img src="https://habrastorage.org/webt/xk/ui/hr/xkuihryr33zxorthmafikr_boj4.png"><br><br>  At this stage, I made the assumption that the problem lies in using the <b>CsaleBasket :: GetBasketUserID method (bSkipFUserInit)</b> without an additional parameter.  The <b>nuance</b> is that the <b>bSkipFUserInit</b> parameter <b>is</b> responsible for creating an entry in the table, even if the client has not yet placed anything in the basket.  My guess was confirmed when <b>I</b> found a call to the ill-fated method in one of the files <b>result_modifier.php</b> without the necessary parameter.  Having corrected this moment and cleared the table of irrelevant data (around 3 o'clock, because the muscles constantly fell off, and the data needed to be removed from the related tables. All this was done using standard Bitrix methods, which I later regretted. In more detail I will report in the conclusions. After cleaning, the number of records decreased from 19+ million to 400+ thousand, which had a beneficial effect on the work of the local version, but the result still did not suit. The page began to be given in 20-30 seconds, and earlier in a few minutes. <br><br>  Then it was decided to look for slow queries.  Since  we use bitrixenv, the order of commands for editing the musk-config looks like this: <br><br><pre><code class="bash hljs">nano /etc/mysql/bx/bvxat.cnf <span class="hljs-comment"><span class="hljs-comment">#     log_slow_queries = /var/log/mysql/mysql-slow.log long_query_time = 1 service mysqld restart</span></span></code> </pre> <br>  After the search, two queries were found that ran for 300+ seconds (see below).  One of them showed 4 random goods from the entire catalog.  At that time, I decided to comment out the call of this component until better times.  But the second one simply cannot be excluded, since he is responsible for the formation of the main menu (see below). <br><br><div class="spoiler">  <b class="spoiler_title">Sql query</b> <div class="spoiler_text"><pre> <code class="sql hljs">Tcp port: 3306 Unix socket: /var/lib/mysqld/mysqld.sock Time Id Command Argument <span class="hljs-comment"><span class="hljs-comment"># Time: 180318 18:30:07 # User@Host: bitrix[bitrix] @ localhost [] # Thread_id: 96 Schema: testdb QC_hit: No # Query_time: 301.414008 Lock_time: 0.000324 Rows_sent: 13 Rows_examined: 260456 use testdb; SET timestamp=1521387007; SELECT DISTINCT BS.*, B.LIST_PAGE_URL, B.SECTION_PAGE_URL, B.IBLOCK_TYPE_ID, B.CODE as IBLOCK_CODE, B.XML_ID as IBLOCK_EXTERNAL_ID, BS.XML_ID as EXTERNAL_ID, DATE_FORMAT(BS.TIMESTAMP_X, '%d.%m.%Y %H:%i:%s') as TIMESTAMP_X, DATE_FORMAT(BS.DATE_CREATE, '%d.%m.%Y %H:%i:%s') as DATE_CREATE ,COUNT(DISTINCT BE.ID) as ELEMENT_CNT FROM b_iblock_section BS INNER JOIN b_iblock B ON BS.IBLOCK_ID = B.ID INNER JOIN b_iblock_section BSTEMP ON BSTEMP.IBLOCK_ID = BS.IBLOCK_ID LEFT JOIN b_iblock_section_element BSE ON BSE.IBLOCK_SECTION_ID=BSTEMP.ID LEFT JOIN b_iblock_element BE ON (BSE.IBLOCK_ELEMENT_ID=BE.ID AND ((BE.WF_STATUS_ID=1 AND BE.WF_PARENT_ELEMENT_ID IS NULL ) AND BE.IBLOCK_ID = BS.IBLOCK_ID ) AND BE.ACTIVE='Y' AND (BE.ACTIVE_TO &gt;= now() OR BE.ACTIVE_TO IS NULL) AND (BE.ACTIVE_FROM &lt;= now() OR BE.ACTIVE_FROM IS NULL)) WHERE 1=1 AND BSTEMP.IBLOCK_ID = BS.IBLOCK_ID AND BSTEMP.LEFT_MARGIN &gt;= BS.LEFT_MARGIN AND BSTEMP.RIGHT_MARGIN &lt;= BS.RIGHT_MARGIN AND BSTEMP.GLOBAL_ACTIVE = 'Y' AND ((((BS.ACTIVE='Y')))) AND ((((BS.GLOBAL_ACTIVE='Y')))) AND ((((BS.IBLOCK_ID = '9')))) AND ((((BS.DEPTH_LEVEL &lt;= '1')))) AND ((((B.ID = '9')))) AND (( B.ID IN ( SELECT IBLOCK_ID FROM b_iblock_group IBG WHERE IBG.GROUP_ID IN (2) AND IBG.PERMISSION &gt;= 'R' AND (IBG.PERMISSION='X' OR B.ACTIVE='Y') ) OR (B.RIGHTS_MODE = 'E' AND EXISTS ( SELECT SR.SECTION_ID FROM b_iblock_section_right SR INNER JOIN b_iblock_right IBR ON IBR.ID = SR.RIGHT_ID INNER JOIN b_user_access UA ON UA.ACCESS_CODE = IBR.GROUP_CODE AND UA.USER_ID = 0 WHERE SR.SECTION_ID = BS.ID AND IBR.OP_SREAD = 'Y' )) )) GROUP BY BS.ID, B.ID ORDER BY BS.LEFT_MARGIN asc;</span></span></code> </pre><br></div></div><br>  At first I was not embarrassed that on the battle server, this request was executed for 300+ seconds, and on the local machine for 20+, and I thought that the reason for this was not enough load on the site.  Those.  on the combat site, the visit was 20 persons per minute, and on the local copy, only I did requests.  I decided to use the Jmeter utility (see below). <br><br><img src="https://habrastorage.org/webt/kq/zb/rm/kqzbrmsxu2sxn_7afeubzyfz8py.png"><br><br>  After running this test in 20 requests, I decided to open the site in the browser and immediately received the following error: <b>Incorrect key file for table</b> / tmp / *.  As it turned out, for each SQL query, Muskul created temporary tables on the disk in the temporary folder, but there was not enough space.  Since  not strong in principle, MySql went with a question to all-knowing Google (did you have at least one day without resorting to searching ?!), who explained the following: <br><br>  <i>if the sample contains <b>TEXT / BLOB</b> type fields, then the database will create temporary tables on the disk</i> <br><br>  And the great assistant, as always, was right!  In the <b>b_iblock_section</b> table, there are a couple of such fields (see right), namely <b>DESCRIPTION</b> and <b>SEARCHABLE_CONTENT</b> . <br><br><img src="https://habrastorage.org/webt/m7/cz/76/m7cz76s0rj4alfvhcvikvhpxtpu.png"><br><br>  By removing these fields from the query and rewriting it (see below), we managed to win the speed several times!  As a result, the query instead of 20+ seconds on the local machine began to return the result after 1.5 seconds.  However, it was too early to rejoice.  since this query in the database was formed in the system bitrix file <b>/bitrix/modules/iblock/classes/mysql/iblocksection.php</b> .  Unfortunately, I didn‚Äôt find anything better than to fix it, although I‚Äôm aware that in the first update of the Bitrix kernel my editing may be erased.  But at that time I was already struggling with this site for 3 days in a row and the time went by on Sunday evening.  So left this farm ... <br><br><div class="spoiler">  <b class="spoiler_title">It was</b> <div class="spoiler_text"><pre> <code class="sql hljs">BS.*, ...</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">It became</b> <div class="spoiler_text"><pre> <code class="sql hljs">BS.ID, BS.TIMESTAMP_X, BS.MODIFIED_BY, BS.DATE_CREATE, BS.CREATED_BY, BS.IBLOCK_ID, BS.IBLOCK_SECTION_ID, BS.ACTIVE, BS.GLOBAL_ACTIVE, BS.SORT, BS.NAME, BS.PICTURE, BS.LEFT_MARGIN, BS.RIGHT_MARGIN, BS.DEPTH_LEVEL, BS.CODE, BS.XML_ID, BS.TMP_ID, BS.DETAIL_PICTURE, BS.SOCNET_GROUP_ID, ...</code> </pre><br></div></div><br>  However, it was too early to rejoice here.  When I filled in the edits to the combat site, the result became better, but far from the desired (300 sec ‚Äì‚Äì&gt; 100+ sec).  Having spent some time in bewilderment and having pawed about myself, I decided to try to work out an assumption about the difference of the versions of mysql on the combat server and on the local machine.  You might think that the matter is in the settings of the database itself, however, I cut off this item at the beginning of the path, when I set the same settings as on the combat vehicle.  It only remained to upgrade from version <b>5.5. *</b> To <b>5.6.35</b> on the server (the latest available version of mysql on the machine).  He placed great hopes on this step, since ideas and assumptions about what could be the case dried out.  Yes, and it was a pity the weekend, which spent on finding and solving problems.  Together with the weekend my nerves were ending ... But how glad I was that when after updating the database everything worked as it should, the numbers in the request logs were identical to the numbers on the local machine, and the site just started to fly.  Joy knew no bounds, it was enough for two: me and my girlfriend, who realized that I would spend the rest of the weekend with her, and not behind the monitor screen. <br><br>  What methods did for yourself: <br><br><ul><li>  Testing and identifying problems on the local computer is logical to conduct in conditions close to combat.  Unfortunately, I came up with this a few hours later, updating the site page with single queries; </li><li>  it is sometimes easier to update the components used.  For example, it helped in my multi-day quest, though it is a pity that I thought of this only at the end of the epic. </li><li>  After some time, I think that it would be better to analyze the CMS system files to create several sql queries in the database, which would clear the ill-fated b_sale_fuser table and its associated data.  And then he sat and waited until the system methods removed the records for each pass ... </li><li>  It is better to spend time studying the tools you work with.  In my case, I'll go read the book on MySql, so that the new problems are not an inexplicable focus for me. </li></ul><br>  I thank everyone who took the time.  It will be great if you leave constructive criticism or advice. <br><br>  <b>PS</b> At the end of the second day of torment, I remembered the story ‚ÄúThe Old Man and the Sea‚Äù, and thought that my attempts would also not be rewarded, but everything worked out. <br><br>  <b>PPS</b> In order for the data deletion rate to increase from the <b>b_sale_fuser</b> table and other related data, it was possible to remove indexes from them and then add them again after updating. </div><p>Source: <a href="https://habr.com/ru/post/351676/">https://habr.com/ru/post/351676/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../351664/index.html">DNSCrypt 2.0 and ad blocking</a></li>
<li><a href="../351666/index.html">Cocos2d-x Design Patterns</a></li>
<li><a href="../351670/index.html">LG has announced the release of an open platform WebOS Open Source Edition</a></li>
<li><a href="../351672/index.html">About porting the MIPSfpga project</a></li>
<li><a href="../351674/index.html">Neoquest 2018: ‚ÄúAirship? Yeah! ‚Äù</a></li>
<li><a href="../351678/index.html">Angular application architecture. We use NgModules</a></li>
<li><a href="../351680/index.html">DEFCON conference 17. ‚ÄúStealing profits from spammers: how I stopped worrying about spam and loved it‚Äù. Grant jordan</a></li>
<li><a href="../351682/index.html">Graal: how to use the new JIT JIT compiler in real life</a></li>
<li><a href="../351684/index.html">In google with no work experience. Programmer from Silicon Valley about Russian diplomas, interviews and work in the US</a></li>
<li><a href="../351686/index.html">Big clump of dirt</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>