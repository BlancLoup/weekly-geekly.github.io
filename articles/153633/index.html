<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>About how I got Java from PDF Flash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A long time ago, when the grass was greener, I was caught and tortured for a long time. I had to raise the performance in one wonderful bundle. 

 As ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>About how I got Java from PDF Flash</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/887/193/35c/88719335ca303f8ab449c86c0a5307c9.png" alt="image" align="left"><br>  A long time ago, when the grass was greener, <s>I was caught and tortured for a long time.</s> I had to raise the performance in one wonderful bundle. <br><br><h4>  As the architect understood the task </h4><br>  Given: there is an <s>insane</s> catalog of products in the form of a large number of PDF for a couple of thousand pages each.  It is necessary to give them to the web in the form of colorful animated presentations. <br><br>  Attempt to solve: they wrote the players on flash and javascript, which fed this converted directory, and they use something like a different algorithm to twist something with advertising. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Problem: catalogs are constantly changing, and converting only one ledger from the catalog takes more than an hour (!). <br><br>  Why and how to improve? <br><br><a name="habracut"></a><br><br><h4>  How is it done before us </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/72a/2b5/8f5/72a2b58f55a369dcd33b13a8f53650e7.png" alt="image" align="left"><br>  <i>There is a reasonable question - why is it so difficult?</i>  <i>So, besides desktops, mobile phones should be spud, and generating a raster for 200 devices and then testing it all is not our method.</i>  <i>And then - and with a zoom then what to do?</i> <i><br><br></i>  <i>Therefore, for the desktop - flash in ancient browsers (cheers for corporate IE), and HTML5 for everything else.</i>  <i>Vector pictures (except for thumbnails, otherwise the SVG-NIS will be mastered at once, while the tablets are weak).</i> <br><br>  Open sorts (as always) to the rescue. <br><br>  Analyzing - what is being done there.  I discover this <br><br><ul><li>  pdftoswf (so what's it discontinued? but it works) </li><li>  pdftosvg (version 0.1) </li><li>  ImageMagick (remember the PNG in the form of thumbnails) </li><li>  pdftohtml (after all, there is also text - and you need to get subtitles, and it is more convenient to do it from XML) </li></ul><br>  I start it all in turn on a test PDF of 500 pages.  Opening hours <b>1 hour 2 minutes</b> . <br><br>  Here you are, grandmother, and St. George's day! <br><br><h4>  Who is guilty? </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/39f/ae6/fe8/39fae6fe87180b89b5c0b0ea0e81bb3a.png" alt="image" align="left"><br>  Obviously, parsing PDF as many as four times in a row is not the best choice. <br><br>  It is no less obvious that ImageMagick is clearly the wrong choice, 3/4 of the time was spent using the convert utility. <br><br>  It was at that moment that a <s>customer with an iron-shrouded iron looked into my room and said: your wisdom is urgently needed!</s>  I enter the game. <br><br>  We recognize the general direction as conditionally correct - where to go, the release, as always, ‚Äújust yesterday‚Äù, but there are no questions for the player.  But we consider the junk picked up poorly, and turn our attention to Java. <br><br><h4>  New actors </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/b2e/692/b59/b2e692b593f4d4449d17a8c0965cda4d.png" alt="image" align="left"><br>  Take the following set of gentleman: <br><br><ul><li>  PDFRenderer </li><li>  Apache batik </li><li>  Adobe Flex SDK: swfutils </li><li>  Jai </li></ul><br><br>  and begin to combine. <br><br>  First and foremost, we remember <a href="http://habrahabr.ru/post/153225/">about Marcus and Boris</a> , and begin: <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PdfConv</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startConversion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String pdfFile)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextPage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pageNo, String outputFileName)</span></span></span><span class="hljs-function"> </span></span>{ ... } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">endConversion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ ... } }</code> </pre> <br>  And we write how we will use it. <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] argv)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> jjk =<span class="hljs-number"><span class="hljs-number">0</span></span>; jjk &lt;argv.length; ++jjk) { PdfConv conv = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PdfConv(); conv.startConversion(argv[jjk]); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = conv.getPages(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; k; ++j) { conv.nextPage(j, argv[jjk] + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + j + <span class="hljs-string"><span class="hljs-string">".svg"</span></span>); conv.nextPage(j, argv[jjk] + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + j + <span class="hljs-string"><span class="hljs-string">".png"</span></span>); conv.nextPage(j, argv[jjk] + <span class="hljs-string"><span class="hljs-string">"_"</span></span> + j + <span class="hljs-string"><span class="hljs-string">".swf"</span></span>); ... } } }</code> </pre><br>  Things are easy - to write all the necessary converters. <br><br><h4>  First rake </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/1513/molumen_snowflakes.png" alt="image" align="left"><br>  It turns out that the chosen lib is really bright.  But she has a couple of serious flaws: <br><br><ol><li>  No SMask support </li><li>  There are no gradients either. </li><li>  JPEG2000 misunderstanding chronic </li><li>  Strange with fonts in the form of any there arrows, etc.  In his best </li></ol><br>  Googling solves font problems, adding JAI to the classpath with image formats. <br><br>  SMask has to be added to the PDFRenderer code with a file.  Trivially - we add a recognition in the parser, a command to save to the context, and change the Shape drawing to a drawing with a mask overlay.  Trite, but textually abundant. <br><br>  Gradients are simply ignored - they are not present in those places that fall into the slides.  Cropy and other processing for simplicity, I do not show, if that. <br><br>  The first stage is completed - it draws as it should.  We implement our API (I removed error handling): <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> PDFFile pdf = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FileChannel fic = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startConversion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String pdfFile)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ File fix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> File(pdfFile); FileInputStream fin = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(fix); fic = fin.getChannel(); MappedByteBuffer mbb = fic.map(FileChannel.MapMode.READ_ONLY, <span class="hljs-number"><span class="hljs-number">0</span></span>, fix.length()); pdf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDFFile(mbb); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pdf.getNumPages(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getPages</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> pdf.getNumPages(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">endConversion</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fic != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) fic.close(); pdf = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; fic = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nextPage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> pageNo, String outputMask)</span></span></span><span class="hljs-function"> </span></span>{ PDFPage page = pdf.getPage(pageNo + <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (page == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; Rectangle bounds = page.getBBox().getBounds(); DrawingCtx ctx = DrawingCtxBuilder.build( outputMask, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dimension(bounds.x + bounds.width, bounds.y + bounds.height)); PDFRenderer rx = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PDFRenderer(page, ctx.getContext(), bounds, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); rx.go(); rx.waitForFinish(); ctx.saveTo(outputMask); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span>; }</code> </pre><br>  Let's proceed to the actual conversion. <br><br><h4>  We draw abstractions - but do not forget about the Roosevelts </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/68269/cartella-vistastyle.png" alt="image" align="right"><br>  The subject area is such that even Boris is not confused. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">abstract</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DrawingCtx</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Graphics2D g2; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> Dimension size; DrawingCtx(Dimension size) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.size = size; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Graphics2D </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getGraphics</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> g2; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">abstract</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception</span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DrawingCtxBuilder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">build</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fileName, Dimension size)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ String type = fileName.substring(fileName.lastIndexOf(<span class="hljs-string"><span class="hljs-string">'.'</span></span>) + <span class="hljs-number"><span class="hljs-number">1</span></span>).toUpperCase(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(type.equals(<span class="hljs-string"><span class="hljs-string">"SVG"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SvgDrawingCtx(size); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(type.equals(<span class="hljs-string"><span class="hljs-string">"PNG"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImageDrawingCtx(size); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(type.equals(<span class="hljs-string"><span class="hljs-string">"SWF"</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SwfDrawingCtx(size); ... <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(type + <span class="hljs-string"><span class="hljs-string">": unknown converter requested"</span></span>); } }</code> </pre><br>  Fill our skeleton with meat - and the cadavrik will be ready for work. <br><br><h4>  SVG and Batik </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172555/KofferV1.png" alt="image" align="right"><br>  Here, in general, everything has been done before us, Apache Batik SVGgen to the rescue.  No problems noticed.  There would be gradients - then yes, with radial gradients you would have to either say goodbye or impose a patch on the batik.  This is after the gradients themselves can be added to the PDFRenderer, by itself. <br><br>  The only subtlety is to make hints correctly so that anti-aliasing is not forgotten, and the pictures are not cut into pieces. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SvgDrawingCtx</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DrawingCtx</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> DOMImplementation domImpl; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Document doc; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SVGGraphics2D svgGenerator; SvgDrawingCtx(Dimension size) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(size); domImpl = SVG12DOMImplementation.getDOMImplementation(); doc = domImpl.createDocument(SVGConstants.SVG_NAMESPACE_URI, SVGConstants.SVG_SVG_TAG, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); svgGenerator = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SVGGraphics2D(doc); svgGenerator.getGeneratorContext().setPrecision(<span class="hljs-number"><span class="hljs-number">4</span></span>); svgGenerator.getGeneratorContext().setEmbeddedFontsOn(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); g2 = svgGenerator; g2.setRenderingHint(RenderingHints.KEY_ANTIALIASING, RenderingHints.VALUE_ANTIALIAS_ON); g2.setRenderingHint( RenderingHints.KEY_INTERPOLATION, RenderingHints.VALUE_INTERPOLATION_BILINEAR); g2.setRenderingHint( RenderingHintsKeyExt.KEY_AVOID_TILE_PAINTING, RenderingHintsKeyExt.VALUE_AVOID_TILE_PAINTING_ON); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ Element svgRoot = svgGenerator.getRoot(); OutputStream os = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(fn); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (fn.endsWith(<span class="hljs-string"><span class="hljs-string">".svgz"</span></span>)) os = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GZIPOutputStream(os); svgGenerator.stream(svgRoot, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> OutputStreamWriter(os), <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> <span class="hljs-comment"><span class="hljs-comment">/* CSS */</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> <span class="hljs-comment"><span class="hljs-comment">/* escaped */</span></span>); os.close(); } }</code> </pre><br><br><h4>  PNG: can not be easier </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172607/Quality_Street_Revival.png" alt="image" align="right"><br>  It's so trite here that I'll just give the code. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageDrawingCtx</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BufferedImage bf = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; ImageDrawingCtx(Dimension size) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(size); bf = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BufferedImage(size.width, size.height, BufferedImage.TYPE_INT_ARGB); g2 = (Graphics2D) bf.getGraphics(); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ OutputStream os = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(fn); ImageIO.write(bf, <span class="hljs-string"><span class="hljs-string">"PNG"</span></span>, os); os.close(); g2.dispose(); bf = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre> <br><br><h4>  Now for the dessert - create the SWF </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/172606/Hussar.png" alt="image" align="right"><br>  The code is also simple (and mostly borrowed from the Flex SDK examples). <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SwfDrawingCtx</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DrawingCtx</span></span></span><span class="hljs-class"> </span></span>{ SwfDrawingCtx(Dimension size) { <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(size); g2 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SpriteGraphics2D(size.width, size.height); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">saveTo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String fn)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ OutputStream os = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileOutputStream(fn); flash.swf.Frame frame1; Movie m = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Movie(); m.version = <span class="hljs-number"><span class="hljs-number">7</span></span>; m.bgcolor = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SetBackgroundColor(SwfUtils.colorToInt(<span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>, <span class="hljs-number"><span class="hljs-number">255</span></span>)); m.framerate = <span class="hljs-number"><span class="hljs-number">12</span></span>; frame1 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> flash.swf.Frame(); DefineSprite tag = ((MyG2D) g2).defineSprite(<span class="hljs-string"><span class="hljs-string">"swf-test"</span></span>); frame1.controlTags.add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> PlaceObject(tag, <span class="hljs-number"><span class="hljs-number">0</span></span>)); m.frames = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArrayList(<span class="hljs-number"><span class="hljs-number">1</span></span>); m.frames.add(frame1); TagEncoder tagEncoder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> TagEncoder(); MovieEncoder movieEncoder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MovieEncoder(tagEncoder); movieEncoder.export(m); tagEncoder.writeTo(os); os.close(); g2.dispose(); g2 = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } }</code> </pre><br>  Nothing foreshadowed, and suddenly.  Part of the pictures in the SWF did not appear. <br><br><h4>  Hot pursuit investigation </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/495/johnny_automatic_snowboarder.png" alt="image" align="right"><br>  This is how it is - there is a SVG, there is a PNG, but there is no SWF. <br><br>  Tracing the <a href="">source adobe source</a> code made me think, and I made the code for the horse: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyG2D</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SpriteGraphics2D</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyG2D</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> width, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> height)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(width, height); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyG2D</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Image image, AffineTransform at, ImageObserver obs)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    return super.drawImage(image, at, obs); } }</span></span></code> </pre><br><br>  An autopsy revealed that <br><pre> <code class="java hljs">at.createTransformedShape(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Rectangle(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, image.getWidth(), image.getHeight()).getBounds()</code> </pre>  returns us a 1x1 rectangle. <br><br>  Eureka! <br><br><pre> <code class="java hljs"> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">boolean</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">drawImage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Image image, AffineTransform at, ImageObserver obs)</span></span></span><span class="hljs-function"> </span></span>{ AffineTransform good = getTransform(); good.concatenate(at); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.drawImage(image, good, obs); }</code> </pre><br>  solves the problem. <br><br><h4>  Results </h4><br><img src="http://openclipart.org/image/250px/svg_to_png/121/molumen_zaz_965.png" alt="image" align="left"><br>  The test run showed that the first version, sewn on a live thread, requires less than <b>10 minutes</b> .  It is still a lot, and there is something to think about. <br><br>  However, the transition from <i>kosher C ++</i> to Java accelerated the procedure more than six times, and the creation of a new converter from scratch required the solution of a couple of rakes in a total of three days. <br><br>  Now the guys have something to think about, and repeat all these steps in C ++.  They have time - java so far copes. <br><br>  Costs: I had to take with myself 40 megabytes of jar-ok, and build it in Tomkat, however the web service was in PHP. </div><p>Source: <a href="https://habr.com/ru/post/153633/">https://habr.com/ru/post/153633/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../153615/index.html">Nokia Plan B (take 2)?</a></li>
<li><a href="../153617/index.html">Optical character recognition in Linux</a></li>
<li><a href="../153619/index.html">MiniSCADA do it yourself</a></li>
<li><a href="../153625/index.html">Configuring Cisco ACS 5.3 in conjunction with Active Directory</a></li>
<li><a href="../153631/index.html">How is the short-term forecast for Yandex.Probka</a></li>
<li><a href="../153635/index.html">How do you most often read technical literature?</a></li>
<li><a href="../153641/index.html">How I parsed Google Play</a></li>
<li><a href="../153643/index.html">Facebook scans the users' correspondence and automatically links the likes to the links</a></li>
<li><a href="../153647/index.html">A small photo report with CEATEC Japan 2012</a></li>
<li><a href="../153653/index.html">A series of webinars "Application Development for Windows 8"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>