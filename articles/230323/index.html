<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WebGL game development features for Digital Trip</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! In this article I want to share my own experience developing the WebGL game Digital Trip. In addition to WebGL, the game uses technologies s...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WebGL game development features for Digital Trip</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/97a/1a1/f98/97a1a1f980258da970bd8575c509cfd5.png" alt="image"><br><br>  Hi, Habr!  In this article I want to share my own experience developing the WebGL game Digital Trip.  In addition to WebGL, the game uses technologies such as WebAudio API, WebSockets, getUserMedia, Vibration API, DeviceOrientation, as well as the three.js libraries, hedtrackr.js, socket.io, etc. The article will describe the most interesting implementation details.  I will talk about the game engine, control with a mobile, webcam control, I will say a few words about the back-end on node.js, which works in conjunction with the dogecoin daemon. <br>  At the end of the article are links to used libraries, source code on GitHub, a description of the game and the game itself. <br>  All who are interested, please under the cat. <br><a name="habracut"></a><br><br>  The gameplay is very simple: we fly along a predetermined trajectory, collect coins and bonuses, dodge stones.  Player positions are limited to 3 options.  Bonuses come in three types: shield (HTML5), slowdown (cat), or restoration of lives (lips).  At the end of the game, you can withdraw the received coins to your dogecoin wallet. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/69c/c71/958/69cc71958acee81fc0afbb226af56209.png" alt="image"><br><br>  The goal of the game development is to tell about the browser capabilities, to upgrade your skills, share experience and get great pleasure from the process. <br>  Now more about the features of implementation. <br><br><h4>  Game engine and some details </h4><br>  The global variable DT is used as a namespace, with which you can access service functions, class constructors and instances, as well as handler functions, various parameters, etc. <br><br><h5>  Preloader </h5><br>  Three scripts are connected to the village: <br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/vendor/jquery.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/vendor/yepnope.1.5.4-min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"js/myYepnope.min.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  To download the remaining scripts, the <a href="http://yepnopejs.com/">yepnope</a> resource loader is used. <br>  When myYepnope.js is executed, the browser checks for WebGL support: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> isWebGLSupported, canvas = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">'checkwebgl'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.WebGLRenderingContext) { <span class="hljs-comment"><span class="hljs-comment">// Browser has no idea what WebGL is isWebGLSupported = false; } else if (canvas.getContext("webgl") || canvas.getContext("webGlCanvas") || canvas.getContext("moz-webgl") || canvas.getContext("webkit-3d") || canvas.getContext("experimental-webgl")) { // Can get context isWebGLSupported = true; } else { // Can't get context isWebGLSupported = false; }</span></span></code> </pre><br>  If the browser supports WebGL, myYepnope defines a function to display the loading of resources and loads other scripts. <br>  This is where the preloader starts.  Visually, it represents a blurry start-up game interface with a subsequent decrease in the blur radius as it loads. <br><img src="https://habrastorage.org/getpro/habr/post_images/775/a91/2ec/775a912ecf1eb9da9205ec3858640322.png"><br><br>  The blur effect is achieved by using the css <code>-webkit-filter: blur()</code> properties.  The property is perfectly animated.  Firefox uses svg filter, the radius of which is dynamically changed and used as a css <code>filter: 'url()'</code> property <code>filter: 'url()'</code> , while the <code>data url</code> generated by the script and updated every 20% of the load. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isWebGLSupported) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> $body = $(<span class="hljs-string"><span class="hljs-string">'body'</span></span>), $cc = $(<span class="hljs-string"><span class="hljs-string">'.choose_control'</span></span>), maxBlur = <span class="hljs-number"><span class="hljs-number">100</span></span>, steps = <span class="hljs-number"><span class="hljs-number">4</span></span>, isWebkitBlurSupported; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($body[<span class="hljs-number"><span class="hljs-number">0</span></span>].style.webkitFilter === <span class="hljs-literal"><span class="hljs-literal">undefined</span></span>) { isWebkitBlurSupported = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; $cc.css({<span class="hljs-attr"><span class="hljs-attr">filter</span></span>: <span class="hljs-string"><span class="hljs-string">"url('data:image/svg+xml;utf8,&lt;svg xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;filter id=\"blur-overlay\"&gt;&lt;feGaussianBlur stdDeviation=\""</span></span> + maxBlur + <span class="hljs-string"><span class="hljs-string">"\"/&gt;&lt;/filter&gt;&lt;/svg&gt;#blur-overlay')"</span></span>}); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { isWebkitBlurSupported = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; $body[<span class="hljs-number"><span class="hljs-number">0</span></span>].style.webkitFilter = <span class="hljs-string"><span class="hljs-string">'blur('</span></span> + maxBlur + <span class="hljs-string"><span class="hljs-string">'px)'</span></span>; } $(<span class="hljs-string"><span class="hljs-string">'#loader'</span></span>).css({<span class="hljs-attr"><span class="hljs-attr">display</span></span>: <span class="hljs-string"><span class="hljs-string">'table'</span></span>}); $cc.css({<span class="hljs-attr"><span class="hljs-attr">display</span></span>: <span class="hljs-string"><span class="hljs-string">'table'</span></span>}); yepnope.loadCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>; yepnope.percent = <span class="hljs-number"><span class="hljs-number">0</span></span>; yepnope.showLoading = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">n</span></span></span><span class="hljs-function">) </span></span>{ yepnope.percent += maxBlur/steps; yepnope.loadCounter += <span class="hljs-number"><span class="hljs-number">1</span></span>; $(<span class="hljs-string"><span class="hljs-string">".loader"</span></span>).animate({<span class="hljs-attr"><span class="hljs-attr">minWidth</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(yepnope.percent)+<span class="hljs-string"><span class="hljs-string">"px"</span></span>}, { <span class="hljs-attr"><span class="hljs-attr">duration</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>, <span class="hljs-attr"><span class="hljs-attr">progress</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> current = <span class="hljs-built_in"><span class="hljs-built_in">parseInt</span></span>($(<span class="hljs-string"><span class="hljs-string">".loader"</span></span>).css(<span class="hljs-string"><span class="hljs-string">"minWidth"</span></span>), <span class="hljs-number"><span class="hljs-number">10</span></span>) * <span class="hljs-number"><span class="hljs-number">100</span></span>/maxBlur; $(<span class="hljs-string"><span class="hljs-string">"title"</span></span>).html(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.floor(current) + <span class="hljs-string"><span class="hljs-string">"% "</span></span> + <span class="hljs-string"><span class="hljs-string">"digital trip"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isWebkitBlurSupported) { $body[<span class="hljs-number"><span class="hljs-number">0</span></span>].style.webkitFilter = <span class="hljs-string"><span class="hljs-string">'blur('</span></span>+ (maxBlur - current)+ <span class="hljs-string"><span class="hljs-string">'px)'</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isWebkitBlurSupported &amp;&amp; current % <span class="hljs-number"><span class="hljs-number">20</span></span> === <span class="hljs-number"><span class="hljs-number">0</span></span>) { $cc.css({<span class="hljs-attr"><span class="hljs-attr">filter</span></span>: <span class="hljs-string"><span class="hljs-string">"url('data:image/svg+xml;utf8,&lt;svg xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;filter id=\"blur-overlay\"&gt;&lt;feGaussianBlur stdDeviation=\""</span></span> + (maxBlur - maxBlur/(steps+<span class="hljs-number"><span class="hljs-number">1</span></span>)*n) + <span class="hljs-string"><span class="hljs-string">"\"/&gt;&lt;/filter&gt;&lt;/svg&gt;#blur-overlay')"</span></span>}); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (current === <span class="hljs-number"><span class="hljs-number">100</span></span>) { $(<span class="hljs-string"><span class="hljs-string">"title"</span></span>).html(<span class="hljs-string"><span class="hljs-string">"digital trip"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isWebkitBlurSupported &amp;&amp; current % <span class="hljs-number"><span class="hljs-number">20</span></span> === <span class="hljs-number"><span class="hljs-number">0</span></span>) $cc.css({<span class="hljs-attr"><span class="hljs-attr">filter</span></span>: <span class="hljs-string"><span class="hljs-string">"url('data:image/svg+xml;utf8,&lt;svg xmlns=\"http://www.w3.org/2000/svg\"&gt;&lt;filter id=\"blur-overlay\"&gt;&lt;feGaussianBlur stdDeviation=\""</span></span> + <span class="hljs-number"><span class="hljs-number">0</span></span> + <span class="hljs-string"><span class="hljs-string">"\"/&gt;&lt;/filter&gt;&lt;/svg&gt;#blur-overlay')"</span></span>}); } }, <span class="hljs-attr"><span class="hljs-attr">complete</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (n === steps) { DT.runApp(); } } }); }; yepnope([{ <span class="hljs-attr"><span class="hljs-attr">load</span></span>: [ <span class="hljs-string"><span class="hljs-string">"js/vendor/three.min.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"js/DT.min.js"</span></span>, <span class="hljs-string"><span class="hljs-string">"../socket.io/socket.io.js"</span></span> ], <span class="hljs-attr"><span class="hljs-attr">callback</span></span>: {} }]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $(<span class="hljs-string"><span class="hljs-string">'#nogame'</span></span>).css({<span class="hljs-attr"><span class="hljs-attr">display</span></span>: <span class="hljs-string"><span class="hljs-string">'table'</span></span>}); }</code> </pre><br></div></div><br>  After downloading, you can choose one of three control methods and start the game. <br><br><h5>  Developments </h5><br>  Interactions between objects within the game are based on standard and custom events. <br><div class="spoiler">  <b class="spoiler_title">List of events</b> <div class="spoiler_text">  'blur' // loss of focus <br>  'focus' // appearance of focus <br><br>  'socketInitialized' // initialize socket.io <br>  'externalObjectLoaded' // completion of loading external model <br><br>  'startGame' // start the game <br>  'pauseGame' // pause <br>  'resumeGame' // resume game <br>  'gameOver' // end of game <br>  'resetGame' // reset game parameters <br><br>  'updatePath' // update position in game space (pipe) <br>  'update' // update game objects <br><br>  'changeSpeed' // external speed change <br>  'showHelth' // health change display <br>  'showInvulner' // display invulnerability change (shield) <br>  'showScore' // display of change points <br>  'showFun' // display of the mode deceleration change (cat) <br>  'changeHelth' // health change <br>  'bump' // collision with an object <br>  'blink' // sphere flashing <br>  'hit' // clash with a stone <br>  'changeScore' // change point <br>  'catchBonus' // catch bonus <br>  'makeInvulner' // change invulnerability mode (shield) <br>  'makeFun' // enable slow mode (cat) <br>  'showBonuses' // reflection of caught bonuses <br>  'stopFun' // off the seal mode <br><br>  'paymentCheck' // client verification status for payment <br>  'paymentMessage' // receive payment message <br>  'transactionMessage' // receive transaction message <br>  'checkup' // start checking <br></div></div><br>  Events occur in the <code>document</code> element, calling the appropriate handlers, for example: <br><pre> <code class="javascript hljs">DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.trigger(<span class="hljs-string"><span class="hljs-string">'gameOver'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">cause</span></span>: <span class="hljs-string"><span class="hljs-string">'death'</span></span>}); DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'gameOver'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (data.cause === <span class="hljs-string"><span class="hljs-string">'death'</span></span>) { DT.audio.sounds.gameover.play(); } });</code> </pre><br>  The <code>'blur'</code> and <code>'focus'</code> events are triggered in a <code>window</code> and are used to turn off the sound and pause when the window with the game loses focus. <br><pre> <code class="javascript hljs">DT.$<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.on(<span class="hljs-string"><span class="hljs-string">'blur'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DT.game.wasStarted &amp;&amp; !DT.game.wasPaused &amp;&amp; !DT.game.wasOver) { DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.trigger(<span class="hljs-string"><span class="hljs-string">'pauseGame'</span></span>, {}); } DT.setVolume(<span class="hljs-number"><span class="hljs-number">0</span></span>); });</code> </pre><br><h5>  Initialization of the game world </h5><br>  Here everything is standard for projects on <code>three.js</code> : a scene, camera, game space, light sources, background are created. <br><br>  Scene <br><pre> <code class="javascript hljs">DT.scene = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Scene();</code> </pre><br>  Camera <br><pre> <code class="javascript hljs">DT.splineCamera = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.PerspectiveCamera( <span class="hljs-number"><span class="hljs-number">84</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerWidth / <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.innerHeight, <span class="hljs-number"><span class="hljs-number">0.01</span></span>, <span class="hljs-number"><span class="hljs-number">1000</span></span> );</code> </pre><br>  Gaming space - pipe, along the TorusKnot curve from the THREE.Curves set <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> extrudePath = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Curves.TorusKnot(); DT.tube = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.TubeGeometry(extrudePath, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">8</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  Sources of light <br><pre> <code class="javascript hljs">DT.lights = { <span class="hljs-attr"><span class="hljs-attr">light</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.PointLight(<span class="hljs-number"><span class="hljs-number">0xffffff</span></span>, <span class="hljs-number"><span class="hljs-number">0.75</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>), <span class="hljs-attr"><span class="hljs-attr">directionalLight</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.DirectionalLight(<span class="hljs-number"><span class="hljs-number">0xffffff</span></span>, <span class="hljs-number"><span class="hljs-number">0.5</span></span>) };</code> </pre><br>  The background is in the form of a sphere around the playing space with a picture stretched along the inner surface with borders of the same color for a seamless connection. <br>  Background <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> geomBG = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.SphereGeometry(<span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>), matBG = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshBasicMaterial({ <span class="hljs-attr"><span class="hljs-attr">map</span></span>: THREE.ImageUtils.loadTexture(<span class="hljs-string"><span class="hljs-string">'img/background5.jpg'</span></span>), }), worldBG = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Mesh(geomBG, matBG); worldBG.material.side = THREE.BackSide;</code> </pre><br><br><h5>  Classes </h5><br>  There are several main classes in the game: Game ( <code>DT.Game</code> ), Player ( <code>DT.Player</code> ), and Game Object ( <code>DT.GameObject</code> ).  They have their own methods (update, reset, etc.), called by the appropriate handlers in response to the triggering of an event.  The game object contains various parameters (speed, acceleration), constants (minimum distance between stones and information about their state ( <code>wasStarted</code> , <code>wasPaused</code> ). Player object contains information about the current state of the player (score, life, invulnerability), as well as the state of the player model (sphere, rings (contours, which are indicators of health) around the sphere.) All other objects are subclasses of the Game object (particles, shield on the player, bonuses). <br><br><h5>  Internal and external models </h5><br>  There are two types of models in the game: internal (simple) models (sphere, health indicator (rings / outlines), stones and coins), which are created using the three.js means and external (complex) models (bonuses and HTML5 shield around the sphere) are loaded in .obj format appropriate <a href="https://github.com/mrdoob/three.js/blob/master/examples%252Fwebgl_loader_obj.html">loader</a> . <br>  The sphere is part of the player‚Äôs object and consists of 2 objects: the physical sphere for calculating collisions with other objects (not added to the scene) <br>  Sphere <pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.sphere = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Mesh(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.SphereGeometry(<span class="hljs-number"><span class="hljs-number">0.5</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>, <span class="hljs-number"><span class="hljs-number">32</span></span>), <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshPhongMaterial({}));</code> </pre><br>  and a <a href="http://jeromeetienne.github.io/fireworks.js/">Fireworks-</a> based particle system for the <a href="http://jeromeetienne.github.io/fireworks.js/">Fireworks</a> particle system. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/68a/ef2/329/68aef23293410c5fc843d8300792f80e.png"><br><br>  Particle system <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.emitter = Fireworks.createEmitter({<span class="hljs-attr"><span class="hljs-attr">nParticles</span></span> : <span class="hljs-number"><span class="hljs-number">100</span></span>}) .effectsStackBuilder() .spawnerSteadyRate(<span class="hljs-number"><span class="hljs-number">30</span></span>) .position(Fireworks.createShapePoint(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) .velocity(Fireworks.createShapePoint(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>)) .lifeTime(<span class="hljs-number"><span class="hljs-number">0.2</span></span>, <span class="hljs-number"><span class="hljs-number">0.7</span></span>) .renderToThreejsParticleSystem({ ... }) .back() .start();</code> </pre><br>  Models of bonuses are loaded in the form of 2 objects each with the same number of vertices (also for transformation). <br><br><div class="spoiler">  <b class="spoiler_title">List of models</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.listOfModels = [{ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'bonusH1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scale</span></span>: <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotaion</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'bonusI'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scale</span></span>: <span class="hljs-number"><span class="hljs-number">0.02</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotaion</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-number"><span class="hljs-number">0x606060</span></span>, <span class="hljs-string"><span class="hljs-string">'5'</span></span>: <span class="hljs-number"><span class="hljs-number">0xffffff</span></span>, <span class="hljs-string"><span class="hljs-string">'html'</span></span>: <span class="hljs-number"><span class="hljs-number">0xffffff</span></span>, <span class="hljs-string"><span class="hljs-string">'orange'</span></span>: <span class="hljs-number"><span class="hljs-number">0xD0671F</span></span>, <span class="hljs-string"><span class="hljs-string">'shield'</span></span>: <span class="hljs-number"><span class="hljs-number">0xC35020</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'bonusE1'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scale</span></span>: <span class="hljs-number"><span class="hljs-number">0.75</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotaion</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-number"><span class="hljs-number">0x606060</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'bonusH2'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scale</span></span>: <span class="hljs-number"><span class="hljs-number">0.1</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotaion</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-number"><span class="hljs-number">0xff0000</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'shield'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scale</span></span>: <span class="hljs-number"><span class="hljs-number">0.16</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotaion</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-number"><span class="hljs-number">0x606060</span></span>, }, { <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">'bonusE2'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scale</span></span>: <span class="hljs-number"><span class="hljs-number">0.75</span></span>, <span class="hljs-attr"><span class="hljs-attr">rotaion</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>), <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-number"><span class="hljs-number">0x606060</span></span>, } ];</code> </pre></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Loader</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> manager = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.LoadingManager(), loader = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.OBJLoader(manager); manager.onProgress = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">item, loaded, total</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.info(<span class="hljs-string"><span class="hljs-string">'loaded item'</span></span>, loaded, <span class="hljs-string"><span class="hljs-string">'of'</span></span>, total, <span class="hljs-string"><span class="hljs-string">'('</span></span>+item+<span class="hljs-string"><span class="hljs-string">')'</span></span>); }; DT.listOfModels.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">el, i, a</span></span></span><span class="hljs-function">) </span></span>{ loader.load(<span class="hljs-string"><span class="hljs-string">'objects/'</span></span> + el.name + <span class="hljs-string"><span class="hljs-string">'.obj'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> object </span></span></span><span class="hljs-function">) </span></span>{ object.traverse( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> child </span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> color = el[child.name] || el.color; child.material = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.MeshPhongMaterial({ <span class="hljs-attr"><span class="hljs-attr">color</span></span>: color, <span class="hljs-attr"><span class="hljs-attr">shading</span></span>: THREE.SmoothShading, <span class="hljs-attr"><span class="hljs-attr">emissive</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Color(color).multiplyScalar(<span class="hljs-number"><span class="hljs-number">0.5</span></span>), <span class="hljs-attr"><span class="hljs-attr">shininess</span></span>: <span class="hljs-number"><span class="hljs-number">100</span></span>, }); }); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (i === <span class="hljs-number"><span class="hljs-number">1</span></span>) { a[i].object = object } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { a[i].object = object.children[<span class="hljs-number"><span class="hljs-number">0</span></span>]; } DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.trigger(<span class="hljs-string"><span class="hljs-string">'externalObjectLoaded'</span></span>, {<span class="hljs-attr"><span class="hljs-attr">index</span></span>: i}); }); });</code> </pre></div></div><br><br>  After loading, external models are available via the link <code>DT.listOfModels[index].object</code> and are used in the bonus constructor. <br><br><h5>  Transformations and postprocessing </h5><br>  The game has several transformations: for health indicators, for bonuses and a glitch effect (or a broken TV effect) at the end of the game. <br><br>  Health indicator and bonus transformations are based on <a href="http://threejs.org/examples/webgl_morphtargets_horse.html">morphTargets</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/0c5/174/380/0c5174380ad5941a4487e94f0548c560.png"><br><br>  When an object is created, the standard state is saved in the geometry of this object.  The remaining states will remain in the special property of the <code>morphTargets</code> geometry.  The current state of the object is determined by the level of the <code>morphTargetInfluences</code> object. <br><br>  The health indicator (rings / contours) around the sphere is 2 objects, the geometry of each of which consists of 180 vertices (60 from the inside and outside). <br><br>  Rings / contours can be circles, five-, four-, and triangles, while the number of vertices always remains 180. <br>  It is important that the number of vertices in each state is the same, and their coordinate vectors change ‚Äúcorrectly‚Äù (in accordance with the desired transformation), otherwise the transformation will not work correctly or will not work at all. <br><br>  To do this, a special function was written to create the geometry of the health indicator (rings / contours). <br><br><div class="spoiler">  <b class="spoiler_title">health indicator geometry</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.createGeometry = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">circumradius</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> geometry = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Geometry(), x, innerradius = circumradius * <span class="hljs-number"><span class="hljs-number">0.97</span></span>, n = <span class="hljs-number"><span class="hljs-number">60</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setMainVert</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">rad, numb</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vert = []; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; numb; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vec3 = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Vector3( rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin((<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI / numb) + (i * ((<span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI)/ numb))), rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos((<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI / numb) + (i * ((<span class="hljs-number"><span class="hljs-number">2</span></span> * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI)/ numb))), <span class="hljs-number"><span class="hljs-number">0</span></span> ); vert.push(vec3); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vert; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fillVert</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">vert</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nFilled, nUnfilled, result = []; nFilled = vert.length; nUnfilled = n/nFilled; vert.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">el, i, arr</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nextInd = i === arr.length - <span class="hljs-number"><span class="hljs-number">1</span></span> ? <span class="hljs-number"><span class="hljs-number">0</span></span> : i + <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> vec = el.clone().sub(arr[nextInd]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> j = <span class="hljs-number"><span class="hljs-number">0</span></span>; j &lt; nUnfilled; j++) { result.push(vec.clone().multiplyScalar(<span class="hljs-number"><span class="hljs-number">1</span></span>/nUnfilled).add(el)); } }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-comment"><span class="hljs-comment">// set morph targets [60, 5, 4, 3, 2].forEach(function (el, i, arr) { var vert, vertOuter, vertInner; vertOuter = fillVert(setMainVert(circumradius, el).slice(0)).slice(0); vertInner = fillVert(setMainVert(innerradius, el).slice(0)).slice(0); vert = vertOuter.concat(vertInner); geometry.morphTargets.push({name: 'vert'+i, vertices: vert}); if (i === 0) { geometry.vertices = vert.slice(0); } }); // Generate the faces of the n-gon. for (x = 0; x &lt; n; x++) { var next = x === n - 1 ? 0 : x + 1; geometry.faces.push(new THREE.Face3(x, next, x + n)); geometry.faces.push(new THREE.Face3(x + n, next, next + n)); } return geometry; };</span></span></code> </pre></div></div><br><br>  For the same reason, bonus models are imported as two .obj objects that were pre-modified in a certain way in the editor (as is necessary for the expected transformation animation (transformation). We used 3ds Max and blender for this. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/a7a/a11/f73/a7aa11f73fa6a75f9836f80df36d0ed1.png"><br><br>  With the lip model there is one interesting point.  In the normal state, the lips are animated (open and close).  When this happens, the force of influence of the vertices from two sets of vertices (open and closed lips) simply changes.  According to the <a href="">three.js documentation, the morphTargetInfluence</a> value of each vertex set must be in the range [0, 1].  In this case, when using force greater than 1, the effect of a certain ‚Äúhyper-influence‚Äù occurs.  So, for example, if you apply morphTargetInfluence with a value of 5 to the set of vertices for a cat model, the model seems to ‚Äúturn inside out‚Äù.  In a lip model, it looks like a ‚Äúmouth opening‚Äù. <br>  The absorption effect of the ‚Äúlip‚Äù bonus is based on this behavior, which made it possible to avoid importing an additional external model. <br>  The glitch effect (or the broken TV effect) used to animate the end of the game is an example of <a href="http://www.airtightinteractive.com/demos/js/badtvshader/">shader-based</a> post-processing. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c3a/d28/266/c3ad282665fdae4eeaed4e5fce021f21.png"><br><br>  Create effect <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.effectComposer = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.EffectComposer( DT.renderer ); DT.effectComposer.addPass( <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.RenderPass( DT.scene, DT.splineCamera ) ); DT.effectComposer.on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> badTVParams = { <span class="hljs-attr"><span class="hljs-attr">mute</span></span>:<span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">show</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-attr"><span class="hljs-attr">distortion</span></span>: <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">distortion2</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">speed</span></span>: <span class="hljs-number"><span class="hljs-number">0.3</span></span>, <span class="hljs-attr"><span class="hljs-attr">rollSpeed</span></span>: <span class="hljs-number"><span class="hljs-number">0.1</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> badTVPass = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.ShaderPass( THREE.BadTVShader ); badTVPass.on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; badTVPass.renderToScreen = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; DT.effectComposer.addPass(badTVPass);</code> </pre></div></div><br><br>  And render it every frame. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'update'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (DT.effectComposer.on) { badTVPass.uniforms[ <span class="hljs-string"><span class="hljs-string">"distortion"</span></span> ].value = badTVParams.distortion; badTVPass.uniforms[ <span class="hljs-string"><span class="hljs-string">"distortion2"</span></span> ].value = badTVParams.distortion2; badTVPass.uniforms[ <span class="hljs-string"><span class="hljs-string">"speed"</span></span> ].value = badTVParams.speed; badTVPass.uniforms[ <span class="hljs-string"><span class="hljs-string">"rollSpeed"</span></span> ].value = badTVParams.rollSpeed; DT.effectComposer.render(); badTVParams.distortion+=<span class="hljs-number"><span class="hljs-number">0.15</span></span>; badTVParams.distortion2+=<span class="hljs-number"><span class="hljs-number">0.05</span></span>; badTVParams.speed+=<span class="hljs-number"><span class="hljs-number">0.015</span></span>; badTVParams.rollSpeed+=<span class="hljs-number"><span class="hljs-number">0.005</span></span>; }; });</code> </pre></div></div><br><br>  Effect is activated after the occurrence of the <code>'gameOver'</code> <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'gameOver'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ DT.effectComposer.on = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; });</code> </pre></div></div><br><br>  And is reset at the corresponding event. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'resetGame'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ DT.effectComposer.on = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; badTVParams = { <span class="hljs-attr"><span class="hljs-attr">distortion</span></span>: <span class="hljs-number"><span class="hljs-number">3.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">distortion2</span></span>: <span class="hljs-number"><span class="hljs-number">1.0</span></span>, <span class="hljs-attr"><span class="hljs-attr">speed</span></span>: <span class="hljs-number"><span class="hljs-number">0.3</span></span>, <span class="hljs-attr"><span class="hljs-attr">rollSpeed</span></span>: <span class="hljs-number"><span class="hljs-number">0.1</span></span> } });</code> </pre></div></div><br><br>  The use of post-processing significantly increases the frame rendering time, so the post-processing is used for a short time and at the end of the game. <br><br><h5>  Music visualization </h5><br>  Music is visualized by the pulsation of particles (dust) in the playing space. <br><br>  For this, the desired visualization frequency was determined.  The presence level of the sound of the desired frequency ( <code>DT.audio.valueAudio</code> ) is currently defined in the render buffer as follows. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getFrequencyValue = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">frequency, bufferIndex</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!DT.isAudioCtxSupp) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nyquist = DT.audio.context.sampleRate/<span class="hljs-number"><span class="hljs-number">2</span></span>, index = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round(frequency/nyquist * freqDomain[bufferIndex].length); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> freqDomain[bufferIndex][index]; }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> visualize = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">index</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!DT.isAudioCtxSupp) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; freqDomain[index] = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(analysers[index].frequencyBinCount); analysers[index].getByteFrequencyData(freqDomain[index]); DT.audio.valueAudio = getFrequencyValue(DT.audio.frequency[index], index); };</code> </pre></div></div><br>  The <code>DT.audio.valueAudio</code> value <code>DT.audio.valueAudio</code> used to update the state of particle transparency: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'update'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ DT.dust.updateMaterial({ <span class="hljs-attr"><span class="hljs-attr">isFun</span></span>: DT.player.isFun, <span class="hljs-attr"><span class="hljs-attr">valueAudio</span></span>: DT.audio.valueAudio, <span class="hljs-attr"><span class="hljs-attr">color</span></span>: DT.player.sphere.material.color }); });</code> </pre></div></div><br>  The <code>updateMaterial</code> method <code>updateMaterial</code> : <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs">DT.Dust.prototype.updateMaterial = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">options</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.material.visible) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.material.visible = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.material.color = options.isFun ? options.color : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> THREE.Color().setRGB(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.material.opacity = <span class="hljs-number"><span class="hljs-number">0.5</span></span> + options.valueAudio/<span class="hljs-number"><span class="hljs-number">255</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; };</code> </pre></div></div><br>  Read more about the WebAudio API <a href="http://html5.by/blog/audio/">here</a> . <br><br><h5>  Favicon animation </h5><br>  Favicon in a digital trip is a black and white image of a cat by default. <br>  In deceleration mode (cat mode), the icon starts to change color. <br>  If you can put in Firefox <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">link</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">rel</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"icon"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"image/gif"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"fav.gif"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  then in Chrome this method will not work.  For Chrome, a dynamic substitution of the favicon png image was used. <br>  The overall implementation looks like this: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> favicon = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByTagName(<span class="hljs-string"><span class="hljs-string">'link'</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>], giffav = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'link'</span></span>), head = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementsByTagName(<span class="hljs-string"><span class="hljs-string">'head'</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>], isChrome = navigator.userAgent.indexOf(<span class="hljs-string"><span class="hljs-string">'Chrome'</span></span>) !== <span class="hljs-number"><span class="hljs-number">-1</span></span>; giffav.setAttribute(<span class="hljs-string"><span class="hljs-string">'rel'</span></span>, <span class="hljs-string"><span class="hljs-string">'icon'</span></span>); giffav.setAttribute(<span class="hljs-string"><span class="hljs-string">'type'</span></span>, <span class="hljs-string"><span class="hljs-string">'image/gif'</span></span>); giffav.setAttribute(<span class="hljs-string"><span class="hljs-string">'href'</span></span>, <span class="hljs-string"><span class="hljs-string">'img/fav.gif'</span></span>); DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'update'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isChrome &amp;&amp; DT.player.isFun &amp;&amp; DT.animate.id % <span class="hljs-number"><span class="hljs-number">10</span></span> === <span class="hljs-number"><span class="hljs-number">0</span></span>) favicon.setAttribute(<span class="hljs-string"><span class="hljs-string">'href'</span></span>, <span class="hljs-string"><span class="hljs-string">'img/'</span></span> + (DT.animate.id % <span class="hljs-number"><span class="hljs-number">18</span></span> + <span class="hljs-number"><span class="hljs-number">1</span></span>) + <span class="hljs-string"><span class="hljs-string">'.png'</span></span>); }); DT.$<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.on(<span class="hljs-string"><span class="hljs-string">'showFun'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e, data</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!data.isFun) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (isChrome) { favicon.setAttribute(<span class="hljs-string"><span class="hljs-string">'href'</span></span>, <span class="hljs-string"><span class="hljs-string">'img/0.png'</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $(giffav).remove(); head.appendChild(favicon); } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!isChrome) { $(favicon).remove(); head.appendChild(giffav); } } });</code> </pre></div></div><br>  <code>'update'</code> is the event of updating the state of objects, <code>'showFun'</code> is the event of the start of the seal mode (deceleration), <code>DT.player.isFun</code> is the state of the seal mode, <code>DT.animate.id</code> is the number of the current frame (frame).  The total number of possible favicon options is 19. Unfortunately, there is no favicon animation in Safari. <br><br><h4>  Mobile controller </h4><br>  The game has the ability to control a mobile device. <br>  To connect a mobile device as a controller, click on the link or use the QR code generated by the <a href="http://larsjung.de/qrcode/">plugin</a> . <br><br>  Control is performed using a gyro and the <code>'deviceOrientation'</code> event.  In the absence of a gyroscope or access to it, use the control by pressing the control buttons. <br><br>  Fallback and handler: <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">// Technique from Juriy Zaytsev // http://thinkweb2.com/projects/prototype/detecting-event-support-without-browser-sniffing/ var eventSupported = function( eventName ) { var el = document.createElement("div"); eventName = "on" + eventName; var isSupported = (eventName in el); if ( !isSupported ) { el.setAttribute(eventName, "return;"); isSupported = typeof el[eventName] === "function"; } el = null; return isSupported; }; // device orientation function orientationTest (event) { if (!turned &amp;&amp; event.gamma) turned = true; window.removeEventListener('deviceorientation', orientationTest, false); window.removeEventListener('MozOrientation', orientationTest, false); } window.addEventListener('deviceorientation', orientationTest, false); window.addEventListener('MozOrientation', orientationTest, false); setTimeout(function () { if (!turned) { $("#btnLeft").on('touchstart',function () { socket.emit("click", {"click":"toTheLeft"}); }); $("#btnRight").on('touchstart',function () { socket.emit("click", {"click":"toTheRight"}); }); $status.html("push buttons to control"); } else { $status.html("tilt your device to control"); } if (!eventSupported('touchstart')) { $status.html("sorry your device not supported"); } }, 1000);</span></span></code> </pre></div></div><br>  Testing support for <code>'deviceOrientation'</code> implemented via <code>setTimeout</code> , and not similar to <code>eventSupported</code> , since there are devices (for example, HTC One V) that support <code>'deviceOrientation'</code> nominally, but the event itself does not occur.  In fact, we are waiting for the occurrence of an event (which should definitely occur) for some period of time, and if it does not occur, we conclude that the event is not supported.  Such a check is actually a hack. <br><br>  For some phones (for example, HTC with Windows Phone) the standard browser (mobile IE) does not support the <code>'touchstart'</code> event, but supports the higher <code>'click'</code> event.  We refused to support such devices, since the response time when using the <code>'click'</code> event (300 ms) is much longer than that of the <code>'touchstart'</code> and it is not possible to provide the necessary level of response for monitoring using such devices. <br><br>  By the way, users of some models of Macbook Pro with HDD can use their laptop in this mode, as it has a gyroscope. <br><br>  For users of devices running Android 4.0 and above, there is a small bonus - the controller's reverse response in the form of vibration, if faced with a stone (vibration 100 ms) or pick up a coin (vibration 10 ms).  To do this, use the Vibration API (requires an updated standard browser, mobile Chrome or Firefox).  Read more about the Vibration API <a href="http://html5.by/blog/vibration-api/">here</a> . <br><br>  When controlling the tilt of the device, the user may not touch the screen for a long time, the device locks, the screen goes blank and the browser stops sending data from the gyroscope.  To prevent this behavior, a hack was used that represents an audio loop: a 10-second silent track that plays cyclically and starts when you press the buttons: start, restart, pause. <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audio</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"audioloop"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"../sounds/loop.mp3"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onended</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"this.play();"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">autobuffer</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">audio</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'#btnSphere'</span></span>).on(<span class="hljs-string"><span class="hljs-string">'touchstart'</span></span>,<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ socket.emit(<span class="hljs-string"><span class="hljs-string">'click'</span></span>, {<span class="hljs-string"><span class="hljs-string">'click'</span></span>:<span class="hljs-string"><span class="hljs-string">'pause'</span></span>}); $(<span class="hljs-string"><span class="hljs-string">'#audioloop'</span></span>).trigger(<span class="hljs-string"><span class="hljs-string">'play'</span></span>); });</code> </pre><br>  At the same time, on Android devices, the audio loop can be 1 second, and on iOS devices, a longer track is required.  In iOS, Safari does not lose track indefinitely, the number of cycles is about 100, so the track length of 10 seconds was chosen. <br><br><h4>  Webcam control </h4><br>  Webcam control is based on the <code>getUserMedia()</code> method. <br>  We looked at a few examples of control using a webcam.  One option is to press the virtual keys, as in this <a href="http://stemkoski.github.io/Three.js/Webcam-Motion-Detection-Texture.html">example</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/230/a38/d73/230a38d73c115c7f0de8e0fd3f3808de.png"><br><br>  We refused it because it was not accurate enough. <br><br>  Another option is to use the head inclination angle and <a href="https://github.com/auduno/headtrackr/">the headtrackr.js library</a> .  It turned out to be more interesting and helped stretch the neck and relieve tension, but the angle was not always determined correctly.  As a result, the head position and its movement relative to the middle of the screen (also with the help of headtrackr.js) are used to control using the webcam. <br><br>  This method of control is an order of magnitude more complicated than a keyboard or mobile, so the speed of the game in the webcam control mode is reduced. <br><br><h4>  Back-end </h4><br>  The game server runs on node.js.  The express, socket.io, mongoose, node-dogecoin, and hookshot modules are used. <br><br>  Everything is rather trivial: socket.io provides transport, express is responsible for routes and statics, and mongoose saves clients to the database.  Hookshot is used to quickly deploy changes to a VPS. <br><br><pre> <code class="javascript hljs">app.use(<span class="hljs-string"><span class="hljs-string">'/webhook'</span></span>, hookshot(<span class="hljs-string"><span class="hljs-string">'refs/heads/master'</span></span>, <span class="hljs-string"><span class="hljs-string">'git pull'</span></span>));</code> </pre><br>  The most interesting in the back-end is the interaction with the dogecoin daemon deployed on the same server.  This is a full-fledged dogecoin wallet, the interaction with which is carried out using the node-dogecoin module in the following way: <br><br><pre> <code class="javascript hljs">dogecoin.exec(<span class="hljs-string"><span class="hljs-string">'getbalance'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, balance</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err, balance); });</code> </pre><br>  In addition, the server checks the client for fraud.  Here the number of coins collected by the client is checked and compared with the maximum number of coins that can be collected during this session. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> checkCoins = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">timeStart, timeEnd, coinsCollect</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> time = (timeEnd - timeStart)/<span class="hljs-number"><span class="hljs-number">1000</span></span>, maxCoins = calcMaxCoins(time); <span class="hljs-comment"><span class="hljs-comment">// if client recieve more coins than it may return coinsCollect &lt;= maxCoins; }; var calcMaxCoins = function (time) { var speedStart = 1/60, acceleration = 1/2500, maxPath = 0, maxCoins = 0, t = 0.25, // coins position in the tube dt = 0.004, // coins position offset n = 10; // number of coins in a row maxPath = (speedStart + acceleration * Math.sqrt(time * 60)) * time; maxCoins = Math.floor(maxPath / (t + dt * (n - 1)) * n)/10; console.log('time:' + time, 'maxCoins:' + maxCoins, 'maxPath:' + maxPath); return maxCoins; };</span></span></code> </pre></div></div><br>        IP, c  UID (cookie)         IP. <br><div class="spoiler">  <b class="spoiler_title">Code</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> checkClient = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">clients, currentClient</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Handle clients from Array["</span></span> + clients.length + <span class="hljs-string"><span class="hljs-string">"]"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> IPpaymentsCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>, UIDpaymentsCounter = <span class="hljs-number"><span class="hljs-number">0</span></span>, IPtimeCounter = <span class="hljs-number"><span class="hljs-number">60</span></span> * <span class="hljs-number"><span class="hljs-number">1000</span></span>, checkup = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; clients.forEach(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">client, i</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.clientIp === currentClient.clientIp &amp;&amp; client.paymentRequest) { IPpaymentsCounter += client.paymentRequest; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (currentClient.timeEnd &amp;&amp; currentClient.cientId !== client.cientId) { <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.min(IPtimeCounter, currentClient.timeEnd - client.timeEnd); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.cookieUID === currentClient.cookieUID &amp;&amp; client.paymentRequest) { UIDpaymentsCounter += client.paymentRequest; } <span class="hljs-comment"><span class="hljs-comment">// console.log("handle client #" + i); }); console.log('IPtimeCounter', IPtimeCounter); if (currentClient.checkup === false || currentClient.maxCoinsCheck === false || IPpaymentsCounter &gt; 1000 || UIDpaymentsCounter &gt; 100 || IPtimeCounter &lt; 20 * 1000) { checkup = false; } else { checkup = true; } return checkup; };</span></span></code> </pre></div></div><br>   ,    . <br><br><h4>  Conclusion </h4><br>        ,       . ,    . <br><br>     GitHub,    <a href="https://github.com/htdt/digital_trip"></a> . <br><br> : <a href="https://github.com/htdt/digital_trip">  github</a> , <a href="http://hotdot.pro/ru/portfolio/trip/"> </a> , <a href="http://dt.htdt.ru/"></a> <br><br>    : <br><ul><li>  <a href="http://jquery.com/">jQuery</a> <br><ul><li> <a href="http://larsjung.de/qrcode/">jquery.qrcode</a> </li></ul><br></li><li>  <a href="http://threejs.org/">three.js</a> <br><ul><li> Detector </li><li> CurveExtras </li><li> OBJLoader </li><li> Stats </li></ul><br></li><li> <a href="http://www.threejsgames.com/extensions/">threex</a> ( ) <br><ul><li> windowresize </li><li> rendererstats </li><li> fullscreen </li></ul><br></li><li> <a href="https://github.com/auduno/headtrackr/">headtrackr.js</a> </li><li> <a href="http://yepnopejs.com/">yepnope.js</a> </li><li>  <a href="http://socket.io/">socket.io</a> </li><li> <a href="http://jeromeetienne.github.io/fireworks.js/">fireworks</a> ( ) </li><li> <a href="http://www.html5rocks.com/en/tutorials/webaudio/intro/">Web Audio BufferLoader</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/230323/">https://habr.com/ru/post/230323/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../230309/index.html">About overconsumption in copyright</a></li>
<li><a href="../230311/index.html">7 reasons for the failure of your Internet project</a></li>
<li><a href="../230313/index.html">Shop-Script 5 Review</a></li>
<li><a href="../230317/index.html">Evernote Web Clipper 6.2 Update for Chrome</a></li>
<li><a href="../230321/index.html">Startup Day at Odessa Innovation Week</a></li>
<li><a href="../230325/index.html">Full description of the game idea. Part 2: Form</a></li>
<li><a href="../230331/index.html">Tasker tutorials. Part 1: Add Your Team to Google Now</a></li>
<li><a href="../230333/index.html">WordPress Projects: Optimization Tips</a></li>
<li><a href="../230339/index.html">NSA employees are also having fun at work.</a></li>
<li><a href="../230341/index.html">Google has launched an API to monitor the data of its cloud services.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>