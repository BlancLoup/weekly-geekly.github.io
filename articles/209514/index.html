<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Porting C # LINQ to PHP</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="LINQ query functionality in C # is rewritten in PHP. Initially, the library was conceived as a training, since such libraries already exist, but then ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Porting C # LINQ to PHP</h1><div class="post__text post__text-html js-mediator-article">  LINQ query functionality in C # is rewritten in PHP.  Initially, the library was conceived as a training, since such libraries already exist, but then it was decided to publish it for everyone.  Copying LINQ to PHP one-to-one is impossible, since the capabilities of C # and PHP are very different.  A distinctive feature of the proposed solution is the orientation to iterators, lazy lambda expressions, and the signature of LINQ methods, identical to C # as far as possible.  All standard LINQ methods are naturally implemented.  A description of the project's capabilities with an explanation of the reasons why exactly this solution was chosen, under the cut. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfa/75e/622/dfa75e62299f8c590a32975534fb1d4a.png" alt="image"><a name="habracut"></a><br><br><h1>  Why LINQ? </h1>  New technologies are always interesting.  Why did they arise, what problems they solve, how do they solve?  LINQ (Language Integrated Query), an SQL-like query language for data sequences (arrays, database responses, collections), is one such chip.  For example, 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = from <span class="hljs-built_in"><span class="hljs-built_in">c</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> db.<span class="hljs-type"><span class="hljs-type">Customers</span></span> <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">Activity</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span> select new { <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">CompanyName</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">ItemID</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">ItemName</span></span> };</code> </pre> <br>  In C #, support for this syntax is built in at the language level, although in fact it is syntactic sugar, which is converted to the following form <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> q = db.<span class="hljs-type"><span class="hljs-type">Customers</span></span>. <span class="hljs-type"><span class="hljs-type">Where</span></span>((<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>) =&gt; <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">Activity</span></span> == <span class="hljs-number"><span class="hljs-number">1</span></span>). <span class="hljs-type"><span class="hljs-type">Select</span></span>((<span class="hljs-built_in"><span class="hljs-built_in">c</span></span>) =&gt; { <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">CompanyName</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">ItemID</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">c</span></span>.<span class="hljs-type"><span class="hljs-type">ItemName</span></span> });</code> </pre><br>  Here, the <code>Where</code> and <code>Select</code> functions are defined over data sequences, but the processing logic is defined for an individual element.  It is made in the spirit of functional programming - everything is a function and the result of calculating the function depends only on the input parameters.  The requirement for the purity of the functions allows a priori to eliminate errors due to side effects.  There are other advantages: <br><ul><li>  Since the order of processing is not important, processing over the set can be done in parallel. </li><li>  Instead of searching LINQ locally, queries can be folded (including partially) into ordinary SQL database queries.  Request externally remains the same. </li><li>  The processing logic of an individual element is isolated.  It can be reused for other collections or combined with others. </li></ul>  It would be nice to have the same tool in PHP.  It would be good, as in C #, without any extra computational overhead.  And although there are such libraries, each implements this functionality differently.  The reason is that the user-friendly implementation of LINQ draws on many of the features of C #, which in PHP are not in the right form and need to be imitated.  And then everyone has different tastes. <br><br><h1>  Why can not copy? </h1>  Let us list what features C # at first glance is not enough to copy the library in PHP. <br><ul><li>  <b>weak typing</b> .  It is rather an advantage. </li><li>  <b>no overloading methods.</b>  This is a consequence of the previous paragraph.  For example, if you need to compare strings, arrays and objects, then you need to write three different functions with the names <code>cmpString</code> , <code>cmpArray</code> , <code>cmpLaptop</code> or put if inside one big one.  Both solutions are bad.  In the first case, the type information in the name "clogs" the code where these functions are used.  In the second case, it is hard to expand the functionality. </li><li>  <b>no class extensions.</b>  You cannot write a method and call it as if it is a method of another class, that is, you cannot extend IEnumerable &lt;T&gt; by simply connecting your namespace.  But in PHP there is a magic __call method, through which you can call static methods implemented elsewhere.  The truth is to modify the desired class, and this is not always possible.  It is also worth forgetting about the support in the IDE. </li><li>  <b>no generators with a beautiful return yield (php &lt;5.5).</b>  On the one hand, it is syntactic sugar.  You can write a function that returns <code>\Iterator</code> , which by <code>next()</code> will call an anonymous function that will calculate the value of the next element and save its state in the class attributes.  But the size of the code will increase many times, and its useful share will fall.  Generators appeared in version 5.5, but we still have to wait until this version becomes popular. </li><li>  <b>No lambda expressions.</b>  These are such small anonymous functions, the functionality of which is limited, but the information about the structure is preserved.  It can be used to symbolically compute a function from a function or to export an expression to another language, say, SQL.  In PHP, you can write an anonymous function, but you will not have information about its structure and, accordingly, there will be no export to SQL. </li><li>  <b>No operator overload.</b>  It is also impossible to beautifully simulate lambda expressions by writing something like <code>$f = (Exp::x()+1) * 2</code> and overloading the addition and multiplication operations for the class returned by the <code>Exp::x()</code> method, the heir from <code>Closure</code> . </li></ul>  There are a lot of minor differences, such as the fact that the base classes for working with a collection in languages ‚Äã‚Äãare called differently ( <code>IEnumerator</code> became <code>Iterator</code> , <code>IEnumerable</code> became <code>IteratorAggregate</code> ), or that PHP has no arrays of methods, but this is easily solved. <br><br><h1>  <strike>What to do?</strike>  What is done </h1>  Before starting work, I didn‚Äôt really look for other solutions to write under the impression of C #, and not from other people's implementations.  The first version was written for a couple of evenings.  Then I transferred all the standard methods from MSDN for a long time, cut out the extra functionality, bringing the logic in accordance with .NET.  At the beginning of the year I compared the possibilities in other projects, reworked the code, published the project on github.  In developing the main emphasis was placed on the following points. <br><br><h2>  Iterators have everything and everything has iterators </h2><br>  Instead of complex loops, copying from an array to an array, the library works with iterators.  Before PHP 5.5, in order to process an iterator, you had to write a class that implements the interface <code>\Iterator</code> , and pass to it in the constructor the <code>\Iterator</code> being processed as an input parameter. <br><br><pre> <code class="php hljs">$data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \ArrayIterator([<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-number"><span class="hljs-number">3</span></span>]); $even = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> \CallbackFilterIterator($data, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($item)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $item % <span class="hljs-number"><span class="hljs-number">2</span></span> == <span class="hljs-number"><span class="hljs-number">0</span></span>; } );</code> </pre><br>  When reading data from the current iterator, data begins to stretch and be processed from the parent iterators.  The overhead of iterators seems to be minimal.  <a href="http://github.com/morgen2009/linq_php/tree/master/Qmaker/Iterators">More than 15 iterators have been</a> implemented for typical sequence processing tasks. <br><ul><li>  CallbackFilterIterator - element filtering </li><li>  CallbackIterator - generation of infinite sequence by function </li><li>  DistinctIterator - the issuance of unique elements </li><li>  ExceptIterator, IntersectIterator - subtraction, intersection of two sequences </li><li>  GroupingIterator - grouping by key </li><li>  IndexIterator - ordering items by key </li><li>  JoinIterator, OuterJoinIterator - strict, not strict binding of two sequences by key </li><li>  LimitIterator - output range range </li><li>  ProductIterator - cross-product multiple iterators </li><li>  ProjectionIterator - projection elements (keys) </li><li>  ReverseIterator - invert order </li><li>  SkipIterator - skipping elements while the condition is true </li><li>  TakeIterator - returning items while the condition is true </li><li>  LazyIterator is an abstract class.  The iterator is built at the first reading of the element. </li><li>  VariableIterator - parent iterator can change after iterator open </li></ul>  Iterators can be used independently of the rest of the LINQ functionality; they are even moved to a separate namespace. <br><br><h2>  Lazy calculations work too </h2><br>  If you pass anonymous functions as an expression in LINQ methods, this gives the greatest execution speed, beautiful lighting and the ability to refactor in the IDE, but information about the structure of the expression is lost.  It does not allow to reconstruct an expression in another programming language, say, SQL.  Unlike lambda expressions.  To solve this problem, many authors pass a string of valid PHP code as an ‚Äúexpression‚Äù.  The string is computed using eval for each element of the sequence and there is a possibility that it can be reformatted into another language, say, SQL.  Some come up with their own string format, for example <code>$x ==&gt; $x*$x</code> .  In this case, code highlighting and refactoring in the IDE are lost, the execution is long, the code is not cached and is not safe. <br><br>  The proposed library has created a tool that allows you to easily build complex expressions.  Information on the structure of the expression is not lost and can be subsequently reused.  The basis is the <code>ExpressionBuilder</code> class, which in streaming mode creates a calculation tree and exports it to the reverse Polish (postfix) entry.  For example, so <br><br><pre> <code class="php hljs">$exp = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExpressionBuilder(); $exp-&gt;add(<span class="hljs-number"><span class="hljs-number">1</span></span>); $exp-&gt;add(<span class="hljs-string"><span class="hljs-string">'+'</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); $exp-&gt;add(<span class="hljs-number"><span class="hljs-number">2</span></span>); $exp-&gt;export(); <span class="hljs-comment"><span class="hljs-comment">// [1, 2, 2, '+']</span></span></code> </pre><br>  Operation priorities and parentheses are supported.  The <code>Expression</code> class runs over the unloaded array and, if it encounters data, then throws it onto the stack, and if it encounters an object of type <code>OperationInterface</code> , it transfers control to it.  The object takes the required number of arguments from the stack, calculates the result and throws it back onto the stack.  At the end of the stack there is only one value - the result.  At a higher level, expressions are constructed using the <code>LambdaInstance</code> class and its <code>Lambda</code> decorator.  Examples of opportunities. <br><ol><li>  access to arguments, constants <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">/*   */</span></span> $f = Lambda::v(); $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $x; };</code> </pre></li><li>  mathematical operations, comparison operations, logical operations <br><pre> <code class="php hljs">$f = Lambda::v()-&gt;add()-&gt;v()-&gt;mult(<span class="hljs-number"><span class="hljs-number">12</span></span>)-&gt;gt(<span class="hljs-number"><span class="hljs-number">36</span></span>); $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $x + $x*<span class="hljs-number"><span class="hljs-number">12</span></span> &gt; <span class="hljs-number"><span class="hljs-number">36</span></span>; };</code> </pre></li><li>  parentheses <br><pre> <code class="php hljs">$f = Lambda::v()-&gt;mult()-&gt;begin()-&gt;c(<span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;add()-&gt;v()-&gt;end(); $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $x * (<span class="hljs-number"><span class="hljs-number">1</span></span> + $x); };</code> </pre></li><li>  string operations <br><pre> <code class="php hljs">$f = Lambda::v()-&gt;like(<span class="hljs-string"><span class="hljs-string">'hallo%'</span></span>);</code> </pre></li><li>  array generation <br><pre> <code class="php hljs">$f = Lambda::complex([ <span class="hljs-string"><span class="hljs-string">'a'</span></span>=&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span>=&gt;Lambda::v() ]); $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [ <span class="hljs-string"><span class="hljs-string">'a'</span></span> =&gt; <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'b'</span></span> =&gt; $x ]; };</code> </pre></li><li>  access to object properties and methods, array elements <br><pre> <code class="php hljs">$f = Lambda::v()-&gt;items(<span class="hljs-string"><span class="hljs-string">'car'</span></span>); $f = Lambda::v()-&gt;getCar(); $f = Lambda::car; $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $x-&gt;getCar(); };</code> </pre></li><li>  global function call <br><pre> <code class="php hljs">$f = Lambda::substr(Lambda::v(), <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>)-&gt;eq(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> substr($x,<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>) == <span class="hljs-string"><span class="hljs-string">'a'</span></span>; };</code> </pre></li><li>  LINQ methods for values <br><pre> <code class="php hljs">$f = Lambda::v()-&gt;linq()-&gt;where(Lambda::v()-&gt;gt(<span class="hljs-number"><span class="hljs-number">1</span></span>)); $f = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(\Iterator $x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CallbackFilterIterator($x, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($x)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $x &gt; <span class="hljs-number"><span class="hljs-number">1</span></span>; }); };</code> </pre></li></ol>  Of course, when calculating lambda expressions, additional side operations are performed additionally.  For the function <code>(x)=&gt;x+1</code> , the <code>Lambda</code> calculation speed is 15 times slower than a direct function call, and the structure itself requires 3600 bytes of storage to store against 800. It is planned to analyze with a profiler to figure out how to increase speed and reduce memory. <br><br><h2>  Meet on the interface, and escorted to the implementation </h2><br>  All LINQ methods are taken from the standard .NET 4.5 and scattered across the appropriate interfaces ( <code>GenerationInterface</code> , <code>FilteringInterface</code> , etc.) with a description from MSDN.  There were a lot of files, but the additional load on parsing files should not be large, especially if caching is enabled.  The method signature has remained as unchanged as possible, given the capabilities of PHP.  The <code>IEnumerable</code> interface inherits all of the mentioned interfaces and the <code>\IteratorAggregate</code> .  The <code>Linq</code> class implements <code>IEnumerable</code> interfaces for local iteration.  In the future, you can make another <code>IEnumerable</code> implementation, which will collect the SQL query or will be a facade to Doctrine.  Implemented the <a href="http://github.com/morgen2009/linq_php/tree/master/Qmaker/Linq/Operation">following methods</a> . <br><ul><li>  Aggregation - aggregate, average, min, max, sum, count </li><li>  Concatenation - concat, zip </li><li>  Element - elementAt, elementAtOrDefault, first, firstOrDefault, last, lastOrDefault, single, singleOrDefault </li><li>  Equality - isEqual </li><li>  Filtering - ofType, where </li><li>  Generation - from, range, repeat </li><li>  Grouping - groupBy </li><li>  Joining - product, join, joinOuter, groupJoin </li><li>  Partitioning - skip, skipWhile, take, takeWhile </li><li>  Projection - select, selectMany, cast </li><li>  Quantifier - all, any, contains </li><li>  Set - distinct, intersect, except, union </li><li>  Sorting - orderBy, orderByDescending, thenBy, thenByDescending, reverse, order </li><li>  Others - toArray, toList, each </li></ul>  If you need to specify a data source in the method, this can be an array ( <code>array</code> ), a function ( <code>callable</code> ) or an iterator ( <code>\Iterator</code> , <code>\IteratorAggregate</code> ).  Similarly, a string ( <code>string</code> ), a function ( <code>callable</code> ), an array ( <code>array</code> ), or a lambda expression ( <code>\LambdaInterface</code> ) can be passed as an expression.  Below are a few examples, there are also a variety of <a href="http://github.com/morgen2009/linq_php/tree/master/tests/Qmaker/Linq">unit tests</a> . <br><pre> <code class="hljs perl">// Grouping+Sorting+Filtering+array expression $x = Linq::from($cars)-&gt;group(Lambda::v()-&gt;getCategory()-&gt;getId())-&gt;<span class="hljs-keyword"><span class="hljs-keyword">select</span></span>([ <span class="hljs-string"><span class="hljs-string">'category'</span></span> =&gt; Lambda::i()-&gt;<span class="hljs-keyword"><span class="hljs-keyword">keys</span></span>(), <span class="hljs-string"><span class="hljs-string">'best'</span></span> =&gt; Lambda::v()-&gt;lin<span class="hljs-string"><span class="hljs-string">q()</span></span> -&gt;where(Lambda::v()-&gt;isActive()-&gt;e<span class="hljs-string"><span class="hljs-string">q(true)</span></span>) -&gt;orderBy(Lambda::v()-&gt;getPrice()) -&gt;<span class="hljs-keyword"><span class="hljs-keyword">last</span></span>() ]) // Set + LambdaInterface expression $x = Linq::from($cars)-&gt;distinct(Lambda::v()-&gt;getCategory()-&gt;getTitle()); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Set + string expression $x = Linq::from($cars)-&gt;distinct(<span class="hljs-string"><span class="hljs-string">'category.title'</span></span>); <span class="hljs-regexp"><span class="hljs-regexp">//</span></span> Generation+callable $fibonacci = function () { $position = <span class="hljs-number"><span class="hljs-number">0</span></span>; $f2 = <span class="hljs-number"><span class="hljs-number">0</span></span>; $f1 = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> function () <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> (&amp;$position, &amp;$f2, &amp;$f1) { $position++; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($position == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $f2; } elseif ($position == <span class="hljs-number"><span class="hljs-number">2</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $f1; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $f = $f1 + $f2; $f2 = $f1; $f1 = $f; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $f; } } } $x = Linq::from($fibonacci)-&gt;take(<span class="hljs-number"><span class="hljs-number">10</span></span>);</code> </pre><br><h2>  The function that returned the function, which returned the function that ... </h2><br>  Each LINQ method creates a <code>Linq</code> class object, to which an initializing anonymous function is passed and a link to other <code>Linq</code> objects, the iterators of which are input data for the initialization function.  Since <code>Linq</code> implements the <code>\IteratorAggregate</code> , when the first item is requested, the iterators are automatically initialized up the chain. <br><br><h1>  Why all this? </h1>  Thanks to everyone who read to the end.  The project was made to train the brain and hands, so any meaningful criticism is welcome at 200%.  I really wanted to share the work, which I was generally pleased with.  If it is really useful to anyone else, then it's generally wonderful. <br><br>  All code is documented, annotated, covered in tests and published on <a href="https://github.com/morgen2009/linq_php">github</a> under the BSD license (modified).  This is a fully working library. </div><p>Source: <a href="https://habr.com/ru/post/209514/">https://habr.com/ru/post/209514/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209504/index.html">Problems of forecasting financial markets</a></li>
<li><a href="../209506/index.html">Fast graphics output in Matlab</a></li>
<li><a href="../209508/index.html">Attempt to drain the client databases of BillManager users</a></li>
<li><a href="../209510/index.html">Monads in Scala</a></li>
<li><a href="../209512/index.html">Kepler equation: reboot</a></li>
<li><a href="../209516/index.html">Netavis Observer is a Linux based IP video surveillance software. Installation, configuration and small hacking</a></li>
<li><a href="../209520/index.html">dSort - put everything on the shelves</a></li>
<li><a href="../209524/index.html">Network programming for game developers. Part 2: receiving and transmitting data packets</a></li>
<li><a href="../209526/index.html">All about namespaces in yii1</a></li>
<li><a href="../209532/index.html">Basics of Scala. 5 hours of brain drain</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>