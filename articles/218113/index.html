<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>A thousand and one gif</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! 
 I would like to tell you the story of creating one simple entertainment service for recording gif'ok from a webcam using HTML5 and JS. About ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>A thousand and one gif</h1><div class="post__text post__text-html js-mediator-article">  Hello! <br>  I would like to tell you the story of creating one simple entertainment service for recording gif'ok from a webcam using HTML5 and JS.  About how a decision on the knee on the basis of open-source solutions overnight produced even if small, but a surge in the popularity of the wave from which for half a year have been brought by a small number of visitors who benefit from this service. <br><br><h5>  It all started just </h5><br>  At the end of summer, on a typical working day, surfing GitHub, I came across a rather interesting script ( <a href="https://github.com/hdragomir/facetogif">facetogif</a> ) on native JS and HTML5 that allows you to record videos from a webcam in a gif-animation.  Even a working demo was <a href="http://imgur.com/">added to uploading</a> ready-made videos to the <a href="http://imgur.com/">imgur</a> service or allowing you to save them immediately on the hard disk. <br>  This idea seemed to me very interesting and I decided to implement it in the form of an independent service with small modifications. <br>  No sooner said than done.  That evening I forked the repository, registered the domain ‚Äúvgif.rf‚Äù, raised the VPS (the cheapest tariff for $ 5) on DigitalOcean and wrote the simplest php script storing the videos right there on the server. <br>  To save resources on the server installed only Nginx and PHP-FPM. <br><a name="habracut"></a><br><br><img src="https://habrastorage.org/getpro/habr/post_images/f7e/1c1/dbb/f7e1c1dbbd92a383ad7cca78dc7d4c1b.png"><br>  <i>first version of the site</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The next morning, I shared a link to a newly-minted service to friends in <a href="http://bit.ly/1pOwjOh">one gated community</a> .  And the service was met well =) Gradually, in the intervals between work, I started doing some small things - I added sharing buttons on VK and Twitter, and also edited js so that you could make videos of only one size (for unification).  On the night of the same day, I realized that a domain in the zone of the Russian Federation is a rather bad idea and registered a more beautiful and interesting domain togif.me, on which the service is to this day. <br>  The long-awaited Saturday has come and since the morning I have decided to take up the site.  For a start, I made a big and beautiful manual with pictures and myself in the lead role, and then laid it out on the <a href="http://pikabu.ru/">Pikabu</a> entertainment website and waited for the minuses (there is a rating system similar to Reddit and Habr).  And then one by one comments began to appear, with pluses and pluses, and then I noticed that the free space on the VPS began to decrease gradually.  Late recollected himself with screwing Yandex. Metrics.  Late in the evening, she showed about 700 unique visitors.  At that time, there were about 500 comments on the post at Picaba.  Well, then someone kind posted a link to the service in a post on <a href="http://joyreactor.cc/">Joyreactor</a> and attendance increased again!  On Sunday, the metric counter froze at over 8 thousand visitors and 12 thousand views! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3a2/f07/714/3a2f077149d48bf2103128993a723692.png"><br><br><h5>  Technical details </h5><br>  And then I realized that I made one annoying mistake.  The video could be downloaded or downloaded, but when it was downloaded, the user was only given a boring direct link to the gif-file.  There was not enough catalog of downloaded videos so that you could not only record your own, but also look at other site visitors! <br>  It is time to rewrite the ‚Äúservice‚Äù which consisted of 1 static html page, 1 open source js and upload.php script. <br><br><h6>  Option 1 </h6><br>  Since the flow of visitors was not interrupted, and I wanted the directory here and now, I put on a simple MySQL database scheme, connected Idiorm to query OOD-style databases, wrote simple routings to display the pages of the directory and the images themselves, and added Disqus to comment on each video . <br>  Somewhere in the same period, I began to experiment with the compression of rollers and it turned out that imagemagick compresses each of them by at least 30%, or even 70% =) <br>  This is due to the fact that the videos are generated by js in the browser when each frame is shot separately and then they are added to the movie.  With this approach, the same parts of frames are repeated in each frame. <br><br>  During this time, the number of visitors melted smoothly (from 1,000 unique to 300 during September), but this didn‚Äôt bother me much.  the service was made purely for my own pleasure, and I was glad for every new recorded video.  It is very pleasant to realize that he did let something very simple and not quite his own, but useful. <br><br>  Then I decided to rewrite everything on the Yii Framework and it turned out: <br><br><h6>  Option 2 </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/8c8/840/3bd/8c88403bd897737c70cbc48b3e112bf4.png"><br><br>  <u>Innovations:</u> <br><ul><li>  tick for ‚Äúnon-public‚Äù clips (not displayed in the catalog) - storing new downloaded clips in <a href="http://selectel.ru/">Selectel storage</a> </li><li>  imagemagick thumbnails generation </li><li>  drawing on the rollers of the watermark with a link to the site (right during the recording) </li><li>  separate FAQ page </li><li>  counting the number of views of each video </li><li>  generating more secure links with a random number of characters and adding a date (instead of /image/4r32njfi3.gif, it was /2014/04/5e7eaed8bd.gif) </li><li>  the possibility of "mirroring" records </li></ul><br><br>  I transferred the storage of clips to selectel storage.  I wanted a faster return of files for end users.  I borrowed the ready php class from <a href="https://github.com/easmith/selectel-storage-php-class">Eugene Smith on GitHub</a> . <br><br>  For site recognition, it was decided to add a watermark to each recorded video clip.  And it would be desirable that even the video just saved from the browser already had it.  For this task, I decided to load user resources and this is what happened: <br><br><pre><code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recorder_fn</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ctx, gif, frames</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> coords = facetogif.recorderFrame(), drawW = facetogif.gifSettings.w, drawH = facetogif.gifSettings.h; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(facetogif.p_flag==<span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; facetogif.scale==<span class="hljs-number"><span class="hljs-number">1</span></span>) { ctx.translate(coords.w, <span class="hljs-number"><span class="hljs-number">0</span></span>); ctx.scale(<span class="hljs-number"><span class="hljs-number">-1</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (facetogif.video.src) { ctx.drawImage(facetogif.video, coords.x,coords.y, coords.w,coords.h); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (facetogif.scale==<span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">//    =) ctx.translate(coords.w, 0); ctx.scale(-1, 1); ctx.fillStyle = "white"; ctx.font = "normal 20px Arial"; ctx.textBaseline = 'top'; ctx.fillText("ToGIF.me", 220, 220); ctx.translate(coords.w, 0); ctx.scale(-1, 1); } else { //  begin ctx.fillStyle = "white"; ctx.font = "normal 20px Arial"; ctx.textBaseline = 'top'; ctx.fillText("ToGIF.me", 220, 220); //  end } var frame = ctx.getImageData(0,0, drawW,drawH); frames.push(frame); gif.addFrame(frame, {delay: facetogif.gifSettings.ms}); } else { clearInterval(recorder.interval); facetogif.recIndicator.classList.remove('on'); recorder.state = recorder.states.IDLE; } } }</span></span></code> </pre> <br><br>  Well, I added the mirroring of the rollers for the reason that if you record a video in normal mode, then on the video your right hand will become left and vice versa.  Therefore, for perfectionists, I added a similar mode. <br><br>  I began to generate more secure links to protect users from full downloading of archives by bluntly searching links because  Those who trusted me and uploaded private videos to the server should deserve protection.  For obvious reasons, I will not disclose the algorithm. <br><br>  During this time, the main site managed to move from VPS to DigitalOcean to a virtual cloud in Selectel, and the old videos remained in place and for the links of the form togif.me/image/xxx.gif automatic redirects started working on old.togif.me/image/xxx .gif <br><br>  Then, in the absence of significant advantages and higher cost of the solution ($ 5 + 300 rubles + 150 rubles every month) for the site, it was decided to start saving money. <br><br>  The new configuration includes - powerful shared hosting on the server and selectel storage for new clips.  For each portion in the 10Gb gif, I decided to create a separate subdomain, and for a set of this volume, I began to transfer them to shared hosting.  there is a lot of space, traffic is not limited and the rate of return is not so important because the videos are no longer new. <br>  Cloud storage with high speeds remains only for new videos that are given away and stored at high speeds.  Now the cost of the site about 200 rubles.  per month in principle tolerable. <br><br>  <u>Current technology stack:</u> <br>  Nginx, Imagemagick, HTML5, JS, PHP, Yii, MySQL <br><br>  <u>Unsolved problems:</u> <br><ul><li>  Movie recording does not work in Safari </li><li>  recording does not work in Iphone, Ipad </li></ul><br><br>  <u>Some statistics:</u> <br><ul><li>  Starting the service - 08.22.13 </li><li>  Traffic for this period - ~ 1Tb </li><li>  Uploaded clips - ~ 15000 </li><li>  Unique visitors - ~ 80 000 </li></ul><br><br>  <u>Findings:</u> <br><ul><li>  For some heavy operations, sometimes you can load client computers and client JS in this case is a lifeline </li><li>  For heavy operations on the server, it is advisable to use something more productive than php.  Images for example are optimized by the convert utility. </li><li>  Yii shows pretty high speed even without built-in caching, but you need to include settings for production mode </li><li>  Flash is gradually leaving, but there are still a lot of devices and programs that do not support the newfangled features of HTML5 </li></ul><br><br>  This is how using open source solutions you can make a rather interesting and useful project for people, which, even if without profit, continues to please someone without much expense. </div><p>Source: <a href="https://habr.com/ru/post/218113/">https://habr.com/ru/post/218113/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../218099/index.html">Amazon introduced set-top box Amazon Fire TV</a></li>
<li><a href="../218103/index.html">Hubble eXtreme Deep Field: A small journey of 13 billion light years</a></li>
<li><a href="../218105/index.html">Overview of the Highscreen Zera F smartphone: "skit" from the flagships for 3,990 rubles</a></li>
<li><a href="../218107/index.html">Windows 8 on Intel Galileo now, for free already in the plans of Microsoft!</a></li>
<li><a href="../218109/index.html">Tame ZoG (Part 5: Mana Collection)</a></li>
<li><a href="../218115/index.html">Run Windows Server 2012R2 from a VHDX file from a USB disk through UEFI</a></li>
<li><a href="../218119/index.html">What is a switch and how to deal with it?</a></li>
<li><a href="../218121/index.html">How to write a "skorochitku" for iOS in half an hour</a></li>
<li><a href="../218123/index.html">Unity 3D Web Player on Linux via Pipelight</a></li>
<li><a href="../218125/index.html">dub: dependency manager for D language</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>