<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reducing the size of the docker image with the spring boot application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. 


 Recently, I faced the task of launching spring boot 2 applications in a kubernetes cluster using a docker image. This problem is not new...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reducing the size of the docker image with the spring boot application</h1><div class="post__text post__text-html js-mediator-article"><p>  Good day. </p><br><p>  Recently, I faced the task of launching spring boot 2 applications in a kubernetes cluster using a docker image.  This problem is not new, I quickly found examples in Google and packed my application.  I was very surprised not to find an alpine image for jdk11 and hoped that slim would be quite small, but the moment of sending the image to the docker registry, I noticed that its size was almost 422 megabytes.  Under the cut, a description of how I reduced the docker image with my spring boot and java 11 to 144 megabytes. </p><br><p><img src="https://habrastorage.org/webt/zx/nk/bg/zxnkbgwnb8bdpshj6q1mypq6z0q.png"></p><a name="habracut"></a><br><h2 id="prilozhenie">  application </h2><br><p>  As I mentioned earlier, my application was built using spring boot 2 and is a REST API wrapper over a relational database (using @RepositoryRestResource).  My dependencies include: </p><br><pre><code class="plaintext hljs">org.springframework.boot:spring-boot-starter-data-rest org.springframework.boot:spring-boot-starter-data-jpa org.flywaydb:flyway-core org.postgresql:postgresql</code> </pre> <br><p>  The jar file compiled has a size of 37.6 megabytes. </p><br><p>  Dockerfile: </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim WORKDIR /home/demo ARG REVISION COPY target/spring-boot-app-${REVISION}.jar app.jar ENTRYPOINT ["java","-jar","app.jar"]</code> </pre> <br><p>  As a result of the build, I get an image size of 422 mb according to the output of the docker images command.  It is interesting that when using the outdated 8-jdk-slim image, the size is reduced to 306 mb. </p><br><h2 id="popytka-1-drugoy-bazovyy-obraz">  Attempt 1: another basic image </h2><br><p>  The first logical step was an attempt to find a more lightweight image, preferably on the basis of alpine.  I scanned to the most popular repositories with Java: </p><br><ul><li>  <a href="https://hub.docker.com/_/openjdk">https://hub.docker.com/_/openjdk</a> </li><li>  <a href="https://hub.docker.com/r/adoptopenjdk/openjdk11">https://hub.docker.com/r/adoptopenjdk/openjdk11</a> </li><li>  <a href="https://hub.docker.com/r/adoptopenjdk/openjdk11-openj9">https://hub.docker.com/r/adoptopenjdk/openjdk11-openj9</a> </li><li>  <a href="https://hub.docker.com/r/adoptopenjdk/openjdk8">https://hub.docker.com/r/adoptopenjdk/openjdk8</a> </li></ul><br><p>  (11 as the current LTS release and 8 as there are still a sufficient number of applications that could not migrate to more modern versions) </p><br><p>  A table with images and tags (~ 2700), their size at the time of this writing is available <a href="">here.</a> </p><br><p>  Here are some of them: </p><br><pre> <code class="plaintext hljs">openjdk 8 488MB openjdk 8-slim 269MB openjdk 8-alpine 105MB openjdk 8-jdk-slim 269MB openjdk 8-jdk-alpine 105MB openjdk 8-jre 246MB openjdk 8-jre-slim 168MB openjdk 8-jre-alpine 84.9MB openjdk 11 604MB openjdk 11-slim 384MB openjdk 11-jdk 604MB openjdk 11-jdk-slim 384MB openjdk 11-jre 479MB openjdk 11-jre-slim 273MB adoptopenjdk/openjdk8 alpine 221MB adoptopenjdk/openjdk8 alpine-slim 89.7MB adoptopenjdk/openjdk8 jre 200MB adoptopenjdk/openjdk8 alpine-jre 121MB adoptopenjdk/openjdk11 alpine 337MB adoptopenjdk/openjdk11 alpine-slim 246MB adoptopenjdk/openjdk11 jre 218MB adoptopenjdk/openjdk11 alpine-jre 140MB</code> </pre> <br><p>  Thus, if you change the base image on adoptopenjdk / openjdk11: alpine-jre, you can reduce the image with the application to 177 mb. </p><br><h2 id="popytka-2-custom-runtime">  Attempt 2: custom runtime </h2><br><p>  Since the release of jdk9 and modularization, it has become possible to build your own runtime that contains only those modules that your application needs.  More details about this functionality can be found <a href="https://docs.oracle.com/javase/9/tools/jlink.htm">here</a> . </p><br><p>  Let's try to identify the necessary modules for the test spring boot application: </p><br><pre> <code class="plaintext hljs">~/app ·êÖ jdeps -s target/app-1.0.0.jar app-1.0.0.jar -&gt; java.base app-1.0.0.jar -&gt; java.logging app-1.0.0.jar -&gt; not found</code> </pre> <br><p>  Okay, it seems that jdeps can't handle the fat jar created using spring boot, but we can unpack the archive and set the classpath: </p><br><pre> <code class="plaintext hljs">~/app ·êÖ jdeps -s -cp target/app-1.0.0/BOOT-INF/lib/*.jar target/app-1.0.0.jar.original Error: byte-buddy-1.9.12.jar is a multi-release jar file but --multi-release option is not set ~/app ·êÖ jdeps -s --multi-release 11 -cp target/app-1.0.0/BOOT-INF/lib/*.jar target/app-1.0.0.jar.original Error: aspectjweaver-1.9.2.jar is not a multi-release jar file but --multi-release option is set</code> </pre> <br><p>  On this occasion, the bug is currently open: <a href="https://bugs.openjdk.java.net/browse/JDK-8207162">https://bugs.openjdk.java.net/browse/JDK-8207162</a> </p><br><p>  I tried to download jdk12 to get this information, but I encountered the following error: </p><br><pre> <code class="plaintext hljs">Exception in thread "main" com.sun.tools.classfile.Dependencies$ClassFileError ... Caused by: com.sun.tools.classfile.ConstantPool$InvalidEntry: unexpected tag at #1: 53</code> </pre> <br><p>  By trial, error, and module search by ClassNotFoundException, I determined that my application needed the following modules: </p><br><ul><li>  java.base </li><li>  java.logging </li><li>  java.sql </li><li>  java.naming </li><li>  java.management </li><li>  java.instrument </li><li>  java.desktop </li><li>  java.security.jgss </li></ul><br><p>  Rantym for them can be collected using: </p><br><pre> <code class="plaintext hljs">jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,java.logging,java.sql,java.naming,java.management,java.instrument,java.desktop,java.security.jgss --output /usr/lib/jvm/spring-boot-runtime</code> </pre> <br><p>  Let's try to build a basic docker image using this module: </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim RUN jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,java.logging,java.sql,java.naming,java.management,java.instrument,java.desktop,java.security.jgss --output /usr/lib/jvm/spring-boot-runtime FROM debian:stretch-slim COPY --from=0 /usr/lib/jvm/spring-boot-runtime /usr/lib/jvm/spring-boot-runtime RUN ln -s /usr/lib/jvm/spring-boot-runtime/bin/java /usr/bin/java</code> </pre> <br><p>  and collect it: </p><br><pre> <code class="plaintext hljs">docker build . -t spring-boot-runtime:openjdk-11-slim</code> </pre> <br><p>  As a result, the size was 106 megabytes, which is significantly less than the majority of found base images with openjdk.  If you use it for my application, then the resulting size will be 144 megabytes. </p><br><p>  Next, we can use <code>spring-boot-runtime:openjdk-11-slim</code> as the base image for all spring boot applications if they have similar dependencies.  In the case of various dependencies, it is possible to use the multistage image assembly for each of the applications where the java runtime will be assembled at the first stage, and the archive with the application is added at the second stage. </p><br><pre> <code class="plaintext hljs">FROM openjdk:11-jdk-slim RUN jlink --no-header-files --no-man-pages --compress=2 --strip-debug --add-modules java.base,YOUR_MODULES --output /usr/lib/jvm/spring-boot-runtime FROM debian:stretch-slim COPY --from=0 /usr/lib/jvm/spring-boot-runtime /usr/lib/jvm/spring-boot-runtime WORKDIR /home/demo ARG REVISION COPY target/app-${REVISION}.jar app.jar ENTRYPOINT ["/usr/lib/jvm/spring-boot-runtime/bin/java","-jar","app.jar"]</code> </pre> <br><h2 id="vyvod">  Conclusion </h2><br><p>  Currently, most docker images for java are quite large, which can negatively affect the start time of the application, especially if the required layers are not already on the server.  Using tags with jre or using the modularization of java, you can build your own runtime, which will significantly reduce the size of the application image. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/457476/">https://habr.com/ru/post/457476/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../457462/index.html">Uber: Overview of the main platform control algorithms</a></li>
<li><a href="../457464/index.html">Deduplication of ads on Yandex. Real Estate</a></li>
<li><a href="../457466/index.html">How we developed IT in Leroy Merlin: engine reassembly on the move</a></li>
<li><a href="../457468/index.html">Universal memory: SRAM, DRAM and flash memory in one bottle</a></li>
<li><a href="../457470/index.html">Leaf math: how one unusual bush changed the equation of a plant growth model</a></li>
<li><a href="../457480/index.html">Creating a listening application for viewing mobile MMORPG traffic</a></li>
<li><a href="../457490/index.html">Aysioshechka from Zuckerberg - briefly and in the Libra case</a></li>
<li><a href="../457494/index.html">‚ÄúAnd if I don‚Äôt know math, am I hopeless?‚Äù - experts answer frequently asked questions about the professions in Data Science</a></li>
<li><a href="../457496/index.html">"Find the five differences." Scalable Generation Difference - New Test Portion</a></li>
<li><a href="../4575/index.html">Monster.com told Runet the first "boo"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>