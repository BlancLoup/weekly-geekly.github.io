<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Unit-testing screenshots: break the sound barrier. Decryption report</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is fashionable to test the layout recourse with screenshots, this will not surprise anyone. We have long wanted to introduce this type of testing a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Unit-testing screenshots: break the sound barrier. Decryption report</h1><div class="post__text post__text-html js-mediator-article"><p>  It is fashionable to test the layout recourse with screenshots, this will not surprise anyone.  We have long wanted to introduce this type of testing at home.  All the time confused questions of ease of support and application, but to a greater extent - the bandwidth of solutions.  I wanted it to be something easy to use and quick to use.  Ready solutions did not fit, and we undertook to make our own. </p><br><p>  Under the cut, we‚Äôll tell you what came out of it, what tasks were solved, and how we achieved that screening testing practically didn‚Äôt affect the total test time.  This post is a transcript of the report that sounded at <a href="https://holyjs-moscow.ru/">HolyJS 2017 Moscow</a> .  You can watch the video <a href="https://www.youtube.com/watch%3Fv%3DULwdj_Vr_WA%26index%3D1%26list%3DPLf0s9ihTnfHyGOoQ_7Urte2lBRrJzqRqa">by the link</a> , and read and watch the slides on. </p><br><p><img src="https://habrastorage.org/webt/qf/5f/bm/qf5fbmtprfkhvfrlakihvaaygwi.jpeg"></p><a name="habracut"></a><br><p>  Hello everyone, my name is Roman.  I work in Avito.  I do many things, including open-source, the author of several projects: <a href="https://github.com/csstree/csstree">CSSTree</a> , <a href="https://github.com/basisjs/basisjs">basis.js</a> , <a href="https://github.com/rempl/rempl">rempl</a> , <a href="https://github.com/css/csso">CSSO Maintainer</a> and <a href="https://github.com/lahmatiy">others</a> . </p><br><p>  Today I will talk about unit testing with screenshots.  This report is a story about the search for engineering solutions.  I will not give recipes for all occasions.  But I will share the direction of thought: where to go to make everything good. </p><br><p>  Bicycles are not always bad.  Those who know me, remember that I often try to do something new, despite the fact that there are a lot of things ready.  What does this lead to?  If you do not give up, you can find solutions, and not at all where you were looking for them. </p><br><p>  Since we have a screenshots theme today, I‚Äôll say that you can speed up testing not only by optimizing the code.  The problem can not only be in it.  And experimenting, you can get interesting moves and solutions. </p><br><p>  Modern front-tenders usually come up with NPM when they encounter a problem, try StackOverflow and try to use ready-made solutions.  But not always npm install can help.  ‚ÄúThe spirit of adventurism has disappeared in us‚Äù: we rarely try to do something on our own, dig deep. </p><br><p><img src="https://habrastorage.org/webt/1m/zr/qe/1mzrqeo_sp_58-sgqktlt-78ozc.png"></p><br><p>  We will fix it. </p><br><h1 id="unit-testirovanie-instrumenty">  Unit Testing: Tools </h1><br><p>  Testing can be different: unit, functional, integration ... In this report, I will talk about unit testing of components or some blocks that we want to test for layout regression. </p><br><p>  We wanted to deal with this topic for a long time, but everyone didn‚Äôt get a hand.  We needed such a solution to make it simple, cheap and fast. </p><br><p>  What are the options? </p><br><ul><li>  Ready services; </li><li>  Finished tools, for example Gemini; </li><li>  You can write your own. </li></ul><br><p>  Services do not suit us for certain reasons: we do not want to use external services, we want everything to be inside. </p><br><p>  What about the finished tools?  They are, there are several of them, but they are usually focused on walking through the urls and ‚Äúclicking‚Äù certain blocks.  This did not quite suit us - we wanted to test exactly the components and blocks, their state, making screenshots. </p><br><p>  There is a <a href="https://github.com/gemini-testing/gemini">Gemini</a> tool from Yandex, a good thing, but it looks like a spaceship.  It is difficult to start, configure, you have to write a lot of code.  Perhaps this is not a problem.  But for me the problem was that by taking a simple test from the readme, copying it a hundred times, I got this figure: 100 images of 282x200 are checked for about two minutes.  It is too long. </p><br><p>  As a result, they began to make their own.  About this will be today's report.  I'll run ahead: I'll show you what we did. </p><br><p><img src="https://habrastorage.org/webt/ro/-u/tw/ro-utwfhqkac_ahezhpqtjtecl4.png"></p><br><p> So, having a certain component markup test on React, we add one line in which we take a screenshot and call the "magic" method <code>toMatchSnapshotImage()</code> .  That is, one additional line in the test - and we among other things check the status of the component with a screenshot. </p><br><p>  In figures: if two identical screenshots of 800x600 are compared, then, in our solution, the comparison takes about 0 ms.  If the screenshots are slightly different, and you need to count the pixels that are different, it takes about 100 ms.  Updating screenshots, getting pictures when we initialize the ‚Äúbase‚Äù of reference screenshots, takes about 25 ms per screenshot.  A lot or a little - see later. </p><br><p>  If we make our own decision, which is able to take a screenshot from the current markup and compare it with the standard, what needs to be done to do this?  First, get a static markup of the component with the necessary styles and resources, load it all into a browser, take a screenshot and compare it with a reference screenshot.  Not so difficult. </p><br><p><img src="https://habrastorage.org/webt/cn/x6/3m/cnx63mz_bje5qcntoa3gtdwlv4g.png"></p><br><h1 id="generaciya-razmetki">  Markup generation </h1><br><p>  Let's start by generating the markup.  It is divided into several steps.  First, generate the HTML component.  Then we determine which dependent parts there are: which styles he uses, which images he needs, and so on.  We are trying to collect all this into a single HTML document that does not contain references to local resources or files. </p><br><h2 id="generaciya-html">  HTML generation </h2><br><p>  HTML generation is highly dependent on the stack you are using.  In our case, this is React.  Take the ready-made <a href="https://www.npmjs.com/package/react-dom">react-dom / server</a> library that allows you to generate a static string, the same HTML that we need. </p><br><p><img src="https://habrastorage.org/webt/vt/ar/cx/vtarcxtfd3mal3tf-4dqgr2nmwc.png"></p><br><p>  That is, we connect <code>react-dom/server</code> , we call the <code>renderToStaticMarkup()</code> method - we get HTML. </p><br><h2 id="generaciya-css">  CSS generation </h2><br><p>  Go ahead: Generate CSS.  We already have HTML, but most likely there are still a lot of styles and other resources.  All this needs to be collected.  What is the action plan here?  First, you need to find the files that are connected and used in the components.  And convert CSS files so that they do not contain links to resources.  That is, to find links to resources and zainlaynit them in the CSS itself.  Then it's all glue. </p><br><p>  The solution, again, depends on the stack.  In our case, we use <a href="https://facebook.github.io/jest/">Jest</a> as a test runner, <a href="https://babeljs.io/">Babel</a> to convert JavaScript and <a href="https://github.com/css-modules/css-modules">CSS Modules</a> to describe styles. </p><br><p>  First we do a search for CSS files. </p><br><p><img src="https://habrastorage.org/webt/bs/u2/5o/bsu25o5oiyrgz4tauwajowwojfu.png"></p><br><p>  CSS Modules means that CSS is connected in JavaScript as a normal module, that is, either <code>import</code> or <code>require()</code> . </p><br><p>  Technically, you need to intercept all such calls and convert them so as to save the paths that were requested. </p><br><p>  To do this, we wrote a plugin for Babel.  Jest has the ability to customize the transformation of JavaScript (perhaps you are already doing this if you use Jest).  Using the <code>transform</code> setting, scripts are added to transform the resources that match the rule.  In our case, we need JavaScript files. </p><br><p><img src="https://habrastorage.org/webt/kr/zv/sf/krzvsfn4xpukxd79krq6gjvc8n0.png"></p><br><p>  The script creates a transformer using <code>babel-jest</code> .  To other settings, we need to add our own plugin that will do the necessary. </p><br><p><img src="https://habrastorage.org/webt/zn/-h/st/zn-hstzemnllba0tugxhgropu6y.png"></p><br><p>  The task of the plugin consists of two parts.  First, a search is made for all <code>import</code> that are <code>require()</code> to <code>require()</code> , so that it is easier then to look for CSS connections.  After that, all <code>require()</code> are replaced with a special function: </p><br><p><img src="https://habrastorage.org/webt/av/k2/1k/avk21k1ioyfpslko7qqezfydfru.png"></p><br><p>  This function initializes the global array to store the paths, adds new paths to this array, and returns the original export that was replaced.  <a href="https://gist.github.com/lahmatiy/d68e91a507cc03f76eafab75a3d81582">The plugin code</a> is 52 lines.  The solution can be simplified, but so far it has not been necessary. </p><br><p>  At the time of generating the HTML markup component in the array <code>includedCssModules</code> will be all the paths that were requested through <code>require()</code> .  All we have to do is convert the paths into the content of these files. </p><br><h1 id="obrabotka-css">  CSS processing </h1><br><p>  At this stage, we need to bypass all the CSS files, find links to resources in them and zainlaynit them.  We also need to turn off the dynamics: if you use animation or some dynamic parts, the result may be different, a screenshot can be made at an unpredictable moment. </p><br><h2 id="inlayn-resursov">  Inline resources </h2><br><p>  To zainlaynit resources, we wrote another plugin.  (You can use ready-made, but in this case it turned out to be easier to write your own). </p><br><p><img src="https://habrastorage.org/webt/oc/vt/sg/ocvtsg_oppewry_iwnpnybwfiq4.png"></p><br><p>  How does all this look?  Remember we added a plugin to <code>jest-transform</code> ?  Here is the same story, only we use a special plugin for CSS Modules, namely <a href="https://www.npmjs.com/package/babel-plugin-css-modules-transform"><code>css-modules-transform</code></a> for <code>babel-jest</code> , which has the ability to customize CSS preprocessing: some script that will convert CSS before it is used. </p><br><p>  So, add the path to our plugin in <code>processCss</code> and write the plugin itself.  It uses the <a href="https://github.com/csstree/csstree">CSSTree</a> parser.  The point is not only that I am its author;) - it is fast, detailed and allows, for example, to search for ways and urles without complex <code>RegExp</code> 's.  It is also tolerant of errors: if there are incomprehensible parts in CSS, then nothing will break, just these parts will remain unassembled.  But this rarely happens. </p><br><p><img src="https://habrastorage.org/webt/hu/-q/uf/hu-quf675t6h5me_mhdq2tyueym.png"></p><br><p>  The plugin searches urls in CSS and replaces them with inline resources. </p><br><p>  What's going on here?  In the first line we get AST, that is, we parse the CSS string into the tree.  Next we go around this tree, find the nodes of the <code>Url</code> type, select a value from them and use it as the path to the file that needs to be zainlaynit.  In the end, simply call <code>translate</code> , that is, transform the transformed tree back into a string. </p><br><p><img src="https://habrastorage.org/webt/8k/dd/qb/8kddqb2we-4k2gynkgl8bbmuhl4.png"></p><br><p>  The implementation of inline resources is not as difficult as it may seem: </p><br><ul><li>  take the URI, resolve it relative to the CSS file in which it is used (because the paths are relative); </li><li>  read binary data from a file; </li><li>  computed by extension mime type; </li><li>  generate the resource URI of the resource. </li></ul><br><p>  Everything!  We zainlaynili resources.  The functions described are 26 lines of code that do everything necessary. </p><br><p>  What else might be useful to write your own solution: we can expand it, for example, later we added the conversion of animated GIF to static images.  But more on that later. </p><br><h1 id="izbavlyaemsya-ot-dinamiki">  Getting rid of the dynamics </h1><br><p>  The next step we need to get rid of the dynamics.  How to freeze an animation and where does it happen? </p><br><p>  Dynamics appears in: </p><br><ul><li>  CSS Transitions; </li><li>  CSS Animations; </li><li>  a carriage in the input fields that flashes and may disappear or appear at any time; </li><li>  animated gif and a number of other moments. </li></ul><br><p>  Let's try to ‚Äúshut off‚Äù all this so that the same result is always obtained. </p><br><h2 id="css-transition">  CSS Transition </h2><br><p>  Zero all <code>transitions-delay</code> and <code>transition-duration</code> . </p><br><p><img src="https://habrastorage.org/webt/cf/zy/gd/cfzygd8qlgvm6hfptwlxgeolmpg.png"></p><br><p>  In this case, all <code>transition</code> will be guaranteed to be in the final state. </p><br><h2 id="css-animation">  CSS Animation </h2><br><p>  We do the same with CSS animations. </p><br><p><img src="https://habrastorage.org/webt/v9/dv/qu/v9dvqujnyze2c4azhmyays60kog.png"></p><br><p>  Here you can see this hack: </p><br><p><img src="https://habrastorage.org/webt/9b/xg/01/9bxg01mvp-59fmo4mmzzwnqwie0.png"></p><br><p>  Note the value of the <code>animation-delay: ‚Äì0.0001s</code> .  The fact is that without this in Safari, animations will not have a final state. </p><br><p>  One last thing: we drove the animation to the end (final state), but the animations are different from the transitions in that they can be repeated.  Therefore, we pause the state of the animation by setting the <code>animation-play-state</code> to <code>paused</code> .  Thus, the animations are paused, that is, they stop playing. </p><br><p><img src="https://habrastorage.org/webt/0c/kj/j7/0ckjj7jvzxbkrkgj6fnyzfrzqtc.png"></p><br><h2 id="karetka">  Carriage </h2><br><p>  The next moment is a carriage in the fields.  The problem is that it flashes: at some point we see a vertical line, at some point - no.  This may affect the resulting screenshot. </p><br><p>  In recent months, a property called <code>caret-color</code> appeared in browsers: first in Chrome, then in Firefox and Safari (Technology Preview).  To ‚Äúturn off‚Äù the carriage, we can make it transparent (set the color to <code>transparent</code> ).  Thus the carriage will always be invisible and will not affect the result. </p><br><p>  For other versions of browsers, you will have to come up with something else, but this is only when we will use them for screenshots. </p><br><p><img src="https://habrastorage.org/webt/zn/ch/cb/znchcb4rzvtnpkmm22y4lcnp628.png"></p><br><h2 id="gif">  Gif </h2><br><p>  With GIF, the situation is a bit more complicated.  The task is to leave one static frame from an animated GIF.  I tried to find a module for this, set it up and forget about the problem.  As a result, I found many libraries that resize images, change the palette, make a GIF from several images, or, on the contrary, make a set of images from an animated GIF.  But I did not find such a package that makes animated GIF static.  I had to write myself. </p><br><p>  After two hours of searching for the library, I decided to see how complex the GIF format is.  I read the <a href="https://en.wikipedia.org/wiki/GIF">wiki</a> , opened the <a href="https://www.w3.org/Graphics/GIF/spec-gif89a.txt">specification</a> from the 89th year - it turned out quite understandable. </p><br><p><img src="https://habrastorage.org/webt/qq/cd/ji/qqcdjiimfoxgcpdg-v-utu9pcis.png"></p><br><p>  GIF consists of several blocks: at the beginning there is a signature describing the size of the image and a table of indexed colors.  Then there are successive blocks: Image Descriptor Block, which is responsible for graphics, and Extension Block, in which you can store a palette, some text, comments, copyrights, and so on.  At the end of the file comes Trailer, a special block that says the GIF is over. </p><br><p>  Thus, you need to go through these blocks and filter (delete) all Image Descriptor Block, except the first one.  Here is a <a href="https://gist.github.com/lahmatiy/1460bd0a1b8812072cfea1bb55d94142">link to the Gist with the code</a> that does the necessary.  I wrote it in a couple of hours, debugged it, while it works fine, no problems were found. </p><br><p>  As a result: GIF images are static, animations are turned off, all the ways to CSS are.  It remains to glue.  What could be simpler, it would seem? </p><br><h1 id="skleyka-css">  CSS glueing </h1><br><p>  Let's see how Jest works.  It usually runs in parallel, runs several threads that execute tests.  Each test file runs in one of the streams, and each file is a separate context that does not fumble data between other contexts.  And the problem is that we have a CSS transformation where we got access to the source code of CSS files is outside the context of the test, and we cannot access this content.  We cannot read CSS from a file either, because CSS has already been converted, stored in JavaScript itself, in some environment, context, worker. </p><br><p>  How to shuffle CSS between tests?  We did a little hack.  Each worker creates a temporary file in JSON format, where the key is the path to CSS, and the value itself is already converted CSS.  Each stream reads this file, takes the necessary one from there and makes a concatenation inside the context of the test. </p><br><p><img src="https://habrastorage.org/webt/dx/vv/zp/dxvvzpfzftqsj64ydbi8_uhmbis.png"></p><br><p>  Here we read some temporary file, parse it in JSON, add the necessary content to it.  Filename is the key, CSS is the converted value.  And write back the converted map. </p><br><p><img src="https://habrastorage.org/webt/li/fp/eu/lifpeuxgzs2j5kzjnrpaxlgy9py.png"></p><br><p>  When we generate CSS for the screenshot, we read from this file, use <code>includedCssModules</code> (an array of CSS paths), get the content of the necessary files, and do <code>join()</code> . </p><br><p>  It remains to gather everything. </p><br><h1 id="finalnaya-sborka">  Final build </h1><br><p><img src="https://habrastorage.org/webt/h-/gw/qb/h-gwqbzatviljdzo0wtdl9ks5vg.png"></p><br><p>  Generating the final HTML.  First, we set styles that disable dynamics (animations).  In the second style, all the glued CSS that we found are connected.  Each test will have its own set of these styles, because when we make the <code>require()</code> component, it pulls up its dependencies, which will be in our list.  As a result, only used CSS files are connected, and not all CSS in the project.  HTML, respectively, we received earlier - this is the code of the component itself. </p><br><p>  As a result, we have achieved our goal.  We can generate the HTML component in the desired state, plus the CSS that it needs. </p><br><p>  So, all the markup is assembled, the animation is turned off - everything is ready to take a screenshot.  Solutions are not perfect, you can do better, but you need to continue to dig inside Jest, Babel, CSS Modules and so on to get more elegant and stable solutions.  But in general, it suits us, and we can move on. </p><br><h1 id="skrinshoty">  Screenshots </h1><br><p>  Today, making screenshots in the browser is quite simple.  A few years ago it could have been a difficult task, it was necessary to use complex solutions.  Today, there are headless browsers that run without a GUI, in which you can download arbitrary code and watch how it works, including taking screenshots. </p><br><p>  Also, all modern browsers support WebDriver.  If you use, for example, Selenium, then everything is done relatively easily.  There are libraries, helpers that simplify writing tests for such environments. </p><br><p>  In our case, we did simple comparisons using a single browser.  While there was no need to make a cross-browser comparison, so we used <a href="https://github.com/GoogleChrome/puppeteer">Puppeteer</a> , a special library that can run headless Chrome and provides a fairly convenient interface for working with it.  Here is the main code that makes the screenshot. </p><br><p><img src="https://habrastorage.org/webt/t9/g2/fe/t9g2femtlpqt1wky20zgjkm84am.png"></p><br><p>  This is where the Puppeteer connects, the browser starts, and when you need to take a screenshot, we call the <code>screenshot()</code> function with some HTML.  This function creates a new page, inserts the transferred HTML into it, takes a screenshot, closes the page and gives us the result of the screenshot.  Works.  Not difficult.  But it turned out not so simple. </p><br><p>  The fact is that when we run the code locally, everything works fine for us.  We have a reference image and a new one, because we create a new image in the same browser version, the same system where we made the reference.  But when we started running all of this on CI, where we no longer have Mac, not Windows, but Linux, our own version of Chrome, our anti-aliasing rules, our own fonts, etc., the images turned out to be different.  That is, they began to get different results. </p><br><p>  What to do?  There are several solutions.  Some solutions are trying to overcome this difference with the help of mathematics.  They compare not pixel-by-pixel, but pixel and neighboring pixels - that is, a loose comparison with a certain tolerance.  It is expensive and somehow strange, I would just like to compare pixel by pixel. </p><br><p>  We went in the direction of another solution: make an external microservice, where you can send a POST request with the HTML code, and get an image at the output, a screenshot that we need. </p><br><p>  What are the benefits we got?  There is no dependence on the machine where the tests are run, you can update, change the browser version - it does not matter, on the microserver side there is always the same browser, which gives the same result. </p><br><p>  Also, no local settings are required for the new project.  You do not need to launch browsers, configure Puppeteer and other things, we just make a POST request and receive an image.  It turns out even faster, oddly enough, although there are network costs.  We send a request to the service, there are caches and a heated browser, which gives the image very quickly.  Plus PNGs are quite small, they press well, network traffic is not very big. </p><br><p>  Cons, too.  The service may fall at any time, you need to monitor its "health".  Everyone knows that the browser can ‚Äúeat off‚Äù a lot of memory, even if simple pages are visited.  The service may dramatically rush load, it can not cope, its resources are limited.  And if the service falls, he can not give the image - our tests do not pass. </p><br><p>  Accordingly, if everyone at the same time decides to check the screenshots (to launch), it may turn out that either they have to wait a long time or the service stops responding, because there is a big load.  The latter is solved more or less: we have a local cloud where you can create several service instances and distribute the load.  But nevertheless, such a problem exists.  What is the death of the service? </p><br><p><img src="https://habrastorage.org/webt/3g/d7/sk/3gd7skpu3mlzkcxk1woyzasd1xy.png"></p><br><p>  There is a certain service instance that works, it has a limited amount of memory (in this case, 1 GB), it can ‚Äúeat‚Äù all the available memory and stop responding.  In such cases, only a reboot helps. </p><br><p>  Microservice solutions have another side.  When we made the creation of screenshots on the code, the idea was to teach the service to give screenshots not only by code, but also by URL plus a certain selector.  What the service does in this case: it enters the page, and either makes a full screenshot of the page, or of the block to which the transmitted selector matches.  This turned out to be convenient and useful for other tasks not related to testing at all.  For example, we are experimenting now: we insert in the documentation, in our knowledge base, screenshots of pages, instructions for our services, parts of the site, using the URL of the service for images ( <code>&lt;img&gt;</code> ).  It turns out that when we go into the documentation, we always have actual screenshots.  And you do not need to constantly update them.  This is a very interesting solution, which turned out by itself. </p><br><p>  Applying the method when we can use the URL to the screenshot service as an image, and thus getting a screenshot of a page or block, is very useful for other tasks, not only for documentation.  For example, you can build functional graphs of sites: in each block of the graph there may be screenshots of pages or blocks that will be updated with each rolling out of the site. </p><br><h1 id="sravnenie-izobrazheniy">  Image Comparison </h1><br><p>  So, we proceed directly to testing with screenshots.  We received a code, received screenshots for this code, it remains to compare them. </p><br><p>  Let me remind you, we use jest to test components.  It is important. <br>  Jest has a ‚Äúkiller feature‚Äù - a comparison of snapshots. </p><br><p><img src="https://habrastorage.org/webt/im/yp/7e/imyp7evx32m8n-jd7zrej0kwqh0.png"></p><br><p>  We make markup of objects, some data, and we can call the <code>toMatchSnapshot()</code> method for this data.  How the method works: </p><br><ul><li>  causes the value to be validated on a string using various methods like <code>JSON.stringify()</code> ; </li><li>  If the test is new, the result is saved to the local database of results for later comparison; </li><li>  if the test is run again, the previous snapshot is taken from the base and two lines are compared, whether they are equal or not.  If they are not equal, then there will be an error, that is, the test is not passed.  If the test has been deleted, Jest notes that there is an irrelevant snapshot in the database so that there is no garbage. </li></ul><br><p>  Using the <code>toMatchSnapshot()</code> method, we can check whether the markup (HTML) of components has changed or not, and we don‚Äôt need to write code in order to compare, update, store snapshots, and so on.  Magic! </p><br><p>  But back to the comparison of images.  We have binary images, this is not a string representation.  There are no built-in tools for comparing images in Jest yet.  There is a <a href="https://github.com/facebook/jest/issues/3530">ticket on this topic</a> on GitHub, they are waiting for a pull request.  Maybe they will do it in time.  But at the moment there is a plugin from American Express - <a href="https://github.com/americanexpress/jest-image-snapshot">jest-image-snapshot</a> .  It is well suited to start, to immediately begin to compare binary images.  It looks like this: </p><br><p><img src="https://habrastorage.org/webt/ev/nl/km/evnlkmvjer32swia1n4wxzkiyfk.png"></p><br><p>  We connect this module and extend the <code>expect</code> new method <code>toMatchImageSnapshot()</code> , which is taken from <a href="https://www.npmjs.com/package/jest-image-snapshot">jest-image-snapshot</a> . </p><br><p><img src="https://habrastorage.org/webt/ne/6_/qi/ne6_qih-hrouczmdmanj5vzcmgq.png"></p><br><p>        .   ‚Äî  ,        ,  ,       . </p><br><p>   ,   <code>toMatchImageSnapshot()</code> .     ,    <code>toMatchSnapshot()</code> .   ,       .   ,   ,    , ,     (  ‚Äî  ),    . </p><br><p>      ?     ,    .    ,   .      Jest. ( ,  Jest    :             ,   ,        .   CI,     ,     ,   ,      ).  ,  <code>jest-image-snapshot</code>   ,    ,   ,     ,    CI,   CI    ,     . </p><br><p>            :    ,    ,      ,   ,    . </p><br><p>    ‚Äî .     800600,   1,5-2   .   ? ,     300 .  ,          ,    .   300  ‚Äî    . </p><br><p>    <code>jest-image-snapshot</code>    .    ‚Äî  .    ,      300    (  : ¬´         ¬ª)   10-20 ,  .       4,5 . ,       ,    .    ,       Jest,      12-15 . </p><br><p>   ?  ,  <code>jest-image-snapshot</code>   ,      <a href="https://www.npmjs.com/package/blink-diff">blink-diff</a> ,  ,     PNG. </p><br><p> ,  ,     800600.    ‚Äî  480  .   ‚Äî    .   ‚Äî 4  (RGB  ).   2   .   ,    ,     4  . 300  ‚Äî 300    4 ,   . </p><br><p>   ,    Garbage Collector   ,     .       ,  .        :          . </p><br><p><img src="https://habrastorage.org/webt/8n/sk/pw/8nskpwbwzsrvhccvtzr-3lijvds.png"></p><br><p>      . , <a href="https://www.npmjs.com/package/blink-diff">blink-diff</a> ,    ,   1,5-2     (800x600).      ‚Äî  <a href="https://www.npmjs.com/package/pixelmatch">pixelmatch</a> .    . , <code>jest-image-snapshot</code>     (  ,   ).  <a href="https://www.npmjs.com/package/looks-same">looks-same</a>   Gemini,     ,     pixelmatch      . </p><br><p>    ?    :     (      )    .        . PNG  ,      (,  800x600     ,   2 ,    ).      ,    . </p><br><p>     ? , ! </p><br><p><img src="https://habrastorage.org/webt/55/hu/ln/55hulnrwyxdblatqcofeobgpgra.png"></p><br><p>    node.js ‚Äì <code>crypto</code> ,    .   ,   <code>md5</code>  <code>sha1</code> , .   ,     <code>hex</code> , . </p><br><p>   .  4     58 .    ,  .  137     2 . , ,  . </p><br><p>   .   ‚Äî  overkill.       ,    .    ?   ,    ,       (  )       .   ,             .    : </p><br><p><img src="https://habrastorage.org/webt/fp/rn/qm/fprnqmi3b9_jxnzjem2__3aioky.png"></p><br><p>   Buffer   <code>equals()</code> (   <code>compare()</code> ,   ‚Äì1, 1  0,    ).   ,     ,  ,    <code>equals()</code> .     :    4   ‚Äî    3     ,    137  ‚Äî 148  .   50-70  ,   . </p><br><h2 id="popikselnoe-sravnenie">   </h2><br><p> ,    ,    .       .     ,    .    ,       ?    ,    ,    . </p><br><p><img src="https://habrastorage.org/webt/mc/7f/fp/mc7ffpsyy4717o1p5pif8jy-byk.png"></p><br><p>  ,      :  ,    PNG,    ,        .    GZIP,   ,       ,     ,  . </p><br><p> ,      ( <code>actualImage</code>  <code>expectedImage</code> ),         <a href="https://www.npmjs.com/package/fast-png">fast-png</a> .    Uint32Array    . ,     ,     .   ,         ,     .      ,    ,         .     <code>actual.data</code> , ,    ,    Uint32Array,        .  ,    ,    ,    .     :    , ,    ,  ,   . </p><br><p>       ,      ,    (: <code>count / (width * height)</code> ). </p><br><p>     ,     .  800600  ~100 ,    ,   ,        . </p><br><h1 id="generaciya-diff-izobrazheniy">  diff- </h1><br><p>  :     ?    ? </p><br><p>     ,        .      ,      ,        .       diff-  . </p><br><p><img src="https://habrastorage.org/webt/vt/7-/gq/vt7-gqtkpcrt1coerzqa3_l2p58.png"></p><br><p>     ,      .     ,   <code>alloc()</code>   ,     (   ).    Uint32Array.        .  ,    ,      .   .   ‚Äî ,    .  ,     .  ‚Äî   .      ,        . </p><br><p>   ? </p><br><p><img src="https://habrastorage.org/webt/uw/ed/db/uweddbopu8l5vibtzyq-yjtcvgo.png"></p><br><p>   ,    ‚Äî , , , ‚Äî  ,     ‚Äî    255.   .    ,       .            .    <code>gray</code> (    )     .       . </p><br><p>     : ,      .    ,  ,  ,       . </p><br><p><img src="https://habrastorage.org/webt/ck/gj/_i/ckgj_ibnwn-ewc1obegm1w1trke.png"></p><br><p>    ( <code>actual</code> , <code>expected</code>  <code>diff</code> )   <code>Buffer.concat()</code> ,          .      fast-png,     PNG.     ,  ,      ,      . </p><br><p><img src="https://habrastorage.org/webt/i_/di/j0/i_dij011xhqaqhemwy5l0prgxo4.png"></p><br><p>      ,   (   ),   ‚Äî diff:  ,  .   ?  . </p><br><p>   ?     ,  ,   250     ( ,      diff-). . ,    . </p><br><p>    .     JS,    / PNG, / GZIP   .     ,   .   WebAssembly   ,          .  ,    ,      ,  . </p><br><p>   :   diff-,    .     diff   !      ,    Git.     ,     . , GitHub   ,     .   BitBucket (Stash),    : </p><br><iframe width="560" height="315" src="https://www.youtube.com/embed/YTynuLAaa6w" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><p>      ,    .    diff?      ,   ()   .    . </p><br><p>  Jest, ,    <code>expand</code> .   ,         ,        .   Jest   ,         .     ‚Äî     <code>--expand</code> ,     .     :  <code>expand</code>  ,      ,   ,    diff-. </p><br><h1 id="esche-bystree">  ? </h1><br><p>     ?  ,     .      .  What does it mean?  ,       ,       .    ,    ,           .      ,  ,     ,   ,    ?   ,  ,       . </p><br><p>   ,     HTML      ,        .    : </p><br><ul><li>   (); </li><li> ,      ; </li><li>    . </li></ul><br><p>        .   ,        ,   .       ,        .        -,      . </p><br><p>  ,    ,   ,    (  ),        (    CI, ).     ,    .        ,  ,         . ,   ,       . </p><br><p>   :      ?       ‚Äî   .  Why not?  ,   PNG    ,   ,   .  GIF  ,    PNG  ¬´¬ª? </p><br><p>  <a href="https://en.wikipedia.org/wiki/Portable_Network_Graphics"></a> ,    PNG. ,    PNG  .   ,   GIF.   GIF        ,   PNG        4 :  ,  ,     . </p><br><p>    ()  PNG,      .      ,     .  <a href="https://gist.github.com/lahmatiy/0332b6dc3319190f9493831492dbf036"></a> .  ?     ,    ,          ,    .   ‚Äî ,     . </p><br><p> ,   .    ‚Äì  .        ,         .              (,         ).    ,    (  ),    ,     ‚Äì   .        (      ),          .         ,    . </p><br><p>      (   ),      ,    .    45-50 ,   - ,      12-15  .       300    (800x600).       . </p><br><p> : ,  -   -,     300    .        ,      (  ‚Äî   ).          . </p><br><h1 id="hranenie-izobrazheniy-v-git">    GIT </h1><br><p>   ,     ,        ‚Äì     Git.        Git,     ,   . </p><br><p>   ,  Git,    VCS,        .         ,       (  ).       , Git       ,       .     Git. </p><br><p>      Git ‚Äî <a href="https://git-lfs.github.com/">GIT LFS</a> .   ,        Git.    : </p><br><p><img src="https://habrastorage.org/webt/fn/f2/_w/fnf2_wypdnal_kr88xyz9ysio4w.png"></p><br><p>         Git   ,     :  GIT LFS,     .          .     pull ,          .   push,      ,   Git     .   git push/pull       . </p><br><h1 id="ci-ili-beyond-the-frontend"> CI,  beyond the frontend </h1><br><p>   :       12-15  ,  ,    CI   .     .  CI  ,  :    14 ,  4 .   :     700+ ,   300+ .        ,   ‚Äî  3,5 .     .    ,  -   , ,      devops-,      ,   ,     ?    ,      TeamCity   ,   . </p><br><p>  CI   :  ,   git,  git checkout,  ,   -, eslint-, stylelint-  .     .   ¬´ ¬ª,  ,   , 3,5 .     ,    ,    , ,   .    ,    30    . </p><br><h1 id="rezultaty">  results </h1><br><p>     -      12-15 .     300    (800600).     CI ‚Äî 20-30 .  :     ,     ,   .     3,5 ,   ,   . 20-30   . </p><br><p>    Jest.    ,   :   ,  ,  expand,  ,   (,    ).  :  ,  ,    Jest.  ,   ,     <code>jest-image-snapshot</code> ,     ,    . </p><br><p>   ‚Äî ¬´ ¬ª,    ,   .     ,    ,   ,   Open Source. </p><br><h1 id="itogi">  Results </h1><br><p>        Babel, CSS Modules, Jest.  ,     ,  ,   ,           . , ,  -    ,     . </p><br><p><img src="https://habrastorage.org/webt/4f/cs/9w/4fcs9wc5jv6bu5sgqujx8u0yy0a.png"></p><br><p>   :   11   ,     .    .  328 :       . </p><br><p>    :    ,  ,        .   ,      :   ,    .   ,  -  ‚Äî   . </p><br><p>   ?  ,   Jest ,    GIF, PNG,     .    Buffer API,   TeamCity,    -   . </p><br><p>   : -      .       .      ,     . </p><br><p>  That's all.  Thank! </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/350604/">https://habr.com/ru/post/350604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../350594/index.html">What is SaaS-business</a></li>
<li><a href="../350596/index.html">This SVG always shows today's date.</a></li>
<li><a href="../350598/index.html">Vue.js Moscow Meetup # 1 (03/22/2018)</a></li>
<li><a href="../350600/index.html">NVDIMM nonvolatile memory for cache protection in RAIDIX 4.6</a></li>
<li><a href="../350602/index.html">How I hacked the soldering iron</a></li>
<li><a href="../350608/index.html">Inventory Monitoring System or CMDB on the knee</a></li>
<li><a href="../350610/index.html">Breaking the Timlide Stalemate: Software Engineering Manager has more salary, better prospects - and we hire them in batches</a></li>
<li><a href="../350612/index.html">How to be * a compiler - creating a JavaScript compiler</a></li>
<li><a href="../350614/index.html">Top 10 trends in artificial intelligence (AI) technology in 2018</a></li>
<li><a href="../350618/index.html">Hackaton MentorHack: Inside out</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>