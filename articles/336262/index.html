<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring IDE Clion and Cmake to work with STM32 and C ++</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Before the example of my setting a bit of lyrics. 

 I have long wanted to try myself in microcontrollers, or rather there were ideas with their use t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring IDE Clion and Cmake to work with STM32 and C ++</h1><div class="post__text post__text-html js-mediator-article">  Before the example of my setting a bit of lyrics. <br><br>  I have long wanted to try myself in microcontrollers, or rather there were ideas with their use that I really wanted to implement.  First started with PIC32 - fire controllers.  It turned out that, at first, they short-circuited their ports, and overpowered them with power ‚Äî not killed (not quite surely, the port really burned once, but the controller itself continued to work).  The MplabX IDE is not bad, it bribed a graphic block displaying the RAM / Flash occupied on the selected MK ‚Äî conveniently, but NetBeans itself as an IDE is a tin, well, it's not convenient even after Idea.  But the problem was not that - as it turned out later, PICs are hard to get, few carry them, and if they do, it is at a relatively high price. <br><br>  Then I decided to dig in the direction of the STM32 - they are in large quantities, asking for the basic periphery is not much, but the main thing is the reachability.  (But the STM code generator is worse than Microchip, the entire file is dirtied with comments and functions, which of course was very disappointing. In Microchip, all generated functions are put into separate files and main.c is almost pure - lovely). <br>  <b>(UPD: I admit that I made a <a href="https://habrahabr.ru/users/golf2109/" class="user_link">mistake</a> here, thanks to <a href="https://habrahabr.ru/users/golf2109/" class="user_link">golf2109</a> , he suggested that you can get rid of the comments and functions of the main.c file, you just need to turn on the option in the settings to put the generated code into separate files, but I still wonder why default setting, it seems it would be logical)</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Now about the IDE for STM32. <br><a name="habracut"></a><br>  I tried Keil vaunted - of course a better notebook, but terribly inconvenient (neither normal hints nor normal formatting, after Idea was not the right coat in general, especially I still didn‚Äôt understand how to create packages, why not just poke a package and continue - I want to be fucked up). <br><br>  Then I tried CooCox - the interface is much better and more pleasant, the formatting is well-tuned (I was directly pleased with the setting of the transfer of parameters in the methods, and the other settings are very useful), but again there were not many Idea buns and again problems with the organization of packages. <br><br>  Clion is almost the same Idea only for C / C ++ and immediately wanted to fasten it, but as it turned out quite problematic (especially for a person who isn‚Äôt strong with pluses, especially with all sorts of assemblers and compilers, a couple of hundred compilation options).  Started with <a href="https://blog.jetbrains.com/clion/2016/06/clion-for-embedded-development/">JetBrains</a> blog.  It is described in some detail, but this is for past versions of STM32CubeMX, the new directory structure has changed a little, as a result of which I did not understand for some time why they did not compile.  Then I figured out - I changed the paths, for cortex-m3 I removed the -mfpu options.  But again not compiled.  Then it turned out that I installed the wrong compiler, or rather I just downloaded it, but did not indicate the path to it in the assembly file (well, it's difficult to think late at night). <br><br>  The main thing in Clion is to tick the 'Automaticaly Reload Cmake Project on Edit' settings (Settings -&gt; Build, Execution, Deployment -&gt; Cmake), then after the edits you do not need to clear anything manually. <br><br>  Another of the changes - the debugger mentioned in the blog, was renamed Ozone, it has not yet been tested, I will unsubscribe later. <br><br>  And the last problem that drilled the brain.  I really wanted OOP, but the project didn't compile if I added a C ++ file, a lot of errors with functions not found (for example, _exit, _sbrk, etc.).  There were 2 problems here: <br><br><ul><li>  in the CMakeLists.txt file in the JetBrains blog the CXX flag was not set in the project directive (needed for C ++ files) </li><li>  There were not enough -specs = nosys.specs -specs = nano.specs options after the -gc-sections option to correct errors in the file from the blog.  They just create these prototypes or, on the contrary, ignore these methods (I can‚Äôt say for sure) </li></ul><br>  After this, the project began to compile normally and its size became normal (without the -specs = nano.specs option, the size was 10 times larger for an empty project, about 110 kb., With an option - 18 kb.) <br><br>  So what I did: <br><br><ol><li>  we put Clion </li><li>  go to the settings (Settings -&gt; Build, Execution, Deployment -&gt; Cmake) and tick the 'Automaticaly Reload Cmake Project on Edit' </li><li>  here we enter in the Cmake options field the <b>-DCMAKE_TOOLCHAIN_FILE = STM32L1xx.cmake parameter</b> and <b>in the Generation path set the build</b> (if changed, in the CMakeLists.txt and STM32L1xx.cmake files, we will also need to change it) </li><li>  we put the ARM compiler ( <a href="https://developer.arm.com/products/software-development-tools/compilers/arm-compiler/downloads/version-6">here I took</a> ) </li><li>  we import the project (which was previously generated in STM32CubeMx), we say that you can create CMakeLists.txt </li><li>  From here or from <a href="https://github.com/seregaSLM/clion-cmake-stm32-freertos">my repository,</a> copy the contents of CMakeLists.txt to the one created in Clion and add the file STM32L1xx.cmake (you can call it what you want) </li><li>  in STM32L1xx.cmake, edit the project name in the project directive and you can remove CXX if you do not need C ++ </li><li>  replace in the CMakeLists.txt file in the <b>add_definitions</b> directive <b>(-DSTM32L100xC)</b> with your controller </li><li>  for reliability, you can do: Tools -&gt; Cmake -&gt; Reset Cache and Reload project and then Tools -&gt; Cmake -&gt; Reload Cmake Project </li><li>  now you can knock off </li></ol><br>  CMakeLists.txt file <br><br><pre><code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">project</span></span>(Skeleton C CXX ASM) <span class="hljs-keyword"><span class="hljs-keyword">cmake_minimum_required</span></span>(VERSION <span class="hljs-number"><span class="hljs-number">3.5</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">add_definitions</span></span>(-DSTM32L100xC) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(FREERTOS_DIR Middlewares/Third_Party/FreeRTOS/Source/) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>(GLOB_RECURSE USER_SOURCES <span class="hljs-string"><span class="hljs-string">"Src/*.c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>(GLOB_RECURSE HAL_SOURCES <span class="hljs-string"><span class="hljs-string">"Drivers/STM32L1xx_HAL_Driver/Src/*.c"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">file</span></span>( GLOB_RECURSE FREERTOS_SOURCES <span class="hljs-string"><span class="hljs-string">"${FREERTOS_DIR}/*.c"</span></span> <span class="hljs-string"><span class="hljs-string">"${FREERTOS_DIR}/CMSIS_RTOS/*.c"</span></span> <span class="hljs-string"><span class="hljs-string">"${FREERTOS_DIR}/portable/GCC/ARM_CM3/*.c"</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">add_library</span></span>( CMSIS Src/system_stm32l1xx.c startup/startup_stm32l100xc.s ) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(Inc) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(Src/gps/parser/nmea) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(Drivers/STM32L1xx_HAL_Driver/Inc) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(Drivers/CMSIS/<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(Drivers/CMSIS/Device/ST/STM32L1xx/<span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(<span class="hljs-variable"><span class="hljs-variable">${FREERTOS_DIR}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(<span class="hljs-variable"><span class="hljs-variable">${FREERTOS_DIR}</span></span>/CMSIS_RTOS) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(<span class="hljs-variable"><span class="hljs-variable">${FREERTOS_DIR}</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(<span class="hljs-variable"><span class="hljs-variable">${FREERTOS_DIR}</span></span>/portable/GCC/ARM_CM3/) <span class="hljs-keyword"><span class="hljs-keyword">include_directories</span></span>(<span class="hljs-variable"><span class="hljs-variable">${FREERTOS_DIR}</span></span>/portable/GCC/MemMang) <span class="hljs-keyword"><span class="hljs-keyword">add_executable</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf <span class="hljs-variable"><span class="hljs-variable">${USER_SOURCES}</span></span> <span class="hljs-variable"><span class="hljs-variable">${HAL_SOURCES}</span></span> <span class="hljs-variable"><span class="hljs-variable">${LINKER_SCRIPT}</span></span> <span class="hljs-variable"><span class="hljs-variable">${FREERTOS_SOURCES}</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">target_link_libraries</span></span>(<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf CMSIS) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(CMAKE_EXE_LINKER_FLAGS <span class="hljs-string"><span class="hljs-string">"${CMAKE_EXE_LINKER_FLAGS} -Wl,-Map=${PROJECT_SOURCE_DIR}/build/${PROJECT_NAME}.map"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(HEX_FILE <span class="hljs-variable"><span class="hljs-variable">${PROJECT_SOURCE_DIR}</span></span>/build/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.hex) <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>(BIN_FILE <span class="hljs-variable"><span class="hljs-variable">${PROJECT_SOURCE_DIR}</span></span>/build/<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.bin) <span class="hljs-keyword"><span class="hljs-keyword">add_custom_command</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">TARGET</span></span> <span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf POST_BUILD <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${CMAKE_OBJCOPY}</span></span> -Oihex $&lt;TARGET_FILE:<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf&gt; <span class="hljs-variable"><span class="hljs-variable">${HEX_FILE}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMAND</span></span> <span class="hljs-variable"><span class="hljs-variable">${CMAKE_OBJCOPY}</span></span> -Obinary $&lt;TARGET_FILE:<span class="hljs-variable"><span class="hljs-variable">${PROJECT_NAME}</span></span>.elf&gt; <span class="hljs-variable"><span class="hljs-variable">${BIN_FILE}</span></span> COMMENT <span class="hljs-string"><span class="hljs-string">"Building ${HEX_FILE} \nBuilding ${BIN_FILE}"</span></span>)</code> </pre> <br>  File STM32L1xx.cmake: <br><br><pre> <code class="cmake hljs"><span class="hljs-keyword"><span class="hljs-keyword">INCLUDE</span></span>(CMakeForceCompiler) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_SYSTEM_NAME Generic) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span>(CMAKE_SYSTEM_VERSION <span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Specify the cross compiler. arm-none-eabi-gcc and arm-none-eabi-g++ are full path required CMAKE_FORCE_C_COMPILER(arm-none-eabi-gcc GNU) CMAKE_FORCE_CXX_COMPILER(arm-none-eabi-g++ GNU) SET(LINKER_SCRIPT ${PROJECT_SOURCE_DIR}/STM32L100RCTx_FLASH.ld) SET(COMMON_FLAGS "-mcpu=cortex-m3 -O2 -mthumb -ffunction-sections -fdata-sections -g -fno-common -fmessage-length=0") SET(CMAKE_CXX_FLAGS_INIT "${COMMON_FLAGS} -std=c++11") SET(CMAKE_C_FLAGS_INIT "${COMMON_FLAGS} -std=gnu99") SET(CMAKE_EXE_LINKER_FLAGS_INIT "-Wl,-gc-sections -specs=nosys.specs -specs=nano.specs -T ${LINKER_SCRIPT}")</span></span></code> </pre> <br>  It was nice to work, but for now I‚Äôm uploading the firmware through the STM utility, later I‚Äôll try to wind up the OZONE.  I will answer questions (if I can). </div><p>Source: <a href="https://habr.com/ru/post/336262/">https://habr.com/ru/post/336262/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336252/index.html">Comparative load testing of Lua-connectors for Tarantool from NGINX</a></li>
<li><a href="../336254/index.html">Features of the development of mobile MMO RTS. Part 6</a></li>
<li><a href="../336256/index.html">Russian girls in Data Science. Part 1</a></li>
<li><a href="../336258/index.html">Reporting in 1C: Data Composition System (ACS), idea and architecture</a></li>
<li><a href="../336260/index.html">Swift Mutexes and Capture</a></li>
<li><a href="../336264/index.html">One step closer to C ++ 20. Results of the meeting in Toronto</a></li>
<li><a href="../336266/index.html">Advanced Jekyll</a></li>
<li><a href="../336268/index.html">ReactiveX 2.0 with examples, or grokay reactive programming 2.0. Part 1: Observable vs Flowable, Backpressure</a></li>
<li><a href="../336270/index.html">Brief reaction to Xored material</a></li>
<li><a href="../336272/index.html">Types of models</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>