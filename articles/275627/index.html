<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fear and Loathing in Multipeer Connectivity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Author: Roman Ivchenko, iOS developer DataArt. 

 Introduction 
 Surely, anyone who has ever searched for a ready solution for exchanging messages, fi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fear and Loathing in Multipeer Connectivity</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/ac1/fa8/394/ac1fa83948cf41ec8525b80b50c18179.png"></div><br>  Author: Roman Ivchenko, iOS developer DataArt. <br><br><h5>  <b>Introduction</b> </h5><br>  Surely, anyone who has ever searched for a ready solution for exchanging messages, files, streams between iOS devices without using the server part, heard about the Multipeer Connectivity framework released in iOS 7. <br><br>  In general, it is one of the most innovative frameworks released in the 7th version of the system.  It had to replace the slightly outdated CoreBluetooth. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In order to learn all the power and strength of Multipeer Connectivity, we tried to run it in our <a href="https://github.com/DataArt/SmartSlides">R &amp; D project</a> , whose task is quite simple - sharing presentations and synchronizing slides between listeners' devices and speaker's device at conferences, in classrooms, etc. <br><br><h5>  <b>Short review</b> </h5><br>  To accomplish our task, the framework, at first glance, very well fit into the architecture of the application.  Conventionally, we have only two types of users - a speaker and a listener.  Multipeer Connectivity just provides the necessary classes for the implementation of the functionality of each type of user. <br><br>  The article does not claim to provide full coverage of all the subtleties of the framework, but tells more about its problems and reliability.  All technical details can be found in the <a href="https://developer.apple.com/library/ios/documentation/MultipeerConnectivity/Reference/MultipeerConnectivityFramework/">Apple documentation</a> . <br><a name="habracut"></a><br><h5>  <b>Speaker aka Advertiser</b> </h5><br><img src="https://habrastorage.org/files/c3a/134/1bf/c3a1341bf6154907996072cc90c9e1f8.png"><br><br>  The mechanism is simple.  There is a session that is initialized by the security and encryption settings, as well as by the object of the class MCPeerID, the essence of which is quite minimalist, since this class has only one property - displayName.  It, in fact, can be considered the name of the ID session.  In order for our session to be seen by other users, the framework provides us with the MCAdvertiserAssistant class, a beacon that informs everyone about this session and stores information about it. <br><br>  As soon as the listener wants to connect to the session, MCAdvertiserAssistant will automatically show a notification about this, with the options "allow / reject connection".  As soon as the user allows the advertizer to connect to the listener, he enters the session and gets the opportunity to communicate with the advertizer. <br><br><h5>  <b>Listener aka Browser</b> </h5><br>  In the case of the listener, it is still easier - the developer writes the listener side code with minimal effort using the MCBrowserViewController framework controller, which completely takes over the entire search and connection logic to the Advertiser or implements its own controller.  In our application, the second approach was used, since the first, as it turned out, in terms of stability and quality of work, corresponds quite well to the title of the article.  But more on that later. <br><br><img src="https://habrastorage.org/files/911/7ce/a43/9117cea4347f4cb8afda6c944ed81d3a.png"><br><br>  For a browser-based device, the MCNearbyServiceBrowser class is provided, something like a radar that is looking for advertisers within a specific service name. <br><br>  Communication between MCNearbyServiceBrowser and the controller class is implemented through the MCNearbyServiceBrowserDelegate protocol, where the logic of the delegate methods implemented implies the display of current active sessions of advertizers, changing their states. <br><br>  It is important to note that a session is created on the browser side, to which MCNearbyServiceBrowser invites an Advertiser.  As soon as the advertiser accepts the invitation from the listener, the devices can be considered connected to each other. <br><br>  The message sending interface is also very transparent and simple, the advertiser and the browser send messages to each other in NSDat format, and the message receiving processing, connection status between devices, file transfer progress can be traced by implementing the MCSessionDelegate protocol methods. <br><br><h5>  <b>First touch</b> </h5><br>  In theory and even, at first glance, in practice, everything looks very convenient in terms of the implementation of the architecture - the developer gets access only to the most necessary, saving himself from the complex logic of working with wifi / bluetooth networks. <br><br>  As usual, before starting to integrate the framework into the project, everyone wants to see how it works in <a href="https://developer.apple.com/library/ios/samplecode/MultipeerGroupChat/Introduction/Intro.html">Apple‚Äôs</a> official <a href="https://developer.apple.com/library/ios/samplecode/MultipeerGroupChat/Introduction/Intro.html">demo</a> project.  MultipeerGroupChat basically shows what's what, and it works quite stably with a starter pack-set - a simulator and an iPhone / iPod / iPad.  Developers who have the opportunity to look at the demo application, having more than two devices, can immediately feel: that something in this framework is amiss. <br><br><h5>  <b>Ghost sessions</b> </h5><br>  The first bug of the framework that immediately catches the eye, even if you have the simulator and the device with you to test it - this is the problem of ghost sessions. <br><br>  Imagine the situation.  Alice is a speaker (Advertiser), Bob is a listener (browser).  Alice starts the presentation session and Bob connects to it, they exchange a couple of messages, everything is fine.  Alice finishes the presentation, and her session ends.  The first is that the probability that Bob will receive a notification that there is no longer an Advertiser, is a little more likely that he will not. <br><br>  For a browser-device, a non-existent Advertiser session may exist indefinitely.  When you try to connect to this session, nothing can happen, or after a while the connection attempt goes into the failed state.  The problem takes on serious proportions if an Advertiser has created its sessions several times.  In this case, the browser in the MCBrowserViewController native controller may display several identical Advertisers of the iPhone Simulator, when you work with only one device and one simulator, and you have no idea which advertiser from the list is active.  An example of a bug in the Apple Demo application: <br><br><img src="https://habrastorage.org/files/73d/f32/6d4/73df326d4dad44589551be065004364f.png"><br><br>  By the way, this problem is not solved by either restarting the application or reinstalling it.  Older sessions may still haunt you.  It only helps on and off the airplane mode. <br><br>  Workaround: <br><br>  When we have only one Advertiser, each new session of this Advertiser must have discoveryInfo.  This parameter is in the Dictionary &lt;String, String&gt; format, which is set at the start of the session of the advertizer and contains additional information about the session.  By adding the session creation time as a unique identifier for each session, on the browser side you can track which sessions to show and which not. <br><br><img src="https://habrastorage.org/files/aa2/4ba/fe6/aa24bafe64cb4e52827141897c1990d3.png"><br><br>  If you do everything right, the list of active sessions for each advertizer device will be the most recent session. <br><br><img src="https://habrastorage.org/files/663/fe3/a3a/663fe3a3ab5641588332a7ebe2a00d27.png"><br><br><h5>  <b>The problem of the maximum number of devices in the session</b> </h5><br>  Strange, but initially the framework has a limitation of seven connectable devices in one session.  Goals, for example, our task, clearly go against this restriction from Apple engineers.  When using our application, 30 - 40 devices can participate at the same time, and it is a pity that the framework does not initially have a solution for such a case. <br><br>  Workaround: <br><br>  Despite the limitation of the framework on the number of devices in a session, it does not have a limit on the number of sessions.  In order, for example, to have one edvertizer had the opportunity to exchange data with 40 browsers, you need to implement a solution that can support work with six sessions.  But here, again, the problem: the browser-device will see several sessions from the same Advertiser, and you need to make sure that the browser sees the most recent session with free places to connect.  As an option, the same discoveryInfo parameter comes to the rescue, in which you can contain, say the session index. <br><br>  The mechanism of management of additional sessions on the advertiser: <br><img src="https://habrastorage.org/files/414/bcd/f10/414bcdf1063347aca432027a1aa09bfc.png"><br><img src="https://habrastorage.org/files/6b9/253/157/6b9253157d5243b68e88d3c98c122c44.png"><br><img src="https://habrastorage.org/files/235/509/b04/235509b0442b4c89a25d0295ac53ceb2.png"><br><br>  On the browser side, you must filter all sessions by index and display the session with the maximum index value.  If in the previous sessions there is suddenly a free space, we will not be able to inform the browser about this, which wants to connect to the Advertiser, since the MCAdvertiserAssistant class discoveryInfo property is readonly. <br><br><h5>  <b>Reconnection</b> </h5><br>  I consider this framework headache to be the most costly for crushing with crutches.  I think it is very strange for Apple to release the framework without a ready-made reconnect mechanism.  The usual case - the browser device went into a slip mod, for 15-20 seconds it can still receive messages from the advertiser, but then the framework informs us that connection lost ... <br><br>  Workaround: <br><br>  It would seem that in order to connect again to the session of the converter, you just need to always store a pointer to the object of this session, and in which case re-send the invitation to the advertiser using this session.  In practice, this obvious approach does not work.  In our project, only hard reset of the browser-session and everything that was connected with it, and the process emulation, as if the user had updated the list of available advertizers and connected to the one from which he disconnected after leaving the background, helped. <br><br><img src="https://habrastorage.org/files/232/e42/b45/232e42b457294aba991b0048df288f3c.png"><br><br>  The solution is very rough, and I am sure that for some projects and tasks it is absolutely inappropriate, but it is apparently impossible to do it differently.  <a href="http://www.ymc.ch/en/multipeer-connectivity-a-bag-of-hurt">Proof</a> , Problem 4. <br><br><h5>  <b>General work instability, sudden connection lost</b> </h5><br><br>  If the previous bugs and limitations could somehow be solved, everything depends on the Apple engineers.  According to my observations, out of 10 attempts to test the simplest cases for our application, approximately 7-8 completed more or less successfully.  Simple cases - about 10 - 15% of the maximum possible load of the application (Advertiser and 20 - 30 browsers).  In the remaining feil cases, the following occurred: <br><br><ul><li>  The browser device suddenly stops receiving messages from the Advertiser, and notifications from the framework, no alerts, no calls to delegate methods are just silence. </li><li>  The browser-device suddenly stops receiving messages from the Advertiser, except for the connection lost messages, the reasons are not specified. </li><li>  The browser device or their group receives messages with a serious delay (on one device the slide was switched, on the other - only after 5 seconds). </li><li>  When trying to reconnect any of the browser devices to the Advertiser, other browsers begin to fall off, or the speed at which they receive messages from the Advertiser drops sharply. </li></ul><br><br>  The first problem mentioned above can be solved by implementing a health check mechanism.  At certain intervals, the browser sends a lightweight ping message, which is waiting for a response.  If the answer does not come within a few seconds, we can assume that the connection with the Advertiser is lost.  In our project, this mechanism was implemented as follows: <br><br><img src="https://habrastorage.org/files/748/d18/253/748d1825310b4d2fb44ab3e87ca82410.png"><br><img src="https://habrastorage.org/files/a6e/3ff/2b2/a6e3ff2b2ac84dc081c01e22768956a4.png"><br><br><h5>  <b>Increasing the number of connected devices proportionately reduces the stability of the entire system.</b> </h5><br>  This problem is the main one in the article.  If in the case of two or three devices the stability of work is more or less normal, with seven to nine, not to mention more quantity, then stability begins to tend to zero.  The framework just doesn't work.  I‚Äôll make a reservation right away: this is about a connection such as an ‚ÄúAdvertiser and many browsers‚Äù.  Perhaps there are some other more stable configurations, but this one is the easiest to implement, and when using the framework, you want it to work equally stable for all configurations. <br><br>  The solution for this problem during the work on the project was not found, and was not searched further, since it was more and more like sticking a riddled inflatable boat in the middle of the ocean. <br><br><h5>  <b>Fear, hate and conclusions</b> </h5><br>  While working on this project and exploring this framework, I still hoped to the end that I was doing something wrong and that Apple couldn‚Äôt screw up so much.  But after a couple of hours of research, I found many similar complaints from the developers and a good article devoted to the same problems. <br><br>  Many messages are two years old, and you can first think that all of this is the framework's childhood diseases, and in iOS 7 it was implemented in the alpha version, but now it's 2016, the latest version of iOS is 9.2, and the problems remain the same . <br><br>  MultipeerConnectivity is not highly recommended for use with more than three devices.  For two or three devices, the forecast is favorable, but there will still be a lot of problems: in order to achieve what, in theory, should be out of the box, you need to spend twice as much time. <br>  The article will end well with a couple of comments on the topic on <a href="https://devforums.apple.com/message/956192">devforums.apple.com/message/956192#956192</a> and a link to our application on GitHub <a href="https://github.com/DataArt/SmartSlides">github.com/DataArt/SmartSlides</a> . <br><br><img src="https://habrastorage.org/files/987/937/ce5/987937ce5e774570b31a5b6178c8672a.jpg"><br><br><img src="https://habrastorage.org/files/a4d/4da/c8d/a4d4dac8d2cf4d00947f70c8d4988ddd.jpg"><br><br>  <b>Confirmation of the problem</b> : <br>  <a href="http://www.ymc.ch/en/multipeer-connectivity-a-bag-of-hurt">www.ymc.ch/en/multipeer-connectivity-a-bag-of-hurt</a> <br>  <a href="http://stackoverflow.com/questions/28418965/multipeer-connectivity-vs-real-time-matches">stackoverflow.com/questions/28418965/multipeer-connectivity-vs-real-time-matches</a> <br>  <a href="https://devforums.apple.com/message/956192">devforums.apple.com/message/956192#956192</a> <br>  <a href="https://devforums.apple.com/message/982861">devforums.apple.com/message/982861#982861</a> </div><p>Source: <a href="https://habr.com/ru/post/275627/">https://habr.com/ru/post/275627/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../275617/index.html">Being a deaf developer</a></li>
<li><a href="../275619/index.html">Create a region plugin for Oracle Application Express</a></li>
<li><a href="../275621/index.html">The most interesting and significant events of 2015 in the field of financial technologies</a></li>
<li><a href="../275623/index.html">Stand back to the forest, and before me ...</a></li>
<li><a href="../275625/index.html">Research day</a></li>
<li><a href="../275631/index.html">How to use a smartphone camera to take photos suitable for OCR or something about the ABBYY Mobile Imaging SDK</a></li>
<li><a href="../275633/index.html">Microservice design patterns</a></li>
<li><a href="../275637/index.html">Critically dangerous vulnerabilities discovered in FreeBSD</a></li>
<li><a href="../275639/index.html">Expansion of a network of monitoring sites: Europe, Latin America, India</a></li>
<li><a href="../275641/index.html">Welcome to Moscow CocoaHeads January 29</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>