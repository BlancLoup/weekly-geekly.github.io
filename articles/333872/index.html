<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Openstack. Detective story or where the connection is lost? Part three</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúWho builds like this ?!‚Äù 


 What is the default address of the router on the network is a big question. In fact, nothing prevents him from being any...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Openstack. Detective story or where the connection is lost? Part three</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/24e/f86/e8b/24ef86e8b74d43918efbeee87af93f6d.png"></div><br><h3>  ‚ÄúWho builds like this ?!‚Äù </h3><br><p>  What is the default address of the router on the network is a big question.  In fact, nothing prevents him from being any address from the subnet.  And the writers of OpenStack also decided - let's be the first to suffer? <br><a name="habracut"></a><br>  As a result, you do not have time to recover, as everything falls.  Why?  Because unexpectedly for all, default gw is not on the router, as it should be, but on your open-stack.  Customers call, chef lutuet.  And you are looking for another reason for the fall.  Just a colleague uncoupled the existing address in order to replace it, and the open stack turned out to be smarter ... <br></p><br><h3>  Life goes on </h3><br><p>  In some cases, the problem occurs immediately, in some - not.  Let me remind you: the old problem was that intermittently some IP-packets began to disappear. <br></p><br><p>  I will try to justify a little.  - Often our problems coincided with the presence of external attacks.  At the same time, in many cases, it seemed that the problems were in the overloaded channels.  In some cases, we exceeded the channel limit and the packets were really dropped.  This was aggravated by the presence of infected machines in the platform, which generated an incredible amount of internal traffic.  Plus network equipment malfunction, in which, <a href="https://forums.juniper.net/t5/Ethernet-Switching/EX2200-system-overload-problems-with-15-1Rx-upgrades/td-p/302166">due to programmer errors, the</a> wrong packages were also killed.  In addition, the <a href="https://docs.openstack.org/mitaka/config-%25D0%25BAeference/networking/networking_options_reference.html">configuration files are huge</a> . <br></p><br><p>  I am not a robot or a wizard - one can understand the functionality of options with thoughtful reading, but it was completely unclear whether they are necessary in a specific context.  I had to intuitively guess the most reasonable assumptions in practice. <br></p><br><p>  Therefore, it was difficult for me and my colleagues to isolate and identify the problem.  Worse, there was no problem in the newly created farm.  We generated three hundred machines, and everything worked like a clock.  Of course, we immediately began to prepare it in production.  This meant the introduction of "ragged" ranges of IP addresses.  We cleaned the farm, removing these three hundred machines.  And suddenly, with only three test virtual machines, the same thing happened as on the old farm - packages began to disappear in large numbers.  So we decided that the problem was somewhere deep in OpenStack. <br></p><br><h3>  Strange temporary solutions </h3><br><p>  In the old farm, we found a relatively simple way to get around this problem.  This was done by tearing off the internal IP address and assigning it from another subnet - we had to add new subnets frequently.  The problem went away for a while.  Some machines worked well. <br></p><br><h3>  Solution somewhere nearby </h3><br><p>  In the course of a long investigation, interrupted for design work, distracted by problems from VIPs, we were still able to identify several errors.  In addition, these same files are different if you use the controller as a compute node, and if you do not.  In one of the first successful configurations, we used it.  Then they refused it.  Some of the settings remain.  Thus, in two of the nine machines there were incorrect settings (the dvr parameter, but dvr-snat, hit the compute nodes).  In the end I found the right parameter and put it in place. <br></p><br><p>  Without understanding how the virtual router works - where it takes the settings, I had to configure it too.  He, in theory, should be with one address and, accordingly, with one MAC address.  Is it logical  We talked this way and accordingly set up with a colleague. <br></p><br><p>  At some point, when investigating problems with DHCP <a href="https://habrahabr.ru/post/332400/">(see Part 2),</a> I found duplicate mac addresses.  Not one, two, but much more.  Here is the number! <br></p><br><p>  It was decided to change the settings of base_mac and dvr_base_mac.  Now in each computer and in each controller these parameters are different. <br></p><br><p>  We have not included l2population from the very beginning - well, we simply did not reach the hands.  And in the new farm included.  And look, after all such changes - it worked!  Not only that - pings have ceased to disappear from the word "in general"!  Previously, no, no, yes, and the bag disappears just like that - 0.1% and we thought it was generally good.  Because it is much worse when a quarter, or even half, disappeared. <br></p><br><div class="spoiler">  <b class="spoiler_title">Settings that made us good - neutron.conf for controller node</b> <div class="spoiler_text">  root @ mama: ~ # cat /etc/neutron/neutron.conf | grep -v "^ #. *" | strings <br>  [DEFAULT] <br>  bind_host = 192.168.1.4 <br>  auth_strategy = keystone <br>  core_plugin = ml2 <br>  allow_overlapping_ips = true <br>  service_plugins = router <br>  base_mac = fa: 17: a1: 00: 00: 00 <br>  notify_nova_on_port_status_changes = true <br>  notify_nova_on_port_data_changes = true <br>  advertise_mtu = true <br>  allow_automatic_dhcp_failover = true <br>  dhcp_agents_per_network = 3 <br>  dvr_base_mac = fa: 17: b1: 00: 00: 00 <br>  router_distributed = true <br>  allow_automatic_l3agent_failover = true <br>  l3_ha = true <br>  max_l3_agents_per_router = 3 <br>  rpc_backend = rabbit <br>  [agent] <br>  root_helper = sudo / usr / bin / neutron-rootwrap /etc/neutron/rootwrap.conf <br>  [database] <br>  connection = mysql + pymysql: // neutron: ZPASSWORDZ @ mama / neutron <br>  [keystone_authtoken] <br>  auth_uri = <a href="http://mama/">mama</a> : 5000 <br>  auth_url = <a href="http://mama/">mama</a> : 35357 <br>  memcached_servers = mama: 11230 <br>  auth_plugin = password <br>  project_domain_name = default <br>  user_domain_name = default <br>  project_name = service <br>  username = neutron <br>  password = ZPASSWORDZ <br>  [nova] <br>  auth_url = <a href="http://mama/">mama</a> : 35357 <br>  auth_plugin = password <br>  project_domain_name = default <br>  user_domain_name = default <br>  region_name = RegionOne <br>  project_name = service <br>  username = nova <br>  password = ZPASSWORDZ <br>  [oslo_messaging_rabbit] <br>  rabbit_userid = openstack <br>  rabbit_password = ZPASSWORDZ <br>  rabbit_durable_queues = true <br>  rabbit_hosts = mama: 5673 <br>  rabbit_retry_interval = 1 <br>  rabbit_retry_backoff = 2 <br>  rabbit_max_retries = 0 <br>  rabbit_ha_queues = false <br>  [quotas] <br>  quota_network = 100 <br>  quota_subnet = 200 <br>  quota_port = -1 <br>  quota_router = 100 <br>  quota_floatingip = -1 <br>  quota_security_group = -1 <br>  quota_security_group_rule = -1 <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Settings that did us well - neutron.conf for compute node</b> <div class="spoiler_text">  root @ baby: ~ # cat /etc/neutron/neutron.conf | grep -v "^ #. *" | strings <br>  [DEFAULT] <br>  bind_host = 192.168.1.7 <br>  bind_port = 9696 <br>  auth_strategy = keystone <br>  core_plugin = ml2 <br>  allow_overlapping_ips = true <br>  service_plugins = router <br>  base_mac = fa: 17: c1: 00: 00: 00 <br>  notify_nova_on_port_status_changes = true <br>  notify_nova_on_port_data_changes = true <br>  allow_automatic_dhcp_failover = true <br>  dhcp_agents_per_network = 3 <br>  dvr_base_mac = fa: 17: d1: 00: 00: 00 <br>  router_distributed = true <br>  allow_automatic_l3agent_failover = true <br>  l3_ha = true <br>  max_l3_agents_per_router = 3 <br>  rpc_backend = rabbit <br>  [agent] <br>  root_helper = sudo / usr / bin / neutron-rootwrap /etc/neutron/rootwrap.conf <br>  [database] <br>  connection = mysql + pymysql: // neutron: ZPASSWORDZ @ mama / neutron <br>  [keystone_authtoken] <br>  auth_uri = <a href="http://mama/">mama</a> : 5000 <br>  auth_url = <a href="http://mama/">mama</a> : 35357 <br>  memcached_servers = mama: 11230 <br>  auth_plugin = password <br>  project_domain_name = default <br>  user_domain_name = default <br>  project_name = service <br>  username = neutron <br>  password = ZPASSWORDZ <br>  [nova] <br>  auth_url = <a href="http://mama/">mama</a> : 35357 <br>  auth_plugin = password <br>  project_domain_name = default <br>  user_domain_name = default <br>  region_name = RegionOne <br>  project_name = service <br>  username = nova <br>  password = ZPASSWORDZ <br>  [oslo_messaging_rabbit] <br>  rabbit_hosts = mama: 5673 <br>  rabbit_userid = openstack <br>  rabbit_password = ZPASSWORDZ <br>  rabbit_durable_queues = true <br>  rabbit_retry_interval = 1 <br>  rabbit_retry_backoff = 2 <br>  rabbit_max_retries = 0 <br>  rabbit_ha_queues = true <br></div></div><br><p>  We waited patiently for a day (and we wanted to run, shouting ‚Äúit worked!‚Äù), We applied similar changes in the old farm.  The second week is normal flight. <br></p><br><h3>  Conclusion </h3><br><p>  Conclusion: of course, all this would not have happened if we set up not manually, but through an automated installer.  However, the experience gained is invaluable. <br></p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/333872/">https://habr.com/ru/post/333872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../333862/index.html">What to read about neural networks</a></li>
<li><a href="../333864/index.html">Bitfury Group conducted the 1st transaction in the Lightning Network using the bitcoin protocol</a></li>
<li><a href="../333866/index.html">Developer Life in Cyprus</a></li>
<li><a href="../333868/index.html">Cooking cache correctly</a></li>
<li><a href="../333870/index.html">Red Architecture - red help button for complex and confusing systems</a></li>
<li><a href="../333874/index.html">Inside Docker Networks: How Docker Uses iptables and Linux Interfaces</a></li>
<li><a href="../333878/index.html">PostgreSQL Indexes - 5</a></li>
<li><a href="../333880/index.html">RubyMine 2017.2: Docker Compose, RuboCop auto-correction in the editor, improved VCS</a></li>
<li><a href="../333882/index.html">Security Week 29: How to crack ICO, RCE-bug in tens of millions of installations, Nukebot went to the people</a></li>
<li><a href="../333884/index.html">API Grace Rules</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>