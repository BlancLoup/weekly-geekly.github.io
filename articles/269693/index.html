<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Parallel processing of a large select in several sessions</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Imagine: there is a select that returns records, each of which needs to be processed, and whether there are many records, or the processing of each re...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Parallel processing of a large select in several sessions</h1><div class="post__text post__text-html js-mediator-article">  Imagine: there is a select that returns records, each of which needs to be processed, and whether there are many records, or the processing of each record takes a lot of time, and the processing of one record does not depend on the processes of other records. <br>  The classic example is to enable multithreading or, in the case of databases, to perform processing in several sessions.  In Orakle, hint / * + parallel () * / and <b>pipelined</b> functions are used for this.  This is great, but if you have the Oracle standard edition (where the parallel does not work) or you want to process not every record separately (for reasons that it is better to save work, and then to complete, with one blow, execute) and divide the entire output of the select into pieces and process each separately? <br><a name="habracut"></a><br>  The task is set as follows: <br><br>  Write a Java stored procedure that receives the following parameters: <br><ul><li>  Select text </li><li>  The name of the procedure that will work with the data portion. </li><li>  Number of threads </li><li>  Data required to connect to the database </li></ul><br>  First, let's see what can be done with the <b>pipelined</b> function. <br><br>  Java opens the result set in the default connection. <br>  First thing to do <br>  <b>select count (*) from ("Text select");</b> <br>  Create a connection pool with the dimension specified in the 3rd parameter. <br>  Let's create separate sessions, having joined through jdbc connection. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      We take the data for this from the 4th parameter, we, by and large, need only a password, we‚Äôll get everything else ourselves (maybe another port if it is different from 1521). <br><br>  We will receive data from the default connection and rewrite it into the session from the pool.  As soon as we decide that we have accumulated enough, we will create a thread, pass this connection to it as a parameter and let it work, and we will continue with the next session or, if everything has already been read, we will wait for the end of all threads. <br><br>  Let's write the processing function.  It gets all the select fields as parameters. <br><br>  It will be convenient for, for example, the first two parameters to be the number in a chunk and its dimension.  This will enable dbms info to display the percentage of completion in the stream. <br><br>  According to the metadata of the select, we will construct its call in the form of something like this: <br><br>  begin proc1 (23,14000, 'a1', 3, 'tratata', 35.48);  end; <br><br>  We will only store such a string. <br><br>  Initially, it was a 2-dimensional array (i, j), where i is the stream number (hereinafter ...).  Then I saw that with a large number of records, the Oracle costs of supporting a large array become excessive and decided to use a temporary table as well. <br><br>  I put the border in 200,000 entries.  If count (*) returns less than 200,000 Java, in-runtime uses a 2-dimensional String array; if more, writes to the parallel_calls_tmp temporary table with one varchar2 (4000) field. <br><br>  So, in the PL / SQL package we create the function <br> <code>FUNCTION run_pipe_parallel(pi_Select_Txt VARCHAR2, <br> pi_Proc_Name VARCHAR2, <br> pi_Parallel_Count VARCHAR2, <br> Pi_Password VARCHAR2) RETURN VARCHAR2 AS <br> LANGUAGE JAVA NAME 'com.samtrest.ParallelRunner.run_parallel(java.lang.String, java.lang.String,java.lang.String, java.lang.String) return java.lang.String'; <br></code> <br>  Create a table <br><pre> <code class="sql hljs"><span class="hljs-comment"><span class="hljs-comment">-- Create table create global temporary table parallel_calls_tmp ( call_str varchar2(4000) ) on commit preserve rows;</span></span></code> </pre><br>  Java side has a function <br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_parallel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String selectTxt, String procedureName, String threadCount, String password)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NumberFormatException, SQLException, ClassNotFoundException </span></span>{ String rc = <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; ParallelRunner parallelRunner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParallelRunner(selectTxt,procedureName,Integer.parseInt(threadCount),password); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parallelRunner.runProc(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SQLException e) { e.printStackTrace(); rc = e.getMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException e) { e.printStackTrace(); rc = e.getMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rc; }</code> </pre><br><br>  Getting an array of data types of select fields <br><pre> <code class="java hljs"> res = stm.executeQuery(); ResultSetMetaData meta = res.getMetaData(); columnCount = meta.getColumnCount(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> [] types = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span>[columnCount]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; columnCount; k++) { types[k] = meta.getColumnType(k+<span class="hljs-number"><span class="hljs-number">1</span></span>); }</code> </pre><br>  So build the call string: <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (res.next()){ callStr = <span class="hljs-string"><span class="hljs-string">"begin "</span></span>+procedureName+<span class="hljs-string"><span class="hljs-string">"("</span></span>+processSeq+<span class="hljs-string"><span class="hljs-string">","</span></span>+(j+<span class="hljs-number"><span class="hljs-number">1</span></span>)+<span class="hljs-string"><span class="hljs-string">","</span></span>+chunkCount; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> k = <span class="hljs-number"><span class="hljs-number">0</span></span>; k &lt; columnCount; k++) { callStr = callStr+<span class="hljs-string"><span class="hljs-string">","</span></span>; String value = <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( types[k] == java.sql.Types.VARCHAR || types[k] == <span class="hljs-number"><span class="hljs-number">1</span></span>){ value = res.getString(k+<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (value == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ value = <span class="hljs-string"><span class="hljs-string">"null"</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ value = <span class="hljs-string"><span class="hljs-string">"'"</span></span>+value+<span class="hljs-string"><span class="hljs-string">"'"</span></span>; } }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types[k] == java.sql.Types.NUMERIC){ BigDecimal number = res.getBigDecimal(k+<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (number == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ value = <span class="hljs-string"><span class="hljs-string">"null"</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ value = number.toString(); } }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (types[k] == java.sql.Types.DATE || types[k] == java.sql.Types.TIMESTAMP){ Timestamp date = res.getTimestamp(k+<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (date == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>){ value = <span class="hljs-string"><span class="hljs-string">"null"</span></span>; }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ value = <span class="hljs-string"><span class="hljs-string">"to_date('"</span></span>+date.toString().substring(<span class="hljs-number"><span class="hljs-number">0</span></span>,date.toString().indexOf(<span class="hljs-string"><span class="hljs-string">'.'</span></span>))+ <span class="hljs-string"><span class="hljs-string">"','yyyy-mm-dd hh24:mi:ss')"</span></span>; } }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ System.out.println(<span class="hljs-string"><span class="hljs-string">""</span></span>+types[k]); } callStr = callStr + value; } callStr = callStr + <span class="hljs-string"><span class="hljs-string">"); end;"</span></span>;</code> </pre><br>  We accumulate in an array or table <br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rowCount &gt; CHUNK_LIMIT){ insert.setString(<span class="hljs-number"><span class="hljs-number">1</span></span>, callStr); insert.executeUpdate(); }<span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ chunks[i][j] = callStr; }</code> </pre><br><br>  And now the whole class that needs to be loaded into the database. <br><pre> <code class="java hljs">create or replace and compile java source named <span class="hljs-string"><span class="hljs-string">"ParallelRunner"</span></span> as <span class="hljs-keyword"><span class="hljs-keyword">package</span></span> com.samtrest; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.math.BigDecimal; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.CallableStatement; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.Connection; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.DriverManager; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.PreparedStatement; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.ResultSet; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.ResultSetMetaData; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.SQLException; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.Statement; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> java.sql.Timestamp; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ParallelRunner</span></span></span><span class="hljs-class"> </span></span>{ String selectTxt; String procedureName; String tableName = <span class="hljs-string"><span class="hljs-string">""</span></span>; String additional; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> threadCount,processSeq; String host=<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>,instance,port=<span class="hljs-string"><span class="hljs-string">"1521"</span></span>,userName,password; Connection [] connPool; Connection defaultConn; ChunkRunner [] chunkRunners; String [][] chunks; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> CHUNK_LIMIT = <span class="hljs-number"><span class="hljs-number">200000</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ParallelRunner</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String selectTxt, String procedureName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> threadCount,String psw)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException, ClassNotFoundException </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.selectTxt = selectTxt; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.procedureName = procedureName; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.threadCount = threadCount; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.port = <span class="hljs-string"><span class="hljs-string">"1521"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.password=psw; connPool = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Connection[threadCount]; chunkRunners = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ChunkRunner[threadCount]; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run_parallel</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String selectTxt, String procedureName, String threadCount, String psw)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> NumberFormatException, SQLException, ClassNotFoundException </span></span>{ String rc = <span class="hljs-string"><span class="hljs-string">"OK"</span></span>; ParallelRunner parallelRunner = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ParallelRunner(selectTxt,procedureName,Integer.parseInt(threadCount),psw); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { parallelRunner.runProc(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (SQLException e) { e.printStackTrace(); rc = e.getMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException e) { e.printStackTrace(); rc = e.getMessage(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rc; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">populateConnectionPool</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> SQLException, ClassNotFoundException</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> siteNumber = <span class="hljs-number"><span class="hljs-number">0</span></span>; String siteStatus =<span class="hljs-string"><span class="hljs-string">"T"</span></span>; ResultSet res; Class.forName(<span class="hljs-string"><span class="hljs-string">"oracle.jdbc.driver.OracleDriver"</span></span>); defaultConn = DriverManager.getConnection(<span class="hljs-string"><span class="hljs-string">"jdbc:default:connection:"</span></span>); PreparedStatement stm = defaultConn.prepareStatement(<span class="hljs-string"><span class="hljs-string">"SELECT SYS_CONTEXT('USERENV','SESSION_USER') from dual"</span></span>); res = stm.executeQuery(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res.next()){ userName = res.getString(<span class="hljs-number"><span class="hljs-number">1</span></span>); } res.close(); stm = defaultConn.prepareStatement(<span class="hljs-string"><span class="hljs-string">"SELECT SYS_CONTEXT('USERENV','DB_NAME') from dual"</span></span>); res = stm.executeQuery(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (res.next()){ instance = res.getString(<span class="hljs-number"><span class="hljs-number">1</span></span>); } res.close(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; connPool.length; i++) { connPool[i] = DriverManager.getConnection(<span class="hljs-string"><span class="hljs-string">"jdbc:oracle:thin:@"</span></span>+host+<span class="hljs-string"><span class="hljs-string">":"</span></span>+port+<span class="hljs-string"><span class="hljs-string">":"</span></span>+instance, userName, password); <span class="hljs-comment"><span class="hljs-comment">//connPool[i] = DriverManager.getConnection("jdbc:oracle:thin:@10.28.28.101:1521:orc1", userName, password); connPool[i].setAutoCommit(false); stm = connPool[i].prepareStatement("begin dbms_application_info.set_module('Java Parallel; process:'||"+ processSeq+",'"+connPool.length+" threads'); end;"); stm.executeUpdate(); } stm.close(); } public void runProc() throws SQLException, ClassNotFoundException{ int rowCount = 0,columnCount, chunkCount,i,j; String callStr=""; PreparedStatement stm; Statement info; PreparedStatement insert = null; populateConnectionPool(); info = defaultConn.createStatement(); info.executeUpdate("begin dbms_application_info.set_module('Parallel process:'||"+ processSeq+",'"+threadCount+" threads'); end;"); System.out.println(selectTxt); stm = defaultConn.prepareStatement("select count(*) from ("+selectTxt+")"); ResultSet res = stm.executeQuery(); if ( res.next()) rowCount = res.getInt(1); res.close(); stm.close(); chunkCount = rowCount/threadCount; if (chunkCount*threadCount &lt; rowCount){ chunkCount++; } i = 0; j = 0; // System.out.println("Count of parallel threads: "+connPool.length); // System.out.println("Count of processing rows: "+rowCount); // System.out.println("Chunk length: "+chunkCount); info.executeUpdate("begin dbms_application_info.set_action('"+connPool.length+","+rowCount+","+chunkCount+"'); end;"); stm = defaultConn.prepareStatement(selectTxt); res = stm.executeQuery(); ResultSetMetaData meta = res.getMetaData(); columnCount = meta.getColumnCount(); int [] types = new int[columnCount]; for (int k = 0; k &lt; columnCount; k++) { types[k] = meta.getColumnType(k+1); } if (rowCount &gt; CHUNK_LIMIT){ insert = connPool[i].prepareStatement("insert into parallel_calls_tmp values (?)"); }else{ chunks = new String[threadCount][chunkCount]; } while (res.next()){ callStr = "begin "+procedureName+"("+processSeq+","+(j+1)+","+chunkCount; for (int k = 0; k &lt; columnCount; k++) { callStr = callStr+","; String value = ""; if ( types[k] == java.sql.Types.VARCHAR || types[k] == 1){ value = res.getString(k+1); if (value == null){ value = "null"; }else{ value = "'"+value+"'"; } }else if (types[k] == java.sql.Types.NUMERIC){ BigDecimal number = res.getBigDecimal(k+1); if (number == null){ value = "null"; }else{ value = number.toString(); } }else if (types[k] == java.sql.Types.DATE || types[k] == java.sql.Types.TIMESTAMP){ Timestamp date = res.getTimestamp(k+1); if (date == null){ value = "null"; }else{ value = "to_date('"+date.toString().substring(0,date.toString().indexOf('.'))+ "','yyyy-mm-dd hh24:mi:ss')"; } }else{ System.out.println(""+types[k]); } callStr = callStr + value; } callStr = callStr + "); end;"; if (i == 0){ if( j == 0 ){ System.out.println(callStr); } } if (rowCount &gt; CHUNK_LIMIT){ insert.setString(1, callStr); insert.executeUpdate(); }else{ chunks[i][j] = callStr; } j++; if (j == chunkCount){ connPool[i].commit(); if (rowCount &gt; CHUNK_LIMIT){ chunkRunners[i] = new ChunkRunner(connPool[i],processSeq); }else{ chunkRunners[i] = new ChunkRunner(connPool[i],processSeq,chunks[i]); } chunkRunners[i].start(); i++; if (i &lt; connPool.length ){ if (rowCount &gt; CHUNK_LIMIT){ insert = connPool[i].prepareStatement("insert into parallel_calls_tmp values (?)"); } j = 0; } } info.executeUpdate("begin dbms_application_info.set_action('"+connPool.length+","+rowCount+","+chunkCount+" threads "+i+","+j+"'); end;"); } res.close(); stm.close(); info.close(); connPool[i].commit(); if (j &lt; chunkCount){ if (rowCount &gt; CHUNK_LIMIT){ chunkRunners[i] = new ChunkRunner(connPool[i],processSeq); }else{ chunkRunners[i] = new ChunkRunner(connPool[i],processSeq,chunks[i]); } chunkRunners[i].start(); } for (int k = 0; k &lt; chunkRunners.length; k++) { if (chunkRunners[k] != null){ try { chunkRunners[k].join(); } catch (InterruptedException e) { e.printStackTrace(); } } } for (int k = 0; k &lt; chunkRunners.length; k++) { if (chunkRunners[k] != null){ if (!connPool[k].isClosed()){ connPool[k].close(); } if (!"".equals(chunkRunners[k].errorMsg)){ throw(new SQLException(chunkRunners[k].errorMsg)); } } } defaultConn.close(); } public class ChunkRunner extends Thread { Connection conn; String errorMsg = ""; String [] chunk; String internal; int processSeq; public ChunkRunner(Connection conn, int process) { super(); this.conn = conn; this.processSeq = process; } public ChunkRunner(Connection conn, int process,String []chunk) { super(); this.conn = conn; this.chunk = chunk; this.processSeq = process; } public ChunkRunner(Connection conn, int process,String inter) { super(); this.conn = conn; this.processSeq = process; this.internal = inter; } public void run(){ Statement stm = null; PreparedStatement select = null; String stmt=""; try { stm = conn.createStatement(); if ("".equals(tableName)){ if( chunk == null){ select = conn.prepareStatement("select * from parallel_calls_tmp"); ResultSet res = select.executeQuery(); while (res.next()){ stmt = res.getString(1); if (stmt != null){ if ( stmt != ""){ stm.executeUpdate(stmt); } } } }else{ for (int i = 0; i &lt; chunk.length; i++) { stmt = chunk[i]; if (stmt != null){ if (stmt != ""){ stm.executeUpdate(stmt); } } } } stm.close(); } } catch (SQLException e) { System.out.println(stmt); e.printStackTrace(); errorMsg = e.getMessage(); e.printStackTrace(); } finally { try { conn.commit(); conn.close(); } catch (SQLException e) { e.printStackTrace(); } } } } } /</span></span></code> </pre><br>  Example Handler Function <br><pre> <code class="sql hljs"> PROCEDURE close_row_process(pi_CurrentInChunk NUMBER, pi_ChunkLength NUMBER, pi_activity_folder_seq fr_activity_folders.activity_folder_seq%TYPE, pi_action_seq fr_folder_actions.action_seq%TYPE, pi_demand_sum_min NUMBER, pi_action_code fr_folder_actions.action_code%TYPE, pi_demand_sum fr_folder_actions.demand_sum%TYPE, pi_contract_acc_num fr_activity_folders.contract_acc_num%TYPE, pi_debt_reduction_sum NUMBER, pi_response_type NUMBER, pi_section_num NUMBER, pi_client_id fr_activity_folders.client_id%TYPE, pi_client_type fr_activity_folders.client_type%TYPE);</code> </pre><br>  Usage example <br><pre> <code class="sql hljs"> dbms_application_info.set_module(module_name =&gt; 'close_folders_parallel,Process: ' || l_ProcessSeq, action_name =&gt; ''); v_Step := 1; l_SelectTxt := '<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> af.activity_folder_seq,<span class="hljs-string"><span class="hljs-string">' || '</span></span> fa.action_seq,<span class="hljs-string"><span class="hljs-string">' || '</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> fa.action_code = <span class="hljs-number"><span class="hljs-number">3</span></span><span class="hljs-string"><span class="hljs-string">' THEN'</span></span> || <span class="hljs-string"><span class="hljs-string">' rs.folder_closing_sum'</span></span> || <span class="hljs-string"><span class="hljs-string">' ELSE'</span></span> || <span class="hljs-string"><span class="hljs-string">' fac.demand_sum_min'</span></span> || <span class="hljs-string"><span class="hljs-string">' END demand_sum_min,'</span></span> || <span class="hljs-string"><span class="hljs-string">' fa.action_code,'</span></span> || <span class="hljs-string"><span class="hljs-string">' fa.demand_sum,'</span></span> || <span class="hljs-string"><span class="hljs-string">' af.contract_acc_num,'</span></span> || <span class="hljs-string"><span class="hljs-string">' nvl(rs.debt_reduction_sum,0) debt_reduction_sum,'</span></span> || <span class="hljs-string"><span class="hljs-string">' fab.response_type,rca.section_num,af.client_id,af.client_type'</span></span> || <span class="hljs-string"><span class="hljs-string">' FROM fr_activity_folders af,'</span></span> || <span class="hljs-string"><span class="hljs-string">' fr_folder_actions fa,'</span></span> || <span class="hljs-string"><span class="hljs-string">' rm_contract_acc rca,'</span></span> || <span class="hljs-string"><span class="hljs-string">' fr_actions_codes fac,'</span></span> || <span class="hljs-string"><span class="hljs-string">' rm_section rs,'</span></span> || <span class="hljs-string"><span class="hljs-string">' fr_action_bank_answers fab'</span></span> || <span class="hljs-string"><span class="hljs-string">' WHERE af.current_action_seq = fa.action_seq'</span></span> || <span class="hljs-string"><span class="hljs-string">' AND rca.contract_acc_num = af.contract_acc_num'</span></span> || <span class="hljs-string"><span class="hljs-string">' AND fa.action_code = fac.action_code'</span></span> || <span class="hljs-string"><span class="hljs-string">' AND rca.section_num = rs.section_num(+)'</span></span> || <span class="hljs-string"><span class="hljs-string">' AND fa.action_seq= fab.action_seq(+)'</span></span> || <span class="hljs-string"><span class="hljs-string">' AND af.folder_status = '</span></span> || fr_check_potential_pkg.c_FOLDER_OPEN_STATUS <span class="hljs-comment"><span class="hljs-comment">--||' AND rownum &lt;= 1000' ; l_ProcName := 'fr_support_pkg.close_row_process'; -- Get amount limits for future actions ------------------------------------------------------ -- populate temporary table with calc balance results in parallel dbms_application_info.set_action(action_name =&gt; 'Parallel Java'); dbms_java.set_output(1000000); SELECT t.parallel_num INTO v_ParallelCount FROM sr_task_codes t WHERE t.task_seq = 203; v_Msg := run_pipe_parallel(pi_Select_Txt =&gt; l_SelectTxt, pi_Proc_Name =&gt; l_ProcName, pi_Parallel_Count =&gt; v_ParallelCount, Pi_Password =&gt; 'psw'); IF v_Msg &lt;&gt; 'OK' THEN RAISE ErrException; END IF; ------------------------------------------------------</span></span></code> </pre><br>  Basically, I just thought that it would work not only with Oracle, but with any database ... <br><br>  If anyone is interested, I can tell you what I added in order to work not with the simulation pipelined functions, but with the execution of individual batches ... <br><br>  I can say that as a result I received a gain in time: 12 hours in one session versus an hour and a half in 25 sessions.  In this case, all 16 server processors were loaded at 100%. </div><p>Source: <a href="https://habr.com/ru/post/269693/">https://habr.com/ru/post/269693/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../269681/index.html">Geek Week 2015: Learn, Learn and Learn More</a></li>
<li><a href="../269685/index.html">Algorithm of search of object displacement in the image</a></li>
<li><a href="../269687/index.html">Technopark Lectures: Alexey Rybak Master Class ‚ÄúAbout what I would like to be told while I was studying‚Äù</a></li>
<li><a href="../269689/index.html">Server Push Implementation for Nancy</a></li>
<li><a href="../269691/index.html">Telecommunications giant TalkTalk suffered from cyber attack</a></li>
<li><a href="../269695/index.html">From Java to Scala: 7 reasons to learn a new language</a></li>
<li><a href="../269697/index.html">Cold perfection: news on the data center cooling systems market</a></li>
<li><a href="../269699/index.html">Compare me completely. Reflection in the service of .NET developer</a></li>
<li><a href="../269701/index.html">Monitoring is handy on IxoraRMS. Quick and tasteful</a></li>
<li><a href="../269705/index.html">Sharing checkstyle and gerrit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>