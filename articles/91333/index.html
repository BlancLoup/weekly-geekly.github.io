<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>SoftReference Read-Write Cache for Hibernate - with ‚Äútails‚Äù for cluster implementation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this topic I will try to talk about the implementation of the data caching system in the CMS ArpSite. This subsystem has already been rewritten mor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>SoftReference Read-Write Cache for Hibernate - with ‚Äútails‚Äù for cluster implementation</h1><div class="post__text post__text-html js-mediator-article">  In this topic I will try to talk about the implementation of the data caching system in the CMS ArpSite.  This subsystem has already been rewritten more than once, but it is precisely what allows the system to work with an acceptable response time in general. <br><br>  Using SoftReference makes it possible to leave the caching behavior ‚Äúon the drain‚Äù - the JVM itself monitors the memory consumption, it also clears the old elements. <br><br>  ‚ÄúCluster‚Äù means that the cache independently monitors invalidation events (obsolescence, updates) of values ‚Äã‚Äãand ensures that obsolete items are discarded from the cache on other servers in the cluster.  There are other cluster cache definitions.  For example, the main mode of operation of JBoss Cache can even "pull" elements from other nodes of the cluster if they are not on the current machine.  But for our system, where the speed of receiving an element from another machine is not much less than the speed of element generation, it is quite invalid. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Read-Write means that we do not use blocking of cache elements and generally do not think (almost) that there are any independent transactions in our system.  For CMS this is normal, but, of course, for any enterprise application this would be unacceptable. <br><a name="habracut"></a><br>  Currently, caching in ArpSite is divided into three levels: <br><ul><li>  Caching generated pages </li><li>  Other caches </li><li>  Data caching </li></ul><br>  The remaining caches are not randomly located in the middle.  The generated pages are what will be given to the user immediately - if the URL and some other parameters match.  Appeals to the database for this is not necessary at all.  Data caching is what is now called the <a href="http://www.javabeat.net/articles/37-introduction-to-hibernate-caching-1.html">second level cache</a> in Hibernate ‚Äî individual lines of the database are cached (by key) and some popular database queries (by arguments).  The remaining caches are understood to be different mechanisms for caching intermediate results of page generation, caching of XSLT style sheets, pieces of XML and others. <br><br>  In case there is a change in the system, we need to clear the caches.  To do this, the system generates one or more events (events) at each data change.  These events are sent asynchronously to the rest of the cluster nodes, after which the caches respond to these events by completely clearing or disabling individual items. <br><br>  The less impact events have on a cache, the better it works.  Obviously, the cache of the generated pages is cleared <i>for any change</i> - trying to analyze the dependencies of page elements on specific database rows is too expensive. <br><br>  Data cache on each server.  And earlier, before the introduction of the cache on JGroups, if an event occurred, the application caused the commands to invalidate the data cache or to completely clean it based on information from the incoming event.  This procedure worked, but it had a serious drawback - any data caching required either to think in detail about the procedure for reacting to events, or simply to clear the cache for each change.  What is happening now in the "other" caches.  It was especially problematic to write the caching of individual queries to the database - it was necessary to remember which tables were used in the query and to clear the cache when the data in these tables changed.  And such code needed to be written for each request that we want to cache ... <br><br>  But this is what Hibernate is already doing on its own!  Hibernate knows what caches need to be cleared for a particular data change, and you just need to ‚Äúpeep‚Äù, what it does on one node, and do the same thing on the others. <br><br><h4>  New Cache API for Hibernate </h4><br>  In Hibernate terminology, one Cache is a single piece of cache that contains a set of equally typed data.  For example, data from one table, or data, for example, immediately for all cached database queries.  In order to control the caching behavior in Hibernate, the programmer indicates which CacheProvider to use.  This may be, for example, EhCacheProvider or trivial HashtableCacheProvider or NoCacheProvider. <br><br>  In version 3.3, Hibernate introduced a new caching API, dividing one old Cache interface into several: <br>  <a href="">Region</a> <br>  ** <a href="">General Data Region</a> <br>  **** <a href="">Query Results Region</a> <br>  **** <a href="">Timestamps Region</a> <br>  ** <a href="">Transactional Data Region</a> <br>  **** <a href="">Collection Region</a> <br>  **** <a href="">Entity Region</a> <br><br>  Also, each Region now provides methods for working out of context (destroy, getSize, getName ()), the General Data Region has standard get / put methods, and the transaction data region organizes data <a href="">handling</a> through the Strategy pattern - <a href="">CollectionRegionAccessStrategy</a> for the Collection Region and <a href="">EntityRegionAccessStrategy</a> for Entity Region.  These interfaces include, among other things, commands for managing data locks in transactions. <br><br>  We already had a cache for Hibernate, based on the old API.  But he had to be abandoned because the old API did not allow to distinguish the addition of data to the cache from the database from their update (as they are outdated).  Therefore, the first step was the implementation of the new API, but on the basis of Region / Strategy.  It was a great help that Hibernate has implementations of adapters from the new API to the old one.  You can simply peek at the implementation, for example, EntityRegionAccessStrategy based on non-transaction cache.  What was done. <br><br>  The basis of the API is Region: <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } }</font> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> <ol><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { /** <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> * Default no-operation implementation of {@link ArpSiteRegionListener}. <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> * Will be replaced by cluster listener if cluster extension is installed <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> * <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> * @author vlsergey {at} gmail {dot} com <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> */ <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { @Override <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { // noop } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } @Override <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { // noop } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; /** <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> * @param regionName <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> *      The name of the cache region. <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> * @param useHardReferences <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> *      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> *      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt; <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> *      otherwise. <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> */ @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } @Override <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } @Override <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><font color="#008000"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { // to let JVM know it shall not GC it because of timeout value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } @Override <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } @Override <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } @Override <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } @Override <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } @Override <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } @Override <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } @Override <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } @Override <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } @Override <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><font color="#0000ff"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } @Override <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> <li></li><li> <code><font color="black"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } } <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></font></code> </li> </ol> <code><font color="gray"><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">abstract</font> <font color="#0000ff">class</font> SoftRegion implements ArpSiteRegion, Cache, SoftRegionMBean { <font color="#008000">/**</font> <font color="#008000">* Default no-operation implementation of {@link ArpSiteRegionListener}.</font> <font color="#008000">* Will be replaced by cluster listener if cluster extension is installed</font> <font color="#008000">*</font> <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> <font color="#008000">*/</font> <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements ArpSiteRegionListener { <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onClear() { <font color="#008000">// noop</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> onRemove(Object key) { <font color="#008000">// noop</font> } } <font color="#0000ff">private</font> AtomicLong clears = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> AtomicLong hits = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">protected</font> final AtomicLong lastTimestamp = <font color="#0000ff">new</font> AtomicLong(); <font color="#0000ff">protected</font> volatile ArpSiteRegionListener listener = <font color="#0000ff">new</font> NoOpListener(); <font color="#0000ff">private</font> final Map&lt;Object, Object&gt; map; <font color="#0000ff">private</font> AtomicLong miss = <font color="#0000ff">new</font> AtomicLong(0); <font color="#0000ff">private</font> final String regionName; <font color="#008000">/**</font> <font color="#008000">* @param regionName</font> <font color="#008000">*      The name of the cache region.</font> <font color="#008000">* @param useHardReferences</font> <font color="#008000">*      &lt;code&gt;true&lt;/code&gt; if cache must use hard references instead of</font> <font color="#008000">*      {@link java.lang.ref.SoftReference}s. &lt;code&gt;false&lt;/code&gt;</font> <font color="#008000">*      otherwise.</font> <font color="#008000">*/</font> @SuppressWarnings( <font color="#A31515">"unchecked"</font> ) SoftRegion(String regionName, boolean useHardReferences) { <font color="#0000ff">this</font> .regionName = regionName; <font color="#0000ff">if</font> (useHardReferences) { map = <font color="#0000ff">new</font> ConcurrentHashMap&lt;Object, Object&gt;(); } <font color="#0000ff">else</font> { map = Collections .&lt;Object, Object&gt; synchronizedMap( <font color="#0000ff">new</font> ReferenceMap( ReferenceMap.SOFT, ReferenceMap.SOFT, <font color="#0000ff">true</font> )); } } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> clear() { map.clear(); clears.incrementAndGet(); listener.onClear(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> boolean contains(Object key) { Object value = map.get(key); <font color="#0000ff">if</font> (value != <font color="#0000ff">null</font> ) { <font color="#008000">// to let JVM know it shall not GC it because of timeout</font> value.hashCode(); <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; } <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> destroy() throws CacheException { map.clear(); } <font color="#0000ff">protected</font> Object get(Object key) { final Object result = map.get(key); <font color="#0000ff">if</font> (result == <font color="#0000ff">null</font> ) { miss.incrementAndGet(); } <font color="#0000ff">else</font> { hits.incrementAndGet(); } <font color="#0000ff">return</font> result; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getBuildCalls() { <font color="#0000ff">return</font> miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getCacheSize() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getClearCalls() { <font color="#0000ff">return</font> clears.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountInMemory() { <font color="#0000ff">return</font> map.size(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getElementCountOnDisk() { <font color="#0000ff">return</font> 0; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getGetCalls() { <font color="#0000ff">return</font> hits.get() + miss.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getHits() { <font color="#0000ff">return</font> hits.get(); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getHitsPercent() { <font color="#0000ff">long</font> hits = <font color="#0000ff">this</font> .hits.get(); <font color="#0000ff">long</font> total = hits + miss.get(); <font color="#0000ff">if</font> (total == 0) { <font color="#0000ff">return</font> 0; } <font color="#0000ff">return</font> ( <font color="#0000ff">int</font> ) (hits * 100 / total); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String getName() { <font color="#0000ff">return</font> regionName; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> getSizeInMemory() { <font color="#0000ff">return</font> -1; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">int</font> getTimeout() { <font color="#0000ff">return</font> Timestamper.ONE_MS * 60000; <font color="#008000">// ie. 60 seconds</font> } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">long</font> nextTimestamp() { final <font color="#0000ff">long</font> next = Timestamper.next(); lastTimestamp.set(next); <font color="#0000ff">return</font> next; } <font color="#0000ff">protected</font> <font color="#0000ff">void</font> put(Object key, Object value) { map.put(key, value); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove(Object key) { map.remove(key); listener.onRemove(key); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> <font color="#0000ff">void</font> setListener(ArpSiteRegionListener listener) { <font color="#0000ff">this</font> .listener = listener; } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> Map&lt;?, ?&gt; toMap() { <font color="#0000ff">return</font> Collections.unmodifiableMap(map); } <font color="#0000ff">@Override</font> <font color="#0000ff">public</font> String toString() { <font color="#0000ff">return</font> <font color="#A31515">"SoftReferenceCache ["</font> + regionName + <font color="#A31515">", "</font> + <font color="#0000ff">this</font> .getSizeInMemory() + <font color="#A31515">']'</font> ; } }</font> * This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  The implementation of the basic methods is rather trivial.  We implement the <a href="">ArpSiteRegion</a> interface, since it contains an additional setListener () method, which we will need later to implement the work in the cluster.  We will need the nextTimestamp / getTimeout methods for TimestampRegionImpl.  Additional methods like getClearCalls / getBuildCalls / getHitsPercent / clear are defined in the <a href="">Cache</a> interface of our application and are needed to manage the cache via <a href="">JMX</a> .  Hibernate, unfortunately, does not provide such functionality.  And how does he know about the features of our cache;) <br><br>  <a href="">SoftCollectionRegion</a> and <a href="">SoftEntityRegion</a> are very similar, so I‚Äôll give only the second one: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> SoftEntityRegion extends SoftTransactionalDataRegion implements </li><li>  EntityRegion { </li><li></li><li>  <font color="#008000">/ **</font> </li><li>  <font color="#008000">* @param regionName</font> </li><li>  <font color="#008000">* The name of the cache region.</font> </li><li>  <font color="#008000">* /</font> </li><li>  SoftEntityRegion (String regionName, </li><li>  CacheDataDescription cacheDataDescription) { </li><li>  super (regionName, cacheDataDescription); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> EntityRegionAccessStrategy buildAccessStrategy (AccessType accessType) { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">new</font> EntityRegionAccessStrategy () { </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> boolean afterInsert (Object key, Object value, Object version) { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> boolean afterUpdate (Object key, Object value, </li><li>  Object currentVersion, Object previousVersion, SoftLock <font color="#0000ff">lock</font> ) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .remove (key); </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> evict (Object key) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .remove (key); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> evictAll () { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .clear (); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> Object get (Object key, <font color="#0000ff">long</font> txTimestamp) { </li><li>  <font color="#0000ff">return</font> SoftEntityRegion.  <font color="#0000ff">this</font> .get (key); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> EntityRegion getRegion () { </li><li>  <font color="#0000ff">return</font> SoftEntityRegion.  <font color="#0000ff">this</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> boolean insert (Object key, Object value, Object version) { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> SoftLock lockItem (Object key, Object version) { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> SoftLock lockRegion () { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">null</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> boolean putFromLoad (Object key, Object value, </li><li>  <font color="#0000ff">long</font> txTimestamp, Object version) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .put (key, value); </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> boolean putFromLoad (Object key, Object value, </li><li>  <font color="#0000ff">long</font> txTimestamp, Object version, boolean minimalPutOverride) { </li><li>  <font color="#0000ff">if</font> (minimalPutOverride &amp;&amp; contains (key)) { </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; </li><li>  } </li><li></li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .put (key, value); </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">true</font> ; </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> remove (Object key) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .remove (key); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> removeAll () { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .clear (); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> unlockItem (Object key, SoftLock <font color="#0000ff">lock</font> ) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .remove (key); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> unlockRegion (SoftLock <font color="#0000ff">lock</font> ) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .clear (); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> boolean update (Object key, Object value, </li><li>  Object currentVersion, Object previousVersion) { </li><li>  SoftEntityRegion.  <font color="#0000ff">this</font> .remove (key); </li><li>  <font color="#0000ff">return</font> <font color="#0000ff">false</font> ; </li><li>  } </li><li>  }; </li><li>  } </li><li></li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  The main work is performed through the strategy interface.  The idea of ‚Äã‚Äãusing a separate interface is that in a transactional implementation, each transaction will use a separate instance of EntityRegionAccessStrategy.  However, with us we simply redirect all requests to the SoftEntityRegion.  The implementation features of the update (), unlockItem (), and unlockRegion () methods were peeped at the EntityAccessStrategyAdapter class.  From the point of view of the future ‚Äúscrewing‚Äù of the cluster, it is important to note that the listener from SoftRegion will respond only to the remove () and clear () methods. <br><br>  Who will call them?  Hibernate itself will call them when it's finished working with individual objects.  For example, it will always call evict (), or evictAll () - if we did something with requests.  It is this predictable work with the cache that will enable us to easily add cluster support in the future - just by tracking the clear / remove calls. <br><br>  But with QueryCache is not so simple.  The problem is that Hibernate ... does not remove old requests from the cache.  That is, it does not invalidate the values ‚Äã‚Äãin the cache if something happens.  Its behavior is more cunning: Next to the QueryResultsRegion, there is a TimestampsRegion, which, judging by its name, contains the timestamps of recent changes to individual tables in the database.  Therefore, if we need to perform a database query, Hibernate does the following: <br><ol><li>  Take a timestamp for a table from TimestampsRegion </li><li>  Get result from QueryResultsRegion </li><li>  Have a result take a timestamp </li><li>  Compare with what was taken from TimestampsRegion.  If the value is greater, then the result in QueryResultsRegion is considered more recent than the last change, and it can be used. </li><li>  Important - if there is no value for a particular table in TimestampsRegion, Hibernate considers that its data has not changed. </li><li>  If the timestamp of the result is less than that taken from TimestampsRegion, then the value is considered obsolete.  However, the value is not removed from the cache, but is replaced by what will be received from the database. </li></ol><br>  In this case, in the case of any requests for UPDATE or INSERT, a new timestamp for the table will be placed in the TimestampsRegion, but the QueryCache will not be notified about this in any way! <br><br>  From the 5th point, by the way, it follows that for normal operation, even without a cluster, in no case can you use a SoftReference to store values ‚Äã‚Äãin a TimestampsRegion.  Even in the description UpdateTimestampsCache says - " <i>we recommend that</i> you not delete values ‚Äã‚Äãfrom this cache at all.  Fortunately, it does not take up much space in the memory. <br><br>  From the description above it is clear that the simple interception clear () / remove () will do nothing - they are simply not called.  It is useless to intercept put () from QueryCache, and it may be too late - the timestamp might have already been updated.  Therefore, two options are possible: <br><ul><li>  Make a complete implementation of TimestampsRegion at the cluster level.  Namely, track the timestamps issued on each machine and synchronize them correctly at the cluster level </li><li>  Do dirty khaki </li></ul><br>  Unfortunately, the first approach for the CMS Arp.Site turned out to be unacceptable - the synchronization of the Timestamp implies a kind of common counter like AtomicLong, but working within the cluster.  That is, all calls to it must be synchronized - every addition of an object to the QueryCache cache.  And this would have a very negative impact on performance - synchronous processing on the network is much more expensive than asynchronous. <br><br>  To implement the asynchronous approach here, we performed a dirty hack.  Namely, we wrote TimestampCache in such a way that he knows what values ‚Äã‚ÄãHibernate puts into it.  This is bad because Hibernate in the next version may change the type of values.  Therefore, it is called a hack.  But it works: <br><br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a></code> <ol><li>  <font color="#0000ff">class</font> TimestampRegionImpl extends SoftRegion implements ArpSiteTimestampRegion { </li><li>  <font color="#008000">/ **</font> </li><li>  <font color="#008000">* Default no-operation implementation of</font> </li><li>  <font color="#008000">* {@link ArpSiteTimestampRegionListener}.</font>  <font color="#008000">Will be replaced by cluster</font> </li><li>  <font color="#008000">* listener if cluster extension is installed</font> </li><li>  <font color="#008000">*</font> </li><li>  <font color="#008000">* @author vlsergey {at} gmail {dot} com</font> </li><li>  <font color="#008000">* /</font> </li><li>  <font color="#0000ff">private</font> <font color="#0000ff">static</font> final <font color="#0000ff">class</font> NoOpListener implements </li><li>  ArpSiteTimestampRegionListener { </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> onInvalidate (Serializable space) { </li><li>  <font color="#008000">// no op</font> </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> onPreInvalidate (Serializable space) { </li><li>  <font color="#008000">// no op</font> </li><li>  } </li><li></li><li>  } </li><li></li><li>  <font color="#0000ff">private</font> ArpSiteTimestampRegionListener listener = <font color="#0000ff">new</font> NoOpListener (); </li><li></li><li>  <font color="#008000">/ **</font> </li><li>  <font color="#008000">* @param regionName</font> </li><li>  <font color="#008000">* The name of the region.</font> </li><li>  <font color="#008000">* /</font> </li><li>  TimestampRegionImpl (String regionName) { </li><li>  super (regionName, <font color="#0000ff">true</font> ); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> evict (Object key) { </li><li>  super.remove (key); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> evictAll () { </li><li>  super.clear (); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> Object get (Object key) { </li><li>  <font color="#0000ff">return</font> super.get (key); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> invalidate (Serializable space) { </li><li>  Long ts = Long.valueOf (nextTimestamp ()); </li><li>  super.put (space, ts); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> preInvalidate (Serializable space) { </li><li>  Long ts = Long.valueOf (nextTimestamp () + getTimeout ()); </li><li>  super.put (space, ts); </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> put (Object key, Object value) { </li><li>  super.put (key, value); </li><li></li><li>  final Serializable space = (Serializable) key; </li><li>  final Long timestamp = (Long) value; </li><li></li><li>  final boolean inFuture = timestamp.longValue ()&gt; lastTimestamp.get (); </li><li>  <font color="#0000ff">if</font> (inFuture) { </li><li>  listener.onPreInvalidate (space); </li><li>  } <font color="#0000ff">else</font> { </li><li>  listener.onInvalidate (space); </li><li>  } </li><li>  } </li><li></li><li>  <font color="#0000ff">@Override</font> </li><li>  <font color="#0000ff">public</font> <font color="#0000ff">void</font> setTimstampListener ( </li><li>  ArpSiteTimestampRegionListener timestampListener) { </li><li>  <font color="#0000ff">this</font> .listener = timestampListener; </li><li>  } </li><li>  } </li></ol>  <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font> </blockquote><br><br>  The main work is done in the put () method.  To understand the logic of the method, you need to dwell on what exactly Hibernate does with the timestamp cache.  Namely, three operations are performed: <br><ul><li>  Get operation - take a timestamp for a region (hidden behind Serializable) </li><li>  Operation invalidate - take a new timestamp and put it in the cache for the region </li><li>  Operation preinvalidate - take a new timestamp, add 60 seconds and put in the cache </li></ul><br>  Our implementation is trying to track which of the last two actions Hibernate performs, and, in the future, to extend this action to all nodes in the cluster.  For this, of course, we will need another Listener ( <a href="">ArpSiteTimestampRegionListener</a> ).  We track the difference between invalidate and preinvalidate by the value that is placed in the cache, after which the listener is notified accordingly.  And for the cluster, for notifications from other machines, we made our two methods (available through the <a href="">ArpSiteTimestampRegion</a> interface) invalidate and preInvalidate, which repeat the logic of Hibernate.  A feature of the implementation is that we do not need to know the current timestamp values ‚Äã‚Äãon different machines in order to invalidate the caches in the cluster.  For example, the invalidate (region) method will take a new timestamp on the <i>current</i> machine in order to disable the QueryCache on the <i>current</i> machine.  He is not interested in what the value was on the machine where Hibernate requested the invalidation. <br><br>  The logic of Hibernate, by the way, who cares, is in the class <a href="">UpdateTimestampsCache</a> and <a href="">StandardQueryCache</a> .  If they change, our implementation of TimestampRegionImpl may have to be rewritten.  This is the price we pay for the hack. <br><br><h4>  To be continued </h4><br>  In this topic, I described how the implementation of caches with ‚Äúnotches‚Äù was made so that you could link separate caches on separate machines into a single cluster solution.  The nicks are as follows: <br>  - the classes SoftRegion and TimestampRegionImpl call the methods of the interfaces ArpSiteRegionListener and ArpSiteTimestampRegionListener, if you need to notify other machines in the cluster about the events <br>  - in turn, through the ArpSiteRegion and ArpSiteTimestampRegion interfaces, they provide an opportunity to notify them about events in the cluster. <br><br>  And although the work with the cluster has not yet been described, the caches are already working. <br><br>  In the next topic - how to make a cluster using JGroups now. </div><p>Source: <a href="https://habr.com/ru/post/91333/">https://habr.com/ru/post/91333/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../91326/index.html">The blocking of ClamAV 0.94 caused a surge in spam and stop mail servers</a></li>
<li><a href="../91327/index.html">Socialize the site with Facebook</a></li>
<li><a href="../91328/index.html">Custom Types in Hibernate</a></li>
<li><a href="../91331/index.html">BinaryHTTPService or how to help HTTPService accept ByteArray data</a></li>
<li><a href="../91332/index.html">Moon made of cheese</a></li>
<li><a href="../91335/index.html">The Second Open Technology Forum was held</a></li>
<li><a href="../91336/index.html">ToriBash - Violence Perfected</a></li>
<li><a href="../91341/index.html">A couple of useful jQuery plugins</a></li>
<li><a href="../91342/index.html">With invitations (invites), something is not as it was before ...</a></li>
<li><a href="../91343/index.html">The Pirate bay a year after the sentence</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>