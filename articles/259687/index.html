<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How Wargaming Common Menu Works</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 

 I want to share with the community development experience JS-widget interproject navigation. It is a module that connects to most sites o...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How Wargaming Common Menu Works</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br><br>  I want to share with the community development experience JS-widget interproject navigation.  It is a module that connects to most sites of the Wargaming universe ( <a href="http://wotblitz.ru/">Portals</a> , <a href="http://wiki.wargaming.net/ru/">Wiki</a> , <a href="http://wargag.ru/">WarGag</a> , etc.). <br><br>  Its main task is to provide the user with convenient navigation between different services of the same subject.  But it also performs a number of other functions, for example, it displays personal notifications, brief dossiers on user profiles in each of our games, and much more. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/aac/e21/ebe/aace21ebe8c140edaf3b14b04e99dcc0.PNG"><br><a name="habracut"></a><br><h3>  First, a little about the requirements. </h3><br>  There are quite a lot of sites on which the menu is embedded, and they all have a different design and layout.  So historically, the sites are built on different frameworks and at different times, use different libraries and sometimes do not look at each other at all. <br><br>  The menu should be at the very top of the page, that is, in fact, be displayed first, so that the user does not notice that the menu is a separate component. <br><br>  Our sites should be removed the need to monitor the release of new projects, changing the addresses of existing ones.  Updating menu items should occur without the participation of sites. <br><br>  The menu should be able to show the current user data on his account - the presence / absence of profiles in different projects, a brief current statistics for each of the projects. <br><br>  Also, through the menu, the user must have access to private notifications, while the flow of notifications for each user can be quite intensive. <br><br><h3>  Now about the implementation </h3><br>  In essence, the project consists of two independent applications - the frontend and backend, which are deployed separately and exist independently. <br><br>  The frontend is a JS application, a set of static files, and the backend is a JSON-API with access to data using a special token.  This scheme was chosen mainly because it is necessary to withstand a decent load (total for all sites) and to ensure operation without downtime with regular updates to the new version, with minimal consequences in the event of a ‚Äúfall‚Äù, since this would mean partial inoperability. almost all of our public web services. <br><br><h4>  CDN </h4><br>  The availability of the frontend is provided by a multi-level caching scheme: the user's browser is a CDN server, the origin server is a spare origin server.  The CDN server works as a caching proxy.  Origin servers are located in different data centers, and at the CDN configuration level, alternate fallback is configured for them. <br><br>  Cache disability occurs using the CDN provider purge API command, and the browser cache is managed using the URL GET parameters. <br><br><h4>  Connection </h4><br>  Sites connect the menu by simply adding a script loader to the page and determining the place where it should be drawn: <br><br><pre><code class="javascript hljs">&lt;script id=<span class="hljs-string"><span class="hljs-string">"common_menu_loader"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> charset=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span> data-language=<span class="hljs-string"><span class="hljs-string">"en"</span></span> src=<span class="hljs-string"><span class="hljs-string">"http://menu.com/loader.min.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> &lt;div id=<span class="hljs-string"><span class="hljs-string">"common_menu"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  Then the menu begins to live its own life - it loads up the necessary components, refers to the backend for the necessary data, etc.  For example, dropdowns with games, notifications and user data are loaded and rendered only when they are needed. <br><br>  Since for the site connecting the menu, the script loader is a third-party script that can generally take longer to load than the local statics of the project, it is possible to connect the loader asynchronously (with the async attribute) - so that site loading is not blocked, and the fact of successful loading using callback. <br><br>  Consumer sites do not participate in menu releases, which means that there is no way to change the src loader to reset the browser cache, so HTTP headers are used: <br><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">expires</span></span> <span class="hljs-number"><span class="hljs-number">7d</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> = /loader.min.js { <span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Cache-Control <span class="hljs-string"><span class="hljs-string">"no-cache, must-revalidate"</span></span>; }</code> </pre><br>  With them, the browser every time when accessing the file of the loader sends a HEAD request to the server, and if the server responds with 304 Not Modified, the file is taken from the cache. <br><br><h4>  Assembly </h4><br>  Frontend rolls out on prod servers assembled package.  Grunt builds, he sticks together and minifies source files, compiles scss to css, assembles icons into sprites (SVG and PNG separately), generates predefined link sets for the menu.  Also in dev-mode, it is possible to start the project ‚Äúby itself‚Äù on express'e with backend emulation. <br><br>  All icons are drawn in SVG vector format and compressed into one sprite by the Grunt plugin <b>dr-svg-sprites</b> .  This allows you to not worry about a separate copy of the increased size for the retina and wins the file size.  In addition, for old IE, this plugin generates a PNG sprite, which is very convenient and saves us from headaches and a lot of bugs. <br><br><h4>  Configuration </h4><br>  To configure the menu to the needs of a particular site, data-attributes are used, which the site developer determines when the downloader is embedded. <br><br><pre> <code class="javascript hljs">&lt;script id=<span class="hljs-string"><span class="hljs-string">"common_menu_loader"</span></span> type=<span class="hljs-string"><span class="hljs-string">"text/javascript"</span></span> charset=<span class="hljs-string"><span class="hljs-string">"utf-8"</span></span> data-notifications_enabled=<span class="hljs-string"><span class="hljs-string">"1"</span></span> data-chat_enabled=<span class="hljs-string"><span class="hljs-string">"0"</span></span> data-intro_tooltips_enabled=<span class="hljs-string"><span class="hljs-string">"1"</span></span> src=<span class="hljs-string"><span class="hljs-string">"http://menu.com/loader.min.js"</span></span>&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  To the case when the site at the time of embedding the loader itself does not know the values ‚Äã‚Äãof all the parameters, there is an alternative way to transfer the parameters - to write the corresponding cookies: <br><br><pre> <code class="javascript hljs">cm.options.notifications_enabled=<span class="hljs-string"><span class="hljs-string">"1"</span></span> cm.options.chat_enabled=<span class="hljs-string"><span class="hljs-string">"0"</span></span> cm.options.intro_tooltips_enabled=<span class="hljs-string"><span class="hljs-string">"1"</span></span></code> </pre><br>  And there is a JS-API through which you can do the same asynchronously. <br><br><pre> <code class="javascript hljs">WG.CommonMenu.update({ <span class="hljs-attr"><span class="hljs-attr">notifications_enabled</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">chat_enabled</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">intro_tooltips_enabled</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span> });</code> </pre><br><br><h4>  Storage settings </h4><br>  "Configuration" to display the menu on the site is selected based on these parameters.  The initial configs store the structure of our resources in a normalized form.  At the assembly stage, specific sets of links are compiled for each combination (excluding the impossible ones).  Formed sets are uploaded to the site and used to render the template. <br><br>  The menu can save the user's personal settings regardless of the site where it is connected without the participation of the backend.  To save user preferences, Local Storage is used, or Cookies in case the first one is unavailable.  Since the menu has its own domain, it allows you to save the settings cross-domain, that is, you can work as if all the menu sites being opened are on the same domain.  To achieve this effect, a static HTML file is used, which is loaded in a frame.  This frame is on your domain and stores information in LS or in cookies, and PostMessage API is used for data exchange. <br><br><h4>  Notifications </h4><br>  The menu can send desktop notifications to the user (if supported by the browser).  They are used to report new unread messages when the tab with the site is inactive or the browser is minimized.  Since the user can have several tabs open at the same time with different sites, but everyone has a menu and everyone knows how to send a notification, we taught different instances of the application to communicate with each other so that they can agree on who will send the notification.  This is done using the same frame that stores data in Local Storage or Cookies, and provides access to them through the JS API. <br><br><img src="https://habrastorage.org/files/a86/2cb/187/a862cb187baf40299df3afe93d153f03.PNG"><br><br><h4>  Layout </h4><br>  The menu scaling is adapted for mobile devices, and automatically changes the view on the pre-set breakpoint.  As a template engine, we use the <a href="http://ejohn.org/blog/javascript-micro-templating/">John Resig solution</a> , slightly modified for our needs.  It is modest in terms of functionality, but it allows using the same templates in JS and on the backend in Jinja2 and does not require heavy libraries to be loaded. <br><br>  For most of the links, the designers had to make a non-standard underscore (the underline line should be below the standard and appear smoothly).  We did it this way: <br><br><pre> <code class="css hljs"><span class="hljs-selector-class"><span class="hljs-selector-class">.link</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:after</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">content</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-bottom</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span> solid; <span class="hljs-attribute"><span class="hljs-attribute">position</span></span>: absolute; <span class="hljs-attribute"><span class="hljs-attribute">top</span></span>: <span class="hljs-number"><span class="hljs-number">50%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">left</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">width</span></span>: <span class="hljs-number"><span class="hljs-number">100%</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">margin-top</span></span>: <span class="hljs-number"><span class="hljs-number">8px</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">transition</span></span>: .<span class="hljs-number"><span class="hljs-number">3s</span></span> ease opacity; } <span class="hljs-selector-class"><span class="hljs-selector-class">.link</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:hover</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:after</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">opacity</span></span>: .<span class="hljs-number"><span class="hljs-number">8</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">border-bottom-width</span></span>: <span class="hljs-number"><span class="hljs-number">1px</span></span>; // IE8 hack }</code> </pre><br><br>  We first decided to animate the width of the underscore, but it looked too irregular.  Then there was the option of approaching the underscore from below, but in the end we decided to dwell on the simple appearance of transparency. <br><br><img src="https://habrastorage.org/files/5e1/70f/5dd/5e170f5ddc5547de956b7a87cda2abd8.jpg"><br><br>  Another design feature was the different styling of the elements in the Games menu, depending on the number of these very elements. <br><br><img src="https://habrastorage.org/files/e64/cf7/e17/e64cf7e17e74474182f697240f651352.jpg"><br><br><img src="https://habrastorage.org/files/21f/6dd/5c1/21f6dd5c1c2c45259ceb3dfee9b2dbb6.jpg"><br><br><img src="https://habrastorage.org/files/1ce/edd/102/1ceedd10222b41fd8583d450795dca57.jpg"><br><br>  Because  There may be a different number of games on the menu in different regions, I had to immediately write all the options in the code.  We did it in pure CSS.  About the cunning method of counting elements have already been written on Habr√© <a href="http://habrahabr.ru/post/252181/">here</a> and <a href="http://habrahabr.ru/company/uprock/blog/198322/">here</a> . <br>  In short, using the pseudo-selector <b>: nth-last-child (n),</b> we find out if we have at least <b>n</b> elements.  How to check that we have exactly <b>n</b> elements?  Just add the pseudo-selector <b>: first-child</b> (or <b>nth-child (1)</b> ). <br>  Thus we will select the first element from <b>n</b> .  The remaining elements can be selected using the selector <b>~</b> . <br>  For example, this is how we stylize a list with six nested elements: <br><br><pre> <code class="css hljs"><span class="hljs-selector-tag"><span class="hljs-selector-tag">li</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:nth-child(1)</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:nth-last-child(6)</span></span>, <span class="hljs-selector-tag"><span class="hljs-selector-tag">li</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:nth-child(1)</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:nth-last-child(6)</span></span> ~ <span class="hljs-selector-tag"><span class="hljs-selector-tag">li</span></span> { ... }</code> </pre><br><br><h4>  User profile </h4><br>  If the user of the site is currently logged in, then the menu contacts the backend for data on this user.  Such calls are periodically repeated to update the UI. <br><br>  The backend is built on Twisted workers, each of which is responsible for a specific functionality;  for example, there is a separate server for issuing a user profile, a separate server for notifications, and so on. <br><br>  However, publicly accessible servers are the tip of the iceberg.  All the main work takes place in Twisted-demons, which process events arriving through AMQP queues and store the results of work on different databases. <br><br>  Their main task is to collect the necessary data on internal web components. <br><br><img src="https://habrastorage.org/files/67e/42c/8d1/67e42c8d133a4cf683b7e738f17f9c97.png"><br><br><h4>  Data storage </h4><br>  For quick access to data from the outside, a Redis-cache is organized, which is filled and updated by the same workers.  Reading from this cache comes directly from Nginx, using <a href="http://wiki.nginx.org/HttpRedis">the HttpRedis module</a> with fallback to the Python server. <br><br>  Redis used to be the main data repository.  He was completely satisfied because he had good performance and allowed not to worry about the obsolescence of sessions.  And data access was instant: all data was in memory.  However, the amount of data inexorably grew, and soon we began to face the problem of lack of RAM.  For Redis to work correctly, it is necessary that at least as much memory is available as it is already in use, since the storage dump is periodically dumped onto the disk, for which the process is being forked. <br><br>  We decided to use the MySQL database with the TokuDB engine as a permanent storage (TokuDB was chosen because of good data compression and the ability to quickly change the structure of the tables) and Redis for storing the session key.  Redis is also used as cache storage. <br><br><h4>  JS disabled </h4><br>  If the user has javascript disabled in the browser, the backend can secure and render the menu on the server.  Then the mapping takes place in the frame.  For rendering, I use the same templates and styles as in JS. <br><br><h3>  Finally </h3><br>  The stated requirements are implemented, but the decision asks for the possibility of more flexible customization.  Initially, we calculated that it would be possible to put all the consumer sites in a clear structure, but in fact consumers are very different.  We will go in the direction of reducing the participation of menu developers to customize it, allowing each consumer to do it themselves. <br><br>  Also in the plans are a number of interesting features that using the Common Menu can be implemented and delivered to the user simultaneously on all web services in a short time. </div><p>Source: <a href="https://habr.com/ru/post/259687/">https://habr.com/ru/post/259687/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259675/index.html">Ruby and C. Part 4. We are on friendly terms with the accelerometer, gyroscope and range finder with Raphael.js</a></li>
<li><a href="../259677/index.html">Autopilot system for radio-controlled helicopter. Part 1: The Idea</a></li>
<li><a href="../259679/index.html">Native OmniDirectional shadows implementation in DirectX11</a></li>
<li><a href="../25968/index.html">Monkey outlet</a></li>
<li><a href="../259683/index.html">Autopilot system for radio-controlled helicopter. Part 2: Takeover</a></li>
<li><a href="../25969/index.html">Remote control foobar2000</a></li>
<li><a href="../259691/index.html">Battle "Listener vs Visitor" at the stadium antlr4</a></li>
<li><a href="../2597/index.html">New search engine searches for stolen financial information</a></li>
<li><a href="../25970/index.html">Ubuntu + Aptana = ... Installing Aptana in pictures</a></li>
<li><a href="../259701/index.html">Vim in full: Introduction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>