<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Auto-Renewable Subscription in iOS: proper implementation and pitfalls</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Auto-Renewable Subscription is probably the most difficult of all types of In-App Purchase in iOS, and it is not easy to implement it right from begin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Auto-Renewable Subscription in iOS: proper implementation and pitfalls</h1><div class="post__text post__text-html js-mediator-article">  Auto-Renewable Subscription is probably the most difficult of all types of In-App Purchase in iOS, and it is not easy to implement it right from beginning to end, and even after going through this difficult path, you may be faced with the refusal of the censors to accept your application. <br><br>  In this post, I will try to take you through all the stages of subscription implementation and, perhaps, I can dissuade you from this idea. <br><a name="habracut"></a><br><br><h4>  What is Auto-Renewable Subscription? </h4><br>  This type of In-App allows you to offer the user to subscribe to the content you provide with one action, and then forget about any payments - the money will be charged off monthly (you can choose a subscription period arbitrarily), and he will no longer need to think about that the subscription period comes to an end, and you don‚Äôt have to remind him about it once more - the money will be withdrawn from his account and sent to yours. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Also, you do not have to build in the ability to unsubscribe - this is possible only in the iOS settings - it is convenient, and the refusal button doesn‚Äôt call up the user. <br><br><h4>  Why can I refuse? </h4><br>  It would seem that such an ideal scheme, I will do a month trial, and then let them subscribe to access to the application for a dollar a month.  But it's not that simple.  The key words here are that Auto-Renewable Subscription is intended to provide Digital Content, and these words are very vague. <br><br>  For example, our application provides the user with several new words every day, and we thought it was quite a ‚Äúdigital content‚Äù.  The guys at Apple didn't think so.  As a result, I had to redo everything on Non-renewing subscriptions. <br><br>  Therefore, before you begin to introduce this type of shopping, think about whether you really fit what Apple put into the meaning of this mechanism. <br><br><h5>  Well, then move on to the implementation </h5><br>  The process of introducing Auto-Renewable Subscription consists of three steps: <br><ul><li>  Add and configure in iTunes Connect </li><li>  Configuring the server side for validation </li><li>  The implementation of in-app purchases </li></ul><br><h5>  Add and configure in iTunes Connect </h5><br>  First we need to get a <b>shared secret</b> , we will use it on the server side when accessing Apple servers.  Go to the section Manage In-App Purchases and generate it. <br><br>  In the same place, we add a new In-App of the appropriate type, select the duration, the name and fill in all the fields. <br><br>  We are especially interested in <b>Product ID</b> - we will request it from the application. <br><br>  We will also be asked to add a link to our Privcay Policy, without it it is impossible.  What is there to write?  Yes, it is not so important, we wrote something like this: <a href="http://www.easy10.com/privacy/">www.easy10.com/privacy</a> <br><br>  Well, we got the <b>shared secret</b> , there is a <b>Product ID</b> , go to the server part. <br><br><h5>  Configuring the server side for validation </h5><br>  This stage is necessary for us to check and decrypt the receipt that comes from Apple upon purchase and at the time when we are wondering if the subscription has been updated in the new month. <br><br>  This mechanism is implemented as follows: <br><ol><li>  In the application we make a purchase request </li><li>  We get a receipt from Apple </li><li>  We code it in base64 </li><li>  Sent to our server (these steps can be swapped) </li><li>  From our server we send to the server Apple </li><li>  They decrypt it and send it to us. </li><li>  We retrieve the necessary information and tell the application what the subscription status is </li></ol><br>  If you do not have your own server, steps 4-6 can be done using the service <a href="https://www.beeblex.com/">www.beeblex.com</a> <br><br>  If you want to have full control over the process, then in step 5 you should send to <a href="https://buy.itunes.apple.com/verifyReceipt">buy.itunes.apple.com/verifyReceipt</a> JSON the following content <br><pre><code class="hljs json">{ <span class="hljs-attr"><span class="hljs-attr">"receipt-data"</span></span> : <span class="hljs-string"><span class="hljs-string">"(receipt bytes here)"</span></span>, <span class="hljs-attr"><span class="hljs-attr">"password"</span></span> : <span class="hljs-string"><span class="hljs-string">"(shared secret bytes here)"</span></span>//  shared secret }</code> </pre> <br>  In response to step 6, we get the following JSON <br><pre> <code class="hljs pgsql">{ "status" : <span class="hljs-number"><span class="hljs-number">0</span></span>, "receipt" : { (receipt here) }, "latest_receipt" : "(base-64 encoded receipt here)", "latest_receipt_info" : { (latest receipt <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> here) } }</code> </pre> <br><br>  If <b>status</b> = 0, then everything is fine.  If it is 21006, then our user has not renewed the subscription and we need to stop providing content.  All other codes can be viewed here: <br>  <a href="http://developer.apple.com/library/ios/">Status codes for auto-renewable subscriptions</a> <br><br>  In the field of <b>receipt</b> we will be most interested in the value of <b>expires_date</b> - we compare it with the current one and on the basis of this we make some decisions.  If the user has not canceled your subscription, it will be automatically updated. <br><br><h6>  And how to test all this? </h6><br>  To do this, we need to create a test user in iTunes Connect and on the server send a request to check receipt at <a href="https://sandbox.itunes.apple.com/verifyReceipt">sandbox.itunes.apple.com/verifyReceipt</a> <br><br>  I want to draw your attention to the fact that in test mode the subscription will be automatically renewed <b>only six times</b> .  And that's all.  This is almost not written anywhere, and I spent sleepless nights, not understanding what was the reason that expires_date was not changed by me.  It is in this.  Therefore, you will have to create a new user to test this particular moment of self-renewal. <br><br>  In addition, the validity period in test mode is much shorter than it actually is, for example, a monthly subscription is compressed to 5 minutes. <br><br>  And lastly, I will give the code of purchases in the application itself.  Even though it was written in hundreds of places, since I decided to put it all together, I cannot do without this part. <br><br><h4>  The implementation of in-app purchases </h4><br>  For this, iOS is designed for StoreKit.framework.  It contains everything you need to make a purchase, track the progress of a transaction and restore purchases from a new device. <br><br>  First, we will need to add a transaction browser, which should support the SKPaymentTransactionObserver protocols - this is necessary to ensure that the transaction is not lost when the user has suddenly turned off the phone or the Internet. <b>Therefore</b> , it is best to do it somewhere in <pre> <code class="objectivec hljs">- (<span class="hljs-built_in"><span class="hljs-built_in">BOOL</span></span>)application:(<span class="hljs-built_in"><span class="hljs-built_in">UIApplication</span></span> *)application didFinishLaunchingWithOptions:(<span class="hljs-built_in"><span class="hljs-built_in">NSDictionary</span></span> *)launchOptions { <span class="hljs-comment"><span class="hljs-comment">//// [[SKPaymentQueue defaultQueue] addTransactionObserver:sharedPaymentsOberver];//   ///}</span></span></code> </pre> <br>  Create a PaymentsOberver class that will support all the protocols we need. <br><pre> <code class="objectivec hljs"><span class="hljs-meta"><span class="hljs-meta">#import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;Foundation/Foundation.h&gt;</span></span></span><span class="hljs-meta"> #import </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;StoreKit/StoreKit.h&gt;</span></span></span><span class="hljs-meta"> @interface PaymentsObserver : NSObject </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;SKPaymentTransactionObserver,SKProductsRequestDelegate,SKRequestDelegate&gt;</span></span></span><span class="hljs-meta"> - (void)requestProductData:(NSString*)ofProduct; - (BOOL)validateReceipt; @end</span></span></code> </pre><br><br>  First, we must form a request for the product, specifying the Product ID that we need, we can request an unlimited number of products at once. <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)requestProductData:(<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span>*)ofProduct { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-built_in"><span class="hljs-built_in">SKPaymentQueue</span></span> canMakePayments])<span class="hljs-comment"><span class="hljs-comment">//,      { NSLog(@"Request Began"); SKProductsRequest *request= [[SKProductsRequest alloc] initWithProductIdentifiers: [NSSet setWithObject:ofProduct]]; request.delegate = self; [request start]; } else { UIAlertView *noPayment = [[UIAlertView alloc]initWithTitle:NSLocalizedString(@"You can't make payments", nil ) message:NSLocalizedString(@"Enable payments in your account settings,please", nil) delegate:self cancelButtonTitle:NSLocalizedString(@"Ok", nil) otherButtonTitles: nil]; [noPayment show]; } }</span></span></code> </pre><br><br>  Upon completion of the request, we will receive a call to one of the SKProductRequestDelegate methods, if successful, this <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)productsRequest:(<span class="hljs-built_in"><span class="hljs-built_in">SKProductsRequest</span></span> *)request didReceiveResponse:(<span class="hljs-built_in"><span class="hljs-built_in">SKProductsResponse</span></span> *)response { <span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *myProduct = response.products; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([response.products count]) { <span class="hljs-built_in"><span class="hljs-built_in">SKPayment</span></span> *payment = [<span class="hljs-built_in"><span class="hljs-built_in">SKPayment</span></span> paymentWithProduct:[myProduct lastObject]]; [[<span class="hljs-built_in"><span class="hljs-built_in">SKPaymentQueue</span></span> defaultQueue] addPayment:payment]; } }</code> </pre><br>  In it, we add the resulting product to the transaction queue.  Apple deals with it further, throwing the user out of the window asking if he is sure of the purchase.  At the end of this process, we have a call to SKPaymentTransactionObserver, in which, depending on whether the transaction has passed, we continue our process, passing the receipt to the server for verification. <br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)paymentQueue:(<span class="hljs-built_in"><span class="hljs-built_in">SKPaymentQueue</span></span> *)queue updatedTransactions:(<span class="hljs-built_in"><span class="hljs-built_in">NSArray</span></span> *)transactions { <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">SKPaymentTransaction</span></span> *transaction <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> transactions) { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (transaction.transactionState) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SKPaymentTransactionStatePurchased</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> completeTransaction:transaction]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SKPaymentTransactionStateFailed</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> failedTransaction:transaction]; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-built_in"><span class="hljs-built_in">SKPaymentTransactionStateRestored</span></span>: [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> restoreTransaction:transaction]; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } }</code> </pre><br><br>  In case of successful verification of our receipt, we must provide the user with the content and, very importantly, remove the transaction from the queue. <br><br><pre> <code class="objectivec hljs">- (<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>)completeTransaction:(<span class="hljs-built_in"><span class="hljs-built_in">SKPaymentTransaction</span></span> *)transaction { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ([<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> validateReceipt:transaction.transactionReceipt]) { [<span class="hljs-keyword"><span class="hljs-keyword">self</span></span> provideContent: transaction.payment.productIdentifier]; <span class="hljs-comment"><span class="hljs-comment">// Remove the transaction from the payment queue. [[SKPaymentQueue defaultQueue] finishTransaction: transaction]; } }</span></span></code> </pre><br><br>  At the end of the subscription period, you will simply need to send a request to the server and check whether it is extended or not. <br><br>  This is all, to me, in the end, it was not useful in this project, but I hope that some of you will be luckier! </div><p>Source: <a href="https://habr.com/ru/post/148318/">https://habr.com/ru/post/148318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148311/index.html">Mobile development with Gideros Studio. Part 0</a></li>
<li><a href="../148312/index.html">Managing configuration files in .net projects</a></li>
<li><a href="../148313/index.html">The principles of minimalism in developing games for mobile platforms</a></li>
<li><a href="../148316/index.html">Installing Debian on a physically accessible system without a monitor and keyboard</a></li>
<li><a href="../148317/index.html">Defending against spam with IronPort c170</a></li>
<li><a href="../148319/index.html">Recognition of numbers by 4 points</a></li>
<li><a href="../148323/index.html">Bot for browser Angry Pets</a></li>
<li><a href="../148324/index.html">Sublime Text 2: How to create a snippet?</a></li>
<li><a href="../148325/index.html">Computational geometry, or how I became involved in Olympiad programming. Part 2</a></li>
<li><a href="../148326/index.html">The practice of using digital filters</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>