<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cyclic containers in Objective-C</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago I wrote this code: 



NSMutableArray *environments = [NSMutableArray new]; for (NSString *key in [dictionary allKeys]) { XCCEnvironment...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cyclic containers in Objective-C</h1><div class="post__text post__text-html js-mediator-article">  Some time ago I wrote this code: <br><br><pre><code class="objectivec hljs"><span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> *environments = [<span class="hljs-built_in"><span class="hljs-built_in">NSMutableArray</span></span> new]; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">NSString</span></span> *key <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> [dictionary allKeys]) { <span class="hljs-built_in"><span class="hljs-built_in">XCCEnvironment</span></span> *environment = [[<span class="hljs-built_in"><span class="hljs-built_in">XCCEnvironment</span></span> alloc] initWithName:key parameters:dictionary[key]]; [environments addObject:environments]; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> environments;</code> </pre> <br>  Notice the problem?  Me not. <br><a name="habracut"></a><br><h2>  Problem </h2><br>  After starting the program, I caught a crash: <br><br><pre> <code class="objectivec hljs">[__NSArrayM someSelector]: unrecognized selector sent to instance <span class="hljs-number"><span class="hljs-number">0x100211d80</span></span></code> </pre><br>  The 'environments' handler expected 'XCCEnvironment', and got 'NSMutableArray'. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      At first it was not clear why this happened, but when I looked at the code, I noticed that I just put the array in the same array: <br><br><pre> <code class="objectivec hljs"><span class="hljs-comment"><span class="hljs-comment">// ... NSMutableArray *environments = [NSMutableArray new]; // ... [environments addObject:environments]; // ...</span></span></code> </pre><br>  Documentation says nothing about the behavior of collections in such situations, the only useful material that I found on this subject is Mike Ash's article <a href="https://www.mikeash.com/pyblog/friday-qa-2014-01-10-lets-break-cocoa.html">Let's break Cocoa</a> . <br><br>  The article states that mutable arrays, dictionaries and sets go crazy if you create a so-called cyclic container.  In addition, when ARC is enabled, a memory leak appears - the collection keeps itself. <br><br><h2>  Decision </h2><br>  Usually, developers do not put the collection inside themselves.  This is as true as the statement that programmers do not dereference null pointers ‚Äî this is still happening and probably this is not what the programmer expects. <br><br>  I was absolutely sure that clang can prevent this error, but did not find any parameters / settings that include this check. <br><br>  In the end I decided to add this check.  The implementation took a couple of nights, but now it is on the <a href="https://github.com/llvm-mirror/clang/commit/5dc6c6cd87f3a86fe9d5ba9d1b3892252c7de248">trunk</a> . <br><br>  The patch includes checking the following collections: <br><br><ul><li>  NSMutableArray </li><li>  NSMutableDictionary </li><li>  NSMutableSet </li><li>  NSMutableOrderedSet </li><li>  NSCountedSet </li></ul><br>  and shows a warning if you are trying to add the collection inside it. <br>  The warning can be enabled / disabled by means of the flags '-wobjc-circular-container' / '- wno-objc-circular-container', respectively, although it is enabled by default. <br><br><h2>  Conclusion </h2><br>  The clang version of the trunk contains this functionality, but it is not yet available in Xcode, I believe that it will appear there after the next major release, maybe in a year. <br><br>  Anyway, having an open source compiler is great: you can fix it, improve it and make your life and the lives of others a little easier. <br><br>  Happy hacking! </div><p>Source: <a href="https://habr.com/ru/post/258249/">https://habr.com/ru/post/258249/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../258237/index.html">Moore's Law for Google Compute Engine: more power for the same money</a></li>
<li><a href="../258239/index.html">Night, street, LED, pharmacy</a></li>
<li><a href="../258241/index.html">The starting list of pages in the new assembly Vivaldi 1.0.178.2</a></li>
<li><a href="../258245/index.html">Inside the post is money. Another JavaScript contest</a></li>
<li><a href="../258247/index.html">What should we build Cache?</a></li>
<li><a href="../258251/index.html">Interface revolution. USB 3.1 Type-C in detail. Electronic technician</a></li>
<li><a href="../258253/index.html">Google transfers corporate applications to the cloud with access from outside</a></li>
<li><a href="../258255/index.html">Development of the system architecture through the service-resource model</a></li>
<li><a href="../258257/index.html">Microservices. Good, bad, evil</a></li>
<li><a href="../258259/index.html">First steps to smart bath</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>