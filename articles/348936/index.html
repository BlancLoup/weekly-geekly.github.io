<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic switching route in Juniper SRX</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A small tutorial on how to automate the switching of the network route in case of problems with one of the links. Then I ask under the cat 



 Legend...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic switching route in Juniper SRX</h1><div class="post__text post__text-html js-mediator-article">  A small tutorial on how to automate the switching of the network route in case of problems with one of the links.  Then I ask under the cat <br><br><img src="https://habrastorage.org/webt/gx/ev/2z/gxev2zsatemdxuogzcynox7oxka.png"><br><a name="habracut"></a><br>  Legend - there are two sites connected via L2 transport through two different providers.  It is necessary to provide connectivity between networks through ISP1 (primary route).  In case of problems with ISP1, automatically switch to ISP2. <br>  Devices - Juniper SRX. <br><br>  For the simplest implementation of this task, it is sufficient on FW1 to register a static route to the network 192.168.2.0 through 10.0.0.2 with a smaller metric and through 10.0.0.6 with a larger one.  On the FW2 the opposite.  But this method will work only when the interface is dropped towards one of the providers, which in practice is very rare, so you need to monitor the channel status in another way. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For this Juniper has an <b><a href="https://www.juniper.net/documentation/en_US/junos/topics/concept/security-rpm-overview.html">RPM (Real-Time Performance Monitoring) service</a></b> .  Here I also want to tell about its use in this scenario. <br><br>  On FW1, we have the usual static entry (on FW2 mirrored after 10.0.0.1): <br><br><pre><code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> routing-options <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> route <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span></code> </pre> <br>  In the routing table we see this entry: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">show</span></span> route <span class="hljs-number"><span class="hljs-number">192.168.2.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">192.168.2.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[Static/<span class="hljs-number"><span class="hljs-number">5</span></span>] <span class="hljs-number"><span class="hljs-number">1d</span></span> <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">14</span></span> &gt; to <span class="hljs-number"><span class="hljs-number">10.0.0.2</span></span> via reth1.<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  We configure the RPM service to control the primary connection.  We send a ping to the address 10.0.0.2 for 10 pieces per test with an interval of 5 seconds (probe-interval 5).  The interval between tests is also 5 seconds, i.e.  we actually have a continuous ping every 5 seconds.  If during the test we lost 5 pings in a row, the test is considered failed. <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN2 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW2 target address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN2 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW2 probe-<span class="hljs-keyword"><span class="hljs-keyword">count</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN2 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW2 probe-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN2 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW2 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN2 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW2 thresholds successive-loss <span class="hljs-number"><span class="hljs-number">5</span></span></code> </pre><br>  We adjust reaction to the test.  In case test fails, add route via ISP2 <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services ip-<span class="hljs-keyword"><span class="hljs-keyword">monitoring</span></span> <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> LAN2_FAILOVER <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> rpm-probe SLA_LAN2 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services ip-<span class="hljs-keyword"><span class="hljs-keyword">monitoring</span></span> <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> LAN2_FAILOVER <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> preferred-route route <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.6</span></span></code> </pre><br>  Checking: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">show</span></span> services ip-<span class="hljs-keyword"><span class="hljs-keyword">monitoring</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> - LAN2_FAILOVER (<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>: PASS) RPM Probes: Probe <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> Address <span class="hljs-keyword"><span class="hljs-keyword">Status</span></span> <span class="hljs-comment"><span class="hljs-comment">------------------ --------------- ---------- --------- SLA_LAN2 CHECK_PRIMARY_FW2 10.0.0.2 PASS Route-Action: route-instance route next-hop state ----------------- ----------------- ---------------- ------------- inet.0 192.168.2.0/24 10.0.0.6 NOT-APPLIED</span></span></code> </pre><br>  On FW2, you need to configure the mirror configuration: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN1 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW1 target address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN1 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW1 probe-<span class="hljs-keyword"><span class="hljs-keyword">count</span></span> <span class="hljs-number"><span class="hljs-number">10</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN1 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW1 probe-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN1 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW1 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span>-<span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services rpm probe SLA_LAN1 <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> CHECK_PRIMARY_FW1 thresholds successive-loss <span class="hljs-number"><span class="hljs-number">5</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services ip-<span class="hljs-keyword"><span class="hljs-keyword">monitoring</span></span> <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> LAN1_FAILOVER <span class="hljs-keyword"><span class="hljs-keyword">match</span></span> rpm-probe SLA_LAN1 <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> services ip-<span class="hljs-keyword"><span class="hljs-keyword">monitoring</span></span> <span class="hljs-keyword"><span class="hljs-keyword">policy</span></span> LAN1_FAILOVER <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> preferred-route route <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">next</span></span>-hop <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span></code> </pre><br>  You can test, disable one of the interfaces (vlan from trunk to FW), so that the link physically remains alive.  We lose about 6 pings from LAN1 to LAN2, after about 30 seconds.  We see the following on FW1: <br><br><pre> <code class="hljs sql"><span class="hljs-keyword"><span class="hljs-keyword">show</span></span> services ip-<span class="hljs-keyword"><span class="hljs-keyword">monitoring</span></span> <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span> - LAN2_FAILOVER (<span class="hljs-keyword"><span class="hljs-keyword">Status</span></span>: FAIL) RPM Probes: Probe <span class="hljs-keyword"><span class="hljs-keyword">name</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Test</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Name</span></span> Address <span class="hljs-keyword"><span class="hljs-keyword">Status</span></span> <span class="hljs-comment"><span class="hljs-comment">------------------ --------------- ---------- --------- SLA_LAN2 CHECK_PRIMARY_FW2 10.0.0.2 FAIL Route-Action: route-instance route next-hop state ----------------- ----------------- ---------------- ------------- inet.0 192.168.2.0/24 10.0.0.6 APPLIED</span></span></code> </pre><br>  In the routing table we see a new entry: <br><br><pre> <code class="hljs delphi"><span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">2.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> *[<span class="hljs-keyword"><span class="hljs-keyword">Static</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>:<span class="hljs-number"><span class="hljs-number">24</span></span>, metric2 <span class="hljs-number"><span class="hljs-number">0</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.6</span></span> via reth1.<span class="hljs-number"><span class="hljs-number">2</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">Static</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span>] <span class="hljs-number"><span class="hljs-number">1</span></span>d <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">26</span></span> &gt; <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span> via reth1.<span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  When the connection is restored via ISP1, the test goes back to the PASS state and removes the entry from the routing table. <br><br>  I draw your attention to the fact that the configuration should be a mirror for both devices. <br>  If there are several static routes, you can add them with new lines then.  There may also be several conditions; this is quite a flexible method. <br><br>  Thank you all, I hope it will save someone time. </div><p>Source: <a href="https://habr.com/ru/post/348936/">https://habr.com/ru/post/348936/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../348922/index.html">Privacy: birth and death. 3000 years of privacy history in pictures</a></li>
<li><a href="../348928/index.html">The Browser Exploitation Framework Project: from XSS to full control</a></li>
<li><a href="../348930/index.html">How we ran the standard examples from the STM32Cube library</a></li>
<li><a href="../348932/index.html">‚ÄúProgrammer pragmatist. The journey from the apprentice to the master ": briefly about the main thing (part two)</a></li>
<li><a href="../348934/index.html">FastTrack Training. "Network Basics". "Understanding the OSI Model". Part one. Eddie Martin December 2012</a></li>
<li><a href="../348938/index.html">Fastest Indian: Key / Value Trie-Based Container</a></li>
<li><a href="../348942/index.html">How to "learn to learn." Part 2 - Metacognitive Processes and Dudling</a></li>
<li><a href="../348944/index.html">Installation of a certification authority in the enterprise. Part 1</a></li>
<li><a href="../348946/index.html">Why you should not use a two-tier architecture in developing client-server applications</a></li>
<li><a href="../348950/index.html">Layout of a collection of abstracts of the conference in LaTeX</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>