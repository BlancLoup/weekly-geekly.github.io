<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Electronic signature in a trusted environment based on the bootable Ubuntu 14.04 LTS and Rutoken EDS Flash</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The procedure of imposing an electronic signature, designed to ensure the confirmation of the integrity of the signed document and its authorship, may...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Electronic signature in a trusted environment based on the bootable Ubuntu 14.04 LTS and Rutoken EDS Flash</h1><div class="post__text post__text-html js-mediator-article">  The procedure of imposing an electronic signature, designed to ensure the confirmation of the integrity of the signed document and its authorship, may in itself be unsafe. <br>  The main attacks on an ES are key theft and substitution of the information being signed, as well as unauthorized access to the ES tool (for example, a USB token) by stealing its PIN code. <br><br>  These attacks are implemented in various ways and at various levels.  At the OS level, it is the introduction of malware (viruses, spyware, rootkits, etc.) that is able to steal keys, PIN-codes and do document substitutions by reading and / or replacing data in the memory of the system process using various mechanisms " Hack "embedded in the OS. <br>  If we are talking about signing in the browser, then the man-in-the-middle attack is added to these attacks, which is aimed at modifying the signed data on a web page or at stealing a PIN code or intercepting the secure token to allow an attacker to pretend to be a subscriber of the system. .  In addition, the sites can attack the type of CSS, due to the disorder of the developers of the site. <br><br>  Obviously, to protect the client as much as possible during the ES procedure is possible only with a set of measures. <br>  These measures include: <br><ul><li>  application for electronic signature of cryptographic smart cards / USB-tokens with non-recoverable keys </li><li>  using the correct implementation of the TLS protocol on the site </li><li>  properly configuring this proper implementation of the TLS protocol </li><li>  use of special hardware to visualize signed data before applying a signature (trustscreen) </li><li>  Correct implementation of browser plug-ins and extensions that provide ES in the browser </li><li>  regulation of the signature procedure for the user, taking into account the security mechanisms built into the browser <br><ul><li>  TLS server certificate validation by user before ES </li><li>  launch of browser plug-ins and extensions only on a trusted site (now properly configured browsers warn the user about the launch) </li><li>  entering a token PIN at the request of a trusted site only </li><li>  response to a browser warning of receiving ‚Äúmixed‚Äù content ‚Äî part via HTTPS, part via HTTP </li></ul></li><li>  OS protection against malware (creating a trusted environment) </li></ul><br>  Some time ago, our company released a new <a href="http://www.rutoken.ru/products/all/rutoken-ecp-flash/">Rutoken EDS Flash</a> .  This two-in-one device is a cryptographic token and a FLASH-controlled memory in a single package.  At the same time, the controller allows you to configure FLASH-memory in such a way that the attributes of the settings can not be changed without knowing the PIN-code to the device. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In this article, we will make a custom Ubuntu 14.04 LTS, in which we ‚Äúpack‚Äù smartcard drivers and <a href="http://www.rutoken.ru/products/all/rutoken-plugin/">Rutoken Plugin</a> .  We will write this OS to FLASH-memory of Rutoken EDS Flash (USB-live) and make it read-only with special means, so that without knowing the PIN-code, the attacker will not be able to remove this attribute. <br><br>  Thus, we will get a boot device, when loaded from which the user will immediately be able to sign documents in the browser on non-recoverable keys in a trusted environment, the integrity of which is guaranteed by the USB token controller. <br><a name="habracut"></a><br><br><h3>  Ubuntu image modification </h3><br>  As a machine for customizing Ubuntu, I also had Ubuntu. <br><br>  Training: <br><br><pre><code class="hljs swift">sudo su apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install squashfs-tools genisoimage</code> </pre> <br><br>  Download the ISO image of Ubuntu 14.04 and store it where necessary: <br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> ~/livecdtmp mv ubuntu-<span class="hljs-number"><span class="hljs-number">14</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>-desktop-i386.iso ~/livecdtmp <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/livecdtmp</code> </pre><br><br>  Mount the ISO image: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">sudo</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">su</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mkdir</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mnt</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mount</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">loop</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">ubuntu-14</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.04</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1-desktop-i386</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.iso</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">mnt</span></span></code> </pre><br><br>  Make an extract of the image: <br><pre> <code class="hljs dos">sudo su <span class="hljs-built_in"><span class="hljs-built_in">mkdir</span></span> extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rsync --exclude=/casper/filesystem.squashfs -a mnt/ extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span></code> </pre><br><br>  Well, and so on: <br><pre> <code class="hljs coffeescript">sudo su unsquashfs mnt<span class="hljs-regexp"><span class="hljs-regexp">/casper/filesystem.squashfs mv squashfs-root editsudo su cp /etc/resolv.conf edit/etc/</span></span> cp <span class="hljs-regexp"><span class="hljs-regexp">/etc/hosts edit/etc/</span></span> mount --bind <span class="hljs-regexp"><span class="hljs-regexp">/dev/</span></span> edit/dev chroot edit mount -t proc none /proc mount -t sysfs none /sys mount -t devpts none /dev/pts <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> HOME=/root <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> LC_ALL=C dbus-uuidgen &gt; /var/lib/dbus/machine-id dpkg-divert --local --rename --add /sbin/initctl ln -s /bin/<span class="hljs-literal"><span class="hljs-literal">true</span></span> /sbin/initctl</code> </pre><br><br>  Actually customization - installation of a smart card driver and plug-in: <br><pre> <code class="hljs coffeescript">pt-get install libccid libpcsclite1 pcscd mkdir <span class="hljs-regexp"><span class="hljs-regexp">/home/ubuntu/</span></span>.mozilla mkdir <span class="hljs-regexp"><span class="hljs-regexp">/home/ubuntu/</span></span>.mozilla<span class="hljs-regexp"><span class="hljs-regexp">/plugins chmod 776 /home/ubuntu/</span></span>.mozilla chmod <span class="hljs-number"><span class="hljs-number">776</span></span> /home<span class="hljs-regexp"><span class="hljs-regexp">/ubuntu/</span></span>.mozilla<span class="hljs-regexp"><span class="hljs-regexp">/plugins cp npCryptoPlugin.so /home/ubuntu/</span></span>.mozilla<span class="hljs-regexp"><span class="hljs-regexp">/plugins cp librtpkcs11ecp.so /home/ubuntu/</span></span>.mozilla/plugins</code> </pre><br><br>  And technical work on the creation of a new ISO: <br><pre> <code class="hljs dos">apt-get clean rm /var/lib/dbus/machine-id rm /sbin/initctl dpkg-divert --<span class="hljs-built_in"><span class="hljs-built_in">rename</span></span> --remove /sbin/initctl umount /proc || umount -lf /proc umount /sys umount /dev/pts <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span> sudo su umount edit/dev sudo su chmod +w extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.manifest chroot edit dpkg-query -W --showformat='${Package} ${Version}\n' &gt; extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.manifest cp extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.manifest extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.manifest-desktop sed -i '/ubiquity/d' extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.manifest-desktop sed -i '/casper/d' extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.manifest-desktop rm extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.squashfs mksquashfs edit extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.squashfs -<span class="hljs-built_in"><span class="hljs-built_in">comp</span></span> xz -e edit/boot printf $(sudo du -sx --block-size=<span class="hljs-number"><span class="hljs-number">1</span></span> edit | cut -f1) &gt; extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/casper/filesystem.size nano extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span>/README.diskdefines <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> extract-<span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> rm md5sum.txt <span class="hljs-built_in"><span class="hljs-built_in">find</span></span> -<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> f -print0 | sudo xargs -<span class="hljs-number"><span class="hljs-number">0</span></span> md5sum | grep -v isolinux/boot.cat | sudo tee md5sum.txt mkisofs -D -r -V "$IMAGE_NAME" -cache-inodes -J -l -b isolinux/isolinux.bin -c isolinux/boot.cat -no-emul-boot -boot-load-size <span class="hljs-number"><span class="hljs-number">4</span></span> -boot-info-table -o ../ubuntu-<span class="hljs-number"><span class="hljs-number">14</span></span>.<span class="hljs-number"><span class="hljs-number">04</span></span>.<span class="hljs-number"><span class="hljs-number">1</span></span>-desktop-i386-rutoken.iso .</code> </pre><br><br>  Ubuntu-14.04.1-desktop-i386-rutoken.iso is our bootable custom image (with installed smart-card drivers and Rutoken Plugin), which is ready to write to Rutoken EDS Flash. <br><br><h3>  Creating a boot device </h3><br><br>  First of all, we format Rutoken EDS FLASH with a special utility, setting the read-write attribute to the memory (under Windows): <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">rtadmin</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-F</span></span> 1 30000 <span class="hljs-selector-tag"><span class="hljs-selector-tag">u</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rw</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-o</span></span> 87654321 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-z</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rtPKCS11ECP</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre><br><br>  Then we write the ISO to it using UNETBootin (under ubuntu): <br><img src="https://habrastorage.org/files/6c7/65a/8bb/6c765a8bbe754751bbc0c948e629fa88.png"><br><br>  Set the size for the preserve file to 0. Then the bootable Ubuntu will store all changes in the RAM memory, and not on FLASH. <br>  After the image is written, use the read-only attribute of the device's FLASH memory using the special tools: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">rtadmin</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.exe</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-C</span></span> 1 <span class="hljs-selector-tag"><span class="hljs-selector-tag">ro</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">p</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">-c</span></span> 12345678 <span class="hljs-selector-tag"><span class="hljs-selector-tag">-z</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">rtPKCS11ECP</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.dll</span></span></code> </pre><br><br>  Now, no one without knowing the PIN of the device will be able to modify the Ubuntu image recorded on the FLASH memory. <br><br><h3>  What happened </h3><br><br>  Below is the download process from Rutoken EDS Flash and signing documents in the browser in a trusted environment: <br><br>  1. Boot menu in bios <br><br><img src="https://habrastorage.org/files/967/844/33c/96784433c1894cc38fbcb066eee26bba.JPG"><br><br>  2. Select the desired item in the loader menu <br><br><img src="https://habrastorage.org/files/9a2/324/87a/9a232487a32f42ed88d5ba6210871ccc.JPG"><br><br>  3. Ubuntu has booted, launch the browser, go to the demo system.  The browser asks the user for permission to run the plugin on the web page <br><br><img src="https://habrastorage.org/files/efd/435/3c9/efd4353c941c4d6692a790e1464b1a90.png"><br><br>  4. Allowing the ‚ÄúRutoken‚Äù plugin to load - click ‚ÄúAllow‚Äù in the upper right corner of the browser <br><br><img src="https://habrastorage.org/files/693/a01/def/693a01def1cf4d379fcc27e1c68ef771.png"><br><br>  5. F5 <br><br><img src="https://habrastorage.org/files/7d1/d80/d8d/7d1d80d8db2944629f3eb56a59d8b97e.png"><br><br>  6. Authorization in the system according to the certificate that is stored on Rutoken EDS Flash <br><br><img src="https://habrastorage.org/files/485/67f/ea3/48567fea3bbd442887c85c1a17b79919.png"><br><br>  Enter the PIN: <br><br><img src="https://habrastorage.org/files/acd/785/2c6/acd7852c65f04051853df544900d15ee.png"><br><br>  6. Signature of payment in your account <br><br><img src="https://habrastorage.org/files/a40/832/5fd/a408325fdc004432bb4888605dc77de8.png"><br><br><img src="https://habrastorage.org/files/5f9/7a2/8a1/5f97a28a1d974513a3dab8424491ca01.png"></div><p>Source: <a href="https://habr.com/ru/post/253619/">https://habr.com/ru/post/253619/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253609/index.html">The ‚Äúperfect storm‚Äù and how it is treated</a></li>
<li><a href="../253611/index.html">And for whom are you Habrahabr</a></li>
<li><a href="../253613/index.html">Mirantis OpenStack 6.0: now with plugins</a></li>
<li><a href="../253615/index.html">50% discount on e-books</a></li>
<li><a href="../253617/index.html">As I defended against phishing, and wrote a bicycle, but my own</a></li>
<li><a href="../253621/index.html">Meet the Rock Validate</a></li>
<li><a href="../253623/index.html">Anonymous payments: Dash or Bitcoin + Mixers?</a></li>
<li><a href="../253625/index.html">Lectures Technopark. Game design from idea to release</a></li>
<li><a href="../253627/index.html">How Big Data and Internet of Things affect data centers. Power usage. Part 1</a></li>
<li><a href="../253631/index.html">10 relatively unknown facts about K-Meleon</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>