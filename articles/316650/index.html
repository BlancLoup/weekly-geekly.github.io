<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pseudo-encapsulation of legacy include when there is no time to refactor</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today I want to consider the migration of code from the distant past to the modern framework. 

 The most common situation that I can cite as an examp...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pseudo-encapsulation of legacy include when there is no time to refactor</h1><div class="post__text post__text-html js-mediator-article">  Today I want to consider the migration of code from the distant past to the modern framework. <br><br>  The most common situation that I can cite as an example is <i>str_repeat ('very-', 20)</i> old code that does not even know classes is planned to be transferred or partially used in a modern framework, but there is no time to rewrite thousands of lines and dozens of dependencies.  This happens when the customer suddenly decides to significantly upgrade or develop a project that has been working without changes for 10+ years, and one parttime-oldschool programmer has sorted it off occasionally rebooting a couple of services and recovering passwords. <br><a name="habracut"></a><br>  I should note that this article was prompted to me by the description of the ‚ÄúGarbage Wrapper‚Äù from <a href="https://habrahabr.ru/users/search/" class="user_link">search</a> in the <a href="https://habrahabr.ru/post/316140/">comments</a> to my previous article. <br><br>  So, imagine that you have already come out of depression after seeing the code, the coffee is over, and now the moment has come when you are ready to start and have even installed <s>your favorite</s> suitable framework, but ... 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      After a short debug, it turns out that the whole project is built on hundreds of chains of inclodes and it is impossible to ‚Äúpull out‚Äù the necessary piece of code to make a service / model out of it. <br><br>  Take for example the classic file of that wonderful noPSR-era: <br><br><pre><code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// legacy_lib.php include("settings.inc.php"); require("functions.php"); require_once("database.connection.php"); define('SOME_CONST', 'value'); $var1 = funcName(CONST_2); function get_Var2A($param1, $param2) { return functionFromAnotherInclude($param2, $param1); } class myClass { var $data = ''; function getData() { global $var1; // do somethig return get_Var2A($var1, SOME_CONST); } } include_once("specialCode.php"); function needThis() { $obj = new myClass(); return unknownFunctionFromInclude() + $obj-&gt;getData(); } $var2 = needThis(); printr('{"param":' . $var2 . '; "var": ' . $var1 . '}');</span></span></code> </pre> <br>  In fact, such a file can often reach 1000+ lines and there are many times more dependencies. <br><br>  You can try to spread this code into classes, services, and so on.  But the likelihood that it will work the same way will go to zero. <br><br>  We need a quick solution, which will give the opportunity to start the task and make the refactor ‚Äúsmoother‚Äù well, or at all <s>to score</s> to postpone it for some time. <br><br>  I will not apply canonical design patterns here because in such situations it is very subjective.  I will propose only to use the <b>approaches</b> of these two: the flyweight and the adapter. <br><br>  We will need the adapted tool for launching and pseudo-encapsulating the legacy code, and the adapter for universal access to it. <br><br>  I deliberately do not use (term | template) s: "facade", "mapper", "decorator" and so on.  Undoubtedly, depending on what the legacy file (s) has and which structure it has - some or other (term | template) s may be more suitable. <br><br>  I aim at relative universality, so I mean that I will ‚Äúadapt‚Äù the result of the adapter to the needs of the service / model. <br><br>  Now more about each. <br><br>  The tasks of the <b>opportunist</b> in my case are as follows: <br><br><ol><li>  Change if necessary directory inclodes; </li><li>  Connect the required file; </li><li>  Buffer the result; </li><li>  Encapsulate global variables; </li><li>  Pseudo-encapsulate global functions; </li><li>  Provide access to all of the above. </li></ol><br>  <b>Adapter</b> Tasks: <br><br><ol><li>  Customize and create a fitter; </li><li>  To give the opportunity to work with the opportunist as with a normal object; </li><li>  Give the ability to override any methods and properties; </li><li>  To be a super class for ‚Äúfacade‚Äù, ‚Äúmapper‚Äù, ‚Äúdecorator‚Äù and other structural patterns </li></ol><br>  What we get as a result: <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyLib</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LegacyAbstractAdapter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Configure flyweight */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span> -&gt;setLegacyFile(<span class="hljs-string"><span class="hljs-string">'legacy_lib.php'</span></span>) -&gt;setLegacyPath(<span class="hljs-string"><span class="hljs-string">'/path/to/includes'</span></span>) ; } } $myLib = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> MyLib(); <span class="hljs-comment"><span class="hljs-comment">//   $var1 = $myLib-&gt;var1; $var2 = $myLib-&gt;var2; //   $myLib-&gt;var1 = 'some new value'; //    $res1 = $myLib-&gt;get_Var2A($param1, $param2); $res2 = $myLib-&gt;needThis(); //     $content = $myLib-&gt;getFlyweight()-&gt;getContent();</span></span></code> </pre> <br>  Now we also have the opportunity to decorate, make compositions and so on. <br><br><pre> <code class="php hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyLib</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">LegacyAbstractAdapter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/** * Configure flyweight */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">configure</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span> -&gt;setLegacyFile(<span class="hljs-string"><span class="hljs-string">'legacy_lib.php'</span></span>) -&gt;setLegacyPath(<span class="hljs-string"><span class="hljs-string">'/path/to/includes'</span></span>) ; } <span class="hljs-comment"><span class="hljs-comment">//   public function needThis() { return 'dummy value'; } //   public function get_Var2A($param1, $param2) { return '&lt;font&gt;' . $this-&gt;getFlyweight()-&gt;call('get_Var2A', [$param1, $param2]); . '&lt;/font&gt;'; } //  . }</span></span></code> </pre> <br>  And, in my opinion, only depending on the content of the final class ‚ÄúMyLib‚Äù - ‚Äúadapter‚Äù can be called something more appropriate. <br><br>  It is also possible to access the class declared inside the file: creating an instance, getting constants and calling its static methods. <br><br>  Although this can be done directly by referring to it "by name" - this possibility is present for abstraction.  In the event that such a class ceases to exist after the refactor, it will be sufficient only to replace one method of access to it, and not all calls. <br><br>  And, of course, there are a number of shortcomings, which should be said: <br><br><ul><li>  Global functions and classes continue to be global and accessible "directly", this approach only regulates access to them, so as not to "produce" more dependent code; </li><li>  Work speed  After conducting the test and referring to the functions 10 million times, the result was obtained in a time twice the ‚Äúnative‚Äù way.  Here we must take into account the load and justification.  Although, in my opinion, in most cases this will not be a significant problem; </li><li>  "Singleton".  It is impossible to create at the same time 2 adapters due to the fact that the inclusion can be performed only 1 time </li></ul><br>  Summary: if you do not have a few months on the refactor, but there is a small performance margin - I think you might find this useful: <a href="https://github.com/jced-artem/legacy-adapter">github</a> <br><br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/316650/">https://habr.com/ru/post/316650/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316634/index.html">What is a DBMS in RAM and how it effectively stores data</a></li>
<li><a href="../316636/index.html">What happens to teams when using BaseCamp, Trello, YouTrack, Smartsheet, Slack, YouGile. Review Part 1</a></li>
<li><a href="../316640/index.html">How to use custom fonts on the web and not go crazy</a></li>
<li><a href="../316646/index.html">State programming in UIControl</a></li>
<li><a href="../316648/index.html">Monopoly on DDoS: Two hackers have created a botnet of 1 million devices based on Mirai</a></li>
<li><a href="../316652/index.html">Using memcached and redis in high-load projects</a></li>
<li><a href="../316654/index.html">How to become a product manager. Part 2</a></li>
<li><a href="../316658/index.html">Archiving Microsoft SQL Server Databases</a></li>
<li><a href="../316660/index.html">AWS Snowmobile: transporting petabyte of data to the cloud on ... trucks from Amazon</a></li>
<li><a href="../316662/index.html">Amazon announced new projects for developers and "mere mortals"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>