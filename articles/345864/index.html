<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Import and convert LinguaLeo vocabulary to Anki flashcards</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Formulation of the problem 
 Those who learn English are probably familiar with Anki, a program for memorizing words, expressions, and any other infor...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Import and convert LinguaLeo vocabulary to Anki flashcards</h1><div class="post__text post__text-html js-mediator-article"><h2>  Formulation of the problem </h2><br>  Those who learn English are probably familiar with Anki, a program for memorizing words, expressions, and any other information using interval repetitions. <br><br>  Another popular service that doesn‚Äôt need to be introduced is LinguaLeo, when reading the original text, immediately send unfamiliar words for study, storing them in your own vocabulary along with pronunciation, image, word transcription and context in which it is used.  A couple of years ago, LinguaLeo introduced a system of interval repetitions, but unlike Anki, the repetition system is not as powerful and does not contain tuning capabilities. <br><br>  What if we try to <s>cross-</s> use the advantages of the two platforms <s>with the hedgehog</s> ?  Take the words themselves from Lingua Leo along with all the media files and information and use Anki's resources to memorize them. <br><a name="habracut"></a><br><h2>  Overview of solutions </h2><br>  There are already several ready-made solutions for the task, but all of them are not very user friendly and require a lot of additional actions: you need to create recording models, card templates, add css styles, upload media files separately, etc.  etc. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition, they are all executed either as a separate program ( <a href="">LinguaGet</a> ), or as additions to the browser ( <a href="https://chrome.google.com/webstore/detail/anki-leo-lingualeo-dictio/mpaohidlipnfnkbogpmanchjfjpdgcml%3Fhl%3Dru">one</a> , <a href="https://chrome.google.com/webstore/detail/export-leo-lingualeo-dict/ljcmfepnkepjmnnokpdeinjefcipjbeo">two</a> ), which is also not very convenient.  In an ideal situation, I wanted the user to get new cards directly from Anki itself. <br><br><h2>  Selection of tools </h2><br>  Anki 2.0 is written in Python 2.7 and supports the add-ons system, which are separate python modules.  The stable version GUI uses PyQt 4.8. <br><br>  Thus, the task can be described in one sentence: <i>we write an addition on python that runs directly from Anki and does not require any action from the user other than entering a login and password from LinguaLeo.</i> <br><br><h2>  Decision </h2><br>  The whole process can be divided into three parts: <br><br><ol><li>  Log in and retrieve a dictionary from LinguaLeo. </li><li>  Convert the data to Anki cards. </li><li>  Creating a graphical interface. </li></ol><br><h3>  Data import </h3><br>  LinguaLeo does not contain the official API, but by digging through the browser add-on code you can find two necessary addresses: <br><br> <code>userDictUrl = "http://lingualeo.com/userdict/json" <br> loginURL = "http://api.lingualeo.com/api/login"</code> <br> <br>  The authorization procedure is nothing complicated and is well described in this <a href="https://habrahabr.ru/post/276495/">article on Habr√©</a> . <br><br>  JSON dictionary contains a hundred words on each page.  Using urlencode, we pass in the filter parameter the value all, and in the page parameter the number of the desired page, we go through each of them and save our dictionary. <br><br><div class="spoiler">  <b class="spoiler_title">The code of the authorization and import dictionary module</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urllib2 <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> cookielib <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> CookieJar <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Lingualeo</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, email, password)</span></span></span><span class="hljs-function">:</span></span> self.email = email self.password = password self.cj = CookieJar() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">auth</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> url = <span class="hljs-string"><span class="hljs-string">"http://api.lingualeo.com/api/login"</span></span> values = {<span class="hljs-string"><span class="hljs-string">"email"</span></span>: self.email, <span class="hljs-string"><span class="hljs-string">"password"</span></span>: self.password} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.get_content(url, values) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_page</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, page_number)</span></span></span><span class="hljs-function">:</span></span> url = <span class="hljs-string"><span class="hljs-string">'http://lingualeo.com/ru/userdict/json'</span></span> values = {<span class="hljs-string"><span class="hljs-string">'filter'</span></span>: <span class="hljs-string"><span class="hljs-string">'all'</span></span>, <span class="hljs-string"><span class="hljs-string">'page'</span></span>: page_number} <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.get_content(url, values)[<span class="hljs-string"><span class="hljs-string">'userdict3'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_content</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, url, values)</span></span></span><span class="hljs-function">:</span></span> data = urllib.urlencode(values) opener = urllib2.build_opener(urllib2.HTTPCookieProcessor(self.cj)) req = opener.open(url, data) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> json.loads(req.read()) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_all_words</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" The JSON consists of list "userdict3" on each page Inside of each userdict there is a list of periods with names such as "October 2015". And inside of them lay our words. Returns: type == list of dictionaries """</span></span> words = [] have_periods = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> page_number = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> have_periods: periods = self.get_page(page_number) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> len(periods) &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> period <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> periods: words += period[<span class="hljs-string"><span class="hljs-string">'words'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: have_periods = <span class="hljs-keyword"><span class="hljs-keyword">False</span></span> page_number += <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> words</code> </pre><br></div></div><br><h3>  Convert the data to Anki cards </h3><br>  The data in Anka is stored as follows: the <u>collection</u> contains <u>models</u> that include css-style, a list of <u>fields</u> and <u>html-</u> design <u>templates for</u> cards (front and back). <br><br>  In our case, there will be five fields: the word itself, translation, transcription, link to the file with pronunciation, link to the file with the image. <br><br>  Filling in all the fields we get a <u>record</u> .  In turn, two <u>cards</u> can be made from the record: ‚ÄúEnglish - Russian‚Äù and ‚ÄúRussian - English‚Äù <br><br><img src="https://i.imgur.com/qoASZ8P.png" alt="flash-card"><br><br>  Cards lie in <u>decks</u> ( <s>Koshchei dies in an egg, and an egg in a casket</s> ). <br><br>  In addition to the above, we will need functions that download audio and images. <br><br><div class="spoiler">  <b class="spoiler_title">Module code with utilities for creating models, records, etc.</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> os <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> random <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> randint <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> urllib2 <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> urlopen <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> aqt <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> mw <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> anki <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> notes <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> lingualeo <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> styles fields = [<span class="hljs-string"><span class="hljs-string">'en'</span></span>, <span class="hljs-string"><span class="hljs-string">'transcription'</span></span>, <span class="hljs-string"><span class="hljs-string">'ru'</span></span>, <span class="hljs-string"><span class="hljs-string">'picture_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'sound_name'</span></span>, <span class="hljs-string"><span class="hljs-string">'context'</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_templates</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collection)</span></span></span><span class="hljs-function">:</span></span> template_eng = collection.models.newTemplate(<span class="hljs-string"><span class="hljs-string">'en -&gt; ru'</span></span>) template_eng[<span class="hljs-string"><span class="hljs-string">'qfmt'</span></span>] = styles.en_question template_eng[<span class="hljs-string"><span class="hljs-string">'afmt'</span></span>] = styles.en_answer template_ru = collection.models.newTemplate(<span class="hljs-string"><span class="hljs-string">'ru -&gt; en'</span></span>) template_ru[<span class="hljs-string"><span class="hljs-string">'qfmt'</span></span>] = styles.ru_question template_ru[<span class="hljs-string"><span class="hljs-string">'afmt'</span></span>] = styles.ru_answer <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (template_eng, template_ru) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">create_new_model</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(collection, fields, model_css)</span></span></span><span class="hljs-function">:</span></span> model = collection.models.new(<span class="hljs-string"><span class="hljs-string">"LinguaLeo_model"</span></span>) model[<span class="hljs-string"><span class="hljs-string">'tags'</span></span>].append(<span class="hljs-string"><span class="hljs-string">"LinguaLeo"</span></span>) model[<span class="hljs-string"><span class="hljs-string">'css'</span></span>] = model_css <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> field <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> fields: collection.models.addField(model, collection.models.newField(field)) template_eng, template_ru = create_templates(collection) collection.models.addTemplate(model, template_eng) collection.models.addTemplate(model, template_ru) model[<span class="hljs-string"><span class="hljs-string">'id'</span></span>] = randint(<span class="hljs-number"><span class="hljs-number">100000</span></span>, <span class="hljs-number"><span class="hljs-number">1000000</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Essential for upgrade detection collection.models.update(model) return model def is_model_exist(collection, fields): name_exist = 'LinguaLeo_model' in collection.models.allNames() if name_exist: fields_ok = collection.models.fieldNames(collection.models.byName( 'LinguaLeo_model')) == fields else: fields_ok = False return (name_exist and fields_ok) def prepare_model(collection, fields, model_css): """ Returns a model for our future notes. Creates a deck to keep them. """ if is_model_exist(collection, fields): model = collection.models.byName('LinguaLeo_model') else: model = create_new_model(collection, fields, model_css) # Create a deck "LinguaLeo" and write id to deck_id model['did'] = collection.decks.id('LinguaLeo') collection.models.setCurrent(model) collection.models.save(model) return model def download_media_file(url): destination_folder = mw.col.media.dir() name = url.split('/')[-1] abs_path = os.path.join(destination_folder, name) resp = urlopen(url) media_file = resp.read() binfile = open(abs_path, "wb") binfile.write(media_file) binfile.close() def send_to_download(word): picture_url = word.get('picture_url') if picture_url: picture_url = 'http:' + picture_url download_media_file(picture_url) sound_url = word.get('sound_url') if sound_url: download_media_file(sound_url) def fill_note(word, note): note['en'] = word['word_value'] note['ru'] = word['user_translates'][0]['translate_value'] if word.get('transcription'): note['transcription'] = '[' + word.get('transcription') + ']' if word.get('context'): note['context'] = word.get('context') picture_url = word.get('picture_url') if picture_url: picture_name = picture_url.split('/')[-1] note['picture_name'] = '&lt;img src="%s" /&gt;' % picture_name sound_url = word.get('sound_url') if sound_url: sound_name = sound_url.split('/')[-1] note['sound_name'] = '[sound:%s]' % sound_name return note def add_word(word, model): collection = mw.col note = notes.Note(collection, model) note = fill_note(word, note) collection.addNote(note)</span></span></code> </pre><br></div></div><br><h3>  GUI creation </h3><br>  Since our addition seeks to minimalism, we only need: <br><br><ul><li>  two input fields (username and password from LingvaLeo) </li><li>  one check-box for importing only unexplored words </li><li>  two buttons (import and cancel) </li></ul><br><img src="https://i.imgur.com/XkXDYvc.png" alt="image"><br><br><div class="spoiler">  <b class="spoiler_title">Graphical interface</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">PluginWindow</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(QDialog)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, parent=None)</span></span></span><span class="hljs-function">:</span></span> QDialog.__init__(self, parent) self.initUI() <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initUI</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.setWindowTitle(<span class="hljs-string"><span class="hljs-string">'Import From LinguaLeo'</span></span>) <span class="hljs-comment"><span class="hljs-comment"># Window Icon if platform.system() == 'Windows': path = os.path.join(os.path.dirname(__file__), 'favicon.ico') loc = locale.getdefaultlocale()[1] path = unicode(path, loc) self.setWindowIcon(QIcon(path)) # Buttons and fields self.importButton = QPushButton("Import", self) self.cancelButton = QPushButton("Cancel", self) self.importButton.clicked.connect(self.importButtonClicked) self.cancelButton.clicked.connect(self.cancelButtonClicked) loginLabel = QLabel('Your LinguaLeo Login:') self.loginField = QLineEdit() passLabel = QLabel('Your LinguaLeo Password:') self.passField = QLineEdit() self.passField.setEchoMode(QLineEdit.Password) self.progressLabel = QLabel('Downloading Progress:') self.progressBar = QProgressBar() self.checkBox = QCheckBox() self.checkBoxLabel = QLabel('Unstudied only?') # Main layout - vertical box vbox = QVBoxLayout() # Form layout fbox = QFormLayout() fbox.setMargin(10) fbox.addRow(loginLabel, self.loginField) fbox.addRow(passLabel, self.passField) fbox.addRow(self.progressLabel, self.progressBar) fbox.addRow(self.checkBoxLabel, self.checkBox) self.progressLabel.hide() self.progressBar.hide() # Horizontal layout for buttons hbox = QHBoxLayout() hbox.setMargin(10) hbox.addStretch() hbox.addWidget(self.importButton) hbox.addWidget(self.cancelButton) hbox.addStretch() # Add form layout, then stretch and then buttons in main layout vbox.addLayout(fbox) vbox.addStretch(2) vbox.addLayout(hbox) # Set main layout self.setLayout(vbox) # Set focus for typing from the keyboard # You have to do it after creating all widgets self.loginField.setFocus() self.show()</span></span></code> </pre><br></div></div><br>  Adventure begins when, in addition to the designated, you want to create a progress bar so that the user does not think that the addition has died during the download process. <br><br>  For the progress of the bar to work without freezing the GUI, you need to create a separate thread (using QThread), where all data would be loaded and cards created, and only a progress counter would be sent to the graphical interface.  Here we are in trouble - the information in Anki is stored in the SQlite database and the program does not allow changing it from outside the main thread.  Solution: the main costly task is to download media files and transfer data to the progress bar in the second thread, while the main fields are filled and records are saved.  Thus, we get a working progress line without a frozen interface. <br><br><div class="spoiler">  <b class="spoiler_title">All GUI module code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># -*- coding: utf-8 -*- import locale import os import platform import socket import urllib2 from anki import notes from aqt import mw from aqt.utils import showInfo from PyQt4.QtGui import (QDialog, QIcon, QPushButton, QHBoxLayout, QVBoxLayout, QLineEdit, QFormLayout, QLabel, QProgressBar, QCheckBox) from PyQt4.QtCore import QThread, SIGNAL from lingualeo import connect from lingualeo import utils from lingualeo import styles class PluginWindow(QDialog): def __init__(self, parent=None): QDialog.__init__(self, parent) self.initUI() def initUI(self): self.setWindowTitle('Import From LinguaLeo') # Window Icon if platform.system() == 'Windows': path = os.path.join(os.path.dirname(__file__), 'favicon.ico') loc = locale.getdefaultlocale()[1] path = unicode(path, loc) self.setWindowIcon(QIcon(path)) # Buttons and fields self.importButton = QPushButton("Import", self) self.cancelButton = QPushButton("Cancel", self) self.importButton.clicked.connect(self.importButtonClicked) self.cancelButton.clicked.connect(self.cancelButtonClicked) loginLabel = QLabel('Your LinguaLeo Login:') self.loginField = QLineEdit() passLabel = QLabel('Your LinguaLeo Password:') self.passField = QLineEdit() self.passField.setEchoMode(QLineEdit.Password) self.progressLabel = QLabel('Downloading Progress:') self.progressBar = QProgressBar() self.checkBox = QCheckBox() self.checkBoxLabel = QLabel('Unstudied only?') # Main layout - vertical box vbox = QVBoxLayout() # Form layout fbox = QFormLayout() fbox.setMargin(10) fbox.addRow(loginLabel, self.loginField) fbox.addRow(passLabel, self.passField) fbox.addRow(self.progressLabel, self.progressBar) fbox.addRow(self.checkBoxLabel, self.checkBox) self.progressLabel.hide() self.progressBar.hide() # Horizontal layout for buttons hbox = QHBoxLayout() hbox.setMargin(10) hbox.addStretch() hbox.addWidget(self.importButton) hbox.addWidget(self.cancelButton) hbox.addStretch() # Add form layout, then stretch and then buttons in main layout vbox.addLayout(fbox) vbox.addStretch(2) vbox.addLayout(hbox) # Set main layout self.setLayout(vbox) # Set focus for typing from the keyboard # You have to do it after creating all widgets self.loginField.setFocus() self.show() def importButtonClicked(self): login = self.loginField.text() password = self.passField.text() unstudied = self.checkBox.checkState() self.importButton.setEnabled(False) self.checkBox.setEnabled(False) self.progressLabel.show() self.progressBar.show() self.progressBar.setValue(0) self.threadclass = Download(login, password, unstudied) self.threadclass.start() self.connect(self.threadclass, SIGNAL('Length'), self.progressBar.setMaximum) self.setModel() self.connect(self.threadclass, SIGNAL('Word'), self.addWord) self.connect(self.threadclass, SIGNAL('Counter'), self.progressBar.setValue) self.connect(self.threadclass, SIGNAL('FinalCounter'), self.setFinalCount) self.connect(self.threadclass, SIGNAL('Error'), self.setErrorMessage) self.threadclass.finished.connect(self.downloadFinished) def setModel(self): self.model = utils.prepare_model(mw.col, utils.fields, styles.model_css) def addWord(self, word): """ Note is an SQLite object in Anki so you need to fill it out inside the main thread """ utils.add_word(word, self.model) def cancelButtonClicked(self): if hasattr(self, 'threadclass') and not self.threadclass.isFinished(): self.threadclass.terminate() mw.reset() self.close() def setFinalCount(self, counter): self.wordsFinalCount = counter def setErrorMessage(self, msg): self.errorMessage = msg def downloadFinished(self): if hasattr(self, 'wordsFinalCount'): showInfo("You have %d new words" % self.wordsFinalCount) if hasattr(self, 'errorMessage'): showInfo(self.errorMessage) mw.reset() self.close() class Download(QThread): def __init__(self, login, password, unstudied, parent=None): QThread.__init__(self, parent) self.login = login self.password = password self.unstudied = unstudied def run(self): words = self.get_words_to_add() if words: self.emit(SIGNAL('Length'), len(words)) self.add_separately(words) def get_words_to_add(self): leo = connect.Lingualeo(self.login, self.password) try: status = leo.auth() words = leo.get_all_words() except urllib2.URLError: self.msg = "Can't download words. Check your internet connection." except ValueError: try: self.msg = status['error_msg'] except: self.msg = "There's been an unexpected error. Sorry about that!" if hasattr(self, 'msg'): self.emit(SIGNAL('Error'), self.msg) return None if self.unstudied: words = [word for word in words if word.get('progress_percent') &lt; 100] return words def add_separately(self, words): """ Divides downloading and filling note to different threads because you cannot create SQLite objects outside the main thread in Anki. Also you cannot download files in the main thread because it will freeze GUI """ counter = 0 problem_words = [] for word in words: self.emit(SIGNAL('Word'), word) try: utils.send_to_download(word) except (urllib2.URLError, socket.error): problem_words.append(word.get('word_value')) counter += 1 self.emit(SIGNAL('Counter'), counter) self.emit(SIGNAL('FinalCounter'), counter) if problem_words: self.problem_words_msg(problem_words) def problem_words_msg(self, problem_words): error_msg = ("We weren't able to download media for these " "words because of broken links in LinguaLeo " "or problems with an internet connection: ") for problem_word in problem_words[:-1]: error_msg += problem_word + ', ' error_msg += problem_words[-1] + '.' self.emit(SIGNAL('Error'), error_msg)</span></span></code> </pre><br></div></div><br>  Add error handling and that's it.  Addition is ready to go. <br><br>  There are plans to rewrite the plugin for the third python for the new, still beta versions of Anka and to use asynchronous loading of media files to speed up work. <br><br>  <a href="https://bitbucket.org/alex-altay/lingualeoanki">BitBucket</a> source code. <br>  Plugin page <a href="https://ankiweb.net/shared/info/1411073333">on Anki Add-ons forum</a> . </div><p>Source: <a href="https://habr.com/ru/post/345864/">https://habr.com/ru/post/345864/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../345852/index.html">DPI of mobile operators: from free Internet to number and location disclosure</a></li>
<li><a href="../345854/index.html">What to read on New Year's holidays</a></li>
<li><a href="../345856/index.html">Optimize the initialization stage of Django</a></li>
<li><a href="../345858/index.html">Russian AI Cup 2017 - the story of second place</a></li>
<li><a href="../345860/index.html">Where it is more profitable to buy currency: banks vs exchange</a></li>
<li><a href="../345870/index.html">Translation of the article by the founder of Debian, Jan Murdoch, ‚ÄúHow I Found myself in Linux‚Äù</a></li>
<li><a href="../345874/index.html">Publish the application in the AppStore. A play without dialogue in several acts</a></li>
<li><a href="../345876/index.html">Hack Hill's cipher? Easy</a></li>
<li><a href="../345880/index.html">IT history lawyer. Life is business outsourcing. Part 1</a></li>
<li><a href="../345882/index.html">Exhaustive javascript reference for your next job interview. Part 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>