<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extendable Classes - Extendable Builders!</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently, I was faced with a task that turned out to be much less trivial than it seemed at first glance. Let there be some class (in my example immut...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extendable Classes - Extendable Builders!</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage1/45b0977b/abe8ece3/1eb0a8fc/130bf145.jpg" align="left">  Recently, I was faced with a task that turned out to be much less trivial than it seemed at first glance.  Let there be some class (in my example immutable) for which there is a builder.  You must be able to inherit from this class, providing the builder inherited from its ancestor's builder.  Under the cut, I will show the course of my thoughts, bad options and the final solution of the problem. <br><a name="habracut"></a><br><h1>  Let's start with the obvious </h1>  We formalize the conditions of our problem in the code: <br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImmutableBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ImmutableBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Builder builder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } public static class Builder { public Builder setSomeString(String value) { // ... return this; } public Builder setSomeInt(int value) { // ... return this; } public ImmutableBase build() { return new ImmutableBase(this); } } }</span></span></code> </pre> <br>  Now we need to try to create some class that inherits from ImmutableBase.  Let's try the approach "in the forehead", not forgetting to change the access modifier from the constructor ImmutableBase to protected: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MyImmutable</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImmutableBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">MyImmutable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Builder builder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>(builder); <span class="hljs-comment"><span class="hljs-comment">// do more things } public static class Builder extends ImmutableBase.Builder { public Builder setSomeDouble(double value) { // ... return this; } @Override public MyImmutable build() { return new MyImmutable(this); } } public static void main(String[] args) { Builder builder = new Builder(); MyImmutable myImmutable = builder.setSomeDouble(0.0). setSomeInt(0).setSomeString("0").build(); } }</span></span></code> </pre><br>  At first glance it seems that everything is fine.  However, you only need to swap the order of calling the builder's methods, as sadness falls on us: <br><br><pre> <code class="bash hljs">MyImmutable.java:20: cannot find symbol symbol : method setSomeDouble(double) location: class ImmutableBase.Builder setSomeInt(0).setSomeDouble(0.0).build(); ^</code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Indeed, the methods defined in ImmutableBase.Builder return an instance of it, not an instance of its successor. <br><br><h1>  Second run </h1><br>  Immediately rejecting the idea of ‚Äã‚Äãredefining all the methods from his ancestor in MyImmutable.Builder, we begin to think.  A tempting option seems to spit on security and do something like <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> &lt;B extends Builder&gt; <span class="hljs-function"><span class="hljs-function">B </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSomeString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... return (B) this; }</span></span></code> </pre><br>  But, fortunately (there is nothing to spit on security!), This decision will not work, giving all the same error.  The fact is that in this case, java cannot itself infer a type based on how it is used, and therefore chooses the narrowest possible type based on constraints.  As we wrote extends Builder, this type is ImmutableBase.Builder.  If we didn't write this, it would be Object.  As a workaround, you can tell the compiler what type we are waiting for by writing this: <br><br><pre> <code class="java hljs">MyImmutable myImmutable = (MyImmutable) builder.setSomeString(<span class="hljs-string"><span class="hljs-string">"0"</span></span>). &lt;MyImmutable.Builder&gt;setSomeInt(<span class="hljs-number"><span class="hljs-number">0</span></span>).setSomeDouble(<span class="hljs-number"><span class="hljs-number">0.0</span></span>).build();</code> </pre><br>  But, you see, it will be completely inconvenient for the library user. <br><br><h1>  All your generic are belong to us! </h1><br>  The idea with generics was probably the right one, and therefore if you think a little more in this direction, you can get the following solution that works with our example: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Builder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">B</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Builder</span></span></span><span class="hljs-class">&lt;?&gt;&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> B </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSomeString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... return (B) this; } public B setSomeInt(int value) { // ... return (B) this; } public ImmutableBase build() { return new ImmutableBase(this); } }</span></span></code> </pre><br><br>  However, even here the terminal happiness is not reached: we got something not type-safe, and getting the error again is quite simple: <br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span></span>{ ImmutableBase.Builder&lt;Builder&gt; builder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImmutableBase.Builder&lt;Builder&gt;(); MyImmutable myImmutable = builder.setSomeString(<span class="hljs-string"><span class="hljs-string">"0"</span></span>). setSomeInt(<span class="hljs-number"><span class="hljs-number">0</span></span>).setSomeDouble(<span class="hljs-number"><span class="hljs-number">0.0</span></span>).build(); }</code> </pre><br>  will cause <br><br><pre> <code class="bash hljs">Exception <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> thread <span class="hljs-string"><span class="hljs-string">"main"</span></span> java.lang.ClassCastException: ImmutableBase<span class="hljs-variable"><span class="hljs-variable">$Builder</span></span> cannot be cast to MyImmutable<span class="hljs-variable"><span class="hljs-variable">$Builder</span></span> at MyImmutable.main(MyImmutable.java:24)</code> </pre><br>  That, given the fact that the user doesn‚Äôt caste anything, may cause a misunderstanding for those who have forgotten that the compiler itself inserts the necessary castes when processing generics.  Fail again, and seemingly fatal: the problem is that MyImmutable.Builder is a subclass of ImmutableBase.Builder, and we cannot get rid of this conditionally. <br><br><h1>  The empire strikes back </h1>  But do not be discouraged!  It is enough to show a little insight and guess that the class that sticks out to the user does not necessarily coincide with the class from which we inherit from MyImmutable.  Therefore, we do this: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImmutableBase</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ImmutableBase</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(InnerBuilder&lt;?&gt; builder)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... } protected static class InnerBuilder&lt;B extends InnerBuilder&lt;B&gt;&gt; { public B setSomeString(String value) { // ... return(B) this; } public B setSomeInt(int value) { // ... return (B)this; } public ImmutableBase build() { return new ImmutableBase(this); } } public static class Builder extends InnerBuilder&lt;Builder&gt; {} }</span></span></code> </pre><br><br>  So, we have a class InnerBuilder, which is not visible to the user, and he cannot do his dirty tricks with him;  and there is the Builder class, which is simply inherited from the first one, hiding implementation details from the user (ie, generics).  Then it is enough in MyImmutable to declare Builder as follows: <br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Builder</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImmutableBase</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">InnerBuilder</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Builder</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Builder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSomeDouble</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">double</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// ... return this; } @Override public MyImmutable build() { return new MyImmutable(this); } }</span></span></code> </pre><br>  And enjoy life, because the problem is finally solved.  Just in case, I recall two main ideas: <ul><li>  Make the Builder a generic class so that the returned type is as expected. </li><li>  To divide what will be inherited from and what the user will see so that he cannot maliciously use these generics and force them to cast to something wrong. </li></ul><br><br>  It is easy to understand that using this method and doing a deeper inheritance, but if you are going to do this, you probably should think about refactoring. <br><br>  <b>I hope someone will save time.</b>  <b>Successes!</b> </div><p>Source: <a href="https://habr.com/ru/post/125846/">https://habr.com/ru/post/125846/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../125835/index.html">QNX RTOS: Flow Planning</a></li>
<li><a href="../125836/index.html">Quick change of network settings</a></li>
<li><a href="../125839/index.html">Through what hole hacked the site?</a></li>
<li><a href="../125841/index.html">9 useful applications for amateurs</a></li>
<li><a href="../125845/index.html">Qt for Android (Necessitas Framework) - does it really work?</a></li>
<li><a href="../125849/index.html">DefCon: 10-year-old girl told about 0-day vulnerabilities in games on iOS and Android platforms</a></li>
<li><a href="../125851/index.html">Flexible, very flexible forms ... at ABBYY FlexiLayout Studio</a></li>
<li><a href="../125852/index.html">Patent drama with the stars</a></li>
<li><a href="../125855/index.html">Digest Wanted.VC # 9</a></li>
<li><a href="../125856/index.html">Rosreestr put in the free access satellite images of the Russian Federation with a resolution of 50 cm</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>