<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>FreeBSD 7.1 - i386 -> amd64 migration via SSH only :)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="There is a server that is located in a data center in Moscow. There is me who is in the county town of N ‚Ñ¢ :-) The only access to the server is SSH an...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>FreeBSD 7.1 - i386 -> amd64 migration via SSH only :)</h1><div class="post__text post__text-html js-mediator-article">  There is a server that is located in a data center in Moscow.  There is me who is in the county town of N ‚Ñ¢ :-) The only access to the server is SSH and Remote PDU for rebooting. <br><br>  There is a need to upgrade to FreeBSD amd64, updating the software and rebuilding the kernel in one. <br><br>  What happened to: <br>  FreeBSD hostname FreeBSD 7.1-RELEASE i386. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What happened after: <br>  FreeBSD hostname FreeBSD 7.1-RELEASE amd64. <br><br><a name="habracut"></a><br><br>  <b>Short disclamer:</b> <br><ul><li>  You do everything at your own peril and risk. </li><li>  I do not advise to do so.  True.  If it is possible to come or order KVM and install the system as usual - it is better to install as usual.  The installation and configuration of FreeBSD took a couple of hours, and this ‚Äúprocedure‚Äù (including reading mana and mocking Google) took me almost two days. </li><li>  We used materials from FreeBSD.org, OpenNet.ru, lissyara.su.  Well, google, where without it. </li></ul><br><br>  We take as a basis: <br><br>  FreeBSD 7.x i386. <br>  The presence of two HDD (or partitions). <br><br>  First, we need complete system and kernel sources (/ usr / src / directory).  You can install them via CVSup (src-all directive), or via sysinstall (sysinstall -&gt; Distribution -&gt; src). <br><br>  In principle, the source code does not weigh a lot and swing quickly. <br><br>  After that, we need to create a new kernel configuration for our system. <br><br> <code>cp /usr/src/sys/amd64/conf/GENERIC ~/&lt;_&gt; <br> ee &lt;_&gt; <br></code> <br><br>  Kernel options depend on your tasks and hardware, I will not give mine here.  The only thing I advise you to add from myself - <br><br> <code>options IPFIREWALL_DEFAULT_TO_ACCEPT <br></code> <br><br>  This is useful because  in the new system at the time of the first start there will be no ipfw configurations (and by default it blocks everything, including our SSH).  I got so :) I had to send the server to reboot and transfer the configuration. <br><br>  After we finish configuring the kernel, we ‚Äúinstall‚Äù our config back by copying.  The main thing is not to forget that we take and set the config not in sys / i386, as usual, but sys / amd64. <br><br>  I personally removed all the ‚Äúextra‚Äù options from /etc/make.conf that could interfere with the compilation - optimization, etc., which I advise you. <br><br>  After that, you need to collect the world: <br><br> <code>cd /usr/src/ <br> make -s buildworld TARGET_ARCH=amd64 <br></code> <br><br>  And the core: <br><br> <code>make -s buildkernel TARGET_ARCH=amd64 KERNCONF=&lt;_&gt; <br></code> <br><br>  With the -s switch, we say make that we don‚Äôt need to output every file, only the naming of the directories it collects. <br>  The whole procedure (C2D E7200) took about two to two and a half hours. <br><br>  Next, we assume that our second HDD is mounted on / backup /, which is clean. <br><br>  Install the world: <br> <code>make -s installworld TARGET_ARCH=amd64 DESTDIR=/backup/ <br></code> <br>  Install the kernel: <br> <code>make -s installkernel TARGET_ARCH=amd64 DESTDIR=/backup/ KERNCONF=&lt;_&gt; <br></code> <br>  Install configuration files, etc. trifle: <br> <code>cd etc/ <br> make -s distribution DESTDIR=/backup/ <br></code> <br><br>  At this step, there may be problems with the lack of any conf.  files (personally I swore sendmail and sshd).  They can be simply copied from the working system. <br><br>  Drag the core: <br><br>  cp -pr / backup / boot / kernel /boot/kernel.test <br><br>  And edit \ transfer the config.  files in / backup / etc.  We are interested in rc.conf (hostname, network settings), sshd_conf and passwd-shadow.  If you have not set default_to_accept, do not forget to open SSH in rc.firewall for yourself. <br><br>  It's time to try. <br><br>  For a one-time download, we will use nextboot.  This is a very good program that allows you to boot with another kernel \ world ONCE.  If the server is restarted, our old system will reboot. <br><br>  nextboot -D <br>  nextboot -o vfs.root.mountfrom = ufs: / dev / ad2s1d -k kernel.test <br><br>  The -D switch resets the nextboot configuration if it already exists.  -o vfs.root.mountfrom specifies where the root partition is located.  Naturally, instead of ad2s1d, your second disk \ partition should be specified, not mine, and -k is the path to the kernel relative to / boot /. <br><br><h4>  Last checklist: </h4><br><br><ul><li>  Check if the world and the core are installed in the right places. </li><li>  Check if the SSHd, rc.conf, passwd, shadow ... configuration files have been migrated ... </li><li>  Check if the network settings were migrated - resolv.conf, IP-alias (if any), again rc.conf </li><li>  Check if / etc / fstab has been migrated and fixed under the new system. </li><li>  Check the availability and contents of /boot/nextboot.conf </li><li>  Let us pray (depending on religiosity). </li></ul><br><br>  If all clauses are satisfied - sudo shutdown -r now <br><br>  If you did everything right, and you are also a little lucky and the system did not throw out the feint with your ears - we will see a working amd64 FreeBSD :) <br>  If you didn‚Äôt see it on the network in a few minutes - we reboot the server through remote power management and look for where we made a mistake :) <br><br>  It remains only to rebuild all the necessary software. </div><p>Source: <a href="https://habr.com/ru/post/50828/">https://habr.com/ru/post/50828/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../50819/index.html">4. Metaprogramming patterns. 19 Kyu. Salvation of drowning business of the hands of drowning people</a></li>
<li><a href="../50820/index.html">Mono brings C # to iPhone and Wii</a></li>
<li><a href="../50821/index.html">Modernization of the old-style telephone (telephone roulette).</a></li>
<li><a href="../50822/index.html">About attentiveness</a></li>
<li><a href="../50823/index.html">Mouse Control</a></li>
<li><a href="../50830/index.html">Martin Fowler - GUI Architectures. Part 1</a></li>
<li><a href="../50831/index.html">jQuery in Eclipse PDT, WTP / Zend Studio for Eclipse</a></li>
<li><a href="../50836/index.html">Cancel or cancel?</a></li>
<li><a href="../50837/index.html">Rasterization in Inkscape</a></li>
<li><a href="../50840/index.html">3 simple tips that will make your Rails application faster, part # 1</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>