<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Collect performance statistics and output results to SSMS as custom reports.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="So, we have a task to collect SQl-server performance statistics and further analysis of the results. What is it for? For example, you want to transfer...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Collect performance statistics and output results to SSMS as custom reports.</h1><div class="post__text post__text-html js-mediator-article">  So, we have a task to collect SQl-server performance statistics and further analysis of the results.  What is it for?  For example, you want to transfer a certain database from one server to another, and you need to calculate performance before and after transfer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/bc3/dd5/d0c/bc3dd5d0ce87971776a3752564e890db.jpg" alt="image"><br><br>  A little more.  There is a certain server, let's call it server-sql-001, on which the CRM and ERP databases of the company run.  And there is another server, let's call it server-sql-1c, on which DB 1C is running.  Server-sql-001 is a brand new server, with modern features, etc.  And server-sql-1c is a fairly average server by modern standards.  And so, all the bookkeeping is eager to move to server-sql-001 in order for them to be happy, to increase the productivity and speed of the excellent yellow program.  So there was a task to check, but is it true that everyone will be happy?  Or after the move will suffer performance and CRM and ERP and 1C?  Here is one of the examples for which we need to collect and analyze statistics. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Yes, you can collect all the necessary statistics into an excel file using the system monitor, then build graphs, etc.  But what if statistics collection continues for a week, a month?  And at intervals of 10 seconds?  Will it be convenient to work with such a file?  Well, see for yourself. <br><a name="habracut"></a><br><h5>  1. Creating a DB. </h5><br>  The first thing we need to do is create a database.  Run SQL Server Management Studio, connect to the server we need. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/25c/caf/007/25ccaf007b1e3831c87ab7d901729449.jpg" alt="image"><br><br>  After connecting to the instance, click File - Create - Create a query in the current connection (or just Ctrl + N).  In the window that appears we write the following code: <br><br> <code>CREATE DATABASE [s_statistic] <br> CONTAINMENT = NONE <br> ON PRIMARY <br> ( NAME = N's_statistic', FILENAME = N'D:\data\s_statistic.mdf' , SIZE = 5120KB , FILEGROWTH = 1024KB ) <br> LOG ON <br> ( NAME = N's_statistic_log', FILENAME = N'L:\log\s_statistic_log.ldf' , SIZE = 1024KB , FILEGROWTH = 10%) <br> GO</code> <br> <br>  If you do not like to create a database through requests, then do the following.  After connecting to the instance, right-click on the Databases - Create Database. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d28/945/c06/d28945c068ae61a9a516247f39c2cdcb.jpg" alt="image"><br><br>  Select the location of the database and click OK.  For our purposes, all other parameters can be left as default. <br>  The goal is to create a database.  And in what way is a matter of taste, as you like. <br><br><h5>  2. Create an ODBC source. </h5><br>  So, the database was created, now it's time to create a source where the System Monitor will write its statistics.  Select Start - Administration - ODBC data sources (for Windows Server 2012, it's easier to press Win + q, type odbc and press enter). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f83/8c1/45a/f838c145a6e0453c8a82c7aacf396334.jpg"><br><br>  We are interested in the System DSN tab.  Click Add, select SQL Server and click Finish.  In the Wizard for creating a new source that appears, we write a name, for example, statistic, if we wish, we can specify a description and specify which sql server we want to connect to, in this case server-sql-001.  (I advise you to write the name of the sql server manually, instead of choosing from the list. The reason is simple, if there are many SQL instances in the environment, the list of available SQL servers will take some time).  After entering the data, click Next.  Here you can choose which authentication method to choose.  Everything else is left as is.  Click Next and here you have to select the connection in the one created by us.  Tick ‚Äã‚ÄãUse default database and select our s_statistic.  Click Next, in the next window to make changes as desired.  Click Finish, check the data source, click OK and close the ODBC data source management console. <br><br><h5>  3. Creating and configuring a group of data collectors. </h5><br>  The third part of our ballet begins with the launch of Computer Management - the Performance section (Performance) - Data Collector Set (Data Collector Groups), right click on User Defined (Special) - New Data Collector Set (Create Group Data Collectors).  We give the name of the new group of data collectors, choose Create manually - Next - Create data logs (Performance counter) - Next - Add.  And here micro hell begins!  The number of various counters just rolls over.  I opted for several: <br><br>  ‚Ä¢ \ Memory \% utilization of allocated memory <br>  ‚Ä¢ \ Process (sqlserv) \% Processor Time <br>  ‚Ä¢ \ Processor (_Total) \% CPU utilization <br>  ‚Ä¢ \ Physical disk (_Total) \% disk activity while reading <br>  ‚Ä¢ \ Physical disk (_Total) \% disk activity while burning <br><br>  You can choose anything or whatever you need at the moment.  My interval is set at 10 seconds.  Click Next - if necessary, change the root folder - Next - Default user - Done.  So, the group was created.  We see that the DataCollector01 counter has already been created and go to its properties in order to select the SQL log format.  Below there is an opportunity to select a data source, where we select the statistic we created.  Click OK, then right-click on the group of data collectors statistic - Start. <br><br>  Great, statistics collection has begun!  By the way, if the error ServelAllConnect% 1 (or something like that) crashes, look in the event log.  There, oddly enough, the error is described in great detail.  Most often it is associated with the rights of the user from whom statistics are collected. <br><br><h5>  4. Creating a custom report. </h5><br>  And now we proceed to the most interesting!  Create a custom report for SSMS. <br>  To begin, check if the report is being recorded.  Run SSMS and create such a query: <br><br> <code>use [s_statistic] <br> go <br> select CounterName, CounterDateTime, CounterValue <br> from dbo.CounterData CDT <br> join dbo.CounterDetails CD on CD.CounterID=CDT.CounterID</code> <br> <br>  As a result, we get this: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/390/e09/8f1/390e098f1f28f28a46523e48f68645a9.jpg"><br><br>  We launch SQL Server Business Intelligence Development Studio (in SQL 2012 it is called SQL Server Data Tools).  Select File - New project - Report server project.  In the right part of the program, right-click the General data sources and select Add new data source. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e69/f04/cf9/e69f04cf91cb4a3f6a54fea509e505fc.jpg" alt="image"><br><br>  We call as we like, and in the connection string we write <code>Data Source=server-sql-001;Initial Catalog=s_statistic</code> .  Or we press the edit and select the connection name of the server, the entrance to the server and the database in the properties of the connection. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5ab/fee/39e/5abfee39e91f866d87ab8ebcd54aa3cc.jpg" alt="image"><br><br>  We check the connection and click OK.  Go to the Accounting data tab and specify the necessary ones there.  Click OK. <br>  Below click the right button Reports - Add a new report.  In this case, we skip the new page, and on the second page we write this, we already know, code: <br><br> <code>select CounterName, CounterDateTime, CounterValue <br> from dbo.CounterData CDT <br> join dbo.CounterDetails CD on CD.CounterID=CDT.CounterID</code> <br> <br>  Click Next, select the report type Matrix - Next.  In the Columns field, puts the CounterName, in the Rows field of the CounterDateTime, in the Details field of the CounterValue, and you can click Finish.  Or click next and choose the style of the matrix.  Great, report created. <br>  Now we can only bring it to the appearance that we like.  Since  we do not really need the table, I delete it.  Instead, we add a chart (graph).  In the given diagrams we indicate: <br><br>  ‚Ä¢ Groups nearby - CounterName <br>  ‚Ä¢ Group category - CounterDateTime <br>  ‚Ä¢ Values ‚Äã‚Äã- CounterValue <br><br>  Save our project and ready.  Now we run SSMS, right-click on our database s_statistic - Reports - Custom reports - find our report - Open. <br><br>  And here is our result: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/de8/2b3/f52/de82b3f525bf03a59f0d3ed401132161.jpg"><br><br>  I hope for critics and advice.  For there is a feeling that I missed something.  But the topic is very interesting for me, I plan to study further. </div><p>Source: <a href="https://habr.com/ru/post/217813/">https://habr.com/ru/post/217813/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217799/index.html">How to reduce the cost of a virtual data center with a USB flash drive</a></li>
<li><a href="../217801/index.html">YAWNDB - time series database</a></li>
<li><a href="../217803/index.html">People do not need a drill, but a picture on the wall</a></li>
<li><a href="../217807/index.html">Microsoft is ending support for Windows XP</a></li>
<li><a href="../217809/index.html">Exception is your friend</a></li>
<li><a href="../217815/index.html">How to make the coolest site so that all competitors envy</a></li>
<li><a href="../217819/index.html">Neck warm up in terminal</a></li>
<li><a href="../217821/index.html">Hadoop / Mapreduce small performance test</a></li>
<li><a href="../217823/index.html">The most useless extension in the world for Opera</a></li>
<li><a href="../217825/index.html">New spacesuit nasa</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>