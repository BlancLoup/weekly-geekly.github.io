<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reduce the build time of your Android projects</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good morning! We start Monday with the material, the translation of which was prepared specifically for students of the course ‚ÄúAndroid-developer. Adv...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reduce the build time of your Android projects</h1><div class="post__text post__text-html js-mediator-article">  Good morning!  We start Monday with the material, the translation of which was prepared specifically for students of the course <a href="https://otus.pw/GBGF/">‚ÄúAndroid-developer.</a>  <a href="https://otus.pw/GBGF/">Advanced course</a> . <br><br><img src="https://habrastorage.org/webt/cq/gh/9u/cqgh9uzb-qlhdgfjiv_ayajrqde.png"><br><br>  I recently transferred the Android code base to <a href="http://kureapp.com/">Kure</a> on AndroidX.  It seemed to me that this is a great opportunity to work on the project build speed.  Gradle has always had a bad reputation because of its slowness and resource-intensiveness, but I was very surprised that minor changes in the configuration of an assembly can increase its speed so much. <br><a name="habracut"></a><br>  Look at assembly scan rates before / after optimization 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/2k/yw/2w/2kyw2wlroiairpx8iiriwjdbejq.jpeg"><br>  <i>before optimization</i> <br><br><img src="https://habrastorage.org/webt/ef/ss/u6/efssu62faz4yoi92zvmssa1pf0m.jpeg"><br>  <i>after optimization Ô∏èÔ∏è</i> <br><br>  Reduced from 5.5 minutes to <b>17 seconds ??</b>  <b>Wow!</b> <br><br>  It's not too difficult to overdo it with optimization, to further reduce the build time.  But in order to make the post understandable to beginners, I will deliberately focus on the minor, painless measures that I have taken to get closer to such an indicator. <br><br><h2>  First of all! </h2><br>  Before you start optimizing, it is important to test our project to find out how long it takes to build it.  Gradle has a handy scan option that you can use to analyze the performance of your task.  Start the terminal in Android Studio and run the following command: <br><br><pre><code class="kotlin hljs">./gradlew assembleDebug --scan</code> </pre> <br>  Upon successful completion of the assembly, you will be prompted to accept the terms of service to download the scan results.  Enter <b>yes</b> to continue.  After the publication is completed, you will receive a link to the terminal to validate the scan.  Open it up. <br><br>  <i>There are quite a few options on the site, but for brevity, we will consider only what is most important.</i> <br><br>  Summary displays a summary of the tasks performed and the time they were completed.  But what interests us here is the <b>Performance</b> section.  It makes a more detailed breakdown of the total build time, as shown below. <br><br><img src="https://habrastorage.org/webt/on/n_/he/onn_he0w_k-i5nkwr7jagda9mx4.jpeg"><br><br>  In the Performance section there is a tab called <b>Settings and suggestions</b> , which contains recommendations for improving assembly speed.  Let's look at them. <br><br><img src="https://habrastorage.org/webt/g0/l0/bu/g0l0buxdn5wy1pfkxnuc0f9i0gc.jpeg"><br><br>  In this section, we can find a few simple fixes to improve speed.  So let's continue and apply these fixes to our project. <br><br><h2>  Step # 1: Update Tools </h2><br>  The Android team is constantly improving and developing the build system.  Thus, in most cases, you can get a significant improvement by simply installing the latest version of the toolkit. <br><br>  During this refactoring, our project was on <b>version 3.2.1 of</b> the Gradle plugin for Android Studio ( <i>several versions older than the latest release</i> ). <br><br>  You can follow <a href="https://developer.android.com/studio/releases/gradle-plugin">this link</a> to get the latest version of the Gradle Plugin.  At the time of this writing, the latest <b>version was 3.4.0.</b> <br><br>  But there is a catch here that we need to remember: <br><br><img src="https://habrastorage.org/webt/v0/b9/j9/v0b9j9xfqws0eknr0khchb4aoi0.jpeg"><br><br>  <i>( <b>Note:</b> When using Gradle version 5.0 or higher, the default memory size of the Gradle daemon is reduced from 1 GB to 512 MB. This may cause poor build performance. To override this default setting, specify the memory size for the Gradle daemon in the gradle.properties file your project.)</i> <br><br>  <a href="https://developer.android.com/studio/releases/gradle-plugin">https://developer.android.com/studio/releases/gradle-plugin</a> <br><br>  <i>When using <b>Gradle 5.0 and higher,</b> we will need to explicitly increase the memory size so that the speed of our assembly does not deteriorate.</i>  <i>We will come back to this in a minute.</i> <br><br>  Open the top-level <b>build.gradle</b> file, which you will find at the root of your project, and add the following line to <b>the dependencies section</b> : <br><br> <code>classpath 'com.android.tools.build:gradle:3.4.0'</code> <br> <br>  You also need to update the <b>distribution URL</b> in the Gradle Wrapper properties file, which is located at <code><b>gradle/wrapper/gradle-wrapper.properties</b></code> .  Update the URL to the following. <br><br>  ( <i>This link will be available on <a href="https://developer.android.com/studio/releases/gradle-plugin">the Android Gradle plugin page</a> .</i> ) <br><br> <code>distributionUrl=https\://services.gradle.org/distributions/gradle-5.1.1-all.zip</code> <br> <br>  You will encounter an error when using Kotlin if the version of the Kotlin Gradle plugin is less than <b>1.3.0.</b>  If so, use the IDE hint to update the Gradle plugin for Kotlin to the latest version (at the time of this writing, this is <b>version 1.3.31</b> ). <br><br>  Ok, let's run the build from the terminal again to see if we have made any improvements. <br><br><img src="https://habrastorage.org/webt/gg/lg/kf/gglgkfxrbccatt7ygkyswjrky28.jpeg"><br><br><h2>  Step # 2: Update Configurations </h2><br>  So, we were able to cut about 2.5 minutes from the assembly time, but this is still not good enough.  Having studied the assembly logs in the terminal, I came across one line that would interest us: <br><br><img src="https://habrastorage.org/webt/gr/fo/pv/grfopv6dg9wjtertgdxun5danku.jpeg"><br><br>  <i>(&gt; Task: app: compileDevelopDebugJavawithJavac</i> <i><br><br></i>  <i>Gradle can disable incremental compilation because the following annotation processors are not incremental: butterknife-compiler-10.1.0.jar (com.jakewharton: butterknife-compiler: 10.1.0), dagger-compiler-2.9.jar (com.google. dagger: dagger-compiler: 2.9).</i> <i><br><br></i>  <i>Consider setting the experimental android.enableSeparateAnnotationProcessing-true flag in the gradle.properties file to start processing annotations in a separate task and performing incremental compilation.)</i> <br><br>  Incremental compilation basically prevents wasteful compilation of the entire set of source files and instead compiles only those files that have been modified.  From the logs it is clear that we do not use this function.  He suggests that we use <code><b>android.enableSeparateAnnotationProcessing=true</b></code> , but, in any case, we should not use the <i>‚ÄúannotationProcessor‚Äù</i> configuration since Kotlin is used in our project. <br><br>  Fortunately, <b>version 1.3.30 of</b> Kotlin adds support for step-by-step annotation processing. <br><br><img src="https://habrastorage.org/webt/hq/ud/_r/hqud_rdvrv8fzj2z4fadmqbqtqc.jpeg"><br><br>  <a href="https://kotlinlang.org/docs/reference/kapt.html">https://kotlinlang.org/docs/reference/kapt.html</a> <br><br><h4>  (Incremental handling of annotations (from 1.3.30) </h4><br>  Starting with version 1.3.30, <code>kapt</code> supports incremental annotation processing as an experimental function.  Currently, annotation processing can be performed incrementally only if all the annotation processors used are incremental. <br>  To enable annotation incremental processing, add this line to the <code>gradle.properties</code> file: <br><br> <code>kapt.incremental.apt=true</code> <br> <br>  Note that incremental annotation processing requires that <a href="https://kotlinlang.org/docs/reference/using-gradle.html">incremental compilation is</a> also included.) <br><br>  So, let's begin: <br><br><ol><li>  1. Change the <b>annotationProcessor</b> configuration to <b>kapt</b> </li><li>  2. Enable the experimental flag of <b>incremental annotation processing.</b> </li></ol><br>  Open the <code><b>build.gradle</b></code> file of your module level and add the following line to the beginning of the file: <br><br> <code>apply plugin: 'kotlin-kapt'</code> <br> <br>  Then change all annotationProcessor configurations in the dependencies section to use kapt.  For example: <br><br> <code>// <br> annotationProcessor 'com.google.dagger:dagger-compiler:2.9' <br> // <br> kapt 'com.google.dagger:dagger-compiler:2.9'</code> <br> <br>  Now open the <b>gradle.properties</b> file located in the root of your project and add the following line: <br><br> <code>kapt.incremental.apt=true</code> <br> <br>  Let's run the build again. <br><br><img src="https://habrastorage.org/webt/wl/bg/xk/wlbgxkwt2nlgrhbf6a-nxj5_jkw.jpeg"><br><br>  Well, we seem to have made some progress. <br><br><h2>  Step # 3: Gradle Properties </h2><br>  We are at the last stage.  Remember the trick we encountered when updating the Gradle plugin version?  It turns out that newer versions of Gradle reduce the size of the memory used to 512 MB.  This is done so that weak machines do not consume too much memory.  I have a computer with 16 gigabytes of RAM, so I can afford to feed about 2-3 gigs to the Gradle daemon, but your numbers may differ. <br><br>  Open the <b>gradle.properties</b> file located in the root of your project and add the following line.  Remember to choose a size according to your requirements and computer specification. <br><br> <code>org.gradle.jvmargs=-Xmx3072m -XX:MaxPermSize=512m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-8</code> <br> <br>  While we are doing this, let's also enable parallel assemblies and customization on demand in the properties. <br><br>  Here‚Äôs what my final version of the <code><b>gradle.properties</b></code> file <code><b>gradle.properties</b></code> : <br><br><pre> <code class="kotlin hljs">org.gradle.jvmargs=-Xmx3072m -XX:MaxPermSize=<span class="hljs-number"><span class="hljs-number">512</span></span>m -XX:+HeapDumpOnOutOfMemoryError -Dfile.encoding=UTF-<span class="hljs-number"><span class="hljs-number">8</span></span> org.gradle.parallel=<span class="hljs-literal"><span class="hljs-literal">true</span></span> org.gradle.configureondemand=<span class="hljs-literal"><span class="hljs-literal">true</span></span> kapt.incremental.apt=<span class="hljs-literal"><span class="hljs-literal">true</span></span></code> </pre> <br><br><ul><li>  <code>org.gradle.parallel</code> - this flag allows Gradle to assemble modules within a project in parallel, rather than sequentially.  This is only useful for multi-module projects. </li><li>  <code>org.gradle.configureondemand</code> - this flag configures only those modules that are necessary for the project, and does not collect them all. </li></ul><br>  Having done this, let's see what we have now indicators of assembly speed: <br><br><img src="https://habrastorage.org/webt/42/g0/mu/42g0mugmqkhqo2ok7ynl-pqcf3e.jpeg"><br><img src="https://habrastorage.org/webt/3h/rb/p8/3hrbp8uyadmxzrzxioj6u6ghob4.jpeg"><br><br>  Like this! <br><br><h2>  Concluding remarks </h2><br>  This is by no means an extensive coverage of all ways to optimize assembly speed.  There are many other things that I didn‚Äôt discuss in this post, such as using minSdk 21 when using MultiDex, pre-indexing libraries, disabling PNG compression, etc., these are just some of them. <br><br>  But most of these configurations require a deeper understanding of the Android build system and experience with large multi-module projects (where the advantages are most obvious).  The steps I mentioned above are easily incorporated into the project even by the junior developers and have significant benefits.  I hope this helps you increase assembly speed! <br><br>  See you next time, peace be with you! </div><p>Source: <a href="https://habr.com/ru/post/457374/">https://habr.com/ru/post/457374/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../45736/index.html">nginx: another allocator</a></li>
<li><a href="../457362/index.html">Action from RUVDS: prepare the server in the summer</a></li>
<li><a href="../457366/index.html">A fanatic, a iron player or a spectator - what kind of gamer are you?</a></li>
<li><a href="../45737/index.html">Mumbai terrorists and new US IT policy</a></li>
<li><a href="../457370/index.html">Creating a 3-level menu using the Htmlix framework</a></li>
<li><a href="../457378/index.html">How id Software created Wolfenstein 3D based technologies from Commander Keen</a></li>
<li><a href="../45738/index.html">Bored, my friends ...</a></li>
<li><a href="../457380/index.html">Super modern OpenGL. Part 2</a></li>
<li><a href="../457382/index.html">7 habits of highly efficient programmers</a></li>
<li><a href="../457386/index.html">Understanding Linux Virtual Interfaces: Tunnels</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>