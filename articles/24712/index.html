<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with clipboard</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After reading the title, you are probably very surprised. 
 After all, it would seem, everything is extremely simple - there is a Clipboard object, th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with clipboard</h1><div class="post__text post__text-html js-mediator-article">  After reading the title, you are probably very surprised. <br>  After all, it would seem, everything is extremely simple - there is a Clipboard object, there are its static methods (like SetText / SetData and GetText / GetData), what else is needed for happiness? <br><br>  However, in practice everything is simple only as long as you copy or paste only basic objects, such as text or bitmap-pictures.  What happens when you need to operate with a more complex structure? <br><br>  Personally, I recently faced the need to copy the "hyperlinks", which then should be easily inserted into Word / Outlook / any other program.  And without relying on the recipient program itself defining the link in the inserted text and not converting it into the necessary format.  Therefore, we consider the work on the example of a hyperlink (the algorithm of actions for any other format will be similar). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So where do you start? <br><a name="habracut"></a><br>  To begin with, it is necessary to find out in what format certain data should be.  It can be <a href="http://www.codeproject.com/KB/clipboard/clipspy.aspx">figured</a> out in different ways, but the most obvious, perhaps, is the small utility <a href="http://www.codeproject.com/KB/clipboard/clipspy.aspx">ClipSpy</a> .  It is enough just to copy the desired object from anywhere and determine which formats are created on the clipboard and what they contain. <br><br>  As the experiment shows, for the hyperlink TEXT, UNICODETEXT and HTML are usually created.  The first and second contain a textual representation of the hyperlink (that will be inserted, for example, in a notebook).  The HTML format is of most interest to us - it contains an html-fragment, which will be inserted into the target program as a hyperlink.  It looks like this: <br><blockquote><pre>  Version: 1.0
 StartHTML: XXXXXXXX
 EndHTML: YYYYYYYY
 StartFragment: ZZZZZZZZ
 EndFragment: TTTTTTTT
 &lt;html ....
 &lt;a href="http://some.site.com/target"&gt; Some target &lt;/a&gt;
 ... &lt;/ html&gt; </pre></blockquote>  where XXXXXXXX is the offset of the beginning of the html content (in fact, the length of the header), <br>  YYYYYYYY - respectively, the offset of the end of the html content (in fact, the length of the entire content), <br>  ZZZZZZZZ and TTTTTTTT - the beginning and end of the fragment with a hyperlink. <br><br>  Well, we decided on the format.  Now create the desired content - a matter of technology.  For now, we will look at how to send the necessary content (in several formats) to the clipboard. <br><br>  Google (advisor beloved by all) gives, as a rule, the following solution: <br><blockquote><pre>  void CopyLink (Uri target, string title)
 {
	 var htmlContent = MakeLink (target, title);
	 var data = new DataObject ();
	 data.SetData (DataFormats.Text, true, target.ToString ());
	 data.SetData (DataFormats.Unicode, true, html_content);
	 data.SetData (DataFormats.Html, true, formatted_buffer);
	 Clipboard.SetDataObject (data, true);
 } </pre></blockquote><br>  And everything would be fine if it were not for one ‚Äúbut‚Äù - such a solution does not allow you to control the encoding when setting the html content.  Therefore, links, for example, with the Russian text in the title are inserted completely wrong, which leads to various interesting effects, up to the "crash" of the recipient program. <br><br>  On this note, the idea of ‚Äã‚Äãwriting a purely managed code covered with a copper basin, therefore, had to turn to WinAPI.  As a result, it turned out not so beautiful, but it is very efficient: <br><blockquote><pre>  [DllImport ("user32.dll")]
 private static extern IntPtr SetClipboardData (uint uFormat, IntPtr hMem);
 [DllImport ("user32.dll")]
 private static extern bool OpenClipboard (IntPtr hWndNewOwner);
 [DllImport ("user32.dll")]
 private static extern bool EmptyClipboard ();
 [DllImport ("user32.dll")]
 private static extern bool CloseClipboard ();
 [DllImport ("user32.dll", SetLastError = true)]
 private static extern uint RegisterClipboardFormat (string lpszFormat);

 void CopyLink (Uri target, string title)
 {
	 var htmlContent = MakeLink (target, title, Encoding.UTF8);

	 if (! OpenClipboard (IntPtr.Zero))
		 throw new Exception ("Failed to open clipboard");
	 EmptyClipboard ();
        
	 var pText = IntPtr.Zero;
	 var pHtml = IntPtr.Zero;
	 try
	 {
		 pText = Marshal.StringToHGlobalAnsi (target.ToString ());
		 SetClipboardData (1 / * CF_TEXT * /, pText);  // For TEXT and UNICODETEXT

		 var bytes = Encoding.UTF8.GetBytes (htmlContent);
		 pHtml = Marshal.AllocHGlobal (bytes.Length);
		 Marshal.Copy (bytes, 0, pHtml, bytes.Length);
		 SetClipboardData (RegisterClipboardFormat (DataFormats.Html), pHtml);
	 }
	 finally 
	 {
		 CloseClipboard ();
		 if (pText! = IntPtr.Zero)
			 Marshal.FreeHGlobal (pText);
		 if (pHtml! = IntPtr.Zero)
			 Marshal.FreeHGlobal (pHtml);
	 }
 } </pre></blockquote><br>  Well, to complete the picture, the MakeLink source code: <br><blockquote><pre>  string MakeLink (Uri target, string title, Encoding encoding)
 {
	 const int numberLengthWithCr = 11;
	 var htmlIntro = "&lt;html&gt; \ n &lt;head&gt; \ n &lt;meta http-equiv = \" Content-Type \ "content = \" text / html;  charset = " 
		 + encoding.WebName + "\" /&gt; \ n &lt;/ head&gt; \ n &lt;body&gt; \ n &lt;! - StartFragment -&gt; ";
	 var htmlOutro = "&lt;! - EndFragment -&gt; \ n &lt;/ body&gt; \ n &lt;/ html&gt;";
	 var htmlLink = string.Format ("&lt;a href=\"{0}\" {1} &lt;/a&gt;", target, title);

	 var startHtmlIndex = 57 + 4 * numberLengthWithCr;
	 var startFragmentIndex = startHtmlIndex + encoding.GetByteCount (htmlIntro);
	 var endFragmentIndex = startFragmentIndex + encoding.GetByteCount (htmlLink);
	 var endHtmlIndex = endFragmentIndex + encoding. GetByteCount (htmlOutro);

	 var buff = new StringBuilder ();
	 buff.AppendFormat ("Version: 1.0 \ n");
	 buff.AppendFormat ("StartHTML: {0: 0000000000} \ n", startHtmlIndex);
	 buff.AppendFormat ("EndHTML: {0: 0000000000} \ n", endHtmlIndex);
	 buff.AppendFormat ("StartFragment: {0: 0000000000} \ n", startFragmentIndex);
	 buff.AppendFormat ("EndFragment: {0: 0000000000} \ n", endFragmentIndex);
	 buff.Append (htmlIntro) .Append (htmlLink) .Append (htmlOutro);
	 return buff.ToString ();
 } </pre></blockquote><br><br>  PS By the way, the question is: is it possible to write code normally, without disabling auto-formatting and manually arranging line breaks?  And then with the auto format in <pre>  the spacing between the lines is just deadly.
 &lt;/ habracut&gt; </pre></div><p>Source: <a href="https://habr.com/ru/post/24712/">https://habr.com/ru/post/24712/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../247109/index.html">There are no auto testers in the team - what to do?</a></li>
<li><a href="../247113/index.html">Happy New Year!</a></li>
<li><a href="../247115/index.html">As I nephew congratulated on his birthday</a></li>
<li><a href="../247117/index.html">BudgetApps - First All-Russian Open Financial Data Competition</a></li>
<li><a href="../247119/index.html">Top games and applications of 2014 in the Russian Windows Phone Store</a></li>
<li><a href="../247121/index.html">Poll. Salaries of developers, against the backdrop of the fall of the ruble</a></li>
<li><a href="../247123/index.html">PyOpenGL with shaders</a></li>
<li><a href="../247125/index.html">Drone maker EHANG, which received $ 10 million, will create an SDK for developers</a></li>
<li><a href="../247129/index.html">News from the 31C3 Forum: New Intrigues of the NSA, Computer Brain Management and Internet Toilet</a></li>
<li><a href="../24713/index.html">Can make such a "social network" for those ... who work?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>