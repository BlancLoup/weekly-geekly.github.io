<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Eggs.Variant - Part I</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The publication of this translation encouraged me to comment the user @encyclopedist to the recent article "Factory Method Without Placing in Dynamic ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Eggs.Variant - Part I</h1><div class="post__text post__text-html js-mediator-article">  The publication of this translation encouraged me to <a href="https://habr.com/post/244497/">comment the</a> user <b>@encyclopedist</b> to the recent article <a href="https://habr.com/post/244497/">"Factory Method Without Placing in Dynamic Memory"</a> .  The article interested me, but a brief <i>googling</i> did not reveal a translation.  ‚ÄúDisorder.‚Äù - I thought - ‚ÄúSuch an interesting article on C ++ and not translated into Russian.  I should fix it. ‚Äù <br><br>  <b>Table of contents</b> <br><ol><li>  <a href="https://habr.com/ru/post/244573/">Introduction</a> </li><li>  <a href="https://habr.com/ru/post/244573/">Design</a> </li><li>  <a href="https://habr.com/ru/post/244573/">Implementation</a> <br><ul><li>  <a href="https://habr.com/ru/post/244573/">Trivially Copied Types</a> </li><li>  <a href="https://habr.com/ru/post/244573/">Trivially destructible types</a> </li></ul><br></li><li>  <a href="https://habr.com/ru/post/244573/">What is not yet said</a> </li></ol><br><br>  Reflections on the development of <a href="https://github.com/eggs-cpp/variant">Eggs.Variant</a> - a generic type-safe <a href="https://github.com/eggs-cpp/variant">tagging</a> <abbr title="discriminated union">union</abbr> in <strong>C ++</strong> <a href="https://github.com/eggs-cpp/variant">11/14</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1><a name="introduction"></a>  Introduction </h1><br>  <a href="http://en.cppreference.com/w/cpp/language/union">A union</a> is a special type of class that at a time can store only one of its non-static members.  It takes up as much space as is required to accommodate the largest of its members. <br><blockquote>  <strong>9 [class] / 5 A</strong> union is a class defined with the keyword <code>union</code> ;  at the same time he can keep only one of his members (9.5).  [...] <br>  <strong>9.5 [class.union] / 1</strong> Only one of the non-static members can be active in the union, that is, at the moment, the value of only one of its non-static members can be stored in the association.  [...] The size of the union is sufficient to contain the largest of its non-static members.  Each non-static member is located in memory as if it is the only member of the structure.  All non-static members of the union object have the same address. <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>9 [class] / 5</strong> A union is a class defined with the class-key union;  it holds at a time (9.5).  [...] <br>  <strong>9.5 [class.union] /</strong> In union data data data data data union at any time.  [...] non-static data members.  Each member of a struct.  All non-static data is the same as address. <br></blockquote><br></div></div><br><br><a name="habracut"></a><br><br>  In <strong>C ++ 98</strong> , union members are restricted to trivial object types.  For these types, their life time begins when the <abbr title="storage">storage is</abbr> received and ends when it is reused or released. <br><blockquote>  <strong>3.8 [basic.life] / 1</strong> [...] The lifetime of an object of type <code>T</code> begins when: <br><ul><li>  storage obtained with type <code>T</code> alignment and size and </li><li>  object initialization, if it is non-trivial, completed. </li></ul><br>  The lifetime of an object of type <code>T</code> ends when: <br><ul><li>  if <code>T</code> is a type of a class with a non-trivial destructor (12.4), the call to the destructor begins, or </li><li>  the repository that the object occupies has been reused or released. </li></ul><br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>3.8 [basic.life] / 1</strong> [...] <code>T</code> begins when: <br><ul><li>  size is obtained, and </li><li>  if the object has a non-trivial initialization, its initialization is complete. </li></ul><br>  <code>T</code> ends when: <br><ul><li>  if <code>T</code> is a class type with a non-trivial destructor (12.4), the destructor call starts, or </li><li>  The storage of the object occupies is reused or released. </li></ul><br></blockquote><br></div></div><br>  This special guarantee allows you to change the active member of the union simply by assigning a new value to the association, allowing you to effectively reuse the repository ‚Äî which is in good agreement with the spirit of the standard, if not with a letter. <br>  In addition, the union does not know which member ‚Äî if any ‚Äî is active, so its special member functions must be implemented without knowledge of this information.  Because union members are limited to trivial types, special member functions can be implemented in terms of the <abbr title="underlying">underlying</abbr> byte union that is independent of the active member. <br><blockquote>  <strong>9.5 [class.union] / 1</strong> [...] A class object with a non-trivial constructor (12.1), a non-trivial copy constructor (12.8), a non-trivial destructor (12.4) or a non-trivial copy assignment operator (13.5.3, 12.8) cannot be a member union, or an element of the array lying in the union.  [...] <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>9.5 [class.union] / 1</strong> [...] An object of a non-trivial constructor (12.1), a non-trivial copy constructor (12.8), a non-trivial destructor (12.4), or a non -trivial copy assignment operator (13.5.3, 12.8) cannot be a member of a union, nor can it be an array of such objects.  [...] <br></blockquote><br></div></div><br>  In <strong>C ++ 11,</strong> this restriction was removed;  union members can now be of any type.  Switching between non-trivial members requires the explicit destruction of the current active member and the use of the <abbr title="placement new">host operator <code>new</code></abbr> to construct a new active member. <br><blockquote>  <strong>9.5 [class.union] / 4</strong> [Note: in general, it is necessary to use one explicit call to the destructor and one explicit call to the placing operator <code>new</code> to change the active member of the enumeration.  ‚ÄîEnd of note] [Example: Consider an object <code>u</code> , having the type of enumeration <code>U</code> with non-static members <code>m</code> type <code>M</code> and <code>n</code> type <code>N</code>  If <code>M</code> has a non-trivial destructor, and <code>N</code> has a non-trivial constructor (for example, if they declare or inherit virtual functions), the active member <code>u</code> can be safely changed from <code>m</code> to <code>n</code> by using the following destructor and placing <code>new</code> operator: <br><pre> <code class="cpp hljs">um~M(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (&amp;u.n) N;</code> </pre><br>  ‚ÄîThe end of the example] <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>9.5 [class.union] / 4</strong> [note: In general, it <strong>should be noted</strong> .  ‚ÄîEnd note] [Example: Consider a non-static data type and have a non-static data members and a <code>n</code> of type <code>N</code>  If you have a non-trivial constructor (for example, if you declare or inherit virtual functions), follows: <br><pre> <code class="cpp hljs">um~M(); <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> (&amp;u.n) N;</code> </pre><br>  ‚ÄîEnd example] <br></blockquote><br></div></div><br>  If a special member function of any of the members of a union is nontrivial, then the special member function of the union itself will be implicitly defined as remote, unless it is provided by the user. <br><blockquote>  <strong>9.5 [class.union] / 2</strong> [Note: if any non-static member of the union has a non-trivial default constructor (12.1), a copy constructor (12.8), a displacement constructor (12.8), a copy assignment operator (12.8), a move assignment operator (12.8) or destructor (12.4), the corresponding member function of the union must be provided by the user, or it will be implicitly removed (8.4.3) from the union.  ‚ÄîEnd of note] <br>  <strong>9.5 [class.union] / 3</strong> [Example: Consider the following union: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> U { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> f; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> s; };</code> </pre><br>  Since the type <code>std::string</code> (21.3) declares non-trivial versions of all special member functions, type <code>U</code> will implicitly remove the default constructor, the copy / move constructors, the copy / move assignment operators, and the destructor.  To use type <code>U</code> some of these member functions must be provided by the user.  ‚ÄîThe end of the example] <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>9.5 [class.union] / 2</strong> (non-trivial default constructor (12.1), copy constructor (12.8), move constructor (12.8), copy assignment operator (12.8) , move assignment operator (12.8), or delete it (8.4.3) for the union.  ‚ÄîEnd note] <br>  <strong>9.5 [class.union] / 3</strong> [Example: Consider the following union: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">union</span></span> U { <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> f; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> s; };</code> </pre><br>  Since he has been an implicitly defaulted constructor, he has been defined as a constructor  To use it, it must be user-provided.  ‚ÄîEnd example] <br></blockquote><br></div></div><br>  These nontrivial member functions can be provided ‚Äî with their usual semantics ‚Äî only if the active member of the enumeration is known so that it can be passed on.  A tagged <em>union</em> is a union or a class similar to a union that has <abbr title="self-aware">knowledge about itself</abbr> , that is, it contains some identifier that lets you know which member ‚Äî if any, is currently active.  Marked <em>union</em> can provide all special member functions regardless of their triviality. <br>  An instance of the class <code>eggs::variant&lt;Ts...&gt;</code> is a marked <em>union of</em> objects with types <code>Ts</code> .  It provides a natural interface for switching the active member and provides all the special member functions with their usual semantics: <br><pre> <code class="cpp hljs">eggs::variants&lt;N, M&gt; u; <span class="hljs-comment"><span class="hljs-comment">// u     u = M{}; //    u   M u = N{}; //    u   N,      //    - using U = eggs::variants&lt;int, float, std::string&gt;;</span></span></code> </pre><br><br><h1><a name="design"></a>  Design </h1><br>  The ultimate goal of design is the synthesis and improvement of the design of the marked <em>association</em> without compromising its functionality.  That is, he should not have a special member to select the current active member of the union, or he should occupy very little space: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">U</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> { T0 m0; ...; TN mN; }; <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> which; } u;</code> </pre><br>  is replaced by this: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> V = eggs::variant&lt;T0, ..., TN&gt;; V v;</code> </pre><br>  In particular: <br><ul><li>  The size of type <code>V</code> must match the size of the corresponding type <code>U</code>  Any active member <code>v</code> must be located in the domain <code>V</code> , properly aligned for the types <code>T0, ... TN</code> ;  the use of additional storage, such as dynamic memory, is not allowed. </li><li>  The semantics of <code>v</code> must match or improve the well-defined semantics of <code>u</code> .  The <code>v</code> interface should not allow undefined behavior, for example, a reference to the inactive member <code>u</code> . </li><li>  Type <code>V</code> should provide all special member functions with their expected semantics. </li></ul><br>  The interface is mainly based on <a href="http://en.cppreference.com/w/cpp/experimental/optional"><code>std::experimental::optional&lt;T&gt;</code></a> , as defined in the <a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2014/n4082.pdf"><abbr title="Library Fundamentals TS">Technical Specification of the main library</abbr></a> .  The conceptual model <code>optional&lt;T&gt;</code> consists of a tagged <em>union of the</em> types <code>nullopt_t</code> and <code>T</code>  Design decisions made for <code>optional&lt;T&gt;</code> are easily transferred to the <code>variant&lt;Ts...&gt;</code> , whose conceptual model consists of the marked-up union of the <code>nullvariant_t</code> types and those that are hidden behind <code>Ts</code> .  The semantics of all special member functions and related operators, as well as the interface for switching the active member ‚Äî through design, assignment, or placement ‚Äî is borrowed from <code>optional&lt;T&gt;</code> . <br>  Access to the active member is done in the style of <a href="http://en.cppreference.com/w/cpp/utility/functional/function"><code>std::function</code></a> , which returns a pointer to the target if it is requested with the correct target type ‚Äî something like <code>dynamic_cast</code> for the poor.  In addition, it also allows you to get a null pointer to the active member (if there is one), which has been very useful to simplify the implementation of auxiliary functions. <br>  Finally, helper classes like <a href="http://eggs-cpp.github.io/variant/reference.html"><code>std::tuple</code></a> provided, as well as access to elements by index or type ‚Äî albeit with unobvious semantics closer to the semantics of casting at run time. <br>  Reference documentation can be found <a href="http://eggs-cpp.github.io/variant/reference.html">here</a> . <br><br><h1><a name="implementation"></a>  Implementation </h1><br>  Direct implementation of <code>variant&lt;Ts&gt;</code> as the storage would use the underlying <abbr title="relaxed union">relaxed union</abbr> : <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> storage { <span class="hljs-keyword"><span class="hljs-keyword">nullvariant_t</span></span> nullvariant; Ts... members; };</code> </pre><br>  However, the above code is not correct in terms of <strong>C ++</strong> syntax, because the template parameter set cannot be disclosed in this context ‚Äî it must contain the names of the members so that they can be referenced.  Instead, a recursive approach should be used to build the underlying storage: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> storage; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> storage&lt;T, Ts...&gt; { <span class="hljs-keyword"><span class="hljs-keyword">nullvariant_t</span></span> nullvariant; T head; storage&lt;Ts...&gt; tail; }; <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">union</span></span> storage&lt;&gt; { <span class="hljs-keyword"><span class="hljs-keyword">nullvariant_t</span></span> nullvariant; };</code> </pre><br>  Unfortunately, this is not so easy, given that any non-trivial special member function for a type from <code>Ts</code> as a result, remove the corresponding special member function from the repository.  To use this implementation, at least the default constructor and destructor must be implemented for the resulting list, although the destructor cannot do anything useful. <br>  The simplest implementation, which was used before relaxed unions appeared in <strong>C ++</strong> , would use <abbr title="raw">bare</abbr> storage, suitable for storing any of the types in <code>Ts</code> - attention, spoiler: in some cases it will not work.  The standard even provides a special <abbr title="trait">property</abbr> to facilitate our work: <br><blockquote>  <strong>10.20.7.6 [meta.trans.other]</strong> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> Len, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Types</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned_union</span></span></span><span class="hljs-class">;</span></span></code> </pre><br><ul><li>  Condition: At least one type must be provided. </li><li>  Comments: The typedef to the member type must be a <abbr title="Plain Old Data - simple data structure">POD</abbr> type, applicable for use as an uninitialized repository for any object whose type is listed in the <code>Types</code> list;  its size must be at least <code>Len</code> .  The static member <code>alignment_value</code> must be an integer constant of type <code>std::size_t</code> , whose value determines the strictest alignment for all types listed in the <code>Types</code> list. </li></ul><br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>10.20.7.6 [meta.trans.other]</strong> <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> Len, <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Types</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned_union</span></span></span><span class="hljs-class">;</span></span></code> </pre><br><ul><li>  Condition: At least one type is provided. </li><li>  This is the case:  its size shall be at least <code>Len</code> .  This is the case for the quotation. </li></ul><br></blockquote><br></div></div><br>  It should be noted that this property has already been removed from the <abbr title="working draft">working draft</abbr> ‚Äî along with the advent of relaxed associations ‚Äî and is now a potential candidate for obsolescence.  A possible replacement in <strong>C ++ 14</strong> might be: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> Len, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Types&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">aligned_union</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::<span class="hljs-keyword"><span class="hljs-keyword">size_t</span></span> alignment_value = <span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::max({<span class="hljs-keyword"><span class="hljs-keyword">alignof</span></span>(Types)...}); <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> {</span></span> alignas(alignment_value) <span class="hljs-keyword"><span class="hljs-keyword">unsigned</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span> _[<span class="hljs-built_in"><span class="hljs-built_in">std</span></span>::max({Len, <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>(Types)...})]; }; };</code> </pre><br>  Using <code>aligned_union</code> as the storage type, a simplified version of <code>variant&lt;Ts&gt;</code> can be implemented as follows: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">variant</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">index_of</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//  T  Ts...,   0 public: static constexpr std::size_t npos = std::size_t(-1); variant() noexcept : _which{npos} {} template &lt;typename T&gt; variant(T const&amp; v) : _which{_index_of&lt;T&gt;::value} { new (target&lt;T&gt;()) T(v); //   T     //   new } /*...*/ std::size_t which() const noexcept { return _which; } template &lt;typename T&gt; T* target() noexcept { return _which == _index_of&lt;T&gt;::value ? static_cast&lt;T*&gt;(static_cast&lt;void*&gt;(&amp;_storage)) : nullptr; } template &lt;typename T&gt; T const* target() const noexcept { return _which == _index_of&lt;T&gt;::value ? static_cast&lt;T const*&gt;(static_cast&lt;void const*&gt;(&amp;_storage)) : nullptr; } private: std::size_t _which; typename std::aligned_union&lt;0, Ts...&gt;::type _storage; };</span></span></code> </pre><br>  Special member functions must be redirected to the active member (if any).  Again, we cannot simply use the <code>switch</code> to achieve this goal ‚Äî although if we could do this, it would hardly have been much simpler ‚Äî and the direct replacement would have a recursive implementation: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">struct</span></span></span><span class="hljs-class"> _</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">destructor</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">call</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* ptr)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static_cast</span></span>&lt;T*&gt;(ptr)-&gt;~T(); } }; variant&lt;Ts...&gt;::~variant() { apply&lt;_destructor, Ts...&gt;(_which, &amp;_storage); } <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> F&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*which*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* </span></span><span class="hljs-comment"><span class="hljs-function"><span class="hljs-params"><span class="hljs-comment">/*storage*/</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{} <span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> F, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> T, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> which, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* storage)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (which == <span class="hljs-number"><span class="hljs-number">0</span></span>) { F::<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> call&lt;T&gt;(storage); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { apply&lt;F, Ts...&gt;(which - <span class="hljs-number"><span class="hljs-number">1</span></span>, storage); } }</code> </pre><br>  A non-recursive implementation of the <code>apply</code> method can be constructed using a jump table, just as a <code>switch</code> does, with a subsequent transition to the appropriate entry: <br><pre> <code class="cpp hljs"><span class="hljs-keyword"><span class="hljs-keyword">template</span></span> &lt;<span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> F, <span class="hljs-keyword"><span class="hljs-keyword">typename</span></span> ...Ts&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">apply</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">std</span></span></span></span><span class="hljs-function"><span class="hljs-params">::</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">size_t</span></span></span></span><span class="hljs-function"><span class="hljs-params"> which, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span><span class="hljs-function"><span class="hljs-params">* storage)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> fun_ptr = <span class="hljs-keyword"><span class="hljs-keyword">void</span></span>(*)(<span class="hljs-keyword"><span class="hljs-keyword">void</span></span>*); <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constexpr</span></span> fun_ptr table[] = {&amp;F::<span class="hljs-keyword"><span class="hljs-keyword">template</span></span> call&lt;Ts&gt;...}; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (which &lt; <span class="hljs-keyword"><span class="hljs-keyword">sizeof</span></span>...(Ts)) { table[which](storage); } }</code> </pre><br>  A non-recursive implementation not only gives a faster generated code, but also significantly speeds up compilation from the case of a large number of types in the <code>Ts</code> list - in your case, the estimate may change. <br><br><h2><a name="trivially-copyable"></a>  Trivially Copied Types </h2><br>  <abbr title="trivially copyable">A trivially copied</abbr> type is one that can be copied by copying its constituent bits ‚Äî that is, using <a href="http://en.cppreference.com/w/cpp/string/byte/memcpy"><code>std::memcpy</code></a> . <br><blockquote>  <strong>3.9 [basic.types] / 2</strong> For any object (except subobjects of the base class) of the trivially copied type <code>T</code> , whether or not they contain valid values ‚Äã‚Äãof type <code>T</code> , its constituent bytes (1.7) can be copied to the <code>char</code> array or <code>unsigned char</code> .  If the contents of the <code>char</code> array or <code>unsigned char</code> copied back to an object, the object should receive its original value as a result.  [...] <br>  <strong>3.9 [basic.types] / 3</strong> For any trivially copied type <code>T</code> , if two pointers to <code>T</code> point to different objects <code>obj1</code> and <code>obj2</code> type <code>T</code> , where either <code>obj1</code> or <code>obj2</code> are subobjects of the base class and the components <code>obj1</code> bytes (1.7) are copied into <code>obj2</code> , as a result, <code>obj2</code> must contain the same value as <code>obj1</code> .  [...] <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>3.9 basic basic basic 2 2 2 2 2 2 2 2 2</strong> any any be copied into an array of <code>char</code> or <code>unsigned char</code> .  It is a charcoal pattern that holds its original value.  [...] <br>  <strong>3.9 [basic.types] / 3,</strong> for any trivially copyable type <code>T</code> , <code>obj1</code> and <code>obj2</code> , what‚Äôs not a norm of the <code>obj2</code> a ob (1.7) making up <code>obj1</code> are copied into <code>obj2</code> , <code>obj2</code> .  [...] <br></blockquote><br></div></div><br>  Combining trivially copied members is itself trivially replicable, which puts it into candidates for additional optimization, which cannot be done for a non-trivially replicable type.  It follows that a <code>variant</code> with a trivially copied type must also strive to be trivially replicable. <br><blockquote>  <strong>9 [class] / 6</strong> A trivially copied class is a class that: <br><ul><li>  does not have non-trivial copy constructors (12.8), </li><li>  does not have non-trivial displacement constructors (12.8), </li><li>  does not have non-trivial copy assignment operators (13.5.3, 12.8), </li><li>  does not have nontrivial relocation assignment operators (13.5.3, 12.8) and </li><li>  has a trivial destructor (12.4). </li></ul><br>  [...] <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>9 [class] / 6</strong> A trivially copyable class is a class that: <br><ul><li>  has no non-trivial copy constructors (12.8), </li><li>  has no non-trivial move constructors (12.8), </li><li>  has no non-trivial copy assignment operators (13.5.3, 12.8), </li><li>  has no non-trivial move assignment operators (13.5.3, 12.8), and </li><li>  has a trivial destructor (12.4). </li></ul><br>  [...] <br></blockquote><br></div></div><br>  To achieve this goal, a separate <code>variant</code> specialization must be chosen if all types in <code>Ts</code> are trivially replicable.  The special member functions listed above should not be provided by the user for this specialization ‚Äî they must either be provided implicitly or explicitly specified when they are first defined as generated by default.  The implementation will provide implicit definitions for them, which will be trivial;  copy and move operators will simply copy the storage bits containing them together with the discriminator, but the destructor will not do anything. <br>  But there is one catch: a trivially copied class may be generally non-replicable, although a special member function that was removed when it was first defined is trivial.  Let's look, for example, at how the class <a href="http://www.boost.org/libs/core/doc/html/core/noncopyable.html"><code>boost::noncopyable</code></a> defined: <br><pre> <code class="cpp hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">noncopyable</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span>: <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constexpr</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noncopyable</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; noncopyable(noncopyable <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; noncopyable&amp; <span class="hljs-keyword"><span class="hljs-keyword">operator</span></span>=(noncopyable <span class="hljs-keyword"><span class="hljs-keyword">const</span></span>&amp;) = <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span>; ~noncopyable() = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>; };</code> </pre><br>  It may come as a surprise that <a href="http://en.cppreference.com/w/cpp/types/is_trivially_copyable"><code>std::is_trivially_copyable</code></a> prints <code>true</code> for the <code>noncopyable</code> class.  Another big surprise is that the <code>variant&lt;noncopyable&gt;</code> instance <code>variant&lt;noncopyable&gt;</code> can be successfully copied, since the remote <code>noncopyable</code> member functions are not used at all.  This is, in effect, a type security breach arising from the decision to use an untyped bare repository to store the active member. <br><br><h2><a name="trivially-destructible"></a>  Trivially destructible types </h2><br>  Another important category of types are <abbr title="trivially destructible">trivially destructible</abbr> types. <br><blockquote>  <strong>12.4 [class.dtor] / 5</strong> [...] A destructor is trivial if it is not provided by the user and if: <br><ul><li>  it is not virtual, </li><li>  all immediate base classes of this class have trivial destructors and </li><li>  for all non-static members of a given class, having a class (or array of classes) of its type, each such class has a trivial destructor. </li></ul><br>  Otherwise, the destructor is nontrivial. <br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote>  <strong>12.4 [class.dtor] / 5</strong> [...] A destructor is trivial if it is not user-provided and if: <br><ul><li>  the destructor is not virtual, </li><li>  trivial destructors, and </li><li>  There are a number of types of data for each of them. </li></ul><br>  Otherwise, the destructor is non-trivial. <br></blockquote><br></div></div><br>  This is especially important because one of the requirements for a <abbr title="literal type">literal type</abbr> ‚Äî whose instances can be used in the context of a <code>constexpr</code> expression ‚Äî is its trivial destructibility. <br><blockquote>  <strong>3.9 [basic.types] / 10 A</strong> type is a literal type if it is: <br><ul><li>  [...] </li><li>   ( 9),    : <br><ul><li>    , </li><li>   <abbr title="aggregate type"> </abbr> (8.5.1)      <code>constexpr</code> -   ,         </li><li>         <abbr title="non-volatile"></abbr>  . </li></ul><br></li></ul><br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3.9 [basic.types] / 10</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> A type is a literal type if it is:</font></font><br><ul><li>  [...] </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> a class type (Clause 9) that has all of the following properties: </font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it has a trivial destructor, </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it is an aggregate type (8.5.1) or a constructor </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> all of its non-volatile literal types. </font></font></li></ul><br></li></ul><br></blockquote><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">A union may be a literal type, provided that at least one of its members is a literal type, and the remaining members are trivially destructible. </font><font style="vertical-align: inherit;">It follows that </font></font><code>variant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">under these conditions it must also strive to be a literal type. </font><font style="vertical-align: inherit;">Another specialization </font></font><code>variant</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">should be chosen if all types in </font></font><code>Ts</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">are trivially destructible. </font><font style="vertical-align: inherit;">However, it is not so useful, since among the restrictions on constant expressions there is a restriction on casting a </font></font><code>void</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">pointer to an object pointer:</font></font><br><blockquote> <strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">5.19 [expr.const] / 2 The</font></font></strong><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> conditional expression </font></font><code>e</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">is the core of a constant expression only if the calculation </font></font><code>e</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">following the rules of the abstract machine (1.9) is not calculated in one of the following expressions:</font></font><br><ul><li>  [...] </li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">conversion from type </font></font><code>cv void*</code><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">to type of pointer to object;</font></font></li><li>  [...] </li></ul><br></blockquote><br><div class="spoiler">  <b class="spoiler_title">Original</b> <div class="spoiler_text"><blockquote> <strong>5.19 [expr.const]/2</strong> A conditional-expression <code>e</code> is a core constant expression unless the evaluation of <code>e</code> , following the rules of the abstract machine (1.9), would evaluate one of the following expressions: <br><ul><li>  [...] </li><li> a conversion from type <code>cv void*</code> to a pointer-to-object type; </li><li>  [...] </li></ul><br></blockquote><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And again, the decision to use an untyped raw storage limits the fullness of the implementation of a generalized tagged union to the same level that can be achieved by implementing it manually. </font></font><br><br><h1><a name="what-lies-ahead"></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> What is not yet said </font></font></h1><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The implementation on the basis of raw storage - although it justifies its price - does not hold water, it is worth going beyond the usual framework. </font><font style="vertical-align: inherit;">The storage of values ‚Äã‚Äãin a generic type-safe tagged union must always be a regular union, otherwise it will not be possible to use all its functionality.</font></font></div><p>Source: <a href="https://habr.com/ru/post/244573/">https://habr.com/ru/post/244573/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../244559/index.html">Brief history of hacking. A story from the head of information security at Yandex</a></li>
<li><a href="../244561/index.html">Do it yourself search on the site</a></li>
<li><a href="../244563/index.html">"Mathematics is one of the forms of art": post to the centenary of the birth of Martin Gardner</a></li>
<li><a href="../244565/index.html">The slowest x86 instruction</a></li>
<li><a href="../244571/index.html">Consulo: ~ 1000 kommitov, or as the autumn passed</a></li>
<li><a href="../244575/index.html">Swift Error Handling - Sword and Magic</a></li>
<li><a href="../244577/index.html">What the team leader should know and how we made up the program for the second day of the Go conference</a></li>
<li><a href="../244579/index.html">Review of the most interesting materials on data analysis and machine learning ‚Ññ24 (November 24 - 30, 2014)</a></li>
<li><a href="../244585/index.html">CoreOS - Linux for minimalist clusters. Short</a></li>
<li><a href="../244587/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ136 (November 24 - 30, 2014)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>