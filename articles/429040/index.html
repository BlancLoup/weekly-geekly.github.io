<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Patching Java code in production without anesthesia</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Here I will talk about the device of one of the many tools that help in the development of various services for the project Odnoklassniki. Inside the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Patching Java code in production without anesthesia</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/di/gh/wc/dighwcvw92d2zysgdcdref8_ptg.png" alt="image"><br><br>  Here I will talk about the device of one of the many tools that help in the development of various services for the project Odnoklassniki.  Inside the company, we call it ‚ÄúHot Code Replace‚Äù (HCR), and this tool is intended to fix critical and simple bugs in production services without stopping them.  This is an extremely important feature, since it allows you to avoid the rather cumbersome and time-consuming process of laying out a new, revised version of the failing service, avoiding the rather long enough pause in the availability of each host, and avoiding resetting the caches. <br><br>  In general, it saves a lot of time and reduces the interval from the moment of error detection to correction from hours to minutes.  Most often, as it was intended, minor errors in the code are corrected, for example, the programmer forgot to check for null and for some users certain actions on the site lead to an error.  That is, when a correction is made by changing several lines within a method.  And for the sake of such minor changes, you no longer need to distract colleagues and wait for hours for calculations on production. <br><a name="habracut"></a><br>  For example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/ra/dh/vz/radhvzc9u4d1q6dc8r4v6uhlekq.png" alt="image"><br>  Can be easily fixed to: <br><br><img src="https://habrastorage.org/webt/rp/9i/ta/rp9itax-od_0ahz3yg8dxdxvf7u.png" alt="image"><br>  Of course, you can make a lot more changes at the same time and add new classes, quickly make edits that the manager asks at the same time, without waiting for the next update.  But this is already, if monsiere knows a lot about perversions. <br><br>  Further, you can put "patches" on each other and to infinity. <br><br>  But this tool is not omnipotent and is based on the standard functionality that the Java class offers: <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/instrument/Instrumentation.html">java.lang.instrument. Instrumentation and its void redefineClasses method (ClassDefinition ... definitions)</a> . <br><br>  Instrumentation.redefineClasses replaces the previously loaded classes with a new byte code.  At the same time you can overload several classes with different dependencies.  Overload does not change existing instances of classes, does not change inheritance, does not touch the field of the instance or class.  You can only change the body of the method, a pool of constants and attributes.  You can add new classes or subclasses.  Signatures of methods, instances fields and class fields cannot be changed.  If you try to make incompatible changes, redefineClasses basically won't work and throws an error.  It must be remembered that when classes are overloaded, the execution of the overloaded section of code is not interrupted, the new bytecode will be used the next time the same method is called.  And therefore, if you try to correct the code of a method that has an infinitely long cycle inside, then the actual replacement will happen only after this cycle itself ends. <br><br>  If quite simply: you can change the code only inside the methods and period. <br><br>  And here is an example of a while loop that does not complete the method until it finishes. <br><br><img src="https://habrastorage.org/webt/p7/rv/1a/p7rv1agfvd0f7phg4otdxedkohk.png" alt="image"><br><br>  The main difficulty was to make a tool that works in the Odnoklassniki ecosystem, a tool that fits into all the established work processes.  Which will be stable and transparently interact with all services on hundreds of hosts, as well as be flexible and easy to use.  This tool must cope with dozens of experiments, work and updates that continuously occur on production. <br><br>  What is the process of installing the patch from the standpoint of the developer / admin, trying to fix the bug in the production, but so that it can be done with the help of a standard and reliable procedure on dozens of servers.  Omit the process of finding and correcting errors in the code. <br><br>  1. A separate brunch is created in GIT to fix the code.  The use of versioning is very important not only because of convenience, but also for subsequent possible investigations. <br><br>  2. TeamCity launches the patch build process.  First, the project build is created from the specified brunch and then the new build is compared with the one installed in the production.  For this, I wrote a plugin for the build tool that pulls all the files from the archives, compares the discrepancies and selects only those files that have changed or been added.  In this case, the Java compiler version in both builds should be the same, since  another version of the compiler will create different files and almost all project files will be included in the patch.  It is very important to create just a small-sized archive, which will get only the necessary files, because  This will significantly speed up the patch delivery process to dozens of servers.  The build process is not only suitable for the project code patch, you can also replace the patched library in the project.  During the comparison of the contents of the two assemblies, differences in the libraries (jar-files) will be found. <br><br>  3. In the case of a successful build, the patch is sent to a special repository, and in the result window a key (or hash) is issued, which is needed to unambiguously identify the patch and some guarantee that this particular code will go to production. <br><br><img src="https://habrastorage.org/webt/7v/c5/es/7vc5esvpyls4kbc-djqnyxp5owq.png" alt="image"><br><br>  Well, again - you can patch an unlimited number of times and assemblies with the same version number will differ by hash. <br><br>  4. Further, all activity moves to the configuration service, where in the usual UI you can specify for which service, on which hosts and which versions of applications you need to patch. <br><br><img src="https://habrastorage.org/webt/pd/qf/um/pdqfummd7yqcqr0igjjbdshtnqk.png" alt="image"><br><br>  Such an abundance of parameters gives the necessary level of flexibility of settings, which is very important in a large zoo of many servers.  For example, on some part of the servers, the version number of the application is different, and this code does not need to be patched.  Or, for verification, it first runs the Hot Code Rreplace on a single server, or on a group of servers, and then spreads across all instances of the application. <br><br>  5. Through the configuration change, the selected services receive information that the patch needs to be installed, its version and verification hash.  The idea is that all services receive the command ‚Äúinstall patch‚Äù and then act independently.  Independently compare their own version and only if the version is the same and the patch hash is missing or different, download the patch build from the repository on their own.  The download process itself takes place via HTTP, and you can quickly change the repository address, the number of download attempts and the waiting period between retries. <br><br>  6. Each application locally checks the assembly hash and unpacks it.  At the same time, each file is checked for its presence in the array, among those returned by Instrumentation.getAllLoadedClasses (), all new classes and files are written to the new - temporary classpath and this classpath is added via Instrumentation.appendToSystemClassLoaderSearch (), and the existing classes are read into memory and pass through the redefineClasses method. <br><br>  7. The whole process: the arrival of a signal about the need to patch the application, its downloading, checking, unpacking and use is logged in detail, both in the log file and in its own, so that you can quickly and easily track the process. <br><br>  8. After successful application of the patch, the process is completed by changing the version of the application to the patched one by adding a specially composed string that includes the patch hash.  If at some host the version has not changed to the expected one, we go to the Hot Code Replace log for this host and see what happened there.  If there were problems with the connection, then you can safely repeat the patch command and the desired host will retry. <br><br>  What possible problems can prevent the application from being patched?  There are quite a few of those, and among them I would put the Instrumentation class functionality in last place.  Until now, the curve code that does not meet the strict conditions of the redefineClasses has always been dropped by the JVM without any consequences for the operation of the application.  When using the redefineClasses method, the JVM completely stops the application, but this process takes a split second.  Because it is not scary. <br><br>  The most risky moment is the delivery of the patch to the server, which is decided by additional rerai.  But if the retracts do not help, then you can repeat the patch call command and each of the hosts will try to repeat the process, but install the patch only if it is necessary, i.e.  The patch has not been previously installed, or if the hash key has changed. <br><br>  Another potential problem is when a fix fixes one error and adds a new one.  To minimize this risk, we first lay out the patch on a limited number of servers, look at the logs, graphics, and monitor the result.  And only then we roll out the fixes on the other hosts. <br><br>  How to deal with the restart of the application or server?  This is already embedded in the logic of all applications of classmates: one of the first in any application is initiated by the HCR module.  And if during the initialization information about the need to patch the application is noticed, the patch will be applied first. <br><br>  And now a little about what makes Hot Code Replace. <br><br><ol><li>  Our JavaAgent.  JavaAgent, <a href="https://docs.oracle.com/javase/7/docs/api/java/lang/instrument/package-summary.html">if anyone has forgotten</a> , this is a separate specially formed * .jar archive, which is picked up by the JVM when the application is started using an additional parameter, for example: -javaagent: /path/to/lib/my-agent.jar It is due to the additional features of the Javaagent- and it is possible to use magic code replacement.  It is in the agent that the java.lang.instrument.Instrumentation class is available.  But, I did not bother him (the agent) with an extra code, since  agent update task is nontrivial, but simply rendered the instance of the Instrumentation class to the static field of the utility class.  Thus, all manipulations can be initiated from anywhere in the application. </li><li>  Configuration service - is responsible for the configuration of any of our applications and, therefore, in each application is initialized first.  It is there that the main functionality of the Hot Code Replace is hidden.  When the application starts or when the HCR configuration is changed for a particular application, version compatibility is checked and all the above described manipulations are performed. </li><li>  TeamCity and build scripts - to conveniently create ‚Äúpatches‚Äù and save only modified or added classes and resources in them. </li></ol><br>  What are the advantages we have from this tool?  The first is the promptness of correcting critical errors in the sale.  According to the logs, I see that colleagues have gradually become more and more often use HCR, instead of waiting for releases.  Next is the speed of use.  The application does not need to be stopped, the JVM only freezes for a split second and all your objects remain in place and continue to work. <br><br>  And our developers healed freely and happily and corrected their mistakes immediately and independently right in production without regard to the number of servers and workload. </div><p>Source: <a href="https://habr.com/ru/post/429040/">https://habr.com/ru/post/429040/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../429030/index.html">"Log Machine" makes free logos for comments</a></li>
<li><a href="../429032/index.html">Splunk Essentials for the Financial Services Industry App, or how Splunk enters the finance analytics market</a></li>
<li><a href="../429034/index.html">Some stories about underground programmers</a></li>
<li><a href="../429036/index.html">Trust Me, I know what I'm doing: independent adaptation of the modular robot to the task environment</a></li>
<li><a href="../429038/index.html">Rust News # 2 (October 2018)</a></li>
<li><a href="../429042/index.html">We test SharxBase, a hardware-software virtualization platform from the Russian vendor SharxDC</a></li>
<li><a href="../429044/index.html">Apple shares have experienced the strongest fall since 2014. Large investors have lost billions</a></li>
<li><a href="../429046/index.html">Four years of development SObjectizer-5.5. How has the SObjectizer changed during this time?</a></li>
<li><a href="../429048/index.html">Tips for a novice hoster</a></li>
<li><a href="../429050/index.html">Attack to the cryptocurrency exchange Gate.io is fixed</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>