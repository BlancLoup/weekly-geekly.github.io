<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Reducing AWS costs with Kubernetes Ingress with the classic ELB balancer</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few months ago, I wrote an article about the Kubernetes Nginx Ingress controller, which ranks second in popularity on this blog. Its main theme is t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Reducing AWS costs with Kubernetes Ingress with the classic ELB balancer</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/sg/gf/aw/sggfawywvq_9259m8jyeezwmbiy.jpeg"></p><br><p>  A few months ago, I wrote an article about the <a href="https://akomljen.com/kubernetes-nginx-ingress-controller/">Kubernetes Nginx Ingress</a> controller, which ranks second in popularity on this blog.  Its main theme is the use of Kubernetes Ingress for local deployments.  However, most users use Kubernetes in the AWS cloud and other cloud-based public services.  However, the problem is that for each service of type LoadBalancer, AWS creates a new balancer ELB (Elastic Load Balancer).  This may be too expensive.  If you use Kubernetes Ingress, you only need one ELB. </p><a name="habracut"></a><br><h2 id="kak-eto-rabotaet">  How it works? </h2><br><p>  For a better understanding, I will cite several schemes.  Without an Ingress controller, a separate classic ELB balancer will be created for each provided service: </p><br><p><img src="https://habrastorage.org/webt/j3/t9/6n/j3t96nx_sylog0pgub2xf7bnjqk.png"></p><br><p>  When using Ingress, you need only one such ELB balancer, which sends all requests to the proxy under Ingress, which is executed in the cluster: </p><br><p><img src="https://habrastorage.org/webt/yd/vc/gw/ydvcgwizbuelkx8nyyhomvar97e.png"></p><br><p>  Consider the cost of the Classic Load Balancer load balancer: </p><br><blockquote>  It is necessary to pay every full or incomplete hour of work of the load balancer Classic Load Balancer and for each gigabyte of data transferred with its help. </blockquote><p>  This means that when using a cluster in the US East region, you will have to pay approximately $ 18.25 for each service provided.  Still it is necessary to pay each gigabyte of the processed data.  Ingress allows you to reduce the cost of AWS with a large number of services provided.  Of course, for high availability, you can use multiple replicas of the Ingress proxy. </p><br><h2 id="razvertyvanie-nginx-ingress">  Deploying Nginx Ingress </h2><br><p>  There are many available options for the Ingress controller, for example, <a href="https://traefik.io/">Traefik</a> , <a href="https://github.com/appscode/voyager">Voyager</a> (for HAProxy), <a href="https://github.com/heptio/contour">Contour</a> (for <a href="https://www.envoyproxy.io/">Envoy</a> ), or even the <a href="https://github.com/kubernetes-sigs/aws-alb-ingress-controller">Ingress AWS ALB</a> controller (alpha version), which is somewhat different from the others.  In this post, I look at the <a href="https://github.com/kubernetes/ingress-nginx">Nginx Ingress</a> controller, which is now the most common.  Unlike the previous article about the <a href="https://akomljen.com/kubernetes-nginx-ingress-controller/">Ingress Nginx</a> controller, this time for deployment I use <a href="https://akomljen.com/package-kubernetes-applications-with-helm/">Helm</a> : </p><br><pre><code class="hljs lua">cat &gt; values.yaml &lt;&lt;EOF controller: replicaCount: <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-built_in"><span class="hljs-built_in">config</span></span>: use-proxy-protocol: <span class="hljs-string"><span class="hljs-string">"true"</span></span> service: annotations: service.beta.kubernetes.<span class="hljs-built_in"><span class="hljs-built_in">io</span></span>/aws-<span class="hljs-built_in"><span class="hljs-built_in">load</span></span>-balancer-proxy-protocol: <span class="hljs-string"><span class="hljs-string">'*'</span></span> EOF helm install <span class="hljs-comment"><span class="hljs-comment">--name ingress \ --namespace ingress \ -f values.yaml \ stable/nginx-ingress</span></span></code> </pre> <br><p>  Note.  Helm has a <a href="https://github.com/kubernetes/helm/issues/1449">problem</a> with the fact that logical values ‚Äã‚Äãare not analyzed as string values ‚Äã‚Äãwhen using the set argument.  Therefore, I created a file with values, but did not <code>--set</code> default values ‚Äã‚Äãvia <code>--set</code> and <code>--set-string</code> . </p><br><p>  Ingress checks Ingress displays two services, the controller and the server-side by default: </p><br><pre> <code class="hljs swift">kubectl <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> pod -n ingress --selector=app=nginx-ingress <span class="hljs-type"><span class="hljs-type">NAME</span></span> <span class="hljs-type"><span class="hljs-type">READY</span></span> <span class="hljs-type"><span class="hljs-type">STATUS</span></span> <span class="hljs-type"><span class="hljs-type">RESTARTS</span></span> <span class="hljs-type"><span class="hljs-type">AGE</span></span> ingress-nginx-ingress-controller-8689c87db7-jlwxv <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Running</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> 5m ingress-nginx-ingress-controller-8689c87db7-kv859 <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Running</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> 5m ingress-nginx-ingress-<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-backend-5f5888cc9b-jdjrp <span class="hljs-number"><span class="hljs-number">1</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-type"><span class="hljs-type">Running</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> 5m</code> </pre> <br><p>  Some points should be explained here.  Since all requests will go through the Ingress controller, it is advisable to have at least two of its replicas.  In essence, this is an internal proxy server.  The controller uses the default server portion to route non-existent Ingress resources.  The server side is pretty simple by default.  To obtain the source IP addresses in the Ingress proxy log, I activated the proxy protocol for Nginx and ELB using the following two settings: </p><br><pre> <code class="hljs cs">--<span class="hljs-keyword"><span class="hljs-keyword">set</span></span> controller.service.annotations.<span class="hljs-string"><span class="hljs-string">"service\\.beta\\.kubernetes\\.io/aws-load-balancer-proxy-protocol"</span></span>=<span class="hljs-string"><span class="hljs-string">'*'</span></span> \ --<span class="hljs-keyword"><span class="hljs-keyword">set</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> controller.config.use-proxy-protocol=<span class="hljs-literal"><span class="hljs-literal">true</span></span> \</code> </pre> <br><p>  The proxy protocol is intended to connect proxy servers without losing client data. </p><br><p>  And as a bonus, you can now easily get an automatic DNS.  First create a DNS A record using metacharacters, for example, <code>*.test.example.com</code> , which will point to an Ingress ELB controller.  The ELB address can be obtained with this command: </p><br><pre> <code class="hljs cs">kubectl <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> svc ingress-nginx-ingress-controller -o jsonpath=<span class="hljs-string"><span class="hljs-string">'{.status.loadBalancer.ingress[0].hostname}'</span></span> -n ingress a00950ebcfd0411e740ee0207cf10ce8<span class="hljs-number"><span class="hljs-number">-1089949860.</span></span>eu-west<span class="hljs-number"><span class="hljs-number">-1.</span></span>elb.amazonaws.com</code> </pre> <br><p>  Then, when you create the Ingress entry point with the host <code>site1.test.example.com</code> you can immediately enter this line in the browser.  DNS will resolve the name without additional configuration.  Using a DNS record with meta characters is not the best idea, but it works.  For detailed DNS settings, you can use <a href="https://github.com/kubernetes-incubator/external-dns">an external DNS</a> for Kubernetes. </p><br><h2 id="zaklyuchenie">  Conclusion </h2><br><p>  Using the Ingress controller really helps achieve a higher level of automation.  <strong>But remember that if it fails, all your external endpoints will also fail!</strong>  In the next article, I will show you how to configure automatic renewal and installation of SSL certificates using Let's Encrypt.  You can then use the default automatic DNS with SSL endpoints by default.  Follow the news. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/423809/">https://habr.com/ru/post/423809/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../423799/index.html">Briefing as an investment. Introduce intranet correctly</a></li>
<li><a href="../423801/index.html">Power supply of IT equipment: security or continuity? part 2</a></li>
<li><a href="../423803/index.html">Consumer-Driven Contracts as a way to develop a service</a></li>
<li><a href="../423805/index.html">Jeff Bezos Philosophy: "Day 1"</a></li>
<li><a href="../423807/index.html">How to use ‚ÄúTobii Eye Tracker 4C‚Äù to communicate with a child who cannot speak and move (SMA, Cerebral Palsy, ALS)</a></li>
<li><a href="../423811/index.html">Julia. Acquaintance</a></li>
<li><a href="../423815/index.html">Very Special Event: how we watched the Apple presentation and what we think about it</a></li>
<li><a href="../423817/index.html">Music and text: how they can be connected</a></li>
<li><a href="../423819/index.html">It seems that the memory of devices finally became enough for everyone.</a></li>
<li><a href="../423821/index.html">Mafia on Go, Vanila JS and WebSocket</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>