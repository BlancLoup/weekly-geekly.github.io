<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Docker Compose advanced configuration (translation)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Docker Compose has a number of non-trivial applications that we will look at in this article. This is another translation of the article that we analy...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Docker Compose advanced configuration (translation)</h1><div class="post__text post__text-html js-mediator-article">  Docker Compose has a number of non-trivial applications that we will look at in this article.  This is another <a href="https://runnable.com/docker/advanced-docker-compose-configuration">translation of the article</a> that we analyzed when preparing materials for our Python course for Web development. <br><br><img src="https://habrastorage.org/web/a01/63c/2ec/a0163c2ec6a4452c8956b940f4365c0d.png"><br><br><h3>  Launch order control </h3><br>  Docker Compose runs containers in dependency order, using the depends_on option to specify when the service starts.  To determine the startup order, Compose uses depends_on, links, volumes_from and network_mode: "service: ...". 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      If the container must wait for the ‚Äúready‚Äù state of another container, you can use the wait-for-it or dockerize tools.  They will check the hosts and ports until the TCP connection is confirmed.  To include a forced wait in the composition, you need to add the entrypoint: <br><br><pre><code class="bash hljs">version: <span class="hljs-string"><span class="hljs-string">'2'</span></span> services: web: build: . ports: - <span class="hljs-string"><span class="hljs-string">"80:8000"</span></span> depends_on: - db entrypoint: <span class="hljs-string"><span class="hljs-string">"./wait-for-it.sh db:5432"</span></span> db: image: postgres</code> </pre> <br>  You can always write a script wrapper yourself if the need arises for more control. <br><a name="habracut"></a><br><h3>  Running multiple copies of the Compose project </h3><br>  If you need multiple copies of environments with the same composition (or docker-compose.yml file), just run docker-compose up -p new_project_name. <br><br><h3>  Environment Variables </h3><br>  Shell environment variables can be used to set values ‚Äã‚Äãin compositions: <br>  Set the environment variables: <br><br><pre> <code class="bash hljs">$ TAG=<span class="hljs-string"><span class="hljs-string">"latest"</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$TAG</span></span> latest $ DB=<span class="hljs-string"><span class="hljs-string">"postgres"</span></span> $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$DB</span></span> postgres</code> </pre> <br>  Use the environment variable in the Docker Compose file: <br><br><pre> <code class="bash hljs">db: image: <span class="hljs-string"><span class="hljs-string">"</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">${DB}</span></span></span><span class="hljs-string">:</span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$TAG</span></span></span><span class="hljs-string">"</span></span></code> </pre> <br>  Docker Compose accepts both $ {DB} and $ TAG.  You can also set environment variables in containers: <br><br><pre> <code class="bash hljs">web: environment: - PRODUCTION=1</code> </pre> <br>  You can even pass environment variables into containers: <br><br><pre> <code class="bash hljs">$ PRODUCTION=1 $ <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-variable"><span class="hljs-variable">$PRODUCTION</span></span> 1</code> </pre> <br><h3>  Environment file </h3><br>  To guarantee the transfer of an environment variable, you must store it in an environment file.  Name the .env file and save it in the working directory.  Docker Compose ignores blank lines (use them for better readability) and code starting with # (that is, comments).  You can assign variables for further substitution, as well as set Compose CLI variables: <br><br><pre> <code class="bash hljs">COMPOSE_API_VERSION COMPOSE_FILE COMPOSE_HTTP_TIMEOUT COMPOSE_PROJECT_NAME DOCKER_CERT_PATH DOCKER_HOST DOCKER_TLS_VERIFY</code> </pre> <br>  Sample environment file: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># ./.env #     COMPOSE_API_VERSION=2 COMPOSE_HTTP_TIMEOUT=45 DOCKER_CERT_PATH=/mycerts/docker.crt EXTERNAL_PORT=5000</span></span></code> </pre> <br><h3>  Using multiple Docker Compose files </h3><br>  Use several Docker Compose files if you need to modify the application for different environments (development, intermediate environment and production) or run administration tasks through the Compose application.  This provides a way to share common configs. <br><br>  Docker Compose by default reads two files: docker-compose.yml and docker-compose.override.yml.  You can store overrides for existing services in the docker-compose-override.yml file or define new ones.  To use multiple files (or a override file with a different name), you must pass -f to docker-compose up (the order matters): <br><br><pre> <code class="bash hljs">$ docker-compose up -f my-override-1.yml my-overide-2.yml</code> </pre> <br>  When the two configuration options match, the new value replaces or expands the original one. <br><br>  In this example, the new value overwrites the old one and the command starts my_new_app.py: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   command: python my_app.py #   command: python my_new_app.py       (ports, expose, external_links, dns, dns_search  tmpfs), Docker Compose   (   Compose   5000  8000): #   expose: - 5000 #   expose: - 8000</span></span></code> </pre> <br>  If environment, labels, volumes, or devices are used, Docker Compose combines the results.  In the following example, the three environment variables become FOO = Hello and BAR = ‚ÄúPython Dev!‚Äù: <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#   environment: - FOO=Hello - BAR=World #   environment: - BAR="Python Dev!"      Docker Compose    (docker-compose.yml): web: image: "my_dockpy/my_django_app:latest" links: - db - cache db: image: "postgres:latest" cache: image: "redis:latest"</span></span></code> </pre><br>  On the development server, we want to open the ports, mount the code as a volume and create a web image (docker-compose.override.yml): <br><br><pre> <code class="bash hljs">web: build: . volumes: - <span class="hljs-string"><span class="hljs-string">".:/code"</span></span> ports: - <span class="hljs-string"><span class="hljs-string">"8883:80"</span></span> environment: DEBUG: <span class="hljs-string"><span class="hljs-string">"true"</span></span> db: <span class="hljs-built_in"><span class="hljs-built_in">command</span></span>: <span class="hljs-string"><span class="hljs-string">"-d"</span></span> ports: - <span class="hljs-string"><span class="hljs-string">"5432:5432"</span></span> cache: ports: - <span class="hljs-string"><span class="hljs-string">"6379:6379"</span></span></code> </pre> <br>  docker-compose up automatically reads the override file and applies it.  You will also need the production version of the Docker Compose application, which we call docker-compose.production.yml: <br><br><pre> <code class="bash hljs">web: ports: - <span class="hljs-string"><span class="hljs-string">"80:80"</span></span> environment: PRODUCTION: <span class="hljs-string"><span class="hljs-string">"true"</span></span> cache: environment: TTL: <span class="hljs-string"><span class="hljs-string">"500"</span></span></code> </pre><br>  When you need to deploy a production file, simply run the following: <br><br><pre> <code class="bash hljs">$ docker-compose -f docker-compose.yml -f docker-compose.production.yml up -d</code> </pre> <br>  Note: Docker Compose reads docker-compose.production.yml, but not docker-compose.override.yml. <br><br><h3>  Admin Tasks </h3><br>  You need to run an administrative copy of the application to be able to perform certain tasks, for example, backup a database.  Using the already mentioned docker-compose.yml file, create the docker-compose.admin.yml file: <br><br><pre> <code class="bash hljs">dbadmin: build: database_admin/ links: - db</code> </pre> <br>  And then, run the following command: <br><br><pre> <code class="bash hljs">$ docker-compose -f docker-compose.yml -f docker-compose.admin.yml run dbadmin db-backup</code> </pre> <br>  Expansion of services <br><br>  You can share configurations using the extends field.  It also allows sharing options between different projects. <br><br>  Create common-services.yml (you can name it as you like): <br><br><pre> <code class="bash hljs">webapp: build: . ports: - <span class="hljs-string"><span class="hljs-string">"8000:8000"</span></span> volumes: - <span class="hljs-string"><span class="hljs-string">"/data"</span></span></code> </pre> <br>  Create a base docker-compose.yml.  For example: <br><pre> <code class="bash hljs">web: extends: file: common-services.yml service: webapp</code> </pre> <br>  In addition, you can define (or override) the configuration and add other services locally: <br><br><pre> <code class="bash hljs">web: extends: file: common-services.yml service: webapp environment: - DEBUG=1 cpu_shares: 5 links: - db important_web: extends: web cpu_shares: 10 db: image: postgres</code> </pre><br><h2>  Common problems </h2><br><h3>  Launch order control </h3><br>  Docker Compose waits only to launch the container before moving on to the next one.  In the event that one part of the application becomes unavailable, Docker Compose relies on the flexibility of the rest of the application. <br><br><h3>  Environment file </h3><br>  If you define environment variables in the shell or via the command line while docker-compose is running, these variables will take precedence over the .env file. <br><br>  You should not store environment variables in the version control system.  If you are using the environment file, add it to the local ignore file and create an env.sample sample, similar to the following example (if it is assumed that the .env file described above is used): <br><br><pre> <code class="hljs 1c">COMPOSE_API_VERSION= <span class="hljs-meta"><span class="hljs-meta">#   2 COMPOSE_HTTP_TIMEOUT= #   30    120   DOCKER_CERT_PATH= #     EXTERNAL_PORT= #     (, 5000 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> Flask  8000 </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword"></span></span></span><span class="hljs-meta"> Django)</span></span></code> </pre> <br><h3>  Using multiple Docker Compose files </h3><br>  Note that Docker Compose merges files in the order you specified. <br><br><h3>  Expansion of services </h3><br>  Services never share links, volumes_from or depends_on, using extends;  links and volumes_from must always be defined locally. <br><br><h3>  The end </h3><br>  With questions, suggestions and comments - welcome in the comments.  And if you want to speak in real time, join us at <a href="http://otus.ru/lessons/python-dlja-web-razrabotki/%3Futm_source%3Dhabr%26utm_medium%3Daffilate%26utm_campaign%3Dwebdev%26utm_term%3Dprofi11.09">the Open Day of the</a> course. </div><p>Source: <a href="https://habr.com/ru/post/337688/">https://habr.com/ru/post/337688/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337674/index.html">Kindergarten, pants with straps: where do programmers come from</a></li>
<li><a href="../337676/index.html">How to optimally calculate the amount of "iron": Sizing model of the EFS</a></li>
<li><a href="../337678/index.html">The practice of forming requirements in IT projects from A to Z. Part 6. System behavior. Excellence requirements</a></li>
<li><a href="../337680/index.html">Plugin for HANA Database project in Visual Studio</a></li>
<li><a href="../337682/index.html">Oracle actually eliminates Sun</a></li>
<li><a href="../337690/index.html">Yandex. Blitz. Why and what algorithmic problems need to be able to solve, working in the search</a></li>
<li><a href="../337692/index.html">Experience in implementing PSR standards in a single project</a></li>
<li><a href="../337694/index.html">VMware Announces ‚ÄúEnd‚Äù vCenter Server for Windows</a></li>
<li><a href="../337698/index.html">Writing operator for Kubernetes at Golang</a></li>
<li><a href="../337700/index.html">10 interesting innovations in JUnit 5</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>