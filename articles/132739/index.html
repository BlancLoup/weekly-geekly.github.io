<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Capacitive touch sensor without external strapping on STM32 Discovery</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Earlier this year, a worthy citizen of Ariman wrote an article about how to fasten a capacitive touch sensor to a microcontroller. This idea seemed ra...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Capacitive touch sensor without external strapping on STM32 Discovery</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/f8b/e7f/4f9/f8be7f4f93716a73e112dd388e8175ea.jpg"><br>  Earlier this year, a worthy citizen of <a href="http://geektimes.ru/users/ariman/" class="user_link">Ariman</a> wrote <a href="http://habrahabr.ru/blogs/DIY/111679/">an article</a> about how to <a href="http://geektimes.ru/users/ariman/" class="user_link">fasten a</a> capacitive touch sensor to a microcontroller.  This idea seemed rather promising to me; for some devices, touch keys would be much better than mechanical ones.  In this article I will talk about my implementation of this useful technology based on the STM32 Discovery debug card. <br><a name="habracut"></a><br>  So, just starting to learn the STM32, I decided to add the ability to detect touches to the device as an exercise.  Having begun to understand the theory and practice of the above article, I repeated the scheme of Comrade <a href="http://geektimes.ru/users/ariman/" class="user_link">Ariman</a> 'a.  It worked perfectly, but I, a fan of minimalism, wanted to simplify it, getting rid of unnecessary elements.  Superfluous in my opinion were the external resistor and the path to the power supply.  All this is already in most microcontrollers, including AVR and STM32.  I mean the pull-up resistors of the I / O ports.  Why not charge the record and our fingers through them?  In anticipation of a trick, I put together a scheme that, to my surprise, earned from the first time.  As a matter of fact, it is even ridiculous to call this scheme, because all we need is to simply connect the contact plate to the leg of the debug board.  All work will take the microcontroller. <br><br>  What is the program like?  First two functions: <br>  The first one brings a logical ‚Äú0‚Äù to the sensor's pin (zero pin in register C) <br><br><pre><code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sensor_Ground</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { GPIOC-&gt;CRL = <span class="hljs-number"><span class="hljs-number">0x1</span></span>; GPIOC-&gt;BRR |= <span class="hljs-number"><span class="hljs-number">0x1</span></span>; }</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The second sets up the same output pin, with a power pull. <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Sensor_InPullUp</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { GPIOC-&gt;CRL = <span class="hljs-number"><span class="hljs-number">0x8</span></span>; GPIOC-&gt;BSRR |= <span class="hljs-number"><span class="hljs-number">0x1</span></span>; }</code> </pre> <br><br>  Now at the beginning of the polling cycle, we will call Sensor_Ground (), and wait a while to discharge all residual charge on the sensor to the ground.  Then, we reset the count variable, which we will consider as the sensor charging time, and call Sensor_InPullUp (). <br><br><pre> <code class="hljs objectivec">Sensor_Ground(); Delay(<span class="hljs-number"><span class="hljs-number">0xFF</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   count = 0; Sensor_InPullUp();</span></span></code> </pre> <br><br>  Now the sensor starts charging through the internal pull-up resistor with a nominal value of the order of dozens of Kohms (30..50K ohm at STM32).  The time constant of such a circuit will be equal to the read cycles, so I changed the quartz resonator on the debug board to a faster 20 MHz (by the way, I did not immediately notice that it turns out on STM32 Discovery the quartz changes without soldering).  So, consider the processor clock cycles until a logical unit appears at the input: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(!(<span class="hljs-type"><span class="hljs-type">GPIOC</span></span>-&gt;<span class="hljs-type"><span class="hljs-type">IDR</span></span> &amp; <span class="hljs-number"><span class="hljs-number">0x1</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">count</span></span>++; }</code> </pre> <br><br>  After exiting this cycle, a count variable will be stored in proportion to the capacity of the sensor plate.  In my case with a 20 MHz chip, the count value equals 1 with no pressing, 7-10 with the lightest touch, 15-20 with normal touch.  It remains only to compare it with the threshold value and do not forget to call Sensor_Ground () again, so that by the next polling cycle the sensor has already been discharged. <br>  The resulting sensitivity is enough for confident determination of touching the bare metal pads.  When the sensor is covered with a sheet of paper or plastic, the sensitivity drops by three to four times, only confident pressures are well defined.  To increase the sensitivity in the case when the sensor needs to be covered with protective material, you can increase the clock frequency of the microcontroller.  <s>With the chip series STM32F103, capable of operating at frequencies up to 72 MHz, millimeter obstacles between the finger and the sensor will not interfere.</s> <br>  Compared to the implementation of <a href="http://geektimes.ru/users/ariman/" class="user_link">Ariman</a> 'a, my approach works much faster (about a dozen cycles of polling one sensor), so I did not complicate the program by setting up timer interrupts. <br><br>  Finally, a video demonstrating the work of the sensor. <br><iframe width="420" height="315" src="https://translate.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://www.youtube.com/embed/JgzaUsu9wR4%3Ffeature%3Doembed&amp;xid=17259,15700022,15700186,15700190,15700253,15700256,15700259&amp;usg=ALkJrhiAJzS9irAbxgBQBLUoQDnu0oeKMw" frameborder="0" allowfullscreen=""></iframe><br><br>  <a href="https://docs.google.com/open%3Fid%3D0BwCpyYEhkf-AYTBlNmQyMGUtNDcyZS00OGY0LWI5ODUtMDQzYmEyMGY0NzA3">Main.c</a> test program. <br><br>  <a href="http://www.st.com/internet/com/TECHNICAL_RESOURCES/TECHNICAL_LITERATURE/REFERENCE_MANUAL/CD00246267.pdf">Reference Manual</a> on the microcontroller <br><br>  <a href="http://geektimes.ru/users/alpine63rus/" class="user_link">Thanks ALPINE63rus</a> user for a very useful article <a href="http://habrahabr.ru/blogs/controllers/128734/">ARM-microcontrollers STM32F.</a>  <a href="http://habrahabr.ru/blogs/controllers/128734/">Quick start with STM32-Discovery</a> , <a href="http://geektimes.ru/users/ariman/" class="user_link">Ariman</a> user for the idea and clear theoretical description. <br><br>  <b>UPD.</b>  <b>After <a href="http://geektimes.ru/users/ew1abz/" class="user_link">ew1abz</a> 'a comment, I decided to figure out the timing and found that the default STM32 Discovery is tuned to the clock frequency.</b> <b><br></b>  <b>(HSE / 2) * 6 = 24 MHz, where HSE is the frequency of external quartz.</b>  <b>Accordingly, changing the quartz from 8 to 20 MHz, I forced the poor STM to operate at 60 MHz.</b>  <b>So, firstly, some of the findings are obviously not entirely correct, and secondly, what I was doing could lead to chip malfunctions.</b>  <b>In case of such failures in the microcontroller there is a HardFault interrupt, using them, I checked the higher frequencies.</b>  <b>So, the chip starts to fail only at 70 MHz.</b>  <b>But although the controller digests this particular program at 60 MHz, it can behave unpredictably when using peripherals or working with Flash memory.</b>  <b>Conclusion: treat this topic as an experiment, repeat only at your own peril and risk.</b> </div><p>Source: <a href="https://habr.com/ru/post/132739/">https://habr.com/ru/post/132739/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../132733/index.html">Project Moonshot: 2800 servers in one rack</a></li>
<li><a href="../132734/index.html">‚ÄúWhite‚Äù hackers and CTF</a></li>
<li><a href="../132735/index.html">What is TYPO3 and what is it eaten with?</a></li>
<li><a href="../132736/index.html">PHP Namespace</a></li>
<li><a href="../132738/index.html">Microsoft is attacking Android with ‚Äútrivial‚Äù patents</a></li>
<li><a href="../13274/index.html">IRC channel and Jabber conference room</a></li>
<li><a href="../132742/index.html">Google vs Yandex or Why is Google looking better?</a></li>
<li><a href="../132743/index.html">MODx Revo, Login authorization setting. Basic setup</a></li>
<li><a href="../132744/index.html">Microsoft Search Server 2010 Express</a></li>
<li><a href="../132745/index.html">Node.js on Windows (with performance tests)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>