<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hybrid Storage for Out-of-the-House Homes and High Availability from Synology</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Several years ago, when choosing the first storage for the house, I looked in the direction of ‚Äúboxed solutions‚Äù because of the lack of special awaren...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hybrid Storage for Out-of-the-House Homes and High Availability from Synology</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/6j/vn/s2/6jvns268d3fi-jkttzzzryzw0y0.jpeg" align="left">  Several years ago, when choosing the first storage for the house, I looked in the direction of ‚Äúboxed solutions‚Äù because of the lack of special awareness in building storage systems based on open source software and ordinary PCs.  At that time, the choice fell on a 2-disk NAS - <a href="https://geektimes.ru/post/183274/">Shuttle KD20</a> .  The vault was compact and quiet.  RAID1 provided the necessary reliability, and at that time there was no need for high performance and advanced functionality.  This NAS worked for almost 4 years, until one day the fan power supply line was covered.  The wheels are heated to 60 degrees and miraculously survived.  I sealed the fan directly to the motherboard, but began to pick up a replacement option.  As a second NAS, I chose a 4-disk Synology.  The tasks remained the same, so I didn‚Äôt go into the <b>DiskStation Manager (DSM)</b> functionality.  This lasted until I decided to install home video surveillance on several channels.  Despite the fact that Synology has its own video surveillance service, I stopped at <a href="https://habrahabr.ru/company/stss/blog/267929/">Macroscop</a> - there was a need for advanced functionality and serious analytics.  Fortunately, I found a new <b>Virtual Machine Manager</b> package in DSM ‚Äî the hypervisor, with which I created a virtual machine and installed Windows and Macroscop on it.  The recording system worked fine, the built-in Pentium 1.6 GHz hardly, but managed to work out the tasks of the storage system and the virtual machine.  But as soon as any analyst was activated, the service fell off due to processor overload.  As a result, I was forced to start searching for a separate Windows budget device with adequate performance for the implementation of the video surveillance server, since Synology of the required level is not cheap.  At that very moment, I once again stumbled across the network on articles on installing DSM on regular hardware and my XPenology project started ... <br><a name="habracut"></a><br>  The cost of the necessary components for the new store was commensurate with the cost of the Intel NUC, which I looked after for the video surveillance server.  Therefore, I decided to abandon the existing Synology in favor of my brother (and use it as a remote backup), and to assemble the all-in-one system based on DSM for myself. <br><br>  As a platform, I chose the well-known <a href="http://www.chenbro.com/en-global/products/TowerServerChassis/Mini_ITX_Server/SR301">Chenbro SR30169 case</a> for 4 hot-swap baskets.  I chose a motherboard based on the number of LANs and on the form factor - I found only this one from fresh ones - the <a href="https://www.asrock.com/MB/Intel/Z370M-ITXac/index.asp">Asrock Z370M-ITX / ac</a> .  Two network interfaces, support for the 8th generation of processors, and most importantly - 6 x SATA on board, which means that you can still connect the SSD under the cache for reading.  The i3-8100 processor with 4 cores and 16GB memory (with a margin for virtualoks).  Left disks from the previous Synology - 4 x 6Tb. <br><br><h3>  Platform assembly </h3><br>  When used on a table, this case normally cools 4 disks in hot-swap baskets.  But in the cabinet under load the temperature of the disks reached 48-50 degrees.  Therefore, I decided to replace the regular 120th fan with a more productive one. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/j1/ac/zm/j1aczm6ubldqvkip5bc7xsntgew.jpeg"><br><br>  1.5A fan lowered the temperature of the discs to 36-40 degrees.  After completion of the hood from the cabinet, I am sure that the temperature will still drop significantly. <br><br>  I installed one SSD 2.5 "under the cache on a standard mount on one side of the disk basket. Its temperature did not exceed 30-32 degrees, and this despite the fact that it does not actively cool. <br><br><img src="https://habrastorage.org/webt/3c/jd/y0/3cjdy0acnfy8kprb82jzqrvxd3a.jpeg"><br><br>  As a disk for DSM packages and a fast partition, I installed the M.2 SATA SSD in the slot on the motherboard.  The drive was heated to 50 degrees, despite the direct blowing.  I solved the problem by installing several radiators on it - the temperature dropped by 10 degrees. <br><br><img src="https://habrastorage.org/webt/k1/l4/y6/k1l4y6o2ovfcr53ijjmwl-q-e4m.jpeg"><br><br>  I have 2 constantly active USB devices: XPenology bootloader and Guardant dongle from Macroscop.  In order not to occupy the external connectors, I attached these devices inside the case. <br><br><img src="https://habrastorage.org/webt/ej/d6/oc/ejd6ocxplqomt6hhsb7tw61904a.jpeg"><br><br>  Ready storage with high performance processor and the most compact size with a creak, but fit into the free 6 units. <br><br><img src="https://habrastorage.org/webt/um/qi/ml/umqimlcovqo_ke-vz_aoa5khetu.jpeg"><br><br><h3>  Bootloader preparation </h3><br>  In order to install DSM, you need a bootloader that will present the hardware as Synology storage. <br><br>  There are a lot of instructions on this topic on the Internet, so I will not go into details, but if there are interested ones, I can describe the details of the preparation of the boot device. <br><br>  After installing a valid serial / MAC pair and other parameters, the image for the DS3615 is uploaded to any device from which you can boot.  You can use SATA DOM, but since I have SATA ports for reading out - I stopped at the classic version - USB flash drive. <br>  In BIOS, you need to remove all boot devices except USB, and in the SATA settings, enable the HotPlug function so that new drives are detected hot, without waiting for a reboot. <br><br><h3>  Launch </h3><br>  When you first start looking for a device using find.synology.com.  If this option does not work, then download Synology Assistant from the official site and scan the network using it. <br>  After connecting to the storage address to the web interface, the system offers to install DSM.  If at the step of preparing the bootloader everything was done correctly - the installation can be made not from the image file, but immediately from the official site in automatic mode. <br>  The system formats all installed media and on each creates an area for the DSM.  Thus, by moving disks to another Synology or Xpenology repository, you can migrate and save all data and system settings. <br><br>  Before realizing everything at home, I practiced for a long time on various platforms.  The system without problems migrated from a computer based on the Celeron J1900 to a server with 2 x E5-2680V4, and then to an ancient exhibit based on 2 x E5645.  If there are virtuals, then of course it is necessary to enable processor compatibility mode before installing the OS on the virtual machine.  This probably decreases productivity, since  The processor in a virtualka becomes not real, but universal.  But then, migration takes place without difficulties and BSOD. <br><br><h3>  Customization </h3><br>  Work through the Xpenology loader has almost no limitations compared to the original device.  Among the differences, we can note the lack of the QuickConnect function - there is no remote access to the storage via the Synology account.  But I have an external IP - this restriction is not relevant for my case. <br><br>  Also, the processor model and the number of cores are incorrectly displayed - the information is sewn in the bootloader and will always look like for DS3615xs: INTEL Core i3-4130 / 2 cores.  But then, the frequency is determined by the current.  This feature does not interfere with the determination and use of the real number of cores by the hypervisor.  But even here there are limitations - Virtual Machine Manager will see no more than 8 cores in the system.  Therefore, it is pointless to install DSM on multi-core configurations. <br>  With the amount of RAM everything is in order - the entire volume was determined and used (in practice, up to 48GB). <br>  Integrated network controllers are defined without problems, but I did not find WiFi.  I assume that this problem can be solved by adding drivers, but, unfortunately, my knowledge of Linux does not allow me to realize this.  If there is a person from the readers of this article who can describe the instructions for adding drivers to the wireless controller to the assembly, I would be grateful. <br><br>  Before using storage, you must create a RAID group.  After the transition to the first Synology, I left a ‚Äúmirror‚Äù, and launched 2 additional disks on Hot Spare.  When switching to Xpenology, I chose RAID5 + HS, but then added the 4th disk to RAID6.  All the same, it is spinning and warming - even if with advantage. <br><br>  Since DSM provides both file and block access, before creating a RAID array, you need to decide on the type of future storage. <br><br><img src="https://habrastorage.org/webt/cf/i7/s6/cfi7s6q8iboip0ztvep3f2gwmva.jpeg"><br><img src="https://habrastorage.org/webt/xs/41/af/xs41afntwmncsduod-bvrtukt5a.jpeg"><br><br>  I immediately created several LUNs for use on a home mini-PC and laptop.  The file sphere is good, and the block access disk for installing programs is even better. <br><br><img src="https://habrastorage.org/webt/xu/xj/am/xuxjambzt3zu3evgtznj6wy1a6o.jpeg"><br><br>  Next, create the required number of LUNs and partitions on RAID groups, shared folders, and so on.  There is no point in describing the well-known functionality of Synology.  All available expansion packs with a description of the functionality are available on the <a href="https://www.synology.com/ru-ru/dsm/packages">official website</a> . <br><br>  Under my tasks the following packages were relevant: <br><br>  <b>Virtual Machine Manager</b> - actually because of him the whole idea with Xpenology. <br><br><img src="https://habrastorage.org/webt/-z/5o/yp/-z5oyp93dbnz_t0afspibfo9b-k.jpeg"><br><br>  The package has more advanced functionality than I use, so I decided to test its operation on several nodes in the High Availability Cluster mode. <br><br>  But, was soon disappointed.  The cluster requires 3 nodes: active, passive, and storage.  Automatic migration of virtual machines when an active node fails is supported only on Synology Virtual DSM virtual machines - it will not roll with Windows and other operating systems.  What is the point on DSM to raise a cluster with virtual DSMs I did not understand ... <br>  In general, more than a banal hypervisor, I did not open this module for myself. <br><br>  <b>VPN Server</b> - supports PPTP, OpenVPN and L2TP / IPSec <br>  PPTP, as I found out, supports only one connection for free - I use it to communicate with remote Synology for backup. <br><br>  I use OpenVPN to connect from iPhone and desktop computer, as well as to connect LUN remotely via iSCSI. <br><br>  <b>Hyper Backup</b> is a convenient, functional and, at the same time, concise backup service. <br><br>  You can back up both folders and LUNs.  File backup can be merged to another Synology, to another NAS and into the clouds.  LUN is backed up only locally or remotely to the Synology device.  Therefore, if you need to backup the moon to the cloud, as I understand it, you can first save it to a local folder, and then to the cloud. <br>  I use 3 types of redundancy: <br><br><img src="https://habrastorage.org/webt/fv/bq/mz/fvbqmzgnijhwoiwnnyfp9qz4vki.jpeg"><br><br><ol><li>  Reserve for a remote Synology - everything is copied there, except for the backup folder (there is a full backup of the remote Synology in it). </li><li>  Backup only the most important on Yandex disk (via WebDAV) </li><li>  Double to Google Drive (available in the list of available cloud services) </li></ol><br>  File backup features are pretty wide. <br><br><img src="https://habrastorage.org/webt/es/i-/yy/esi-yy-igvzo_f5xcf-370yve5c.jpeg"><br><br>  Selecting the method and specifying the data for authorization on the remote device are marked with folders for backup. <br><br>  Next, configure the schedule and backup options. <br><br><img src="https://habrastorage.org/webt/ik/py/jz/ikpyjzokj7n4opwbzugnlyxioie.jpeg"><br><br>  If you select encryption, you will need to enter a password to access the backup.  After creating the task, the key file is automatically unloaded, which can replace the forgotten password during data recovery. <br><br>  Client-side encryption, in my opinion, is very useful when backing up to a public cloud.  If Google can do anything with the archive of your photos, then an encrypted backup of the same photos will be of no use to anyone. <br><br>  Then the backup rotation is enabled / configured. <br><br><img src="https://habrastorage.org/webt/m0/ut/bl/m0utbl1-akz9ybozhx0erhti8x8.jpeg"><br><br>  I use the Smart Recycle mode, but you can set the schedule for rotating copies of incremental backups in your own way. <br><br>  The Hyper Backup module only works in conjunction with the reverse part ‚Äî the <b>Hyper Backup Vault</b> module. <br><br>  This service accepts remote copies and is responsible for their storage. <br><br><img src="https://habrastorage.org/webt/xk/-i/yd/xk-iydosjbgdm4nhi1kl6_40tsg.jpeg"><br><br>  Restoration of data, applications and settings is possible both on the current system (if the array is damaged, data is lost, etc.), or on a new one the same or completely different Synology or Xpenology.  To restore, when creating a backup task, you need to specify that this is not a new task, but a connection to an existing one.  Hyper Backup will see the necessary backup on the remote machine and will offer to select the version of the copy by date and time. <br><br>  At the moment, this is still all the functionality that I managed to master and use. <br>  Home Xpenology continues to work without problems - DSM and packages are periodically updated, computational capacities with a margin, and for money it cost me 1.5 times cheaper than Synology DS916 +. <br><br><h3>  Synology High Availability Cluster </h3><br>  I was interested in the <b>High Availability Manager service</b> , which turned out to be incompatible with the Virtual Machine Manager service, as it also does the cluster, but in a different way. <br><br><img src="https://habrastorage.org/webt/7r/lk/7z/7rlk7zxq6cenu6x_2tbwvk1kvsy.jpeg"><br><br>  For testing, I picked up Xpenology on two servers based on 2 x Xeon E5645.  The servers for this cluster must be identical, the IP addresses are static, the second port of each server is connected to each other directly (via a switch, but more efficiently). <br><br><img src="https://habrastorage.org/webt/1b/mw/pn/1bmwpnnv51h8e4knzb6xrsp_wxy.jpeg"><br><br>  After connecting the second node, the Heartbeat connection is tested.  Next, a cluster name and a static local address are assigned.  During a node merge, the passive node configuration is brought to the active state, applications, storage and data are synchronized.  Both nodes fall off to access the network, and after creation - the cluster is available at its new address. <br><br><img src="https://habrastorage.org/webt/vq/kw/2n/vqkw2nxfhkgaxkeezslnnqdf0oc.jpeg"><br><br>  Depending on the amount of existing data, full synchronization of arrays can take a lot of time, but the cluster is available to work without fault tolerance within 10 minutes after the start of the merge. <br><br><img src="https://habrastorage.org/webt/_i/hx/by/_ihxbyld-ph7ck19bltvabbtjvk.jpeg"><br><br>  After the second node is a full copy of the first, the high availability mode is activated. <br><br>  To test the fault tolerance, I created a LUN, connected it via iSCSI, and launched a voluminous task of reading and writing from my PC, along with playing a video. <br><br>  At the time of activity, I de-energized the main server.  The LUN did not fall off, the copying process was not interrupted, but it stopped for 10-15 seconds - this time it took the passive server to take the role of an active one and start the dropped services.  Playback also paused for a few seconds.  After a short idle time, data copying and video playback continued in normal mode without the need to restart the process.  Such a ‚Äúfailure‚Äù in most cases will not be noticeable to users, unless the video is played without buffering or any other processes are running that require continuous access to the repository. <br><br><img src="https://habrastorage.org/webt/og/ts/39/ogts39scg148ioam3bs4jvx6-mw.jpeg"><br><br>  After turning on the first node, it goes into passive server mode.  A background synchronization process starts, after which the high availability mode is restored again. <br><br>  To replace the node, in case of complete failure, you must release the passive server. <br><br><img src="https://habrastorage.org/webt/m2/8k/f-/m28kf-tm8roldaxyvprxamqjjr0.jpeg"><br><br>  The procedure for linking a passive server is similar to the procedure for creating a cluster, first synchronization - then High Availability.  Only with one exception - the addition is already happening from the cluster interface, and not the active server. <br><br>  From the minuses of such a solution - high redundancy, well, plus - honest fault tolerance. <br>  The main costs fall on the drives, but for fans of RAID10, the most it!  Mirror two nodes with RAID5 or RAID6 - the disks will be almost the same.  But fault tolerance will be added multiple. <br><br>  It is clear that this is not a unique functionality, but out of the box and does not require special experience and knowledge - just a web interface.  And, considering that Xpenology works on any hardware, it turns out to be a very interesting, productive, and fault-tolerant solution for personal use. <br><br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/353872/">https://habr.com/ru/post/353872/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353862/index.html">Conference SMARTRHINO-2018</a></li>
<li><a href="../353864/index.html">Different facets of a digital enterprise</a></li>
<li><a href="../353866/index.html">A little about physics in almost Agar IO on aicups.ru</a></li>
<li><a href="../353868/index.html">Map matching and processing of raw GPS data on an industrial scale</a></li>
<li><a href="../353870/index.html">Telecom's digital transformation, or how operators ‚Äúgo‚Äù to IT</a></li>
<li><a href="../353876/index.html">Configure Sublime Text 3 to work with VHDL files</a></li>
<li><a href="../353878/index.html">How to hide DNS requests from the prying eyes of the provider</a></li>
<li><a href="../353880/index.html">Telegram and AWS Blocking - Morning does not start with coffee</a></li>
<li><a href="../353884/index.html">Sophisticated javascript call center</a></li>
<li><a href="../353886/index.html">Asynchronous Loops and Stream APIs in Node.js 10</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>