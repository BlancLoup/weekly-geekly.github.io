<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Plugin system on ASP.NET. Idea development</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, dear readers. In this article I will tell you about the development of a plug-in system for projects written in ASP.NET MVC. In the previous...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Plugin system on ASP.NET. Idea development</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/073/410/156/073410156f5d4f58a7e9c06bac8fdc22.png"></div><br>  Good day, dear readers.  In this article I will tell you about the development of a plug-in system for projects written in ASP.NET MVC.  <a href="https://habrahabr.ru/post/202776/">In the previous article</a> I described the basics of creating a system that allows you to divide its parts into separate plugins. <br><br>  Writing a continuation pushed me to numerous questions that I get from readers.  Continued under the cut. <br><a name="habracut"></a><br><h3>  Introduction </h3><br>  I received a large number of questions on the described system from users of the habr.  It is very pleasant that many people found my article interesting and useful.  Most often I am asked about the further development of the system.  Due to some changes in my life, I had to move a bit away from this topic.  But given the interest in the topic, today I will try to share with you my experience of implementation and the problems that I encountered while working with the system. <br><br>  Like the previous article, this one is written for newbies who may find it difficult to understand all the subtleties.  I will describe everything as simple as possible (in some places, experienced programmers may begin to shower me with tomatoes for simplifications), so I apologize to those who are particularly sensitive to the reader's account for forgiveness. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Problems and limitations in the first version </h3><br>  The system I described earlier has certain advantages when working on large projects.  But, as with everything, it also has its drawbacks.  During the implementation of the system in work projects, I encountered several unpleasant moments: <br><br><ol><li>  Compiled plug-in files are blocked after downloading, which does not allow updates from the "on the fly". </li><li>  It is necessary to constantly keep track of the plug-in versions in the folder so that the old versions are not loaded. </li><li>  The need to connect third-party libraries to the root project to ensure the work of plug-ins. </li></ol><br>  This is not a complete list of problems that I encountered when working.  But these problems are basic and because of them the development can turn into a very unpleasant act (I shed so much pain because of them and shed tears of blood). <br><br>  The list of problems is determined, we will solve them. <br><br><h3>  Blocking plugins </h3><br>  In the first version of the system there is a very big problem - blocking plug-in files.  And this problem arises very acutely if the plugin is connected to a ‚Äúcombat‚Äù project, the stopping of which is extremely undesirable.  To update plugins, it was necessary to somehow stop the site and download updated versions of the system components. <br><br>  This problem results from one line of code: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> currentAssambly = AppDomain.CurrentDomain.Load(assembly);</code> </pre> <br>  Let me explain what happens here, if there is no experience with application domains.  First, <a href="https://msdn.microsoft.com/ru-ru/library/system.appdomain(v%3Dvs.110).aspx">let's look at MSDN</a> for the definition of the application domain class. <br><blockquote>  Represents an application domain, which is the isolated environment in which applications run. </blockquote><br>  For simpler understanding, imagine that a domain is a separate process in the system in which the application runs.  Thus, from the line of code above, we can understand that the plug-in file is ‚Äúloaded‚Äù into the process of the main site.  From this it follows that the file will be blocked as long as the application domain exists (or the site is running). <br><br>  To solve the blocking problem, there are several generally accepted solutions: <br><br><ol><li>  Upload the plugin file to your own domain. </li><li>  Call the overloaded .Load (byte []) method for the domain.  This method allows you to connect the assembly of a copy of its contents from the byte array. </li><li>  Enable shadow copy for the application domain and load plugins with the static Assembly.Load () method </li></ol><br>  The first method is bad in that it generates separate processes for plugins and isolates (in fact, if the domain is correctly configured, this is solved, but it requires writing a large amount of additional code) the downloadable plugin from the main site and its libraries.  So we will not use it. <br><br>  The second method does not suit us, since in this case, as well as in the first, the plugin is isolated from the libraries.  And MSDN itself says that the .Load method (byte []) is auxiliary and is used only if there is no possibility to call the static Assembly.Load () method.  In our case, nothing prevents us from using the static method. <br><br>  But the third way we will adopt.  It requires a minimum amount of code and is simple to be embedded into a plugin manager already written. <br><br><div class="spoiler">  <b class="spoiler_title">This code will be added.</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> cachePath = <span class="hljs-string"><span class="hljs-string">@"C:\Temp"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!System.IO.Directory.Exists(cachePath)) System.IO.Directory.CreateDirectory(cachePath, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> System.Security.AccessControl.DirectorySecurity()); AppDomain.CurrentDomain.SetCachePath(cachePath); <span class="hljs-comment"><span class="hljs-comment">//Set shadowcopy to prevent locking plugins AppDomain.CurrentDomain.SetShadowCopyPath(AppDomain.CurrentDomain.BaseDirectory); AppDomain.CurrentDomain.SetShadowCopyFiles();</span></span></code> </pre><br></div></div><br>  I will explain a little.  When using Shadow Copy, the application domain before loading the plug-in (or another connected library) makes a copy of it into the specified folder and works with this copy, making it possible to manipulate the source file. <br><br>  In the above code, we specified the path to the folder where copies of the loaded plugins will be stored.  Do not forget that the folder must be available for writing.  Otherwise, we will get an exception at the start. <br><br>  After the application is loaded into the domain of the plugin, it can no longer be removed or replaced.  Thus, even though the plug-in files are available for rewriting on the fly, there is no need to restart. <br><br><h3>  Plugin version tracking </h3><br>  This problem may arise only from a limited number of developers (I do not exclude that this circle is limited to me alone), but earlier I could mistakenly upload the updated version of the plugin to the wrong folder or simply by changing the file name to upload two versions at once. <br><br>  The curvature of the hands and no fraud.  On the other hand, being able to store several versions of the plugin on the server at once may be useful.  For example, if in the new version there is a critical failure, and the programmer is sick.  The situation is, of course, fictional and fantastic, but you never know.  Therefore, we will add version tracking.  This is done quite simply.  Passing through all the plug-in files by reflection we get the version and add it to the list of plug-ins.  If there is already such a plugin in the list, perform a version comparison.  If the found file has a higher version, replace it. <br><br><div class="spoiler">  <b class="spoiler_title">Code example</b> <div class="spoiler_text"><pre> <code class="cs hljs">... IList&lt;System.Reflection.AssemblyName&gt; assemblies = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;AssemblyName&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dll <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> libs) { ... <span class="hljs-comment"><span class="hljs-comment">//     if (!assemblies.Any(o =&gt; o.Name == dll.Name)) assemblies.Add(dll); //Replace assembly with higher version //  ,       else if (assemblies.Any(o =&gt; o.Name == dll.Name &amp;&amp; o.Version &lt; dll.Version)) { assemblies.Remove(assemblies.FirstOrDefault(o =&gt; o.Name == dll.Name)); assemblies.Add(dll); } ...</span></span></code> </pre><br></div></div><br><h3>  Connection of third-party libraries </h3><br>  This problem caused me the most pain and suffering.  How many times have I come across a situation where I don‚Äôt see a new plugin in the system.  And only debag showed an error loading the connected library.  Yes, and litter the base project is not comme il faut.  Therefore, it was decided to create a kind of library repository in which the connected libraries would be added.  But there is one nuance that is worth paying close attention to here.  If you update the library version in one of the plug-ins, and the other version has the old version, we will get an error.  But this is a matter of attentiveness.  After a couple of updates, this feature is postponed in the head and then the problems disappear. <br><br>  In this case, to solve the problem, we only need to add one to the line of the config (main project) the following: <br><br><pre> <code class="xml hljs"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">probing</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">privatePath</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bin;plugins;plugins/SharedLibs"</span></span></span><span class="hljs-tag"> /&gt;</span></span></code> </pre><br>  I created the SharedLibs directory.  But the name, as you know, can be anything.  Thus, we tell the main project that it should search for libraries in the places indicated in the parameter.  The rest of the dependency resolution magic will do for us .NET <br><br><h3>  Afterword </h3><br>  So, we have done the second iteration on the development of a plug-in system for ASP.NET MVC sites.  The main problems that caused difficulties in using the system have been resolved.  At this stage of the development of the idea, the system is already used in production projects and shows its viability. <br><br>  The article turned out small because it is a kind of addition to the previous one. <br>  Now I work on automatic replacement of the updated plug-ins "on the fly".  But the current implementation is very unstable and it will be indecent to post it. <br><br>  I also hope that at least a little satisfied the interest of all who wrote to me.  I am pleased to answer your questions. <br><br>  <a href="https://github.com/EkzoMan/EkzoPluginsSystem">Repository on github.com</a> <br><br>  <b>PS</b> Friends, your constructive criticism is very important.  Express your opinion in the comments. <br>  <b>PPS</b> Time is extremely short and not enough for the implementation of all ideas and ideas.  If there are enthusiasts and interested people, join the project on github.  We will develop the system together. </div><p>Source: <a href="https://habr.com/ru/post/357684/">https://habr.com/ru/post/357684/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../357674/index.html">Chrome 57 will actively suppress the work of the background tabs</a></li>
<li><a href="../357676/index.html">Improvements in Chrome and Firefox accelerated page reloading by 28-50%</a></li>
<li><a href="../357678/index.html">Memes and jokes from the CIA archives</a></li>
<li><a href="../357680/index.html">To be included in the register of domestic software, its source code will have to be submitted for evaluation at the Ministry of Communications and Mass Media</a></li>
<li><a href="../357682/index.html">Someone is trying to hack GitHub users who work under Windows</a></li>
<li><a href="../357686/index.html">Deprived of the premium for Russian citizenship, the programmer will receive a payment from Mail.ru</a></li>
<li><a href="../357688/index.html">Client-server step-by-step, from single-threaded to multi-threaded (Client-Server step by step)</a></li>
<li><a href="../357690/index.html">Getting Instagram users by city</a></li>
<li><a href="../357692/index.html">Certificate Store in LibreOffice Office Suite</a></li>
<li><a href="../357694/index.html">Haskell - knight's move</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>