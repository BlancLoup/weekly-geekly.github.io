<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Zabbix + Communigate Pro: low-level discovery and account monitoring</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Foreword 
 In my first publication, I talked about how you can configure the monitoring of the queues of the Communigate Pro mail servers (CGP) in Zab...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Zabbix + Communigate Pro: low-level discovery and account monitoring</h1><div class="post__text post__text-html js-mediator-article"><h1>  Foreword </h1><br>  In my first <a href="http://habrahabr.ru/post/221795/">publication,</a> I talked about how you can configure the monitoring of the queues of the Communigate Pro mail servers (CGP) in Zabbix.  Today I will talk about my little experience of using <a href="https://www.zabbix.com/documentation/2.0/manual/discovery/low_level_discovery">low-level discover (LLD)</a> Zabbix to monitor the number of users in domains.  I must say that the practical sense of monitoring the number of users, in my opinion, is small.  This was done more for our own joy and the ability to quickly answer the authorities the question "how many users do we have?" Without having to run through all the servers. <br><a name="habracut"></a><br><h1>  Low-level discover </h1><br>  LLD provides the ability to automatically create data items, triggers and graphics for various computer settings.  For example, Zabbix can automatically collect data about your file system or network interfaces and build data elements for monitoring based on this information. <br>  In order for LLD to be possible, we need to add a custom parameter to the Zabbix agent settings, the request of which will return to the monitoring server a list of JSON objects, each of which in the case of, for example, network interfaces, corresponds to one interface. <br><br><h1>  Task </h1><br>  It is necessary to make it possible to ‚Äúmonitor‚Äù the number of users in all domains of the CGP server + the total number of users on the server. <br>  The implementation of this task consists of the following steps: <br>  1. Script for getting the list of CGP domains for LLD. <br>  2. Script to get the number of accounts for the domain. <br>  3. Place these scripts on the server. <br>  4. Configure Zabbix agent. <br>  5. Create a template in Zabbix to monitor the number of accounts. <br>  6. Add this template to the necessary nodes in Zabbix. <br><br>  <b>Important note!</b>  Scripts that are used in this case require the user, whose name they use in their work, to have the ‚ÄúCan Modify All Domains and Accounts Settings‚Äù permission (see more <a href="http://www.communigate.com/CommuniGatePro/Security.html">here</a> ).  These are very serious rights that allow you to simply clear a domain from users.  Accordingly, everything that you do - you do at your own peril and risk. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  1. Script for getting the list of CGP domains for LLD </h2><br>  Both scripts in their work use the pearl barley library <a href="">CLI.pm</a> , which allows you to access the Communigate Pro <a href="http://www.communigate.com/CommuniGatePro/CLI.html">API</a> . <br>  For the first script, we need one simple ListDomains function, which returns a list of server domains. <br>  An important feature of this script is the need to return the response in JSON-format.  I did not want to install a separate JSON library for the pearl (JSON :: DWIW, for example), so as not to produce additional dependencies.  I decided that in this case, Perl could do well. <br>  The main features of the script are presented in its help: <br><br><pre><code class="bash hljs">discovery_cgp_domains [-h hostname] [-p port] -u username -w password discovery_cgp_domains -h|--<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> -h hostname - address of DNS name of the server (Default: localhost) -p port - port <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> connection (Default: 106) -u username - account on CGatePro with grant <span class="hljs-string"><span class="hljs-string">'Can Modify All Domains and Accounts Settings'</span></span> -w password - user password --<span class="hljs-built_in"><span class="hljs-built_in">help</span></span> - <span class="hljs-built_in"><span class="hljs-built_in">print</span></span> this <span class="hljs-built_in"><span class="hljs-built_in">help</span></span> --debug - show debug lines</code> </pre> <br>  The source code of the script can be seen <a href="https://bitbucket.org/torwald/cgp_utility">here</a> . <br>  Usage example: <br><pre> <code class="bash hljs">torwald@torwald-station:~/cgp_utility$ ./discovery_cgp_domains.pl -h cgp.server.org -u cgpmonitor -w password { <span class="hljs-string"><span class="hljs-string">"data"</span></span>:[ {<span class="hljs-string"><span class="hljs-string">"{#CGPDOMAIN}"</span></span>:<span class="hljs-string"><span class="hljs-string">"main.domain.org"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"{#CGPDOMAIN}"</span></span>:<span class="hljs-string"><span class="hljs-string">"support.domain.org"</span></span>}, {<span class="hljs-string"><span class="hljs-string">"{#CGPDOMAIN}"</span></span>:<span class="hljs-string"><span class="hljs-string">"hosting.domain.org"</span></span>} ] }</code> </pre><br>  As we can see, the answer contains a list of objects with one attribute - "#CGPDOMAIN", each of which represents one domain on the server.  The attribute name will be used later on when configuring the LLD. <br><br><h2>  2. Script to get the number of accounts for the domain. </h2><br>  In the second script we add another function - ListAccounts (domain).  As the name implies, it returns a list of domain users.  There is no separate function to get the number of users in the CGP API, so I‚Äôm just using the count of the length of the user list. <br>  In addition, the script can perform the summation of the number of all users on the server.  To do this, call it with the -d TOTAL option. <br>  All script options are also presented in his help: <br><pre> <code class="perl hljs">count_cgp_account [-h hostname] [-p port] -u username -w password [-d domain] count_cgp_account -h|--help -h hostname - address of DNS name of the server (Default: localhost) -p port - port <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> connection (Default: <span class="hljs-number"><span class="hljs-number">106</span></span>) -u username - account on CGatePro with grant <span class="hljs-string"><span class="hljs-string">'Can Modify All Domains and Accounts Settings'</span></span> -w password - user password -d domain - domain name to count accounts; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> you <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> -d TOTAL then you<span class="hljs-string"><span class="hljs-string">'ll get number of all accounts on server --help - print this help --debug - show debug lines</span></span></code> </pre><br>  The script simply displays the number of users on the server.  Work example: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#    hosting.domain.org torwald@torwald-station:~/cgp_utility$ ./count_cgp_account.pl -h cgp.server.org -u cgpmonitor -w password -d hosting.domain.org 6537 #    torwald@torwald-station:~/cgp_utility$ ./count_cgp_account.pl -h cgp.server.org -u cgpmonitor -w password -d TOTAL 6559 #    -    torwald@torwald-station:~/cgp_utility$ ./count_cgp_account.pl -h cgp.server.org -u cgpmonitor -w password 6559</span></span></code> </pre><br>  The source code is <a href="https://bitbucket.org/torwald/cgp_utility">here</a> . <br><br><h2>  3. We place scripts on the server </h2><br>  In this case, everything is quite simple: <br><ol><li>  We place the utility in / usr / local / bin (you can ‚Äúcut off‚Äù the extension) and give the zabbix agent user rights (zabbix by default) to run this utility. </li><li>  We place the CLI.pm module where it will be ‚Äúvisible‚Äù to the Perl interpreter, launched on behalf of zabbix.  I have this / usr / local / lib / perl5. </li><li>  In the CGP admin interface, we create a user (for example, cgpmon) with the ‚ÄúCan Modify All Domains and Accounts Settings‚Äù rights. </li><li>  We check connection from under the user of zabbix. </li></ol><br><br><h2>  4. Configure Zabbix Agent </h2><br>  1. Add the following settings to the agent configuration file. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># /etc/zabbix_agentd.conf # low-level discovery  Communigate UserParameter=cgp.domains.discovery,/usr/local/bin/discovery_cgp_domains -u cgpmon -w password #    UserParameter=cgp.domain.accounts.count[*],/usr/local/bin/check_cgp_queue -u cgpmon -w password -d $1</span></span></code> </pre><br><br>  More information about the syntax of working with this parameter and the "asterisk", in particular, can be found in the <a href="https://www.zabbix.com/documentation/2.2/manual/config/items/userparameters">documentation</a> . <br>  Thus, now we can get a list of domains and the number of accounts in this domain using the monitoring agent. <br><br>  2. Restart the agent for the new settings to take effect. <br><br><h2>  5. Setting up a Zabbix template </h2><br>  For the monitoring of accounts, I created a separate template - Template Communigate Domains Info. <br><br><h3>  Group of elements </h3><br>  First of all, you should create a Data Item Group in the template.  In my case, this is CGP.DomainsInfo.  This will allow all data items generated after LLD to be collected in one place. <br><br><h3>  Detection rule </h3><br>  Open the template and go to the Discovery Rules, where we create a new rule: <br><img src="https://habrastorage.org/files/dbb/28c/9bc/dbb28c9bc4744e029938afea60d98f35.png"><br>  Notice the Macro box.  In it we write the name of the attribute "{#CGPDOMAIN}".  As we remember, it is contained in all objects returned by the script to get a list of domains.  And the value of this attribute will be used by all our prototypes (data, triggers and graphs).  Often perform LLD for servers is not worth it, once a day is enough.  In my case, they could have been put on once a month. <br><br><h3>  Prototype data item </h3><br>  After these preparations, go to the Prototypes of the data elements and create a new prototype: <br><img src="https://habrastorage.org/files/5da/28f/ce1/5da28fce1e9a401f9700f5b6cbdfefb0.png"><br>  Here you should also pay attention to the use of the string "{#CGPDOMAIN}" in the Name and Key fields.  When generating new data items, this string will be replaced with the corresponding domain name.  Also, do not forget to specify the created Group of elements, otherwise we risk getting a large list of ‚Äúhomeless‚Äù data elements. <br><br>  If desired, you can register prototypes of triggers.  For example, trigger create and delete accounts. <br><h3>  Rule for total users </h3><br>  After creating all the prototypes in the template, add a rule to monitor the total number of accounts on the server: <br><img src="https://habrastorage.org/files/a2a/73a/e24/a2a73ae249e74667b1ea281af1febbee.png"><br><br><h3>  Template for hurry </h3><br>  For hurrying ready template can be found <a href="">here</a> . <br><br><h2>  6. Add nodes to the template </h2><br>  Here, in fact, nothing complicated or RTFM.  After adding we wait for the LLD to work, and we get the monitoring of the number of users. <br><br><h1>  Afterword </h1><br>  Why this monitoring is needed, I, as I said, do not know.  For now.  I hope smart people will tell me what you can do with this data. <br>  In addition, such an implementation is not safe in principle, since  we must keep the Communigate account password with good permissions in the config file.  But in principle, this can be circumvented. <br>  Almost the same information can also be obtained using the OS commands. <br>  For example, you can get a list of domains by simply scanning the Domains directory in the Communigate directory. <br>  And the number of users - recursively calculate the number of directories of the form username.macnt within the domain. <br>  But in this case, I wanted to show the general principle of how to automatically collect any information from Communigate using Zabbix.  And how to get the necessary data in different ways. </div><p>Source: <a href="https://habr.com/ru/post/243379/">https://habr.com/ru/post/243379/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../243367/index.html">The digest of interesting news and materials from the world of PHP No. 51 (October 26 - November 16, 2014)</a></li>
<li><a href="../243369/index.html">Interlight Moscow 2014 - what's new in coverage?</a></li>
<li><a href="../243371/index.html">Let's talk about the differences Mono from MS.NET</a></li>
<li><a href="../243373/index.html">Auto-positioning and autotracing of printed circuit boards</a></li>
<li><a href="../243377/index.html">We invite you to participate in Security Meet Up December 4</a></li>
<li><a href="../243381/index.html">Work in the office VS Work in coworking for a small team</a></li>
<li><a href="../243383/index.html">How to send push notifications to the Windows Universal app</a></li>
<li><a href="../243385/index.html">Processors, cores and threads. System topology</a></li>
<li><a href="../243389/index.html">What will be new on .NEXT and why it will be good</a></li>
<li><a href="../243391/index.html">Facebook's Osquery Introduction</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>