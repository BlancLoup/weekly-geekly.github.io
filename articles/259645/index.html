<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Configuring VPLS Multihoming on Juniper Routers</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="VPLS technology has long established itself as a way to combine geographically separated objects into a single L2 network. This solution is well scale...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Configuring VPLS Multihoming on Juniper Routers</h1><div class="post__text post__text-html js-mediator-article">  VPLS technology has long established itself as a way to combine geographically separated objects into a single L2 network.  This solution is well scaled compared to the classic L2 network and allows you to get rid of L2-loop problems in the network core.  However, it often becomes necessary to organize backup channels from the subscriber to the VPLS-cloud.  In such a situation there is a danger of looping in the PE-CE section.  To solve this problem, there are several approaches.  Here are some of them: <br><ul><li>  BGP-Based VPLS Multihoming </li><li>  A bunch of VPLS and STP </li><li>  MC-LAG </li></ul><br>  In this article I would like to consider the first two approaches. <br><a name="habracut"></a><br><h1>  Content </h1><br>  <a href="https://habr.com/ru/post/259645/">Transport setting</a> <br><ul><li>  <a href="https://habr.com/ru/post/259645/">Basic configuration of PE routers</a> </li><li>  <a href="https://habr.com/ru/post/259645/">Basic setup of P routers</a> </li><li>  <a href="https://habr.com/ru/post/259645/">Basic CE switch configuration</a> </li></ul><br>  <a href="https://habr.com/ru/post/259645/">BGP-Based VPLS Multihoming</a> <br><ul><li>  <a href="https://habr.com/ru/post/259645/">BGP Setup</a> </li><li>  <a href="https://habr.com/ru/post/259645/">VPLS Setup</a> </li><li>  <a href="https://habr.com/ru/post/259645/">Multihoming setting</a> </li></ul><br>  <a href="https://habr.com/ru/post/259645/">A bunch of VPLS and STP</a> <br><ul><li>  <a href="https://habr.com/ru/post/259645/">STP Setup</a> </li><li>  <a href="https://habr.com/ru/post/259645/">Configure VPLS on LDP</a> </li></ul><br>  <a href="https://habr.com/ru/post/259645/">findings</a> <br>  <a href="https://habr.com/ru/post/259645/">The materials used in writing the article</a> <br><br><h1>  Disclaimer </h1><br>  The main purpose of this article is to present a working configuration of a fairly comprehensive solution.  When writing, I did not set myself the goal to go deep into the theory and explain the subtleties of the work of those or other protocols that will be discussed.  It is understood that the reader is well acquainted with the operation of MPLS, BGP and Spanning-tree protocols. <br><br><h1><a name="transport"></a>  Transport setting </h1><br>  Below is the topology that I will use in this article. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/050/91e/917/05091e9174574f6d98bfe8357debb4eb.png"><br><br>  The network of the provider consists of PE and P routers (Juniper MX), all of them are in OSPF Area 0 and BGP AS 65412. The subscriber network is three switches (Cisco Catalyst), each of which has Vlan 10 and RPVST-version Spanning-tree protocol (VSTP in Juniper terminology). <br><br>  Before you begin setting up VPLS, you must raise the MPLS transport.  For LSP signaling, this example uses the RSVP protocol.  For brevity, I present the configurations of only two routers, the rest are easy to configure by analogy. <br><br><h5> <b><a name="pe_base"></a></b>  <b>Basic configuration of PE routers using the example of PE1</b> </h5><br><div class="spoiler">  <b class="spoiler_title">PE1 base config</b> <div class="spoiler_text"><pre><code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">system</span></span> { host-<span class="hljs-type"><span class="hljs-type">name</span></span> PE1; } interfaces { ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> { encapsulation flexible-ethernet-services; flexible-vlan-tagging; unit <span class="hljs-number"><span class="hljs-number">10</span></span> { encapsulation vlan-vpls; vlan-id <span class="hljs-number"><span class="hljs-number">10</span></span>; } } ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> { mtu <span class="hljs-number"><span class="hljs-number">2000</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> mpls; } } ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> { mtu <span class="hljs-number"><span class="hljs-number">2000</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">30</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> mpls; } } lo0 { unit <span class="hljs-number"><span class="hljs-number">0</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> <span class="hljs-type"><span class="hljs-type">inet</span></span> { address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>/<span class="hljs-number"><span class="hljs-number">32</span></span>; } } } } routing-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> { router-id <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; autonomous-<span class="hljs-keyword"><span class="hljs-keyword">system</span></span> <span class="hljs-number"><span class="hljs-number">65412</span></span>; } protocols { rsvp { interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>; } mpls { label-switched-<span class="hljs-type"><span class="hljs-type">path</span></span> PE1-PE2 { <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-cspf; } label-switched-<span class="hljs-type"><span class="hljs-type">path</span></span> PE1-PE3 { <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-cspf; } label-switched-<span class="hljs-type"><span class="hljs-type">path</span></span> PE1-PE4 { <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-cspf; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span>; interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span>; } ospf { area <span class="hljs-number"><span class="hljs-number">0.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> { interface-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> p2p; } interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> { interface-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> p2p; } interface lo0<span class="hljs-number"><span class="hljs-number">.0</span></span>; } } }</code> </pre> </div></div><br><br>  The flexible-vlan-tagging and flexible-ethernet-sevices parameters allow you to configure not only VPLS, but also other services on the physical interface, using different logical units.  If the interface is to be used only under VPLS, then encapsulation ethernet-vpls or vlan-vpls should be specified.  Read more <a href="http://www.juniper.net/documentation/en_US/junos12.1/topics/concept/vpls-security-interface-understanding.html">here</a> . <br><br><h5> <b><a name="p_base"></a></b>  <b>Basic P-router configuration using the example of P1</b> </h5><br><div class="spoiler">  <b class="spoiler_title">P1 base config</b> <div class="spoiler_text"><pre> <code class="hljs java">system { host-name P1; } interfaces { ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> { mtu <span class="hljs-number"><span class="hljs-number">2000</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { family inet { address <span class="hljs-number"><span class="hljs-number">10.0</span></span>.11.2/<span class="hljs-number"><span class="hljs-number">30</span></span>; } family mpls; } } ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1</span></span> { mtu <span class="hljs-number"><span class="hljs-number">2000</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { family inet { address <span class="hljs-number"><span class="hljs-number">10.0</span></span>.13.2/<span class="hljs-number"><span class="hljs-number">30</span></span>; } family mpls; } } ge-<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2</span></span> { mtu <span class="hljs-number"><span class="hljs-number">2000</span></span>; unit <span class="hljs-number"><span class="hljs-number">0</span></span> { family inet { address <span class="hljs-number"><span class="hljs-number">10.0</span></span>.21.1/<span class="hljs-number"><span class="hljs-number">30</span></span>; } family mpls; } } lo0 { unit <span class="hljs-number"><span class="hljs-number">0</span></span> { family inet { address <span class="hljs-number"><span class="hljs-number">10.0</span></span>.0.11/<span class="hljs-number"><span class="hljs-number">32</span></span>; } } } } routing-options { router-id <span class="hljs-number"><span class="hljs-number">10.0</span></span>.0.11; autonomous-system <span class="hljs-number"><span class="hljs-number">65412</span></span>; } protocols { rsvp { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lo0</span></span></span><span class="hljs-class">.0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/1.0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/2.0</span></span>; } mpls { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/1.0</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/2.0</span></span>; } ospf { area <span class="hljs-number"><span class="hljs-number">0.0</span></span>.0.0 { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.0 </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p2p</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/1.0 </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p2p</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/2.0 </span></span>{ <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">p2p</span></span></span></span>; } <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lo0</span></span></span><span class="hljs-class">.0</span></span>; } } }</code> </pre></div></div><br>  Check that MPLS is up and running: <br><pre> <code class="hljs pgsql">lab@PE1&gt; traceroute mpls rsvp PE1-PE2 Probe <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>: retries <span class="hljs-number"><span class="hljs-number">3</span></span>, exp <span class="hljs-number"><span class="hljs-number">7</span></span> ttl Label Protocol Address Previous Hop Probe Status <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.12</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) Egress <span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">2.0</span></span> destination <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span> lab@PE1&gt; traceroute mpls rsvp PE1-PE3 Probe <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>: retries <span class="hljs-number"><span class="hljs-number">3</span></span>, exp <span class="hljs-number"><span class="hljs-number">7</span></span> ttl Label Protocol Address Previous Hop Probe Status <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">299888</span></span> RSVP-TE <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) Success <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> RSVP-TE <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Egress <span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> destination <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span> lab@PE1&gt; traceroute mpls rsvp PE1-PE4 Probe <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>: retries <span class="hljs-number"><span class="hljs-number">3</span></span>, exp <span class="hljs-number"><span class="hljs-number">7</span></span> ttl Label Protocol Address Previous Hop Probe Status <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">299936</span></span> RSVP-TE <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) Success <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">299792</span></span> RSVP-TE <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> Success <span class="hljs-number"><span class="hljs-number">3</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> RSVP-TE <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.34</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.13</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span> Egress <span class="hljs-type"><span class="hljs-type">Path</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> via ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">1.0</span></span> destination <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.64</span></span></code> </pre><br><h5> <b><a name="ce_base"></a></b>  <b>Basic CE switch configuration</b> </h5><br><div class="spoiler">  <b class="spoiler_title">CE1 base config</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">hostname CE1 ! spanning-tree mode rapid-pvst spanning-tree extend system-id ! vlan <span class="hljs-number"><span class="hljs-number">10</span></span> ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport trunk encapsulation dot1q switchport mode trunk ! interface Vlan10 ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">10.1</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.0</span></span> no shutdown !</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">CE2 base config</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">hostname CE2 ! spanning-tree mode rapid-pvst spanning-tree extend system-id ! vlan <span class="hljs-number"><span class="hljs-number">10</span></span> ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport trunk encapsulation dot1q switchport mode trunk ! interface Vlan10 ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">10.2</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.0</span></span> no shutdown !</code> </pre></div></div><br><div class="spoiler">  <b class="spoiler_title">CE3 base config</b> <div class="spoiler_text"><pre> <code class="hljs erlang-repl">hostname CE3 ! spanning-tree mode rapid-pvst spanning-tree extend system-id ! vlan <span class="hljs-number"><span class="hljs-number">10</span></span> ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">0</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport trunk encapsulation dot1q switchport mode trunk ! interface GigabitEthernet0/<span class="hljs-number"><span class="hljs-number">1</span></span> switchport trunk allowed vlan <span class="hljs-number"><span class="hljs-number">10</span></span> switchport trunk encapsulation dot1q switchport mode trunk ! interface Vlan10 ip address <span class="hljs-number"><span class="hljs-number">192.168</span></span>.<span class="hljs-number"><span class="hljs-number">10.3</span></span> <span class="hljs-number"><span class="hljs-number">255.255</span></span>.<span class="hljs-number"><span class="hljs-number">255.0</span></span> no shutdown !</code> </pre></div></div><br><br>  Now you can go directly to the VPLS service settings. <br><br><h1><a name="bgp_multihoming"></a>  BGP-Based VPLS Multihoming </h1><br>  First of all, I would like to consider the ‚Äúclassic‚Äù, from Juniper's point of view, implementation of VPLS using BGP signaling ( <a href="https://tools.ietf.org/html/rfc4761">RFC 4761</a> ).  From the point of view of the control plane, this is not much different from the usual L3VPN - here also Route Distinguisher and Route Target are used, and l2vpn is specified as the address family. <br>  First you need to configure the BGP protocol itself.  Since iBGP requires full connectivity within the network, I used P1 and P2 as the route reflector to simplify the configuration. <br><br><h5> <b><a name="bgp"></a></b>  <b>BGP Setup</b> </h5><br>  PE routers: <br><div class="spoiler">  <b class="spoiler_title">PE BGP config</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">protocols { bgp { <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> IBGP { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">internal</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>.X; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> l2vpn { signaling; } neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span>; } } }</code> </pre><br>  where X is the number of the corresponding PE </div></div><br><br>  P1 <br><div class="spoiler">  <b class="spoiler_title">P1 BGP config</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">routing-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> { rib <span class="hljs-type"><span class="hljs-type">inet</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> { static { route <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">discard</span></span>; } } } protocols { bgp { <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> IBGP { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">internal</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.11</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> l2vpn { signaling; } <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; } } }</code> </pre></div></div><br><br>  P2 <br><div class="spoiler">  <b class="spoiler_title">P2 BGP config</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">routing-<span class="hljs-keyword"><span class="hljs-keyword">options</span></span> { rib <span class="hljs-type"><span class="hljs-type">inet</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> { static { route <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-keyword"><span class="hljs-keyword">discard</span></span>; } } } protocols { bgp { <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> IBGP { <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-type"><span class="hljs-type">internal</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">local</span></span>-address <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.22</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">family</span></span> l2vpn { signaling; } <span class="hljs-keyword"><span class="hljs-keyword">cluster</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; } } }</code> </pre></div></div><br>  It is worth noting the <b>routing-options</b> block.  When route-reflector receives a route from its client, before announcing it to other clients, it checks the availability of the next-hop in the inet.3 table.  Since during the initial configuration of MPLS on P-routers, I did not create LSP to PE-routers, this table is empty and, accordingly, the test does not work.  Routes received from RR clients are marked as hidden and are not announced further.  Of course, you can create LSPs from RRs to each PE, but this is laborious, and these LSPs will never be used to transmit traffic.  It is much easier and more elegant to create a static route to the lo0 network <br><br>  At the moment, BGP connectivity should work between all PE routers, but so far they have nothing to announce.  You can proceed to configure VPLS. <br><br><h5> <b><a name="vpls"></a></b>  <b>VPLS Setup</b> </h5><br>  PE1 <br><div class="spoiler">  <b class="spoiler_title">PE1 BGP VPLS config</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">routing</span></span>-instances { <span class="hljs-type"><span class="hljs-type">VPLS</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> vpls; interface ge-0/0/0.10; route-distinguisher 10.0.0.1:1; vrf-target target:65412:10; protocols { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vpls</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">no</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tunnel</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">services</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CE1</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> 1; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.10; } } } } }</span></span></code> </pre></div></div><br>  PE2 <br><div class="spoiler">  <b class="spoiler_title">PE2 BGP VPLS config</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">routing</span></span>-instances { <span class="hljs-type"><span class="hljs-type">VPLS</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> vpls; interface ge-0/0/0.10; route-distinguisher 10.0.0.2:1; vrf-target target:65412:10; protocols { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vpls</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">no</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tunnel</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">services</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CE2</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> 2; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.10; } } } } }</span></span></code> </pre></div></div><br>  It's all quite simple: create a routing-instance with the type of vpls, assign RD and RT, specify the interfaces in the direction of CE and the unique site-identifier. <br>  Checking: <br><pre> <code class="hljs delphi">lab@PE1&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> site: CE1 (<span class="hljs-number"><span class="hljs-number">1</span></span>) connection-site <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">2</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262146</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262145</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048576</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">1</span></span> remote site <span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br><pre> <code class="hljs delphi">lab@PE2&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> site: CE2 (<span class="hljs-number"><span class="hljs-number">2</span></span>) connection-site <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">1</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262145</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262146</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048576</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">2</span></span> remote site <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  VPLS connections have risen.  You can check the connectivity of CE1 and CE2: <br><pre> <code class="hljs pgsql">CE1&gt;ping <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>. Sending <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>-byte ICMP Echos <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, timeout <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> seconds: .!!!! Success rate <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span> percent (<span class="hljs-number"><span class="hljs-number">4</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span>), round-trip min/avg/max = <span class="hljs-number"><span class="hljs-number">10</span></span>/<span class="hljs-number"><span class="hljs-number">119</span></span>/<span class="hljs-number"><span class="hljs-number">207</span></span> ms</code> </pre><br><h5> <b><a name="multihoming"></a></b>  <b>Multihoming setting</b> </h5><br>  As can be seen from the topology, the CE3 switch is connected simultaneously with two PE routers.  Here, to avoid the occurrence of L2-loops, it is necessary to use the <b>Multihoming</b> mechanism.  Consider the settings of PE3 and PE4. <br><br>  PE3 <br><div class="spoiler">  <b class="spoiler_title">PE3 VPLS config</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">routing</span></span>-instances { <span class="hljs-type"><span class="hljs-type">VPLS</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> vpls; interface ge-0/0/0.10; route-distinguisher 10.0.0.3:1; vrf-target target:65412:10; protocols { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vpls</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">no</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tunnel</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">services</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CE3</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> 3; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">multi</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">homing</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">preference</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">primary</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.10; } } } } }</span></span></code> </pre></div></div><br>  PE4 <br><div class="spoiler">  <b class="spoiler_title">PE4 VPLS config</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">routing</span></span>-instances { <span class="hljs-type"><span class="hljs-type">VPLS</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> vpls; interface ge-0/0/0.10; route-distinguisher 10.0.0.4:1; vrf-target target:65412:10; protocols { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">vpls</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">no</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">tunnel</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">services</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">CE3</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">identifier</span></span></span><span class="hljs-class"> 3; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">multi</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">homing</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">site</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">preference</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">backup</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.10; } } } } }</span></span></code> </pre></div></div><br>  Unlike previous configurations of PE1 and PE2, two parameters are added here: <br><ul><li>  <b>multi-homing</b> - indicates to the router that it is connected to a multihomed site; </li><li>  <b>site-preference</b> - a value from 1 (primary) to 65535 (backup), announced by another PE as the BGP community. </li></ul><br>  At the same time, the same site-identifier is specified on both PEs.  Thus, PE3 and PE4 announce the same l2vpn route, which differs only in the site-preference parameter.  The route with the highest site-preference, i.e.  the route from PE3 wins and all l2vpn traffic from PE1 and PE2 starts to go through PE3.  The ge-0/0/0 interface on PE4 does not allow traffic. <br><pre> <code class="hljs delphi">lab@PE1&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> site: CE1 (<span class="hljs-number"><span class="hljs-number">1</span></span>) connection-site <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">2</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">28</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262146</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262145</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048576</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">1</span></span> remote site <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">41</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262147</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262145</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048579</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">1</span></span> remote site <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br><pre> <code class="hljs delphi">lab@PE2&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> site: CE2 (<span class="hljs-number"><span class="hljs-number">2</span></span>) connection-site <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">1</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">29</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262145</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262146</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048576</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">2</span></span> remote site <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.3</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262147</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262146</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048578</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">2</span></span> remote site <span class="hljs-number"><span class="hljs-number">3</span></span></code> </pre><br><pre> <code class="hljs delphi">lab@PE3&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> site: CE3 (<span class="hljs-number"><span class="hljs-number">3</span></span>) connection-site <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">1</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.1</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262145</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262147</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048833</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">3</span></span> remote site <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">16</span></span>:<span class="hljs-number"><span class="hljs-number">35</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.<span class="hljs-number"><span class="hljs-number">0.2</span></span>, Negotiated control-word: No Incoming <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262146</span></span>, Outgoing <span class="hljs-keyword"><span class="hljs-keyword">label</span></span>: <span class="hljs-number"><span class="hljs-number">262147</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Local</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span>: lsi.<span class="hljs-number"><span class="hljs-number">1048832</span></span>, Status: Up, Encapsulation: VPLS Description: Intf - vpls VPLS <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> site <span class="hljs-number"><span class="hljs-number">3</span></span> remote site <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> rmt RN</code> </pre><br><pre> <code class="hljs perl">lab@PE4&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS Local site: CE3 (<span class="hljs-number"><span class="hljs-number">3</span></span>) connection-site Type St Time <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> up <span class="hljs-comment"><span class="hljs-comment"># Up trans 1 rmt LN 2 rmt LN 3 rmt LN</span></span></code> </pre><br>  It should be noted that on PE4 all VPLS connections are in the LN state - local site not designated.  This suggests that PE4 does not participate in the transmission of VPLS traffic. <br>  When the PE3-CE3 link drops or PE3 loses connectivity with the rest of the network, the router stops announcing the l2vpn route, PE4 starts to pass traffic on the interface ge-0/0/0, and PE1 and PE2 begin to route traffic towards PE4.  The channel switching speed in this case depends on the BGP convergence rate. <br><br><h1><a name="stp_vpls"></a>  A bunch of VPLS and STP </h1><br>  Now to the fun part.  Consider the topology in which CE1 and CE2 are interconnected. <br><br><img src="https://habrastorage.org/files/f52/e6e/aa0/f52e6eaa05a1457885ff433dd1359d01.png"><br><br>  When using BGP-Based Multihoming in such a topology, everything will be fine until the CE1-CE2 link is broken.  PE routers do not learn about the topology change and, in the case where, for example, PE1 is the main router, traffic to CE2 will continue to go through PE1 and will be dropped. <br>  In order for the topology changes in the CE segment to be transmitted to the VPLS segment, you must configure the interaction of STP and VPLS. <br><br>  Below is a bit of high-level theory of how this should work. <br>  Consider a regular situation when all the links work. <br><br><img src="https://habrastorage.org/files/746/d5d/fa0/746d5dfa03e2453c892e00698b923606.png"><br><br><ol><li>  PE1 and PE2 are involved in both STP and VPLS domains. </li><li>  STP domain is local to CE1, CE2, PE1, PE2 and does not apply to PE3, PE4 and CE3 </li><li>  STP on PE1 and PE2 is configured so that PE1 is the root bridge, and PE2 is the backup root </li><li>  On the PE1 and PE2 ports facing the CE, root protect is configured.  Thus, when a BPDU from PE1 arrives at port PE2, this port is blocked </li><li>  On PE1 and PE2, PW (pseudowires) are raised up to each other and up to PE3 and PE4 (full connectivity), while PE2 signals its PW as standby (shown in dotted lines) because the port towards CE2 is in a locked state </li></ol><br><br>  Suppose the link CE1-CE2 is broken. <br><br><img src="https://habrastorage.org/files/63c/98d/488/63c98d4882d946a0ba63cc437099eb47.png"><br><br>  In the STP domain: <br><ol><li>  CE1 and CE2 send Topology Change Notification </li><li>  CE1 and CE2 reset MAC tables </li><li>  PE2 becomes the root bridge in its segment. </li><li>  PE1 remains root bridge </li><li>  PE2 unlocks the port in the direction of CE2, because  stops receiving BPDU from PE1 </li></ol><br>  In the VPLS domain: <br><ol><li>  PE2 puts its PW in the Up state, because the port in the direction of CE2 is no longer blocked </li><li>  PW on PE1 remain Up Up as before </li><li>  PE2 sends a signal to PE3 and PE4 to reset the MAC addresses received from PE1 </li><li>  PE3 and PE4 are beginning to use PE1 and PE2 to transmit traffic to CE1 and CE2. </li></ol><br>  When the CE1-CE2 link is restored, the TCN is sent again and the script repeats, with the difference that the PE2-CE2 link is blocked. <br><br>  We now turn to the setting.  I note right away that I was able to recreate this behavior only using the LDP protocol for VPLS signaling ( <a href="https://tools.ietf.org/html/rfc4762">RFC 4762</a> ), although this is not written anywhere in the official documentation (correct if I am mistaken). <br><br><h5><a name="stp"></a>  <b>STP Setup</b> </h5><br>  Unlike conventional switches, to set up STP on MX series routers, you need to create routing-instance type layer2-control. <br><br>  PE1 and PE3 <br><div class="spoiler">  <b class="spoiler_title">PE1 &amp; PE3 STP config</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">routing-instances { STP { instance-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> layer2-control; protocols { vstp { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> { mode <span class="hljs-type"><span class="hljs-type">point</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-<span class="hljs-type"><span class="hljs-type">point</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-root-port; } vlan <span class="hljs-number"><span class="hljs-number">10</span></span> { bridge-priority <span class="hljs-number"><span class="hljs-number">24</span></span>k; } } } } }</code> </pre></div></div><br><br>  PE2 and PE4 <br><div class="spoiler">  <b class="spoiler_title">PE2 &amp; PE4 STP config</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">routing-instances { STP { instance-<span class="hljs-keyword"><span class="hljs-keyword">type</span></span> layer2-control; protocols { vstp { interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> { mode <span class="hljs-type"><span class="hljs-type">point</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-<span class="hljs-type"><span class="hljs-type">point</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">no</span></span>-root-port; } vlan <span class="hljs-number"><span class="hljs-number">10</span></span> { bridge-priority <span class="hljs-number"><span class="hljs-number">28</span></span>k; } } } } }</code> </pre></div></div><br>  We check the work of STP <br><pre> <code class="hljs pgsql">lab@PE1&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> spanning-tree interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> routing-instance STP Spanning tree interface parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VLAN <span class="hljs-number"><span class="hljs-number">10</span></span> Interface Port ID Designated Designated Port State <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span> port ID bridge ID <span class="hljs-keyword"><span class="hljs-keyword">Cost</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">24586.00058671</span></span>c3d0 <span class="hljs-number"><span class="hljs-number">20000</span></span> FWD DESG</code> </pre><br><pre> <code class="hljs pgsql">lab@PE2&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> spanning-tree interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> routing-instance STP Spanning tree interface parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VLAN <span class="hljs-number"><span class="hljs-number">10</span></span> Interface Port ID Designated Designated Port State <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span> port ID bridge ID <span class="hljs-keyword"><span class="hljs-keyword">Cost</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">32778.500000080000</span></span> <span class="hljs-number"><span class="hljs-number">20000</span></span> BLK ALT (Root-Prev)</code> </pre><br>  STP works as it should - the port towards CE2 is blocked by root protect. <br><br><h5><a name="ldp_vpls"></a>  <b>Configure VPLS on LDP</b> </h5><br>  Unlike BGP, when configuring VPLS with LDP alarm, you must manually specify the IP addresses of all PE routers participating in the VPLS. <br>  PE1 <br><div class="spoiler">  <b class="spoiler_title">PE1 LDP VPLS config</b> <div class="spoiler_text"><pre> <code class="hljs actionscript">protocols { ldp { <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">lo0</span></span></span><span class="hljs-class">.0; } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">routing</span></span></span><span class="hljs-class">-</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">instances</span></span></span><span class="hljs-class"> </span></span>{ VPLS { instance-type vpls; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ge</span></span></span><span class="hljs-class">-0/0/0.10; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">protocols</span></span></span><span class="hljs-class"> </span></span>{ vpls { no-tunnel-services; vpls-id <span class="hljs-number"><span class="hljs-number">1</span></span>; mac-flush; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>; neighbor <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>; } } } }</code> </pre> </div></div><br>  The key parameter here is <b>mac-flush</b> .  Without it, routers will not reset the MAC address table when the topology changes. <br>  On PE2, PE3, PE4, the settings are absolutely identical except for the lines of neighbor. <br><br>  Check LDP operation <br><pre> <code class="hljs pgsql">lab@PE1&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> ldp neighbor Address Interface Label space ID Hold <span class="hljs-type"><span class="hljs-type">time</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> lo0<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">33</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span> lo0<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.3</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">44</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span> lo0<span class="hljs-number"><span class="hljs-number">.0</span></span> <span class="hljs-number"><span class="hljs-number">10.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.4</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">41</span></span></code> </pre><br>  LDP connections have risen, look what with VPLS <br><pre> <code class="hljs kotlin"><span class="hljs-symbol"><span class="hljs-symbol">lab@</span></span>PE1&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS VPLS-id: <span class="hljs-number"><span class="hljs-number">1</span></span> Neighbor Type St Time last up # Up trans <span class="hljs-number"><span class="hljs-number">10.0</span></span>.0.2(vpls-id <span class="hljs-number"><span class="hljs-number">1</span></span>) rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">32</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.0.2, Negotiated control-word: No Incoming label: <span class="hljs-number"><span class="hljs-number">262401</span></span>, Outgoing label: <span class="hljs-number"><span class="hljs-number">262401</span></span> Negotiated PW status TLV: No Local <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">lsi.1048580</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status: Up</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Encapsulation: ETHERNET Description: Intf - vpls VPLS neighbor 10.0.0.2 vpls-id 1 Flow Label Transmit: No</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Flow Label Receive: No 10.0.0.3</span></span></span></span>(vpls-id <span class="hljs-number"><span class="hljs-number">1</span></span>) rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">51</span></span>:<span class="hljs-number"><span class="hljs-number">49</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.0.3, Negotiated control-word: No Incoming label: <span class="hljs-number"><span class="hljs-number">262402</span></span>, Outgoing label: <span class="hljs-number"><span class="hljs-number">262401</span></span> Negotiated PW status TLV: No Local <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">lsi.1048581</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status: Up</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Encapsulation: ETHERNET Description: Intf - vpls VPLS neighbor 10.0.0.3 vpls-id 1 Flow Label Transmit: No</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Flow Label Receive: No 10.0.0.4</span></span></span></span>(vpls-id <span class="hljs-number"><span class="hljs-number">1</span></span>) rmt Up May <span class="hljs-number"><span class="hljs-number">30</span></span> <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">52</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> Remote PE: <span class="hljs-number"><span class="hljs-number">10.0</span></span>.0.4, Negotiated control-word: No Incoming label: <span class="hljs-number"><span class="hljs-number">262403</span></span>, Outgoing label: <span class="hljs-number"><span class="hljs-number">262401</span></span> Negotiated PW status TLV: No Local <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class">: </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">lsi.1048582</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Status: Up</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Encapsulation: ETHERNET Description: Intf - vpls VPLS neighbor 10.0.0.4 vpls-id 1 Flow Label Transmit: No</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Flow Label Receive: No</span></span></span></span></code> </pre><br><pre> <code class="hljs perl">lab@PE2&gt; show vpls connections Layer-<span class="hljs-number"><span class="hljs-number">2</span></span> VPN connections: &lt;...&gt; Instance: VPLS VPLS-id: <span class="hljs-number"><span class="hljs-number">1</span></span> Neighbor Type St Time <span class="hljs-keyword"><span class="hljs-keyword">last</span></span> up <span class="hljs-comment"><span class="hljs-comment"># Up trans 10.0.0.1(vpls-id 1) rmt ST 10.0.0.3(vpls-id 1) rmt ST 10.0.0.4(vpls-id 1) rmt ST</span></span></code> </pre><br>  Here, too, everything is in order.  On a PE2 connection in standby state. <br>  We check that CE3 can ping CE2.  Traffic must go through PE3, PE1 and CE1. <br><pre> <code class="hljs pgsql">CE3&gt;ping <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>. Sending <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>-byte ICMP Echos <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, timeout <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> seconds: !!!!! Success rate <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> percent (<span class="hljs-number"><span class="hljs-number">5</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span>), round-trip min/avg/max = <span class="hljs-number"><span class="hljs-number">12</span></span>/<span class="hljs-number"><span class="hljs-number">14</span></span>/<span class="hljs-number"><span class="hljs-number">18</span></span> ms</code> </pre><br>  We look at the table of MAC addresses on PE3 <br><pre> <code class="hljs pgsql">lab@PE3&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> vpls mac-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> MAC flags (S -static MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -<span class="hljs-keyword"><span class="hljs-keyword">Statistics</span></span> enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : VPLS Bridging <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> : __VPLS__, VLAN : NA MAC MAC Logical NH RTR address flags interface <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> ID <span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>a D lsi<span class="hljs-number"><span class="hljs-number">.1049088</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>a D ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.10</span></span></code> </pre><br>  Here 50: 00: 00: 08: 80: 0a - the MAC address of the Vlan10 interface on CE2, lsi.1049088 - PW from PE3 to PE1. <br><br>  Now break the link of CE1-CE2 and see what has changed <br><pre> <code class="hljs pgsql">lab@PE1&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> spanning-tree interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> routing-instance STP Spanning tree interface parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VLAN <span class="hljs-number"><span class="hljs-number">10</span></span> Interface Port ID Designated Designated Port State <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span> port ID bridge ID <span class="hljs-keyword"><span class="hljs-keyword">Cost</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">24586.00058671</span></span>c3d0 <span class="hljs-number"><span class="hljs-number">20000</span></span> FWD DESG</code> </pre><br><pre> <code class="hljs pgsql">lab@PE2&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> spanning-tree interface ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> routing-instance STP Spanning tree interface parameters <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> VLAN <span class="hljs-number"><span class="hljs-number">10</span></span> Interface Port ID Designated Designated Port State <span class="hljs-keyword"><span class="hljs-keyword">Role</span></span> port ID bridge ID <span class="hljs-keyword"><span class="hljs-keyword">Cost</span></span> ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">128</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-number"><span class="hljs-number">28682.0005867142</span></span>d0 <span class="hljs-number"><span class="hljs-number">20000</span></span> FWD DESG</code> </pre><br>  The PE2 interface in the direction of CE2 moved to the Forwarding state as it should. <br>  Pinging PE2 again <br><pre> <code class="hljs pgsql">CE3&gt;ping <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-keyword"><span class="hljs-keyword">escape</span></span> <span class="hljs-keyword"><span class="hljs-keyword">sequence</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">abort</span></span>. Sending <span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>-byte ICMP Echos <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">192.168</span></span><span class="hljs-number"><span class="hljs-number">.10</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span>, timeout <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> seconds: !!!!! Success rate <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">100</span></span> percent (<span class="hljs-number"><span class="hljs-number">5</span></span>/<span class="hljs-number"><span class="hljs-number">5</span></span>), round-trip min/avg/max = <span class="hljs-number"><span class="hljs-number">7</span></span>/<span class="hljs-number"><span class="hljs-number">13</span></span>/<span class="hljs-number"><span class="hljs-number">19</span></span> ms</code> </pre><br>  We look the MAC table on PE3 <br><pre> <code class="hljs pgsql">lab@PE3&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> vpls mac-<span class="hljs-keyword"><span class="hljs-keyword">table</span></span> MAC flags (S -static MAC, D -dynamic MAC, L -locally learned, C -Control MAC SE -<span class="hljs-keyword"><span class="hljs-keyword">Statistics</span></span> enabled, NM -Non configured MAC, R -Remote PE MAC) Routing instance : VPLS Bridging <span class="hljs-keyword"><span class="hljs-keyword">domain</span></span> : __VPLS__, VLAN : NA MAC MAC Logical NH RTR address flags interface <span class="hljs-keyword"><span class="hljs-keyword">Index</span></span> ID <span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>a D lsi<span class="hljs-number"><span class="hljs-number">.1049089</span></span> <span class="hljs-number"><span class="hljs-number">50</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">09</span></span>:<span class="hljs-number"><span class="hljs-number">80</span></span>:<span class="hljs-number"><span class="hljs-number">0</span></span>a D ge<span class="hljs-number"><span class="hljs-number">-0</span></span>/<span class="hljs-number"><span class="hljs-number">0</span></span>/<span class="hljs-number"><span class="hljs-number">0.10</span></span></code> </pre><br>  As you can see, MAC CE2 is now on the lsi.1049089 interface, and this is PW to PE2. <br><br><h1><a name="conclusion"></a>  findings </h1><br>  As can be seen from the article, the organization of VPLS Multihoming is not the most trivial task with its pitfalls.  Both approaches described by me to the solution of this problem have their advantages and disadvantages and are applicable only in certain situations.  The general disadvantage of VPLS Multihoming is the impossibility of simultaneously using two uplinks.  If such functionality is necessary, you should look towards the EVPN technology, which is gradually replacing VPLS. <br><br><h1><a name="references"></a>  The materials used in writing the article </h1><br><ol><li>  <a href="">Juniper Networks Warrior: A Guide to the Rise of Juniper Networks Implementations by Peter Southwick</a> </li><li>  <a href="http://www.shortestpathfirst.net/2009/12/08/implementing-provider-provisioned-vpns-using-route-reflectors/">Implementing Provider-Provisioned VPNs Using Route Reflectors</a> </li><li>  <a href="http://rtoodtoo.net/mpls-rsvp-configuration-troubleshooting/">MPLS / RSVP configuration &amp; troubleshooting</a> </li><li>  <a href="https://mellowd.co.uk/ccie/%3Fp%3D4459">VPLS on Junos Signalled via LDP or BGP</a> </li><li>  <a href="http://data.proidea.org.pl/plnog/5edycja/materialy/prezentacje/EmilGagala.pdf">Advanced vpls</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/259645/">https://habr.com/ru/post/259645/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259633/index.html">Devices with load balancing in network monitoring systems or "what is Network Packet Broker"</a></li>
<li><a href="../259635/index.html">We study the insides of the server Huawei RH5885 V3 (unboxing)</a></li>
<li><a href="../259637/index.html">Method of teaching programming: ‚Äúnote-taking‚Äù</a></li>
<li><a href="../259639/index.html">What did you want to know about the Android Animation Framework, but were afraid to ask</a></li>
<li><a href="../259641/index.html">We write chat for the local network using C ++ Builder. Server part</a></li>
<li><a href="../259647/index.html">Developed by the University of Alabama will help passive cooling systems for servers and ordinary PCs.</a></li>
<li><a href="../259649/index.html">Problems of recognition of ID-documents on mobile devices on the example of machine-readable zones</a></li>
<li><a href="../259651/index.html">SaaS, PaaS, IaaS, or your hardware: What do domestic IT companies use?</a></li>
<li><a href="../259653/index.html">Restore databases using Veeam Explorer for Microsoft SQL Server</a></li>
<li><a href="../259655/index.html">We write chat for the local network using C ++ Builder. Client part</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>