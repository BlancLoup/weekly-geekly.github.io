<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>RESTful API on Node.js + MongoDB</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As a mobile application developer, I often need backend services for storing user data, authorization, and more. Of course, you can use BaaS (Parse, B...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>RESTful API on Node.js + MongoDB</h1><div class="post__text post__text-html js-mediator-article">  As a mobile application developer, I often need backend services for storing user data, authorization, and more.  Of course, you can use BaaS (Parse, Backendless, etc ...) for such tasks.  But its solution is always more convenient and practical. <br><br>  And I nevertheless decided to study technologies completely unknown to me, which are now quite popular and positioned as easily mastered by beginners and not requiring in-depth knowledge and experience for implementing large-scale projects.  So let's check together whether a non-specialist can write his effective and correct backend. <br><br>  This article will discuss building a REST API for a mobile application on Node.js using the Express.js framework and the Mongoose.js module for working with MongoDB.  To control access, let's use OAuth 2.0 technology using OAuth2orize and Passport.js modules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I am writing from the perspective of an absolute beginner.  Glad to any feedback and amendments on the code and logic! <br><br><h5>  Content </h5><br><ol><li>  <a href="https://habr.com/ru/post/193458/">Node.js + Express.js, a simple web server</a> </li><li>  <a href="https://habr.com/ru/post/193458/">Error handling</a> </li><li>  <a href="https://habr.com/ru/post/193458/">RESTful API endpoints CRUD</a> </li><li>  <a href="https://habr.com/ru/post/193458/">MongoDB &amp; Mongoose.js</a> </li><li>  <a href="https://habr.com/ru/post/193458/">Access control - OAuth 2.0, Passport.js</a> </li></ol><br><a name="habracut"></a><br>  I work in OSX, IDE - <a href="http://www.jetbrains.com/webstorm/">JetBrains WebStorm</a> . <br><br>  Basics Node.js gathered in the <a href="http://learn.javascript.ru/nodejs-screencast">screencasts of Ilya Kantor</a> , highly recommend!  ( <a href="http://habrahabr.ru/post/193158/">And here is a post about them in Habr√©</a> ) <br><br>  The finished project at the last stage can be taken on <a href="https://github.com/ealeksandrov/NodeAPI">GitHub</a> .  To install all modules, run the npm install command in the project folder. <br><br><a name="p1"></a><h4>  1. Node.js + Express.js, a simple web server </h4><br>  Node.js has non-blocking I / O, which is cool for an API that many clients will call on.  Express.js is a developed, lightweight framework that allows you to quickly describe all the paths (API endpoints) that we will process.  You can also find many useful modules for it. <br><br>  Create a new project with a single server.js file.  Since the application will rely entirely on <a href="http://expressjs.com/">Express.js</a> , install it.  Installation of third-party modules occurs through the Node Package Manager by running the <code>npm install modulename</code> in the project folder. <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> NodeAPI npm i express</code> </pre><br><br>  Express will be installed in the node_modules folder.  Connect it to the application: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> app = express(); app.listen(<span class="hljs-number"><span class="hljs-number">1337</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Express server listening on port 1337'</span></span>); });</code> </pre><br><br>  Run the application through the IDE or console ( <code>node server.js</code> ).  This code will create a web server on localhost: 1337.  If you try to open it - it will display the message <code>Cannot GET /</code> .  This is because we have not yet specified a single route (route).  Next, create several paths and make the basic Express settings. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     var app = express(); app.use(express.favicon()); //   ,      app.use(express.logger('dev')); //        app.use(express.bodyParser()); //  ,   JSON   app.use(express.methodOverride()); //  put  delete app.use(app.router); //       app.use(express.static(path.join(__dirname, "public"))); //    ,     public/ (    index.html) app.get('/api', function (req, res) { res.send('API is running'); }); app.listen(1337, function(){ console.log('Express server listening on port 1337'); });</span></span></code> </pre><br><br>  Now localhost: 1337 / api will return our message.  localhost: 1337 will display index.html. <br><br>  Here we turn to error handling. <br><br><a name="p2"></a><h4>  2. Error handling </h4><br>  At first we will connect the convenient module for logging <a href="https://github.com/flatiron/winston">Winston</a> .  We will use it through our wrapper.  Install <code>npm i winston</code> in the project root, then create the libs / folder and log.js file there. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> winston = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'winston'</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLogger</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">module</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.filename.split(<span class="hljs-string"><span class="hljs-string">'/'</span></span>).slice(<span class="hljs-number"><span class="hljs-number">-2</span></span>).join(<span class="hljs-string"><span class="hljs-string">'/'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//    ,    return new winston.Logger({ transports : [ new winston.transports.Console({ colorize: true, level: 'debug', label: path }) ] }); } module.exports = getLogger;</span></span></code> </pre><br><br>  We created 1 transport for logs - to the console.  We can also separately sort and save messages, for example, in a database or file.  Let's connect a logger to our server.js. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> express = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'express'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> path = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'path'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     var log = require('./libs/log')(module); var app = express(); app.use(express.favicon()); //   ,      app.use(express.logger('dev')); //        app.use(express.bodyParser()); //  ,   JSON   app.use(express.methodOverride()); //  put  delete app.use(app.router); //       app.use(express.static(path.join(__dirname, "public"))); //    ,     public/ (    index.html) app.get('/api', function (req, res) { res.send('API is running'); }); app.listen(1337, function(){ log.info('Express server listening on port 1337'); });</span></span></code> </pre><br><br>  Our informational message is now beautifully separately displayed in the console.  Add error handling 404 and 500. <br><br><pre> <code class="javascript hljs">app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">)</span></span>{ res.status(<span class="hljs-number"><span class="hljs-number">404</span></span>); log.debug(<span class="hljs-string"><span class="hljs-string">'Not found URL: %s'</span></span>,req.url); res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Not found'</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }); app.use(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, req, res, next</span></span></span><span class="hljs-function">)</span></span>{ res.status(err.status || <span class="hljs-number"><span class="hljs-number">500</span></span>); log.error(<span class="hljs-string"><span class="hljs-string">'Internal error(%d): %s'</span></span>,res.statusCode,err.message); res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: err.message }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; }); app.get(<span class="hljs-string"><span class="hljs-string">'/ErrorExample'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res, next</span></span></span><span class="hljs-function">)</span></span>{ next(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span>(<span class="hljs-string"><span class="hljs-string">'Random error!'</span></span>)); });</code> </pre><br><br>  Now, if there are no paths available, Express will return our message.  If an internal application error occurs, our handler will also work; you can check this by contacting localhost: 1337 / ErrorExample. <br><br><a name="p3"></a><h4>  3. RESTful API endpoints, CRUD </h4><br>  Add paths for processing certain "articles" (articles).  On Habr√© there is an excellent <a href="http://habrahabr.ru/post/181988/">article</a> explaining how to make a convenient API correctly.  We will not fill them with logic yet, we will do it in the next step, with the connection of the database. <br><br><pre> <code class="javascript hljs">app.get(<span class="hljs-string"><span class="hljs-string">'/api/articles'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.send(<span class="hljs-string"><span class="hljs-string">'This is not implemented now'</span></span>); }); app.post(<span class="hljs-string"><span class="hljs-string">'/api/articles'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.send(<span class="hljs-string"><span class="hljs-string">'This is not implemented now'</span></span>); }); app.get(<span class="hljs-string"><span class="hljs-string">'/api/articles/:id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ res.send(<span class="hljs-string"><span class="hljs-string">'This is not implemented now'</span></span>); }); app.put(<span class="hljs-string"><span class="hljs-string">'/api/articles/:id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ res.send(<span class="hljs-string"><span class="hljs-string">'This is not implemented now'</span></span>); }); app.delete(<span class="hljs-string"><span class="hljs-string">'/api/articles/:id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ res.send(<span class="hljs-string"><span class="hljs-string">'This is not implemented now'</span></span>); });</code> </pre><br><br>  For testing post / put / delete I would recommend a great wrapper over cURL - <a href="httpie">httpie</a> .  Further I will give examples of requests using this tool. <br><br><a name="p4"></a><h4>  4. MongoDB &amp; Mongoose.js </h4><br>  Choosing a DBMS, I was again guided by the desire to learn something new.  <a href="http://www.mongodb.org/">MongoDB</a> is the most popular NoSQL document-oriented DBMS.  <a href="http://mongoosejs.com/">Mongoose.js</a> is a wrapper that allows you to create convenient and functional document schemes. <br><br>  Download and install <a href="http://www.mongodb.org/downloads">MongoDB</a> .  Install mongoose: <code>npm i mongoose</code> .  I allocated work with DB to the file libs / mongoose.js. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mongoose'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./log'</span></span>)(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); mongoose.connect(<span class="hljs-string"><span class="hljs-string">'mongodb://localhost/test1'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> db = mongoose.connection; db.on(<span class="hljs-string"><span class="hljs-string">'error'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ log.error(<span class="hljs-string"><span class="hljs-string">'connection error:'</span></span>, err.message); }); db.once(<span class="hljs-string"><span class="hljs-string">'open'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">"Connected to DB!"</span></span>); }); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Schema = mongoose.Schema; <span class="hljs-comment"><span class="hljs-comment">// Schemas var Images = new Schema({ kind: { type: String, enum: ['thumbnail', 'detail'], required: true }, url: { type: String, required: true } }); var Article = new Schema({ title: { type: String, required: true }, author: { type: String, required: true }, description: { type: String, required: true }, images: [Images], modified: { type: Date, default: Date.now } }); // validation Article.path('title').validate(function (v) { return v.length &gt; 5 &amp;&amp; v.length &lt; 70; }); var ArticleModel = mongoose.model('Article', Article); module.exports.ArticleModel = ArticleModel;</span></span></code> </pre><br><br>  In this file, a connection is made to the database, as well as object schemas are declared.  Articles will contain image objects.  A variety of complex validations can also be described here. <br><br>  At this stage, I suggest connecting the <a href="https://github.com/flatiron/nconf">nconf</a> module to store the path to the database in it.  Also in the config save the port on which the server is created.  The module is installed using the <code>npm i nconf</code> .  The wrapper is libs / config.js <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> nconf = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'nconf'</span></span>); nconf.argv() .env() .file({ <span class="hljs-attr"><span class="hljs-attr">file</span></span>: <span class="hljs-string"><span class="hljs-string">'./config.json'</span></span> }); <span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports = nconf;</code> </pre><br><br>  It follows that we need to create config.json in the root of the project. <br><br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">1337</span></span>, <span class="hljs-string"><span class="hljs-string">"mongoose"</span></span>: { <span class="hljs-string"><span class="hljs-string">"uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"mongodb://localhost/test1"</span></span> } }</code> </pre><br><br>  Changes mongoose.js (only in the header): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>); mongoose.connect(config.get(<span class="hljs-string"><span class="hljs-string">'mongoose:uri'</span></span>));</code> </pre><br><br>  Server.js changes: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/config'</span></span>); app.listen(config.get(<span class="hljs-string"><span class="hljs-string">'port'</span></span>), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ log.info(<span class="hljs-string"><span class="hljs-string">'Express server listening on port '</span></span> + config.get(<span class="hljs-string"><span class="hljs-string">'port'</span></span>)); });</code> </pre><br><br>  Now add CRUD actions to our existing paths. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/log'</span></span>)(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ArticleModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/mongoose'</span></span>).ArticleModel; app.get(<span class="hljs-string"><span class="hljs-string">'/api/articles'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ArticleModel.find(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, articles</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send(articles); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; log.error(<span class="hljs-string"><span class="hljs-string">'Internal error(%d): %s'</span></span>,res.statusCode,err.message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Server error'</span></span> }); } }); }); app.post(<span class="hljs-string"><span class="hljs-string">'/api/articles'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> article = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArticleModel({ <span class="hljs-attr"><span class="hljs-attr">title</span></span>: req.body.title, <span class="hljs-attr"><span class="hljs-attr">author</span></span>: req.body.author, <span class="hljs-attr"><span class="hljs-attr">description</span></span>: req.body.description, <span class="hljs-attr"><span class="hljs-attr">images</span></span>: req.body.images }); article.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { log.info(<span class="hljs-string"><span class="hljs-string">"article created"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>, <span class="hljs-attr"><span class="hljs-attr">article</span></span>:article }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(err); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err.name == <span class="hljs-string"><span class="hljs-string">'ValidationError'</span></span>) { res.statusCode = <span class="hljs-number"><span class="hljs-number">400</span></span>; res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Validation error'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Server error'</span></span> }); } log.error(<span class="hljs-string"><span class="hljs-string">'Internal error(%d): %s'</span></span>,res.statusCode,err.message); } }); }); app.get(<span class="hljs-string"><span class="hljs-string">'/api/articles/:id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ArticleModel.findById(req.params.id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, article</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!article) { res.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Not found'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>, <span class="hljs-attr"><span class="hljs-attr">article</span></span>:article }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; log.error(<span class="hljs-string"><span class="hljs-string">'Internal error(%d): %s'</span></span>,res.statusCode,err.message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Server error'</span></span> }); } }); }); app.put(<span class="hljs-string"><span class="hljs-string">'/api/articles/:id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ArticleModel.findById(req.params.id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, article</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!article) { res.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Not found'</span></span> }); } article.title = req.body.title; article.description = req.body.description; article.author = req.body.author; article.images = req.body.images; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> article.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { log.info(<span class="hljs-string"><span class="hljs-string">"article updated"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span>, <span class="hljs-attr"><span class="hljs-attr">article</span></span>:article }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err.name == <span class="hljs-string"><span class="hljs-string">'ValidationError'</span></span>) { res.statusCode = <span class="hljs-number"><span class="hljs-number">400</span></span>; res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Validation error'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Server error'</span></span> }); } log.error(<span class="hljs-string"><span class="hljs-string">'Internal error(%d): %s'</span></span>,res.statusCode,err.message); } }); }); }); app.delete(<span class="hljs-string"><span class="hljs-string">'/api/articles/:id'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ArticleModel.findById(req.params.id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, article</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!article) { res.statusCode = <span class="hljs-number"><span class="hljs-number">404</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Not found'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> article.remove(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!err) { log.info(<span class="hljs-string"><span class="hljs-string">"article removed"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">status</span></span>: <span class="hljs-string"><span class="hljs-string">'OK'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { res.statusCode = <span class="hljs-number"><span class="hljs-number">500</span></span>; log.error(<span class="hljs-string"><span class="hljs-string">'Internal error(%d): %s'</span></span>,res.statusCode,err.message); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res.send({ <span class="hljs-attr"><span class="hljs-attr">error</span></span>: <span class="hljs-string"><span class="hljs-string">'Server error'</span></span> }); } }); }); });</code> </pre><br><br>  Thanks to the Mongoose and the described schemes - all operations are very clear.  Now, besides node.js, you should run mongoDB with the <code>mongod</code> command.  <code>mongo</code> - utility for working with the database, the service itself - <code>mongod</code> .  Create previously in the database do not need anything. <br><br>  Sample requests using httpie: <br><br><pre> <code class="javascript hljs">http POST http:<span class="hljs-comment"><span class="hljs-comment">//localhost:1337/api/articles title=TestArticle author='John Doe' description='lorem ipsum dolar sit amet' images:='[{"kind":"thumbnail", "url":"http://habrahabr.ru/images/write-topic.png"}, {"kind":"detail", "url":"http://habrahabr.ru/images/write-topic.png"}]' http http://localhost:1337/api/articles http http://localhost:1337/api/articles/52306b6a0df1064e9d000003 http PUT http://localhost:1337/api/articles/52306b6a0df1064e9d000003 title=TestArticle2 author='John Doe' description='lorem ipsum dolar sit amet' images:='[{"kind":"thumbnail", "url":"http://habrahabr.ru/images/write-topic.png"}, {"kind":"detail", "url":"http://habrahabr.ru/images/write-topic.png"}]' http DELETE http://localhost:1337/api/articles/52306b6a0df1064e9d000003</span></span></code> </pre><br><br>  The project at this stage can take a look at <a href="https://github.com/ealeksandrov/NodeAPI/tree/e8764a97f9c70fb6eae102fda7237e745d9e99ac">GitHub</a> . <br><br><a name="p5"></a><h4>  5. Access control - OAuth 2.0, Passport.js </h4><br>  For access control, I will resort to OAuth 2. It may be redundant, but later this approach facilitates integration with other OAuth providers.  In addition, I did not find any working examples of user-password OAuth2 flow for Node.js. <br>  <a href="http://passportjs.org/">Passport.js</a> will monitor access control directly.  For the OAuth2 server, a solution from the same author, <a href="https://github.com/jaredhanson/oauth2orize">oauth2orize,</a> is <a href="https://github.com/jaredhanson/oauth2orize">useful</a> .  Users, tokens will be stored in MongoDB. <br>  First you need to install all the modules that we need: <br><ul><li>  Faker </li><li>  oauth2orize </li><li>  passport </li><li>  passport-http </li><li>  passport-http-bearer </li><li>  passport-oauth2-client-password </li></ul><br>  Then, in mongoose.js, you need to add schemas for users and tokens: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crypto = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'crypto'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// User var User = new Schema({ username: { type: String, unique: true, required: true }, hashedPassword: { type: String, required: true }, salt: { type: String, required: true }, created: { type: Date, default: Date.now } }); User.methods.encryptPassword = function(password) { return crypto.createHmac('sha1', this.salt).update(password).digest('hex'); //more secure - return crypto.pbkdf2Sync(password, this.salt, 10000, 512); }; User.virtual('userId') .get(function () { return this.id; }); User.virtual('password') .set(function(password) { this._plainPassword = password; this.salt = crypto.randomBytes(32).toString('base64'); //more secure - this.salt = crypto.randomBytes(128).toString('base64'); this.hashedPassword = this.encryptPassword(password); }) .get(function() { return this._plainPassword; }); User.methods.checkPassword = function(password) { return this.encryptPassword(password) === this.hashedPassword; }; var UserModel = mongoose.model('User', User); // Client var Client = new Schema({ name: { type: String, unique: true, required: true }, clientId: { type: String, unique: true, required: true }, clientSecret: { type: String, required: true } }); var ClientModel = mongoose.model('Client', Client); // AccessToken var AccessToken = new Schema({ userId: { type: String, required: true }, clientId: { type: String, required: true }, token: { type: String, unique: true, required: true }, created: { type: Date, default: Date.now } }); var AccessTokenModel = mongoose.model('AccessToken', AccessToken); // RefreshToken var RefreshToken = new Schema({ userId: { type: String, required: true }, clientId: { type: String, required: true }, token: { type: String, unique: true, required: true }, created: { type: Date, default: Date.now } }); var RefreshTokenModel = mongoose.model('RefreshToken', RefreshToken); module.exports.UserModel = UserModel; module.exports.ClientModel = ClientModel; module.exports.AccessTokenModel = AccessTokenModel; module.exports.RefreshTokenModel = RefreshTokenModel;</span></span></code> </pre><br><br>  The password virtual property is an example of how mongoose can incorporate convenient logic into models.  About hashes, algorithms and salt - not this article, we will not go into the details of implementation. <br><br>  So, the objects in the database: <br><ol><li>  User - a user who has the name, password hash and salt of his password. </li><li>  Client is a client application that is granted access on behalf of the user.  Have a name and secret code. </li><li>  AccessToken - a token (type bearer), issued to client applications, is limited in time. </li><li>  RefreshToken is another type of token that allows you to request a new bearer-token without re-requesting a password from the user. </li></ol><br><br>  In the config.json add the token lifetime: <br><pre> <code class="javascript hljs">{ <span class="hljs-string"><span class="hljs-string">"port"</span></span> : <span class="hljs-number"><span class="hljs-number">1337</span></span>, <span class="hljs-string"><span class="hljs-string">"security"</span></span>: { <span class="hljs-string"><span class="hljs-string">"tokenLife"</span></span> : <span class="hljs-number"><span class="hljs-number">3600</span></span> }, <span class="hljs-string"><span class="hljs-string">"mongoose"</span></span>: { <span class="hljs-string"><span class="hljs-string">"uri"</span></span>: <span class="hljs-string"><span class="hljs-string">"mongodb://localhost/testAPI"</span></span> } }</code> </pre><br><br>  Let's separate into separate modules the OAuth2 server and authorization logic.  In oauth.js, the ‚Äústrategies‚Äù of passport.js are described, we include 3 of them - 2 on OAuth2 username-password flow, 1 for token checking. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> passport = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BasicStrategy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport-http'</span></span>).BasicStrategy; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ClientPasswordStrategy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport-oauth2-client-password'</span></span>).Strategy; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> BearerStrategy = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport-http-bearer'</span></span>).Strategy; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).UserModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ClientModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).ClientModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> AccessTokenModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).AccessTokenModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RefreshTokenModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).RefreshTokenModel; passport.use(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BasicStrategy( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">username, password, done</span></span></span><span class="hljs-function">) </span></span>{ ClientModel.findOne({ <span class="hljs-attr"><span class="hljs-attr">clientId</span></span>: username }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, client</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(err); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.clientSecret != password) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, client); }); } )); passport.use(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientPasswordStrategy( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">clientId, clientSecret, done</span></span></span><span class="hljs-function">) </span></span>{ ClientModel.findOne({ <span class="hljs-attr"><span class="hljs-attr">clientId</span></span>: clientId }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, client</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(err); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!client) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (client.clientSecret != clientSecret) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, client); }); } )); passport.use(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BearerStrategy( <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">accessToken, done</span></span></span><span class="hljs-function">) </span></span>{ AccessTokenModel.findOne({ <span class="hljs-attr"><span class="hljs-attr">token</span></span>: accessToken }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, token</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(err); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!token) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.round((<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now()-token.created)/<span class="hljs-number"><span class="hljs-number">1000</span></span>) &gt; config.get(<span class="hljs-string"><span class="hljs-string">'security:tokenLife'</span></span>) ) { AccessTokenModel.remove({ <span class="hljs-attr"><span class="hljs-attr">token</span></span>: accessToken }, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(err); }); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'Token expired'</span></span> }); } UserModel.findById(token.userId, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(err); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!user) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-literal"><span class="hljs-literal">false</span></span>, { <span class="hljs-attr"><span class="hljs-attr">message</span></span>: <span class="hljs-string"><span class="hljs-string">'Unknown user'</span></span> }); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> info = { <span class="hljs-attr"><span class="hljs-attr">scope</span></span>: <span class="hljs-string"><span class="hljs-string">'*'</span></span> } done(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, user, info); }); }); } ));</code> </pre><br><br>  For the issuance and update of the token is responsible oauth2.js.  One exchange-strategy is to receive a token via username-password flow, another one is to exchange a refresh_token. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oauth2orize = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'oauth2orize'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> passport = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'passport'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> crypto = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'crypto'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> config = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./config'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).UserModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ClientModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).ClientModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> AccessTokenModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).AccessTokenModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RefreshTokenModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./mongoose'</span></span>).RefreshTokenModel; <span class="hljs-comment"><span class="hljs-comment">// create OAuth 2.0 server var server = oauth2orize.createServer(); // Exchange username &amp; password for access token. server.exchange(oauth2orize.exchange.password(function(client, username, password, scope, done) { UserModel.findOne({ username: username }, function(err, user) { if (err) { return done(err); } if (!user) { return done(null, false); } if (!user.checkPassword(password)) { return done(null, false); } RefreshTokenModel.remove({ userId: user.userId, clientId: client.clientId }, function (err) { if (err) return done(err); }); AccessTokenModel.remove({ userId: user.userId, clientId: client.clientId }, function (err) { if (err) return done(err); }); var tokenValue = crypto.randomBytes(32).toString('base64'); var refreshTokenValue = crypto.randomBytes(32).toString('base64'); var token = new AccessTokenModel({ token: tokenValue, clientId: client.clientId, userId: user.userId }); var refreshToken = new RefreshTokenModel({ token: refreshTokenValue, clientId: client.clientId, userId: user.userId }); refreshToken.save(function (err) { if (err) { return done(err); } }); var info = { scope: '*' } token.save(function (err, token) { if (err) { return done(err); } done(null, tokenValue, refreshTokenValue, { 'expires_in': config.get('security:tokenLife') }); }); }); })); // Exchange refreshToken for access token. server.exchange(oauth2orize.exchange.refreshToken(function(client, refreshToken, scope, done) { RefreshTokenModel.findOne({ token: refreshToken }, function(err, token) { if (err) { return done(err); } if (!token) { return done(null, false); } if (!token) { return done(null, false); } UserModel.findById(token.userId, function(err, user) { if (err) { return done(err); } if (!user) { return done(null, false); } RefreshTokenModel.remove({ userId: user.userId, clientId: client.clientId }, function (err) { if (err) return done(err); }); AccessTokenModel.remove({ userId: user.userId, clientId: client.clientId }, function (err) { if (err) return done(err); }); var tokenValue = crypto.randomBytes(32).toString('base64'); var refreshTokenValue = crypto.randomBytes(32).toString('base64'); var token = new AccessTokenModel({ token: tokenValue, clientId: client.clientId, userId: user.userId }); var refreshToken = new RefreshTokenModel({ token: refreshTokenValue, clientId: client.clientId, userId: user.userId }); refreshToken.save(function (err) { if (err) { return done(err); } }); var info = { scope: '*' } token.save(function (err, token) { if (err) { return done(err); } done(null, tokenValue, refreshTokenValue, { 'expires_in': config.get('security:tokenLife') }); }); }); }); })); // token endpoint exports.token = [ passport.authenticate(['basic', 'oauth2-client-password'], { session: false }), server.token(), server.errorHandler() ]</span></span></code> </pre><br><br>  To connect these modules, add to server.js: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> oauth2 = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/oauth2'</span></span>); app.use(passport.initialize()); <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/auth'</span></span>); app.post(<span class="hljs-string"><span class="hljs-string">'/oauth/token'</span></span>, oauth2.token); app.get(<span class="hljs-string"><span class="hljs-string">'/api/userInfo'</span></span>, passport.authenticate(<span class="hljs-string"><span class="hljs-string">'bearer'</span></span>, { <span class="hljs-attr"><span class="hljs-attr">session</span></span>: <span class="hljs-literal"><span class="hljs-literal">false</span></span> }), <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">req, res</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// req.authInfo is set using the `info` argument supplied by // `BearerStrategy`. It is typically used to indicate scope of the token, // and used in access control checks. For illustrative purposes, this // example simply returns the scope in the response. res.json({ user_id: req.user.userId, name: req.user.username, scope: req.authInfo.scope }) } );</span></span></code> </pre><br><br>  For example, the protection is on the address localhost: 1337 / api / userInfo. <br><br>  To check the operation of the authorization mechanism, you must create a user and a client in the database.  I will give the application on Node.js, which will create the necessary objects and remove unnecessary from the collections.  It helps to quickly clear the database of tokens and users when testing, I think one launch will be enough :) <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> log = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/log'</span></span>)(<span class="hljs-built_in"><span class="hljs-built_in">module</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mongoose = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/mongoose'</span></span>).mongoose; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> UserModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/mongoose'</span></span>).UserModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> ClientModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/mongoose'</span></span>).ClientModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> AccessTokenModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/mongoose'</span></span>).AccessTokenModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> RefreshTokenModel = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./libs/mongoose'</span></span>).RefreshTokenModel; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> faker = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'Faker'</span></span>); UserModel.remove({}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserModel({ <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">"andrey"</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">"simplepassword"</span></span> }); user.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> log.error(err); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> log.info(<span class="hljs-string"><span class="hljs-string">"New user - %s:%s"</span></span>,user.username,user.password); }); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;<span class="hljs-number"><span class="hljs-number">4</span></span>; i++) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> user = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UserModel({ <span class="hljs-attr"><span class="hljs-attr">username</span></span>: faker.random.first_name().toLowerCase(), <span class="hljs-attr"><span class="hljs-attr">password</span></span>: faker.Lorem.words(<span class="hljs-number"><span class="hljs-number">1</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] }); user.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, user</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> log.error(err); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> log.info(<span class="hljs-string"><span class="hljs-string">"New user - %s:%s"</span></span>,user.username,user.password); }); } }); ClientModel.remove({}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClientModel({ <span class="hljs-attr"><span class="hljs-attr">name</span></span>: <span class="hljs-string"><span class="hljs-string">"OurService iOS client v1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">clientId</span></span>: <span class="hljs-string"><span class="hljs-string">"mobileV1"</span></span>, <span class="hljs-attr"><span class="hljs-attr">clientSecret</span></span>:<span class="hljs-string"><span class="hljs-string">"abc123456"</span></span> }); client.save(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err, client</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> log.error(err); <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> log.info(<span class="hljs-string"><span class="hljs-string">"New client - %s:%s"</span></span>,client.clientId,client.clientSecret); }); }); AccessTokenModel.remove({}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> log.error(err); }); RefreshTokenModel.remove({}, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">err</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (err) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> log.error(err); }); setTimeout(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ mongoose.disconnect(); }, <span class="hljs-number"><span class="hljs-number">3000</span></span>);</code> </pre><br><br>  If you created the data with a script, the following commands for authorization will also work for you.  Let me remind you that I use <a href="httpie">httpie</a> . <br><br><pre> <code class="bash hljs">http POST http://localhost:1337/oauth/token grant_type=password client_id=mobileV1 client_secret=abc123456 username=andrey password=simplepassword http POST http://localhost:1337/oauth/token grant_type=refresh_token client_id=mobileV1 client_secret=abc123456 refresh_token=TOKEN http http://localhost:1337/api/userinfo Authorization:<span class="hljs-string"><span class="hljs-string">'Bearer TOKEN'</span></span></code> </pre><br><br>  <b>Attention!</b>  On a production server, be sure to use HTTPS, which is implied by the OAuth 2 specification. And do not forget about the correct password hashing.  Implementing https in this example is easy, there are many examples on the net. <br>  Let me remind you that all the code is contained in the repository on <a href="https://github.com/ealeksandrov/NodeAPI">GitHub</a> . <br>  To work, you need to run <code>npm install</code> in the directory, run <code>mongod</code> , <code>node dataGen.js</code> (wait for execution), and then <code>node server.js</code> . <br><br>  If some part of the article is worth describing in more detail, please indicate this in the comments.  The material will be processed and supplemented as feedback is received. <br><br>  To summarize, I want to say that node.js is a cool, convenient server solution.  Document-based MongoDB is a very unusual, but undoubtedly useful tool, most of which I haven't used yet.  Around Node.js is a very large community where there are a lot of open-source developments.  For example, the creator of oauth2orize and passport.js - Jared Hanson has made great projects that make it as easy as possible to implement properly protected systems. </div><p>Source: <a href="https://habr.com/ru/post/193458/">https://habr.com/ru/post/193458/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../193442/index.html">Live Broadcast Windows Camp</a></li>
<li><a href="../193450/index.html">Electromagnetic radiation that blocks the operation of engines</a></li>
<li><a href="../193452/index.html">Load testing in Skyforge, or Bots - server orderlies. Part 2</a></li>
<li><a href="../193454/index.html">IBM Introduces NeXtScale System - High-Performance Computing Platform for Data Centers</a></li>
<li><a href="../193456/index.html">Implementing a mutex outside the OS using the example of an AVR microcontroller and a TWI bus</a></li>
<li><a href="../19346/index.html">A little bit about the hobby of old iron</a></li>
<li><a href="../193460/index.html">Automate monitoring: low-level detection</a></li>
<li><a href="../193464/index.html">Yealink and 3CX become strategic partners</a></li>
<li><a href="../193466/index.html">Competition within the team kills the team spirit</a></li>
<li><a href="../193468/index.html">Localization trends and localization of trends: a summary of Localization World-2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>