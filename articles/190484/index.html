<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a browser igrulki in the social network from and to</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! I want to tell my story of creating a browser-based online game for social. networks. In the article I will try to consider everything from the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a browser igrulki in the social network from and to</h1><div class="post__text post__text-html js-mediator-article">  Hello!  I want to tell my story of creating a browser-based online game for social.  networks.  In the article I will try to consider everything from the beginning to the end, from the idea to the 10th restart.  The article was published not small, but detailed.  Perhaps some of the features applied in the game will seem obvious to someone.  So, anyone interested in learning about the horror that I went through, I ask for a cat!  (I wonder maybe the most novice igrodelyam and holivarschikam) <br><a name="habracut"></a><br><h4>  Introduction.  (You can skip this) </h4><br>  The path to the idea of ‚Äã‚Äãthe game was very long.  It all started with the fact that I knew jQuery.  Yes.  It was a golden time.  With the help of blunt animations, I did all sorts of fuck like emoticon movement across the field to the place of the mouse click.  When this level reached perfection, I wanted to add onlineness to this ‚Äúgame‚Äù.  And then it started ... <br><br>  The first thing that occurred to me was sending a request to the server every N seconds if the second player had done something.  Everything was done in PHP + MySQL.  Information about the place and time of the click was saved in the database and issued to players upon request.  Source miracle unfortunately not left, well, okay. <br><br>  The next vital step was performance.  The option with constant requests to the server naturally disappeared, and there was a need to look for other solutions.  I went through all sorts of Comets, flash drives ... but I couldn't even get all of this on the server.  And then suddenly I stumbled upon NodeJS.  It was something.  I was happy as a child doing the first tests, and only when I learned about Socket.io .... <a href="http://socket.io/">Well, you understand me</a> =) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It was all for me how to discover America, I didn‚Äôt sleep at night and wrote code, did tests ... when I noticed that my game was stuck in place.  A little thought, I began to make my first creation, similar to the game.  Again ... the customer message was on jQuery, the same animation, the same movement of emoticons.  Everything was gradually improved, a chat was added, several types of weapons (aha, emoticons were shooting).  The large map was a regular 10k x 10k pixel image.  Then I learned about Chrome Dev Tools.  Seeing how my brainchild eats my memory, I began again to delve into the depths of Google.  Learned that HTML5 already exists with its Canvas.  This was another reason to rejoice.  Again, sleepless nights of studying API (the word of the night is in the plural, because I generally knew JS extremely superficially, and now it's time to work on them closely).  After a couple of weeks, my ‚Äúgame‚Äù was rewritten into pure JS and HTML5.  At that time I was working in my college as a lab technician, and we sat down and tested my crutches with the same lab technicians.  A couple of days later, it became boring, and I began to dive into 3D ... <br><br>  Oh, this is 3D.  Stupid attempts to create 3D shapes in the browser basically did not lead to anything.  That is, they turned out to create on the page, even move between the red balls and gray krakozyabram, blended in a blender.  Surprisingly, while writing this article, I discovered that on a server this night called ‚Äúwife in the night shift‚Äù is still alive.  <a href="http://axe-ps.ru/3d">Link for especially curious.</a>  - You can even rotate the mouse and move the arrows.  TreeJS seemed to me very difficult and again Google came to my rescue.  There I learned about Unity3D.  In general, I have a stupid habit of doing stupid performance tests.  When I first started the unit, I was surprised at how conveniently the interface was made, and even without having the skills to work with such programs, I managed to make a map with mountains, paths and waterfalls.  I didn‚Äôt grow together with waterfalls, I accidentally added several tens of thousands to the map, and when rendering, the video card refused.  Well, what to do ... did an excellent laying of bricks. <br><br><h4>  Crucial moment. </h4><br>  I think many people know the story of the success of the game "Racing on the keyboard"?  (I did not find the link to the article, I will be happy to insert it).  When I found out how much the developers of SUCCESSFUL applications on social networks earn, I probably, like others, wanted to create my own game for a social network.  And I began active work on this.  I learned that a unit project can also be put together under the web ... The idea of ‚Äã‚Äãthe game was relatively simple - it had its own line with something and courtesans.  To have something to suffer in a unit, I even started negotiations with a designer who can draw mobs, maps, etc. for playing games.  Of course, nobody wanted to work on bare enthusiasm, and I decided to do something ‚Äúsimpler‚Äù to fill my pocket for the initial budget of a more serious project.  This ‚Äúsimpler‚Äù was the idea to make 2d online races on HTML5, only not the online one, in which you click on the opponent, you wait, and ‚Äúyou won! life for myself, I decided to make races for racing =) Well, and what ... no turns, less physics ... In short, after half a year everything ended with a test version with 20 cars.  I already exhausted to look for all the parameters for machines, t. To.  tried to make realistic (even 2d) physics, needed parameters such as aerodynamic drag, torque plots and other characteristics that, as it turned out, were not so easy to find. <br><br>  But these races were something for me to teach.  I studied all the new technologies, invented bicycles from crutches, ran into my own rake several times ... But over the course of this half of the year some ideal client-server skeleton for me has been formed.  Specifically, on the canvas client, on the nodejs + socket.io server.  Trite, crooked, but it worked.  And if it works, then don‚Äôt touch it =) Basically, I experienced problems due to ignorance of the language, and even the simplest functions that are already embedded in JS I cycled myself, not knowing about their existence.  Something like this looked like a small piece of the server part: <br><br><pre><code class="javascript hljs">io = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>); mysql = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'mysql'</span></span>); players = []; <span class="hljs-comment"><span class="hljs-comment">//,  .   - . races = []; // ,    -   4  // -  - ... io.sockets.on('connection', function(socket){ socket.on('message', function(msg){ msg = JSON.pars(msg); switch(msg.type){ case 1: ... break; ... } } }</span></span></code> </pre> <br>  (Who is no longer interested in reading but would like to see - the link at the end of the article) <br>  Inside swith, there was a code that sent a specific response to the user.  By the way that in case you can write not only numbers, I didn‚Äôt know, for this I had to keep in mind all types of messages, of which there were as many as 50. Among them are authorization, the beginning of the race, and the end of the race, and chat, and various different in-game events.  I knew that for socket, instead of using switch constructions, you can immediately write socket.on ('message type' ...), but this approach creates an extra portion of spaghetti, and not very big convenience of writing code, so the server part of the final game is written directly exactly.  That is, such a skeleton, later, I still found out that in a case, you can write whatever you want =).  On the client, the construction is one-on-one, only there is no array of all players, there is only an object of itself (and global), and a huge set of functions (also global) that take on the role of incoming message handlers. <br><br>  Gradually, I learned the features of JS, NodeJS and socket.io.  I remember the first successfully failed test of the maximum number of connections.  At 10k + - 250 connections, socket.io lost responsiveness and did not accept new connections.  After a long fuss <a href="http://ru.fractalizer.ru/frpost_197/%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0-%25D1%258F%25D0%25B4%25D1%2580%25D0%25B0-linux-%25D0%25B4%25D0%25BB%25D1%258F-%25D0%25BF%25D0%25BE%25D0%25B4%25D0%25B4%25D0%25B5%25D1%2580%25D0%25B6%25D0%25BA%25D0%25B8-%25D0%25B1%25D0%25BE%25D0%25BB%25D1%258C%25D1%2588%25D0%25BE/">, this</a> article helped.  There everything is described in detail so I will not repeat. <br><br>  As I said, with the races I butted half a year, and I didn‚Äôt have enough strength for more.  About the idea of ‚Äã‚Äãa 3d game, I had already completely forgotten, and all that was left of it was a drawing paper on a room door with a database structure.  And so, since the races were too difficult for me, I decided to simplify my task even more, and to make airplanes flying in the air and just shooting at each other. <br><br><h4>  My game, my game ... </h4><br><h5>  First version </h5><br><h6>  Logic and govnokod </h6><br>  And so, one fine free day, I sat down at work, loaded the interns and began to experiment again with the canvas.  The first experiments were unpretentious - to make the square move at least directly (after driving the box in races, I already forgot how I did it and decided to rewrite everything anew with new knowledge).  Of course, he began to move after 10 minutes ... then decided to add key management - up and down.  And then everything stalled.  This canvas with my own matrixes and translates, be they wrong ... there were so many calculations that I could no longer navigate the code.  Although the whole "physics" was based on the geometry of the 5th grade, or rather the geometry of various triangles =) He hated trigonometry in school, which he later regretted.  The calculations of the triangles were too large and heavy, but after learning the basics of trigonometry, I realized what a fool he was.  But even with trigonometry <s>calculations, the</s> straight-handedness left much to be desired.  This is how the working code of the first version of the game on the canvas looks like with the key pressed down: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(player[pid].key.up == <span class="hljs-literal"><span class="hljs-literal">false</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(player[pid].key.down == <span class="hljs-literal"><span class="hljs-literal">true</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(player[pid].alfa &gt;= <span class="hljs-number"><span class="hljs-number">-359</span></span>){ player[pid].alfa -= (<span class="hljs-number"><span class="hljs-number">1.4</span></span>*(time/player[pid].speed)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ player[pid].alfa = <span class="hljs-number"><span class="hljs-number">0</span></span>; } player[pid].x += k2*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(k1*player[pid].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span>*(time/player[pid].speed); player[pid].y += k2*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(k1*player[pid].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span>*(time/player[pid].speed); player[pid].x = rezak(pid,real,player,k1,k2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pid == <span class="hljs-string"><span class="hljs-string">'green'</span></span>){ real[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].x = player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].x + k2*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); real[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].y = player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].y-player[pid].rad + k2*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pid == <span class="hljs-string"><span class="hljs-string">'red'</span></span>){ real[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].x = player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].x + k2*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); real[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].y = player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].y-player[pid].rad + k1*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); } } player[pid].x += k2*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(k1*player[pid].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span>*(time/player[pid].speed); player[pid].y += k2*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(k1*player[pid].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)*<span class="hljs-number"><span class="hljs-number">2</span></span>*(time/player[pid].speed); player[pid].x = rezak(pid,real,player,k1,k2); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pid == <span class="hljs-string"><span class="hljs-string">'green'</span></span>){ real[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].x = player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].x + k2*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); real[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].y = player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].y-player[pid].rad + k2*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(player[<span class="hljs-string"><span class="hljs-string">'green'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(pid == <span class="hljs-string"><span class="hljs-string">'red'</span></span>){ real[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].x = player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].x + k2*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); real[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].y = player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].y-player[pid].rad + k1*(player[pid].rad * <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(player[<span class="hljs-string"><span class="hljs-string">'red'</span></span>].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>)); } ctx.save(); ctx.translate(player[pid].x, player[pid].y-player[pid].rad); ctx.rotate(k1*player[pid].alfa*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>); ctx.drawImage(player[pid].img, <span class="hljs-number"><span class="hljs-number">-22</span></span>,+(player[pid].rad<span class="hljs-number"><span class="hljs-number">-8</span></span>)); ctx.restore(); }</code> </pre><br><br>  I myself am now writing an article and proving to my cat that this is not my code.  I‚Äôm not saying that there are constants in the code that are chosen by the method of scientific typing ... I consider the rest of the code to be dangerous to the readers.  All the problems were due to the fact that each time I had to do a translate canvas, because of which it was very difficult for me to catch the REAL coordinates (those that the user sees) of the plane, and real coordinates are needed, at least, to calculate the amount of aircraft hit (in the code for example, coordinates for the canvas are player [pid] .x, player [pid] .y, and real coordinates are already real ['red']. x and real ['red']. y) - don't ask about the choice of variable names, now I open the code, and there ...: (a clean copy-paste of my code, the comments were just like that, I even remembered that moment, because  no not understand how it works requestAnimationFrame) <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">animate</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id,pid,appid,imagesD,player,real,warID</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">// #$ time = new Date() - time2; requestAnimationFrame( function(){animate(id,pid,appid,imagesD,player,real,warID);},ctx); drive(id,pid,appid,imagesD,player,real,warID); //   time2 = new Date(); }</span></span></code> </pre><br><br>  By the way, even then all the game logic was transferred to the server.  In particular, the purchase of game items, ammo and life during the battle.  All counted the server.  The calculations are minimal, and the tests showed that the home celeron 2.4 GHz completely holds 10k DIFFERENT messages per second, which then was still far from reality and was fine with me.  So the beginning of protection from kulhatzkerov was laid at this time. <br><h6>  Govnodizayn </h6><br>  All the while developing, design was easy.  I said goodbye to this idiotic idea only after version 3 of the release.  More on this later ... In general, to make it clear, I post the first version of the ‚Äúdesign‚Äù of the ‚Äúgame‚Äù: <br><img src="https://habrastorage.org/getpro/habr/post_images/839/551/0d9/8395510d9ae3ab9f9b08a7455c15dcb1.jpg"><br>  As you can see, contrasting colors, round corners, the lack of frames are a bit like a village.  ‚ÄúI can shave as much as I can‚Äù - so the techies will treat with understanding, and I hope the interface designers have not frightened the picture. <br><br><h5>  Session, diploma, summer ... lyrical digression </h5><br>  When summer came with their bonuses like a session, or rather state.  exams, defense of a non-initiated diploma, problems with the army - I had to forget about the game for a while, and for 2 months (June, July) I had a brain break.  And suddenly it dawned on me that somehow I earn little, and began to look for a new job.  Somehow it didn't really work out to find something acceptable ... as I opened the console on the main page of Yandex and saw ‚ÄúDo you like to look in the console?  Or maybe js can write?  <a href="">company.yandex.ru/job/vacancies/interface_dev_mail.xml</a> .  For the sake of interest, I answered the test questions and safely forgot.  After about a week, a letter came from Yandex, ‚Äúbut would you like to have an interview on Skype?‚Äù Of course I do!  Lip is not a fool =) In short, the interview, I miserably flunked.  Namely, I did not know just what this was and how to use it, the designer, new etc ... I decided that it would be nice to train myself and began to smoke JS manuals again.  And I realized how cool that is this, new, call, apply ... I learned how to use these things so to speak ... and did something.  I sat down to rewrite the game. <br><br><h4>  First start </h4><br><br><h5>  And again a little about govnodizine </h5><br>  That summer I was lucky to buy my wife an iPhone and pick up HTC on WP 7.5 for myself.  For some reason, I terribly liked the tiled interface.  It is simple and straightforward.  Really simple and straightforward.  And I wanted to start ‚Äúrewriting‚Äù the game with design.  For myself, decided that it should be simple and clear ... in short plagiarism with tiles.  In short, what happened to me has gone somewhere, so <s>you are lucky now not to cover your face with your hand in horror,</s> do not even dare to think about it.  But take my word for it, it looked much better than the previous version. <br><br><h6>  Code, code, code again </h6><br>  It was crazy for me to make these tiles, decided to show off (in front of whom?) And make each tile on a separate canvas.  Of course I did ... but, forgive me, a <s>bad word for a comma in Russian</s> , one tile occupied for me for some reason half of the entire client code. <br>  After rewriting everything, it's time to file VK api.  Here I would cross out all the text further but ... I will try to express briefly and decently: there is a lot of functionality - there is little documentation.  In the documentation, error codes are not all given, half of the parameters are not described, the result is returned in the form of nothing, then for me a meaningless <b>array of object objects</b> .  I drunk all these requests to the API 1 by day per game, for, again, using the method of scientific typing.  A matter of habit of course.  There is nothing more to say.  Guys, write the documentation for your grandmother.  Newbies are lost). <br><br><h5>  Actually, the first launch </h5><br>  The planned release date of the game was approaching, and minor problems arose that needed to be addressed.  During development, I used my home server exclusively, but it was clear that I would have to rent everything.  I did not have any money, so the ideal solution for me at that time was to rent a cloud server.  Selectel fit perfectly. <br>  XXX August is the day of the first failure of the game.  The application was approved a week after the application was submitted, but this is even good.  During this week I managed to drain almost 10 thousand on the target advertising of VK - my most useless waste of money.  10k flew in a couple of hours.  But these couple of hours turned out to be a great experience.  With the first players for each garbage NodeJS began to ache and fall, I did not know about try ... catch, and until the game got into the catalog, it was necessary to solve something.  I managed to close a lot of holes, but not all, which is why this ‚Äúrelease‚Äù failed before it began.  I had to manually restart the nodejs, in the round-the-clock mode to sit in the console so that God forbid the node lay more than a minute.  I also did not know about such a thing as bash, or rather did not want to know. <br><br><h5>  Some statistics </h5><br>  In the early days, the game was set by 6-7 thousand people, which could not help but please me (of course, there is nothing to compare it with).  So, by the way, an interesting (or maybe not) moment happened here. <br><img src="https://habrastorage.org/getpro/habr/post_images/db0/825/e99/db0825e99f8536a5568eddf90812dec8.jpg"><br>  (circled) <br>  There you can see what date, so the age of the players is not difficult to guess.  Be careful in choosing release dates. <br>  Everything, after that, I was completely desperate, the installation went on decline, there was a maximum of one and a half "pilot" online.  This is including me. <br>  The only advantage that made me continue to work is the non-sickly offers to buy the game.  On the first day there were a lot of offers about the exchange, and the prices up to 80 thousand.  On the second day I was offered up to $ 7,000, and now I regret that I did not agree. <br><h4>  Bug work </h4><br>  Shaking my brain about what was <s>put in the hair shampoo is</s> not so, I decided that it was a matter of whistles, perfections and the absence of social spam on the walls (of course, on behalf of the application).  And what do you think I did?  Not guessed.  I began to rewrite the game again.  Started again with design. <br><br>  <b>Error 1. I thought that a good designer would come out of me.</b> <br>  I decided to simplify even stronger, made huge buttons with ugly inscriptions - this is a miracle, I also do not want to show for religious reasons. <br><br>  <b>Error 2. Few whistles (weapons, body kit, as you wish)</b> <br>  There was a lot of work done (on the mistakes, of course).  Besides the fact that I added 12 new types of weapons / bonuses, I made a ‚Äúspecial effect‚Äù for each of them when they hit it - by the way, nothing looked.  At this stage, rewriting is justified.  There was a certain modularity, thanks to which I can now add even a new weapon per minute, there would be ideas.  Immediately was made super protection from kulhackinga. <br>  <b>If it used to be like this: the</b> client fires, the client checks if there is any such weapon, he (the client) checks if the rocket hit the opponent, and if it hit, then only send a message to the server and it sends a message to the opponent that got into it. <br>  <b>It became like this: the</b> client presses the key, the key code is transmitted to the server, the server looks at which weapon the key is assigned to the player, checks whether the weapon is reloaded, whether it is at all, whether it can be used on this plane (also added aircraft each has its own advantages, including which weapon you can use), and a bunch of minor conditions.  In the event that there was not a single false, the shot data was sent to both players.  If all the same was found false, then the shooter politely (in red capital letters) showed a message like "FLASHING! ....".  Actually, if it's interesting like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'shot'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() &lt; players[socket.id].per[msg.typeW]){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">''</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(players[socket.id].weapons[msg.typeW] &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ players[socket.id].weapons[msg.typeW] = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">' '</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons[players[socket.id].plane].weapons.indexOf(msg.typeW) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; weapons.weapons.indexOf(msg.typeW) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">' '</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons[players[socket.id].plane].bonuses.indexOf(msg.typeW) &lt; <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; weapons.bonuses.indexOf(msg.typeW) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">' '</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(players[socket.id].wrate != weapons[players[socket.id].plane].rate + players[socket.id].rate &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() &gt;= players[socket.id].per.P){ players[socket.id].wrate = weapons[players[socket.id].plane].rate + players[socket.id].rate; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons.weapons.indexOf(msg.typeW) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ msg.per = weapons[msg.typeW].rate*<span class="hljs-number"><span class="hljs-number">1000</span></span>/players[socket.id].wrate; players[socket.id].per[msg.typeW] = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() + msg.per; players[socket.id].weapons[msg.typeW] -= <span class="hljs-number"><span class="hljs-number">1</span></span>; players[socket.id].pot[msg.typeW] += <span class="hljs-number"><span class="hljs-number">1</span></span>; msg.hit = weapons[msg.typeW].radius; msg.speed = weapons[msg.typeW].speed; msg.val = players[socket.id].weapons[msg.typeW]; msg.side = players[socket.id].side; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons.bonuses.indexOf(msg.typeW) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ msg.per = weapons[msg.typeW].rate*<span class="hljs-number"><span class="hljs-number">1000</span></span>*players[socket.id].wdamage; players[socket.id].per[msg.typeW] = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now() + msg.per; players[socket.id].weapons[msg.typeW] -= <span class="hljs-number"><span class="hljs-number">1</span></span>; players[socket.id].pot[msg.typeW] += <span class="hljs-number"><span class="hljs-number">1</span></span>; msg.val = players[socket.id].weapons[msg.typeW]; msg.side = players[socket.id].side; <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(msg.typeW){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'I'</span></span>: players[socket.id].life += <span class="hljs-number"><span class="hljs-number">10</span></span>; msg.life = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.ceil(players[socket.id].life); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(players[socket.id].life &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>){ players[socket.id].life = <span class="hljs-number"><span class="hljs-number">100</span></span>; msg.life = <span class="hljs-number"><span class="hljs-number">100</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'J'</span></span>: players[socket.id].wsuspension += <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'L'</span></span>: players[socket.id].kamikadze = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'P'</span></span>: players[socket.id].wrate = <span class="hljs-number"><span class="hljs-number">100000</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; }; } socket.json.send(msg); io.sockets.socket(players[socket.id].oppSocket).json.send(msg); } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br><br>  A little explanation to the code.  players is an array of all players and is identified by socket.id.  Each array element is a player object that is created immediately upon entry into the game, by assigning what it returned to MySQL.  In fact, between each else if there was a sending error to the user, but I did not find this code.  weapons - is an array of parameters of weapons and bonuses. <br><br>  I made the miscalculation of the hit on the sly: the opponent calculates.  How to describe it further ... after a successful shot of 1 player, 2 player draws a rocket in her and looks to see if she has fallen into it (herself).  If it does, it sends the message to the server with the content of "what is and in what place on the screen."  The server calculates the damage, and sends both players.  At the same time, a fantastic special effect is drawn and the rocket disappears.  At the same time on the server it is checked how many things are left there, lives, etc.  - and if suddenly player 2 has less than 0 lives, then we write everything into the database, send players information about who won and who lost and everyone is happy. <br>  If interested, here is the client's hit calculation code: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; weapons_1.length; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons_1[i].draw({<span class="hljs-attr"><span class="hljs-attr">t</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].time2, <span class="hljs-attr"><span class="hljs-attr">x</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">ra</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].ra}) == <span class="hljs-string"><span class="hljs-string">'coordLimit'</span></span>){ weapons_1.splice(i,<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons_1[i].s &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.abs(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x-weapons_1[i].x) &lt; <span class="hljs-number"><span class="hljs-number">80</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.abs(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y-weapons_1[i].y) &lt; <span class="hljs-number"><span class="hljs-number">80</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> dl = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt(((avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x-weapons_1[i].x)*(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x-weapons_1[i].x))+((avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y-weapons_1[i].y)*(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y-weapons_1[i].y))); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(dl &lt; (avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].w/<span class="hljs-number"><span class="hljs-number">4</span></span>+weapons_1[i].w/<span class="hljs-number"><span class="hljs-number">4</span></span>)+weapons_1[i].hit){ sock.send($.toJSON({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'hit'</span></span>, <span class="hljs-attr"><span class="hljs-attr">typeW</span></span>: weapons_1[i].typeW, <span class="hljs-attr"><span class="hljs-attr">i</span></span>: i})); weapons_1.splice(i,<span class="hljs-number"><span class="hljs-number">1</span></span>); }; } }</code> </pre><br><br>  weapons_1 is nothing more than an array of all missiles launched by an opponent.  As you can see, in order not to load the memory, when the rocket leaves the limits of the canvas, it is removed from the array. <br><br>  The second piece is a small optimization.  I do not know how useful it is, but in order not to count each frame of the hypotenuse (in a triangle a rocket-plane), first there is a small calculation of the absolute position on the screen.  And if the rocket is too far by approximate measures, then there is no need to consider the hypotenuse. <br><br>  avatars [0] and avatars [1] are player objects.  After reading <a href="http://habrahabr.ru/company/mailru/blog/182088/">this article</a> , for some reason I decided to call it avatars, so it was. <br><br>  <i>The ‚Äúevent‚Äù of hit on the client looks like this:</i> <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'hit'</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].life = msg.life; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].life &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].life = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].life &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].life = <span class="hljs-number"><span class="hljs-number">100</span></span>; $(<span class="hljs-string"><span class="hljs-string">'#life span, #life2 span'</span></span>).html(msg.life); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(msg.damage &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: (<span class="hljs-string"><span class="hljs-string">'!'</span></span>), <span class="hljs-attr"><span class="hljs-attr">x</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">t</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>})); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: (<span class="hljs-string"><span class="hljs-string">'-'</span></span>+(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.ceil(msg.damage))), <span class="hljs-attr"><span class="hljs-attr">x</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">t</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>})); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(msg.typeW){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'C'</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].ra -= msg.damage*msg.damage*avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].koef; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'E'</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].debaff.E.per = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now(); avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].debaff.E.tper = <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>.now()+(msg.damage*<span class="hljs-number"><span class="hljs-number">500</span></span>); particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: (<span class="hljs-string"><span class="hljs-string">' !'</span></span>), <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">350</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">350</span></span>, <span class="hljs-attr"><span class="hljs-attr">t</span></span>: <span class="hljs-number"><span class="hljs-number">2000</span></span>})); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: msg.typeW, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">side</span></span>: <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-attr"><span class="hljs-attr">damage</span></span>: msg.damage})); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'pop'</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life = msg.life; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life &gt; <span class="hljs-number"><span class="hljs-number">100</span></span>) avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons_0.length &gt; msg.i){ weapons_0.splice(msg.i,<span class="hljs-number"><span class="hljs-number">1</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(msg.damage &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: (<span class="hljs-string"><span class="hljs-string">'!'</span></span>), <span class="hljs-attr"><span class="hljs-attr">x</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">t</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>})); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: (<span class="hljs-string"><span class="hljs-string">'-'</span></span>+(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.ceil(msg.damage))), <span class="hljs-attr"><span class="hljs-attr">x</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">t</span></span>: <span class="hljs-number"><span class="hljs-number">1000</span></span>})); } <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(msg.typeW){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'C'</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].ra += msg.damage*msg.damage*avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].koef; <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'E'</span></span>: particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'message'</span></span>, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: (<span class="hljs-string"><span class="hljs-string">' !   !'</span></span>), <span class="hljs-attr"><span class="hljs-attr">x</span></span>: <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: <span class="hljs-number"><span class="hljs-number">220</span></span>, <span class="hljs-attr"><span class="hljs-attr">t</span></span>: <span class="hljs-number"><span class="hljs-number">2000</span></span>})); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(msg.typeW == <span class="hljs-string"><span class="hljs-string">'F'</span></span>) msg.damage = <span class="hljs-number"><span class="hljs-number">1</span></span>; particles.push(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Effect({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: msg.typeW, <span class="hljs-attr"><span class="hljs-attr">x</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x, <span class="hljs-attr"><span class="hljs-attr">y</span></span>: avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y, <span class="hljs-attr"><span class="hljs-attr">side</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-attr"><span class="hljs-attr">damage</span></span>: msg.damage})); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;</code> </pre><br><br>  Here case 'pop' is nothing more than a translation of the word "hit", so those who cannot boast of knowing the language can understand me.  particles - an array of particles (special effects).  There is nothing to comment on.  The event of a shot occurs by analogy, but instead of particles, arrays of weapons_0 (my missiles) and weapons_1 (his missiles) are used, with cramming of new objects in them. <br><br>  <b>Error 3. Many bugs.</b> <br>  Apart from minor server crashes due to the abrupt lack of any variables, the main problem for me was ping.  It so happened that at work the connector fell off the patch cord, but it wasn‚Äôt in stock, and I had to sit on wifi.  At work, he is rotten, so that the delays were ensured by quality (150-200ms instead of 18-20 usual).  Testing another weapon, I noticed that after some time in two browser windows the picture of the location of the aircraft is not at all the same.  And as it turned out, the cause is wifi, or rather ping, and even packet loss.  As decided - we read further if you are not tired. <br><br><h4>  What happens in the game at all.  Mechanics. </h4><br>  Yes, there is nothing to say.  You press the button - the plane flies up / down.  Only now the player starts flying in the right direction, and the opponent does not immediately, for the long wait for the ill-fated messag√© that the opponent has long pressed the button up and flies to itself ... Actually this is the problem with the ping.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The more ping - the faster the picture becomes different for two clients. </font><font style="vertical-align: inherit;">Solved the problem ingeniously - every N time interval (1.5 - 3 seconds) synchronization is made about the real state of affairs. </font><font style="vertical-align: inherit;">There were of course minor jumps of airplanes during this synchronization (within a radius of 2-3px), but this is not as noticeable as what you are shooting at an opponent, you see how a rocket flies through it, and did not hit it - because in fact the player it may already be in another corner and shoot from there at you. </font><font style="vertical-align: inherit;">And so here and there. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The entire system was built in the spirit of client- (server-check) -client (s).</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Second run </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When I closed the holes, tried try ... catch, learned how to check the server‚Äôs negligence (the script below) on the base, drunk the VK API at the level of receiving a photo of the opponent, and issuing TOP 30 players (also with photos, by the way, and even with names), again began to spend money on advertising. </font><font style="vertical-align: inherit;">This time more meaningfully, right in the application catalog. </font><font style="vertical-align: inherit;">For moderate 100 votes (700r), I received about 200-300 installations, well, about half of the installed ones were immediately removed, so ‚Äú150 clean‚Äù. </font></font><br><br> <i><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Script to check if node is running</font></font></i> <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo `date` node /path/to/server.js &amp; while 1&gt;0 do ps -A | grep node &gt; /dev/null if [ $? = "1" ] then echo `date` node /path/to/server.js &amp; fi sleep 5 done</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">By the way, there is still worth noting that I found for myself an amazing </font></font><a href="http://help.ubuntu.ru/wiki/screen"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">screen</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> utility </font><font style="vertical-align: inherit;">, and without it, leaving the terminal meant death. </font><font style="vertical-align: inherit;">Now without her as without hands.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Again rework </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Due to failure in terms of installations and angry reviews of players, I again realized that this was a failure. </font><font style="vertical-align: inherit;">But in our business the main thing is not to give up! </font><font style="vertical-align: inherit;">And again what? </font><font style="vertical-align: inherit;">Yes, I again began to rewrite everything. </font><font style="vertical-align: inherit;">On the second launch, I made the following conclusions:</font></font><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Again not enough sociality </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Not enough attractiveness ( </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">shit</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> design takes its own)</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Lack of plot </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Difficult calculations on the client (8-10ms for rendering and drawing one frame is a dofig for such a ‚Äúgame‚Äù on i7, please note) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Large server load (30 people online - 10% of one core, I don‚Äôt remember about memory, and 5 Mbit traffic) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is no training, because of what the players are not at all clear what and how </font></font></li></ul><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I started, as always, again with design, and it was already more like the truth. </font><font style="vertical-align: inherit;">I showed it to friends, said ‚ÄúWOW is much better than that shit!‚Äù, But I didn‚Äôt feel this WOW, and finally took the first right step - I went to freelancing to look for an interface designer. </font><font style="vertical-align: inherit;">I found it, talked about it, I ponil about all my problems in the game, the person understood everything and made candy - which was only possible for 12 thousand. </font><font style="vertical-align: inherit;">(rubles) </font></font><br><img src="//habrastorage.org/files/e7b/426/ef7/e7b426ef78c444c5b566828577014bd2.JPG"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is the final version that exists now. </font><font style="vertical-align: inherit;">About more, I did not dream. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, about the design, then there were more small tasks like icons, a background for the game itself, and new effects for the weapon. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Learning to do it turned out to be a hemorrhoid exercise for me, and I managed to create tips on each button.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> We make an incentive to play </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Of the new features added, the main achievement I consider to receive medals and bonuses for some merit. </font><font style="vertical-align: inherit;">Play 100 times, finish off with a machine gun, etc. </font><font style="vertical-align: inherit;">Naturally with the proposal to place a beautiful picture of medals on your wall. </font><font style="vertical-align: inherit;">Two birds with one stroke. </font><font style="vertical-align: inherit;">Social fake was done. </font><font style="vertical-align: inherit;">By the way, here is the code for uploading a photo to the Vkontakte server:</font></font><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?</span></span> $url = $_POST[<span class="hljs-string"><span class="hljs-string">'uploadUrl'</span></span>]; $postdata = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'photo'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'@/path/to/image/'</span></span>.$_POST[<span class="hljs-string"><span class="hljs-string">"type"</span></span>].<span class="hljs-string"><span class="hljs-string">'.jpg'</span></span>, <span class="hljs-string"><span class="hljs-string">'app_id'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'3509664'</span></span>, <span class="hljs-string"><span class="hljs-string">'api_key'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'1234567890'</span></span>); $ch = curl_init($url); curl_setopt($ch, CURLOPT_RETURNTRANSFER, <span class="hljs-number"><span class="hljs-number">0</span></span>); curl_setopt($ch, CURLOPT_POST, <span class="hljs-number"><span class="hljs-number">1</span></span>); curl_setopt($ch, CURLOPT_POSTFIELDS, $postdata); curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, <span class="hljs-number"><span class="hljs-number">30</span></span>); $data = curl_exec($ch); curl_close($ch); <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> $data[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I posted this code for the reason that </font><font style="vertical-align: inherit;">I couldn‚Äôt find the </font></font><s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">nichrome</font></font></s><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> in the network, and this is a kind of impression of all that I could find. </font><font style="vertical-align: inherit;">I had to work with curl for the first time, so it was not without problems with its installation, but this is not so interesting. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I'll tell you about the algorithm posting entries on the wall of a user with a picture. </font><font style="vertical-align: inherit;">More precisely and faster will lead the code with detailed comments.</font></font><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">wall</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id, msg, typeMsg</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  : id ,   ,      VK.api('photos.getWallUploadServer', {https: 1}, function (data) { //         (data.response.upload_url) $.post('upload.php', {'uploadUrl': data.response.upload_url, type: typeMsg)}, function(data) { //    ,  upload.php    , typeMsg -   .    -  . var upload = $.parseJSON(data); //    hash  photo,     VK.api('photos.saveWallPhoto', {'hash': upload.hash, 'photo': upload.photo, 'server': upload.server, 'uid': id, 'gid': '', https: 1}, function (data) { //         (   ) //       ,  " "    wall.post. VK.api('wall.post', {'message': msg, attachments: data.response[0].id, https: 1}, function(data){ //               }) }) }); }); }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Such are spaghetti. </font><font style="vertical-align: inherit;">Eat on health!</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Client optimization </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">So, I finally decided to more closely read about the sine cosines and, first of all, get rid of the separate calculations for drawing and real coordinates. </font><font style="vertical-align: inherit;">There is nothing special to tell, but the code is clearly better.</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.draw = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">t</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a2 = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK = (t &gt; <span class="hljs-number"><span class="hljs-number">40</span></span>) ? <span class="hljs-number"><span class="hljs-number">1</span></span>+((t<span class="hljs-number"><span class="hljs-number">-40</span></span>)/<span class="hljs-number"><span class="hljs-number">40</span></span>) : <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x += <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin((<span class="hljs-number"><span class="hljs-number">90</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ra)*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.x2+(<span class="hljs-number"><span class="hljs-number">2</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin((<span class="hljs-number"><span class="hljs-number">90</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ra)*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y -= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ra*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y2-(<span class="hljs-number"><span class="hljs-number">2</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ra*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>))); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s -= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ra*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>))*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wspeed/(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y/<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wspeed))/<span class="hljs-number"><span class="hljs-number">4.5</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s2-(<span class="hljs-number"><span class="hljs-number">2</span></span>*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.ra*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>))*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wspeed/(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.y/<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wspeed))/<span class="hljs-number"><span class="hljs-number">4.5</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-number"><span class="hljs-number">0.0001</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s*<span class="hljs-number"><span class="hljs-number">50</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.wradius; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r2; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-number"><span class="hljs-number">0.000000001</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r+<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r-<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.s)/(<span class="hljs-number"><span class="hljs-number">2</span></span>*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.r); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa2; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.timeK*<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.koef*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.acos(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.cosa)*<span class="hljs-number"><span class="hljs-number">180</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.PI; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">isNaN</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a)) <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.a2; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; weapons.all.length; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.id &amp;&amp; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.per[weapons.all[i]] &lt;= <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.tper[weapons.all[i]]){ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.per[weapons.all[i]] += (t &gt; <span class="hljs-number"><span class="hljs-number">40</span></span>) ? t+<span class="hljs-number"><span class="hljs-number">40</span></span> : <span class="hljs-number"><span class="hljs-number">40</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  (   ) } } if(this.id){ this.opacity = (this.per.M &lt; this.tper.M) ? 0.6 : 1; if(this.debaff.M.per != 1) this.debaff.M.per += (t &gt; 40) ? t+40 : 40; if(this.debaff.E.per &lt;= this.debaff.E.tper) this.debaff.E.per += (t &gt; 40) ? t+40 : 40; } if(this.x &gt; 700+this.w) this.x = -this.w; if(this.x &lt; -this.w) this.x = 700+this.w; if(this.key == 'up') this.ra += this.a else if(this.key == 'down') this.ra -= this.a; if(isNaN(this.x) || isNaN(this.y) || isNaN(this.r) || isNaN(this.a) || isNaN(this.ra) || isNaN(this.s) || isNaN(this.cosa) || isNaN(this.timeK)){ this.x = (par.side == 'left') ? 40 : 660; this.y = 450; this.s = this.wspeed; this.r = this.s*50/this.wradius; this.cosa = (this.r*this.r+this.r*this.r-this.s*this.s)/(2*this.r*this.r); this.a = 0; this.ra = this.a; } if(this.opacity &gt;= 0.5){ ctx.globalAlpha = this.opacity; ctx.save(); ctx.translate(this.x, this.y); ctx.fillStyle = '#f00'; ctx.strokeStyle = '#000'; ctx.fillRect(-34,-40,(this.life/100)*67,4); ctx.strokeRect(-34,-40,67,4); ctx.rotate(-this.ra*this.PI/180); ctx.drawImage(this.image, -this.w/2, -this.h/2, this.w, this.h); ctx.restore(); } }</span></span></code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here everything seems to be clear except for the names of the variables; One of the players discovered (and later checked by me) an unpleasant bug - the samoe is abruptly in the upper left corner and everything, you can leave the game. This was due to the fact that when calculating some variables, with a small degree of probability they became === 0, and then they had to be divided, and such a mess was obtained. After the crash into the verification code on the NaN, the bug disappeared and everyone is happy. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">if (this.opacity&gt; = 0.5) {...} the code of the rendering on the canvas is executed only if the plane is not in stealth mode (yes, there is such a bonus)</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another point - the function takes the parameter t. It is essentially needed for weak computers / tablets. Ie this parameter contains infa about how much time a frame is drawn, and if it is more than 40ms (everything works at a speed of 25 frames per second), then all movements of the aircraft must be proportionally increased. These changes reduced the rendering time by about 2-3ms, which is not bad anymore. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The next step was the optimization of the smoke from the aircraft, because most of all the memory and processor he ate. About how smoke is implemented, I wrote in </font></font><a href="http://habrahabr.ru/post/185482/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">this article</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">. To optimize, I made another image - smaller in size and which should not be rotated (gray round gradient), and once I drew it on an invisible canvas (buffer), and then copied from it. Nothing complicated. And, well, I also made the particles be added only when the device has enough relics to draw it (t &lt;10). This gave another minus 3-4ms calculations. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Then the biggest hole was found - in drawing the reload rate and quantity for each weapon. In battle, it looks like this:</font></font><br><img src="//habrastorage.org/files/df2/279/f51/df2279f514c14eb8860d04349e43be67.JPG"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The arrows indicate the pieces, the rendering of which was the most difficult (arc). </font><font style="vertical-align: inherit;">I decided that because </font><font style="vertical-align: inherit;">most of the weapons most of the time is in full recharge (or with no ammo (bottom bar)), then you can simply draw these states on a separate canvas, and if necessary just draw ready (do not draw at all). </font><font style="vertical-align: inherit;">The most interesting thing is that the optimization of these 32 semicircles gave the greatest effect - ash 5-6ms. </font><font style="vertical-align: inherit;">And now the mission is complete. </font><font style="vertical-align: inherit;">With the maximum possible smoke from both players (the fewer lives, the more smoke), the frame began to draw 1-2ms, and without smoke, generally less than 1ms (0.2-0.3 if you take the average). </font><font style="vertical-align: inherit;">All numbers for Chrome 32.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Server optimization </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It turned out to be too expensive to check every rocket launched on the server, let alone send an answer to the client (socket.io is not perfect, as it turned out). Therefore, I transferred this responsibility to the client, but in order to save myself from cheaters, there is simply a selective check of questionable users on the server (a smart one built such a thing - each user on the server accumulates a certain amount of errors, after which he gets more careful control , to the extent that I personally check the logs of the player - well, this is quite if the suspicious caught). And the answer from the server in the case of, for example, the absence of weapons does not go - and what, I also have to notify the cheater that he will fail? In general, this removed a huge part of the load on both the node and the base. The result was 5% CPU for 150 people. online.Memory eats all a penny.</font></font><br><br><h5><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Any vague customer losses </font></font></h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When advertising was given in the application directory of contact, the statistics of the installation did not correspond to reality, i.e. </font><font style="vertical-align: inherit;">A lot of users simply did not even wait for the game to load (less than 2 seconds on average - this is not a flash). </font><font style="vertical-align: inherit;">I started looking for a problem and it turned out to be used by some players (20%) https. </font><font style="vertical-align: inherit;">And then danced with tambourines. </font><font style="vertical-align: inherit;">Eventually socket.io and nginx managed to be configured. </font><font style="vertical-align: inherit;">Here is a piece of nodejs server code that creates an https server socket.io</font></font><br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> fs = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'fs'</span></span>); server = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'https'</span></span>).createServer({<span class="hljs-attr"><span class="hljs-attr">key</span></span>: fs.readFileSync(<span class="hljs-string"><span class="hljs-string">'/path/to/*.key'</span></span>), <span class="hljs-attr"><span class="hljs-attr">cert</span></span>: fs.readFileSync(<span class="hljs-string"><span class="hljs-string">'/path/to/*.crt'</span></span>)}).listen(<span class="hljs-number"><span class="hljs-number">1006</span></span>); io = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'socket.io'</span></span>).listen(server);</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> There is nothing to comment on, but I spent more than one day on this, and that does not include ordering and installing certificates on the server. </font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Third launch </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Or rather - nedozapusk. Vkontakte has the opportunity to place your application in the top 9 of the ‚ÄúNew‚Äù block for 1000 votes (7 thousand rubles, excluding discounts). I threw in the votes, sent the application, chose the day (right for the then tomorrow), and waited. At night, I received a notification that I was forced to refuse placement, with a proposal to add to the game the possibility of playing with a computer or learning. I decided to do both.</font></font><br><br><h5>  Artificial Intelligence </h5><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">I already thought about the possibility of playing with a computer, but somehow I didn‚Äôt want to get into this mess, because I thought it was as long as it took me long. But since I already mentioned above that the code of the game was modular, for the first day I made the opportunity to kill the computer blank, for the second day I made a computer brain and drank it 30 levels. In total, on the server side I added 3 lines (not counting the level config), and on the client lines 30-40. And it turned out to be quite not bad, I myself can‚Äôt kill level 25 AI. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The AI ‚Äã‚Äãcode is a little: the enemy plane just constantly follows your plane, and in the case that the angle of attack becomes acceptable, it shoots from the whole weapon. Here again, trigonometry of the 7th grade and nothing more.</font></font> Code: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].oppId == <span class="hljs-string"><span class="hljs-string">'computer'</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> x = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.abs(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x-avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> y = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.abs(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y-avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> gp = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sqrt((x*x)+(y*y)); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> rad = avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].ra*<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">180</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> prom; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x &lt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y &lt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y) prom = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.asin(y/gp)+rad <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x &gt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y &lt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y) prom = (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">2</span></span>)-<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.asin(y/gp)+rad+(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x &gt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y &gt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y) prom = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.asin(y/gp)+rad+<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].x &lt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].y &gt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y) prom = (<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI/<span class="hljs-number"><span class="hljs-number">2</span></span>)-<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.asin(y/gp)+rad+(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.PI*<span class="hljs-number"><span class="hljs-number">1.5</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sin = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.sin(prom); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cos = <span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(prom); avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 -= <span class="hljs-number"><span class="hljs-number">40</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time2 -= <span class="hljs-number"><span class="hljs-number">40</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time3 -= <span class="hljs-number"><span class="hljs-number">40</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time2 &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].levelBot == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time3 &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons.learning[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">0</span></span>]]){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons.learning[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">0</span></span>]][avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">1</span></span>]] == <span class="hljs-string"><span class="hljs-string">'^'</span></span>) $(<span class="hljs-string"><span class="hljs-string">'#learning'</span></span>).append(<span class="hljs-string"><span class="hljs-string">'&lt;br/&gt;'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> $(<span class="hljs-string"><span class="hljs-string">'#learning'</span></span>).append(weapons.learning[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">0</span></span>]][avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">1</span></span>]]); avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">1</span></span>] += <span class="hljs-number"><span class="hljs-number">1</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time3 = <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">1</span></span>] &gt;= weapons.learning[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">0</span></span>]].length){ avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-number"><span class="hljs-number">0</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">0</span></span>] += <span class="hljs-number"><span class="hljs-number">1</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time2 = <span class="hljs-number"><span class="hljs-number">1000</span></span>; $(<span class="hljs-string"><span class="hljs-string">'#learning'</span></span>).empty(); } } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(weapons.learning[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].learning[<span class="hljs-number"><span class="hljs-number">0</span></span>]] &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].levelBot == <span class="hljs-number"><span class="hljs-number">0</span></span>){avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x = <span class="hljs-number"><span class="hljs-number">-800</span></span>} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sin &gt; <span class="hljs-number"><span class="hljs-number">0.02</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].key = <span class="hljs-string"><span class="hljs-string">'up'</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 = <span class="hljs-number"><span class="hljs-number">100</span></span>/avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].wradius} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sin &lt;= <span class="hljs-number"><span class="hljs-number">0.02</span></span> &amp;&amp; sin &gt;= <span class="hljs-number"><span class="hljs-number">-0.02</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].key = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 = <span class="hljs-number"><span class="hljs-number">100</span></span>/avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].wradius} } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sin &lt; <span class="hljs-number"><span class="hljs-number">-0.02</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 &lt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].key = <span class="hljs-string"><span class="hljs-string">'down'</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 = <span class="hljs-number"><span class="hljs-number">100</span></span>/avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].wradius} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y &gt; <span class="hljs-number"><span class="hljs-number">510</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">Math</span></span>.cos(rad) &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>){avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].key = <span class="hljs-string"><span class="hljs-string">'up'</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 = <span class="hljs-number"><span class="hljs-number">100</span></span>/avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].wradius} <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>{avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].key = <span class="hljs-string"><span class="hljs-string">'down'</span></span>; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].time1 = <span class="hljs-number"><span class="hljs-number">100</span></span>/avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].wradius} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(sin &lt;= <span class="hljs-number"><span class="hljs-number">0.035</span></span> &amp;&amp; sin &gt;= <span class="hljs-number"><span class="hljs-number">-0.035</span></span> || (sin &lt;= <span class="hljs-number"><span class="hljs-number">0.3</span></span> &amp;&amp; sin &gt;= <span class="hljs-number"><span class="hljs-number">-0.3</span></span> &amp;&amp; gp &lt; <span class="hljs-number"><span class="hljs-number">30</span></span>) || gp &lt; <span class="hljs-number"><span class="hljs-number">15</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all.length; i++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].weapons[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]] &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>){ avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].per[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]] += <span class="hljs-number"><span class="hljs-number">40</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].per[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]] &gt;= avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].tper[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]]){ <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]){ <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'I'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life &lt;= <span class="hljs-number"><span class="hljs-number">20</span></span> &amp;&amp; avatars[<span class="hljs-number"><span class="hljs-number">0</span></span>].life &gt;= <span class="hljs-number"><span class="hljs-number">25</span></span>){ sock.send($.toJSON({<span class="hljs-attr"><span class="hljs-attr">type</span></span>:<span class="hljs-string"><span class="hljs-string">'shot'</span></span>,<span class="hljs-attr"><span class="hljs-attr">x</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x,<span class="hljs-attr"><span class="hljs-attr">y</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y,<span class="hljs-attr"><span class="hljs-attr">a</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].ra,<span class="hljs-attr"><span class="hljs-attr">koef</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].koef,<span class="hljs-attr"><span class="hljs-attr">typeW</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i],<span class="hljs-attr"><span class="hljs-attr">side</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].sideName,<span class="hljs-attr"><span class="hljs-attr">bot</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>})); avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].weapons[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]] -= <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'J'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].life &lt;= <span class="hljs-number"><span class="hljs-number">50</span></span>){ sock.send($.toJSON({<span class="hljs-attr"><span class="hljs-attr">type</span></span>:<span class="hljs-string"><span class="hljs-string">'shot'</span></span>,<span class="hljs-attr"><span class="hljs-attr">x</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x,<span class="hljs-attr"><span class="hljs-attr">y</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y,<span class="hljs-attr"><span class="hljs-attr">a</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].ra,<span class="hljs-attr"><span class="hljs-attr">koef</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].koef,<span class="hljs-attr"><span class="hljs-attr">typeW</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i],<span class="hljs-attr"><span class="hljs-attr">side</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].sideName,<span class="hljs-attr"><span class="hljs-attr">bot</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>})); avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].weapons[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]] -= <span class="hljs-number"><span class="hljs-number">1</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: sock.send($.toJSON({<span class="hljs-attr"><span class="hljs-attr">type</span></span>:<span class="hljs-string"><span class="hljs-string">'shot'</span></span>,<span class="hljs-attr"><span class="hljs-attr">x</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].x,<span class="hljs-attr"><span class="hljs-attr">y</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].y,<span class="hljs-attr"><span class="hljs-attr">a</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].ra,<span class="hljs-attr"><span class="hljs-attr">koef</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].koef,<span class="hljs-attr"><span class="hljs-attr">typeW</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i],<span class="hljs-attr"><span class="hljs-attr">side</span></span>:avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].sideName,<span class="hljs-attr"><span class="hljs-attr">bot</span></span>: <span class="hljs-number"><span class="hljs-number">1</span></span>})); avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].weapons[avatars[<span class="hljs-number"><span class="hljs-number">1</span></span>].all[i]] -= <span class="hljs-number"><span class="hljs-number">1</span></span>; } } } } } } }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In addition to the idea, there is nothing to learn from here, I do not advise using the code. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The if block (avatars [1] .time2 &lt;= 0 &amp;&amp; avatars [0] .levelBot == 0 &amp;&amp; avatars [1] .time3 &lt;= 0) {...} is training. It occurs only when playing with level 0 AI. There the essence is that the messages are displayed by letter (fashionably, the type is printed) from the array of messages. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Also, the AI ‚Äã‚Äãhas a little brain on the topic of not breaking. At a height below a certain, he begins to ignore you, and tries to steer in order not to die. Well ... and the first-aid kit, he also uses correctly, and not as horrible.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Actually, the mission is completed, the AI ‚Äã‚Äãis ready, the training is there, it's up to the small thing - to wait for the approval of the administration to reapply for placement in that very block. </font><font style="vertical-align: inherit;">For some reason, the second time I was able to choose the nearest date of placement on March 23, so I am waiting, waiting. </font><font style="vertical-align: inherit;">And if it will lead to some kind of permanent online and profit, then I will definitely write an article about money withdrawal, taxes, and so on. </font><font style="vertical-align: inherit;">So far the game has brought 20 votes, so there‚Äôs nothing to talk about.</font></font><br><br><h4>  findings </h4><br><ul><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Can't do like me </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Test more. </font><font style="vertical-align: inherit;">Ask friends, preferably from the age group of players that you expect to see in the game. </font><font style="vertical-align: inherit;">You can simply show the picture and ask what is convenient there.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">If you are not going to add over 100,500 new features in the game - do not rewrite all the code! </font><font style="vertical-align: inherit;">In general, it is better to start with something simpler.</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">All that is written above is only a small part of all the horror that I encountered. </font><font style="vertical-align: inherit;">So be prepared for the difficulties!</font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Began - finish to the end. </font></font> BUT!<font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Only if you are confident of success and are pursuing a specific goal and not having fun ... otherwise why? </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Do not try to wash eggs with expensive shampoo. </font><font style="vertical-align: inherit;">Soap is the most it. </font><font style="vertical-align: inherit;">(A metaphor that can be understood differently, but the meaning will not disappear)</font></font></li></ul><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">ps I do not recommend using the code written here. </font><font style="vertical-align: inherit;">I am sure that there are many more elegant solutions, which I will be glad to hear in the comments.</font></font> Thanks for attention! <br><br> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Update</font></font></b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> With a clear conscience, in view of the large number of requests to show the link, I write it here: </font></font><a href="http://vk.com/app3509664"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">reference</font></font></a> </div><p>Source: <a href="https://habr.com/ru/post/190484/">https://habr.com/ru/post/190484/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../190472/index.html">The most popular article in a scientific journal</a></li>
<li><a href="../190474/index.html">Data structures, PHP. Part two</a></li>
<li><a href="../190478/index.html">The developer reported a bug in Facebook on the page Zuckerberg</a></li>
<li><a href="../190480/index.html">How to close the Internet in Russia</a></li>
<li><a href="../190482/index.html">Working with data from related tables in ASP.NET MVC or developing a Lookup component</a></li>
<li><a href="../190488/index.html">Cookie without cookies</a></li>
<li><a href="../190490/index.html">Nokia Sensing XCHALLENGE 2013</a></li>
<li><a href="../190492/index.html">Ten reasons not to use a statically typed functional programming language</a></li>
<li><a href="../190494/index.html">Improved CoffeeScript Inheritance</a></li>
<li><a href="../190496/index.html">ASUS X550CC Notebook Review</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>