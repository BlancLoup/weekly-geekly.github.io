<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Shadow DOM: Specification</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Andrei Glazkov, Ito Hayato from Google, as well as other experts on Github, are working on drafting the Shadow DOM specification. A lot of work has al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Shadow DOM: Specification</h1><div class="post__text post__text-html js-mediator-article">  Andrei Glazkov, Ito Hayato from Google, as well as other experts on Github, are working on drafting the Shadow DOM specification.  A lot of work has already been done, but much remains to be done.  As part of supporting work in this area, a translation of the existing version of the specification of July 7 has been created. <br><br>  This specification describes how to combine several DOM trees into one hierarchy, and the interaction of these trees with each other in one document, which allows you to build the DOM more correctly. <br><img src="https://habrastorage.org/files/ad6/053/d48/ad6053d48caa4a149586ff69830b7a70.jpg"><br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">1. Compliance</b> <div class="spoiler_text">  All diagrams, examples, notes, as well as sections clearly marked as non-normative are not normative.  Everything else in this specification is normative. <br>  In the original version of the specification, the keywords "should", "should not", "need", "will", "not be", "should", "should not", "recommended", "can" and "optionally" in normative Parts of this document should be interpreted as described in <a href="http://w3c.github.io/webcomponents/spec/shadow/">[RFC 2119]</a> .  For readability, these words are not used in upper case in the original of this specification. <br><br>  To simplify references and in order to avoid circular dependencies between different parts of a specification, this document is composed of three consecutive parts: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      1. Creating conditions for specification. <br>  2. Explanation of the idea of ‚Äã‚Äãthe model and the algorithms underlying it. <br>  3. Description of this model using DOM-interfaces and HTML-elements. <br><br>  In a sense, these parts can be considered as mathematics, establishing the environment in which the model will operate, physics, describing how theoretically this model should work, and mechanics, showing how the model is put into practice. <br><br>  Any point at which the corresponding client application must make state decisions or respond to the state of the conceptual model is described as an algorithm. <br><br>  Algorithms are described in terms of uniformity of processing. <br>  Uniformity of processing is a limitation imposed on the implementers of the algorithm, which is that the output for all algorithms implemented on the client and described in the specification must be absolutely identical for any input. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">2. Concepts</b> <div class="spoiler_text">  <b>2.1 Introduction</b> <br><br>  <i>This part is non-standard.</i> <br>  <a href="http://www.html5rocks.com/en/tutorials/webcomponents/shadowdom/">Shadow DOM 101</a> should be considered as a non-normative <a href="http://www.html5rocks.com/en/tutorials/webcomponents/shadowdom/">.</a> <br><br>  <b>2.2 Shadow Trees</b> <br><br>  The document tree is a DOM node structure whose root element is a document. <br><br>  The shadow tree has a corresponding flag for the encapsulation mode, which can be open or closed. <br><br>  The shadow root is the root element of the shadow tree. <br><br>  A node A is called a child (deep child) or a nested shadow root of node B, if A is a child node B or A is the root node of the shadow tree contained in B. <br><br>  Node A is called a deep descendant of node B if A is a child or nested shadow root of node B or A is a child or nested shadow root of node C, which is in turn the deep descendant of node B. <br><br>  The contained descendant (inclusive deep descendant) can be a node or one of its deep descendants. <br><br>  A node A is called a deep parent of a node B only if B is a deep descendant of A. <br><br>  Node A is called a deep ancestor (deep ancestor) of node B only if B is a deep descendant of A. <br><br>  Inclusive deep ancestor - a node or one of its deep ancestors. <br><br>  When an element is a contained descendant of an element of a document, it is in the document at the depth of that element. <br><br>  <b>2.3 Trees of trees</b> <br><br>  A tree of trees is a tree consisting of node trees. <br>  <i>The definition of the term ‚Äútree of trees‚Äù is given in this place in order to facilitate the definition of algorithms in the subsequent sections.</i>  <i>This designation method should simplify this specification.</i> <br><br>  Just as a node tree can be represented as a set of relationships between these nodes, a tree of trees can be represented as a set of relationships between node trees. <br><br>  ‚óè Tree A is the parent tree of tree B in case one of these conditions is satisfied: <br><br>  1. A and B are next to each other in the same ordered list and tree A is the oldest in relation to B. <br>  2. B is the most senior shadow tree and the leading element of the shadow tree B is also the leader for A. <br><br>  ‚óè Other relationships and conditions, such as the root tree, the child tree, the descendant tree containing the descendant tree, the ancestor tree containing the ancestor tree, the preceding tree are defined in a manner similar to the definition of trees. <br><br>  The property <a href="https://dom.spec.whatwg.org/">ownerDocument</a> in the shadow tree must refer to the document of the host element containing this shadow tree. <br><br>  The named properties of the Window object [HTML] must have access to the nodes in the document tree. <br><br>  2.3.1 Example of a tree <br>  <i>This part is non-standard.</i> <br><br><img src="https://habrastorage.org/files/a4b/e9b/609/a4be9b6090394ad3854e700675ab4fa6.png"><br>  <i>Fig.</i>  <i>1 Tree trees.</i> <br><br>  The figure shows 6 tree nodes with the names A, B, C, D, E, and F. The trees of nodes C, D, and B have a common leading element that is part of the node tree A. Shadow trees E and F have a common leading element, which is part of the node tree D. <br>  The figure also shows the following relationships: <br><br>  ‚óè The list of child trees of the tree A is [B, C, D]. <br>  ‚óè The list of child trees of tree B is []. <br>  ‚óè The list of child trees of the C tree is []. <br>  ‚óè The list of child trees of the tree D is [E, F]. <br>  ‚óè The list of child trees of the E tree is []. <br>  ‚óè The list of child trees of the tree F is []. <br>  ‚óè Document Tree A is the root tree of the tree of trees. <br><br>  As for the relations between nodes, it is worth noting that there are no ancestor / descendant relations between two nodes if they consist of different node trees.  The root element of a shadow tree is not a child of the host element of a shadow tree.  There is no parent node for the root element of the shadow tree.  For this reason, most existing APIs have their own scope, and do not affect other node trees, despite the fact that they form one tree of trees.  For example, document.getElementById (elementId) will never return an element from the shadow tree, even if it has the specified elementId. <br><br>  The same applies to the work of CSS selectors: a combined selector that descends down the DOM tree will not affect the elements of the shadow tree, because the root element of this tree is not a child node of its leading element.  If a special CSS shadow DOM selector is used, which is mentioned later, it will not match an element in another node tree. <br><br>  <i>Because ShadowRoot inherits a DocumentFragment, as will be explained later, you can use ShadowRoot.getElementByID (elementId) to get a node from a shadow tree.</i> <br><br>  <b>2.4 Composed trees</b> <br><br>  A composed tree is a tree of nodes constructed from nodes of several node trees in a tree.  The exact algorithm for constructing such a tree will be given below. <br><br><img src="https://habrastorage.org/files/1bf/82d/891/1bf82d8911b8406a8477c190ee9c989d.png"><br>  <i>Fig.</i>  <i>2 Composed tree</i> <br><br>  If the element is not part of a compiled tree whose root node is a document, this element should not appear in the formatting structure [CSS21] or create any block.  This behavior should not be overridden by explicitly specifying the 'display' property. <br><br>  When defining CSS inheritance rules, an element must inherit from the parent node in the composed tree, if applicable. <br><br>  <i>The working draft of the CSS Scoping specification [css-scoping-1] defines selectors related to the shadow model of the document.</i>  <i>For those who will search for this specification of the shadow model of the document with these selectors, we denote these selectors here:</i> <i><br></i>  <i>‚óè: shadow pseudo-element</i> <i><br></i>  <i>‚óè / deep / combinator that was replaced by a combinator &gt;&gt;&gt; (shadow combinator of partial descendants)</i> <i><br></i>  <i>‚óè :: content pseudo-element</i> <i><br></i>  <i>‚óè: host-context () functional pseudo-class</i> <i><br></i> </div></div><br><div class="spoiler">  <b class="spoiler_title">3. Distributions</b> <div class="spoiler_text"> <b>3.1 Points of Inclusion</b> <br><br>  The point of inclusion is the place where the nodes appear in another node tree instead of their original position when building a composed tree. <br><br><img src="https://habrastorage.org/files/d6d/de5/be5/d6dde5be5c87454d8de7f918f6f63e04.png"><br>  <i>Fig.</i>  <i>3 Distribution</i> <br><br>  Distribution is a mechanism that determines which nodes appear at which switching point. A detailed distribution algorithm will be described later. <br><br>  <b>3.2 Content inclusion points</b> <br><br>  Content inclusion points are the inclusion points to which the child nodes of the leading shadow element are distributed.  A content element that satisfies the following conditions is a content inclusion point: <br><br>  ‚óè The root node of the content item is the root node of the shadow tree <br>  ‚óè There are no other content elements among the ancestors of the content item. <br><br>  <b>3.3 Distribution Results</b> <br><br>  Each tree of trees has distribution results describing a consequence of this process.  The result of the distribution should be as follows: <br><br>  1. Each point of inclusion must have an ordered list, called distributed nodes, consisting of nodes distributed at the point of inclusion. <br>  2. Each node that is not an inclusion point has an ordered list called assignment point assignments and consisting of the inclusion points in which the nodes are distributed. <br>  3. The inclusion point A is the final destination of node B if A is the last item in the list of assignment points for inclusion B. <br><br>  When Node A is distributed to the enable point B, the following should occur: <br>  ‚óè A will be added to distributed nodes B <br>  ‚óè B is added to the final switch points A <br><br>  <i>There is a case that deserves special attention - a situation where the inclusion point is a child of another leading shadow element.</i>  <i>In such situations, the nodes distributed at this point of inclusion appear in such a way as if they are children of the leading shadow element in the context of the distribution.</i>  <i>Then, the nodes distributed in the shadow tree may already be distributed from their parent tree.</i> <i><br></i>  <i>Although the node is distributed to more than one switching point, it appears only once in the composed tree - at the place of its final destination.</i> <br><br><img src="https://habrastorage.org/files/f0b/a93/a9f/f0ba93a9fe1e4cbe9efb42219a89e666.png"><br>  <i>Fig.</i>  <i>4 Redistribution.</i> <br><br>  In the figure, child node 1 is distributed to switch on point 1. Then child 1 is redistributed to switch on point 3. Final switch points on child 1 - [switch on point 1, point on switch 3] and point of switch 3 are the final assignments of child 1. Distributed switch point nodes 1 and the points of inclusion 3 are [descendant 1] and [descendant 1, descendant 3], respectively. <br><br>  <b>3.5 Algorithms distribution</b> <br><br>  To calculate the result of the tree distribution of trees, it is necessary to use the distribution algorithm, which should be equivalent to performing the following steps sequentially: <br><br>  <b>Input</b> <br>  TREE OF TREES - tree of trees <br>  <b>Conclusion</b> <br>  Updated result of TREE TREES distribution <br>  1. All distributed nodes and final switching points belonging to TREE TREES must be empty. <br>  2. The ROOT TREE must be the TREE TREE tree. <br>  3. It is necessary to run the algorithm for calculating the distribution with the ROOT TREE as input data. <br><br>  To determine the distribution result for a given tree of nodes and its descendant trees, an algorithm for calculating the distribution result should be used, consisting in performing the following steps: <br><br>  <b>Input</b> <br>  TREE NODES - node tree <br>  <b>Conclusion</b> <br>  Updated distribution result for containing tree-descendants of the TREE OF NODES <br>  1. For each leading element of the shadow tree, the LEADING SHADOW ELEMENT (SHADOW-HOST), which is the leading element of the NODE TREE, in the current tree structure: <br><br>  The pool must be the result of the algorithm for filling the pool with a leading shadow element as input <br>  A SHADOW TREE is a shady tree contained in the LEADING SHADOW ELEMENT. <br>  Run a pool allocation algorithm with a TEMPLE TREE and a POOL as input <br>  Run the algorithm to calculate the result of the distribution recursively, with the SHADOW TREE as input <br><br>  The algorithm for filling the pool should also be used to obtain nodes from the child nodes of this node and consists in performing the following actions: <br><br>  <b>Input</b> <br>  KNOT (NODE) ‚Äã‚Äãnode <br>  <b>Conclusion</b> <br>  POOL (POOL) ordered list of nodes <br>  1. The pool must be an empty ordered list. <br>  2. For each node, node knockout: <br>  1. If the CHILD is the point of activation: <br>  1. Add all nodes to the distributed nodes. <br>  2. Otherwise: <br>  1. Add CASTING TO POOL <br><br>  The pool distribution algorithm must be used to distribute nodes in the pool to the inclusion points of the content in the shadow tree and consists of the following actions: <br><br>  <b>Input</b> <br>  Shade Tree, Shadow Tree <br>  PUL, ordered list of nodes <br>  <b>Conclusion</b> <br>  Nodes in the BULLET are distributed to the inclusion points of the contents in the tree. <br>  1. For each content inclusion point, CONTENT, consisting in the SHADOW TREE in the tree structure: <br>  1. For each node knot in the bullet <br>  1. If the KNOT satisfies the criterion of compliance CONTENTS: <br>  1. Distribute the KNOT in the CONTENT <br>  2. Remove the KNOT from the pool <br>  2. If in the CONTENT no node is distributed: <br>  1. For each descendant, CONTROL of CONTENTS <br>  1. DISTRIBUTE CASTING IN THE CONTENT <br><br>  <i>If no node has been distributed to the point of inclusion of the CONTENT content, the child nodes of CONTENT are distributed to the CONTENT as backup nodes.</i> <br><br>  If there is any condition that affects changes in distribution results, the distribution result must be updated before it can be used. <br><br>  <b>3.5 Satisfaction of eligibility criteria</b> <br><br>  The criterion for matching the point of inclusion is a set of composite selectors [SELECTORS4].  These composite selectors can contain only such simple selectors: <br><br>  ‚óè Type selector or universal selector <br>  ‚óè class selector (s) <br>  ‚óè ID selector <br>  ‚óè attribute selector (s) <br>  ‚óè Negative pseudo-class:: not () <br><br>  A node satisfies the matching criterion only if: <br>  1. all complex selectors in the sample consist only of allowed simple selectors;  and <br>  2. The node corresponds to at least one composite selector in the sample, or the sample is empty. <br></div></div><br><div class="spoiler">  <b class="spoiler_title">4. Drafting</b> <div class="spoiler_text">  To determine the descendants of each node in the composed tree, it is necessary to apply an algorithm for calculating the descendants of the composed tree, which consists in performing the following actions: <br><br>  <b>Input</b> <br>  KNOTE (NODE), a node located in a composed tree <br>  <b>Conclusion</b> <br>  CURRENT (CHILDREN), child node of the KNOTT in the composed tree. <br>  1. CREATURE should be an empty ordered list of nodes <br>  2. If the NODE is the leading shadow element: <br>  1. The pool-costs should be the youngest shadow root contained in the node. <br>  3. Otherwise: <br>  1. The pool-flow should be a node of the node <br>  4. For each child node, CASTING, in CASTING BULLET: <br>  1. If the CASH is the point of inclusion: <br>  1. For each node, DISTRIBUTED NODE (DISTRIBUTED-NODE), in the list of distributed nodes at the point of inclusion of the CASH: <br>  1. If the CASH is the final destination of the DISTRIBUTED KNOT, add the DISTRIBUTED KNOT to the DESCENT <br>  2. Otherwise: <br>  1. Add CREATE TO CREATE <br><br>  For a given tree of TREE TREES, a composed tree constructed from TREE TREES must correspond to the following tree: <br>  ‚óè The root node of the composed tree is the root node of the root tree in the TREE TREE. <br>  For a given node in the composed tree, the child nodes of this node are the result of the algorithm for calculating the composed tree with the node as input <br></div></div><br><div class="spoiler">  <b class="spoiler_title">5. Events</b> <div class="spoiler_text">  In each algorithm in this section, the Window must be treated as if it were the parent node of the document ‚Äî so that the Window can also receive events. <br><br>  When an event is distributed into a shadow tree, its path either passes through shadow trees or ends at the shadow root.  The only exception is change events (mutations).  These types of events should never be distributed into a shadow tree. <br><br>  <b>5.1 Always stopped events</b> <br>  The following events should always be stopped at the lowest shadow root: <br><br>  ‚óè abort <br>  ‚óè error <br>  ‚óè select <br>  ‚óè change <br>  ‚óè load <br>  ‚óè reset <br>  ‚óè resize <br>  ‚óè scroll <br>  ‚óè selectstart <br><br>  The exact algorithm will be given below. <br><br>  <b>5.2 Ways of events</b> <br>  To determine the event path, it is necessary to use the event path calculation algorithm, which consists in performing the following actions: <br>  <b>Input</b> <br>  KNOT, node <br>  EVENT, event (event) <br>  <b>Conclusion</b> <br>  PATH, event path, ordered list of event targets. <br>  1. The PATH should be an empty ordered list. <br>  2. THE CURRENT ITEM MUST BE A NODE <br>  3. Repeat until CURRENT ELEMENT exists: <br>  1. Add POWER ON POINT <br>  2. If the final points of the CURRENT ELEMENT are not empty: <br>  1. Add each switching point to the final switching points of the CURRENT ELEMENT, from the first, including, to the last, exclusive, to the PATH. <br>  2 ... THE CURRENT ITEM must be the final destination of the CURRENT ITEM <br>  3. Otherwise, if all the following conditions are met, stop this algorithm: <br>  1. If the CURRENT ITEM is a shadow root: <br>  2. If the CURRENT ITEM is the root node of the NODE <br>  3. Installed scoped flag. <br>  4. Otherwise: THE CURRENT ITEM must be a deep parent of the CURRENT ITEM. <br><br>  <b>5.3 Examples of event paths</b> <br><br>  <i>This section is non-normative.</i> <br>  Suppose we have the following tree trees: <br><img src="https://habrastorage.org/files/e22/77e/bdd/e2277ebdd9044ebe8df554b6a91463d0.png"><br>  <i>Fig.</i>  <i>5 Example of a tree.</i>  <i>Nodes that are not participating in the event path in question, described below, are omitted.</i> <br>  ‚óè A is a document. <br>  ‚óè E, J, N, Q, S are shadow roots. <br>  ‚óè I, M, P, R, and U content inclusion points. <br><br>  This tree of trees consists of the following six trees: one document tree and five shadow trees: <br>  ‚óè Document tree 1. It consists of nodes A, B, C, and D. <br>  ‚óè Shadow Tree 2 contained in B. It includes nodes E, F, G, H, and I. <br>  ‚óè Shadow Tree 3 contained in H. It includes nodes J, K, L, and M. <br>  ‚óè Shadow Tree 4 contained in K. It includes nodes N, O, and P. <br>  ‚óè Shadow Tree 5 contained in O. It includes nodes Q and R. <br>  ‚óè Shadow Tree 6 contained in F. It includes nodes S, T and U. <br><br>  Let's assume that the result of the distribution of this tree is: <br><br>  ‚óè Assignment of the switching points C is [I, M] (C is redistributed) <br>  ‚óè Assignments of the switching points L is [P, R] (L is redistributed) <br>  ‚óè The assignment points of the switch G is [U] <br><br>  In this case, if the event is sent to node D, the event path will be as follows: <br>  [D, C, I, M, L, P, R, Q, O, N, K, J, H, G, U, T, S, F, E, B, A] (Excluding Window) <br><br>  Please note that the algorithm for calculating the event path is designed to achieve the following goals: <br><br>  1. If there is a CENTRAL node in the event path and it has a PARENT in the node tree, the event path will also include the PARENT.  PARENT always appears somewhere after a HELP in the event path. <br>  2. Nodes along the way events form a linear chain of ancestors in each node tree.  No node tree has branch points. <br><br><img src="https://habrastorage.org/files/43e/a3e/a65/43ea3ea65a4340c6b14eb1f827f2f5b1.png"><br>  <i>Fig.</i>  <i>6 In this figure, the number on the left of each node represents the initial position of each node in the event path.</i>  <i>At the parent node, this figure is always greater than that of any of its descendants in each node tree.</i> <br><br>  This suggests that if we focus on one node tree and forget about all the others, the event path will look as if the event occurred only in the node tree in question.  This is an important aspect in the sense that the presence of a shadow tree does not in any way affect the event path within the node tree containing the leading shadow element until the event is stopped in any of the descendant trees. <br>  For example, from the point of view of the document tree 1, the event path should look like this: [D, C, B, A].  From the point of view of the shadow tree 2, the event path should look like [I, H, G, F, E].  Other node trees obey the same rules. <br>  It is also worth noting that if we exclude all points of inclusion and shadow roots from the event path, the result would be equivalent to the containing ancestors of the node in the compiled tree on which the event occurs. <br><br><img src="https://habrastorage.org/files/cbb/b19/2c5/cbbb192c5847436bb9984050434cf709.png"><br><img src="https://habrastorage.org/files/42a/580/63b/42a58063bb2648598b8afc2d02a131f0.png"><br>  <i>Fig.</i>  <i>7 The relationship between the event path and the constructed tree.</i>  <i>The event path used in the example is shown in the figure on the left, and the composed tree is shown on the right.</i>  <i>If we exclude all inclusion points and shadow roots from the event path, the result will correspond to the containing ancestors of node D in the constructed tree.</i> <br><br>  <b>5.4 Event Forwarding</b> <br>  In cases where the event path passes through several node trees, the event information about its target can be adjusted depending on the order in which the encapsulation is processed.  Event forwarding is the process of calculating the corresponding target elements for each ancestor of the node where the event occurs.  A relative target element is the node that most accurately represents the target element of a given ancestor‚Äôs event while maintaining encapsulation. <br>  The redirection algorithm should be used to determine relative goals and consist of the following steps: <br>  Input <br>  CURRENT WAY, event path <br>  CURRENT GOAL, the node on which the event listener is triggered. <br>  Conclusion <br>  RELATIVE PURPOSE, adjusted target element <br>  1. THE TREE OF THE CURRENT GOAL should be the node tree containing the CURRENT GOAL <br>  2. THE ORIGINAL PURPOSE MUST BE THE FIRST ELEMENT IN THE WAY OF THE EVENT <br>  3. TREE OF THE ORIGINAL PURPOSE should be the node tree containing the ORIGINAL PURPOSE <br>  4. The TREE OF THE RELATIVE PURPOSE should be the closest common containing tree of the descendants of the TREE OF THE CURRENT GOAL and the TREE OF THE RELATIVE GOAL. <br>  5. RELATIVE TARGET ELEMENT should be the first node in the EVENT WAY, satisfying the following conditions: <br>  1. The node must be contained in the TREE OF THE RELATIVE TARGET ELEMENT <br>  The redirection process must occur before the event is delivered to the element. <br><br>  <b>5.5 Redirect relatedTarget</b> <br>  Some events have a property relatedTarget <a href="http://w3c.github.io/webcomponents/spec/shadow/">[DOM-Level-3-Events]</a> , which contains a node that is not the purpose of the event, but related to it. <br>  For example, for a mouseover event, relatedTarget may point to the node from which the mouse pointer moved to the current element.  In the case when relatedTarget is in a shadow tree, the corresponding user agents should not allow leakage of its actual value beyond the limits of this tree.  In cases where both the relatedTarget and the target belong to the same shadow tree, the corresponding user agents must stop the events in the shadow root to avoid the appearance of side mouseover and mouseout events from the same node at the same time. <br><br>  Thus, if an event has a relatedTarget property, its value and the element that it must match must be adjusted. <br>  The relatedTarget redirection process must occur before the event is delivered to the element. <br><br>  <b>5.6 Forwarding touch events</b> <br>  The Touch target attribute [TOUCH EVENTS] should be adjusted in the same way as an event with a relatedTarget.  Each Touch target attribute in the TouchList list returned by a call to TouchEvent touches (), changedTouches (), and targetTouches () must be the result of executing the relative target calculation algorithm with the KNOT and Touch target as input data. <br><br>  <b>5.7 Redirect Focus Events</b> <br>  The focus, DOMFocusIn, blur, and DOMFocusOut events must be handled in the same way as events with relatedTarget, where a node loses focus as a result of receiving this focus by another node or event target element, which causes the node that has lost focus to become a relative target. with respect to the node that received it. <br><br>  <b>5.8 Event Transfer</b> <br>  At the time of the transfer event: <br><br>  ‚óè The Event target and currentTarget attributes should return a relative target for the node on which the event listeners fired. <br>  ‚óè The MouseOvent relatedTarget attribute of the event must return the corrected relative target <br>  ‚óè The offsetX and offsetY attributes of the MouseEvent event should return the value of the origin point of the relative target, taking into account the internal indents. <br>  ‚óè The Touch target attribute must return the adjusted relative target. <br>  ‚óè If relatedTarget and target are the same element for a given node, event listeners should not work on it.  TouchEvent does not obey this rule. <br>  ‚óè If a node is its own relative goal, event listeners should not operate on it during the capture phase, which entails step 6 of the event transmission algorithm. <br>  ‚óè If the node where the event listener was triggered is its own relative target, the eventPhase attribute of the event should return AT_TARGET during the ascent phase, which entails step 9 of the event transmission algorithm. <br>  ‚óè If the value of the bubbles attribute of the event is false, the following should be done: <br>  1. The event path must be sorted in reverse order. <br>  2. The value of the eventPhase event attribute must be set to AT_TARGET <br>  3. For each object in the event path, whose relative goal is equal to the object itself, the event listener must be called with the event itself as an argument until the event stop flag is disabled <br>  After the event transfer is completed, the target and currentTarget event objects must indicate the relative target of the highest parent. <br>  This step is necessary in order to avoid detection of nodes in the shadow tree, since it is possible for the script to transfer the event object beyond its scope. <br><br>  <b>5.9 Example of event redirection</b> <br>  <i>This section is non-standard.</i> <br> ,     , ,       .      ,              ,   .               : <br> <b> 1</b> <br><br><img src="https://habrastorage.org/files/317/44f/99a/31744f99ae6d4f7688cb17775d312bab.png"><br><br> ,          (#volume-slider-thumb),    mouseover   .          relatedTarget. <br>   ,        : <br>  (Ancestor)   (Relative Target) <br><img src="https://habrastorage.org/files/bdd/267/776/bdd2677768984d4f8787882f3c9db338.png"><br><br>    mouseover     ,         (#timeline-slider-thumb).    mouseout      mouseover  . <br>  ,      relatedTarget  mouseout .   , relatedTarget     (#timeline-slider-thumb).     ,        ,     : <br>  (Ancestor)   (Relative Target)    (Adjusted related Target) <br><img src="https://habrastorage.org/files/77f/0e4/f00/77f0e4f0024446c5bb44d8f5c28f2d7e.png"><br> , #player,   target  relatedTarget     (#player),    ,          . <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">6. User interaction</font></font></b> <div class="spoiler_text"> <b>6.1   </b> <br> <i>   .</i> <br>  <a href="http://w3c.github.io/webcomponents/spec/shadow/">[</a> ]  .       .    , ,  ,  : <br>   ,    ,       ,       DOM,    . <br> ,         ,       . ,    window.getSelection()     ,     . <br>     getSelection()       . <br><br> <b>6.2  </b> <br>       ,        [CSS3UI]. <br>     ,                  : <br> 1.      ,   <br> 2.            : <br> 1.   ,   ‚Äî focusable;  or <br> 2.             . <br>     ,              . <br><br> <b>6.3  </b> <br>   ,   activeElement  focus API     .        ,        activeElement        . <br>            activeElement,      : <br> <b></b> <br>  (ELEMENT),   <br> ,     <br>  <b>Conclusion</b> <br>  (ADJUSTED),   activeElement . <br> 1.             null     <br> 2.                <br><br> <b>6.4 </b> <br>   contenteditable           . <br><br> <b>6.5  </b> <br>           ,          WAI-ARIA [WAI-ARIA]   . <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">7. HTML Elements in Shadow Trees</font></font></b> <div class="spoiler_text"> <b>7.1  HTML    </b> <br>  ,       -          .    ,         .               .  , HTML    ,   [HTML]   ,   . <br><br> <i> [HTML],  HTML     ,      ,     ,                     .  ,    ,      ,       .    ,   ,   HTML      ,    ,  ,      .     W3C 26365  27406.        .         HTML    .  HTML    ,           .     [HTML]  ,       .</i> <br><br> HTML     : <br> ‚óè     <br> ‚óè  HTML ,     ,       ,         ,   ,      . <br> ‚óè  HTML      : <br> ‚óã dialog <br> ‚óã iframe <br> ‚óã style <br> ‚óè    : <br> ‚óè  HTML ,     ,         ,      .      HTML        <br> ‚óè  HTML      : <br> ‚óã base <br> ‚óã link <br> ‚óè    ,   : <br> ‚óè  HTML ,     ,            ,     .  ,       ,    ‚Äî ,     . <br> ‚óè  HTML      : <br> ‚óã applet <br> ‚óã embed <br> ‚óã object <br><br> <i>, ,   object       ,       ‚Äî . ,           ,         ,    ‚Äî .  ,   ,     .</i> <br> <b>7.2 </b> <br>  [HTML]   ,      ,     . <br> ‚óè dir <br> ‚óè draggable <br> ‚óè dropzone <br> ‚óè hidden <br> ‚óè lang  xml:lang <br> ‚óè spellcheck <br> ‚óè title <br><br> <i>    ,   -    .   : <br> ‚óè tabindex  autofocus    . <br> ‚óè role  ARIA    .</i> <br></div></div><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">8. Elements and DOM interfaces. </font><font style="vertical-align: inherit;">Examples of Shadow Dom.</font></font></b>  <b class="spoiler_title">Links</b> <div class="spoiler_text"> <b>8.1  ShadowRoot</b> <br>  ShadowRoot   . <br><img src="https://habrastorage.org/files/4c3/213/e1a/4c3213e1a8db40f7bac3d58cf54756e6.png"><br><br> <b>8.1.1 </b> <br> activeElement : Element, readonly, nullable <br>       . <br>        ,     ,    . <br><br> host : Element, readonly <br>     ,    <br>          ,   . <br><br> innerHTML : DOMString, <br>    ShadowRoot. <br>            HTML      shadow host. <br><br>       : <br> 1.         [DOM-PARSING]            shadow host <br> 2.       . <br><br> olderShadowRoot : ShadowRoot, readonly, nullable <br>          <br>       StyleSheetList,     . <br><br> <b>8.1.2 </b> <br> caretPositionFromPoint <br><br>       ,  caretPositionFromPoint <a href="http://w3c.github.io/webcomponents/spec/shadow/">[CSSOM-VIEW]</a> .        CSSOM View Module [CSSOM-VIEW].    <a href="https://www.w3.org/Bugs/Public/show_bug.cgi%3Fid%3D27829">W3C 27829. <br></a> <br><img src="https://habrastorage.org/files/b4b/1ef/ac5/b4b1efac57ea4f6087e2464e5512c055.png"><br>   : CaretPosition, nullable <br><br> elementFromPoint <br>      . <br><br> <i>       CSSOM View Module <a href="http://w3c.github.io/webcomponents/spec/shadow/">[CSSOM-VIEW]</a> .    <a href="https://www.w3.org/Bugs/Public/show_bug.cgi%3Fid%3D27829">W3C 27829</a> .</i> <br><br>        : <br> 1.    ‚Äî   ShadowRoot ‚Äî   InvalidNodeTypeError. <br> 2.  -  , x       (  ),   y       (  ),  null. <br> 3.       x  y    ,     <br> 4.             null     <br> 5.               <br><br><img src="https://habrastorage.org/files/cac/c27/56d/cacc2756da204679adee241c9db186f1.jpg"><br><br>   : Element, nullable <br> elementsFromPoint <br> <i>      ,  elementFromPoint.        CSSOM View Module <a href="http://w3c.github.io/webcomponents/spec/shadow/">[CSSOM-VIEW]</a> .    <a href="https://www.w3.org/Bugs/Public/show_bug.cgi%3Fid%3D27829">W3C 27829</a> .</i> <br><br><img src="https://habrastorage.org/files/c34/ea8/5dd/c34ea85dda944822b4bf1a3d424735cd.jpg"><br>   : getSelection <br>      . <br>        . <br> <i> .</i> <br>   : Selection, nullable <br>  nodeType  ShadowRoot   DOCUMENT_FRAGMENT_NODE.   nodeName  ShadowRoot   "#document-fragment". <br>   cloneNode()  ShadowRoot     DATA_CLONE_ERR. <br><br> <b>8.2   Element</b> <br><img src="https://habrastorage.org/files/d2d/13e/306/d2d13e3066d94f2e9b999d1adf781ea8.jpg"><br><br> <b>8.2.1 </b> <br> shadowRoot : ShadowRoot, readonly, nullable <br>     ,    . <br>          ,    ,      .    null. <br><br> <b>8.2.2 </b> <br> createShadowRoot <br>       : <br> 1.     ShadowRoot,    . <br> 2.   ShadowRoot              <br> 3.   ShadowRoot. <br> <i> .</i> <br>   : ShadowRoot <br> getDestinationInsertionPoints <br>       NodeList,           ,         . <br> <i> .</i> <br>   : NodeList <br><br> <b>8.3   Text</b> <br> partial interface Text { <br> NodeList getDestinationInsertionPoints (); <br>  }; <br> <b>8.3.1 </b> <br> getDestinationInsertionPoints <br>       NodeList,           ,         . <br> <i> .</i> <br>   : NodeList <br><br> <b>8.4  content</b> <br>  content     . <br>   content     ,           HTMLUnknownElement. <br>  <b>Context</b> <br>     . <br> <b> </b> <br>  <br> <b></b> <br>  ,     <br> <b> </b> <br>   <br> select,  ,   <br><br>           .      . <br><br> <b>DOM </b> <br><br><img src="https://habrastorage.org/files/4e2/7e2/a23/4e27e2a23b09454a9ea6202f30d87e70.jpg"><br><br> <b></b> <br> select : DOMString, <br>    select. <br> <b></b> <br> getDistributedNodes <br>        : <br> 1.    ‚Äî   : <br> 1.   NodeList   ,    ,        . <br> 2. : <br> 1.    NodeList. <br>  . <br>   : NodeList <br><br> <b>8.5  shadow</b> <br>  shadow        . <br>   shadow     ,           HTMLUnknownElement. <br>  <b>Context</b> <br>     . <br> <b> </b> <br>  <br> <b></b> <br>  <br><br> <b> Shadow DOM</b> <br><br>         ,       :     .     : <br><br><img src="https://habrastorage.org/files/0dd/fc0/504/0ddfc050481244d1a07d33e94af3d7d5.jpg"><br><br>        DOM.        ,             .    Green Eye,      ,    ul: <br><br><img src="https://habrastorage.org/files/692/506/9d3/6925069d36f741a78c802ee90e3628fa.jpg"><br><br>            ,      : <br><br><img src="https://habrastorage.org/files/dd9/30c/c99/dd930cc99f324d08821412210d273e37.jpg"><br><br>   ,       ,     : <br><br><img src="https://habrastorage.org/files/5bd/0ac/c3a/5bd0acc3aed8480d8e8fe8377cfeea04.jpg"><br><br> , !   - ,    .   ,        Puyo Puyo. <br>   . <br>  .     ,     , ,    ,    ,    .    ,        , ,     ,    ,  .             ,  : <br><br><img src="https://habrastorage.org/files/780/e77/2d4/780e772d4a6c4206b80ba7eee92f2a8a.jpg"><br><br>   shadow              . ¬´, , ,        ,       ¬ª, ‚Äî ,  . <br><br>  <b>Links</b> <br><br> <b>[CSS21]</b> <br> Bert Bos; Tantek √áelik; Ian Hickson; H√•kon Wium Lie et al. <a href="http://www.w3.org/TR/CSS2">Cascading Style Sheets Level 2 Revision 1 (CSS 2.1) Specification.</a> 7 June 2011. W3C Recommendation. <br> <b>[CSS3UI]</b> <br> Tantek √áelik; Florian Rivoal. <a href="http://www.w3.org/TR/css-ui-3/">CSS Basic User Interface Module Level 3</a> (CSS3 UI). 7 July 2015. W3C Candidate Recommendation. <br> <b>[CSSOM-VIEW]</b> <br> Simon Pieters; Glenn Adams. <a href="http://www.w3.org/TR/cssom-view/">CSSOM View Module.</a> 17 December 2013. W3C Working Draft. <br> <b>[DOM]</b> <br> Anne van Kesteren; Aryeh Gregor; Ms2ger; Alex Russell; Robin Berjon. <a href="http://www.w3.org/TR/dom/">W3C DOM4</a> . 18 June 2015. W3C Last Call Working Draft. <br> <b>[DOM-Level-3-Events]</b> <br> Gary Kacmarcik; Travis Leithead. <a href="http://www.w3.org/TR/uievents/">UI Events (formerly DOM Level 3 Events)</a> . 28 April 2015. W3C Working Draft. <br> <b>[DOM-PARSING]</b> <br> Travis Leithead. <a href="http://www.w3.org/TR/DOM-Parsing/">DOM Parsing and Serialization.</a> 17 June 2014. W3C Candidate Recommendation. <br> <b>[EDITING]</b> <br> Aryeh Gregor. <a href="https://dvcs.w3.org/hg/editing/raw-file/tip/editing.html">HTML Editing APIs.</a> <br> <b>[HTML]</b> <br> Ian Hickson. <a href="https://html.spec.whatwg.org/multipage/">HTML Standard. Living Standard.</a> <br> S. Bradner. <a href="https://tools.ietf.org/html/rfc2119%2520%2520%5BSELECTORS4%5D">Key words for use in RFCs to Indicate Requirement Levels.</a> March 1997. Best Current Practice. <br> <b>[SELECTORS4]</b> <br> Elika Etemad; Tab Atkins Jr‚Ä¶ <a href="http://www.w3.org/TR/selectors4/">Selectors Level 4.</a> 2 May 2013. W3C Working Draft. <br> <b>[TOUCH-EVENTS]</b> <br> Doug Schepers; Sangwhan Moon; Matt Brubeck; Arthur Barstow. <a href="http://www.w3.org/TR/touch-events/">Touch Events.</a> 10 October 2013. W3C Recommendation. <br> <b>[WAI-ARIA]</b> <br> James Craig; Michael Cooper et al. <a href="http://www.w3.org/TR/wai-aria/">Accessible Rich Internet Applications (WAI-ARIA) 1.0.</a> 20 March 2014. W3C Recommendation. <br><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/262017/">https://habr.com/ru/post/262017/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262007/index.html">Phalcon 2.0.4 release</a></li>
<li><a href="../262009/index.html">Teach telnet.exe to play the correct MUDs</a></li>
<li><a href="../262011/index.html">The first steps in working with Arduino</a></li>
<li><a href="../262013/index.html">Critical security update for node.js and io.js</a></li>
<li><a href="../262015/index.html">The mystery of flicker noise unraveled</a></li>
<li><a href="../262019/index.html">The first acquaintance with the coprocessor Intel Xeon Phi</a></li>
<li><a href="../262021/index.html">Creating the simplest data structures using functions in Python</a></li>
<li><a href="../262023/index.html">Entity Framework through the eyes of a stranger</a></li>
<li><a href="../262025/index.html">Cohort analysis: 3 cases</a></li>
<li><a href="../262027/index.html">UNetLab emulator - revolutionary leap</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>