<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Iphone, do not lag. Part 1: multithreading for practitioners</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="My name is Max, and I‚Äôm an alcoholic who have been developing iOS for over 7 years now. 

 In the wake of the job seekers, I‚Äôll say that I regularly c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Iphone, do not lag. Part 1: multithreading for practitioners</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/dt/qm/q-/dtqmq-s7csync0fglool12gmwso.png" height="400"></div><br>  My name is Max, and I‚Äôm an <s>alcoholic who have</s> been developing iOS for over 7 years now. <br><br>  In the wake of the <a href="https://habrahabr.ru/post/352246/">job seekers,</a> I‚Äôll say that I regularly conduct interviews with mobile developers for companies. <br><br>  Among the candidates there are cadres who smoke hookah right on the Skype interview, try to google questions on the go, want a ZP 180k for 3 months of experience, behave as if the gop-stopped me on the street (with the appropriate terminology) and so on. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But in most cases, even with adequate middle specialists, there is a common gap: the lack of understanding of the principles of asynchronous task execution and hardware acceleration in iOS. <br><br>  In this article, I decided in simple words to tell about the use of multithreading in iOS, so that after the first reading it was possible to easily and fully understand the use of this knowledge in practice. <br><br>  (If too lazy to read, then attached <a href="https://www.youtube.com/watch%3Fv%3Dw_42TFPmdZY">video</a> ) <br><a name="habracut"></a><br>  There will be two materials, one dedicated to multithreading (this one), and the second in hardware acceleration: how to evenly distribute the load between the CPU and the GPU in order to get a perfectly-smooth interface. <br><br>  For those who are interested not only to learn how to apply the techniques, but also to comprehend Zen, there is <a href="https://habrahabr.ru/post/320152/">an excellent article</a> .  It is, however, still for Swift 3, but the essence has not changed during this time. <br><br><div class="spoiler">  <b class="spoiler_title">SHOCK!</b>  <b class="spoiler_title">The true causes of lags!</b> <div class="spoiler_text">  As one <i>expert</i> told me at the interview: the application is slowed down due to the fact that the signal from the server cannot go faster than the speed of light.  And in this gap, everything lags. <br>  So, physics, you heartless bastard.  The mystery is revealed, we diverge. <br></div></div><br><h3>  Brief practical theory </h3><br>  A practical theory is such a theory, without which you are not a result-oriented practitioner, but simply an uneducated savage. <br><br>  And before you start fantasizing about asynchrony, threads, and other wisdoms, you need to answer the question: why do you need to parallelize something?  Here is the main thread, why not turn everything on it?  I hope for many the obvious answer: because everything will slow down, ale. <br><br>  And why is the main stream so special then?  Its exclusivity is that all interaction with the application from the outside takes place on it: touch processing, notifications, system messages and so on. <br><br>  And the main thing in our case is that the whole responder chain hangs on main thread: <br>  UIApplication -&gt; UIWindow -&gt; UIViewController -&gt; UIView. <br><br><img src="https://habrastorage.org/webt/pn/i1/zl/pni1zl31xn2yxup8sknoubmn-lu.png"><br><br>  All clicks on the screen, all user interaction, come exactly there. <br><br>  But okay, let the pressure be processed on the main thread, but, damn it, Apple, why can't I, like Clint Eastwood, draw with two hands? <br><br>  Yes, because to communicate several threads, you will have to smear a thick layer of gizmos for synchronization, and this is all unnecessary junk and pressure on already scanty resources.  Apple even introduced Main Thread Checker to help avoid any exotic bugs caused by inhuman treatment of the main thread. <br><br>  In general, the first rule is to leave main thread for UI, and UI for main thread. <br><br>  Well, where, then, do the rest? <br><br>  IOS has a lot of tools for this purpose: threads, posix threads, gcd, operation queue. <br>  Everyone has their own use, but in everyday life, consisting of banal tasks of the type: go to the server, bring, save and display, enough gcd and operation queue. <br><br>  <a href="https://developer.apple.com/documentation/dispatch">GCD</a> is an Apple library for performing tasks in parallel.  It consists of performed operations (tasks) and queues that contain these same operations.  The most banal FIFO collection with taskey.  Of course, there are still a lot of options, but we do not need them yet. <br><br>  <a href="https://developer.apple.com/documentation/foundation/nsoperationqueue">NSOperationQueue</a> is the same queue, only high-level and OOP oriented.  And in fact, just a beautiful wrapper over gcd, it does not have any functional advantages, although it did before. <br><br>  The choice between the two, in most cases, depends on taste, with rare exceptions.  Work with what you prefer.  Personally, I prefer gcd because of better handling and the lack of an additional overhead projector. <br><br>  By the way, among developers, such obscurantism has often occurred that the alleged NSOperationQueue is no longer based on GCD, but has been specially reworked for iOS and therefore faster / higher / stronger.  But this is not the case, I will quote an apple: <a href="https://developer.apple.com/documentation/foundation/nsoperationqueue">Apple</a> : <br><br><img src="https://habrastorage.org/webt/ei/bv/r1/eibvr1u2my9mqkmt3ui_m6seoma.png"><br><br>  So NSOperationQueue has no special advantages over GCD. <br><br><h3>  Priorities GCD &amp; NSOperationQueue </h3><br>  Run through the main components. <br><br>  Each queue has such a concept as the priority with which it receives resources.  This is called quality of service, most often used with the abbreviation 'qos' or quality of service. <br>  The higher the priority, the faster and more CPU time is allocated for tasks on this queue.  Yes, yes, it is also faster, you heard right.  The system can optimize processor wake-up, thereby saving energy.  This is useful to remember if you are working with low power mode when the user has a battery. <br><br>  So I want the Yandex.Taxi authors to find out.  After all, you can save the battery in such a simple way, and not to arrange the "mining of bitcoins" on my iPhone. <br><br>  What are the priorities?  There are several of them and we must remember everything so that it does not endlessly hurt.  But many say that it is supposedly not being sanctified anywhere, and the type is not at all necessary. <br><br>  And so priorities: <i>userInteractive</i> , <i>userInitiated</i> , <i>default</i> , <i>utility</i> and <i>background</i> . <br><br>  Main does not consider, because it is not a priority, but a separate queue for the main thread.  She, by the way, also has a priority: userInteractive.  So, for example, by running shamanism with pictures in a separate queue with userInteractive priority, you will receive non-illusion logs, because the race for resources will begin.  Smaller problems than just running in main, but more difficult to debug, because the lags will be intermittent. <br>  (there are still unspecified, but this is generally wild, with which you are unlikely to ever come across) <br><br>  If you want to understand exactly how the transfer of operations takes place between the queues - the above cited a link to the article. <br><br>  So when what to use? <br><br><ul><li>  <b>userInteractive</b> - no need to apply at all.  It is tacitly reserved by the main thread, as I wrote above.  Apple defines its application spectrum as: operations that are critical for user interaction, taking no more than a fraction of a second.  Sounds like a UI thing, doesn't it?  In practice, I had only one task, which was to compete with the interface in speed and requiring surgical precision, but it was not solved via gcd.  In short, userInteractive is for the gods from Apple, and not simple hard workers like us. </li><li>  <b>userInitiated</b> - local operations that require instant results.  For example, saving something to the database before moving to the next screen.  But, at the same time, it does not block UI.  I especially emphasize that it is local operations.  The network is not included here. <br><br>  Suppose you twist the download indicator in the middle of the screen and you need to do something urgently to show the content.  Obviously, this cannot be done on the main stream, because gui will start to fail, but there is no point in throwing too deep into the background, because from the entire interface one single twist turns.  In this case, userInitiated is used. </li><li>  <b>default</b> is the default priority.  Apple disagrees with itself, in the documentation saying that it is not necessary to use it, but on the WWDC, on the contrary, states that this is the best priority for downloading pictures and other network communications.  Having played with different QoS, I can say that default is best suited for downloading images or small files that affect the user's perception of the application.  The difference between utlity (the next level) and default is really felt when working with images, especially when rendering.  <b>Default</b> works much faster, but it does not compete with the interface for resources.  My recommendation is to keep all network business logic and images defaulted. </li><li>  <b>utility</b> - something not very high priority, but still necessary in the near future.  For example, processing bulky files or complex database manipulations, media conversion and so on.  Simply put, when you need to do an urgent task for the application, but where a couple of extra seconds of waiting will not play a role.  By the way, such operations are the first candidate for transferring to background mode when working with lower power mode. </li><li>  <b>background</b> - the most vegetable mode of all.  As they say, for those who have known life and are not in a hurry.  It is worth using when saving energy, or for ultra-heavy operations.  Type of loading of fat files, backups and more.  And if suddenly the user turned on lower power mode, and your operation was already in the background priority, then maybe well, it nafig right away, eh? </li></ul><br><h3>  Practice in the real world </h3><br>  Speaking of application, if you use a third-party framework for a task, then most of the tools do the work on the queue with which they were called, or support its explicit mention.  If it did not work out in 5 minutes to find a way to explicitly specify a priority, then it is easier to simply wrap the operation in dispatch_async and not worry. <br><br>  Most importantly, note that often callbacks are called on the main thread for some historical reasons.  Sometimes you make a request with default qos, and then you pull the save to the base in the completion block, forgetting that you're already at home.  And scratching a turnip, why this application is barely going. <br><br>  So if there is no certainty, then we set breakpoint in the block and look at the call stack.  In such moments it is better to double-check than to look for lags through the profiler.  I like to ask about the profiler during the interviews. <br><br>  Main thread: <br><br><img src="https://habrastorage.org/webt/yy/zc/ak/yyzcak26jtmmp6t-0myt22tak6w.png"><br><br>  Any other: <br><br><img src="https://habrastorage.org/webt/3c/o8/du/3co8duwixierpuuirv1v-obnpac.png"><br><br>  In general, be sure to pay attention to what the flow is action.  Save a lot of time and nerves later. <br><br>  One more nuance that arises when you drop by asynchrony: but how much should you put into separate operations?  Where is the border?  What are the consequences? <br><br>  Philosophically, if something is asynchronous, then it can be asynchronous.  But we will approach more pragmatically: if your application is made up of a multitude of pre-second operations, then you should first think whether these trivialities can be merged into some larger task?  If you produce a separate operation for each sneeze, then there will be only more lags. <br><br>  For example: we have a certain table with products in the store.  Each cell is a price, avatar, multi-line description.  The price is localized (the symbol of the ruble + formatting), the description too (it has a certain prefix verbal).  As a rule, the compilation of a localized string is done right at the moment of setting the values ‚Äã‚Äãin the corresponding labels. <br><br>  But you can asynchronously do this?  We first localize in the background, and then put in the label. <br>  So, this is a bad decision.  The best option would be for each object of the product to compile localized values ‚Äã‚Äãimmediately after a request to the server, writing data into the appropriate fields of the entity. <br><br>  Especially useful will be the size of these same fields in advance to calculate, writing to the model.  Yes, this is normal, despite the fact that it looks unusual. <br><br>  In our team, this practice has long been adopted - to calculate the height of cells obviously when receiving data from the server, saving them to the database.  Or in the array, if you do not use the database, if only it happened previously and in the background.  It is better to let your user see the spinning twist for a fraction of a second than to admire the friezes. <br><br>  And no need to worry about the storage capacity.  In the current reality, any memory on the iPhone is a cheap resource, and processor time is expensive.  It is worth remembering. <br><br>  <b>Conclusion</b> : prepare the data for the interface in advance.  So cheaper and more beautiful. <br><br>  And since you‚Äôve already half forgotten, here are the questions you should ask yourself to stop writing nonsense: <br><br><ol><li>  Is it possible to make an operation in advance in the background and cache the result? </li><li>  Which priority is better for the task? <br><ul><li>  <b>userInitiated</b> : small and urgent actions </li><li>  <b>utility</b> or <b>default</b> : network tasks, rendering </li><li>  <b>background</b> : long processes </li></ul></li><li>  On which thread callbacks are called?  Is there too much load on the main thread?  (you can easily check through the callpoint on breakpoint) </li></ol><br>  In the next series we will discuss hardware acceleration.  It sounds scary, but it will be easy. <br><br>  <b>PS</b> I would be grateful to any feedback on the video.  The first experience, for every minute it took an hour literally. </div><p>Source: <a href="https://habr.com/ru/post/343274/">https://habr.com/ru/post/343274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343264/index.html">Cross pollination: manage Linux from under Windows, and vice versa</a></li>
<li><a href="../343266/index.html">Reliable infrastructure for a cloudy b2b startup</a></li>
<li><a href="../343268/index.html">"Automatic Spam Detector". Or "What were Hemingway, Huxley, and Postman warned about?"</a></li>
<li><a href="../343270/index.html">Continuous integration, continuous delivery, continuous deployment: just a nested doll</a></li>
<li><a href="../343272/index.html">Contracts are like debugging.</a></li>
<li><a href="../343276/index.html">Solving Memory Misuse Problems in Node.js</a></li>
<li><a href="../343278/index.html">How we control the quality of the code in the Android Browser. Yandex lecture</a></li>
<li><a href="../343282/index.html">How data centers work: today and tomorrow</a></li>
<li><a href="../343284/index.html">Interview with the main digital strategist Adblock Plus: ‚ÄúWell, I sleep well, Burumych, great!‚Äù</a></li>
<li><a href="../343286/index.html">How high-frequency trading changed the situation on world markets: 4 conclusions of analysts at Credit Suisse</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>