<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Java time machine</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the world there are many cool little libraries that are not famous, but very useful. The idea is to slowly acquaint Habr with such things under the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Java time machine</h1><div class="post__text post__text-html js-mediator-article"><p>  In the world there are many cool little libraries that are not famous, but very useful.  The idea is to slowly acquaint Habr with such things under the <a href="https://habrahabr.ru/search/%3Fq%3D%255Bjavalifehacker%255D%26target_type%3Dposts">#javalifehacker</a> tag.  Today we will talk about <a href="https://github.com/Devexperts/time-test">time-test</a> , in which there are only 16 commits, but they are enough.  The author of the library is <a href="https://twitter.com/nkoval_">Nikita Koval</a> , and this is a translation of his article, originally written <a href="https://blog.devexperts.com/time-machine-for-java">for the blog Devexperts</a> . </p><br><p>  It is not easy to write unit tests for time-bound functionality.  Sometimes you can take a time-returning method and replace its implementation with a test code.  But for testing real applications this is not enough.  Let's see why this solution may not work and what is really needed to test the time. </p><br><p><img src="https://habrastorage.org/webt/kt/qi/mq/ktqimqrpausrp9fpi9mdbrqa7no.png"><br></p><br><p>  Here is the simplest method that counts the number of days until the end of the world: </p><br><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">fun</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">daysBeforeDoom</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> doomTime - System.currentTimeMillis()) / millisInDay }</code> </pre> <a name="habracut"></a><br><p>  Most likely, to test it, it is enough to simply substitute all <code>System.currentTimeMillis()</code> calls using existing tools ( <a href="https://github.com/TOPdesk/time-transformer-agent/">one</a> , <a href="https://stackoverflow.com/questions/2001671/override-java-system-currenttimemillis-for-testing-time-sensitive-code">two</a> ) or writing code transformations on <a href="http://asm.ow2.org/">ASM</a> or <a href="https://www.eclipse.org/aspectj/">AspectJ</a> (if you need some kind of specialized behavior). </p><br><p>  But there are cases when this approach is not enough.  Imagine that we are writing an alarm clock that wakes up every day and displays the message: ‚ÄúThere are &lt;N&gt; days left until the end of the world‚Äù: </p><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-type"><span class="hljs-type">Thread</span></span>.sleep(<span class="hljs-type"><span class="hljs-type">ONE_DAY</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">println</span></span>(<span class="hljs-string"><span class="hljs-string">"${daysBeforeDoom()} days left till the doomsday"</span></span>) }</code> </pre> <br><p>  But how to test this code?  How to check that it is really executed every day and displays the correct message?  Using the simplest approach from the example above and replacing <code>System.currentTimeMillis()</code> , you can check the correctness of the message and only.  But to test the correctness of the schedule, you will have to wait a whole day. </p><br><p>  Thus, it is almost impossible to test such code without using additional tools.  So let's write them! </p><br><p>  So, there are two methods that return time: <code>System.currentTimeMillis()</code> and <code>System.nanoTime()</code> .  In addition, there are several synchronization methods with the ability to specify the maximum wait time: <code>Thread.sleep(..)</code> , <code>Object.wait(..)</code> and <code>LockSupport.park(..)</code> . </p><br><p>  To manage time, I want to do some <code>increaseTime(..)</code> method that changes the virtual time and wakes up the necessary flows. </p><br><p>  This can be achieved if all methods that work with time are replaced by test implementations.  Let's take a look at how this might work. </p><br><p>  Test example: </p><br><pre> <code class="hljs lisp">increaseTime(<span class="hljs-name"><span class="hljs-name">ONE_DAY</span></span>) checkMessage()</code> </pre> <br><p>  You have probably already noticed that this test creates the potential for racing between checking a message and a print operation that is not performed instantly.  Of course, you can try to add a pause. </p><br><pre> <code class="hljs erlang"><span class="hljs-function"><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">increaseTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ONE_DAY)</span></span></span><span class="hljs-function"> T</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">hread</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sleep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">500</span></span></span></span><span class="hljs-function"><span class="hljs-params"> /*ms*/)</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">checkMessage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span></code> </pre> <br><p>  In normal life, this test will almost always work, but there are no real guarantees that <code>checkMessage()</code> will not be called before the message is displayed.  This can happen as a result of increasing complexity of the test logic, or simply when running code on an overloaded server.  There may be a desire to increase the timeout, but this solution will only slow down the tests, and there will still be no guarantee of correctness. </p><br><p>  Instead, we need a special method that waits until all awakened threads do their job. </p><br><p>  Ideally, I would like to write this test: </p><br><pre> <code class="hljs lisp">increaseTime(<span class="hljs-name"><span class="hljs-name">ONE_DAY</span></span>) waitUntilThreadsAreFrozen(<span class="hljs-number"><span class="hljs-number">1</span></span>_000/*ms, timeout*/) checkMessage()</code> </pre> <br><p>  Thus, we need to support not only the virtualization of time-dependent methods, but also the <code>waitUntilThreadsAreFrozen</code> method, which is not easy at the same time. </p><br><p>  Working in Devexperts, Nikita wrote a tool called <a href="https://github.com/Devexperts/time-test">time-test</a> , which solves this problem.  Let's see how it works. </p><br><p>  Time-test is written as a Java agent.  To use it, add the <code>-javaagent:timetest.jar</code> and put it in the classpath.  This tool transforms the bytecode and replaces all methods that work with time with the challenges of their implementations.  Writing a good java agent is often not an easy task, so Nikita developed the <a href="https://github.com/Devexperts/jagent">JAgent</a> framework, which simplifies this matter. </p><br><p>  When creating tests, you need to enable <code>TestTimeProvider</code> .  It implements all the necessary methods (including <code>System.currentTimeMillis()</code> , <code>Thread.sleep(..)</code> , <code>Object.wait(..)</code> , <code>LockSupport.park(..)</code> , etc., and overrides their normal implementation.  In most tests, there is no need for direct time management used in the underlying implementation.  Therefore, until you connect TestTimeProvider, the tool continues to use the default implementations of the above methods, wrapping them in your own code.  After connecting <code>TestTimeProvider</code> , it becomes possible to use the <code>TestTimeProvider.setTime(..)</code> , <code>TestTimeProvider.increaseTime(..)</code> and <code>TestTimeProvider.waitUntilThreadsAreFrozen(..)</code> . </p><br><p>  <code>TimeProvider.java</code> : </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">timeMillis</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">long</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">nanoTime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sleep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> millis)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sleep</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> millis, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nanos)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object monitor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> millis)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">waitOn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object monitor, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> millis, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nanos)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> InterruptedException</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notifyAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object monitor)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">notify</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object monitor)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">park</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isAbsolute, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">long</span></span></span></span><span class="hljs-function"><span class="hljs-params"> time)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">unpark</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Object thread)</span></span></span></span>;</code> </pre> <br><p>  As it was written above, the main problem with the implementation of <code>TestTimeProvider</code> is simultaneous support for both methods for working with time and <code>waitUntilThreadsAreFrozen(..)</code> .  Therefore, for each time change, all the necessary threads are initially marked as working, and only then wake up.  At the same time, <code>waitUntilThreadsAreFrozen(..)</code> waits until all threads are in a waiting state so that none of them will be marked as working.  Within the framework of this approach, threads wake up, reset their mark, perform the task and return to the waiting state - and only then <code>waitUntilThreadsAreFrozen(..)</code> will understand that they have completed. </p><br><p>  What a test looks like using <code>TestTimeProvider</code> : </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setup</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">// Use TestTimeProvider for this test TestTimeProvider.start(/* initial time could be passed here */); } @After public void reset() { // Reset time provider to default after the test execution TestTimeProvider.reset(); } @Test public void test() { runMyConcurrentApplication(); TestTimeProvider.increaseTime(60_000 /*ms*/); TestTimeProvider.waitUntilThreadsAreFrozen(1_000 /*ms*/); checkMyApplicationState(); }</span></span></code> </pre> <br><p>  There is another difficulty with the virtualization of time.  The described approach works well if you need to control time throughout the entire JVM.  But you usually want to avoid affecting your testing library (such as JUnit), the garbage collector thread, and other things that are not directly related to the tested code fragment.  Therefore, it is imperative to determine whether we are running in the code under test and whether we should, therefore, virtualize time.  To do this, time-test must know the input points of the code being tested (usually these are test classes).  Then time-test starts tracking new threads launches and marks them as ‚Äútheir own‚Äù, which means that time virtualization will be applied to them.  However, problems may arise if you use <code>ForkJoinPool</code> , since it does not run from the test code, and time-test cannot understand that it is necessary to virtualize time there as well.  To work with structures similar to ForkJoinPool, you need to expand the definition of input points. </p><br><p>  I think it has now become clear that testing the functionality that is working over time may not be such an easy task.  I hope time-test will make your life easier, the <a href="https://github.com/Devexperts/time-test">source code can be picked up on GitHub</a> . </p><br><h1 id="ob-avtore">  about the author </h1><br><p>  Nikita Koval is a research engineer in the dxLab research group of Devexperts.  In addition, he is a student at the Department of Computer Technologies at ITMO, where he also teaches a course on multithreaded programming.  Mainly interested in multi-threaded algorithms, program verification and analysis. </p><br><blockquote>  Minute advertising.  Nikita will come to the <a href="https://habrahabr.ru/company/jugru/blog/349442/">JBreak 2018</a> conference (which will be held in less than two weeks) in the report ‚ÄúTowards a fast multi-threaded hash table‚Äù to tell us about practical approaches to building high-performance algorithms using the full power of multi-core architectures.  There are discussion zones at the conference, so after the report, it will be possible to meet with Nikita and discuss various issues - not only multi-threaded hash tables, but also virtualization of time described in the article.  Tickets <a href="https://2018.jbreak.ru/tickets/">can be purchased on the official website</a> . </blockquote></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/349508/">https://habr.com/ru/post/349508/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../349494/index.html">Ask the creator of Vue.js a question</a></li>
<li><a href="../349496/index.html">Conduit - lightweight service mesh for Kubernetes</a></li>
<li><a href="../349500/index.html">How many developers and how few programmers ...</a></li>
<li><a href="../349502/index.html">Zane Lackey: ‚ÄúYou should not invest in security, just to meet the requirements of the law‚Äù</a></li>
<li><a href="../349504/index.html">tdlib-ruby: how to build a telegram client in ruby</a></li>
<li><a href="../349510/index.html">How we set up Continuous Delivery at Kubernetes using TFS</a></li>
<li><a href="../349512/index.html">Browser! = Browser engine</a></li>
<li><a href="../349514/index.html">Announcement of Serverless Moscow Meetup # 1</a></li>
<li><a href="../349516/index.html">Dagaz: Faster, Better, Smarter ...</a></li>
<li><a href="../349518/index.html">A new version of RMM-solution Panda Systems Management has been released.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>