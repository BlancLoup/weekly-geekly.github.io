<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Some immersion inside the hacked site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It is no secret that most sites these days are not broken manually. There is a large army of bots that search for vulnerabilities in site scripts, bru...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Some immersion inside the hacked site</h1><div class="post__text post__text-html js-mediator-article">  It is no secret that most sites these days are not broken manually.  There is a large army of bots that search for vulnerabilities in site scripts, brute-force CMS admin panels, FTP / SSH accounts, then download small bootloader scripts or backdoors, inject several dozens of ‚Äúagent‚Äù managers into the site scripts, and scatter them randomly directories open for writing, web shells, spam mailers and other malicious php (and sometimes perl) scripts.  From the inside, the infected site looks like this (report fragment from the AI-BOLIT scanner): <br><br><img src="https://habrastorage.org/files/002/9e4/2bf/0029e42bf0194cabbecf619e3a7345fa.png"><br><br>  The patterns of infection (the number, composition and purpose of malicious scripts) may vary.  In this case, infection statistics are as follows: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  41 backdoor insert </li><li>  5 WSO web shells </li><li>  4 scripts that embed malicious code in .php files </li><li>  7 mail () spam mailers </li><li>  2 spam mailers working via SMTP </li><li>  1 backdoor </li><li>  1 script that injects malicious code into wordpress / joomla scripts </li></ul><br>  Among the ‚Äúmalware‚Äù there are all sorts of interesting instances.  But today it is not about them.  It is more interesting to analyze not so much static malicious code in files, as the process of working with ‚Äúmalware‚Äù in dynamics: what requests and in what format do command centers send to the embedded backdoors, with what intensity, with what parameters, etc.  In addition, static analysis works badly for modern malware because some scripts do not contain payloads. <a name="habracut"></a><br><br>  Take the popular backdoor: <br><br><img src="https://habrastorage.org/files/93e/bd0/722/93ebd0722ce44ad38bd5ead62df5bfa2.png"><br><br>  It consists of one or two lines and is used to receive and execute PHP code.  Payload "arrives" in the POST request parameters and is executed at the same moment.  Naturally, the payload code is not stored anywhere, so the dynamic analysis process usually rests on the lack of data: there are no logs with the body of requests that would contain the code under study. <br><br>  To analyze the communication of the command center with its ‚Äúagents‚Äù, you need to log HTTP requests to the malicious script, and for this you need to set up timely logging of the body of the POST request to a file, which is never done on shared hosting.  On dedicated servers, however, POST requests with data are also not logged.  This is due to the saving of server resources and, in general, the lack of need.  But that is not all.  The second problem associated with the analysis of hacking and infection of the site is the late appeal of the owner of the infected site to specialists. <br>  Almost always, "patients" are treated 2-3 weeks after the appearance of the first malicious script.  That is, when the downloaded code has already been implemented, it has ‚Äúfallen asleep‚Äù and begins to be actively exploited by hackers, and the site is blocked by hosting due to spam sending, phishing pages, or attacks on third-party resources.  By the way, the code is ‚Äútracked down‚Äù in order to cover the traces of hacking and not immediately arouse suspicion of the site owner.  Weeks after two rotations of logs do their dirty work, erasing information about how the malicious code was uploaded to the site, and the implemented malware start creating harmful payload: attack other resources, upload to the site doorway pages, spam mailers, implement a code for redirects to bundles of splots, send tons of spam emails with phishing content, etc. <br><br>  But from time to time you still manage to set up logging on the infected site and collect the insights of requests to malicious scripts.  So, what is hidden from prying eyes? <br><br>  It is typical enough for such an infection to introduce a root .htaccess redirect to a pharm affiliate program (selling Viagra, etc.), a wap-click affiliate program (subscribing to media content for SMS) or a malicious resource (for a drive- by attacks or trojan downloads disguised as a flash player or antivirus update). <br><br><img src="https://habrastorage.org/files/d0a/fb7/74a/d0afb774a9dd4d198d7e20c7cb1923a2.png"><br><br>  The redirect in this case is implemented as follows: in the POST request, the php code is transmitted, which is wrapped in base64.  The code is executed using a backdoor on a hacked site and adds its own 404 error handler, in which it throws visitors to the attacker's site.  Moreover, it is enough to have a missing image, script or .css file on any page of the site in order for the visitor to redirect.  Domains to which visitors are redirected, periodically change. <br><br>  Another example of the log of requests to embedded backdoors and downloaded spam mailing scripts: <br><br><img src="https://habrastorage.org/files/8de/480/cd6/8de480cd69d7449e846927cf08d23385.png"><br><br>  Here, too, all data is transmitted in base64 encoding via POST and COOKIE variables.  Moreover, the executable fragments are wrapped twice in base64 encoding, in order to bypass WAFs and web scanners who know about base64 and are able to decode it.  In the decoded version, the request to the backdoor looks like this: <br><br><img src="https://habrastorage.org/files/198/b60/d47/198b60d471724db3bc4db76d0014e9f2.png"><br><br><img src="https://habrastorage.org/files/2c8/984/d9f/2c8984d9fd5c42e09c007c00f27fed96.png"><br><br>  In payload, you crawl directories and inject code that will look for wordpress files in accessible directories and do one of two things: either to insert malicious content into them, or to restore the original content of files (as the command center implements malware for a while or according to schedule) ).  To make it harder to find modified scripts, the modification date (mtime) for files is set by the date that one of the wordpress scripts was modified.  In addition, read-only attributes are set so that inexperienced webmasters cannot edit them (this is really puzzling to many). <br><br>  As for the other ‚Äúpayload‚Äù - spamming - the content is wrapped twice in base64 and passed in the POST parameters of the request to the spam mailer.  And from time to time they can send some verification letters with service information: <br><br><img src="https://habrastorage.org/files/abb/ca0/a53/abbca0a530924510bd5dc49ffadfe73f.png"><br><br>  An interesting observation: if you remove all malicious scripts from the site, then after a few unsuccessful requests, the process of communicating with "agents" stops.  That is, the command center is not trying to immediately re-hack the site and upload backdoors to it, apparently for the same reason - to hide the process of initial loading backdoors.  But if you leave at least one backdoor in the treatment, then through it a whole ‚Äúbundle‚Äù of hacker shells, backdoors and spam mailers will be downloaded again. <br>  Therefore, the site should always be treated very carefully. </div><p>Source: <a href="https://habr.com/ru/post/280516/">https://habr.com/ru/post/280516/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280506/index.html">Don't miss the online Build conference opening tonight (18:30 MCK)</a></li>
<li><a href="../280508/index.html">DevOps section at the DUMP-2016 conference</a></li>
<li><a href="../280510/index.html">What should be the email-list, and why users unsubscribe from them</a></li>
<li><a href="../280512/index.html">Symfony and command bus</a></li>
<li><a href="../280514/index.html">15 steps to improve usability</a></li>
<li><a href="../280518/index.html">Text translation of the Build 2016 conference</a></li>
<li><a href="../280520/index.html">The story of the creation of a classic RTS at home from scratch + analysis of the main stages of development (AI, network, etc.)</a></li>
<li><a href="../280524/index.html">QA: Conference. Many news, new reports, live</a></li>
<li><a href="../280526/index.html">Portal in the service of accounting or automation of expense reports</a></li>
<li><a href="../280528/index.html">The joy and sadness of developing on Qt for Android (and not only)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>