<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Puppet Virtual Resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="It seems to me that the basic meaning of vitrual resources becomes clearer already with specific examples of exported resources ‚Äî when virtual resourc...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Puppet Virtual Resources</h1><div class="post__text post__text-html js-mediator-article">  It seems to me that the basic meaning of vitrual resources becomes clearer already with specific examples of exported resources ‚Äî when virtual resources are placed in the database and used to exchange information between agents, but in order to understand <i>recursion, you need to understand recursion</i> , so let's start with a local application.  For example. <br><br>  The example will be a bit synthetic.  It was difficult for me to come up with a rather short example, while demonstrating the meaning of virtual resources.  In practice, such examples with sewn-in user names are rare.  At least they should. <br><br>  There is a server with Apache installed.  Installation and configuration is made conveniently and fashionably puppet-class apache.  For simplicity, everything will be stored in the main manifest <b>site.pp.</b>  All emerging problems during the development of the example are relevant in the case of the separation of pieces of logic on the modules. <br><a name="habracut"></a><br>  Suppose a class needs a unix user, in this example a <b>webUser</b> whose home directory will be the document root for the web.  Then we get the following <b>site.pp</b> skeleton: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } ... } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> }</span></span></code> </pre> <br>  It's simple.  Now we have decided to add nginx to our infrastructure no matter for what purposes.  The main thing is that he also needs a webUser user to upload content.  Add a class: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  Run: <br><br><pre> <code class="bash hljs">root@puppet:/vagrant<span class="hljs-comment"><span class="hljs-comment"># puppet apply ./site.pp --noop Error: Duplicate declaration: User[webUser] is already declared in file /vagrant/site.pp:17; cannot redeclare at /vagrant/site.pp:11 on node puppet.example.com Error: Duplicate declaration: User[webUser] is already declared in file /vagrant/site.pp:17; cannot redeclare at /vagrant/site.pp:11 on node puppet.example.com</span></span></code> </pre><br>  For obvious reasons, it does not work.  It turns out that in the same scope we have two resources with the same <i>name name</i> value.  You can solve the problem, for example, by taking out the user's resource in a separate class: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  Run - works: <br><br><pre> <code class="bash hljs">root@puppet:/vagrant<span class="hljs-comment"><span class="hljs-comment"># puppet apply ./site.pp --noop Notice: Compiled catalog for puppet.example.com in environment production in 0.07 seconds Notice: /Stage[main]/users/User[webUser]/ensure: current_value absent, should be present (noop) Notice: Class[users]: Would have triggered 'refresh' from 1 events Notice: Stage[main]: Would have triggered 'refresh' from 1 events Notice: Finished catalog run in 0.02 seconds</span></span></code> </pre><br>  Suppose that we needed to add a new user, <b>cacheUser</b> , in the folder of which we will store a cache.  Both Apache and nginx use this cache, so we add the corresponding user to the <b>users</b> class: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cacheUser</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } }</span></span></code> </pre><br>  Next, we decided to add php5-fpm and uwsgi, which need <b>webUser</b> , but do not need <b>cacheUser</b> .  In such a situation, it is necessary to allocate <b>cacheUser</b> to a separate class in order to connect it separately only in the classes apache and nginx.  It is not comfortable.  In addition, there are no guarantees that a little later it is not necessary to allocate another user to a separate class.  This is where virtual resources come to the rescue. <br><br>  If you add an <b>@</b> to the definition of a resource: <br><br><pre> <code class="ruby hljs"> @user { <span class="hljs-string"><span class="hljs-string">'webUser'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">ensure</span></span> =&gt; present }</code> </pre><br>  The resource will be considered virtual.  Such a resource will not be added to the agent directory until we explicitly determine.  From the documentation: <br><blockquote>  The virtual resource declaration </blockquote><br>  Therefore, if you execute the code below even if there are no <b>webUser</b> and <b>cacheUser</b> users in the system, they will not be added: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> { @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cacheUser</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  Checking: <br><br><pre> <code class="bash hljs">root@puppet:/vagrant<span class="hljs-comment"><span class="hljs-comment"># puppet apply ./site.pp Notice: Compiled catalog for puppet.example.com in environment production in 0.07 seconds Notice: Finished catalog run in 0.02 seconds</span></span></code> </pre><br>  Users, as expected, were not added. <br><br>  But be careful.  Although the virtual resource is not added to the directory, this does not mean that the following code will work: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> { @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> { @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  It will still produce a compilation error.  This happens because, at first, the puppet parser iterates over all resources, adding even vitrual to the directory.  At this stage, the stage and an error occurs due to duplication of names.  The next step is the processing of the implementation of virtual types: the collector searches the directory for places in which virtual resources are defined and the found marks as non-virtual.  And only at the very end there is a cleanup of the directory from virtual resources that would not be implemented. <br><br>  To determine the resource, use either the spaceship operator <b>&lt;|</b>  <b>|</b>  <b>&gt;</b> either by using <b>realize</b> function.  Rewrite our manifest using one or the other syntax: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> { @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">user</span></span></span><span class="hljs-class"> { '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cacheUser</span></span></span><span class="hljs-class">': </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">realize</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">'], </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class">['</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cacheUser</span></span></span><span class="hljs-class">'] } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">users</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">User</span></span></span><span class="hljs-class"> &lt;| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class"> == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">webUser</span></span></span><span class="hljs-class">' </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">or</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class"> == '</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">cacheUser</span></span></span><span class="hljs-class">' |&gt; } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">default</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class"> }</span></span></code> </pre><br>  <b>You</b> can transfer several resources to <b>realize at</b> once, and <b>&lt;|</b>  <b>|&gt; You</b> can specify several conditions by which a search is made for the resources to be determined. <br><br>  Besides the syntactic difference in <b>realize</b> and <b>&lt;|</b>  <b>|&gt;</b> there are differences in behavior.  If the resource with the specified name does not exist, <b>realize</b> will <b>generate an</b> error: <br><br><pre> <code class="bash hljs">Error: Failed to realize virtual resources User[nonExistingUser] on node puppet.example.com</code> </pre><br>  Operator <b>&lt;|</b>  <b>|&gt;</b> in this case does not give an error, because it is a kind of superstructure over the function <b>realize</b> .  The function <b>realize</b> is applied to all found resources according to the search query specified in its body.  Accordingly, if no resource was found for the specified error criteria does not occur, since the function <b>realize is</b> not called. <br><br>  By the way, the operator <b>&lt;|</b>  <b>|&gt;</b> There are still two fairly good uses.  It can be used to override the status of a resource in a class.  For example: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configurations</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class"> { '/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">etc</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">nginx</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file</span></span></span><span class="hljs-class"> { '/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">etc</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache2</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">' : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">present</span></span></span><span class="hljs-class"> } } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s1</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">example</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configurations</span></span></span><span class="hljs-class"> } </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">node</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">s2</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">example</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">com</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">include</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">configurations</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">File</span></span></span><span class="hljs-class"> &lt;| </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">title</span></span></span><span class="hljs-class"> == '/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">etc</span></span></span><span class="hljs-class">/</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">apache2</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">conf</span></span></span><span class="hljs-class">' |&gt; { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ensure</span></span></span><span class="hljs-class"> =&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">absent</span></span></span><span class="hljs-class"> } }</span></span></code> </pre><br>  Exclude the <i>/etc/apache2.con</i> f file for the <i>s2.example.com</i> node. <br>  It can also be used with the <b>~&gt;</b> and <b>-&gt;</b> operators.  Thus, we can notify all services about any changes, or request to add all <i>yum</i> repositories before installing any package: <br><pre> <code class="ruby hljs">Yumrepo &lt;<span class="hljs-params"><span class="hljs-params">| |</span></span>&gt; -&gt; Package &lt;<span class="hljs-params"><span class="hljs-params">| |</span></span>&gt;</code> </pre><br><br>  It seems to me that the main advantage of virtual resources is that they can be exported and made available to other agents.  To export a virtual resource, you need to add another <b>@</b> sign before its description. <br><br>  A classic example from the Puppet documentation: <br><br><pre> <code class="ruby hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ssh</span></span></span><span class="hljs-class"> { </span><span class="hljs-comment"><span class="hljs-class"><span class="hljs-comment"># Declare: @</span></span><span class="hljs-doctag"><span class="hljs-class"><span class="hljs-comment"><span class="hljs-doctag">@sshkey</span></span></span></span><span class="hljs-class"><span class="hljs-comment"> { $hostname: type =&gt; dsa, key =&gt; $sshdsakey, } # Collect: Sshkey &lt;&lt;| |&gt;&gt; }</span></span></span></span></code> </pre><br>  In this example, we have defined the <b>sshkey</b> virtual resource.  Operator-collector <b>&lt;&lt; |</b>  <b>| &gt;&gt;</b> contains an empty body, so it unloads all exported objects of the <b>Sshkey</b> class.  Thus, any agent in the manifest of which the ssh class is connected exports its public key ( <i>@@ sshkey</i> ) and then imports all the keys added by other agents ( <i>Sshkey &lt;&lt; | | &gt;&gt;</i> ) to itself. <br><br>  Exported resources are stored in PuppetDB - DB from PuppetLabs.  After connecting PuppetDB, each folder copied by the master master is put into the PuppetDB database, which in turn provides a search interface for searching through catalogs. <br><br>  By specifying <b>@@</b> , we mark the resource as exportable and inform puppet that the resource must be added to the directory and tag it <i>exported</i> .  When the puppet master sees the operator <b>&lt;&lt; |</b>  <b>| &gt;&gt;</b> , it makes a search query to <b>PuppetDB</b> and adds all the exported resources found that match the search criteria. <br><br>  It is important that the exported resources are in the global scope, so their names must be unique. <br><br>  This functionality has a huge potential and I often have to use it.  Automation of adding servers to monitoring or nginx backends. <br><br>  It is better to use existing modules, but to demonstrate the principle, this example will do: <br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment">#         "server IP:PORT;"       upstream  nginx class nginx::backend($ip = $::ipaddress, $port = 8080) { @</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@concat</span></span></span><span class="hljs-comment">::fragment { "$::fqdn" : content =&gt; "server $ip:$port;", tag =&gt; 'nginx-backend', target =&gt; '/etc/nginx/conf.d/backend.conf' } } #  ,     concat,        nginx::backend class nginx::frontend { concat { '/etc/nginx/backend.conf' : ensure =&gt; present, force =&gt; true, ensure_newline =&gt; true } ~&gt; Class['::nginx::service'] concat::fragment { 'upstream_header': content =&gt; 'upstream backend { ', order =&gt; '01', target =&gt; '/etc/nginx/backend.conf', } concat::fragment { 'upstream_footer' : content =&gt; '}', order =&gt; '03', target =&gt; '/etc/nginx/backend.conf' } #   Concat::Fragment &lt;&lt;| tag == 'nginx-backend' |&gt;&gt; { target =&gt; '/etc/nginx/backend.conf', order =&gt; '02' } } class nginx::install { package { 'nginx' : ensure =&gt; present } } class nginx::service { service { 'nginx' : ensure =&gt; running, require =&gt; Class['nginx::install'] } } class nginx { class { 'nginx::install' : } -&gt; class { 'nginx::service': } } node 'back1.example.com' { class { 'nginx' : } class { 'nginx::backend' : port =&gt; 8083 } } node 'back2.example.com' { class { 'nginx' : } class { 'nginx::backend' : port =&gt; 8084 } } node 'front1.example.com' { class { 'nginx' : } class { 'nginx:::frontend' : } }</span></span></code> </pre><br><br>  More information about syntax and usage patterns can be found at the following links: <br><ul><li>  <a href="https://docs.puppetlabs.com/puppet/latest/reference/lang_virtual.html">docs.puppetlabs.com/puppet/latest/reference/lang_virtual.html</a> </li><li>  <a href="https://docs.puppetlabs.com/puppet/latest/reference/lang_exported.html">docs.puppetlabs.com/puppet/latest/reference/lang_exported.html</a> </li><li>  <a href="https://docs.puppetlabs.com/puppet/2.7/reference/lang_collectors.html">docs.puppetlabs.com/puppet/2.7/reference/lang_collectors.html</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/242123/">https://habr.com/ru/post/242123/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../242109/index.html">Speech recognition in FreePBX using Yandex Speechkit</a></li>
<li><a href="../242113/index.html">About Meteor in detail: why is the future of web development</a></li>
<li><a href="../242115/index.html">Changing time zones on MS Exchange and dealing with its consequences for Android and IOS</a></li>
<li><a href="../242119/index.html">Delphi: Fast (de) JPEG Encoding with libjpeg-turbo</a></li>
<li><a href="../242121/index.html">SSD VPS from REG.RU: combine the merits</a></li>
<li><a href="../242127/index.html">Development of new media platform. Stage of delivering video content to users</a></li>
<li><a href="../242139/index.html">5 killer dull landings</a></li>
<li><a href="../242141/index.html">"Hide behind a high fence ... privacy"</a></li>
<li><a href="../242143/index.html">Writing scripts for Mikrotik RouterOS is just</a></li>
<li><a href="../242145/index.html">Facebook is officially available in Tor.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>