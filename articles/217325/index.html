<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Automatic update of C # programs</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A few years ago, while programming in Delphi, I personally built for myself some kind of automatic update code, which later became indispensable when ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Automatic update of C # programs</h1><div class="post__text post__text-html js-mediator-article">  A few years ago, while programming in Delphi, I personally built for myself some kind of automatic update code, which later became indispensable when developing any program that has an update.  At the moment this code is completely rewritten in c # and I want to share it with you. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/226/163/8f7/2261638f741f9310472d16d9d342ec50.jpg" alt="image"><br><br><h5>  First we define the goals of this implementation: </h5><br><ol><li>  When a new version is detected, the update should occur automatically; </li><li>  After the update, the program should automatically restart; </li><li>  After updating the program name should remain the same. </li></ol><br>  The problem is that the program cannot delete, replace and restart itself.  And, it would seem, how to solve this issue?  Here we will be helped by the second file, which is responsible for renaming and restarting the program, since we do not pursue the goal of storing all codes in 1 file. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Stages </h4><br><h5>  Stage 1: Version Verification </h5><br>  Due to my laziness to look for the best option, 2 files were posted on the site: <br><ul><li>  myprogram.exe </li><li>  version.xml </li></ul><br>  Yes, it is the XML format that I use.  Running off-topic I will say that in the version.xml file I have a list of several versions of files, but we will consider only one. <br><br>  Go ahead.  The structure of the version file is as follows: <br><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">myprogram</span></span></span><span class="hljs-tag">&gt;</span></span>1.0.2.37<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">myprogram</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">version</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  A backgroundWorker component has been added to the form (to implement background file loading) with the following code inside the DoWork handler: <br><pre> <code class="hljs axapta"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">double</span></span> versionRemote = Convert.ToDouble(doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"myprogram"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText.Replace(<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)), thisVersion = Convert.ToDouble(Application.ProductVersion.Replace(<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (thisVersion &lt; versionRemote) { MessageBox.Show(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-string"><span class="hljs-string">"   ("</span></span> + doc.GetElementsByTagName(<span class="hljs-string"><span class="hljs-string">"myprogram"</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>].InnerText + <span class="hljs-string"><span class="hljs-string">")"</span></span> + Environment.NewLine + <span class="hljs-string"><span class="hljs-string">"     ."</span></span>, Application.ProductName + <span class="hljs-string"><span class="hljs-string">" v"</span></span> + Application.ProductVersion, MessageBoxButtons.OK, MessageBoxIcon.Information); var <span class="hljs-keyword"><span class="hljs-keyword">client</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> WebClient(); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.DownloadProgressChanged += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> DownloadProgressChangedEventHandler(download_ProgressChanged); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.DownloadFileCompleted += <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AsyncCompletedEventHandler(download_Completed); <span class="hljs-keyword"><span class="hljs-keyword">client</span></span>.DownloadFileAsync(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(@<span class="hljs-string"><span class="hljs-string">"http://mysite/myprogram.exe"</span></span>), <span class="hljs-string"><span class="hljs-string">"temp_myprogram"</span></span>); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { }</code> </pre> <br>  What we see in the code above: <br>  Since the version we can have a large number, we use the variable type double.  To compare versions, we delete all points and convert the version from a string to a number (in the example, the number is 10237). <br>  We will do the same with the version of the file itself assigned to the variable <b>thisVersion</b> . <br><br>  After that we need to compare the local version with the remote one, and if our version is smaller than the remote one, then we first display a message informing about the further update.  After that, the program starts downloading the file to the same folder from which it is running.  The file is named <b>temp_myprogram</b> . <br><br>  To track the download status, a progressBar component was added to the form, and a function was added to the code: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">download_ProgressChanged</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, DownloadProgressChangedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { progressBar1.Value = e.ProgressPercentage; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { } }</code> </pre><br>  The function displays the file download status in the progress bar.  This is only for visual display. <br>  So, we downloaded our file and what to do next?  And then the <b>download_Completed</b> function comes into <b>play</b> , containing the code: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">download_Completed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, AsyncCompletedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Process.Start(<span class="hljs-string"><span class="hljs-string">"updater.exe"</span></span>, <span class="hljs-string"><span class="hljs-string">"temp_myprogram myprogram.exe"</span></span>); Process.GetCurrentProcess().Kill(); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception) { } }</code> </pre><br>  Everything is simple here: run the <b>updater.exe</b> file with the parameters, which I will discuss in the next step. <br>  The second line indicates the need to force the application to shut down. <br><br><h5>  Stage 2: Update Processing </h5><br>  Next, the <b>updater.exe</b> utility comes to the rescue, a functional feature of which is to check the shutdown of the main application and update processing. <br>  Well, let's not go into the text and go straight to the code: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Diagnostics</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.IO; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Threading; namespace Updater { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Program { static <span class="hljs-type"><span class="hljs-type">void</span></span> Main(string[] args) { try { string process = args[<span class="hljs-number"><span class="hljs-number">1</span></span>].Replace(".exe", ""); Console.WriteLine("Terminate process!"); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (Process.GetProcessesByName(process).Length &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Process[] myProcesses2 = Process.GetProcessesByName(process); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-type"><span class="hljs-type">int</span></span> i = <span class="hljs-number"><span class="hljs-number">1</span></span>; i &lt; myProcesses2.Length; i++) { myProcesses2[i].Kill(); } Thread.Sleep(<span class="hljs-number"><span class="hljs-number">300</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(File.Exits(args[<span class="hljs-number"><span class="hljs-number">1</span></span>])){ File.<span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span>(args[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } File.<span class="hljs-keyword"><span class="hljs-keyword">Move</span></span>(args[<span class="hljs-number"><span class="hljs-number">1</span></span>], args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); Console.WriteLine("Starting "+args[<span class="hljs-number"><span class="hljs-number">1</span></span>]); Process.<span class="hljs-keyword"><span class="hljs-keyword">Start</span></span>(args[<span class="hljs-number"><span class="hljs-number">1</span></span>]); } catch (<span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>) { } } } }</code> </pre><br>  Since we do not need forms, the project is assembled as a regular console application, whose actions are quite simple. <br>  We set a cycle that checks whether the process specified in the 2nd parameter is running.  If the process is found, then the <b>Kill ()</b> command will be transferred to it for a forced end, after which we wait 300 milliseconds and repeat.  The cycle will work until the process is complete. <br><br>  Next, delete the old file.  To eliminate some errors (rather errors in the brain), we add the function of checking the existence of a file. <br>  After deleting, rename the name of the file specified in the 1st parameter to the name specified in the 2nd parameter.  In our case, the <b>temp_myprogram</b> file will be renamed to <b>myprogram.exe</b> , after which the <b>myprogram.exe</b> process will be launched and the window of this update will be closed. <br>  I also want to say that the updater file I use in all my projects where it is required, since it does not have a binding to any particular application. <br><br>  And go to the next step: <br><br><h5>  Stage 3: Completion </h5><br><br>  And here we see that the updated version file was successfully launched, and the "update" window was closed.  Profit! <br><br>  The article is written on the basis of the launcher for modpak "PROTanki" to the game "World of Tanks" with the original screenshots of the application.  For those who say ‚Äúthis functionality is not there‚Äù, I‚Äôll immediately say that this launcher is in beta test and is available to a limited number of people. <br><br>  If anyone needs the <b>updater.exe</b> file, you can always download its current version <a href=""><b>HERE</b></a> , on my official website.  Currently the current version is <b>1.0.0.2</b> . <br><br>  And on this line, our automatic update code comes to an end. <br><br>  <b>UPD.</b>  <b>I wrote the <a href="http://habrahabr.ru/post/217633/">second article</a> containing part of the amendments.</b> <b><br></b>  <b>We kindly ask, who else has thoughts about ‚Äúhand curves‚Äù, ‚Äúcurve code‚Äù, etc., write at least in the comments what is wrong.</b>  <b>Based on your constructive criticism, I will improve my work, thereby learning how to write better code.</b> <b><br></b>  <b>Thanks in advance!</b> <br><br>  <i>Sincerely, Andrei Helldar!</i> </div><p>Source: <a href="https://habr.com/ru/post/217325/">https://habr.com/ru/post/217325/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../217309/index.html">How to catch a hedgehog</a></li>
<li><a href="../217315/index.html">Photo report from the exhibition of retrocomputers in Minsk</a></li>
<li><a href="../217317/index.html">Algorithms for video processing processor TI DM368</a></li>
<li><a href="../217319/index.html">Computer vision library CCV 0.6 with new image classifier</a></li>
<li><a href="../217321/index.html">PVS-Studio now supports any build system on Windows and any compiler. Easy and out of the box</a></li>
<li><a href="../217327/index.html">Attacks in time - a fairy tale or a real threat?</a></li>
<li><a href="../217331/index.html">Enigma algorithm</a></li>
<li><a href="../217333/index.html">Once again about the leak of atoms and the VCL bug</a></li>
<li><a href="../217337/index.html">ATM. On the other side of the wire</a></li>
<li><a href="../217339/index.html">Running a tmux window adapted for convenient work with Ruby on Rails</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>