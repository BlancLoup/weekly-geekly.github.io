<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Celery - distributed task queue</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This time we decided to talk about the wonderful product that we use in our work. It will be a question of Celery - "distributed task queue". This is ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Celery - distributed task queue</h1><div class="post__text post__text-html js-mediator-article">  This time we decided to talk about the wonderful product that we use in our work.  It will be a question of Celery - "distributed task queue".  This is a distributed asynchronous queue of tasks, which has broad functionality.  In our <a href="http://cms.biggo.ru/">site builder,</a> we often have to run asynchronous from the point of view of a user response task.  On Habr√©, unfortunately, there is not a lot of information on this product, and it deserves a separate mention, and we want to correct this. <br><br>  So, what can <a href="http://celeryq.org/">Celery</a> : <br><br><ul><li>  Perform tasks asynchronously or synchronously </li><li>  Perform periodic tasks (smart crond replacement) </li><li>  Perform pending tasks </li><li>  Distributed execution (can be run on N servers) </li><li>  Within the limits of one worker'a it is possible to perform several tasks competitively (simultaneously) </li><li>  Repeat the task if there is an exception </li><li>  Limit the number of tasks per unit of time (rate limit, for a task or globally) </li><li>  Routing tasks (what worker what to do) </li><li>  Easy to monitor assignments </li><li>  Perform subtasks </li><li>  Send exception reports to email </li><li>  Check whether the task has been completed (convenient for building Ajax applications where the user is waiting for completion) </li></ul><br>  Interested?  We ask under the cat. <br><a name="habracut"></a><br>  Let's start c worker'a configuration.  This is the daemon that actually receives tasks from the queue and executes them.  The recommended queue is RabbitMQ, but for now we have limited ourselves to ghettoq, via MongoDB.  Also supported by Redis and RDBMS. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      celeryconfig.py: <br><br><pre><code class="hljs pgsql">CARROT_BACKEND = "ghettoq.taproot.MongoDB" BROKER_HOST = "xxx" BROKER_PORT = <span class="hljs-number"><span class="hljs-number">27017</span></span> BROKER_VHOST = "celery" CELERY_SEND_TASK_ERROR_EMAILS = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> ADMINS = ( (<span class="hljs-string"><span class="hljs-string">'Admin'</span></span>, <span class="hljs-string"><span class="hljs-string">'admin@localhost'</span></span>), ) CELERYD_MAX_TASKS_PER_CHILD = <span class="hljs-number"><span class="hljs-number">5</span></span> CELERY_IMPORTS = ("tasks", ) CELERY_DISABLE_RATE_LIMITS = <span class="hljs-keyword"><span class="hljs-keyword">True</span></span> CELERY_RESULT_BACKEND = "mongodb" CELERY_MONGODB_BACKEND_SETTINGS = { "host": "xxx", "port": <span class="hljs-number"><span class="hljs-number">27017</span></span>, "database": "celery", "taskmeta_collection": "my_taskmeta_collection", }</code> </pre> <br><br>  Running the daemon: celeryd -l INFO -B <br>  We include logging in the console and the -B option to start the daemon of periodic tasks.  The latter can be run separately by the command celerybeat <br><br>  Now create a test task.  In the config, we import tasks, so the tasks file is tasks.py: <br><br><pre> <code class="hljs python"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery.decorators <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> task <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery.decorators <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> periodic_task <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> celery.task.schedules <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> crontab @periodic_task(run_every=timedelta(seconds=<span class="hljs-number"><span class="hljs-number">60</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mail_queue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Task is executed every minute"</span></span> @periodic_task(run_every=crontab(hour=<span class="hljs-number"><span class="hljs-number">0</span></span>, minute=<span class="hljs-number"><span class="hljs-number">10</span></span>)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">transactions</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"Task is executed every day on 0:10"</span></span> @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delayed_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id)</span></span></span><span class="hljs-function">:</span></span> some_function() @task <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">delayed_heavy_function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(id)</span></span></span><span class="hljs-function">:</span></span> some_heavy_function()</code> </pre><br><br>  So, we have 4 tasks in tasks.  The first two are scheduled;  they are marked by the @periodic_task decorator.  But the last two will be called directly from the program code.  In this way: <br><br><pre> <code class="hljs haskell"><span class="hljs-title"><span class="hljs-title">from</span></span> tasks <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> delayed_function, delayed_heavy_function delayed_function.apply_async(<span class="hljs-title"><span class="hljs-title">args</span></span>=[<span class="hljs-title"><span class="hljs-title">id</span></span>], <span class="hljs-title"><span class="hljs-title">countdown</span></span>=300) #    300  r = delayed_heavy_function.delay(<span class="hljs-title"><span class="hljs-title">id</span></span>) #  (   ),   </code> </pre><br><br>  Now in order to track the result and the fact that the last task was completed, let's execute: <br><br>  r.ready () # Return True if the job has completed <br>  r.result # Returns the value of the function executed or None if it has not yet been executed (asynchronously) <br>  r.get () # Will wait for the assignment and return its result (synchronous) <br><br>  The variable r can be driven through cPickle, put the value in the cache and ayaksom to poll the status of the task.  Or you can get the task id, and put it in the cache.  In addition, you can set the task id yourself, the main thing is that it is unique. <br><br>  After using celery tightly, we found several errors related to deferred execution of tasks with the queue manager ghettoq, but they were all corrected by the author on the day of the issue on github, for which he thanks. <br><br>  Not so long ago, version 2.0 was released, which has ceased to be django-dependent, and integration with django has now been moved to a separate sub-project, celery-django. <br><br>  Two celery limitations can be distinguished: more precisely, these are just features: on a regular FreeBSD, workers will not work, because  there is no pythonic multiprocessing there, although there are recipes for assembling a kernel for celery;  To reload tasks, the worker must be restarted to load the new python code of the tasks and related functions.  It works great on linux. </div><p>Source: <a href="https://habr.com/ru/post/102742/">https://habr.com/ru/post/102742/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../102733/index.html">Self-motivated team</a></li>
<li><a href="../102734/index.html">Presented color e-book</a></li>
<li><a href="../102737/index.html">Opening the blog of the PocketBook company</a></li>
<li><a href="../102739/index.html">Overview of Nuclear NAT in FreeBSD</a></li>
<li><a href="../102740/index.html">NetBeans CSS Macros</a></li>
<li><a href="../102744/index.html">Korean Galaxy Tab Video Presentation</a></li>
<li><a href="../102745/index.html">Chiefs and how to live with them</a></li>
<li><a href="../102747/index.html">Pros and cons of working from home</a></li>
<li><a href="../102748/index.html">Announced Canon EOS 60D</a></li>
<li><a href="../102749/index.html">Sphinx - not just for searching! My history</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>