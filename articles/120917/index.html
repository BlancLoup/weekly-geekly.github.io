<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>New XMLHttpRequest2 Features</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One of the unsung heroes of the HTML5 universe is XMLHttpRequest 2. Strictly speaking, XHR2 is not part of HTML5 and is not an independent object. XHR...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>New XMLHttpRequest2 Features</h1><div class="post__text post__text-html js-mediator-article">  One of the unsung heroes of the HTML5 universe is XMLHttpRequest 2. Strictly speaking, XHR2 is not part of HTML5 and is not an independent object.  XHR2 is the same XMLHttpRequest, but with some changes.  XHR2 is an integral part of complex web applications, so it should be given more attention. <br><br>  Our old friend XMLHttpRequest has changed a lot, but not many people know about its changes.  <a href="http://dev.w3.org/2006/webapi/XMLHttpRequest-2/">XMLHttpRequest Level 2</a> includes new features that will put an end to our crazy hacks and tambourine dances around XMLHttpRequest: cross-domain queries, the process of downloading files, downloading and sending binary data.  These features enable AJAX to work confidently without any hacks with the latest HTML5 technologies: <a href="http://www.html5rocks.com/tutorials/file/filesystem/">File System API</a> , <a href="http://chromium.googlecode.com/svn/trunk/samples/audio/specification/specification.html">Web Audio API</a> , and WebGL. <br><br>  This article will highlight the new features of XMLHttpRequest, especially those that can be used <a href="http://www.html5rocks.com/tutorials/file/dndfiles/">when working with files</a> . <br><a name="habracut"></a><br><h4>  Data retrieval </h4><br>  Extracting binary data from a file to XHR is very painful.  Technically, it is even impossible.  But there is one well documented trick that allows you to rewrite the mime type with a custom encoding. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So before you could get the contents of the image: <br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/path/to/image.png'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   ,      xhr.overrideMimeType('text/plain; charset=x-user-defined'); xhr.onreadystatechange = function(e) { if (this.readyState == 4 &amp;&amp; this.status == 200) { var binStr = this.responseText; for (var i = 0, len = binStr.length; i &lt; len; ++i) { var c = binStr.charCodeAt(i); //String.fromCharCode(c &amp; 0xff); var byte = c &amp; 0xff; } } }; xhr.send();</span></span></code> </pre> <br>  Although this works, you do not receive a binary blob in responseText, but a binary string that represents a binary image file.  We deceive XMLHttpRequest and force it to pass the raw data.  Although this is a small hack, but I want to call it black magic. <br><br><h4>  Specify response format </h4><br>  In the previous example, we loaded the image as a ‚Äúbinary file‚Äù, rewriting the server mime type and processing it as a binary string.  Instead of this magic, let's take advantage of the new XMLHttpRequest feature ‚Äî the responseType and response properties, which will show the browser in which format we want to receive data. <br><br>  <b>xhr.responseType</b> <br>  Before sending a request, you can change the xhr.responseType property and specify the output format: ‚Äútext‚Äù, ‚Äúarraybuffer‚Äù, ‚Äúblob‚Äù or ‚Äúdocument‚Äù (default is ‚Äútext‚Äù). <br><br>  <b>xhr.response</b> <br>  After a successful request is completed, the response property will contain the requested data in the format DOMString, ArrayBuffer, Blob, or Document in accordance with responseType. <br><br>  With this new great feature we can remake the previous example.  This time we request a picture as ArrayBuffer instead of a string.  We upload the downloaded file into Blob format using BlobBuilder API: <br><pre> <code class="javascript hljs">BlobBuilder = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.MozBlobBuilder || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.WebKitBlobBuilder || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.BlobBuilder; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/path/to/image.png'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.responseType = <span class="hljs-string"><span class="hljs-string">'arraybuffer'</span></span>; xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> bb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BlobBuilder(); bb.append(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response); <span class="hljs-comment"><span class="hljs-comment">// :  xhr.responseText var blob = bb.getBlob('image/png'); /*...*/ } }; xhr.send();</span></span></code> </pre><br>  That's so much better! <br><br><h5>  ArrayBuffer format answers </h5><br>  ArrayBuffer is a generic fixed-length container for binary data.  This is very convenient if you need a generic raw binary data buffer, but the real strength of ArrayBuffer is that you can make a <a href="https://developer.mozilla.org/en/JavaScript_typed_arrays">typed JavaScript array out of it</a> .  In fact, you can create arrays of different lengths using a single ArrayBuffer.  For example, you can create an 8-bit integer array that uses the same ArrayBuffer as the 32-bit array obtained from the same data. <br><br>  As an example, let's write the code that receives our image as an ArrayBuffer and creates an 8-bit integer array from its data: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/path/to/image.png'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.responseType = <span class="hljs-string"><span class="hljs-string">'arraybuffer'</span></span>; xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uInt8Array = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response); <span class="hljs-comment"><span class="hljs-comment">// this.response == uInt8Array.buffer // var byte3 = uInt8Array[4]; // 4-  /*...*/ }; xhr.send();</span></span></code> </pre><br><h5>  Blob Answers </h5><br>  If you want to work directly with <a href="https://developer.mozilla.org/en/DOM/Blob">Blob</a> and / or you do not need to manipulate the file bytes, use <code>xhr.responseType='blob'</code> (Now available only in Chrome <a href="http://crbug.com/52486">crbug.com/52486</a> ): <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitURL; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/path/to/image.png'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.responseType = <span class="hljs-string"><span class="hljs-string">'blob'</span></span>; xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blob = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> img = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'img'</span></span>); img.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.URL.revokeObjectURL(img.src); <span class="hljs-comment"><span class="hljs-comment">// Clean up after yourself. }; img.src = window.URL.createObjectURL(blob); document.body.appendChild(img); /*...*/ } }; xhr.send();</span></span></code> </pre><br>  Blob can be used in several places: saving data to <a href="http://www.html5rocks.com/tutorials/indexeddb/todo/">indexedDB</a> , writing to <a href="http://www.html5rocks.com/tutorials/file/filesystem/">HTML5 File System</a> , creating <a href="http://www.html5rocks.com/tutorials/workers/basics/">Blob URL</a> ( <a href="https://developer.mozilla.org/en/DOM/window.URL.createObjectURL">MDC</a> ) as in the example above. <br><br><h4>  Sending data </h4><br>  The ability to receive data in various formats is great, but it does not suit us if we cannot send this data back (to the server).  XMLHttpRequest limited us to sending a DOMString or Document (XML).  Now it is in the past.  The updated send () method allows you to send data of the following types: DOMString, Document, FormData, Blob, File, ArrayBuffer.  In this part of the article we will look at how to send data in these formats. <br><br><h5>  Sending string data: xhr.send (DOMString) </h5><br>  <b>Before XMLHttpRequest 2:</b> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendText</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">txt</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/server'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.responseText); } }; xhr.send(txt); } sendText(<span class="hljs-string"><span class="hljs-string">'test string'</span></span>);</code> </pre><br>  <b>After XMLHttpRequest 2:</b> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendTextNew</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">txt</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/server'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.responseType = <span class="hljs-string"><span class="hljs-string">'text'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt;&lt; xhr.onload = function(e) { if (this.status == 200) { console.log(this.response); // &lt;&lt;&lt; } }; xhr.send(txt); } sendText2('test string');</span></span></code> </pre><br>  Nothing new.  The ‚ÄúAfter‚Äù example is slightly different.  It explicitly defines responseType, but you can omit responseType and get the same result (the default is always text). <br><br><h5>  Submitting Form Data: xhr.send (FormData) </h5><br>  I think many of you used <a href="http://jquery.malsup.com/form/">jQuery</a> or other libraries to send form data over AJAX.  Instead, we can use <a href="https://developer.mozilla.org/en/XMLHttpRequest/FormData">FormData,</a> another data type that XHR2 understands.  FormData is useful for creating HTML forms on the fly in JavaScript.  These forms can be sent using AJAX: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> formData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(); formData.append(<span class="hljs-string"><span class="hljs-string">'username'</span></span>, <span class="hljs-string"><span class="hljs-string">'johndoe'</span></span>); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt;&lt; formData.append('id', 123456); // &lt;&lt;&lt; var xhr = new XMLHttpRequest(); xhr.open('POST', '/server', true); xhr.onload = function(e) { /*...*/ }; xhr.send(formData); // &lt;&lt;&lt;</span></span></code> </pre><br>  In essence, we dynamically create a form and add input fields to it by calling the append method. <br>  And you do not need to create a real form from scratch.  FormData objects can be initialized from existing HTMLFormElement elements on the page.  For example: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"myform"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">action</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"/server"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"username"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"johndoe"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"number"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"id"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"123456"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">input</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"submit"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">onclick</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"return sendForm(this.form);"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">form</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendForm</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">form</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> formData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(form); <span class="hljs-comment"><span class="hljs-comment">//  FormData  HTMLFormElement formData.append('secret_token', '1234567890'); //      var xhr = new XMLHttpRequest(); xhr.open('POST', form.action, true); xhr.onload = function(e) { /*...*/ }; xhr.send(formData); return false; //   }</span></span></code> </pre><br>  HTML form can contain files ( <code>&lt;input type="file"&gt;</code> ) - FormData can work with them.  Just add the file (s) and the browser will execute a <code>multipart/form-data</code> request when the <code>send()</code> method is called.  It is very convenient! <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">uploadFiles</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">url, files</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> formData = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FormData(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>, file; file = files[i]; ++i) { formData.append(file.name, file); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, url, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> }; xhr.send(formData); <span class="hljs-comment"><span class="hljs-comment">// multipart/form-data } document.querySelector('input[type="file"]').addEventListener('change', function(e) { uploadFiles('/server', this.files); }, false);</span></span></code> </pre><br><h5>  Sending a file or blob: xhr.send (Blob) </h5><br>  Using XHR2 we can also send File or Blob.  Keep in mind that the files are Blob. <br>  In this example, we will create a new text field from scratch using the BlobBuilder API and upload this Blob to the server.  This code also creates a handler that shows us the file upload process (An incredibly useful HTML5 feature): <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">progress</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">min</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">max</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"100"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"0"</span></span></span><span class="hljs-tag">&gt;</span></span>0% complete<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">progress</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">blobOrFile</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/server'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> }; <span class="hljs-comment"><span class="hljs-comment">//     var progressBar = document.querySelector('progress'); xhr.upload.onprogress = function(e) { // &lt;&lt;&lt; if (e.lengthComputable) { progressBar.value = (e.loaded / e.total) * 100; progressBar.textContent = progressBar.value; //      progress } }; xhr.send(blobOrFile); // &lt;&lt;&lt; } var BlobBuilder = window.MozBlobBuilder || window.WebKitBlobBuilder || window.BlobBuilder; var bb = new BlobBuilder(); bb.append('hello world'); // &lt;&lt;&lt; upload(bb.getBlob('text/plain')); // &lt;&lt;&lt;</span></span></code> </pre><br><h5>  Sending an arbitrary set of bytes: xhr.send (ArrayBuffer) </h5><br>  We can send ArrayBuffers <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">sendArrayBuffer</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/server'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> }; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> uInt8Array = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Uint8Array</span></span>([<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>]); <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt;&lt; xhr.send(uInt8Array.buffer); // &lt;&lt;&lt;&lt; }</span></span></code> </pre><br><h4>  Cross Origin Resource Sharing (CORS) </h4><br>  <a href="http://dev.w3.org/2006/waf/access-control/">CORS</a> allows applications on the same domain to perform cross-domain AJAX requests to another domain.  We don‚Äôt even need to change anything on the client - everything is extremely simple!  The browser itself will send the necessary title for us. <br><br><h5>  Enable CORS Requests </h5><br>  Suppose our application is on <code>example.com</code> and we need to get data from <code><a href="http://www.example2.com/"></a> www.example2.com</code>  <code><a href="http://www.example2.com/"></a> www.example2.com</code> .  Usually, if you try to make such an AJAX request, the request will not be executed and the browser will throw the exception ‚Äúorigin mismatch‚Äù.  With CORS <code><a href="http://www.example2.com/"></a> www.example2.com</code>  <code><a href="http://www.example2.com/"></a> www.example2.com</code> may decide to allow our application to execute the request from <code>example.com</code> or not by adding just one header: <br><pre> <code class="hljs objectivec">Access-Control-Allow-Origin: http:<span class="hljs-comment"><span class="hljs-comment">//example.com</span></span></code> </pre> <br>  The <code>Access-Control-Allow-Origin</code> header can be issued to one site or to any site from any domain: <br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Access</span></span>-Control-Allow-Origin: *</code> </pre> <br>  CORS is enabled on any page of the html5rocks.com site.  If you enable the debugger, then you can see this <code>Access-Control-Allow-Origin</code> header: <br><img src="http://www.html5rocks.com/en/tutorials/file/xhr2/access_control_header.png" alt="image"><br>  Enable cross-domain queries is very simple.  If your data is accessible to everyone, then please <a href="http://enable-cors.org/">enable CORS</a> ! <br><br><h5>  Creating a cross-domain query </h5><br>  If the server resource permits CORS, then creating a cross-domain request is no different from the usual XMLHttpRequest.  For example, this is how we can execute a request from an application on the <code>example.com</code> server to the server <code><a href="http://www.example2.com/"></a> www.example2.com</code>  <code><a href="http://www.example2.com/"></a> www.example2.com</code> : <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://www.example2.com/hello.json'</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.response); <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> } xhr.send();</code> </pre><br>  Everything is extremely transparent and there are no dances with a tambourine around postMessage, window.name, document.domain, server proxies and other <s>perversions of the</s> <a href="http://habrahabr.ru/blogs/javascript/120336/">methods</a> . <br><br><h4>  Examples </h4><br><h5>  Upload and save file in HTML5 File System </h5><br>  Suppose we have a gallery of images and we want to save some pictures to ourselves using the <a href="http://www.html5rocks.com/tutorials/file/filesystem/">HTML5 File System</a> . <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.requestFileSystem = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.requestFileSystem || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.webkitRequestFileSystem; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">onError</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Error'</span></span>, e); } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'/path/to/image.png'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.responseType = <span class="hljs-string"><span class="hljs-string">'arraybuffer'</span></span>; <span class="hljs-comment"><span class="hljs-comment">// &lt;&lt;&lt; //     xhr.onload = function(e) { // &lt;&lt;&lt; //        window.requestFileSystem(TEMPORARY, 1024 * 1024, function(fs) { // &lt;&lt;&lt; //   -   fs.root.getFile('image.png', {create: true}, function(fileEntry) { //   fileEntry.createWriter(function(writer) { writer.onwrite = function(e) { /*...*/ }; writer.onerror = function(e) { /*...*/ }; //  Blob    var bb = new BlobBuilder(); // &lt;&lt;&lt; bb.append(this.response); // &lt;&lt;&lt; //    writer.write(bb.getBlob('image/png')); // &lt;&lt;&lt; }, onError); }, onError); }, onError); }; xhr.send();</span></span></code> </pre> <br>  Attention: see <a href="http://www.html5rocks.com/tutorials/file/filesystem/">which browsers support FileSystem API</a> <br><br><h5>  Sending a file in parts </h5><br>  Using the <a href="http://www.html5rocks.com/tutorials/file/dndfiles/">File API</a> we can simplify the process of sending a large file.  We split a large file into several small files, then each one is sent using XHR.  On the server we collect the file in one big.  This is similar to GMail sending large attachments.  This technique can be used to bypass the limitations of Google App Engine - 32MB per http request. <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.BlobBuilder = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.MozBlobBuilder || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.WebKitBlobBuilder || <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.BlobBuilder; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">upload</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">blobOrFile</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> xhr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest(); xhr.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'/server'</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>); xhr.onload = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-comment"><span class="hljs-comment">/*...*/</span></span> }; xhr.send(blobOrFile); } <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.querySelector(<span class="hljs-string"><span class="hljs-string">'input[type="file"]'</span></span>).addEventListener(<span class="hljs-string"><span class="hljs-string">'change'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> blob = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.files[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> BYTES_PER_CHUNK = <span class="hljs-number"><span class="hljs-number">1024</span></span> * <span class="hljs-number"><span class="hljs-number">1024</span></span>; <span class="hljs-comment"><span class="hljs-comment">//    1MB const SIZE = blob.size; var start = 0; var end = BYTES_PER_CHUNK; while(start &lt; SIZE) { // : blob.slice  .  http://goo.gl/U9mE5 if ('mozSlice' in blob) { var chunk = blob.mozSlice(start, end); } else { var chunk = blob.webkitSlice(start, end); } upload(chunk); start = end; end = start + BYTES_PER_CHUNK; } }, false); })();</span></span></code> </pre><br>  I don‚Äôt attach the file assembly script on the server - everything is obvious there. <br><br><h4>  Links </h4><br>  1. <a href="http://dev.w3.org/2006/webapi/XMLHttpRequest-2/">XMLHttpRequest Level 2</a> Specification <br>  2. <a href="http://dev.w3.org/2006/waf/access-control/">Cross Origin Resource Sharing</a> Specification <a href="http://dev.w3.org/2006/waf/access-control/">(CORS)</a> <br>  3. <a href="http://www.w3.org/TR/file-upload/">File API</a> specification <br>  4. <a href="http://dev.w3.org/2009/dap/file-system/pub/FileSystem/">FileSystem API</a> specification </div><p>Source: <a href="https://habr.com/ru/post/120917/">https://habr.com/ru/post/120917/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../120911/index.html">Language extensions RASE. Operator Overloading in ActionScript</a></li>
<li><a href="../120912/index.html">nanoCAD 3.0: exit June 15, 2011</a></li>
<li><a href="../120914/index.html">EEE PC 901: Installing a 3G modem with a switch and the ability to connect to an external PC</a></li>
<li><a href="../120915/index.html">Automation of business processes. Using JavaFX in real projects</a></li>
<li><a href="../120916/index.html">A small task management system - you can not execute the execution</a></li>
<li><a href="../120918/index.html">A little about paranoia and photos VKontakte</a></li>
<li><a href="../120920/index.html">New AgilePiter meeting, June 14: "Engineering practices in Agile"</a></li>
<li><a href="../120921/index.html">Incorrect interpretation of the rules by KazNIK led to the closure of google.kz</a></li>
<li><a href="../120922/index.html">EEE PC 901 + 3G modem, part two. Making the right antenna</a></li>
<li><a href="../120923/index.html">CPanel and Parallels Plesk Panel from the point of view of a hoster. Part two</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>