<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Antifraud (part 4): an analytical system for recognizing fraudulent payments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the final fourth part of the article we will discuss in detail the most difficult from a technical point of view part of an antifraud-service - an ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Antifraud (part 4): an analytical system for recognizing fraudulent payments</h1><div class="post__text post__text-html js-mediator-article"><img alt="No fraud" src="https://habrastorage.org/getpro/habr/post_images/da6/5ff/b1a/da65ffb1a44ad8e8752fe92a426b9f42.jpg"><br><br>  In the final fourth part of the article we will discuss in detail the most difficult from a technical point of view part of an antifraud-service - an <em>analytical system for recognizing fraudulent bank card payments</em> . <br><br>  Detection of various kinds of frauds is a typical case for supervised learning tasks; therefore, the analytical part of the anti-fraud service, in accordance with the best industry practices, will be built using machine learning algorithms. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For the task ahead, we will use <em>Azure Machine Learning - a cloud service for performing predictive analytics tasks</em> .  Understanding the article will require basic knowledge of machine learning and <a href="https://habr.com/company/microsoft/blog/254637/">familiarity with the Azure Machine Learning service</a> . <br><br><div class="spoiler">  <b class="spoiler_title">What has been done?</b>  <b class="spoiler_title">(for those who have not read the previous 3 parts, but are interested)</b> <div class="spoiler_text">  In the <a href="https://habr.com/post/253725/">first part of the</a> article, we discussed <strong>why the issue of fraudulent payments (fraud) is so acute</strong> for all participants in the market of electronic payments - from online stores to banks - and what are the main difficulties, because of which the cost of developing such systems is sometimes too high for many participants in the ecommerce market. <br><br>  In <a href="https://habr.com/post/253731/">the second part</a> , the <strong>technical and non-technical requirements</strong> that are imposed on such systems were described, and how I am going to reduce the cost of developing and owning an antifraud-system by an order of magnitude (s). <br><br>  In the <a href="https://habr.com/post/254037/">third part</a> , the <strong>software architecture of the service</strong> , its modular structure and key implementation details were considered. <br><br>  In the final fourth part we have the <strong>following goal ...</strong> <br></div></div><br><h2>  purpose <br></h2><br>  In this part, I will describe the project, in the first step of which we will train four models using <em>logistic regression, perceptron, support vector machine and decision tree</em> .  From the trained models, choose the one that gives greater accuracy on the test sample and publish it in the form of a <em>REST / JSON service</em> .  Further for the received service we will write the software client and we will carry out load testing on REST service. <br><br><a name="habracut"></a><br><h2>  Creating a model <br></h2><br>  Let's create a new experiment in Azure ML Studio.  In its final form, it will look like the one shown in the illustration below.  Let us relate each element of the experiment with the stage of the sequence that the average data scientist does in the process of teaching the model. <br><br><img alt="Azure ML experiment" src="https://habrastorage.org/getpro/habr/post_images/92b/ae8/080/92bae8080fd3b45f9c305204adf9ea92.png"><br><br>  Consider each of the stages of creating a model of recognition of fraudulent payments, taking into account the technical details described in the last part 3 of the article. <br><br><h3>  Hypothesis <br></h3><br>  The basic concepts and assumptions useful for creating the model were discussed in the first 2 parts of the article.  I will not repeat, just note that the creation of a good hypothesis is an iterative process of trial and error, the foundation for which is knowledge both in the studied subject area and in the field of Data Science. <br><br><h3>  Data acquisition <br></h3><br>  The data set for the recognition model of fraudulent payments will be a transaction log, which consists of 2 tables in the NoSQL storage (Azure Table): a fact table about transactions TransactionsInfo and a table with previously calculated statistical metrics of TransactionsStatistics. <br><br>  At the data acquisition stage, we will load these 2 tables through the <em>Reader</em> control. <br><br><h3>  Data preparation and research <br></h3><br>  Let's make <em>Inner Join of the</em> loaded tables across the field TransactionId.  With the help of the <em>Metadata Editor</em> control, we specify the data types (string, integer, timestamp), mark the column with answers (label) and the columns with predictors (features), as well as the type of scale in these data: nominal, absolute. <br><br>  Do not underestimate the importance of preparation for the creation of an adequate model: I will give a simple example with the currency of payment, which is stored as ISO codes (integer value).  ISO codes - has a nominal (classification) scale.  But it is hardly worth hoping that the system will automatically determine that the ‚ÄúCurrency‚Äù column does not contain an integer value with an absolute scale (that is, operations such as + or&gt; are possible).  Because it is too unobvious rule, knowledge of which the system does not possess. <br><br>  The dataset may contain missing values.  In our case, it is not always possible to determine the country or IP address of the payer, such fields may contain null values.  After checking the existing data set, we replace the empty values ‚Äã‚Äãof the countries with ‚Äúundefined‚Äù using the <em>Clean Missing Data</em> control.  Using the same control, we will delete the lines where in the card holder field, the payment amount or currency does not contain values, like lines containing obviously incorrect data, that is, making noise in the model. <br><br>  At the next stage, we‚Äôll get rid of unused fields in the model: the address (we are only interested in whether the payer's country coincided with the country where the request came from), the hash of the cardholder‚Äôs name (since it has no effect on the result of the payment) data that came to us from the Azure Table). <br><br>  Finally, using the <em>Normalize Data</em> control, we will perform a ZScore-normalization of data containing large numerical values, such as the amount of payment (TransactionAmount column). <br><br><h3>  Data division <br></h3><br>  Let's divide the resulting data set into a training and test sample.  Choose the optimal ratio of data in the training sample and test.  For our purposes, using the <em>Split</em> control, we ‚Äúsend‚Äù 70% of all available data to the training set, additionally including arbitrary data mixing (the Randomized split flag) when divided into subsets of data.  Mixing data when dividing will allow you to avoid "distortions" in the training sample associated with large leaks of plastic card numbers (and, as a result, anomalous activity of fraud robots during this period). <br><br><h3>  Construction and evaluation of the model <br></h3><br>  We initialize several classification algorithms and compare which one gives the best result (accuracy) on the test sample.  It is important to note that it is not at all the fact that the real data will achieve the same performance as the test data.  Therefore, it is very important to understand that the model did not take into account why one of the algorithms gives a significantly worse or better result, correct errors and start the learning algorithm again.  This process ends when the researcher receives an acceptable model. <br><br>  Azure ML allows us to connect an unlimited number of machine learning algorithms in one experiment.  This makes it possible at the research stage to compare the performance of several algorithms in order to identify which one is best suited for our task.  In our experiment, we use several algorithms of two-class classification: <em>Two-Class Logistic Regression</em> (logistic regression), <em>Two-Class Boosted Decision Tree</em> (decision tree, built using gradient growth), <em>Two-Class Support Vector Machine</em> (method of support vectors), <em>Two- Class Neural Network</em> (neural network). <br><br>  Another opportunity to get the best model performance is to customize the machine learning algorithm using a large number of parameters available to customize the algorithm.  So for the Two-Class Boosted Decision Tree algorithm, the number of trees to be built was specified, as well as the minimum / maximum number of leaves on each tree;  For the Two-Class Neural Network algorithm, the number of hidden nodes, learning iterations, and initial weights. <br><br>  At the final stage, we will review the output of the <em>Evaluate Model</em> control (Visualize command from the context menu of the element) for each of the algorithms. <br><br><img alt="antifraud evaluate model" src="https://habrastorage.org/getpro/habr/post_images/e46/434/cdf/e46434cdf004ef4e7aac884bab1567f2.png"><br><br>  The Evaluate Model control contains a confusion matrix, calculated <em>Accuracy, Precision, Recall, F1 Score</em> , AUC, ROC and Precision / Recall graphics accuracy indicators.  To put it simply, we will choose an algorithm whose Accuracy, Precision, AUC values ‚Äã‚Äãare closer to 1, the ROC graph is more concave toward the Y axis for both the training and the test sample. <br><br>  In addition, it is impassable to look at the change in <em>AUC</em> depending on the <em>Threshold</em> value to be set.  In the case of fraud, this is important, since the cost of unrecognized fraudulent payments ( <em>False Positive</em> ) is much higher than the cost of payments mistakenly taken as fraud ( <em>False Negative</em> ). <br><br>  In such cases, it is necessary to select a Threshold value other than the default value of 0.5. <br><br>  When choosing the most suitable algorithm for obtaining the optimal model of fraud recognition, besides the Threshold level, we also take into account the fact that the decision-making logic for some algorithms (for example, a decision tree) can be reproduced, and for some there is no (perceptron).  The availability of such a possibility can be critical if it is important to know why, according to a certain precedent, the system made a specific decision. <br><br>  The best accuracy was shown by the Two-Class Neural Network algorithm of the two-class neural network (the accuracy figures are shown in the illustration above), followed by the algorithm based on decision trees - the Two-Class Boosted Decision Tree. <br><br><h2>  Publishing the model as a web service <br></h2><br>  Once a model has been obtained that works with the required accuracy, we will publish our experiment as a web service.  The publishing operation takes place by clicking the <em>Publish Web Service</em> button in Azure ML Studio.  The process of creating a web service from an experiment is trivial and I will skip its description. <br><br>  As a result, Azure ML will deploy a scalable fault-tolerant (SLA 99.95%) web service.  After the service is published, the service API documentation page will be available - the API help, which in addition to the general service description, description of the formats of expected input and output messages, also contains examples of calling the service in C #, Python and R. <br><br>  The principle of calling a service by a software client can be represented as follows. <br><br><img alt="Azure ML services.png" src="https://habrastorage.org/getpro/habr/post_images/39c/4b5/47a/39c4b547ad51baae518d23e99c749c54.png"><br><br><h3>  Connect to the Azure ML web service <br></h3><br>  Take an example in C # from the API help and, having slightly changed it, call the web service Azure ML. <br><br>  Listing 1. Call the Azure ML web service <br><pre><code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task&lt;RequestStatistics&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">InvokePredictorService</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">TransactionInfo transactionInfo, TransactionStatistics transactionStatistics</span></span></span><span class="hljs-function">)</span></span> { Contract.Requires&lt;ArgumentNullException&gt;(transactionInfo != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); Contract.Requires&lt;ArgumentNullException&gt;(transactionStatistics != <span class="hljs-literal"><span class="hljs-literal">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> statistics = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RequestStatistics(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> watch = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Stopwatch(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> client = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient()) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> scoreRequest = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> { Inputs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, StringTable&gt;() { { <span class="hljs-string"><span class="hljs-string">"transactionInfo"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringTable() { ColumnNames = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> [] { <span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Column name list }, Values = new [,] { { #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">region</span></span></span><span class="hljs-meta"> Column value list } } } }, }, GlobalParameters = new Dictionary&lt;string, string&gt;() }; client.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", ConfigurationManager.AppSettings["FraudPredictorML:ServiceApiKey"]); client.BaseAddress = new Uri("https://ussouthcentral.services.azureml.net/workspaces/&lt;workspace_id&gt;/services/&lt;service_id&gt;/execute?api-version=2.0&amp;details=true"); watch.Start(); HttpResponseMessage response = await client.PostAsJsonAsync("", scoreRequest); </span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">if</span></span></span><span class="hljs-meta"> (response.IsSuccessStatusCode) await response.Content.ReadAsStringAsync(); statistics.TimeToResponse = watch.Elapsed; statistics.ResponseStatusCode = response.StatusCode; watch.Stop(); } return statistics; }</span></span></code> </pre> <br>  We get the following request / response: <br>  Listing 2.1.  Request to Azure ML web service <br><pre> <code class="javascript hljs">POST https:<span class="hljs-comment"><span class="hljs-comment">//ussouthcentral.services.azureml.net/workspaces/&lt;workspace_id&gt;/services/&lt;service_id&gt;/execute?api-version=2.0&amp;details=true HTTP/1.1 Authorization: Bearer &lt;api key&gt; Content-Type: application/json; charset=utf-8 Host: ussouthcentral.services.azureml.net /*   */ { "Inputs": { "transactionInfo": { "ColumnNames": [ "PartitionKey", "RowKey", "Timestamp", "CardId", "CrmAccountId", "MCC", "MerchantId", "TransactionAmount", "TransactionCreatedTime", "TransactionCurrency", "TransactionId", "TransactionResult", "CardExpirationDate", "CardholderName", "CrmAccountFullName", "TransactionRequestHost", "PartitionKey (2)", "RowKey (2)", "Timestamp (2)", "CardsCountFromThisCrmAccount1D", "CardsCountFromThisCrmAccount1H", "CardsCountFromThisCrmAccount1M", "CardsCountFromThisCrmAccount1S", "CardsCountFromThisHost1D", "CrmAccountsCountFromThisCard1D", "FailedPaymentsCountByThisCard1D", "SecondsPassedFromPreviousPaymentByThisCard1D", "PaymentsCountByThisCard1D", "HostsCountFromThisCard1D", "HasHumanEmail", "HasHumanPhone", "IsCardholderNameIsTheSameAsCrmAccountName", "IsRequestCountryIsTheSameAsCrmAccountCountry", "TransactionDayOfWeek", "TransactionLocalTimeOfDay" /*    */ ], "Values": [ [ "990", "f31f64f367644b1cb173a48a34817fbc", "2015-03-15T20:54:28.6508575Z", "349567471", "10145", "32", "990", "136.69", "2015-03-15T20:54:28.6508575Z", "840", "f31f64f367644b1cb173a48a34817fbc", null, "2015-04-15T23:44:28.6508575+03:00", "640ab2bae07bedc4c163f679a746f7ab7fb5d1fa", "640ab2bae07bedc4c163f679a746f7ab7fb5d1fa", "20.30.30.40", "990", "f31f64f367644b1cb173a48a34817fbc", "2015-03-15T20:54:28.6508575Z", "2", "1", "0", "0", "0", "0", "1", "2", "0", "0", "true", null, "true", "true", "Monday", "Morning" /*    */ ] ] } }, "GlobalParameters": { } }</span></span></code> </pre> <br>  Listing 2.2.  Azure ML web service response <br><pre> <code class="javascript hljs">HTTP/<span class="hljs-number"><span class="hljs-number">1.1</span></span> <span class="hljs-number"><span class="hljs-number">200</span></span> OK Content-Length: <span class="hljs-number"><span class="hljs-number">1619</span></span> Content-Type: application/json; charset=utf<span class="hljs-number"><span class="hljs-number">-8</span></span> Server: Microsoft-HTTPAPI/<span class="hljs-number"><span class="hljs-number">2.0</span></span> x-ms-request-id: f8cb48b8<span class="hljs-number"><span class="hljs-number">-6</span></span>bb5<span class="hljs-number"><span class="hljs-number">-4813</span></span>-a8e9<span class="hljs-number"><span class="hljs-number">-5</span></span>baffaf49e15 <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>: Sun, <span class="hljs-number"><span class="hljs-number">15</span></span> Mar <span class="hljs-number"><span class="hljs-number">2015</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">44</span></span>:<span class="hljs-number"><span class="hljs-number">31</span></span> GMT { <span class="hljs-string"><span class="hljs-string">"Results"</span></span>: { <span class="hljs-string"><span class="hljs-string">"transactionPrediction"</span></span>: { <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"table"</span></span>, <span class="hljs-string"><span class="hljs-string">"value"</span></span>: { <span class="hljs-string"><span class="hljs-string">"ColumnNames"</span></span>: [ <span class="hljs-string"><span class="hljs-string">"PartitionKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"RowKey"</span></span>, <span class="hljs-string"><span class="hljs-string">"Timestamp"</span></span>, <span class="hljs-string"><span class="hljs-string">"CardId"</span></span>, <span class="hljs-string"><span class="hljs-string">"CrmAccountId"</span></span>, <span class="hljs-string"><span class="hljs-string">"MCC"</span></span>, <span class="hljs-string"><span class="hljs-string">"MerchantId"</span></span>, <span class="hljs-string"><span class="hljs-string">"TransactionAmount"</span></span>, <span class="hljs-string"><span class="hljs-string">"TransactionCreatedTime"</span></span>, <span class="hljs-string"><span class="hljs-string">"TransactionCurrency"</span></span>, <span class="hljs-string"><span class="hljs-string">"TransactionId"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-string"><span class="hljs-string">"Scored Labels"</span></span>, <span class="hljs-string"><span class="hljs-string">"Scored Probabilities"</span></span> ], <span class="hljs-string"><span class="hljs-string">"Values"</span></span>: [ [ <span class="hljs-string"><span class="hljs-string">"990"</span></span>, <span class="hljs-string"><span class="hljs-string">"f31f64f367644b1cb173a48a34817fbc"</span></span>, <span class="hljs-string"><span class="hljs-string">"2015-03-15T20:54:28.6508575Z"</span></span>, <span class="hljs-string"><span class="hljs-string">"349567471"</span></span>, <span class="hljs-string"><span class="hljs-string">"10145"</span></span>, <span class="hljs-string"><span class="hljs-string">"32"</span></span>, <span class="hljs-string"><span class="hljs-string">"990"</span></span>, <span class="hljs-string"><span class="hljs-string">"136.69"</span></span>, <span class="hljs-string"><span class="hljs-string">"2015-03-15T20:54:28.6508575Z"</span></span>, <span class="hljs-string"><span class="hljs-string">"840"</span></span>, <span class="hljs-string"><span class="hljs-string">"f31f64f367644b1cb173a48a34817fbc"</span></span>, <span class="hljs-comment"><span class="hljs-comment">/*    */</span></span> <span class="hljs-string"><span class="hljs-string">"Success"</span></span>, <span class="hljs-string"><span class="hljs-string">"0.779961256980896"</span></span> ] ] } } } }</code> </pre><br><h3>  Stress Testing <br></h3><br>  For the purpose of load testing, we will use Azure's IaaS capabilities ‚Äî let's raise a virtual machine (Instance A8: 8x CPU, 56Gb RAM, 40Gbit / s InfiniBand, Windows Server 2012 R2, $ 2.45 / hr) in the same region (US Central South) our Azure ML web service.  Let's run a task on ~ 20K queries on a VM and look at the results. <br><br>  Listing 3. Service client code and tasks <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Entry point </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public void Main() { var client = new FraudPredictorMLClient(); RequestsStatistics invokeParallelStatistics = client.InvokeParallel(1024, 22); LogResult(invokeParallelStatistics); RequestsStatistics invokeAsyncStatistics = client.InvokeAsync(1024).Result; LogResult(invokeAsyncStatistics); } private static void LogResult(RequestsStatistics statistics) { Contract.Requires</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ArgumentNullException&gt;</span></span></span><span class="hljs-comment">(statistics != null); Func</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;double, string&gt;</span></span></span><span class="hljs-comment"> format = d =&gt; d.ToString("F3"); Log.Info("Results:"); Log.Info("Min: {0} ms", format(statistics.Min)); Log.Info("Average: {0} ms", format(statistics.Average)); Log.Info("Max: {0} ms", format(statistics.Max)); Log.Info("Count of failed requests: {0}", statistics.FailedRequestsCount); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Client for FraudPredictorML web-service </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> public class FraudPredictorMLClient { </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Async invocation of method </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="merchantId"&gt;</span></span></span><span class="hljs-comment">Merchant id</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;exception cref="ArgumentOutOfRangeException"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;paramref name="merchantId"/&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/exception&gt;</span></span></span><span class="hljs-comment"> public async Task</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;RequestsStatistics&gt;</span></span></span><span class="hljs-comment"> InvokeAsync(int merchantId) { Contract.Requires</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ArgumentOutOfRangeException&gt;</span></span></span><span class="hljs-comment">(merchantId &gt; 0); IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TransactionInfo&gt;</span></span></span><span class="hljs-comment"> tis = null; IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TransactionStatistics&gt;</span></span></span><span class="hljs-comment"> tss = null; // upload input data Parallel.Invoke( () =&gt; tis = new TransactionsInfoRepository().Get(merchantId), () =&gt; tss = new TransactionsStatisticsRepository().Get(merchantId) ); var inputs = tis .Join(tss, ti =&gt; ti.TransactionId, ts =&gt; ts.TransactionId, (ti, ts) =&gt; new { TransactionInfo = ti, TransactionStatistics = ts }) .ToList(); // send requests var statistics = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;RequestStatistics&gt;</span></span></span><span class="hljs-comment">(inputs.Count); foreach (var input in inputs) { RequestStatistics stats = await InvokePredictorService(input.TransactionInfo, input.TransactionStatistics).ConfigureAwait(false); statistics.Add(stats); } // return result return new RequestsStatistics(statistics); } </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> Parallel invocation of method (for load testing purposes) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/summary&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="merchantId"&gt;</span></span></span><span class="hljs-comment">Merchant id</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;param name="degreeOfParallelism"&gt;</span></span></span><span class="hljs-comment">Count of parallel requests</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/param&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;exception cref="ArgumentOutOfRangeException"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;paramref name="merchantId"/&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/exception&gt;</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">///</span></span></span><span class="hljs-comment"> </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;exception cref="ArgumentOutOfRangeException"&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;paramref name="merchantId"/&gt;</span></span></span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;/exception&gt;</span></span></span><span class="hljs-comment"> public RequestsStatistics InvokeParallel(int merchantId, int degreeOfParallelism) { Contract.Requires</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ArgumentOutOfRangeException&gt;</span></span></span><span class="hljs-comment">(merchantId &gt; 0); Contract.Requires</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;ArgumentOutOfRangeException&gt;</span></span></span><span class="hljs-comment">(degreeOfParallelism &gt; 0); IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TransactionInfo&gt;</span></span></span><span class="hljs-comment"> tis = null; IEnumerable</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;TransactionStatistics&gt;</span></span></span><span class="hljs-comment"> tss = null; // upload input data Parallel.Invoke( () =&gt; tis = new TransactionsInfoRepository().Get(merchantId), () =&gt; tss = new TransactionsStatisticsRepository().Get(merchantId) ); var inputs = tis .Join(tss, ti =&gt; ti.TransactionId, ts =&gt; ts.TransactionId, (ti, ts) =&gt; new { TransactionInfo = ti, TransactionStatistics = ts }) .ToList(); // send requests var statistics = new List</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt;RequestStatistics&gt;</span></span></span><span class="hljs-comment">(inputs.Count); for (int i = 0; i </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; inputs.Count; i = i + degreeOfParallelism) { var tasks = new List&lt;Task&lt;RequestStatistics&gt;</span></span></span><span class="hljs-comment">&gt;(); for (int j = i; j </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">&lt; i + degreeOfParallelism; j++) { if (inputs.Count &lt;= j) break; var input = inputs[j]; tasks.Add(InvokePredictorService(input.TransactionInfo, input.TransactionStatistics)); } Task.WaitAll(tasks.ToArray()); statistics.AddRange(tasks.Select(t =&gt;</span></span></span><span class="hljs-comment"> t.Result)); } // return result return new RequestsStatistics(statistics); } /* other members */ }</span></span></code> </pre><br>  <i>Call InvokeParallel ():</i> <br>  Best Response Time: 421.683 ms <br>  Worst time: 1355.516 ms <br>  Average time: 652.935 ms <br>  Number of successful requests: 20061 <br>  Number of failures: 956 <br><br>  <i>Call InvokeAsync ():</i> <br>  Best Response Time: 478.102 ms <br>  Worst Time: 1344.348 ms <br>  Average time: 605.911 ms <br>  Number of successful requests: 21017 <br>  Number of failures: 0 <br><br><h2>  Limitations (potential) <br></h2><br>  The bottleneck of the system being developed, at first glance, will be Azure ML.  Therefore, it is extremely important to understand the limitations of Azure ML in general and Azure ML web services in particular.  But on this issue there is very little of both official documentation and the results received from the community. <br><br>  So the question remains with the throttled policy of the Azure ML web service endpoints: the maximum value of parallel requests for the Azure ML web service is not clear (the figure of 20 parallel requests per endpoint is empirically tested), as well as the maximum size of the received message (actual for packet mode service work). <br><br>  Less relevant, but there is a question with the maximum size of input data (Criteo Labs placed dataset on 1 TB of data), the maximum number of predictors and use cases that can be input to the machine learning algorithm in Azure ML. <br><br>  It is critical to reduce the response time of the web service FraudPredictorML, as well as the time to retrain the model to a minimum, but so far there are no official recommendations on how this can be done (and is it even possible at all). <br><br><h2>  Recommendations to customers <br></h2><br>  Antifraud-service does not limit customers in any way in the preliminary verification of payments, and in the subsequent interpretation of the prediction results.  Preliminary checks specific to the business process, as well as the final decision on accepting / declining a payment, are tasks that clearly fall outside the area of ‚Äã‚Äãresponsibility of the anti-fraud service. <br><br>  Regardless of the role of the client - an online store, a payment system or a bank - the following recommendations exist for customers: <br><ul><li>  perform a preliminary check of payments, using technologies accepted in the industry (fingerprint, etc.), and using your own knowledge of the client (order history, etc.); <br></li><li>  interpret the result using the following practice: fraud probability is less than 0.35 - accept payment without 3D-Secure, probability from 0.35 to 0.85 - accept payment with 3DS enabled, fraud probability - more refuse; <br></li><li>  choose the levels proposed in the previous paragraph based on your own analytics and regularly review them (minimize lost profits and fraud penalties). <br></li></ul><br><div class="spoiler">  <b class="spoiler_title">Recommendations for commenting</b> <div class="spoiler_text">  In the framework of this series of articles, we dealt with the problems of the issue, the legal and technical aspects of the problem.  This is a <strong>technical article</strong> , it <strong>does not aim to create a business plan</strong> , compare it with the decisions of competitors, calculate the discounted value of the project.  With all these questions <del>  at RBC </del>  - not to me, not to this hub, and, there is a suspicion, not even to this site. <br></div></div><br><h2>  Conclusion <br></h2><br>  In this cycle, consisting of 4 articles, we conducted an experiment on the design and development of a <strong>highly scalable, fault-tolerant, reliable antifraud-service operating in near real-time mode, with open for external REST / JSON API clients.</strong> <br><br>  The use <em>of machine learning algorithms</em> (decision tree, neural networks) allowed us to create an analytical system <em>capable of self-learning</em> both on accumulated history and on new payments.  Through the use of <em>PaaS- / IaaS-services, it was possible to reduce the initial financial costs of infrastructure</em> and software to almost zero.  The <em>fact</em> that the developer has <em>competencies in the subject area, data science, and distributed systems architecture has</em> helped dramatically <em>reduce the number of participants in the development team.</em> <br><br>  As a result, in less than 60 man-hours and with minimal initial infrastructure costs (&lt;$ 150, which were covered from an MSDN subscription), it was possible to create an antifraud system core. <br><br>  The resulting service, of course, requires more careful verification (and subsequent correction) of the main modules, more fine-tuning of the classifier (s), the development of a series of auxiliary subsystems, interest, and (no secret) investments.  But despite the above-mentioned defects, the service is <em>an order of magnitude (and more) more efficient than similar developments in the industry,</em> both in terms of development costs and in terms of the cost of ownership. <br><br><h4>  Other parts of the article </h4><br>  If it remains unclear <a href="https://habr.com/post/253725/">to you what the problem is</a> (part 1). <br>  If you didn't miss, <a href="https://habr.com/post/253731/">why fraud problem</a> <del>  <a href="https://habr.com/post/253731/">long and expensive</a> </del>  <a href="https://habr.com/post/253731/">difficult to solve</a> (part 2). <br>  If you are interested in <a href="https://habr.com/post/254037/">how it looks from the point of view of software architecture</a> (part 3). <br><br><br>  Dmitry Petukhov <br><del>  Software Architect &amp; Developer, Big Data Enthusiast, Microsoft Certified Professional </del><br>  architect, developer, enthusiast, tireless researcher and coffee lover <br></div><p>Source: <a href="https://habr.com/ru/post/254683/">https://habr.com/ru/post/254683/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254673/index.html">Softbank is going to connect talking robot Pepper to IBM Watson</a></li>
<li><a href="../254675/index.html">Code optimization with RequireJS: how it is done and why it is needed</a></li>
<li><a href="../254677/index.html">Unity 3d 4.6 (5) project Survival shooter game in Russian</a></li>
<li><a href="../254679/index.html">Unity support at Consulo for 2015 in one post</a></li>
<li><a href="../254681/index.html">Ionic framework. Ecosystem overview</a></li>
<li><a href="../254685/index.html">Hacking drones</a></li>
<li><a href="../254687/index.html">Easter assembly Vivaldi 1.0.142.32</a></li>
<li><a href="../254689/index.html">Akvaponika do it yourself with the use of a microcontroller</a></li>
<li><a href="../254693/index.html">7 amazing facts about vocational guidance</a></li>
<li><a href="../254697/index.html">Wordpress: Cloud Storage Plugins</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>