<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Cost-effective code 2: crouching DDD, Hidden CQRS</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Three programmers were asked to cross the field, and walk to the house on the other side. The novice programmer looked at a short distance and said, ‚Äú...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Cost-effective code 2: crouching DDD, Hidden CQRS</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/fa2/152/377/fa21523771534f1fa7c924421d320a12.jpg"><br><blockquote>  Three programmers were asked to cross the field, and walk to the house on the other side.  The novice programmer looked at a short distance and said, ‚ÄúThis is not far away!  It will take me ten minutes. ‚Äù  An experienced programmer looked at the field, thought a little, and said: "I could get there in a day."  The newcomer looked at him in surprise.  The guru programmer looked at the field and said.  "It seems about ten minutes, but I think fifteen will be enough."  An experienced programmer laughed. <br><br>  The novice programmer set off, but within a few moments, mines began to explode, leaving behind large pits.  From the explosions, he flew back, and he had to start over and over again and again.  It took him two days to reach the goal.  In addition, he was all shaking and was wounded when he came. <br><br>  An experienced programmer crawled on all fours.  Carefully touching the ground and looking for mines, moving only if I was sure that it was safe.  Slowly and carefully he crossed the field during the day.  Just hitting a couple of minutes. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Guru programmer set off, and went straight across the field.  Purposeful and straight.  He reached the goal in just ten minutes. <br>  ‚ÄúHow did you manage to do this?‚Äù Asked two others. ‚ÄúHow did you manage not to catch a single mine?‚Äù <br>  ‚ÄúEasy,‚Äù he replied.  "I did not lay mines on my way." <br></blockquote><br>  Sadly, you have to admit - we are laying our own mines.  In the <a href="http://habrahabr.ru/post/233221/">first part,</a> I detailed the main risks in software development and described the technological and methodological ways to mitigate these risks.  Over the past year, I received many comments, the main meaning of which was as follows: ‚Äúeverything is cool, but where to start and how it will look in the real world‚Äù.  Indeed, the first text is rather theoretical and represents a catalog of links.  In this article I will try to give as many examples as possible. <br><a name="habracut"></a><br>  Programmers who do not have sufficient experience may not understand many of the problems described in the <a href="http://habrahabr.ru/post/233221/">first article</a> , because they manifest themselves only in a long run: there is not much difference in how a website is written on ten pages with a pair of filter forms and a CRUD admin panel, all code can be rewritten from scratch in a couple of days.  But what will happen in a year or two? <br><br>  Our site begins to develop, new functionality appears, there are already a few dozen pages and molds, affiliate programs with external resources are added.  We advertised on the million-plus Vkontakte public and the main page ‚Äúdeveloped‚Äù under load.  Do not worry, stick cache.  Now you need to quickly start with friendly service.  Copy-paste integration code with a partner from its code base, we write to synchronize "our" and "external" data. <br><br>  Changes in business rules begin, which have to be duplicated in the code and stored in the subject area, the cache of the main page needs to be updated periodically, the number of bugs and configuration problems in the backlog is growing. <br>  6-7 iterations of changes in business rules, integrations, optimization of performance and expansion of functionality take place, and now we have the Frankenstein monster, stitched from sample code from Stack Overflow, SDK code of partners, crutches and hotpatches, various incredibly useful 3rd party components and own bicycles . <br><br><h2>  The main problems that I have to fix in the code 2-3 years old </h2><ol><li>  repeating the boiler-plate-code (all sorts of using, try-catch, log, etc.): makes it difficult to make changes to the code base and refatoring, imperceptibly eats up the time to write the same constructions (seconds at the beginning of the project, days after a year or two the existence of a code base) </li><li>  code duplication, including implicit, mindless creation of identical classes of Entity, DTO and ViewModel, duplication of Linq-requests, creation of similar interfaces ITEntityRepository: IRepository &lt;TEntity&gt;, having only one implementation </li><li>  SRP violation: stuffing properties into Entity from different contexts and even not related to the home model, creating various managers, services and helper ones with unclear responsibility </li><li>  LSP violation </li><li>  NullReferenceException </li><li>  data errors </li><li>  creating feedback, mixing application layers, infrastructure code and domain model code </li></ol><br>  <b>Usually the excuses for all this disgrace are:</b> <br><ol><li>  short release dates </li><li>  no time to refactor </li><li>  lack of time to plan and design (what architecture? Need to figure out!) </li></ol><br>  In general, all this is true, but it must be admitted that even experienced developers often lack the ‚Äúmatte part‚Äù to quickly make the right decisions.  By true, I understand the following state of things: 80% of you write code that performs a business case, and 20% a small reserve for the future, each time guessing exactly what 20% should be written (in other words, how the requirements change).  To guess what the stakeholders want (as the domain model of the application will change) usually requires management experience and / or experience in the subject area. <br><br>  <b>However, there are a number of requirements arising in many growing projects:</b> <br><ol><li>  multi-user access (notorious habr-effect), counting viewing hits, likes, etc. </li><li>  analytics and personalization (building sales funnels, analyzing user preferences in order to offer more relevant content) </li><li>  full text search </li><li>  performing pending tasks and scheduled tasks </li><li>  filtering, conversion and pagination </li><li>  logging, notification system, monitoring, self-diagnostics, self-recovery after failures and error handling </li></ol><br>  In this article I will focus on the separation of the domain (business rules) from the application infrastructure.  Every AOP, dynamic compilation and other magic will be left for the next time. <br><br><h2>  10 application layers should be enough for everyone </h2><img src="https://habrastorage.org/files/68f/47a/8dc/68f47a8dca0d4fa2b904ca407c45306c.png"><br><br>  For a ‚Äúregular web application in a vacuum,‚Äù I counted a maximum of 10 layers.  Is it a lot or a little?  Given that you can "cut corners" and get along with the classic three, I think that is just right.  We take out for brackets endpoits, a deyte-mapper, a publisher-subskrayber, intceptors.  Remained: <br><ol><li>  Services </li><li>  Command / Query </li><li>  Entity </li><li>  DAO </li></ol><br>  In order to put everything in its place, let's start with the simplest case of a web application - landing page. <br><blockquote>  The landing page (English ‚Äúlanding page‚Äù) is a web page built in a certain way, the main task of which is to collect contact information of the target audience.  Used to enhance the effectiveness of advertising, increasing the audience ... </blockquote><br>  We have one page and it collects "leads".  Lead must have email.  Optional fields on the form will be the phone and name.  Create a Lida class: <br><pre><code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IEntity</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Lead</span></span> : <span class="hljs-title"><span class="hljs-title">IEntity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;Func&lt;Lead, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; ProcessedRule = x =&gt; x.Processed; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _email; [Key, Required, Index(<span class="hljs-string"><span class="hljs-string">"IX_Email"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, IsUnique = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _email; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"email"</span></span>); } _email = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Phone { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Processed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime CreatedDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } [Obsolete(<span class="hljs-string"><span class="hljs-string">"Only for model binders and EF, don't use it in your code"</span></span>, <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lead</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lead</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phone = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { Email = email; Phone = phone; CreatedDate = DateTime.Now; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsProcessed</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Is(ProcessedRule); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Email; } }</code> </pre> <br><br><h2>  Entity, Rich Domain Model and defensive programming (aka encapsulation) </h2>  Controversy: <a href="http://samolisov.blogspot.ru/2012/10/anemic-domain-model.html">samolisov.blogspot.ru/2012/10/anemic-domain-model.html</a> <br>  I am a supporter of a rich domain model (Rich Domain Model) and I don‚Äôt like an anemic one, so Lead has the right designer and does not allow himself to be transferred to an inconsistent state (break the invariant).  Modern ORM frameworks, whose ancestors spawned anemic models, already allow you to follow the principles of encapsulation (well, almost).  The access modifier internal comes to the rescue.  Especially for those who do not wash their hands and within the domain assembly uses the default constructor there is an attribute [Obsolete].  The second parameter will break the build when trying to use this constructor explicitly, while your ORM and ModelBinder will easily take advantage of this constructor. <br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">Obsolete(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Only for model binders and EF, don't use it in your code"</span></span></span><span class="hljs-meta">, true)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">internal</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lead</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Lead</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">[NotNull] </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> phone = </span></span><span class="hljs-literal"><span class="hljs-function"><span class="hljs-params"><span class="hljs-literal">null</span></span></span></span></span><span class="hljs-function">)</span></span> { Email = email; Phone = phone; CreatedDate = DateTime.Now; }</code> </pre><br>  There is no guarantee that the junior will not remove it, but such things can be solved in the course of the code review. <br><br>  Properties in .NET were invented not only in order to map them to the database.  With such an organization code, you will fall exactly in the place where you try to set the wrong email, and not while saving to the database, which can be very far from the moment of setting the value, especially during mass operations. <br><br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">Key, Required, Index(</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"IX_Email"</span></span></span><span class="hljs-meta">, 1, IsUnique = true)</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _email; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"email"</span></span>); } _email = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } }</code> </pre><br>  The constructor also uses the Email property, so the invariant is securely protected. <br>  It's easier for me to work this way, the rule follows from here - Code First.  First, I write a domain model, and then I create an auto-migration (so I use the Entity Framework) and execute it. <br><br>  From my point of view, there is nothing wrong with replacing an access to a designer without parameters with a public one (public) and writing like this without creating unnecessary DTO and ViewModel of the same type: <br><pre> <code class="hljs cs"> [<span class="hljs-meta"><span class="hljs-meta">HttpPost</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Index</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Lead lead</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!ModelState.IsValid) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(lead); } <span class="hljs-comment"><span class="hljs-comment">//‚Ä¶ }</span></span></code> </pre><br>  Under the conditions: <br><ol><li>  Lead class is not an aggregation root </li><li>  application form has one-to-one mapping to the lead class </li><li>  no-parameter constructor protected by the Obsolete attribute </li></ol><br>  Otherwise, create a DTO and / or ViewModel and use DataMapper. <br><br><h2>  <a href="http://habrahabr.ru/post/147363/">Monad Maybe</a> </h2>  While Visual Studio 2015 comes out of CTP with new operators, this monad helps keep the code readable.  Using Maybe in conjunction with JetBrains.Annotations and Possible NullReferenceException as error in R # ensures that there is no NullReferenceException in your code.  In fact, this is the implementation of the NullObject pattern in a functional style. <br><br><h2>  Business Logic and Infrastructure Separation (DDD) </h2>  The main controversy around DDD revolves around the following theses: <br><ol><li>  C too few publicly available examples with DDD on the network, it is not clear what it is all about </li><li>  what to consider as a domain, and what infrastructure </li><li>  DDD is very long and expensive compared to the ‚Äúop-op, ready code‚Äù methodology </li></ol><br>  Reading the <a href="http://www.ozon.ru/context/detail/id/5497184/">book of Evans</a> was for me the second sharp turn in understanding the code, after <a href="http://habrahabr.ru/post/136049/">The Art of Unit Testing</a> .  For 10 years in software development, I managed to get a good look at a large number of code bases.  Thank God, already in all programming languages ‚Äã‚Äãthere is a basic platform (framework) and a package manager and it never occurs to anyone to write their MVC framework with blackjack and courtesans. <br><br>  However, business logic can be found in various places of the application: in stored procedures, helperes, managers, services, telecontrollers, repositories, linq queries.  In the absence of clear rules, each developer will organize the business logic in accordance with his ideas of beauty. <br><br>  <b>This creates a whole bunch of problems:</b> <br><ol><li>  it is not clear where to look for a business rule </li><li>  it is impossible to clearly answer the question of what is the test coverage of a domain model code, </li><li>  code to procedural style, encapsulation broken </li><li>  there is a danger of duplicating a business rule in two or more places (for example, in the c # code and stored procedure code. If requirements change, you are more likely to remember to change the rule only in one place. As a result, the discrepancy will remain and may emerge in a few months. Deal with the problem will be other people and not the fact that they know how to ‚Äúmust be right.‚Äù In addition, managers and helperies are classes with vague responsibility, most likely turning into God-objects with time </li><li>  dependencies between assemblies are not regulated in any way.  Classes of domain models with the light hand of junior can easily begin to depend on the web context and build Common.Web </li></ol><br>  <b>At a higher level, this translates into:</b> <br><ol><li>  slowing down the pace of development, down to the state when the entire full time team is busy supporting and eliminating bugs </li><li>  permanent bugfixing and crushing </li><li>  the need to allocate additional resources to support and eliminate errors in the application database </li></ol><br>  For me, Evans DDD is a way to standardize work with business logic.  DDD offers a set of patterns for this.  Let's look at the main ones.  At the same time, let's ‚Äúmarry‚Äù them with another ‚Äúfashionable‚Äù concept - CQRS. <br><br><h4>  How is this related to DDD? </h4>  DDD tells us the <s>flies</s> domain separately, the infrastructure - separately.  Ok we have an ‚Äúentity‚Äù. <br><br><h2>  Entity </h2><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IEntity</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetId</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; }</code> </pre><br>  An entity is anything that has a unique identifier.  Two nails in the bag - not Entity, because you can not distinguish one from the other.  In terms of domain, they are identical.  But Vasya and Peter for our tax - Entity.  They have a TIN (taxpayer identification number). <br><br><blockquote>  In modern applications, the auto-incrementable integer value or GUID is most often used as an Id.  Despite the prevalence of this approach, in some cases it can create situations that require special handling.  If you have ever bought tickets from an aggregator, then you know that the aggregator reservation number may not match the airline's reservation number.  This is due to the fact that the carrier has its own IT system, and the aggregator has its own. </blockquote><br>  Let's go back to the landing page example and the lead.  My most abstract IEntity implementation is a method that returns an Id as a string.  I intentionally use a method, not a property.  All properties of the class Lead are mapped on the database fields.  This will help avoid ambiguity and the need to peek into the mapping.  The primary key is Email, not Id.  If I implemented the Id property, I would have to explicitly indicate that the Id property is mapped on the Email field in the database, besides that, it would create problems with other types of primary keys (integer and guid) <br><br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Lead</span></span> : <span class="hljs-title"><span class="hljs-title">IEntity</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> _email; [Key, Required, Index(<span class="hljs-string"><span class="hljs-string">"IX_Email"</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, IsUnique = <span class="hljs-literal"><span class="hljs-literal">true</span></span>)] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Email { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _email; } <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrEmpty(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ArgumentNullException(<span class="hljs-string"><span class="hljs-string">"value"</span></span>); } _email = <span class="hljs-keyword"><span class="hljs-keyword">value</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> Phone { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span> Processed { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime CreatedDate { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// IEntity Implementation public string GetId() { return Email; }</span></span></code> </pre><br>  I have already said that I use as the main, but not the only, ORM Entity Framework.  Main reasons: <br><ol><li>  automatic generation of migrations (saves a lot of time and frees you from writing routine code) </li><li>  best linq support in .NET </li><li>  developing faster than NHibernate </li><li>  supports DataAnnotation-attributes for data mapping and creating migrations </li></ol><br><h2>  Fluent mapping VS Atribute mapping </h2>  The taste and color of all markers of course are different.  Fluent mapping is cleaner and allows you not to drag EF depending on the domain assembly, but I do not like its verbosity and the need to support 2 classes: entities and mapping.  Someone might say, they say this is a violation of the SRP.  My opinion - the attributes are not imperative code and such a comparison is not correct.  I see the difference only in the form of the record and the extra dependence on EF, which, however, is easily cut when necessary. <br><br><h2>  Persistence ignorance </h2>  So, we have domain entities and they need to be created, processed, saved, filtered, obtained from some data source and deleted.  In common people this is called CRUD-operations.  We can create an entity with the help of the operator new, not forgetting that we need to use the "correct" constructor that does not violate the invariant of the object.  We have declared the default constructor only for ORM support and were protected from dirty hands with the [Obsolete] attribute. <br><br>  How can we save an object and get it from a data source?  In modern frameworks, two approaches are used: Active Record (AR) and Unit of Work (UoW).  I am a categorical opponent of Active Record.  It is possible that in interpreted PLs AR it gives advantages, but not in compiled ones.  AR most horribly violates SRP by adding the Entity Save method to everyone.  The task of Entity is to implement business logic and encapsulate data, and not to save itself in the database.  Therefore, my choice is UoW. <br><pre> <code class="hljs cs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-title"><span class="hljs-title">IUnitOfWork</span></span>: <span class="hljs-title"><span class="hljs-title">IDisposable</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Commit</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Save&lt;TEntity&gt;(TEntity entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> Delete&lt;TEntity&gt;(TEntity entity) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, <span class="hljs-title"><span class="hljs-title">IEntity</span></span>; }</code> </pre><br>  For EF, the implementation of UoW will be the DataContext of your application.  However, the DataContext itself will not stick into the domain assemblies.  First, why do we need a dependence on EF here?  Secondly, it is often enough to implement the Bounded Context in order to separate the development teams, while migration is better left within the same DataContext to eliminate the option of desynchronization of the data schema. <br><br>  How to save, edit and delete is understandable.  There is a function to get data.  Traditionally this function is implemented using repositories.  And traditionally implemented "sloppy".  Details of the problem are described in the article ‚Äú <a href="http://blog.byndyu.ru/2011/08/repository.html">problem repository pattern</a> ‚Äù. <br><br>  <b>In short, first you do this:</b> <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">IEnumerable&lt;T&gt; </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Add</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T entity)</span></span></span></span>; <span class="hljs-function"><span class="hljs-function">bool </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Remove</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(T entity)</span></span></span></span>; }</code> </pre><br>  The result is: <br><pre> <code class="hljs cpp"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AccountRepository</span></span></span><span class="hljs-class"> :</span></span> IRepository&lt;Account&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Account </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Account </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Account </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByAge</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> age)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Account </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByNameAndEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email)</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Account </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetByNameOrEmail</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> name, </span></span><span class="hljs-built_in"><span class="hljs-function"><span class="hljs-params"><span class="hljs-built_in">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> email)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">// ... public Account GetByAreYouFuckingKiddingMe(SomeCriteria c); }</span></span></code> </pre><br>  You get out of this situation (I do not consider the option with extension-methods, for the reasons stated below): <br><pre> <code class="hljs java"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-function"><span class="hljs-function">T </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetById</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> id)</span></span></span></span>; <span class="hljs-comment"><span class="hljs-comment">//   IQueryable&lt;T&gt; Query(); bool Add(T entity); bool Remove(T entity); }</span></span></code> </pre><br>  But break off like this: <br><pre> <code class="hljs objectivec"><span class="hljs-comment"><span class="hljs-comment">//   - repo.Query().Where(a =&gt; a.IsDeleted = false); //   ,        repo.Query().Where(a =&gt; a.IsDeleted = false &amp;&amp; a.Balance &gt; 0); // runtime error repo.Query().Where(a =&gt; a.CreationDate &lt; getCurrentDate());</span></span></code> </pre><br>  In the last example, the first two linq queries illustrate changes to the ‚Äúactive account‚Äù business rule.  At first, we considered active not deleted, and then the requirement ‚Äúthe balance should be greater than zero‚Äù was added.  Since linq queries are very easy to write, they are likely to be copied to a dozen places in the code base.  Almost certainly somewhere will change, but somewhere will be forgotten. <br><br>  The third example will compile perfectly, but crash at runtime because ORM will not understand how to translate your getCurrentDate function to SQL.  If time is running out, and the junior has got the task, he quickly ‚Äúfinished‚Äù the code with a file like this: <br><pre> <code class="hljs javascript">repo.Query().ToEnumerable().Where(<span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">a</span></span></span><span class="hljs-function"> =&gt;</span></span> a.CreationDate &lt; getCurrentDate());</code> </pre><br>  And all 3 million accounts will rise into RAM. <br><br>  <b>There are still implicit problems with providing IQueryable to the outside:</b> <br><ol><li>  IQueryable ‚Äúleaks‚Äù and <a href="http://blog.ploeh.dk/2013/07/20/linq-versus-the-lsp">clearly violates the LSP</a> .  The only IQueryable implementation that "digests" any exploits you feed it is in-memory.  But for in-memory, you have a linq2object, which removes any meaning from IQueryable.  Any where request is a potential point of failure for your code. </li><li>      linq.  -     ,    Sphinx'  Elastic'.  ,   ¬´   linq-¬ª     ( , ).    ,     ,   ,         </li><li>         ,              NOSQL-. ,         -,  ..   </li></ol><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first problem is not solved in principle. </font><font style="vertical-align: inherit;">This is in linq by-design. </font><font style="vertical-align: inherit;">And sin to complain, linq is very convenient. </font><font style="vertical-align: inherit;">Points two and three hint that IQueryable is not suitable as an abstraction for all occasions, because in the real world not all .NET developers have a half-kick to parse the expression trees and write their linq provider during the day to any data source. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Well, that all have come up with for us</font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Specification aka Filter </font></font></h2><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ISpecification&lt;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T:IEntity { <span class="hljs-type"><span class="hljs-type">bool</span></span> IsSatisfiedBy(T o); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IRepository&lt;T&gt; { T GetById(<span class="hljs-type"><span class="hljs-type">int</span></span> id); //   IEnumerable&lt;T&gt; GetBySpecification(ISpecification&lt;T&gt; spec); <span class="hljs-type"><span class="hljs-type">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(T entity); <span class="hljs-type"><span class="hljs-type">bool</span></span> Remove(T entity); }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The specification is a business filtering rule. Only one method, or the object satisfies the condition, or - no. In the current form, the specification solves the problem of duplicating the code: now you do not have Linq and you have to write your own specification class for each filter rule. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">But, excuse me, why is this necessary? We cannot translate IsSatisfiedBy into SQL, which means we will have to raise all records from the database again and filter by them. Now we need to write a specification for each sneeze, and therefore create a set of classes that are used exactly once (in the interface where you need to filter the data in a certain way). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Indeed, the whole discussion is underway, they say the </font></font><a href="http://www.minddriven.de/index.php/technology/dot-net/c-sharp/specification-pattern-obsolete"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">‚Äúspecification‚Äù pattern is outdated with the advent of linq</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> . </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The first thing that astronauts offer architecture:</font></font><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IExpressionSpecification</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ISpecification</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">class</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity { Expression</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Func&lt;T, bool</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Expression</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IRepository</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span></span>{ T GetById(int id); <span class="hljs-comment"><span class="hljs-comment">//   IEnumerable&lt;T&gt; GetBySpecification(IExpressionSpecification&lt;T&gt; spec); bool Add(T entity); bool Remove(T entity); }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You do not need to have super-abilities to see the same eggs, a profile view with an additional unnecessary layer in the form of a specification. </font><font style="vertical-align: inherit;">Moreover, the problem of duplicating linq requests in code can be elegantly solved like this:</font></font><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Account</span></span> : <span class="hljs-title"><span class="hljs-title">IEntity</span></span> { [BusinessRule] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;Func&lt;Lead, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; ActiveRule = x =&gt; x.IsDeleted &amp;&amp; x.Ballance &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre><br><h4>  Eventually </h4><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> The repository will not be able to effectively use as a base abstraction for all data sources. </font></font></li><li> <b><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">linq is very convenient, but not suitable everywhere for economic reasons or performance restrictions</font></font></b> </li></ol><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> CQ [R] S - Command, Query [Responsibility] Segregation </font></font></h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Or in Russian, the division of reading and writing. </font><font style="vertical-align: inherit;">The principle has found the greatest application in the loaded systems. </font><font style="vertical-align: inherit;">A classic example is a feed on social networks: you need to pull data from a pile of tables for all your friends and remember to take into account how everyone likes and reposits your photos. </font><font style="vertical-align: inherit;">The classic implementation is not suitable for this task - too many joins and read / write locks. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The usual solution is to separate read and write to avoid blocking. </font><font style="vertical-align: inherit;">Denormalization strategies may be different, but the main point comes down to:</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> get rid of joins, read flat data </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> avoid read / write locks </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> synchronize data "in the background", accumulating changes </font></font></li></ol><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Thus, the classic repository is divided into two interfaces: Command and Query. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Command implements add, edit, and delete, and Query reads data.</font></font><br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IQuery&lt;TEntity, <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> TSpecification&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, IEntity <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TSpecification : ISpecification&lt;TEntity&gt; { IQuery&lt;TEntity, TSpecification&gt; <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>([<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] TSpecification specification); IQuery&lt;TEntity, TSpecification&gt; OrderBy&lt;TProperty&gt;( [<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] Expression&lt;Func&lt;TEntity, TProperty&gt;&gt; expression, SortOrder sortOrder = SortOrder.<span class="hljs-keyword"><span class="hljs-keyword">Asc</span></span>); IQuery&lt;TEntity, TSpecification&gt; <span class="hljs-keyword"><span class="hljs-keyword">Include</span></span>&lt;TProperty&gt;([<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] Expression&lt;Func&lt;TEntity, TProperty&gt;&gt; expression); [<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] TEntity Single(); [CanBeNull] TEntity FirstOrDefault(); [<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] IEnumerable&lt;TEntity&gt; <span class="hljs-keyword"><span class="hljs-keyword">All</span></span>(); [<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] IPagedEnumerable&lt;TEntity&gt; Paged(<span class="hljs-type"><span class="hljs-type">int</span></span> pageNumber, <span class="hljs-type"><span class="hljs-type">int</span></span> take); long Count(); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICommand { <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface ICommand&lt;<span class="hljs-keyword"><span class="hljs-keyword">in</span></span> T&gt; { <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(T context); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> interface IPagedEnumerable&lt;<span class="hljs-keyword"><span class="hljs-keyword">out</span></span> T&gt; : IEnumerable&lt;T&gt; { long TotalCount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> CreateEntityCommand&lt;T&gt; : UnitOfWorkScopeCommand&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, IEntity { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(T context) { UnitOfWorkScope.GetFromScope().Save(context); UnitOfWorkScope.GetFromScope().<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> CreateEntityCommand([<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] IScope&lt;IUnitOfWork&gt; unitOfWorkScope) : base(unitOfWorkScope) { } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> DeleteEntityCommand&lt;T&gt; : UnitOfWorkScopeCommand&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, IEntity { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> DeleteEntityCommand([<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] IScope&lt;IUnitOfWork&gt; unitOfWorkScope) : base(unitOfWorkScope) { } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> override <span class="hljs-type"><span class="hljs-type">void</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Execute</span></span>(T context) { UnitOfWorkScope.GetFromScope().<span class="hljs-keyword"><span class="hljs-keyword">Delete</span></span>(context); UnitOfWorkScope.GetFromScope().<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } }</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The primary responsibility of Query is to translate a specification (domain filtering rule) into a request to a data source (infrastructure). </font><font style="vertical-align: inherit;">Query provides an abstraction from the data source - to us it doesn't matter where we get the data from, and the specification is a kind of linq +. </font><font style="vertical-align: inherit;">For data sources that support linq, you can use ExpressionSpecification. </font><font style="vertical-align: inherit;">In cases when using linq is difficult (there is no provider, for example, as in the case of Elastic Search), we throw out the Expression and use our specification.</font></font><br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IExpressionSpecification</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ISpecification</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class">:</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">class</span></span></span><span class="hljs-class">,</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity { Expression</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Func&lt;T, bool</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Expression</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> static IQuery&lt;TEntity, IExpressionSpecification&lt;TEntity&gt;&gt; Where&lt;TEntity&gt;( <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> IQuery&lt;TEntity, IExpressionSpecification&lt;TEntity&gt;&gt; query, Expression&lt;Func&lt;TEntity, bool&gt;&gt; expression) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity { return query.Where</span></span></span></span>(new ExpressionSpecification&lt;TEntity&gt;(expression)); }</code> </pre><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> To filter data in RAM, you can use an instance of the specification, and the translation of the specification in the query to the data source go to Query. </font></font><br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ICommandFactory, IQueryFactory </font></font></h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Creating a large number of small command and query objects can be a tedious task; it is logical to register them in an IOC container by convention. </font><font style="vertical-align: inherit;">In order not to drag your container to all assemblies and not to create a ServiceLocator, we will assign this responsibility to the factories.</font></font><br><pre> <code class="hljs kotlin"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ICommandFactory</span></span></span><span class="hljs-class"> </span></span>{ TCommand GetCommand&lt;TEntity, TCommand&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TCommand : ICommand&lt;TEntity&gt;; T GetCommand&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : ICommand; CreateEntityCommand&lt;T&gt; GetCreateCommand&lt;T&gt;() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity; DeleteEntityCommand</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetDeleteCommand</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">T</span></span></span><span class="hljs-class">&gt;</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity; } public interface IQueryFactory { IQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity, IExpressionSpecification&lt;TEntity</span></span></span><span class="hljs-class">&gt;&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity</span></span></span><span class="hljs-class">&gt;</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity; IQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity, TSpecification</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity, TSpecification</span></span></span><span class="hljs-class">&gt;</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity where TSpecification : ISpecification</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity</span></span></span><span class="hljs-class">&gt;; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TQuery</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">GetQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity, TSpecification, TQuery</span></span></span><span class="hljs-class">&gt;</span></span>() <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">, </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IEntity where TSpecification: ISpecification</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">where</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">TQuery</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">IQuery</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TEntity, TSpecification</span></span></span><span class="hljs-class">&gt;; }</span></span></code> </pre><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Then work with query will look like this. </font></font></h2><br><pre> <code class="hljs pgsql">_queryFactory.GetQuery&lt;Product&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(Product.ActiveRule) //   ,     Account.  ExpressionSpecification .OrderBy(x =&gt; x.Id) .Paged(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) //  <span class="hljs-number"><span class="hljs-number">10</span></span>     //        ElasticSearch,  : _queryFactory.GetQuery&lt;Product, FullTextSpecification&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> FullTextSpecification(¬´¬ª)) .<span class="hljs-keyword"><span class="hljs-keyword">All</span></span>() //  EF          Dapper _queryFactory.GetQuery&lt;Product, DictionarySpecification, DapperQuery&gt;() .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> DictionarySpecification (someDirctionary)) .<span class="hljs-keyword"><span class="hljs-keyword">All</span></span>()</code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In all cases, we use the same code, and the _queryFactory.GetQuery construction &lt;Product, DictionarySpecification, DapperQuery&gt; () clearly indicates to us that this is an optimization. This line appeared in the code only in the course of evolutionary refactoring, because first we wrote on ORM, for the sake of speed of development. If there is a person in the team who is well versed in expression trees, you can gradually translate all queries to linq (although in real life it is almost impossible for economic reasons). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the case of _queryFactory.GetQuery &lt;Product, FullTextSpecification&gt; (), we specify the ‚Äúfull-text specification‚Äù, but the domain code does not know that the returned instance is ElasticSearchQuery. For him, this is just a ‚Äúfull text search‚Äù filtering rule. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Controversy on the topic:</font></font><a href="http://habrahabr.ru/post/125720/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">habrahabr.ru/post/125720</font></font></a> <br><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Some syntactic sugar </font></font></h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Let's go back to the example: </font></font><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Account</span></span> : <span class="hljs-title"><span class="hljs-title">IEntity</span></span> { [BusinessRule] <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;Func&lt;Lead, <span class="hljs-keyword"><span class="hljs-keyword">bool</span></span>&gt;&gt; ActiveRule = x =&gt; x.IsDeleted &amp;&amp; x.Ballance &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">IsActive</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//     ??? } }</span></span></code> </pre><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The ‚Äúactive account‚Äù business rule is in a logical place and reused. </font><font style="vertical-align: inherit;">No need to fear scattered throughout the project lambda. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Sometimes this requirement is needed in the form of Expression &lt;Func &lt;Lead, bool &gt;&gt; - for translation into a query to a data source, and sometimes in the form of Func &lt;Lead, bool &gt;&gt; - for filtering objects in memory and providing properties like IsActive. </font><font style="vertical-align: inherit;">Creating a specification class for every sneeze doesn't seem like a good idea. </font><font style="vertical-align: inherit;">When can use the following implementation:</font></font><br><pre> <code class="hljs pgsql"> <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Extensions { private static readonly ConcurrentDictionary&lt;Expression, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt; _cachedFunctions = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ConcurrentDictionary&lt;Expression, <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;(); <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static Func&lt;TEntity, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt; AsFunc&lt;TEntity&gt;(this <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> entity, Expression&lt;Func&lt;TEntity, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;&gt; expr) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, IEntity { //@see http://sergeyteplyakov.blogspot.ru/<span class="hljs-number"><span class="hljs-number">2015</span></span>/<span class="hljs-number"><span class="hljs-number">06</span></span>/lazy-trick-<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-concurrentdictionary.html <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (Func&lt;TEntity, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;)_cache.GetOrAdd(expr, id =&gt; <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> Lazy&lt;<span class="hljs-keyword"><span class="hljs-keyword">object</span></span>&gt;( () =&gt; _cache.GetOrAdd(id, expr.Compile()))); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static <span class="hljs-type"><span class="hljs-type">bool</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span>&lt;TEntity&gt;(this TEntity entity, Expression&lt;Func&lt;TEntity, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;&gt; expr) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity: <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, IEntity { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> AsFunc(entity, expr).Invoke(entity); } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static IQuery&lt;TEntity, IExpressionSpecification&lt;TEntity&gt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>&lt;TEntity&gt;( this IQuery&lt;TEntity, IExpressionSpecification&lt;TEntity&gt;&gt; query, Expression&lt;Func&lt;TEntity, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;&gt; expression) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> TEntity : <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>, IEntity { <span class="hljs-keyword"><span class="hljs-keyword">return query</span></span> .<span class="hljs-keyword"><span class="hljs-keyword">Where</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ExpressionSpecification&lt;TEntity&gt;(expression)); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> ExpressionSpecification&lt;T&gt; : IExpressionSpecification&lt;T&gt; <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T:<span class="hljs-keyword"><span class="hljs-keyword">class</span></span>,IEntity { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> Expression&lt;Func&lt;T, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;&gt; Expression { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; private <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } private Func&lt;T, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt; _func; private Func&lt;T, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt; Func { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> this.AsFunc(Expression); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> ExpressionSpecification([<span class="hljs-keyword"><span class="hljs-keyword">NotNull</span></span>] Expression&lt;Func&lt;T, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;&gt; expression) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (expression == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) throw <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> ArgumentNullException("expression"); Expression = expression; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> IsSatisfiedBy(T o) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Func(o); } } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> Account : IEntity { [BusinessRule] <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> static Expression&lt;Func&lt;Lead, <span class="hljs-type"><span class="hljs-type">bool</span></span>&gt;&gt; ActiveRule = x =&gt; x.IsDeleted &amp;&amp; x.Ballance &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-type"><span class="hljs-type">bool</span></span> IsActive() { this.<span class="hljs-keyword"><span class="hljs-keyword">Is</span></span>(ActiveRule); } }</code> </pre><br><h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Where are the services, the managers, and the helper? </font></font></h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">With proper code organization, you don‚Äôt have any helper in the domain. Maybe there is something in the presentation layer. Manager and Service are the same thing, so the name Manager is better not to use at all. Service is a purely technical term. Use Service only as postfix or do not use at all (leave only the namespace in order to register by convention in the IOC). </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the real business there are no ‚Äúservices‚Äù, there are ‚Äúcash desks‚Äù, ‚Äúpostings‚Äù, ‚Äúquotas‚Äù and all that. So it is better to group your business logic and name the classes according to the application domain and create them only as needed. CRUD operations do not need any services. The UoW + Command + Query + Specification + Validator bundles are enough to cover 90% of the accounting system needs. By the way, this requires only one controller class.</font></font><br><br><h2>  Conclusion </h2><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Such an architecture may seem overloaded. </font><font style="vertical-align: inherit;">Indeed, this approach imposes certain limitations:</font></font><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Qualification of developers: requires an understanding of programming patterns and a good knowledge of the platform </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> initial investments in the infrastructure code (it took me almost 4 days to complete the full time in order to pull interfaces out of my projects, untie unnecessary dependencies and make the infrastructure as abstract and lightweight as possible, a lot of code went under the knife) </font></font></li><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> it is this assembly that is still being tested in a real project, I have no metrics on hand and guarantees that this approach gives a performance benefit due to standardization (although subjectively, I am 100% sure of this) </font></font></li></ol><br><h4>  Benefits </h4><br><ol><li><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> clear separation of the domain from the infrastructure </font></font></li><li>     ,   ,   ,  ,  ,    </li><li>  -     </li><li>     repair-kit       </li><li>    ,    </li></ol><br><br>  <em>To be continued...</em> </div><p>Source: <a href="https://habr.com/ru/post/259829/">https://habr.com/ru/post/259829/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../259809/index.html">ESP8266 - solar-powered sensor data collection</a></li>
<li><a href="../259811/index.html">20th anniversary php</a></li>
<li><a href="../259815/index.html">Life without DDoS</a></li>
<li><a href="../259821/index.html">Customize Checkpoint. Part 1. Installation and initial configuration</a></li>
<li><a href="../259825/index.html">Appodeal - free advertising revenue optimizer for mobile developers.</a></li>
<li><a href="../259831/index.html">How I found the best programming language in the world. Part 1</a></li>
<li><a href="../259833/index.html">Spatial navigation and not only in the assembly Vivaldi 1.0.196.2</a></li>
<li><a href="../259835/index.html">Work with texture compression in Unity3D + NGUI</a></li>
<li><a href="../259839/index.html">OS Development on Go + asm Part 0x01</a></li>
<li><a href="../259841/index.html">How I found the best programming language in the world. Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>