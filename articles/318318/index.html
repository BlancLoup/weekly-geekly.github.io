<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analog. Net Entity Framework in Delphi through RTTI. Part one, introductory</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="After Delhi was revived in Embarcadero, I returned from developing C # to a more familiar tool. I was seriously pleased that most of the syntactic fea...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analog. Net Entity Framework in Delphi through RTTI. Part one, introductory</h1><div class="post__text post__text-html js-mediator-article">  After Delhi was revived in Embarcadero, I returned from developing C # to a more familiar tool.  I was seriously pleased that most of the syntactic features, classes and various "ryushechek" magically moved from Sharp.  Unfortunately, such a pleasant opportunity as mapping a selection from a database onto a collection of classes was left out of the brackets. <br><br>  In our projects, we often encounter the need for algorithmic processing of various samples, the implementation of which is impossible by means of SQL.  For each sample, a class was created, and every time you need to create a new sample, you had to perform exactly the same movements, with the difference that you had to fill in the class fields with pens. <br><br>  Having stretched our brains and evaluating the possibilities of RTTI, labor costs and the available supply of tambourines, we have a list of ‚Äúhoteles‚Äù for working with databases that are missing in our boring life: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ol><li>  Automatic generation of classes according to the structure of the tables of the database being developed. </li><li>  Populating class lists with data from tables. </li><li>  To implement the creation of classes it will not be superfluous to read the structure of the database tables. </li><li>  With the hands on the structure of the database, you can automate: </li></ol><br><ul><li>  Comparison of the structure of the existing database with the reference one to prevent errors when updating the developed software from the end user; </li><li>  The formation of a "database contract" containing the constants of the names of tables, fields, stored procedures and functions; </li><li>  Creating classes from nn.  1. taking into account the relationships between the tables. </li><li>  Creating "wrappers" to call stored procedures and functions. </li></ul><br>  And with proper implementation and accurate work in the distance, the possibility of cross-platform work between different types of SQL servers begins to loom. <br><a name="habracut"></a><br><h3>  Start simple </h3><br>  Let's check the ability to display data from DataSets on classes.  The updated RTTI allows you to enumerate the property names of a class, as well as get and set property values. <br><br>  Let's create an example of sampling from a simple table and filling in the list of classes containing public properties that match the name of the table fields.  We will work MS SQL server. <br><br>  Let's create a DB, in it the table with physical.  persons and a couple of entries: <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">master</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> [TestRtti] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> [TestRtti] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[Users_Persons]( [Guid] [uniqueidentifier] ROWGUIDCOL <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_Users_Persons_Guid] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (newid()), [Created] [datetime2](<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_Users_Persons_Created] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()), [Written] [datetime2](<span class="hljs-number"><span class="hljs-number">7</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [DF_Users_Persons_Written] <span class="hljs-keyword"><span class="hljs-keyword">DEFAULT</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">getutcdate</span></span>()), [First_Name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Middle_Name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Last_Name] [<span class="hljs-keyword"><span class="hljs-keyword">nvarchar</span></span>](<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Sex] [<span class="hljs-built_in"><span class="hljs-built_in">bit</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, [Born] [<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>] <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> [dbo].[Users_Persons] <span class="hljs-keyword"><span class="hljs-keyword">ADD</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CONSTRAINT</span></span> [PK_Users_Persons] PRIMARY <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> NONCLUSTERED ( [Guid] <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> )<span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> (PAD_INDEX = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, STATISTICS_NORECOMPUTE = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, SORT_IN_TEMPDB = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, IGNORE_DUP_KEY = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">ONLINE</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">OFF</span></span>, ALLOW_ROW_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>, ALLOW_PAGE_LOCKS = <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> [PRIMARY] <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> [dbo].[Users_Persons] ([Guid], [Created], [Written], [First_Name], [Middle_Name], [Last_Name], [Sex], [Born]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (N<span class="hljs-string"><span class="hljs-string">'291fefb5-2d4e-4ccf-8ca0-25e97fabefff'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(N<span class="hljs-string"><span class="hljs-string">'2016-07-21 10:56:16.6630000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DateTime2), <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(N<span class="hljs-string"><span class="hljs-string">'2016-12-09 16:22:01.8670000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DateTime2), N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(N<span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> [dbo].[Users_Persons] ([Guid], [Created], [Written], [First_Name], [Middle_Name], [Last_Name], [Sex], [Born]) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (N<span class="hljs-string"><span class="hljs-string">'11ad8670-158c-4777-a099-172acd61cbd3'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(N<span class="hljs-string"><span class="hljs-string">'2016-07-21 10:59:02.2030000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DateTime2), <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(N<span class="hljs-string"><span class="hljs-string">'2016-12-09 16:22:10.4730000'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> DateTime2), N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, N<span class="hljs-string"><span class="hljs-string">''</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">CAST</span></span>(N<span class="hljs-string"><span class="hljs-string">'1970-01-01'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre> <br>  Handles in the UsersPersonsEntity.pas module, create a class TUsersPersonsEntity and, running ahead, declare its list and create for it the type of reader class: <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> UsersPersonsEntity; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> Generics.Collections, DataSetReader; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-title"><span class="hljs-title">TUsersPersonsEntity</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TBaseDataRecord) <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> FGuid: TGUID; FCreated: TDateTime; FWritten: TDateTime; FFirstName: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; FMiddleName: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; FLastName: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; FSex: Boolean; FBorn: TDate; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Guid: TGUID <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FGuid <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FGuid; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Created: TDateTime <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FCreated <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FCreated; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Written: TDateTime <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FWritten <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FWritten; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> First_Name: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FFirstName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FFirstName; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Middle_Name: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FMiddleName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FMiddleName; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Last_Name: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span> <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FLastName <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FLastName; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Sex: Boolean <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FSex <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FSex; <span class="hljs-keyword"><span class="hljs-keyword">property</span></span> Born: TDate <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> FBorn <span class="hljs-keyword"><span class="hljs-keyword">write</span></span> FBorn; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TUsersPersonsList = TDataRecordsList&lt;TUsersPersonsEntity&gt;; TUsersPersonsReader = TDataReader&lt;TUsersPersonsEntity&gt;; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  In the current situation, we don‚Äôt even need a class constructor.  Now the most fun thing is to map a string from the DataSet to an instance of the class.  All the reading code is in a separate module and occupies almost one hundred and fifty lines. <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">unit</span></span> DataSetReader; <span class="hljs-keyword"><span class="hljs-keyword">interface</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> System.TypInfo, System.Rtti, SysUtils, DB, Generics.Collections, Generics.Defaults; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TBaseDataRecord = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">overload</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetPropertyValueByField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassProperty: TRttiProperty; Field: TField; FieldValue: Variant)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRowValuesByFieldName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSet: TDataSet)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AfterRead</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; TBaseDataRecordClass = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> TBaseDataRecord; TDataRecordsList&lt;T: TBaseDataRecord&gt; = <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>(TObjectList&lt;T&gt;); TDataReader&lt;T: TBaseDataRecord, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function">&gt; = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">class</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSet: TDataSet; ListInstance: TDataRecordsList&lt;T&gt; = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">nil</span></span></span></span><span class="hljs-function"><span class="hljs-params">; EntityClass: TBaseDataRecordClass = </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">nil</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">:</span></span> TDataRecordsList&lt;T&gt;; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">implementation</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Context: TRttiContext; <span class="hljs-comment"><span class="hljs-comment">{ TBaseDataRecord }</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">constructor</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TBaseDataRecord</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Create</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TBaseDataRecord</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AfterRead</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TBaseDataRecord</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetPropertyValueByField</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassProperty: TRttiProperty; Field: TField; FieldValue: Variant)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GetValueGuidFromMsSql</span></span></span><span class="hljs-function">:</span></span> TValue; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Guid: TGUID; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Field.IsNull <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Guid := TGUID.Empty <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Guid := StringToGUID(Field.AsString); Result := TValue.From(Guid); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Value: TValue; GuidTypeInfo: PTypeInfo; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Field = <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exit</span></span>; GuidTypeInfo := TypeInfo(TGUID); Value := ClassProperty.GetValue(Self); <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> Field.DataType <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> ftGuid: <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Value.TypeInfo = GuidTypeInfo <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> ClassProperty.SetValue(Self, GetValueGuidFromMsSql) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ClassProperty.SetValue(Self, TValue.FromVariant(FieldValue)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> ClassProperty.SetValue(Self, TValue.FromVariant(FieldValue)); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">procedure</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TBaseDataRecord</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetRowValuesByFieldName</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSet: TDataSet)</span></span></span><span class="hljs-function">;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Field: TField; FieldName: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; FieldValue: Variant; ClassName: <span class="hljs-keyword"><span class="hljs-keyword">String</span></span>; ClassType: TRttiType; ClassProperty: TRttiProperty; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ClassName := Self.ClassName; ClassType := Context.GetType(Self.ClassType.ClassInfo); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ClassProperty <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ClassType.GetProperties <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Field := DataSet.FindField(ClassProperty.<span class="hljs-keyword"><span class="hljs-keyword">Name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> Field &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> FieldName := Field.FieldName; FieldValue := Field.Value; SetPropertyValueByField(ClassProperty, Field, FieldValue); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-comment"><span class="hljs-comment">{ TDataReader&lt;T&gt; }</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">TDataReader</span></span></span><span class="hljs-function">&lt;</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">T</span></span></span><span class="hljs-function">&gt;.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Read</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DataSet: TDataSet; ListInstance: TDataRecordsList&lt;T&gt;; EntityClass: TBaseDataRecordClass)</span></span></span><span class="hljs-function">:</span></span> TDataRecordsList&lt;T&gt;; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Row: T; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ListInstance = <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Result := TDataRecordsList&lt;T&gt;.Create <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> Result := ListInstance; Result.OwnsObjects := True; Result.Clear; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; DataSet.DisableControls; Result.Capacity := DataSet.RecordCount; <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> DataSet.Eof <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> EntityClass = <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> Row := T.Create() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> Row := EntityClass.Create() <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> T; Row.SetRowValuesByFieldName(DataSet); Row.AfterRead; Result.Add(Row); DataSet.Next; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">initialization</span></span> Context := TRttiContext.Create; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre> <br>  For the convenience of operating generic classes, it is desirable to create a base class of table row entities with the virtual designer TBaseDataRecord and generate real entities of table rows from it (see the TUsersPersonsEntity declaration).  In addition to the base class, in the module there is a generic class "reader".  Its task is to go over the DataSet, create instances of strings, and slip the current selection string into the created instance of the TBaseDataRecord inheritor and store it in the resulting list. <br><br>  The function of displaying data from a sample for a class is in the TBaseDataRecord.  When the class properties are searched, the DataSet will search for fields with the same name.  If the field is found, then after a light shamanism with variant types and TValue, the property has the required value. <br><br>  Unfortunately, "not so simple."  In the SetPropertyValueByField method, you have to check that the current property is of type TGUID.  MSSQL gives the GUID as a string and a direct assignment gives an error.  You have to explicitly convert the string to a GUID.  Moreover, further use has shown the need for additional squats for: <br><br><ul><li>  MSSQL, OLEDB and DATE, DATETIME </li><li>  Processing BLOBs </li><li>  Firebird and GUID when stored in CHAR (16) CHARACTER SET OCTETS </li><li>  Firebird and TIMESTAMP </li></ul><br>  The list is constantly updated as it is discovered.  But the main thing is that it works.  And it works as follows (the actual text of the program): <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">program</span></span> TestRtti; <span class="hljs-meta"><span class="hljs-meta">{$APPTYPE CONSOLE}</span></span> <span class="hljs-meta"><span class="hljs-meta">{$R *.res}</span></span> <span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> DB, ADODB, System.SysUtils, ActiveX, DataSetReader <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'DataSetReader.pas'</span></span>, UsersPersonsEntity <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-string"><span class="hljs-string">'UsersPersonsEntity.pas'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> Connection: TADOConnection; Query: TADOQuery; UsersPersons: TUsersPersonsList; UserPerson: TUsersPersonsEntity; Reader: TUsersPersonsReader; i: Integer; <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> ReportMemoryLeaksOnShutdown := True; UsersPersons := <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> CoInitialize(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); Connection := TADOConnection.Create(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> Connection.ConnectionString := <span class="hljs-string"><span class="hljs-string">'Provider=SQLNCLI11.1;Integrated Security=SSPI;Persist Security Info=False;User ID="";'</span></span> + <span class="hljs-string"><span class="hljs-string">'Initial Catalog="TestRtti";Data Source=localhost;Initial File Name="";Server SPN=""'</span></span>; Connection.Connected := True; Query := TADOQuery.Create(<span class="hljs-keyword"><span class="hljs-keyword">nil</span></span>); Reader := TUsersPersonsReader.Create; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> Query.Connection := Connection; Query.SQL.Text := <span class="hljs-string"><span class="hljs-string">'SELECT * FROM Users_Persons'</span></span>; Query.Open; UsersPersons := Reader.<span class="hljs-keyword"><span class="hljs-keyword">Read</span></span>(Query); Writeln(<span class="hljs-string"><span class="hljs-string">' : '</span></span>, UsersPersons.Count); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i := <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> UsersPersons.Count - <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-keyword"><span class="hljs-keyword">begin</span></span> UserPerson := UsersPersons[i]; Writeln(Format(<span class="hljs-string"><span class="hljs-string">'%d. %s %s %s %s'</span></span>, [i + <span class="hljs-number"><span class="hljs-number">1</span></span>, UserPerson.First_Name, UserPerson.Middle_Name, UserPerson.Last_Name, FormatDateTime(<span class="hljs-string"><span class="hljs-string">'dd.mm.yyyy'</span></span>, UserPerson.Born)])); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; Writeln(<span class="hljs-string"><span class="hljs-string">' Enter  ...'</span></span>); Readln; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> Query.Free; Reader.Free; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> Connection.Free; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> UsersPersons &lt;&gt; <span class="hljs-keyword"><span class="hljs-keyword">nil</span></span> <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> FreeAndNil(UsersPersons); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> E: Exception <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> Writeln(E.ClassName, <span class="hljs-string"><span class="hljs-string">': '</span></span>, E.<span class="hljs-keyword"><span class="hljs-keyword">Message</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">end</span></span>.</code> </pre><br>  The main thing in the code is the string <b>UsersPersons: = Reader.Read (Query);</b>  .  And that's all.  Compact, however.  And here is the output of the application: <br><br><img src="https://habrastorage.org/files/a64/9ae/a4d/a649aea4d3b2472cb1fbe4fff4c598aa.png" alt="image"><br><br><h3>  What's next </h3><br>  This is just an opportunity check.  Although for ‚Äúflat‚Äù simple queries, the above mechanism is quite efficient. <br><br>  And then - the automatic creation of a database contract and table entities, the creation of a reference database schema, linking lists of entities, updating data, serialization of lists and cross-platform reading. </div><p>Source: <a href="https://habr.com/ru/post/318318/">https://habr.com/ru/post/318318/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../318306/index.html">First steps with STM32 and mikroC compiler for ARM architecture - Part 1</a></li>
<li><a href="../318308/index.html">Sprint: how to test any business idea in just 5 days</a></li>
<li><a href="../318310/index.html">FX Architecture: a revolution for data convergence</a></li>
<li><a href="../318312/index.html">New Year Bug Stories</a></li>
<li><a href="../318316/index.html">Friday format: Successful vacation for an IT specialist or some other favorite work</a></li>
<li><a href="../318320/index.html">NFV MANO Platform Review from the open source community</a></li>
<li><a href="../318322/index.html">19 unexpected finds in the Node.js documentation</a></li>
<li><a href="../318324/index.html">Personal experience: how we chose the DLP system</a></li>
<li><a href="../318326/index.html">Boring about decoding</a></li>
<li><a href="../318328/index.html">ABBYY Cloud OCR SDK subscriptions: ‚Äúshut up and take my money!‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>