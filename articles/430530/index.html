<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mock server to automate mobile testing</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While working on the latest project, I ran into testing a mobile application connected at the business logic level with various third-party services. ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mock server to automate mobile testing</h1><div class="post__text post__text-html js-mediator-article">  While working on the latest project, I ran into testing a mobile application connected at the business logic level with various third-party services.  Testing these services was not part of my task, but problems with their API blocked the work on the application itself - tests did not fall due to problems inside, but because of the inability of the API, not even reaching the required functionality. <br><br>  Traditionally, for testing such applications, stands are used.  But they do not always work normally, and this interferes with work.  As an alternative solution, I used moki.  About this thorny path and I want to tell you today. <br><br><img src="https://habrastorage.org/webt/kn/uf/vw/knufvwqxahfwy6zkqxrkgeirrga.jpeg" alt="image"><br><a name="habracut"></a><br>  In order not to touch the code of a real project (under NDA), for clarity of the further presentation, I created a simple REST client for Android that allows you to send HTTP requests (GET / POST) to a certain address with the parameters I need.  We will test it. <br>  The application client code, dispatchers, and tests can be <a href="https://git.maxilect.com/maxilect/mockserver-example">downloaded from GitLab</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  What are the options? </h2><br>  In my case, there were two approaches to mopping: <br><br><ul><li>  Deploy a mock server in the cloud or on a remote machine (if we are talking about confidential developments that cannot be taken to the cloud); </li><li>  launch the mock server locally - directly on the phone on which the mobile application is being tested. </li></ul><br>  The first option is slightly different from the test bench.  Indeed, it is possible to allocate a workplace in the network for the mock server, but it will need to be maintained, like any test facility.  This is where we will face the main pitfalls of this approach.  The remote workplace has died, has stopped responding, something has changed - it is necessary to monitor, change the configuration, i.e.  do everything the same as with the support of a regular test bench.  We do not fix the situation for ourselves in any way, and it will definitely take more time than any local manipulations.  So specifically in my project it was more convenient to raise the mock server locally. <br><br><h2>  Choosing a mock server </h2><br>  There are many different tools.  I tried to work with several and almost in each I encountered certain problems: <br><br><ul><li>  <b>Mock-server</b> , <b>wiremock</b> - two mock servers, which I could not normally run on Android.  Since all the experiments took place within the framework of a live project, the time to choose was limited.  Picked up with them for a couple of days, I quit trying. </li><li>  <b>Restmock</b> is a wrapper over <b>okhttpmockwebserver</b> , which is <b>described</b> in more detail below.  It looked not bad, it started, but the developer of this wrapper hid ‚Äúunder the hood‚Äù the possibility of setting the IP address and port of the mock server, but for me it was critical.  Restmock started on some random port.  Picking around in the code, I saw that when the server was initialized, the developer used a method that set the port randomly if it did not receive it at the input.  In principle, it was possible to inherit from this method, but the problem was in the private constructor.  As a result, I refused the wrapper. </li><li>  <b>Okhttpmockwebserver</b> - having tried different tools, I stopped at the mock server, which normally gathered and started locally on the device. </li></ul><br><h2>  We understand the principle of work </h2><br>  The current version of okhttpmockwebserver allows you to implement several scenarios: <br><br><ul><li>  <b>The queue of answers</b> .  The mock server responses are added to the FIFO queue.  No matter which API and which way I will go, the mock server will in turn throw out the messages in this queue. </li><li>  <b>Dispatcher</b> allows <b>you</b> to create rules that determine which answer to give.  Suppose a request came at a URL containing a path, for example / get-login /.  Therefore, / get-login / the mock server gives a single, predetermined answer. </li><li>  <b>Request Verifier</b> .  Based on the previous scenario, I can check the requests that the application sends (that in the given conditions, the request with certain parameters really leaves).  In this case, the answer is unimportant, since it is determined by how the API works.  This script implements the Request verifier. </li></ul><br>  Consider each of the scenarios in more detail. <br><br><h3>  Response queue </h3><br>  The simplest implementation of the mock server is the response queue.  Prior to the test, I define the address and port where the mock server will be deployed, as well as the fact that it will work according to the message queuing principle - FIFO (first in first out). <br><br>  Next, run the mock server. <br><br><pre><code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">QueueTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) @</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Before</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">fun</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-class">() </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>)) mockServer.enqueue(MockResponse().setBody(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>)) mockServer.start(ip, port) } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">queueTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"1st message"</span></span>) returnFromResponseActivity() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"2nd message"</span></span>) returnFromResponseActivity() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/getMessage"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">"3rd message"</span></span>) returnFromResponseActivity() } }</code> </pre> <br>  Tests are written using the Espresso framework, designed to perform actions in mobile applications.  In this example, I select the types of requests and send them in turn. <br>  After starting the test, the mock server gives it answers in accordance with the prescribed queue, and the test passes without errors. <br><br><h3>  Dispatcher implementation </h3><br>  Dispatcher is a set of rules by which the mock server operates.  For convenience, I created three different dispatchers: SimpleDispatcher, OtherParamsDispatcher and ListingDispatcher. <br><br><h4>  Simpledispatcher </h4><br>  To implement the dispatcher, okhttpmockwebserver provides the <code>Dispatcher()</code> class.  You can inherit from it by redefining the <code>dispatch</code> function in your own way. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SimpleDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"GET"</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.method == <span class="hljs-string"><span class="hljs-string">"POST"</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>) } }</code> </pre><br>  The logic in this example is simple: if GET arrives, I return a message that this is a GET request.  If POST, return message about POST request.  In other situations, return an empty request. <br><br>  In the test, a <code>dispatcher</code> appears - an object of the class <code>SimpleDispatcher</code> , which I described above.  Further, as in the previous example, the mock server is started, only this time a kind of rule for working with this mock server is indicated - the same dispatcher. <br><br>  Test sources with <code>SimpleDispatcher</code> can be found <a href="https://git.maxilect.com/maxilect/mockserver-example">in the repository</a> . <br><br><h4>  OtherParamsDispatcher </h4><br>  By overriding the <code>dispatch</code> function, I can push off from other request parameters to send responses: <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OtherParamsDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> when { request.path.contains(<span class="hljs-string"><span class="hljs-string">"?queryKey=value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a GET request with query parameter queryKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was a POST request with body parameter bodyKey equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) request.headers.toString().contains(<span class="hljs-string"><span class="hljs-string">"header: value"</span></span>) -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">": "</span></span>It was some request with header equals value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> -&gt; MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">200</span></span>).setBody(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ Wrong response }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) } } }</code> </pre><br>  In this case, I demonstrate several options for the conditions. <br><br>  First, the API can pass parameters in the address bar.  Therefore, I can put a condition on the entry in the path of any ligament, for example <code>‚Äú?queryKey=value‚Äù</code> . <br>  Secondly, this class allows you to climb inside the body (body) of POST or PUT requests.  For example, you can use <code>contains</code> by first executing <code>toString()</code> .  In my example, the condition is triggered when a POST request comes in, containing the <code>‚ÄúbodyKey‚Äù:‚Äùvalue‚Äù</code> .  Similarly, I can validate the request <code>header : value</code> ( <code>header : value</code> ). <br><br>  For examples of tests I recommend to contact <a href="https://git.maxilect.com/maxilect/mockserver-example">the repository</a> . <br><br><h4>  ListingDispatcher </h4><br>  If necessary, you can implement a more complex logic - ListingDispatcher.  In the same way, I override the <code>dispatch</code> function.  But now, right in the class, I set the default set of <code>stubsList</code> ( <code>stubsList</code> ) - mocks for different occasions. <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcher</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Dispatcher</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> stubsList: ArrayList&lt;RequestClass&gt; = defaultRequests() <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-function">override fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">dispatch</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request: RecordedRequest)</span></span></span><span class="hljs-function">: MockResponse </span></span>= <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { stubsList.first { it.matcher(request.path, request.body.toString()) }.response() } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (e: NoSuchElementException) { Log.e(<span class="hljs-string"><span class="hljs-string">"Unexisting request path ="</span></span>, request.path) MockResponse().setResponseCode(<span class="hljs-number"><span class="hljs-number">404</span></span>) } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">defaultRequests</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function">: ArrayList&lt;RequestClass&gt; </span></span>{ val allStubs = ArrayList&lt;RequestClass&gt;() allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/get"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /get url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">"queryParam=value"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and contains queryParam=value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) allStubs.add(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Request url starts with /post url and body contains bodyParam:value<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> allStubs } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) } <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ stubsList.add(stub) } }</code> </pre><br>  For this, I created an open class <code>RequestClass</code> , all fields of which are empty by default.  For this class, I set the <code>response</code> function, which creates a <code>MockResponse</code> object (returning a 200 response or some other <code>responseText</code> ), and a <code>matcher</code> function that returns <code>true</code> or <code>false</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">open class </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RequestClass</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(val path:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val query: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val body:String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">, val responseText: String = </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">""</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">response</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(code: Int = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">200</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function">: MockResponse </span></span>= MockResponse() .setResponseCode(code) .setBody(responseText) <span class="hljs-function"><span class="hljs-function">open fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">matcher</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(apiCall: String, apiBody: String)</span></span></span><span class="hljs-function">: Boolean </span></span>= apiCall.startsWith(path)&amp;&amp;apiCall.contains(query)&amp;&amp;apiBody.contains(body) }</code> </pre><br>  As a result, I can build more complex combinations of conditions for stubs.  This construction seemed to me more flexible, although the principle at its basis is very simple. <br><br>  But most of all in this approach, I liked that I could inject some stubs on the go if there was a need to change something in the answer of the mock server on one test.  When testing large projects, such a task occurs quite often, for example, when testing some specific scenarios. <br>  Replacement can be done as follows: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replaceMockStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(stub: RequestClass)</span></span></span><span class="hljs-function"> </span></span>{ val valuesToRemove = ArrayList&lt;RequestClass&gt;() stubsList.forEach { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (it.path.contains(stub.path)&amp;&amp;it.query.contains(stub.query)&amp;&amp;it.body.contains(stub.body)) valuesToRemove.add(it) } stubsList.removeAll(valuesToRemove) stubsList.add(stub) }</code> </pre><br>  With this implementation of the dispatcher tests remain simple.  I also start the mock server, just choose <code>ListingDispatcher</code> . <br><br><pre> <code class="java hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ListingDispatcherTest</span></span></span><span class="hljs-class">: </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BaseTest</span></span></span><span class="hljs-class">() </span></span>{ <span class="hljs-meta"><span class="hljs-meta">@Rule</span></span> <span class="hljs-meta"><span class="hljs-meta">@JvmField</span></span> <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> mActivityRule: ActivityTestRule&lt;MainActivity&gt; = ActivityTestRule(MainActivity::<span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">java</span></span></span><span class="hljs-class">) </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">private</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">val</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">dispatcher</span></span></span><span class="hljs-class"> </span></span>= ListingDispatcher() <span class="hljs-meta"><span class="hljs-meta">@Before</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initMockServer</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val mockServer = MockWebServer() val ip = InetAddress.getByName(<span class="hljs-string"><span class="hljs-string">"127.0.0.1"</span></span>) val port = <span class="hljs-number"><span class="hljs-number">8080</span></span> mockServer.setDispatcher(dispatcher) mockServer.start(ip, port) } . . . }</code> </pre><br>  For the sake of experiment, I replaced the stub with POST: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">postReplacedStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyParam"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) replacePostStub() sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, params = params) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br>  For this, I called the <code>replacePostStub</code> function from the normal <code>dispatcher</code> and added a new <code>response</code> . <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">replacePostStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.replaceMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">"\"bodyParam\":\"value\""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>Post request stub has been replaced<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br>  In the test above, I check that the stub has been replaced. <br>  Then I added a new stub, which was not in default. <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getNewStubTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ addSomeStub() sendGetRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/some_specific_url"</span></span>) assertResponseMessage(<span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>) }</code> </pre><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addSomeStub</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ dispatcher.addMockStub(RequestClass(<span class="hljs-string"><span class="hljs-string">"/some_specific_url"</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span><span class="hljs-string"><span class="hljs-string">"{ "</span></span>message<span class="hljs-string"><span class="hljs-string">" : "</span></span>U have got specific message<span class="hljs-string"><span class="hljs-string">" }"</span></span><span class="hljs-string"><span class="hljs-string">""</span></span>)) }</code> </pre><br><h3>  Request Verifier </h3><br>  The last case - Request verifier - provides not mocking, but checking requests sent by the application.  To do this, I just start the mock server by implementing the dispatcher so that the application returns at least something. <br>  When sending a request from the test, he comes to the mock server.  Through it, I can access the request parameters using <code>takeRequest()</code> . <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-function">fun </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">requestVerifierTest</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ val params: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"bodyKey"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) val headers: HashMap&lt;String, String&gt; = hashMapOf(<span class="hljs-string"><span class="hljs-string">"header"</span></span> to <span class="hljs-string"><span class="hljs-string">"value"</span></span>) sendPostRequest(<span class="hljs-string"><span class="hljs-string">"http://localhost:8080/post"</span></span>, headers = headers, params = params) val request = mockServer.takeRequest() assertEquals(<span class="hljs-string"><span class="hljs-string">"POST"</span></span>, request.method) assertEquals(<span class="hljs-string"><span class="hljs-string">"value"</span></span>, request.getHeader(<span class="hljs-string"><span class="hljs-string">"header"</span></span>)) assertTrue(request.body.toString().contains(<span class="hljs-string"><span class="hljs-string">"\"bodyKey\":\"value\""</span></span>)) assertTrue(request.path.startsWith(<span class="hljs-string"><span class="hljs-string">"/post"</span></span>)) }</code> </pre><br>  Above, I showed a check on a simple example.  Exactly the same approach can be used for complex JSON, including checking the entire structure of the request (you can compare at the level of JSON or parse JSON on objects and check equality at the level of objects). <br><br><h2>  Results </h2><br>  In general, I liked the tool (okhttpmockwebserver), and I use it on a large project.  Of course, there are some little things that I would like to change. <br>  For example, I do not like having to knock on the local address (localhost: 8080 in our example) in the configs of my application;  Perhaps I will still find a way to configure everything so that the mock server responds when trying to send a request to any address. <br>  Also, I lack the ability to forward requests - when the mock server sends the request further, if it does not have a suitable stub for it.  In this mock server there is no such approach.  However, they did not even reach their implementation, since at the moment in a ‚Äúcombat‚Äù project it is not worth such a task. <br><br>  Article author: Ruslan Abdulin <br><br>  PS We publish our articles on several sites Runet.  Subscribe to our pages on the <a href="https://vk.com/maxilect">VK</a> , <a href="https://www.facebook.com/maxilectru/">FB</a> or <a href="https://t.me/maxilect">Telegram channel</a> to learn about all of our publications and other news from Maxilect. </div><p>Source: <a href="https://habr.com/ru/post/430530/">https://habr.com/ru/post/430530/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430520/index.html">Meet Spring Data MongoDB</a></li>
<li><a href="../430522/index.html">Do you need a corporate culture in IT? Confession brand manager of the Krasnodar studio Plarium</a></li>
<li><a href="../430524/index.html">Neural Network Architecture</a></li>
<li><a href="../430526/index.html">Slot machines: where did they come from in the USSR and how are they arranged</a></li>
<li><a href="../430528/index.html">Programming with PyUSB 1.0</a></li>
<li><a href="../430532/index.html">Security in iOS applications</a></li>
<li><a href="../430534/index.html">Creating a template for Zabbix using DVR Trassir SDK as an example</a></li>
<li><a href="../430536/index.html">Designing window functions that sum up to a unit with a given level of overlap</a></li>
<li><a href="../430538/index.html">Do you read Scaladoc for ‚Äúobvious‚Äù collection methods? Or why laziness is not always good.</a></li>
<li><a href="../430542/index.html">Open webinar "Infrastructure as a code"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>