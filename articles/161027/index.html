<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Getting the image of the right size without OutOfMemoryError + auto-rotate according to EXIF ‚Äã‚Äãorientation</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many have probably already faced the problem of OutOfMemoryError and found quite a clever displaying Bitmaps manual Efficiently . But if you have not ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Getting the image of the right size without OutOfMemoryError + auto-rotate according to EXIF ‚Äã‚Äãorientation</h1><div class="post__text post__text-html js-mediator-article">  Many have probably already faced the problem of OutOfMemoryError and found quite a clever displaying <a href="http://developer.android.com/training/displaying-bitmaps/index.html">Bitmaps</a> manual <a href="http://developer.android.com/training/displaying-bitmaps/index.html">Efficiently</a> .  But if you have not had time to invent your bicycle on the basis of the manual, I offer my ready-made solution with explanations that can get images: <br><br><ul><li>  Bitmap and byte [] </li><li>  Reduced while maintaining proportions </li><li>  Reduced with a crop (crop) to a given size width x height </li><li>  Optimized for 2g </li><li>  Always in the correct orientation (considering EXIF ‚Äã‚Äãorientation) </li></ul><br><br><div class="spoiler">  <b class="spoiler_title">Usage example</b> <div class="spoiler_text"><pre><code class="java hljs">ImageManager im = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ImageManager(ctx, <span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">100</span></span>); Bitmap bm = im.setIsScale(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .setIsResize(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .setIsCrop(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) .getFromFile(myUri.toString());</code> </pre> <br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  OutOfMemoryError </h4><br>  Why does this error occur?  The fact is that a limited amount of memory (heap size) is allocated to each application, which varies depending on the device.  For example, 16mb, 24mb and higher.  Modern devices typically have 24mb and higher, however, these values ‚Äã‚Äãcan be quickly "eaten." <br><br>  What exactly is memory consuming?  The answer lies in the Bitmap class, which in the general case spends 2 or 4 bytes per pixel (depending on the image bit depth - 16bit RGB_555 or 32 bits ARGB_888).  Calculate how much a Bitmap will eat, containing an image taken with a 5 megapixel camera. <br><br>  With a 4: 3 aspect ratio, you will get an image with sides of 2583 x 1936. In the RGB_555 configuration, our Bitmap will take 2583 * 1936 * 2 = 9.54 MB (hereinafter I think that MB = 2 in 20 degrees bytes), and in ARGB_888 in 2 times more - a little more than 19Mb.  It is scary to think about cameras with a large number of megapixels. <br><br><h5>  The solution is short and clear. </h5><br>  1) Using the BitmapFactory.decodeStream function with the passed third parameter new BitmapFactory.Options (), for which inJustDecodeBounds = true, we get a Bitmap containing only the dimensions of the image in pixels and not containing the pixels themselves. <br>  2) Determine how many times you need to reduce the image to get the size we need. <br>  3) Assign this value to the inSampleSize field of the BitmapFactory.Options instance and call the BitmapFactory.decodeStream function again. <br>  4) It is guaranteed that the decoder returns a thumbnail without an OutOfMemoryError <br><br>  Note: I see no reason to make the size of the image larger than the screen size.  Also, I see no reason to store Bitmap in the ARGB_888 configuration, since many devices have 16 bit screens.  But even on more colorful screens, the benefit from a two-fold reduction in memory consumption is higher than a slight decrease in image quality (IMHO). <br><br><div class="spoiler">  <b class="spoiler_title">Example</b> <div class="spoiler_text"><pre> <code class="java hljs">InputStream in = ... <span class="hljs-comment"><span class="hljs-comment">// InputStream BitmapFactory.Options o = new BitmapFactory.Options(); o.inJustDecodeBounds = true; BitmapFactory.decodeStream(in, null, o); in.close(); int origWidth = o.outWidth; //  int origHeight = o.outHeight; //  int bytesPerPixel = 2 // RGB_555  int maxSize = 480 * 800 * bytesPerPixel; //   Bitmap int desiredWidth = ‚Ä¶; //  int desiredHeight = ‚Ä¶; //  int desiredSize = _ desiredWidth * _ desiredHeight * bytesPerPixel; //   Bitmap   width  height if (desiredSize &lt; maxSize) maxSize = desiredSize; int scale = 1; //  int origSize = origWidth * origHeight * bytesPerPixel; //   if (origWidth &gt; origHeight) { scale = Math.round((float) origHeight / (float) desiredHeight); } else { scale = Math.round((float) origWidth / (float) desiredWidth); } o = new BitmapFactory.Options(); o.inSampleSize = scale; o.inPreferredConfig = Config.RGB_565; in = ‚Ä¶ // InputStream.  -     , .         InputStream   (  ByteArrayInputStream  FileInputStream). Bitmap bitmap = BitmapFactory.decodeStream(in, null, o); // Bitmap</span></span></code> </pre><br></div></div><br><br><h5>  What's next? </h5><br>  If you do not need an exact match to the width and height, then the resulting Bitmap is sufficient, otherwise we will resize and / or crop the image.  The implementation of these functions is trivial, the source code at the end of the post. <br><br><h4>  EXIF orientation or correct inverted images. </h4><br>  This solution applies only to the jpeg format. <br><br>  Guarantees that the objects in the image will always be rotated as we see them - no.  It is enough to turn the camera of the smartphone to any angle - and here is an image for you that you don‚Äôt use anywhere else.  But I want the houses and people to stand on the ground, and the birds flew across the sky.  To come to the aid of EXIF ‚Äã‚Äãis a format that allows you to add additional information to images. <br><br>  We are only interested in one parameter - orientation, which the smartphone camera adds to the metadata (I want to believe that the cameras of all devices do this).  But in its raw form, it stores not a degree of rotation, but a digital value of 1-8.  What these meanings are described <a href="http://beradrian.wordpress.com/2008/11/14/rotate-exif-images/">here</a> .  Honestly, I did not memorize what they mean, so I recommend taking the finished function at the end of the post, which converts these values ‚Äã‚Äãto degrees: getOrientation (Context context, Uri uri).  The function returns the values ‚Äã‚Äã90, 180, 270, 0 or -1 (an erroneous state, when for one reason or another it was not possible to determine the angle of rotation).  Accordingly, rotation is required when the value is&gt; 0. <br><br>  To return the image to the correct angle, you need to supplement the code for obtaining the image: <br><br>  Instead: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> origWidth = o.outWidth; <span class="hljs-comment"><span class="hljs-comment">//  int origHeight = o.outHeight; // </span></span></code> </pre><br><br>  We will write: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">int</span></span> origWidth = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-comment"><span class="hljs-comment">//  int origHeight = 0; //  if (orientation == 90 || orientation == 270) { origWidth = o.outHeight; origHeight = o.outWidth; } else { origWidth = o.outWidth; origHeight = o.outHeight; }</span></span></code> </pre><br><br>  And at the end add: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orientation &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Matrix matrix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Matrix(); matrix.postRotate(orientation); Bitmap decodedBitmap = bitmap; bitmap = Bitmap.createBitmap(decodedBitmap, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, bitmap.getWidth(), bitmap.getHeight(), matrix, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-comment"><span class="hljs-comment">//     if (decodedBitmap != null &amp;&amp; !decodedBitmap.equals(bitmap)) { decodedBitmap.recycle(); } }</span></span></code> </pre><br><br>  <b>UPDATE 1</b> <br><br><h4>  We optimize the image </h4><br><h5>  Width and height </h5><br>  The ImageManager class uses two enum ScaleMode and ResizeMode.  Each has two values, EQUAL_OR_GREATER and EQUAL_OR_LOWER. <br><br>  For ScaleMode: <br><ul><li>  EQUAL_OR_GREATER will mean that the picture reduced by the decoder will always be equal to or slightly larger than given by width x height </li><li>  EQUAL_OR_LOWER will mean that the picture reduced by the decoder will always be slightly less than the given width x height </li></ul><br><br>  For ResizeMode: <br><ul><li>  EQUAL_OR_GREATER will mean that both sides of the image will be equal to or greater than the given width x height </li><li>  EQUAL_OR_LOWER will mean that the picture will be inscribed in a rectangle given by width x height (all sides are equal or less than given by width x height) </li></ul><br><br>  If the image size, memory consumption, space on the SD card, 2g / 3g download speed are not secondary, then it is recommended to use the EQUAL_OR_LOWER mode, which will reduce these parameters due to a slight decrease in image quality.  In practice, I quickly came to this compromise, because when sending / receiving images at 2g speed usually leaves much to be desired (especially in an unstable signal, which is not only in tunnels and subways). <br><br><h5>  Jpeg compression rate </h5><br>  But if ScaleMode and ResizeMode allow saving on width and height, then there is another way to reduce the image size: jpeg compression rate.  To do this, in the ImageManager class, I wrote a method and its overload: <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getRawFromFile(String path, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> compressRate) <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getRawFromFile(String path)</code> </pre><br><br>  In the overload of the method with a hardcode, the parameter empirically derived parameter 75 is hammered. I use this method together with ScaleMode and ResizeMode to get an optimized jpeg image in the form of a byte array, which is the very thing to send it to the post in the server. <br><br><h4>  Afterword </h4><br>  I hope this manual will prove to someone not only useful, but it will also give you insight.  For thoughtless copy-paste can solve the problem in the short term, but in the long term it can lead to even bigger mistakes. <br><br><div class="spoiler">  <b class="spoiler_title">Listing of ImageManager class</b> <div class="spoiler_text"><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ImageManager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Context _ctx; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _boxWidth; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> _boxHeight; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ResizeMode _resizeMode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ScaleMode _scaleMode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Config _rgbMode; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> _isScale; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> _isResize; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> _isCrop; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> _isRecycleSrcBitmap; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">boolean</span></span> _useOrientation; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ImageManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context ctx, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> boxWidth, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> boxHeight)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>(ctx); _boxWidth = boxWidth; _boxHeight = boxHeight; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ImageManager</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context ctx)</span></span></span><span class="hljs-function"> </span></span>{ _ctx = ctx; _isScale = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; _isResize = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; _isCrop = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; _isRecycleSrcBitmap = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; _useOrientation = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setResizeMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ResizeMode mode)</span></span></span><span class="hljs-function"> </span></span>{ _resizeMode = mode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setScaleMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ScaleMode mode)</span></span></span><span class="hljs-function"> </span></span>{ _scaleMode = mode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setRgbMode</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Config mode)</span></span></span><span class="hljs-function"> </span></span>{ _rgbMode = mode; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIsScale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isScale)</span></span></span><span class="hljs-function"> </span></span>{ _isScale = isScale; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIsResize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isResize)</span></span></span><span class="hljs-function"> </span></span>{ _isResize = isResize; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIsCrop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> isCrop)</span></span></span><span class="hljs-function"> </span></span>{ _isCrop = isCrop; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setUseOrientation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ _useOrientation = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ImageManager </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setIsRecycleSrcBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">boolean</span></span></span></span><span class="hljs-function"><span class="hljs-params"> value)</span></span></span><span class="hljs-function"> </span></span>{ _isRecycleSrcBitmap = value; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String path)</span></span></span><span class="hljs-function"> </span></span>{ Uri uri = Uri.parse(path); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> orientation = -<span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_useOrientation) { orientation = getOrientation(_ctx, uri); } Bitmap bitmap = scale(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamFromFile(_ctx, path), orientation); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getFromBitmap(bitmap); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap bitmap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isResize) bitmap = resize(bitmap); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isCrop) bitmap = crop(bitmap); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getRawFromFile(String path) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getRawFromFile(path, <span class="hljs-number"><span class="hljs-number">75</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] getRawFromFile(String path, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> compressRate) { Bitmap scaledBitmap = getFromFile(path); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scaledBitmap == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; ByteArrayOutputStream output = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayOutputStream(); scaledBitmap.compress(CompressFormat.JPEG, compressRate, output); recycleBitmap(scaledBitmap); <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] rawImage = output.toByteArray(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (rawImage == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> rawImage; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFromByteArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] rawImage)</span></span></span><span class="hljs-function"> </span></span>{ Bitmap bitmap = scale(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StreamFromByteArray(rawImage), -<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> getFromBitmap(bitmap); } <span class="hljs-meta"><span class="hljs-meta">@SuppressLint</span></span>(<span class="hljs-string"><span class="hljs-string">"NewApi"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">scale</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(IStreamGetter streamGetter, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> orientation)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { InputStream in = streamGetter.Get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Bitmap bitmap = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; Config rgbMode = _rgbMode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? _rgbMode : Config.RGB_565; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!_isScale) { BitmapFactory.Options o = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapFactory.Options(); o.inPreferredConfig = rgbMode; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (android.os.Build.VERSION.SDK_INT &gt;= <span class="hljs-number"><span class="hljs-number">11</span></span>) { o.inMutable = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } bitmap = BitmapFactory.decodeStream(in, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, o); in.close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_boxWidth == <span class="hljs-number"><span class="hljs-number">0</span></span> || _boxHeight == <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) in.close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } ScaleMode scaleMode = _scaleMode != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> ? _scaleMode : ScaleMode.EQUAL_OR_GREATER; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> bytesPerPixel = rgbMode == Config.ARGB_8888 ? <span class="hljs-number"><span class="hljs-number">4</span></span> : <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> maxSize = <span class="hljs-number"><span class="hljs-number">480</span></span> * <span class="hljs-number"><span class="hljs-number">800</span></span> * bytesPerPixel; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> desiredSize = _boxWidth * _boxHeight * bytesPerPixel; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (desiredSize &lt; maxSize) maxSize = desiredSize; BitmapFactory.Options o = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapFactory.Options(); o.inJustDecodeBounds = <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; BitmapFactory.decodeStream(in, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, o); in.close(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> scale = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> origWidth; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> origHeight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orientation == <span class="hljs-number"><span class="hljs-number">90</span></span> || orientation == <span class="hljs-number"><span class="hljs-number">270</span></span>) { origWidth = o.outHeight; origHeight = o.outWidth; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { origWidth = o.outWidth; origHeight = o.outHeight; } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> ((origWidth * origHeight * bytesPerPixel) * (<span class="hljs-number"><span class="hljs-number">1</span></span> / Math.pow(scale, <span class="hljs-number"><span class="hljs-number">2</span></span>)) &gt; maxSize) { scale++; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (scaleMode == ScaleMode.EQUAL_OR_LOWER) { scale++; } o = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BitmapFactory.Options(); o.inSampleSize = scale; o.inPreferredConfig = rgbMode; in = streamGetter.Get(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; bitmap = BitmapFactory.decodeStream(in, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, o); in.close(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (orientation &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { Matrix matrix = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Matrix(); matrix.postRotate(orientation); Bitmap decodedBitmap = bitmap; bitmap = Bitmap.createBitmap(decodedBitmap, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, bitmap.getWidth(), bitmap.getHeight(), matrix, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (decodedBitmap != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; !decodedBitmap.equals(bitmap)) { recycleBitmap(decodedBitmap); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bitmap; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap sourceBitmap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceBitmap == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_resizeMode == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) _resizeMode = ResizeMode.EQUAL_OR_GREATER; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> srcRatio; <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> boxRatio; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> srcWidth = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> srcHeight = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> resizedWidth = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> resizedHeight = <span class="hljs-number"><span class="hljs-number">0</span></span>; srcWidth = sourceBitmap.getWidth(); srcHeight = sourceBitmap.getHeight(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_resizeMode == ResizeMode.EQUAL_OR_GREATER &amp;&amp; (srcWidth &lt;= _boxWidth || srcHeight &lt;= _boxHeight) || _resizeMode == ResizeMode.EQUAL_OR_LOWER &amp;&amp; srcWidth &lt;= _boxWidth &amp;&amp; srcHeight &lt;= _boxHeight) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sourceBitmap; } srcRatio = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)srcWidth / (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)srcHeight; boxRatio = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)_boxWidth / (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)_boxHeight; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (srcRatio &gt; boxRatio &amp;&amp; _resizeMode == ResizeMode.EQUAL_OR_GREATER || srcRatio &lt; boxRatio &amp;&amp; _resizeMode == ResizeMode.EQUAL_OR_LOWER) { resizedHeight = _boxHeight; resizedWidth = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)resizedHeight * srcRatio); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { resizedWidth = _boxWidth; resizedHeight = (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>)resizedWidth / srcRatio); } Bitmap resizedBitmap = Bitmap.createScaledBitmap(sourceBitmap, resizedWidth, resizedHeight, <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isRecycleSrcBitmap &amp;&amp; !sourceBitmap.equals(resizedBitmap)) { recycleBitmap(sourceBitmap); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resizedBitmap; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> Bitmap </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">crop</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap sourceBitmap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sourceBitmap == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> srcWidth = sourceBitmap.getWidth(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> srcHeight = sourceBitmap.getHeight(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> croppedX = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> croppedY = <span class="hljs-number"><span class="hljs-number">0</span></span>; croppedX = (srcWidth &gt; _boxWidth) ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((srcWidth - _boxWidth) / <span class="hljs-number"><span class="hljs-number">2</span></span>) : <span class="hljs-number"><span class="hljs-number">0</span></span>; croppedY = (srcHeight &gt; _boxHeight) ? (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span>)((srcHeight - _boxHeight) / <span class="hljs-number"><span class="hljs-number">2</span></span>) : <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (croppedX == <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; croppedY == <span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sourceBitmap; Bitmap croppedBitmap = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { croppedBitmap = Bitmap.createBitmap(sourceBitmap, croppedX, croppedY, _boxWidth, _boxHeight); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(Exception e) { } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_isRecycleSrcBitmap &amp;&amp; !sourceBitmap.equals(croppedBitmap)) { recycleBitmap(sourceBitmap); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> croppedBitmap; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">recycleBitmap</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Bitmap bitmap)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (bitmap == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || bitmap.isRecycled()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; bitmap.recycle(); System.gc(); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamGetter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StreamFromFile</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamGetter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String _path; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Context _ctx; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StreamFromFile</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context ctx, String path)</span></span></span><span class="hljs-function"> </span></span>{ _path = path; _ctx = ctx; } <span class="hljs-meta"><span class="hljs-meta">@SuppressWarnings</span></span>(<span class="hljs-string"><span class="hljs-string">"resource"</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { Uri uri = Uri.parse(_path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-string"><span class="hljs-string">"content"</span></span>.equals(uri.getScheme()) ? _ctx.getContentResolver().openInputStream(uri) : <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> FileInputStream(_path); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (FileNotFoundException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">StreamFromByteArray</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">IStreamGetter</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span>[] _rawImage; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">StreamFromByteArray</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] rawImage)</span></span></span><span class="hljs-function"> </span></span>{ _rawImage = rawImage; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> InputStream </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_rawImage == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ByteArrayInputStream(_rawImage); } } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getOrientation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(Context context, Uri uri)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-string"><span class="hljs-string">"content"</span></span>.equals(uri.getScheme())) { Cursor cursor = context.getContentResolver().query(uri, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> String[] { MediaStore.Images.ImageColumns.ORIENTATION }, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (cursor == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> || cursor.getCount() != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } cursor.moveToFirst(); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> orientation = cursor.getInt(<span class="hljs-number"><span class="hljs-number">0</span></span>); cursor.close(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> orientation; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { ExifInterface exif = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ExifInterface(uri.getPath()); <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> orientation = exif.getAttributeInt(ExifInterface.TAG_ORIENTATION, -<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (orientation) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ExifInterface.ORIENTATION_ROTATE_270: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">270</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ExifInterface.ORIENTATION_ROTATE_180: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">180</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ExifInterface.ORIENTATION_ROTATE_90: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">90</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> ExifInterface.ORIENTATION_NORMAL: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (IOException e) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> -<span class="hljs-number"><span class="hljs-number">1</span></span>; } } } }</code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/161027/">https://habr.com/ru/post/161027/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../161011/index.html">Running service workers using systemd</a></li>
<li><a href="../161013/index.html">Logic - weekly selection of gaming and IT industry news ‚Ññ3</a></li>
<li><a href="../161017/index.html">Mobile operators of Spain have launched Joyn for Android: is the industry trying to return Whatsapp and Viber users?</a></li>
<li><a href="../161021/index.html">Bluetooth sticker helps to find keys, backpack or remote control</a></li>
<li><a href="../161025/index.html">BitTorrent intends to become a distributor of licensed content.</a></li>
<li><a href="../161029/index.html">7 Grocery technicians that the developer should pay attention to</a></li>
<li><a href="../161031/index.html">Martian Code: Lecture on how to program Curiosity</a></li>
<li><a href="../161033/index.html">Dismantling the new iMac 2012</a></li>
<li><a href="../161035/index.html">10 PRINT CHR $ (205.5 + RND (1)) ;: GOTO 10</a></li>
<li><a href="../161037/index.html">Part 2: Tunnel Magic, NetDB, and Protocol Juggling</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>