<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>What role did MS-DOS play in Windows 95?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="MS-DOS in Windows 95 was used for two purposes: 

- She served as a loader. 
- She acted as a compatibility layer with 16-bit drivers.  When Windows 9...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>What role did MS-DOS play in Windows 95?</h1><div class="post__text post__text-html js-mediator-article">  MS-DOS in Windows 95 was used for two purposes: <ul><li>  She served as a loader. </li><li>  She acted as a compatibility layer with 16-bit drivers. </li></ul> When Windows 95 started, it first loaded a special version of MS-DOS, it was she who processed your <code>CONFIG.SYS</code> file, ran <code>COMMAND.COM</code> , which your <code>AUTOEXEC.BAT</code> ran and eventually executed <code>WIN.COM</code> , which in turn started the boot process 32 -bit <abbr title="Virtual Machine Manager">VMM</abbr> virtual machine manager. <br><br>  This special version of MS-DOS was fully functional to the extent that the words ‚Äúfully functional‚Äù are generally applicable to MS-DOS.  It couldn‚Äôt have been any other way; when it went into MS-DOS emulation mode, only this version remained to work. <br><br>  The <code>WIN.COM</code> program started downloading what most people call ‚ÄúWindows‚Äù itself.  Through a copy of MS-DOS, she loaded the virtual machine manager, read the <code>SYSTEM.INI</code> file, loaded the virtual device drivers, then turned off the EMM386 (if there was one), and switched to protected mode.  ‚ÄúReal Windows‚Äù from the point of view of most people is exactly protected mode. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In protected mode, virtual device drivers worked their magic.  Among their actions was <a href="http://blogs.msdn.com/larryosterman/archive/2004/08/12/213681.aspx">pulling out the entire MS-DOS state</a> , translating it into the 32-bit file subsystem state, and disabling MS-DOS.  All further file operations were directed to the 32-bit file subsystem.  When the program accessed <code>int 21h</code> , the 32-bit file subsystem was responsible for processing. <br><br>  This is where the second role of MS-DOS comes into play.  You see, MS-DOS programs and drivers liked to be embedded in the depths of the operating system.  They could replace the interrupt handler <code>21h</code> , they could patch the system code, they could replace the low-level disk handlers <code>int 25h</code> and <code>int 26h</code> .  They could also create mind-blowing things with interruptions of BIOS type <code>int 13h</code> , responsible for working with disks. <br><br><a name="habracut"></a>  When the program accessed <code>int 21h</code> , first the request was sent to the 32-bit file subsystem, where it underwent some preprocessing.  Then, if the file subsystem detected that someone had intercepted the <code>int 21h</code> vector, it <i>went back to the 16-bit code</i> to allow the interceptor to execute.  Replacing the <code>int 21h</code> vector is ideologically similar to subclassing a window.  You get the old vector and install the new vector.  When the handler you set is called, you do something, and then call the old handler.  After returning from the old handler, you can still do something before returning control. <br><br>  One of the 16-bit drivers loaded from <code>CONFIG.SYS</code> was <code>IFSMGR.SYS</code> .  His task was to <i>intercept MS-DOS first</i> , before all the other drivers and programs got their chance!  This driver was in collusion with the 32-bit file subsystem, <i>returning from 16-bit code back to 32-bit</i> so that the file subsystem could continue its work. <br><br>  In other words, MS-DOS was just an exceptionally adept <a href="http://blogs.msdn.com/oldnewthing/archive/2006/01/10/511201.aspx">decoy</a> .  The 16-bit drivers and programs patched and intercepted the handlers, which for them looked just like real MS-DOS, but in reality were bait.  If the 32-bit file subsystem saw that someone had bought the bait, she made the decoy duck quack. <br><br>  Let's start with the system without the "evil" drivers and programs that are embedded in MS-DOS. <br><img src="https://habrastorage.org/storage2/962/388/cd9/962388cd9d387d898b0a3826adacd9ab.png"><br><br>  It is a paradise.  The 32-bit file subsystem was able to do all the work, without interacting with annoying drivers who did fancy things.  Note the additional step of updating the MS-DOS state variable.  Although we retrieved them during the download, we keep them up to date, as drivers and programs often "knew" about them, bypassed the operating system, and worked directly with state variables.  Consequently, the file subsystem should have maintained the illusion of MS-DOS responsibility (despite the fact that MS-DOS actually does not work anymore) for such drivers and programs to see what they expected. <br><br>  Please also note that the state variables are different for different virtual machines.  (That is, each open MS-DOS session got its own copy of state variables.) In the end, <a href="http://blogs.msdn.com/oldnewthing/archive/2007/12/18/6794821.aspx">each MS-DOS session had a separate current folder</a> , a separate file table, and so on.  However, all this was a performance, because the real list of open files was stored in a 32-bit file subsystem.  It could not be otherwise, since disk caches should have been reconciled, and file sharing restrictions should be checked globally.  If one MS-DOS session opened a file for exclusive access, then an attempt by a program running in another MS-DOS session to open the same file should have completed with an error. <br><br>  Well, it was a simple case.  Difficult case: you had a driver that intercepted an <code>int 21h</code> .  I do not know what this driver does, say, a network driver that intercepts input-output for network drives and processes it somehow.  Suppose also that some TSR program running in an MS-DOS session intercepted <code>int 21h</code> to <a href="http://www.fysnet.net/tsrdemo.htm">print on screen 1 when <code>int 21h</code> is called, and 2 when <code>int 21h</code> ends</a> .  Let's trace the access to the local disk (not network, so the network driver does not do anything): <br><img src="https://habrastorage.org/storage2/fa1/ba3/025/fa1ba3025878065358bdec64c00c63a1.png"><br><br>  Note that all the work is still done by the 32-bit file subsystem.  The call goes through the entire 16-bit chain only to maintain the illusion of the responsibility of 16-bit MS-DOS.  In the 16-bit world, only the code set by the TSR and the driver were <code>IFSMGR</code> , plus a small piece of <code>IFSMGR</code> connecting the components.  No 16-bit MS-DOS code was executed.  The 32-bit file system intercepted all work from MS-DOS. <br><br>  A similar dance ‚Äúto intercept normal work, but to allow unusual actions if someone asked for unusual actions‚Äù occurred when the I / O subsystem took control of your hard disk from 16-bit device drivers.  If the subsystem recognized the drivers, it collected their status and processed all operations in the same way as the 32-bit file subsystem processed the operations instead of 16-bit MS-DOS.  On the other hand, if a subsystem did not recognize some kind of driver, it left it responsible for the disk.  The component that transmits commands from a 32-bit environment to a 16-bit driver is called <abbr title="Real mode mapper">RMM</abbr> . <br><br>  If you are not lucky enough to use RMM for a disk, you probably noticed that the performance of operations with this disk is terrible.  The reason for this is the use of the old clumsy 16-bit driver instead of the fast multi-threaded 32-bit driver.  (While the 16-bit driver was processing a single I / O operation, it was impossible to process other I / O, because the 16-bit drivers were not multi-threaded.) <br><br>  RMM, oddly enough, turned out to be useful for its terrible, because its use was an early sign of infection of your computer with MS-DOS-virus.  In the end, MS-DOS viruses did the same thing as TSR and drivers: they intercepted interrupt vectors and take control of your hard disk.  From the point of view of the I / O subsystem, they looked exactly like 16-bit hard disk drivers!  When people complained about ‚ÄúWindows suddenly started to terribly slow down,‚Äù we sent them to the system performance page in the control panel and asked if there was a line ‚ÄúSome disks work in MS-DOS mode‚Äù or ‚ÄúAll disks use MS-DOS compatibility mode‚Äù .  If it does, then RMM was responsible for the disks, and if you didn‚Äôt change the hardware, it probably meant a virus. <br><br>  Finally, some parts of MS-DOS were not related to I / O.  For example, there were functions for allocating memory, <a href="http://blogs.msdn.com/oldnewthing/archive/2007/12/17/6785519.aspx">parsing a string with possible wildcards in <abbr title="File control block">FCB</abbr> format,</a> and the like.  Such functions were still handled by MS-DOS, since these are just functions of the "auxiliary library" and did not benefit from rewriting in 32-bit code, except the possibility to say "yes, we did it."  The old 16-bit code worked fine, and using ready-made code made it possible to maintain compatibility with programs patching MS-DOS to change the behavior of such functions. <br><br><blockquote>  <i>The first comment to the original article: ‚ÄúMost impressive is that most of this time (most of the time) actually worked (mostly).‚Äù</i> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/191212/">https://habr.com/ru/post/191212/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191190/index.html">SanDisk Connect Wireless Media Drive - a wireless flash drive for mobile devices</a></li>
<li><a href="../191192/index.html">NodeJS Cluster-hub. Messaging in cluster, requests, interprocess exclusive locks (critical sections)</a></li>
<li><a href="../191196/index.html">Mobile acquiring services and mini terminals in Russia - it's time to take Visa and MasterCard!</a></li>
<li><a href="../191202/index.html">The head of Microsoft resigns. Optimistic version of the article</a></li>
<li><a href="../191210/index.html">Yii, continuous integration - how not to break everything</a></li>
<li><a href="../191214/index.html">Google updated dictionary search function</a></li>
<li><a href="../191216/index.html">Zephyr - NASA Sail Rover to explore Venus</a></li>
<li><a href="../191218/index.html">Divide and rule. Or a rights sharing system for ASP MVC</a></li>
<li><a href="../191232/index.html">Google is working on unmanned vehicles of its own production</a></li>
<li><a href="../191234/index.html">Ranking algorithm changes in App Store</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>