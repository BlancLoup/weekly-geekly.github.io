<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pathfinding: A simple implementation of a funnel algorithm (Funnel Algorithm)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The funnel algorithm is a simple algorithm for finding the simplest path that passes through the ‚Äúportals‚Äù. The most detailed description can be found...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pathfinding: A simple implementation of a funnel algorithm (Funnel Algorithm)</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/b71/7c8/5bd/b717c85bd8c340aca20681df322054ae.png"><br><br>  The funnel algorithm is a simple algorithm for finding the simplest path that passes through the ‚Äúportals‚Äù.  The most detailed description can be found at the link <a href="https://skatgame.net/mburo/ps/thesis_demyen_2006.pdf">Efficient Triangulation-Based Pathfinding</a> ( <a href="https://skatgame.net/mburo/ps/thesis_demyen_2006.pdf">2</a> ) <br>  Here, this algorithm will be implemented before the stupor is simple.  Instead of using queues and other funny things, our simplest implementation restarts the loop every time it detects another angle.  This means that some portals will be polled more often than they should, nevertheless, making implementation easier. <br><a name="habracut"></a><br><img src="https://habrastorage.org/files/539/8f6/fa4/5398f6fa4c504c38a3ceb70e3ac37e45.png"><br>  The canvas above shows the 6 steps of this algorithm.  On checking each facet of the portal (the ants on something yellow), the following actions are performed: <br><ul><li>  Check whether the points inside the current tunnel are left and right.  If the answer is yes, then we move on without doing anything (AD). <br></li><li>  If the new left point is outside the tunnel, the tunnel is not updated (EF) </li><li>  If the new left point is behind the right side of the tunnel (F), we add the right point of the tunnel as the angle of the path and set and set this (left) point as the starting point and restart the algorithm (G). <br></li></ul><br>  These rules apply to the left side. <br>  As can be seen from the example above, some faces are rechecked several times, but all of these calculations are so simple that the overhead is dismissively small, giving a simple and practical implementation. <div class="spoiler">  <b class="spoiler_title">Badly hidden code</b> <div class="spoiler_text"><pre><code class="cpp hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">float</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">triarea2</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* b, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* c)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ax = b[<span class="hljs-number"><span class="hljs-number">0</span></span>] - a[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> ay = b[<span class="hljs-number"><span class="hljs-number">1</span></span>] - a[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> bx = c[<span class="hljs-number"><span class="hljs-number">0</span></span>] - a[<span class="hljs-number"><span class="hljs-number">0</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> by = c[<span class="hljs-number"><span class="hljs-number">1</span></span>] - a[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> bx*ay - ax*by; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">inline</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">bool</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">vequal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* a, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* b)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">float</span></span> eq = <span class="hljs-number"><span class="hljs-number">0.001f</span></span>*<span class="hljs-number"><span class="hljs-number">0.001f</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> vdistsqr(a, b) &lt; eq; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">stringPull</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* portals, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> nportals, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">float</span></span></span></span><span class="hljs-function"><span class="hljs-params">* pts, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">const</span></span></span></span><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> maxPts)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//   . int npts = 0; //   float portalApex[2], portalLeft[2], portalRight[2]; int apexIndex = 0, leftIndex = 0, rightIndex = 0; vcpy(portalApex, &amp;portals[0]); vcpy(portalLeft, &amp;portals[0]); vcpy(portalRight, &amp;portals[2]); //   . vcpy(&amp;pts[npts*2], portalApex); npts++; for (int i = 1; i &lt; nportals &amp;&amp; npts &lt; maxPts; ++i) { const float* left = &amp;portals[i*4+0]; const float* right = &amp;portals[i*4+2]; //   . if (triarea2(portalApex, portalRight, right) &lt;= 0.0f) { if (vequal(portalApex, portalRight) || triarea2(portalApex, portalLeft, right) &gt; 0.0f) { //  . vcpy(portalRight, right); rightIndex = i; } else { //     ,     ,       vcpy(&amp;pts[npts*2], portalLeft); npts++; //   . vcpy(portalApex, portalLeft); apexIndex = leftIndex; //   vcpy(portalLeft, portalApex); vcpy(portalRight, portalApex); leftIndex = apexIndex; rightIndex = apexIndex; //  i = apexIndex; continue; } } //   . if (triarea2(portalApex, portalLeft, left) &gt;= 0.0f) { if (vequal(portalApex, portalLeft) || triarea2(portalApex, portalRight, left) &lt; 0.0f) { //  . vcpy(portalLeft, left); leftIndex = i; } else { //    ,     ,      . vcpy(&amp;pts[npts*2], portalRight); npts++; //    vcpy(portalApex, portalRight); apexIndex = rightIndex; //   vcpy(portalLeft, portalApex); vcpy(portalRight, portalApex); leftIndex = apexIndex; rightIndex = apexIndex; //  i = apexIndex; continue; } } } //     . if (npts &lt; maxPts) { vcpy(&amp;pts[npts*2], &amp;portals[(nportals-1)*4+0]); npts++; } return npts; }</span></span></code> </pre> <br></div></div>  The <i><b>portals</b></i> array contains all the portal portals of the path to be simplified, the first point of the face on the left and the first point of the face on the right.  The first right and first left points are our starting point, and the last left and right points are our end point.  Those.  like that: <br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">//   vcpy(&amp;portals[nportals*4+0], startPos); vcpy(&amp;portals[nportals*4+2], startPos); nportals++; //     for (int i = 0; i &lt; path-&gt;npolys-1; ++i) { getPortalPoints(mesh, path-&gt;poly[i], path-&gt;poly[i+1], &amp;portals[nportals*4+0], &amp;portals[nportals*4+2]); nportals++; } //   vcpy(&amp;portals[nportals*4+0], endPos); vcpy(&amp;portals[nportals*4+2], endPos); nportals++;</span></span></code> </pre><br>  A drop of honey in a barrel of honey is that this algorithm can be implemented in the context of any navigation format.  Grid, connected squares, quadtree, waypoints (waypoints) or nesmesh - indifferent, the main thing is that you can provide a list of segments that are portals from one node to another. <br><br>  The algorithm is also well combined with the stirring.  You are free to calculate the desired speed of movement, based on the following turns.  It is so fast that you can count it (speed) on each iteration before applying the step of striing. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      ps It is highly recommended to get acquainted with a more complete version - at least diagonally (from a translator). </div><p>Source: <a href="https://habr.com/ru/post/278151/">https://habr.com/ru/post/278151/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278123/index.html">Symfony how to use FOSRestBundle</a></li>
<li><a href="../278125/index.html">Automation of business processes in CRM. Comparison of approaches</a></li>
<li><a href="../278127/index.html">Anniversary digest of interesting materials from the world of web development and IT for the last week No. 200 (February 22 - 28, 2016)</a></li>
<li><a href="../278129/index.html">Azure Backup Server - free DPM</a></li>
<li><a href="../278137/index.html">PHP Digest number 80 - interesting news, materials and tools (February 14 - 28, 2016)</a></li>
<li><a href="../278153/index.html">Part 1. Installing and Configuring a Reputable DNS Server Based on the PowerDNS Solution // Basic Installation</a></li>
<li><a href="../278159/index.html">Debian's RISC under QEMU</a></li>
<li><a href="../278163/index.html">CodingFuture + Puppet. Part III: Install Puppet Server (cfpuppetserver)</a></li>
<li><a href="../278165/index.html">Best practices Richard Siddeway Powershell in depth</a></li>
<li><a href="../278167/index.html">HTTP / 2: getting ready for the transition</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>