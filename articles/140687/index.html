<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Build Failover Systems Based on Exchange 2010</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day! 
 This article describes my experience in building a fault-tolerant Microsoft Exchange 2010 SP1 mail service. 
 It is useful mostly for begi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Build Failover Systems Based on Exchange 2010</h1><div class="post__text post__text-html js-mediator-article">  Good day! <br>  This article describes my experience in building a fault-tolerant Microsoft Exchange 2010 SP1 mail service. <br>  It is useful mostly for beginners to understand the theory. <br>  I will not delve into the practical aspects, but I will try to set out the theoretical basis necessary when building a failover Exchange cluster. <br>  Everything else is under the cut.  (A lot of text!) <br><a name="habracut"></a><br><br>  So, if our task is to build a failover mail system based on Exchange 2010, then the only (acceptable) option would be to use the DAG (Database Access Group). <br>  In addition to DAG, we will need several more servers to ensure the resiliency of the required Exchange roles.  About them will be discussed later. <br><br>  I needed to achieve the following goals: <br>  <b>‚Ä¢ Fault tolerance for clients using Outlook on the internal network</b> <b><br></b>  <b>‚Ä¢ Partial fault tolerance for clients using Outlook via RPC over HTTPS from the Internet</b> <b><br></b>  <b>‚Ä¢ Partial fault tolerance for ActiveSync clients</b> <b><br></b>  <b>‚Ä¢ Minimize the chance of losing incoming (from the Internet) mail</b> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In connection with the goals set before me, I began to work according to the following scheme (a small clarification - the channel between the data center and the office is 30 Mb / s synchronous): <br><img src="http://img13.imageshost.ru/img/2012/03/25/image_4f6f6d4b26433.jpg" alt="image"><br><br>  Let me remind you that in Exchange 2010 elements of a DAG array can be more than just a Mailbox server, which is why it greatly simplifies the work in comparison with version 2007. <br><br>  The first thing I do is take out the Edge Transport in the DMZ using TMG on both sites. <br>  In the DNS records for my domain, I prescribe 3 MX records with different priority - one points to the TMG in Datacenter, the other points to the gateway in Office, the third to the backup channel in the office, which is also set up in TMG and configured via ISP Redundancy (Failover).  This makes it the fourth item in my list of goals - <i>to minimize the chance of losing incoming mail</i> . <br><br>  If the Internet is lost in the data center / the server goes down - all incoming mail arrives at the server in the office.  The only option in which mail may still not be reached if the Internet disappears immediately in the data center and in the office (on two channels!) For more than 30 minutes. <br><br>  The following is to provide fault tolerance for clients using Outlook 2010 on the internal network.  To do this, you must ensure the fault tolerance of the Mailbox and Client Access roles. <br>  On 2 Exchange servers with the Mailbox role on different sites, 2 databases are created - one is active on the first site, the second is active on the other. <br><br>  What is it for: <br>  1) The distribution of the load, if everything works in normal mode. <br>  2) If the server in the data center fails / becomes unavailable, we have a copy of the database in the office, which will automatically switch to Active mode.  Users can continue to work. <br>  3) Ability to conduct server maintenance by switching active servers "to hot". <br><br>  When creating a DAG cluster from a GUI, you will need to specify at least one File Witness server.  File Witness server (file witness), to put it very roughly, is a server with a shared folder that will support votes in quorum in the event of a failure of one of the Mailbox servers.  It is needed so that after servers that have been unavailable for some time become Back-online, they can synchronize (read replicate) changes from other cluster members and not get confused about what they already have and what lacks. <br><br>  I created one File Witness server on each site (because if the Internet drops on one of the sites, both Mailbox and File Witness server become unavailable for the second part of the Exchange server) to maintain the quorum.  But the task of ensuring the resiliency of Outlook clients has not yet been completed. <br><br>  At this stage, the question arises: ‚Äú <i>But does everyone have a specific Client Access server registered in Outlook ?!</i>  <i>And if it becomes offline, then where will the clients connect?</i>  ". <br><br>  It is to prevent this situation from being used by Network Load Balancing Services (Network Load Balancing Services).  <i>I used the features that are available in Windows Server 2008 R2 with the role of Cluster Services, but Microsoft strongly recommends the use of "iron" NLB.</i> <br>  As NLB servers, I used File Witness server to save resources. <br><br>  On NLB, I configured load balancing between two Exchange servers with the Client Access role. <br>  <i><b>However, these servers [approx.</b></i>  <i><b>- Client Access] are not Mailbox servers!</b></i>  <i><b>We strongly recommend that you distribute these roles across different servers / virtual servers.</b></i> <br><br>  Now for Outlook clients, the server (which we specify when setting up an account) is the NLB server.  In order to provide even greater resiliency (in case of failure of one of the NLB servers), I created in the domain 2 DNS type A records with the same name ( <i>exchange.contoso.com for example</i> ), each of which refers to different NLB server. <br>  At the same time, thanks to the DNS Round Robin technology, in the event of a failure of 1 of the NLB servers, about 50% of the clients will work.  Of course, the DNS cache also comes into play here, but you can read about it and about Round Robin separately in the Microsoft knowledge base. <br><br>  So I executed the first item from the list of my goals - <i>fault tolerance for Outlook clients in the internal network</i> . <br><br>  A small addition - I configured VIP addresses (the entire internal subnet) on NLB that ALWAYS (except when the server is not available) will work with Exchange in the office - to reduce Internet traffic and increase speed.  Only if 1 of the servers fails, clients switch to another Client Access server (by the way, this rule also applies to mobile devices that connect to office Wi-Fi, because their DNS requests are returned IP-addresses from the local network).  For me it was relevant, because  I have no clients on the second site. <br><br>  There are 2 more points left that relate to clients outside the local network.  It's all very simple - in the public DNS records for my domain, I again indicate two (this time two, in order to save traffic on the backup channel in the office) type A records that refer to the external IP Forefront TMG in the data center and on the .  IP address in the office.  Autodiscover services are active both there and there. <br>  And again, thanks to DNS Round Robin technology, <u><b>partial</b></u> resiliency of ActiveSync and RPC over HTTPS clients is provided. <br><br>  PS I will be glad to your questions and constructive criticism. </div><p>Source: <a href="https://habr.com/ru/post/140687/">https://habr.com/ru/post/140687/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140682/index.html">LTE, 3G, Femto or Wi-Fi? Where is marketing, and where is a reasonable business model?</a></li>
<li><a href="../140683/index.html">PayPal and Russian Post</a></li>
<li><a href="../140684/index.html">Validation beyond the foul</a></li>
<li><a href="../140685/index.html">Intracorporate "store" and how to use it</a></li>
<li><a href="../140686/index.html">Windows Azure Toolkit for Windows 8: review and simple usage example</a></li>
<li><a href="../140688/index.html">HP officially introduced ProLiant Gen8 servers in Russia</a></li>
<li><a href="../140689/index.html">Password Manager with web access</a></li>
<li><a href="../140691/index.html">Applicants for new gTLDs are waiting for the last moment to apply</a></li>
<li><a href="../140692/index.html">We write a simple Windows application on Tcl / Tk using SQLite</a></li>
<li><a href="../140694/index.html">"Big Georgian Brother" will be dismantled on the bones on PHDays</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>