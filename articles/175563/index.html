<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to listen to the radio using powershell and node.js</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Part one: powershell and mci . 
 The operating system used is Windows 7. 
 The first question that arises is: how to play mp3 in powershell? 
 Earlier...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to listen to the radio using powershell and node.js</h1><div class="post__text post__text-html js-mediator-article"><h5>  Part one: <a href="http://ru.wikipedia.org/wiki/Windows_PowerShell">powershell</a> and <a href="http://ru.wikipedia.org/wiki/MCI_(%25D0%25B8%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D1%2584%25D0%25B5%25D0%25B9%25D1%2581)">mci</a> . </h5><br>  The operating system used is Windows 7. <br>  The first question that arises is: how to play mp3 in powershell? <br>  Earlier on Habr√© there were mentions of a similar question: <br>  <a href="http://habrahabr.ru/qa/6717/">How to play mp3 from the command line in Windows 7?</a> <br>  <a href="http://habrahabr.ru/post/117441/">How can you use PowerShell?</a> <br><br>  Due to the lack of a satisfactory answer, it was decided to use the Media Control Interface or mci. <br>  The advantages are as follows: built-in to the system, sufficiently low-level, it is possible to send commands as a string. <br>  Mci is known to many by answering the question: ‚Äúhow to open a CD-ROM reader / writer programmatically?‚Äù, Although it provides many other possibilities.  Below are some usage scenarios. <br><br>  Removing a CD-ROM: <br><pre><code class="cs hljs">mci <span class="hljs-string"><span class="hljs-string">'set cdaudio door open'</span></span></code> </pre> <br>  Play local mp3 file: <br><pre> <code class="cs hljs">mci <span class="hljs-string"><span class="hljs-string">'play C:\\temp\\Kalimba.mp3'</span></span> mci <span class="hljs-string"><span class="hljs-string">'status C:\\temp\\Kalimba.mp3 mode'</span></span></code> </pre><br>  Writing to a wav file: <br><pre> <code class="cs hljs">mci <span class="hljs-string"><span class="hljs-string">'open new type waveaudio alias RecWavFile'</span></span> mci <span class="hljs-string"><span class="hljs-string">'set RecWavFile bitspersample 16 samplespersec 44100 channels 2'</span></span> mci <span class="hljs-string"><span class="hljs-string">'record RecWavFile'</span></span> mci <span class="hljs-string"><span class="hljs-string">'stop RecWavFile'</span></span> mci <span class="hljs-string"><span class="hljs-string">'save RecWavFile C:\\temp\\RecWavFile.wav'</span></span> mci <span class="hljs-string"><span class="hljs-string">'close RecWavFile'</span></span> mci <span class="hljs-string"><span class="hljs-string">'play C:\\temp\\RecWavFile.wav wait'</span></span></code> </pre><br>  A simple option to play the stream from the network: <br><pre> <code class="cs hljs">mci <span class="hljs-string"><span class="hljs-string">'play http://some-radio-server.com:80/some-radio-channel.mp3'</span></span></code> </pre><br><a name="habracut"></a><br>  Advanced version of the playback stream from the network: <br><pre> <code class="cs hljs">mci <span class="hljs-string"><span class="hljs-string">'open http://some-radio-server.com:80/some-radio-channel.mp3 type mpegvideo alias radio'</span></span> <span class="hljs-meta"><span class="hljs-meta">#mci 'open http://other-radio-server/other-radio-channel.fake.mp3 type mpegvideo alias radio' mci 'status radio volume' mci 'setaudio radio volume to 100' mci 'play radio' mci 'status radio mode' mci 'stop radio' mci 'close radio'</span></span></code> </pre>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It may seem strange, but initially in powershell there is no such method (the author did not find it) working with mci.  To make this work possible, you need to write a wrapper over the mciSendStringA function.  At the same time, in order to have a full-fledged command line interface, in addition to entering commands, output of the result of the function execution and decoding of error codes is required.  The first is needed, for example, to request status with the status command.  The second is convenient, since you do not need to look for a description of the error each time. <br><br>  <b>mci powershell wrapper:</b> <br><pre> <code class="php hljs">$MemDef =@<span class="hljs-string"><span class="hljs-string">" [DllImport("</span></span>winmm.dll<span class="hljs-string"><span class="hljs-string">", CharSet = CharSet.Ansi)] public static extern int mciSendStringA( string lpstrCommand, [Out] byte[] lpstrReturnString, int uReturnLength, IntPtr hwndCallback); [DllImport("</span></span>winmm.dll<span class="hljs-string"><span class="hljs-string">", CharSet = CharSet.Ansi)] public static extern int mciGetErrorStringA( int dwError, [Out] byte[] lpstrBuffer, int uLength); "</span></span>@ $winmm = Add-Type -memberDefinition $MemDef -ErrorAction <span class="hljs-string"><span class="hljs-string">'SilentlyContinue'</span></span> -passthru -name mciSendString <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mci</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($strSend)</span></span></span><span class="hljs-function"> </span></span>{ $buffer = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object byte[] <span class="hljs-number"><span class="hljs-number">128</span></span> [int]$error = $winmm::mciSendStringA( $strSend, $buffer, <span class="hljs-number"><span class="hljs-number">128</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) [Text.Encoding]::ASCII.GetString($buffer) $error_buffer = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-Object byte[] <span class="hljs-number"><span class="hljs-number">128</span></span> [void]$winmm::mciGetErrorStringA( $error, $error_buffer, <span class="hljs-number"><span class="hljs-number">128</span></span> ) [Text.Encoding]::GetEncoding(<span class="hljs-string"><span class="hljs-string">'windows-1251'</span></span>).GetString($error_buffer) }</code> </pre><br>  Some explanations may be helpful. <br>  Inside $ MemDef contains a piece of C # code.  And inside $ winmm is the result of its compilation. <br>  To get a text string you need from the library function: <br><ol><li>  declare the type of the returned string (in C # code, which means that the register matters) as [Out] byte []; </li><li>  when you call to prepare the buffer; </li><li>  transfer buffer and buffer size; </li><li>  interpret received bytes as a string in a specific encoding. </li></ol><br>  It may seem that the use of C # inclusions, especially for declaring winapi-shnyh functions, is not very correct.  But here it is the convenience of use that is important, not the way to achieve it: the string with the mci command harmoniously merges with the powershell style. <br><br>  A list of mci commands can be found <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dd743572(v%3Dvs.85).aspx">here</a> or by searching for ‚ÄúMultimedia Command Strings‚Äù. <br>  PS Through mci, you can watch movies. <br><br><h5>  Part two: <a href="http://ru.wikipedia.org/wiki/HTTP">http</a> <a href="http://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25BE%25D0%25BA%25D1%2581%25D0%25B8-%25D1%2581%25D0%25B5%25D1%2580%25D0%25B2%25D0%25B5%25D1%2580">proxy</a> and <a href="http://ru.wikipedia.org/wiki/Nodejs">node.js</a> </h5><br>  As can be seen from the examples: it is possible to specify not only local files as a name, but also a URL. <br>  But for some servers (such as other-radio-server) there is a problem: playback starts only after a forced disconnection.  Your own HTTP proxy "correcting" the "wrong" packages can help here.  In particular, for immediate playback, it is enough to add the header 'content-length' to the response. <br>  To write your own proxy, node.js would be the best choice. <br><br>  After starting and connecting the proxy, you can use the commented line instead of the previous one. <br>  The end of the url ".fake.mp3" talks about the need for proxy manipulations.  Below is the far from the optimal server code. <br><br>  <b>node / proxy_server.js:</b> <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'./simple_cli'</span></span>).run() <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> http = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'http'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = <span class="hljs-built_in"><span class="hljs-built_in">require</span></span>(<span class="hljs-string"><span class="hljs-string">'url'</span></span>) http.createServer(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request, response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> u = url.parse(request.url) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> options = { <span class="hljs-attr"><span class="hljs-attr">port</span></span> : u[<span class="hljs-string"><span class="hljs-string">'port'</span></span>] || <span class="hljs-number"><span class="hljs-number">80</span></span>, <span class="hljs-attr"><span class="hljs-attr">host</span></span> : u[<span class="hljs-string"><span class="hljs-string">'hostname'</span></span>], <span class="hljs-attr"><span class="hljs-attr">method</span></span> : request.method, <span class="hljs-attr"><span class="hljs-attr">path</span></span> : u[<span class="hljs-string"><span class="hljs-string">'pathname'</span></span>], <span class="hljs-attr"><span class="hljs-attr">headers</span></span> : request.headers } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(request.url) <span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> options.headers[<span class="hljs-string"><span class="hljs-string">'proxy-connection'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( request.url.substr(<span class="hljs-number"><span class="hljs-number">-9</span></span>) === <span class="hljs-string"><span class="hljs-string">".fake.mp3"</span></span> ) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> p = options[<span class="hljs-string"><span class="hljs-string">'path'</span></span>] options[<span class="hljs-string"><span class="hljs-string">'path'</span></span>] = p.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, p.length - <span class="hljs-number"><span class="hljs-number">9</span></span>) options[<span class="hljs-string"><span class="hljs-string">'icy-metadata'</span></span>] = <span class="hljs-string"><span class="hljs-string">'0'</span></span> } <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(options) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> proxy_request = http.request(options); proxy_request.on(<span class="hljs-string"><span class="hljs-string">'response'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">proxy_response</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(proxy_response.headers) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>( request.url.substr(<span class="hljs-number"><span class="hljs-number">-9</span></span>) === <span class="hljs-string"><span class="hljs-string">".fake.mp3"</span></span> ) { proxy_response.headers[<span class="hljs-string"><span class="hljs-string">'content-length'</span></span>] = <span class="hljs-string"><span class="hljs-string">'221183499'</span></span> } proxy_response.pipe(response); response.writeHead(proxy_response.statusCode, proxy_response.headers); }); request.pipe(proxy_request); }).listen(<span class="hljs-number"><span class="hljs-number">8080</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Server running...'</span></span>);</code> </pre><br><br>  PS Proxy can also be useful, for example, for viewing or preprocessing sent requests and received answers. <br><br><h5>  Part Three: <a href="http://ru.wikipedia.org/wiki/%25D0%2598%25D0%25BD%25D1%2582%25D0%25B5%25D1%2580%25D0%25B0%25D0%25BA%25D1%2582%25D0%25B8%25D0%25B2%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D1%258C">Interactivity</a> </h5><br>  Sometimes, for the convenience of viewing the headers passing through the server, you need to clear the console.  The simplest command line interface allows you to achieve this. <br>  <b>node / simple_cli.js</b> <br><pre> <code class="javascript hljs"><span class="hljs-built_in"><span class="hljs-built_in">module</span></span>.exports.run = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{ process.stdin.resume(); process.stdin.setEncoding(<span class="hljs-string"><span class="hljs-string">'utf8'</span></span>); process.stdin.on(<span class="hljs-string"><span class="hljs-string">'data'</span></span>, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">data</span></span></span><span class="hljs-function">) </span></span>{ data = data.toString().trim(); <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (data) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'exit'</span></span>: process.exit(); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'clear'</span></span>: process.stdout.write(<span class="hljs-string"><span class="hljs-string">'\u001B[2J\u001B[0;0f'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'help'</span></span>: process.stdout.write(<span class="hljs-string"><span class="hljs-string">'exit, clear, help\n'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: process.stdout.write(<span class="hljs-string"><span class="hljs-string">'unrecognize: '</span></span>+data+<span class="hljs-string"><span class="hljs-string">'\n'</span></span>); } }); }</code> </pre><br>  This is needed for easy server startup: <br>  <b>run_proxy_server.cmd</b> <br><pre> <code class="dos hljs">"<span class="hljs-variable"><span class="hljs-variable">%~d0%</span></span>~p0node.exe" "<span class="hljs-variable"><span class="hljs-variable">%~d0%</span></span>~p0node\proxy_server.js" <span class="hljs-built_in"><span class="hljs-built_in">pause</span></span></code> </pre><br><br>  The final recipe: <br><ol><li>  download node.exe to the working folder from ‚Äú <a href="http://nodejs.org/download/">nodejs.org/download</a> ‚Äù <br>  After creating all the files in it, we get the following tree: <br>  + <br>  | -node.exe <br>  | -run_proxy_server.cmd <br>  | + node <br>  |  | -proxy_server.js <br>  |  | -simple_cli.js <br></li><li>  Run http proxy: <br>  run_proxy_server.cmd </li><li>  set the local proxy: <br>  windows + R, control, ctrl + F, pr <br>  "Proxy server settings", "Network settings", "Proxy server", "Use proxy server ...." <br>  Address: 127.0.0.1 Port: 8080 <br>  OK </li><li>  interactively execute the wrapper code </li><li>  interactively execute examples </li></ol><br>  For the last two points, you can use, for example, any of the options: <br><ul><li>  poweshell from command line </li><li>  Windows powershell </li><li>  Windows PowerShell ISE </li></ul><br><br>  PS As some-radio-server and some-radio-channel, you can take, for example, icy-e-05.sharp-stream and kiss100low respectively, and as other-radio-server and other-radio-channel - pub5.5. .fm and di_eurodance. </div><p>Source: <a href="https://habr.com/ru/post/175563/">https://habr.com/ru/post/175563/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../175543/index.html">Note on entering American colleges</a></li>
<li><a href="../175551/index.html">Grabcad - announced a volunteer contest to create glasses that allow deaf people to see and read a speech, or maybe more</a></li>
<li><a href="../175553/index.html">A Brief History of Animals on O'Reilly Books</a></li>
<li><a href="../175557/index.html">Moscow public transport fare collection system</a></li>
<li><a href="../175559/index.html">As I wrote skad. Part five</a></li>
<li><a href="../175569/index.html">How Visa and Master Card Benefit from Working with Square</a></li>
<li><a href="../175571/index.html">Tree View with "CRUD operations", "drag and drop (DnD)" and "delayed loading" using Dojo Tree, Entity Framework, SQL Server and ASP.NET MVC</a></li>
<li><a href="../175575/index.html">Date mining and heuristics of finding places in restaurants: almost the same problem as with free parking</a></li>
<li><a href="../175583/index.html">Thinking about fremium games, on the other hand barricades</a></li>
<li><a href="../175587/index.html">SSAS 2012: from multidimensional to tabular data model</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>