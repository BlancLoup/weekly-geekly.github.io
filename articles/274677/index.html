<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Software Internet gateway for a small company (Shorewall, OpenVPN, OSPF). Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present the second article in the series, aimed at "continuing" system administrators, for experienced ones, I can hardly discover something new. 
 ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Software Internet gateway for a small company (Shorewall, OpenVPN, OSPF). Part 2</h1><div class="post__text post__text-html js-mediator-article">  I present the second article in the series, aimed at "continuing" system administrators, for experienced ones, I can hardly discover something new. <br>  In these articles, we will look at building an Internet gateway on linux, allowing you to link several company offices, and provide limited access to the network, traffic prioritization (QoS) and simple load balancing with redundancy between two providers. <br>  Specifically in this part: <br><ul><li>  More detailed setting Shorewall </li><li>  Terrible and not clear QoS </li><li>  Load balancing and redundancy </li></ul><br><br>  And in the <a href="http://habrahabr.ru/post/274639/">previous part</a> were considered: <br><ul><li>  The simplest setting is Shorewall </li><li>  Awfully tricky dnsmasq setup </li><li>  No less complicated setting OpenVPN </li><li>  And for many continuing admins atypical, dynamic routing, for example, OSPF </li></ul><br>  <a href="https://habrahabr.ru/post/277983/">In the third part</a> : <br><ul><li>  Full QoS in Shorewall </li><li>  More detailed setting Shorewall </li><li>  Channel traffic scaling according to protocols </li><li>  Crutches, without them, nowhere </li></ul><br>  <a href="https://habrahabr.ru/post/277983/">In the fourth part</a> : <br><ul><li>  Automatic events </li><li>  Macros </li></ul><br><a name="habracut"></a><br>  Everything described below is valid for CentOS 7.1 (and above, the 6th series is also suitable, but with some minor features) <br><br><h1>  In-depth customization Shorewall </h1>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The last time we set up a rather trusting and primitive mode of operation, we will now turn on a bit of sensible paranoia. <br>  This is not difficult to do, let's edit the file: <br><div class="spoiler">  <b class="spoiler_title">policy</b> <div class="spoiler_text"><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/policy # # For information about entries in this file, type "man shorewall-policy" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-policy.html # ############################################################################### #SOURCE DEST POLICY LOG LIMIT: CONNLIMIT: # LEVEL BURST MASK $FW all REJECT grn all REJECT tun all REJECT red all DROP</span></span></code> </pre> <br></div></div><br>  The new configuration has become easier, but it's too early to rejoice, the rules file will swell considerably: <br><div class="spoiler">  <b class="spoiler_title">/ etc / shorewall / rules</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP ?SECTION ALL ?SECTION ESTABLISHED ?SECTION RELATED ?SECTION INVALID ?SECTION UNTRACKED ?SECTION NEW INCLUDE rules.fw INCLUDE rules.grn INCLUDE rules.red INCLUDE rules.red-dnat INCLUDE rules.tun</span></span></code> </pre><br></div></div><br>  And we will use the INCLUDE directive to spread the rules across several files: <br><div class="spoiler">  <b class="spoiler_title">rules.fw</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules.fw # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP DNS(ACCEPT) $FW red Web(ACCEPT) $FW red FTP(ACCEPT) $FW red OpenVPN(ACCEPT) $FW red Ping(ACCEPT) $FW all OSPF(ACCEPT) $FW tun SSH(ACCEPT) $FW all</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">rules.grn</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules.grn # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP DNS(ACCEPT) grn $FW Web(ACCEPT) grn red FTP(ACCEPT) grn red Ping(ACCEPT) grn all SSH(ACCEPT) grn all - - - - s:3/min #,  ,   SIP (    ) ACCEPT grn red udp 5060 - - - - - - - - sip</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">rules.red</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules.red # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP OpenVPN(ACCEPT) red $FW SSH(ACCEPT) red $FW - - - - s:3/min SIP(ACCEPT) red grn</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">rules.tun</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules.tun # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP Ping(ACCEPT) tun $FW OSPF(ACCEPT) tun $FW SSH(ACCEPT) tun $FW - - - - s:3/min SSH(ACCEPT) tun grn - - - - s:3/min</span></span></code> </pre><br></div></div><br>  Now all traffic is under our control, we let only those protocols that we want.  Pay attention to the rules for SSH, we have limited the frequency of connections to 3 per minute, from each ip source.  But you have to be very careful with this parameter, by incorrectly specifying the key s: or d :, you can make your service easily amenable to DDoS attack.  And for Web traffic (and indeed any), it must be borne in mind that many potential customers can sit behind NAT, and then one IP, the source of connections, can generate a significant number of connections. <br>  Pay attention to how we dealt with the SIP and FTP protocol.  We simply registered them, and Shorewall, using macros, hid from us all the subtleties of working with the nf_nat_ * and nf_conntrack_ * modules (without the appropriate modules, for each protocol, which besides the command connection (or in general all the ports are dynamic, like RPC), it also creates and secondary ports on unknown ports, Shorewall, like iptables, will not be able to dynamically open ports for these connections).  In the examples for SIP, I used almost manual configuration, specifying the protocol, port, and helper used. <br>  With helpers, Shorewall works automatically (if it is not disabled), as soon as the protocol is encountered, or the use of the helper column is explicitly specified, Shorewall loads the appropriate module.  You can view the known shorewall modules and their settings in the file: / usr / share / shorewall / helpers.  If there is a need to change them, copy the file into / etc / shorewall, then this copy will override the standard file. <br>  If we need to forward ports to internal servers, this is not difficult: <br><div class="spoiler">  <b class="spoiler_title">rules.red-dnat</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules.red-dnat # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP Web(DNAT) red grn:172.16.0.2 #,      ,    DNAT     : #Web(DNAT) red grn:172.16.0.2 - - - 192.168.10.37 #,  : #DNAT red grn:172.16.0.2 tcp 80,443 #DNAT red grn:172.16.0.2 tcp 80,443 - 192.168.10.37 #   : #DNAT red grn:172.16.0.2:80 tcp 8080</span></span></code> </pre><br></div></div><br>  In addition, Shorewall supports ipsets (verify that the package is installed: yum install ipset), which are simply named address lists.  Useful when you need to configure a certain rules for a group of hosts that can not be combined into a subnet. <br>  It is not difficult to use them in configs, it is enough where you use addresses or subnets + &lt;ipsets name&gt;. <br>  If we want Shorewall to save and restore us ipsets during its restarts, then you need to set SAVE_IPSETS = Yes in the shorewall.conf file <br>  Here‚Äôs what a configuration with and without ipsets might look like: <br><div class="spoiler">  <b class="spoiler_title">rules</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/rules # # For information on the settings in this file, type "man shorewall-rules" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-rules.html # ###################################################################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE ORIGINAL RATE USER/ MARK CONNLIMIT TIME HEADERS SWITCH HELPER # PORT(S) PORT(S) DEST LIMIT GROUP # ipsets OpenVPN(ACCEPT) red:192.168.10.4,192.168.23.2 $FW # ipsets OpenVPN(ACCEPT) red:+ovpn_allow $FW</span></span></code> </pre><br></div></div><br>  First, let's announce our ipsets: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#  iphash (     ,   man ipset    ) ipset -N ovpn_allow iphash #     ipset -A ovpn_allow 192.168.10.4 ipset -A ovpn_allow 192.168.23.2</span></span></code> </pre><br>  That's all, we can see what we have recorded: ipset -L <br><pre> <code class="bash hljs">Name: ovpn_allow Type: <span class="hljs-built_in"><span class="hljs-built_in">hash</span></span>:ip Revision: 1 Header: family inet hashsize 1024 maxelem 65536 Size <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> memory: 16560 References: 0 Members: 192.168.23.2 192.168.10.4</code> </pre><br><h1>  Simple load balancing and redundancy at Shorewall </h1><br><br>  I will say right away, and balancing and redundancy, only configured using Shorewall, he himself does not provide any functionality for detecting the loss of a channel or a uniform distribution of the real load. <br>  All setup is reduced to editing one file: <br><div class="spoiler">  <b class="spoiler_title">providers</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/providers # # For information about entries in this file, type "man shorewall-providers" # # For additional information, see http://shorewall.net/MultiISP.html # ############################################################################################ #NAME NUMBER MARK DUPLICATE INTERFACE GATEWAY OPTIONS COPY pr1 1 0x10000 - $IF_RED1 $GW_RED1 track,fallback=1 pr2 2 0x20000 - $IF_RED2 $GW_RED2 track,fallback=4</span></span></code> </pre><br></div></div><br>  If anyone remembers, in the last article there was a section from ‚ÄúShorewall.conf‚Äù.  It is needed just to configure the labeling of packages and work with providers.  There we set which bits from the packet label, set the provider ID, which tags just (I‚Äôm not using them anywhere, but Shorewall uses them for its own needs), and which ones to track connections. <br>  Here we described two providers, asked how to label packets for them, on which interface each one is sitting, and what is the gateway. <br>  Here is the OPTIONS column, I need to explain a bit.  Here the fallbak key forces to generate additional routing rules, in case balancing cannot process the packet (the interface is adjacent to the example), and the dial sets the interface weight.  The track parameter indicates the need to track which provider the connection went to, and send the next packet from this connection to the same provider (if TRACK_PROVIDERS = Yes is installed in shorewall.conf, then this option is written automatically to all providers). , the more often new connections will come to the interface (as a result, relative weight is used, who has higher weight in proportion, traffic is more frequent there, it is not recommended to set a large weight value).  Balancing occurs on the principle of roundrobin by the kernel itself and is based on the fact that a client-server connection is established (as a client, your router and the server, respectively, are a remote server).  At the same time, the routes are cached for some time, and the following effect is obtained: someone in LAN, for example, reached a certain site (which has one IP), traffic went through provider 1, then someone else got there, and the traffic would run again through provider 1 (if the cache did not have time to be reset).  It may also turn out that you do not have symmetric providers, as in the example, and so lucky, every fourth connection falling on the first provider will be the most difficult, and we wanted to avoid it ... There are no simple solutions, and this article will not help you in any way. <br>  But not everything is so bad, and even so it works with dignity (by the way, it works so for most solutions, quite simple solutions are used for ‚Äúfair‚Äù balancing, which often do not work without support from providers (both of them)). <br>  Added variable file: <br><div class="spoiler">  <b class="spoiler_title">params</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/params # # Assign any variables that you need here. # # It is suggested that variable names begin with an upper case letter # to distinguish them from variables used internally within the # Shorewall programs # # Example: # # NET_IF=eth0 # NET_BCAST=130.252.100.255 # NET_OPTIONS=routefilter,norfc1918 # # Example (/etc/shorewall/interfaces record): # # net $NET_IF $NET_BCAST $NET_OPTIONS # # The result will be the same as if the record had been written # # net eth0 130.252.100.255 routefilter,norfc1918 # ############################################################################### IF_RED1=eth0 GW_RED1=192.168.10.1 IF_RED2=eth2 GW_RED2=detect IF_GRN=eth1 NET_GRN=172.16.0.0/23 IF_TUN=tap+ #LAST LINE -- DO NOT REMOVE</span></span></code> </pre><br></div></div><br>  You may notice that the second provider has the gateway specified as the ‚Äúdetect‚Äù keyword that works on connections with dynamic addressing.  For some cases (for example, PPtP), Shorewall itself cannot correctly determine the gateway, for which a file with an auxiliary script is used: <br><div class="spoiler">  <b class="spoiler_title">findgw</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall version 4 - Findgw File # # /etc/shorewall/findgw # # The code in this file is executed when Shorewall is trying to detect the # gateway through an interface in /etc/shorewall/providers that has GATEWAY # specified as 'detect'. # # The function should echo the IP address of the gateway if it knows what # it is; the name of the interface is in $1. # # See http://shorewall.net/shorewall_extension_scripts.htm for additional # information. # ############################################################################### LANG='C' nmcli --terse --fields IP6.GATEWAY device show ${1} | cut -f2- -d':' #IPv6 LANG='C' nmcli --terse --fields IP4.GATEWAY device show ${1} | cut -f2- -d':' #IPv4</span></span></code> </pre><br></div></div><br>  And importantly, you need to disguise it all correctly: <br><div class="spoiler">  <b class="spoiler_title">masq</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/masq # # For information about entries in this file, type "man shorewall-masq" # # The manpage is also online at # http://www.shorewall.net/manpages/shorewall-masq.html # ################################################################################################################################### #INTERFACE:DEST SOURCE ADDRESS PROTO PORT(S) IPSEC MARK USER/ SWITCH ORIGINAL PROBABILITY # GROUP DEST $IF_RED1 $NET_GRN detect $IF_RED2 $NET_GRN detect</span></span></code> </pre><br></div></div><br>  The detect parameter, in the ADDRESS column, forces you to determine the outgoing address on the interface for SNAT (with several providers it becomes necessary). <br>  And the script for NetworkManager will complement all this (a simpler version was in the last article, and it did not take into account that after raising the interface, Shorewall does not always correctly build the routing policy, so we simply restart it for such interfaces). <br><div class="spoiler">  <b class="spoiler_title">/etc/NetworkManager/dispatcher.d/30-shorewall.sh</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash IF=$1 #   ,     STATUS=$2 #     function check_prov() { PARAM=$(grep -v '^#' /etc/shorewall/params | grep $1 | cut -d '=' -f 1) if [ -z "$PARAM" ]; then grep -v '^#' /etc/shorewall/providers | grep -q $1 [[ $? == 0 ]] &amp;&amp; shorewall restart else grep -v '^#' /etc/shorewall/providers | grep -q $PARAM [[ $? == 0 ]] &amp;&amp; shorewall restart fi } case $STATUS in up) #      shorewall enable $IF shorewall6 enable $IF check_prov $IF ;; down) #      shorewall disable $IF shorewall6 disable $IF check_prov $IF ;; esac</span></span></code> </pre><br></div></div><br>  Having given the command, after shorewall restart: <br><pre> <code class="bash hljs">shorewall show routing</code> </pre><br>  You can see the constructed routing scheme: <br><div class="spoiler">  <b class="spoiler_title">Routing example</b> <div class="spoiler_text"><pre> <code class="bash hljs">Shorewall 5.0.2.1 Routing at cent1.domain.local -   8 23:41:30 MSK 2016 Routing Rules 0: from all lookup <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 999: from all lookup main 10000: from all fwmark 0x10000/0xff0000 lookup pr1 10001: from all fwmark 0x20000/0xff0000 lookup pr2 20000: from 192.168.10.37 lookup pr1 20000: from 192.168.10.36 lookup pr2 32765: from all lookup balance 32767: from all lookup default Table balance: Table default: default nexthop via 192.168.10.1 dev eth0 weight 1 nexthop via 192.168.10.1 dev eth2 weight 1 Table <span class="hljs-built_in"><span class="hljs-built_in">local</span></span>: <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 192.168.10.37 dev eth0 proto kernel scope host src 192.168.10.37 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 192.168.10.36 dev eth2 proto kernel scope host src 192.168.10.36 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 172.16.3.1 dev tap0 proto kernel scope host src 172.16.3.1 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 172.16.3.129 dev tap1 proto kernel scope host src 172.16.3.129 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 172.16.248.1 dev lo proto kernel scope host src 172.16.248.1 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 172.16.0.1 dev eth1 proto kernel scope host src 172.16.0.1 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 broadcast 192.168.10.255 dev eth2 proto kernel scope link src 192.168.10.36 broadcast 192.168.10.255 dev eth0 proto kernel scope link src 192.168.10.37 broadcast 192.168.10.0 dev eth2 proto kernel scope link src 192.168.10.36 broadcast 192.168.10.0 dev eth0 proto kernel scope link src 192.168.10.37 broadcast 172.16.3.255 dev tap1 proto kernel scope link src 172.16.3.129 broadcast 172.16.3.128 dev tap1 proto kernel scope link src 172.16.3.129 broadcast 172.16.3.127 dev tap0 proto kernel scope link src 172.16.3.1 broadcast 172.16.3.0 dev tap0 proto kernel scope link src 172.16.3.1 broadcast 172.16.248.1 dev lo proto kernel scope link src 172.16.248.1 broadcast 172.16.1.255 dev eth1 proto kernel scope link src 172.16.0.1 broadcast 172.16.0.0 dev eth1 proto kernel scope link src 172.16.0.1 broadcast 127.255.255.255 dev lo proto kernel scope link src 127.0.0.1 broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 <span class="hljs-built_in"><span class="hljs-built_in">local</span></span> 127.0.0.0/8 dev lo proto kernel scope host src 127.0.0.1 Table main: 192.168.10.1 dev eth2 scope link src 192.168.10.36 172.16.3.1 dev tap0 proto zebra 172.16.3.129 dev tap1 proto zebra 172.16.248.2 via 172.16.3.2 dev tap0 proto zebra metric 13 172.16.12.129 via 172.16.3.2 dev tap0 proto zebra metric 3 172.16.11.1 via 172.16.3.2 dev tap0 proto zebra metric 3 172.16.3.128/25 dev tap1 proto kernel scope link src 172.16.3.129 172.16.3.0/25 dev tap0 proto kernel scope link src 172.16.3.1 192.168.10.0/24 dev eth2 proto kernel scope link src 192.168.10.36 metric 101 192.168.10.0/24 dev eth0 proto kernel scope link src 192.168.10.37 metric 100 172.16.8.0/23 via 172.16.3.2 dev tap0 proto zebra metric 13 172.16.0.0/23 dev eth1 proto kernel scope link src 172.16.0.1 metric 100 Table pr1: 192.168.10.1 dev eth0 scope link src 192.168.10.37 default via 192.168.10.1 dev eth0 src 192.168.10.37 Table pr2: 192.168.10.1 dev eth2 scope link src 192.168.10.36 default via 192.168.10.1 dev eth2 src 192.168.10.36</code> </pre><br></div></div><br><br>  But, is it possible to send any traffic to a specific provider?  Answer Yes! <br><div class="spoiler">  <b class="spoiler_title">mangle</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/mangle # # For information about entries in this file, type "man shorewall-mangle" # # See http://shorewall.net/traffic_shaping.htm for additional information. # For usage in selecting among multiple ISPs, see # http://shorewall.net/MultiISP.html # # See http://shorewall.net/PacketMarking.html for a detailed description of # the Netfilter/Shorewall packet marking mechanism. # #################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE USER TEST LENGTH TOS CONNBYTES HELPER PROBABILITY DSCP # PORT(S) PORT(S) MARK(0x20000):P 172.16.0.4 0.0.0.0/0!172.16.0.0/12</span></span></code> </pre><br></div></div><br>  Here we have marked all traffic from 172.16.0.4 to any network, except 172.16.0.0/12, with the label of the second provider.  Conditions can be trickier, you just have to take into account, for the traffic generated on our gateway, you need to remove the ": P" rule. <br><br><h1>  Scary and terrible QoS </h1><br><br>  Immediately it is necessary to clarify this: to really adjust the speed, we can only when sending.  Incoming traffic has already reached our interface, bypassing all the bottlenecks, and pushing in queues for the right to be at our doorstep. <br>  But it is too early to despair, and there are mechanisms that are not as elegant and reliable as we would like, but solve this problem.  In networks based on IP family of protocols, this is solved in the following way: <br>  The source smoothly increases the sending speed, while the delivery responses (ACK packets in the TCP protocol) generally arrive or come with a normal delay.  If there is a loss or increase in ACK delay, the speed is reduced.  Then, after a certain period of time, they try to raise the speed again.  And this happens before the end of the transfer. <br>  What about UDP?  And with it, everything is simple, there is no control of delivery, there is no headache.  Sent and OK (this let the recipient suffer). <br>  Of course, in its pure form, UDP is usually not used in complex data transfer tasks.  This protocol is usually used as the basis for implementing its own delivery control option (you can say for your TCP implementations, in cases where the standard does not suit you).  Therefore, in many protocols running over UDP, delivery control is also there.  That does not negate the ability to send a continuous stream of UDP in full force, clogging the communication channel of the target (the same version of DDoS). <br>  How can we organize the prioritization of traffic and bandwidth allocation of incoming traffic?  The answer is higher: create a delay in receiving on your side (as a result, a delay in generating an ACK) or if the delay is indecently high, discard the packet. <br><br>  In Linux, this is implemented by creating a pseudo-interface IFB, which seems to rise between the physical interface and the gateway itself, passing incoming traffic through itself.  The traffic enters the physical interface (we have already accepted it on it), and immediately goes to the IFB, which already controls how fast and in what order to pass this traffic (or discard it altogether). <br>  Shorewall will help us with the configuration (although you can also register it in /etc/modprobe.d): <br><div class="spoiler">  <b class="spoiler_title">/ etc / shorewall / init</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/init # # Add commands below that you want to be executed at the beginning of # a "shorewall start", "shorewall-reload" or "shorewall restart" command. # # For additional information, see # http://shorewall.net/shorewall_extension_scripts.htm # ############################################################################### modprobe ifb numifbs=3 ip link set ifb0 up ip link set ifb1 up ip link set ifb2 up</span></span></code> </pre><br></div></div><br>  Here it is trivial, they created three pseudo-interfaces of the IFB and raised them. <br>  Next, we describe the interfaces on which we will regulate traffic: <br><div class="spoiler">  <b class="spoiler_title">tcdevices</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/tcdevices # # For information about entries in this file, type "man shorewall-tcdevices" # # See http://shorewall.net/traffic_shaping.htm for additional information. # ############################################################################### #NUMBER: IN-BANDWITH OUT-BANDWIDTH OPTIONS REDIRECTED #INTERFACE INTERFACES 1:$IF_GRN - 1000mbit hfsc,classify 2:ifb1 - 1000mbit hfsc,classify $IF_GRN 3:$IF_RED1 - 10mbit hfsc,classify 4:ifb0 - 10mbit hfsc,classify $IF_RED1 5:$IF_RED2 - 10mbit hfsc,classify 6:ifb2 - 10mbit hfsc,classify $IF_RED2</span></span></code> </pre><br></div></div><br>  Here we explicitly specify the numbers of the interfaces used (if not specified, Shorewall will number them in the order of the file declaration), associate the IFB with real interfaces, set the maximum outgoing speed (remember, only we adjust it and the ifb interface is in fact line) and set the classification discipline and that we will classify the traffic. <br>  <b>Important!</b>  The speed needs to be set slightly lower than the speed given by the provider.  If the speed with which we operate is higher than the provider gives us, then the bandwidth limitation will happen on its side, which means all our attempts at classification, etc.  (not completely, but largely) will be in vain.  It‚Äôs not very easy to make QoS channels with variable bandwidth, because of all the working tools you will only have to reorder the packets, in the hope that valuable traffic will crawl through the channel (the sufferers on the radio channels sigh sadly). <br>  We describe those same classes: <br><div class="spoiler">  <b class="spoiler_title">tcclasses</b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/tcclasses # # For information about entries in this file, type "man shorewall-tcclasses" # # See http://shorewall.net/traffic_shaping.htm for additional information. # ############################################################################### #INTERFACE:CLASS MARK RATE: CEIL PRIORITY OPTIONS # DMAX:UMAX 1:1:2 - 1mbit 3mbit 2 default 1:1:3 - 256kbit full 1 2:1:2 - 1mbit 3mbit 2 default 2:1:3 - 256kbit full 1 3:1:2 - 1mbit 3mbit 2 default 3:1:3 - 256kbit full 1 4:1:2 - 1mbit 3mbit 2 default 4:1:3 - 256kbit full 1 5:1:2 - 1mbit 3mbit 2 default 5:1:3 - 256kbit full 1 6:1:2 - 1mbit 3mbit 2 default 6:1:3 - 256kbit full 1</span></span></code> </pre><br></div></div><br>  For now, we will not do anything complicated (and therefore interesting and useful), while we will tie two classes to each interface (including IFB). <br>  In the first column, we associate an interface with classes.  &lt;interface number&gt;: &lt;parent class number&gt;: &lt;class number being described&gt;. <br>  The interface is always a class 1, which we essentially described in tcdevices. <br>  Further, we did not mark the packets, and therefore we will not use the column, then comes the most interesting, the minimum guaranteed bandwidth, and the maximum possible (no more than that of the parent class) for this class.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The priority will be given to the order of resolving the dispute (for someone less, he will go first if he has gone beyond the boundaries of the guaranteed lane, and she has already been completely occupied by someone else). </font><font style="vertical-align: inherit;">Finally, the options go, default says that if nothing is found by the filters (packages are not assigned to classes), then assign them a default class). </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Further, historically, the rules for classifying real interfaces are in the file:</font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">mangle</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/mangle # # For information about entries in this file, type "man shorewall-mangle" # # See http://shorewall.net/traffic_shaping.htm for additional information. # For usage in selecting among multiple ISPs, see # http://shorewall.net/MultiISP.html # # See http://shorewall.net/PacketMarking.html for a detailed description of # the Netfilter/Shorewall packet marking mechanism. # #################################################################################################################################################### #ACTION SOURCE DEST PROTO DEST SOURCE USER TEST LENGTH TOS CONNBYTES HELPER PROBABILITY DSCP # PORT(S) PORT(S) CLASSIFY(1:3) 0.0.0.0/0 0.0.0.0/0 tcp - 80,443 CLASSIFY(3:3) 0.0.0.0/0 0.0.0.0/0 tcp 80,443</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> And for virtual IFB in: </font></font><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">tcfilters</font></font></b> <div class="spoiler_text"><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment"># # Shorewall -- /etc/shorewall/tcfilters # # For information about entries in this file, type "man shorewall-tcfilters" # # See http://shorewall.net/traffic_shaping.htm for additional information. # ######################################################################################################## #INTERFACE: SOURCE DEST PROTO DEST SOURCE TOS LENGTH PRIORITY #CLASS PORT(S) PORT(S) 2:3 0.0.0.0/0 0.0.0.0/0 tcp - 80,443 4:3 0.0.0.0/0 0.0.0.0/0 tcp 80,443</span></span></code> </pre><br></div></div><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the example above, I placed the incoming traffic from the HTTP (S) server to class number 3 on the physical interface, and to the virtual one associated with it, and I made the outgoing one in the same way, but ‚Äúdeploying ports‚Äù. </font><font style="vertical-align: inherit;">Be very careful about the fact that connections are often bidirectional, and it is necessary to describe their classification separately for each direction, regardless of who initiated the client or server. </font></font><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is here that the roof begins to pop. </font><font style="vertical-align: inherit;">To understand the picture will help (I ask you not to hit them with your feet, I don‚Äôt really know how to work in Visio).</font></font><br><img src="https://habrastorage.org/files/a2d/8cf/b71/a2d8cfb71e8f4f0a86771cfea7f2452b.png"><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">You can cut traffic as a result at different sites, without applying IFB, if you have one provider and the gateway itself does not accept traffic (it is not its recipient). </font><font style="vertical-align: inherit;">If there are more providers, and the gateway itself actively receives traffic (for example, it serves a VPN), then it‚Äôs not easy to get out without an IFB.</font></font><br><br>  PS <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">In the next article, I plan to elaborate more on QoS, especially in light of the spread of VoIP technologies. </font><font style="vertical-align: inherit;">The topic is big, and you need to plan everything well. </font><font style="vertical-align: inherit;">If you are interested in a certain aspect in more detail, write a request in the comments, I will consider the wishes in the next article.</font></font></div><p>Source: <a href="https://habr.com/ru/post/274677/">https://habr.com/ru/post/274677/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../274663/index.html">STM32F4 USB RNDIS driver (device control via web interface)</a></li>
<li><a href="../274665/index.html">About excitement in the minds</a></li>
<li><a href="../274667/index.html">Selection: 115 useful mailing lists about technologies that you should subscribe to</a></li>
<li><a href="../274671/index.html">Sociology of Algorithms: How Financial Markets and High Frequency Trading are Connected (Part 2)</a></li>
<li><a href="../274675/index.html">What is RESTful in reality?</a></li>
<li><a href="../274679/index.html">Criminals who devastated ATMs with the help of the Tyupkin virus are caught</a></li>
<li><a href="../274681/index.html">Summary of registered second-level domains in the .RU zone</a></li>
<li><a href="../274683/index.html">jQuery plugin for building block mosaic</a></li>
<li><a href="../274685/index.html">VoIP + Cisco Packet Tracer</a></li>
<li><a href="../274687/index.html">IBDesignable magic or extend Interface Builder functionality in Xcode</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>