<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Memcached, PHP, Ketama. If not, but really want.</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I want to. 
 Ketama in PHP, and even so that at least from what access was. 
 This is not about PHP. In terms of access. Well, from PHP too. 

 Well, ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Memcached, PHP, Ketama. If not, but really want.</h1><div class="post__text post__text-html js-mediator-article"> I want to. <br>  Ketama in PHP, and even so that at least from what access was. <br>  This is not about PHP.  In terms of access.  Well, from PHP too. <br><br>  Well, let's get started. <br>  What we have. <br>  Inet, Google ... <br>  ‚Ä¶ everything :( <br>  Ahh, I almost forgot.  The most important thing.  The ceiling, so it was stupid to stare. <br><br>  So google. <br>  There is no ketama in PHP.  And where is that. <br>  Gee, on last.fm. <br>  <a href="http://www.lastfm.ru/user/RJ/journal/2007/04/10/rz_libketama_-_a_consistent_hashing_algo_for_memcache_clients">www.lastfm.ru/user/RJ/journal/2007/04/10/rz_libketama_-_a_consistent_hashing_algo_for_memcache_clients</a> <br>  Only after April 10, 2007, version 0.1.1 has not been updated by anyone, and the functionality is somewhat scanty.  On danga.  com already gets'y, cas'y, etc.  crap full.  Can it be possible, but that's just to figure it out. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Google further ... <br>  <a href="http://tangent.org/">tangent.org</a> <br><br>  What we have. <br>  Memcached Functions for MySQL <br>  libmemcached 0.23 <br><br>  <b>WOW !!!!</b> <br>  Clients using the library: <br>  Ruby: <a href="http://github.com/fauna/memcached/tree/master">github.com/fauna/memcached/tree/master</a> <br>  Perl: <a href="http://code.google.com/p/perl-libmemcached/">code.google.com/p/perl-libmemcached</a> <br>  Python: <a href="http://code.google.com/p/python-libmemcached/">code.google.com/p/python-libmemcached</a> <br>  PHP: (In Japanese) <a href="http://labs.gree.jp/Top/OpenSource/libmemcached.html">labs.gree.jp/Top/OpenSource/libmemcached.html</a> <br><br>  We go there where PHP. <br>  GUARD!!!  Shalashiki. <br>  Damn and version 0.1.0.  But fresh, from 09/18/2008.  In short, glitches in it have not yet been fixed, because no one had time to look for them. <br>  ‚Ä¶ everything. <br>  There is nothing more. <br><br>  Well, we will try. <br>  Probably it is better not to start with slut. <br>  Although I have a bourgeois whole vocabulary: hi, yes, no, problem, thank and everything. <br>  ... well, not all of course, there is still a fuck, but he will not help me. <br>  In Japanese it is shorter. <br><br>  I put libmemcached and Memcached Functions for MySQL on the database server.  On the web server libmemcached. <br>  Raise four memcached daemons.  One on the web server, three on the database server.  Why?  And FIG knows, it happened. <br>  I install functions. <br><br>  Hmm, the list is impressive. <br>  memc_add <br>  memc_add_by_key <br>  memc_servers_set <br>  memc_server_count <br>  memc_set <br>  memc_set_by_key <br>  memc_cas <br>  memc_cas_by_key <br>  memc_get <br>  memc_get_by_key <br>  memc_delete <br>  memc_delete_by_key <br>  memc_append <br>  memc_append_by_key <br>  memc_prepend <br>  memc_prepend_by_key <br>  memc_increment <br>  memc_decrement <br>  memc_replace <br>  memc_replace_by_key <br>  memc_servers_behavior_set <br>  memc_udf_version <br>  memc_list_behaviors <br>  memc_stats <br>  memc_stat_get_keys <br>  memc_stat_get_value <br><br>  Not understood.  If there is a cas?  Where is gets  What the hell I gave up cas without gets'a !!! <br>  Okay, we will remember them.  Probably. <br><br>  We define server <br> <code>SELECT memc_servers_set('192.168.0.10:11211, 192.168.0.11:11211, 192.168.0.11:11212, 192.168.0.11:11213);</code> <br> <br>  We shove a cache of a dozen keys <br> <code>SELECT memc_set('key1', 'val1'); <br> ‚Ä¶ <br> SELECT memc_set('key10', 'val10');</code> <br> <br>  We take them from the cache <br> <code>SELECT memc_get('key1'); <br> ‚Ä¶ <br> SELECT memc_get('key10');</code> <br> <br>  It seems normal, gives what they put. <br><br>  Now we bring down one memcached daemon.  As expected, the two keys are covered.  We again put in the cache 10 of the same keys. <br>  FIG you.  Those missing two never showed up.  Ketama and does not smell.  Well, nothing, readme read me not zapadlo. <br><br>  In Memcached Functions for MySQL, I did not find anything clever.  Let's go to <a href="http://tangent.org/">tangent.org</a> . <br>  Damn, how everything is running. <br><br>  Yeah, that's about it. <br>  <a href="http://docs.tangent.org/libmemcached/memcached_behavior.html">docs.tangent.org/libmemcached/memcached_behavior.html</a> <br>  According to translate.ru behavior this behavior. <br>  By default MEMCACHED_BEHAVIOR_DISTRIBUTION costs MEMCACHED_DISTRIBUTION_MODULA, and we need MEMCACHED_DISTRIBUTION_CONSISTENT, and MEMCACHED_BEHAVIOR_HASH to be MEMCACHED_HASH_KETAMA. <br><br>  And memcached_behavior_set () does that.  In MySQL, this is supposed to be memc_servers_behavior_set. <br>  Brrr, stop.  And what is this in the dock memcached_behavior.pod <br><br>  = item MEMCACHED_BEHAVIOR_DISTRIBUTION <br>  Using this website you can enable values. <br>  The default method is MEMCACHED_DISTRIBUTION_MODULA.  You can enable <br>  consistent hashing by setting MEMCACHED_DISTRIBUTION_CONSISTENT. <br>  Consistent hashing delivers better distribution <br>  added.  Currently <br>  MEMCACHED_DISTRIBUTION_CONSISTENT is an alias for the value <br>  MEMCACHED_DISTRIBUTION_CONSISTENT_KETAMA. <br><br>  = item MEMCACHED_BEHAVIOR_KETAMA <br>  Sets the default distribution to MEMCACHED_DISTRIBUTION_CONSISTENT_KETAMA <br>  and the hash to MEMCACHED_HASH_MD5. <br><br>  Something porridge in my head begins. <br>  Yeah, I probably understand, you need to do MEMCACHED_BEHAVIOR_KETAMA ... <br>  Like this? <br>  Let's go on reading.  It seems stupidly need everything.  More on bourgeois understand byyyy. <br><br>  It looks like it <br>  If you want to make a difference, it‚Äôs worth <br>  So you need MEMCACHED_BEHAVIOR_KETAMA set 1. <br><br>  Well, let's try. <br> <code>SELECT memc_servers_behavior_set ('MEMCACHED_BEHAVIOR_KETAMA', 1);</code> <br> <br>  Mdaaa.  Kirdyk full. <br> <code>mysql&gt;SELECT memc_servers_behavior_set('MEMCACHED_BEHAVIOR_KETAMA', 1); <br> ERROR 2013 (HY000): Lost connection to MySQL server during query <br> mysql&gt;</code> <br>  It is treated only restart MySQL server ... <br><br>  Okay.  We will write to developers <br>  <a href="http://forums.mysql.com/read.php%3F150">forums.mysql.com/read.php?150</a> , 231325,231325 # msg-231325 <br><br>  Quick ... unsubscribed <br>  <a href="http://forums.mysql.com/read.php%3F150">forums.mysql.com/read.php?150</a> , 231325,231359 # msg-231359 <br><br>  And if so <br>  <a href="http://forums.mysql.com/read.php%3F150">forums.mysql.com/read.php?150</a> , 231325,231442 # msg-231442 <br>  That's the same thing. <br><br>  It looks like a long time. <br>  We'll have to look blankly at the ceiling.  Maybe there is something? <br>  For sure.  There is.  Only here some thoughts are not clever, but dirty. <br>  If from where something is taken is not what I need.  So somewhere it is put there.  You just need to find it somewhere and put there what I need. <br><br>  Oh damn.  Climb to the source.  And they are on it.  And I only know the name of C.  In the sense that the language is so called. <br>  Anyway.  There is nothing to do, we will look for familiar words. <br>  In MySQL, the library is probably not worth it, it is so, laying.  We climb into libmemcached itself. <br><br>  Yeah, that's it.  In memcached.c.  line 29 <br>  ptr-&gt; distribution = MEMCACHED_DISTRIBUTION_MODULA; <br>  whole two familiar words. <br><br>  And the construction of the name is promising: memcached_st * memcached_create (memcached_st * ptr). <br>  Now we will try to understand who memcached_st is. <br>  Probably understandable.  According to libmemcached.pod, if translate.ru correctly explained everything to me, this is the very place where it is not what I need. <br>  Let's go again on <a href="http://tangent.org/">tangent.org</a> .  Konfy is not there, but there is mailing worm <a href="http://lists.tangent.org/mailman/listinfo/libmemcached">lists.tangent.org/mailman/listinfo/libmemcached</a> .  There is not much of that.  Stupidly look for familiar words. <br><br>  There is something. <br>  <a href="http://lists.tangent.org/pipermail/libmemcached/2008-September/000434.html">lists.tangent.org/pipermail/libmemcached/2008-September/000434.html</a> <br>  If you understand correctly, you need MEMCACHED_BEHAVIOR_SERVER_FAILURE_LIMIT to do some set.  They write 10, I will try 3. <br><br>  <a href="http://lists.tangent.org/pipermail/libmemcached/2008-August/000429.html">lists.tangent.org/pipermail/libmemcached/2008-August/000429.html</a> <br>  Well, we'll do the same. <br><br>  So.  Try to correct the source.  In the sense of putting what we need. <br><br>  Instead of ptr-&gt; distribution = MEMCACHED_DISTRIBUTION_MODULA; <br>  Write ptr-&gt; distribution = MEMCACHED_DISTRIBUTION_CONSISTENT_KETAMA; <br>  Wow.  My first line in life is 0.5 C. <br><br>  Instead of ptr-&gt; retry_timeout = 0; <br>  Write ptr-&gt; retry_timeout = 60; <br><br>  Yyyyyyyyy.  Instead write about MEMCACHED_BEHAVIOR_SERVER_FAILURE_LIMIT? <br>  Again, we stupidly look at the ceiling. <br><br>  And what to watch that.  Search for SERVER_FAILURE_LIMIT in source code. <br>  There is.  In memcached_behavior.c.  Page 166 is called ptr-&gt; server_failure_limit. <br>  Add by analogy with the rest <br>  ptr-&gt; server_failure_limit = 3; <br>  Maybe a ride.  In principle, if anything - the server will fall cancer.  So also put it. <br><br>  That's what happened <br><br> <code>memcached_st *memcached_create(memcached_st *ptr) <br> { <br> memcached_result_st *result_ptr; <br> <br> if (ptr == NULL) <br> { <br> ptr= (memcached_st *)malloc(sizeof(memcached_st)); <br> <br> if (!ptr) <br> return NULL; /* MEMCACHED_MEMORY_ALLOCATION_FAILURE */ <br> <br> memset(ptr, 0, sizeof(memcached_st)); <br> ptr-&gt;is_allocated= MEMCACHED_ALLOCATED; <br> } <br> else <br> { <br> memset(ptr, 0, sizeof(memcached_st)); <br> } <br> result_ptr= memcached_result_create(ptr, &amp;ptr-&gt;result); <br> WATCHPOINT_ASSERT(result_ptr); <br> ptr-&gt;poll_timeout= MEMCACHED_DEFAULT_TIMEOUT; <br> ptr-&gt;connect_timeout= MEMCACHED_DEFAULT_TIMEOUT; <br> ptr-&gt;retry_timeout= 60; <br> ptr-&gt;distribution= MEMCACHED_DISTRIBUTION_CONSISTENT_KETAMA; <br> ptr-&gt;server_failure_limit= 3; <br> <br> return ptr; <br> } <br></code> <br>  Everything.  Recompile and forward.  We start onany ... well, you understand, to iterations. <br><br>  We define server <br> <code>SELECT memc_servers_set('192.168.0.10:11211, 192.168.0.11:11211, 192.168.0.11:11212, 192.168.0.11:11213);</code> <br> <br>  We shove a cache of a dozen keys <br> <code>SELECT memc_set('key1', 'val1'); <br> ‚Ä¶ <br> SELECT memc_set('key10', 'val10');</code> <br> <br>  We take them from the cache <br> <code>SELECT memc_get('key1'); <br> ‚Ä¶ <br> SELECT memc_get('key10');</code> <br> <br>  It seems normal, gives what they put. <br><br>  We bring down one daemon memcached. <br>  Not understood.  What the heck.  Why are they ALL alive?  This is about the data that I put in the cache. <br><br>  Okay.  Valim second. <br>  Well, we did not agree.  They are all alive. <br><br>  Well, if the third. <br>  Damn, all alive. <br><br>  Well, we are so easy not to take.  There is no reception against scrap.  Valim of the last fourth daemon memcached. <br>  That is the same.  Live left. <br>  We begin to kill, lift, save in, get out of ... <br>  ... shorter iterations to do. <br>  I CAN'T KILL !!! <br><br>  Hmm.  Works.  Even more than that. <br><br>  Well no.  We are not so easy to take. <br>  Everything is KILLED !!! <br>  Left alive one node.  In the quiet raised the second.  Not arranging any calls to memcached, I dropped the first one. <br>  All did not survive.  Know our who you want cancer put. <br><br>  Uff.  What am I talking about? <br>  Actually about PHP. <br><br>  Well, let's go to the hut <a href="http://labs.gree.jp/Top/OpenSource/libmemcached.html">labs.gree.jp/Top/OpenSource/libmemcached.html</a> <br><br>  So, thank God, the source code is not in a hut. <br>  <a href="http://github.com/kajidai/php-libmemcached/tree/master">github.com/kajidai/php-libmemcached/tree/master</a> <br><br>  We screw on. <br>  <a href="http://labs.gree.jp/Top/OpenSource/libmemcached/Document.html">labs.gree.jp/Top/OpenSource/libmemcached/Document.html</a> <br><br>  We try <br><br> <code>&lt;?php <br> $memcached = new Memcached(); <br> $memcached-&gt;addserver('192.168.0.10', 11211); <br> $memcached-&gt;addserver('192.168.0.11', 11211); <br> $memcached-&gt;addserver('192.168.0.11', 11212); <br> $memcached-&gt;addserver('192.168.0.11', 11213); <br> $memcached-&gt;set('key1', 'val1'); <br> $ret = $memcached-&gt;get('key1'); <br> Echo $ret. ‚Äú&lt;br&gt;‚Äù; <br> ‚Ä¶</code> <br> <br>  It works bastard ... <br>  Together with MySQL works. <br>  Correctly the data work in a pair. <br>  Valim, we lift, we write, we read - everything is correct. <br><br>  By the way.  On the webserver, a file of libmemcached is screwed. <br><br>  And what about the functionality we have here? <br><br>  Not bad <br>  memcached_ctor <br>  memcached_server_add <br>  memcached_add <br>  memcached_add_by_key <br>  memcached_append <br>  memcached_append_by_key <br>  memcached_behavior_get <br>  memcached_behavior_set <br>  memcached_cas <br>  memcached_cas_by_key <br>  memcached_delete <br>  memcached_delete_by_key <br>  memcached_get <br>  memcached_get_by_key <br>  memcached_set <br>  memcached_set_by_key <br>  memcached_increment <br>  memcached_decrement <br>  memcached_prepend <br>  memcached_prepend_by_key <br>  memcached_replace <br>  memcached_replace_by_key <br>  memcached_server_list <br>  memcached_mget <br>  memcached_fetch <br>  memcached_server_list_append <br>  memcached_server_push <br><br>  gets'a no either. <br><br>  And what about the glitches ... <br>  And FIG knows. <br>  To find out.  Well, in fact, do not write the same author in my Russian English to Japan.  After all, he will answer me in his Japanese English. <br>  So the war will begin. <br><br>  Okay, let's get into the source.  After all, I have already written 2.5 lines in total in my life. <br><br>  Damn, it's all just ... <br>  Ahhh, drove in.  He simply wrote a call wrapper for broadcast calls.  Damn and nakosyachit then probably there is nowhere special. <br><br>  Well. <br>  Let's sum up. <br><br>  First of all.  I wrote my first 2.5 lines in C. <br>  Secondly.  I now have ketama in PHP. <br>  Thirdly.  Fuck this cache so easy to fall down. <br>  Fourth.  Fucking from what, normal access to the data in memcached, even from C, at least from Perl, at least from PHP with MySQL.  One lays, do not care where and who the other reads correctly. <br><br>  Ps.  Hats off to Brian Aker <a href="http://brian.krow.net/">brian.krow.net</a> </div><p>Source: <a href="https://habr.com/ru/post/43156/">https://habr.com/ru/post/43156/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../431546/index.html">Why do we say OK?</a></li>
<li><a href="../431548/index.html">Solar Dozor - what is behind the stars?</a></li>
<li><a href="../431550/index.html">Injection Molded Films (IMD): How It Works</a></li>
<li><a href="../431554/index.html">Facebook counter from old electric meter</a></li>
<li><a href="../431556/index.html">Sidenis about working with insurance corporations, agile coaching and prohibited technologies</a></li>
<li><a href="../431560/index.html">Access to SS7 signaling networks via radio subsystem - now it is possible</a></li>
<li><a href="../431562/index.html">How to taxi with legacy code when the project was needed for yesterday</a></li>
<li><a href="../431564/index.html">The greatest mistake in the history of physics</a></li>
<li><a href="../431566/index.html">MEMS accelerometers and gyroscopes - we understand the specification</a></li>
<li><a href="../431568/index.html">Fintech Digest: payment by phone number, ATMs are attacking again, institutionalization of the cryptosphere</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>