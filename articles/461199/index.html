<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to use PAM-modules for local authentication in Linux using GOST-2012 keys on Rutoken</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Simple passwords do not protect, and complex passwords cannot be remembered. Therefore, they are so often found on a sticker under the keyboard or on ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to use PAM-modules for local authentication in Linux using GOST-2012 keys on Rutoken</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/em/xk/dv/emxkdvyl4drekv2we2jbgk0e7no.jpeg"><br><br>  Simple passwords do not protect, and complex passwords cannot be remembered.  Therefore, they are so often found on a sticker under the keyboard or on the monitor.  In order for passwords to remain in the heads of ‚Äúforgetful‚Äù users and the reliability of protection not to be lost, there is two-factor authentication (2FA). <a name="habracut"></a><br><br>  Due to the combination of factors of ownership of the device and knowledge of its PIN code, the PIN code itself can be simpler and easier to remember.  Deficiencies in the length or randomness of the PIN code are compensated for by the requirement of physical ownership and restrictions on the search for the PIN code. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In addition, in state institutions it happens that they want everything to work according to GOST.  This option 2FA to enter Linux and will be discussed.  I'll start from afar. <br><br><h1>  PAM modules </h1><br>  Pluggable Authentication Modules (PAMs) are modules with a standard API and implementations of various authentication mechanisms in applications. <br>  All utilities and applications that can work with PAM pick them up and can use them to authenticate the user. <br>  In practice, this works something like this: the login command turns to PAM, which performs all the necessary checks using the modules specified in the configuration file and returns the result back to the login command. <br><br><h2>  librtpam </h2><br>  The module developed by the Active company adds two-factor authentication of users by smart cards or USB tokens using asymmetric keys according to the latest standards of domestic cryptography. <br><br>  Consider the principle of its work: <br><ul><li>  the token stores the user's certificate and its private key; </li><li>  The certificate is saved in the user's home directory as trusted. </li></ul><br><br>  The authentication process is as follows: <br><ol><li>  Rutoken searches for the user's personal certificate. </li><li>  The token PIN is requested. </li><li>  The random data is signed on a private key directly in the Rutoken chip. </li><li>  The received signature is verified using the public key from the user certificate. </li><li>  The module returns the result of the signature verification to the calling application. </li></ol><br><br>  You can authenticate using the keys GOST R 34.10-2012 (length 256 or 512 bits) or outdated GOST R 34.10-2001. <br><br>  There is no need to worry about the security of keys - they are generated directly in Rutoken and never leave his memory during cryptographic operations. <br><br><img src="https://habrastorage.org/webt/t7/zy/aj/t7zyajv_ajx2gbcbk9arxuwocke.jpeg"><br><br>  Rutoken EDS 2.0 is certified by the FSB and FSTEC according to NDV 4, therefore it can be used in information systems that process confidential information. <br><br><h2>  Practical use </h2><br>  Almost any modern Linux is suitable, for example, we will use xUbuntu 18.10. <br><h3>  1) Install the necessary packages </h3><br> <code>sudo apt-get install libccid pcscd opensc</code> <br>  If you want to add a desktop lock with a screensaver, additionally install the <code>libpam-pkcs11</code> package. <br><br><h3>  2) Add a PAM module with support for GOST </h3><br>  Download the library from <a href="https://download.rutoken.ru/Rutoken/PAM/">https://download.rutoken.ru/Rutoken/PAM/</a> <br>  Copy the contents of the PAM folder librtpam.so.1.0.0 to the system folder <br>  <code>/usr/lib/</code> or <code>/usr/lib/x86_64-linux-gnu/</code> or <code>/usr/lib64</code> <br><br><h3>  3) Install the package with librtpkcs11ecp.so </h3><br>  Download and install the DEB or RPM package from the link: <a href="https://www.rutoken.ru/support/download/pkcs/">https://www.rutoken.ru/support/download/pkcs/</a> <br><br><h3>  4) We verify that Rutoken EDS 2.0 works in the system </h3><br>  In the terminal, execute <br> <code>$ pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -T</code> <br>  If you see the <code>Rutoken ECP &lt;no label&gt;</code> , then everything is fine. <br><br><h3>  5) Read the certificate </h3><br>  Check that the device has a certificate <br> <code>$ pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -O</code> <br>  If after the line: <br> <code>Using slot 0 with a present token (0x0)</code> <br> <ul><li>  <b>If information</b> about keys and certificates <b>is displayed</b> , then you need to read the certificate and save it to disk.  To do this, run the following command, where instead of {id} you need to substitute the ID certificate that you saw in the output of the previous command: <br> <code>$ pkcs11-tool --module /usr/lib/librtpkcs11ecp.so -r -y cert --id {id} --output-file cert.crt</code> <br>  If the cert.crt file is created, go to step 6). </li><li>  <b>there is nothing</b> , then the device is empty.  Contact your administrator or create the keys and certificate yourself by following the next step. </li></ul><br><br><h4>  5.1) Create a test certificate </h4><br><blockquote>  Attention!  The described methods for creating keys and certificates are suitable for testing and are not intended for use in combat mode.  To do this, you need to use keys and certificates issued by a trusted certification authority of your organization or an accredited certification authority. <br>  The PAM module is designed to protect local computers and involves work in small organizations.  Since there are few users, the Administrator can manually monitor the revocation of certificates and manually block accounts, as well as the validity period of certificates.  The PAM module is not yet able to verify certificates by CRL and build trust chains. </blockquote><br><br><h4>  Easy way (via browser) </h4><br>  To obtain a test certificate, use the <a href="https://ra.rutoken.ru/">Rootoken Registration Center web service</a> .  The process will take no more than 5 minutes. <br><br><h4>  Geek path (via console and possibly compiler) </h4><br>  <b>Check OpenSC Version</b> <br> <code>$ opensc-tool --version</code> <br>  If the version is less than 0.20, then upgrade or collect <a href="https://github.com/AktivCo/OpenSC/tree/gostr3410-2012/">the pkcs11-tool branch with GOST 2012 support</a> from our GitHub (at the time of this article release 0.20 has not yet been released) or from the master branch of the main OpenSC project no later than the <a href="https://github.com/OpenSC/OpenSC/tree/8cf1e6f769b36bdcadc3958574305b90e88c816d">8cf1e6f commit</a> <br><br>  We generate a key pair with parameters: <br> <code>--key-type: GOSTR3410-2012-512: (-2012 512  c  ), GOSTR3410-2012-256:A (-2012 256    A)</code> <br> <br>  <code>--id:</code> object identifier (CKA_ID) as double-digit character numbers in hex from the ASCII table.  Use only ASCII codes for printed characters, as  id will need to pass OpenSSL as a string.  For example, ASCII codes ‚Äú3132‚Äù correspond to the string ‚Äú12‚Äù.  <b>For convenience, you can use the <a href="https://www.rapidtables.com/convert/number/ascii-to-hex.html">online service for converting strings to ASCII codes</a></b> . <br><br> <code>$ ./pkcs11-tool --module /usr/lib/librtpkcs11ecp.so --keypairgen --key-type GOSTR3410-2012-512:A -l --id 3132</code> <br> <br>  Next we will create a certificate.  Two ways will be described below: the first through the CA (we will use test CAs), the second - self-signed.  To do this, you must first install and configure OpenSSL version 1.1 or later to work with Rutoken through a special rtengine module using the <a href="https://dev.rutoken.ru/display/PUB/%25D0%25A3%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25BE%25D0%25B2%25D0%25BA%25D0%25B0%2B%25D0%25B8%2B%25D0%25BD%25D0%25B0%25D1%2581%25D1%2582%25D1%2580%25D0%25BE%25D0%25B9%25D0%25BA%25D0%25B0%2BOpenSSL">Install and Configure OpenSSL</a> manual. <br>  For example: for '- <code>-id 3132</code> ' in OpenSSL you need to specify " <code>pkcs11:id=12</code> ". <br><br>  You can use the services of a test CA, of which there are many, for example, <a href="https://www.cryptopro.ru/solutions/test-ca">here</a> , <a href="http://testcert.infotecs.ru/">here</a> and <a href="http://soft.lissi.ru/services/test_ca/">here</a> , for this we will create a certificate request <br><br>  Another option is to succumb to laziness and create a self-signed <br> <code>$ openssl req -utf8 <b>-new</b> -keyform engine -key "pkcs11:id=12" -engine rtengine -out req.csr</code> <br> <br>  Download the certificate to the device <br> <code>$ openssl req -utf8 <b>-x509</b> -keyform engine -key "pkcs11:id=12" -engine rtengine -out cert.cer</code> <br> <br><h3>  6) Register the certificate in the system </h3><br>  Make sure your certificate looks like a base64 file: <br><br><img src="https://habrastorage.org/webt/ri/mh/cu/rimhcu-wkts8cx7hyqqp_qhmrco.png"><br><br>  If your certificate looks like this: <br><br><img src="https://habrastorage.org/webt/tg/8b/so/tg8bsoyf7it4iinbhotb2ydbvka.png"><br><br>  then you need to convert the certificate from the DER format to the PEM format (base64) <br><br> <code>$ openssl x509 -in cert.crt -out cert.pem -inform DER -outform PEM</code> <br>  Again we check that now everything is in order. <br><br>  Add a certificate to the list of trusted certificates <br> <code>$ mkdir ~/.eid <br> $ chmod 0755 ~/.eid <br> $ cat cert.pem &gt;&gt; ~/.eid/authorized_certificates <br> $ chmod 0644 ~/.eid/authorized_certificates</code> <br>  The last line protects the list of trusted certificates from accidental or intentional changes by other users.  This eliminates the situation when someone adds their certificate here and can log in on your behalf. <br><br><h3>  7) Configure authentication </h3><br>  The configuration of our PAM module is completely standard and done just like the settings of other modules.  We create in the file <code>/usr/share/pam-configs/rutoken-gost-pam</code> containing the full name of the module, whether it is enabled by default, module priority and authentication parameters. <br>  In the authentication parameters there are requirements for the success of the operation: <br><ul><li>  required: such modules should return a positive response.  If the result of the module call contains a negative answer, this will lead to an authentication error.  The request will be reset, but the rest of the modules will be called. </li><li>  requisite (required): similar to required, but immediately leads to authentication failure and ignores the rest of the modules. </li><li>  sufficient: if in front of such a module none of the required or sufficient modules returned a negative result, the module will return a positive answer.  The remaining modules will be ignored. </li><li>  optional (optional): if there are no required modules in the stack and none of the sufficient modules returned a positive result, then at least one of the optional modules should return a positive answer. </li></ul><br>  The full contents of the file <code>/usr/share/pam-configs/rutoken-gost-pam</code> : <br> <code>Name: Rutoken PAM GOST <br> Default: yes <br> Priority: 800 <br> Auth-Type: Primary <br> Auth: sufficient /usr/lib/librtpam.so.1.0.0 /usr/lib/librtpkcs11ecp.so</code> <br> <br><img src="https://habrastorage.org/webt/x4/s8/lm/x4s8lmf9wad0qson9-cdveilens.png"><br><br>  save the file, then execute <br> <code>$ sudo pam-auth-update</code> <br>  in the window that appears, put an asterisk near <b>Rutoken PAM GOST</b> and click <b>OK</b> <br><br><img src="https://habrastorage.org/webt/i-/pk/u-/i-pku-qe0vc8gu0kh1kmgcyzye0.png"><br><br><h3>  8) Check the setting </h3><br>  To understand that everything is configured, but not to lose the ability to log in, enter the command <br> <code>$ sudo login</code> <br>  Enter your username.  Everything is configured correctly if the system requires a device PIN. <br><br><img src="https://habrastorage.org/webt/3n/mv/-q/3nmv-q20lo_mhv4c2csju_bx-qq.png"><br><br><h3>  9) Configure the computer lock when extracting the token </h3><br>  The <code>libpam-pkcs11</code> package includes the <code>pkcs11_eventmgr,</code> utility <code>pkcs11_eventmgr,</code> which allows you to perform various actions when PKCS # 11 events occur. <br>  To configure <code>pkcs11_eventmgr</code> use the configuration file: <code>/etc/pam_pkcs11/pkcs11_eventmgr.conf</code> <br>  <i>For various Linux distributions, the command that causes the account to be locked when removing smart cards or tokens will be different.</i>  <i>See <code>event card_remove</code> .</i> <br>  An example configuration file is presented below: <br><br><pre> <code class="xml hljs">pkcs11_eventmgr { #    daemon = true; #    debug = false; #     polling_time = 1; #  -    # - 0 expire_time = 0; #  pkcs11      pkcs11_module = usr/lib/librtpkcs11ecp.so; #    #  : event card_insert { #     (  ) on_error = ignore ; action = "/bin/false"; } #   event card_remove { on_error = ignore; #     #  GNOME action = "dbus-send --type=method_call --dest=org.gnome.ScreenSaver /org/gnome/ScreenSaver org.gnome.ScreenSaver.Lock"; #  XFCE # action = "xflock4"; #  Astra Linux (FLY) # action = "fly-wmfunc FLYWM_LOCK"; } #     event expire_time { #     (  ) on_error = ignore; action = "/bin/false"; } }</code> </pre> <br><br>  After that, add the <code>pkcs11_eventmgr</code> application to startup.  To do this, edit the .bash_profile file: <br> <code>$ nano /home/&lt;_&gt;/.bash_profile</code> <br>  Add the line pkcs11_eventmgr to the end of the file and reboot. <br><br>  <b>The described steps to configure the operating system can be used as instructions in any modern Linux distribution, including domestic ones.</b> <br><br><img src="https://habrastorage.org/webt/t0/hw/sc/t0hwsc-bgtngftj0stl9d14rdta.png"><br><br><h2>  Conclusion </h2><br>  Linux PCs are becoming more and more popular in Russian government agencies, and setting up reliable two-factor authentication in this OS is not always easy.  We will be happy with this guide to help solve the ‚Äúpassword problem‚Äù and reliably protect access to your PC without spending a lot of time on it. </div><p>Source: <a href="https://habr.com/ru/post/461199/">https://habr.com/ru/post/461199/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../461185/index.html">JsonDiscovery: Changing browsing experience for JSON</a></li>
<li><a href="../461191/index.html">Recordings from summer DIYorDIE Meetup June 16th</a></li>
<li><a href="../461193/index.html">With you FizTech.Science: eliminate cognitive distortion and comprehend the secrets of the mind</a></li>
<li><a href="../461195/index.html">IR interface, Raspberry and LIRC</a></li>
<li><a href="../461197/index.html">Tales about the harsh Russian IT and digitalization victims</a></li>
<li><a href="../4612/index.html">GooYahoo or MicroYahoo? Terry camel time to think about the future</a></li>
<li><a href="../46120/index.html">Facebook Connect. Universal Internet Passport.</a></li>
<li><a href="../461201/index.html">Themes and styles in Android apps</a></li>
<li><a href="../461205/index.html">Best Test Management Systems 2019</a></li>
<li><a href="../461207/index.html">Sysadmins, today is our day</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>