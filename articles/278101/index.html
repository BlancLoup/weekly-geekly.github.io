<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Consul.io Part 2</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part, we examined in detail what problems and tasks the distributed application architecture sets before us. We identified what tools we ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Consul.io Part 2</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="https://habrahabr.ru/post/278085/">first part,</a> we examined in detail what problems and tasks the distributed application architecture sets before us.  We identified what tools we can use to solve these problems and noted the importance of discovery at the initial stage of the project.  And also, Consul chose the main application on the basis of which we will consider the implementation of the discovery service. <br><br><img src="https://habrastorage.org/files/d85/9e3/300/d859e3300f784d428f12c89e2d6d5be2.png"><br><br>  In the final part, we will look at how Consul works with the DNS protocol, analyze the main requests to the HTTP API, see what types of Health Checks we can use and, of course, analyze what K / V storage is for.  And most importantly, we will get closer acquainted with some features in practice. <br><a name="habracut"></a><br><h4>  DNS interface </h4><br>  Consul can respond to queries using the DNS protocol, and you can use any DNS client for queries.  The DNS interface is available for components on the local host on port 8600. In addition to direct requests to Consul, you can register it as a resolver on the system and use it transparently for name resolution, proxying all external requests to the upstream ‚Äúfull‚Äù DNS server and resolving requests to private zone .consul yourself. <br>  In order to implement primitive DNS balancing if there are several services in the directory with the same name and different IP addresses, Consul randomly shuffles the IP addresses in the response. <br>  In addition to a direct request for domain name resolution within a cluster, you can search (lookup).  The search can be performed both for the service (service lookup) and for the cluster node (node ‚Äã‚Äãlookup). <br>  The format of the domain name in a DNS query within the consul-cluster is rigidly defined and cannot be changed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Cluster node </h4><br>  This is a normal DNS query that will return the cluster node's IP address by its name (the node name is set when the agent starts using the - node parameter).  Consider the host name format for a DNS query: <br> <code>[node].node[.datacenter].[domain]</code> <br> <ul><li>  [node] - mandatory part, the name of the node; </li><li>  .node - a pointer to the fact that we are performing a node lookup; </li><li>  [.datacenter] - optional part, data center name (consul ‚Äúout of the box‚Äù can provide discovery for several data centers within one cluster. The default name is dc1. If the data center name is not specified, the current DC will be used. That is, the framework for which the agent is running, to which the request is being executed); </li><li>  . [domain] - mandatory part, private Consul domain of the first level.  <code>.consul</code> to <code>.consul</code> by default. </li></ul><br>  Thus, the domain name for a node with a name, for example, nodeservice, will look like this: <br> <code>nodeservice.node.consul.</code> <br>  As we can see the name of the data center is missing, but the name can also be built like this: <br> <code>nodeservice.node.dc1.consul.</code> <br>  Multiple nodes with the same name within the same DC are not allowed. <br><br><h4>  Service </h4><br>  A request to search for a service by name is executed on all nodes of the cluster.  Unlike the request for resolving a host name, a query for finding a service provides more options.  In addition, in fact, the IP-address of the service (that is, A-records), you can perform a request for SRV-record and find out the ports on which the service is running. <br>  This is what a typical search request for all sites running a service with the name <code>rls</code> looks like: <br><pre> <code class="bash hljs">root@511cdc9dd19b:~<span class="hljs-comment"><span class="hljs-comment"># dig @127.0.0.1 -p 8600 rls.service.consul. ; &lt;&lt;&gt;&gt; DiG 9.9.5-3ubuntu0.7-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 rls.service.consul. ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26143 ;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 0 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;rls.service.consul. IN A ;; ANSWER SECTION: rls.service.consul. 0 IN A 172.17.0.2 rls.service.consul. 0 IN A 172.17.0.3 ;; Query time: 4 msec ;; SERVER: 127.0.0.1#8600(127.0.0.1) ;; WHEN: Thu Feb 18 07:23:00 UTC 2016 ;; MSG SIZE rcvd: 104</span></span></code> </pre><br>  From this answer, you can see that there are two nodes in the cluster that are running a service with the name <code>rls</code> and that the Consul DNS interface returned the IP addresses of all the nodes.  If we repeat the request several times, we will see that the records periodically change places, that is, the first place is not assigned to the first service found.  This is an example of simple DNS balancing, which we talked about above. <br>  If we request the SRV record, the answer will be: <br><br><pre> <code class="bash hljs">root@511cdc9dd19b:/<span class="hljs-comment"><span class="hljs-comment"># dig @127.0.0.1 -p 8600 rls.service.consul. SRV ; &lt;&lt;&gt;&gt; DiG 9.9.5-3ubuntu0.7-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 rls.service.consul. SRV ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 8371 ;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 2 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;rls.service.consul. IN SRV ;; ANSWER SECTION: rls.service.consul. 0 IN SRV 1 1 80 agent-two.node.dc1.consul. rls.service.consul. 0 IN SRV 1 1 80 agent-one.node.dc1.consul. ;; ADDITIONAL SECTION: agent-two.node.dc1.consul. 0 IN A 172.17.0.3 agent-one.node.dc1.consul. 0 IN A 172.17.0.2 ;; Query time: 5 msec ;; SERVER: 127.0.0.1#8600(127.0.0.1) ;; WHEN: Thu Feb 18 07:39:22 UTC 2016 ;; MSG SIZE rcvd: 244</span></span></code> </pre><br>  The <code>ANSWER SECTION</code> lists the domain names of the nodes in the format required by Consul (note the nodes, but not the services!) And the ports on which the requested service is running.  The IP addresses of the nodes (and, respectively, services) are listed in the <code>ADDITIONAL SECTION</code> response. <br><br>  The format of the service name for the DNS query looks like this: <br> <code>[tag.][service].service[.datacenter].[domain]</code> <br> <ul><li>  [tag.] - optional part.  Used to filter the service by tags.  If we have services with the same name but different tags, then adding a tag name will help filter the issue; </li><li>  [service] - mandatory part, the name of the service; </li><li>  .service - a pointer to the fact that we are performing a service lookup; </li><li>  [.datacenter] - optional part, the name of the data center; </li><li>  . [domain] - mandatory part, private Consul domain of the first level. </li></ul><br>  Thus, a service named nginx and having a tag called web can be represented by a domain: <br> <code>web.nginx.service.consul</code> <br> <br><h5>  SRV requests for searching services in accordance with RFC-2782 </h5><br>  In addition to the ‚Äúusual‚Äù construction of a domain name, we can build it under the stricter <a href="https://www.ietf.org/rfc/rfc2782.txt">RFC-2782</a> rules to fulfill the request for an SRV record.  The format of the name looks like this: <br> <code>_service._tag.service[.datacenter].[domain]</code> <br>  The service name and tag are underscore (_) as a prefix.  (In the original RFC, instead of the tag, there should be a protocol name, this is done to prevent collisions upon request). <br>  In the case of using the name in the format of RFC-2782, a service named nginx and having a tag called web will look like this: <br> <code>_web._nginx.service.consul</code> <br> <br>  The answer will be exactly the same as in the case of the ‚Äúsimple‚Äù query: <br><pre> <code class="bash hljs">root@511cdc9dd19b:/<span class="hljs-comment"><span class="hljs-comment"># dig @127.0.0.1 -p 8600 _rls._rails.service.consul. SRV ; &lt;&lt;&gt;&gt; DiG 9.9.5-3ubuntu0.7-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 -p 8600 _rls._rails.service.consul. SRV ; (1 server found) ;; global options: +cmd ;; Got answer: ;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 26932 ;; flags: qr aa rd; QUERY: 1, ANSWER: 2, AUTHORITY: 0, ADDITIONAL: 2 ;; WARNING: recursion requested but not available ;; QUESTION SECTION: ;_rls._rails.service.consul. IN SRV ;; ANSWER SECTION: _rls._rails.service.consul. 0 IN SRV 1 1 80 agent-one.node.dc1.consul. _rls._rails.service.consul. 0 IN SRV 1 1 80 agent-two.node.dc1.consul. ;; ADDITIONAL SECTION: agent-one.node.dc1.consul. 0 IN A 172.17.0.2 agent-two.node.dc1.consul. 0 IN A 172.17.0.3 ;; Query time: 6 msec ;; SERVER: 127.0.0.1#8600(127.0.0.1) ;; WHEN: Thu Feb 18 07:52:59 UTC 2016 ;; MSG SIZE rcvd: 268</span></span></code> </pre><br>  By default, all domain names within Consul have TTL = 0, that is, they are not cached at all.  Need to keep that in mind. <br><br><h4>  HTTP API </h4><br>  The HTTP REST API is the core Clusul cluster management tool and provides a very wide range of capabilities.  The API implements 10 endpoints, each of which provides access to the configuration of a specific Consul functional aspect.  A detailed description of all edpoints is in the <a href="http.html">Consul documentation</a> , and we briefly describe each of them to get an idea of ‚Äã‚Äãthe features of the API: <br><ul><li>  acl - access control; </li><li>  agent - Consul agent management; </li><li>  catalog - management of cluster nodes and services; </li><li>  coordinate - network coordinates; </li><li>  event - user events; </li><li>  health - availability checks; </li><li>  kv - Key / Value storage; </li><li>  query - prepared queries; </li><li>  session - session; </li><li>  status - system status. </li></ul><br>  <i>acl</i> <br>  As the name implies, acl manages access control for Consul services.  We can regulate access to receive and modify data about services, nodes, user events, as well as control access to k / v storage. <br><br>  <i>agent</i> <br>  Manage local agent Consul.  All operations available on this endpoint affect the local agent data.  You can get information about the current state of the agent, its role in the cluster, as well as access to manage local services.  Changes made to local services will be synchronized with all nodes in the cluster. <br><br>  <i>catalog</i> <br>  Manage the global Consul registry.  It focuses on working with sites and services.  As part of this endpoint, you can register and disable services and, in the case of working with services, using this section is more preferable than working through an <code>agent</code> .  Work through the <code>catalog</code> simpler, clearer and contributes to <a href="https://www.consul.io/docs/internals/anti-entropy.html">anti-entropy</a> . <br><br>  <i>coordinate</i> <br>  Consul uses <a href="https://en.wikipedia.org/wiki/Network_tomography">network tomography</a> to calculate network coordinates.  These coordinates are used to build efficient routes within the cluster and many useful functions, such as, for example, finding the nearest node with a given service or switching to the nearest data center in the event of an accident.  The API functions in this section are used only to obtain information about the current state of network coordinates. <br><br>  <i>event</i> <br>  Handling custom events.  Custom events are used to perform any actions within the cluster: for example, to automatically deploy, restart services, run certain scripts or other actions within the orchestration process. <br><br>  <i>health</i> <br>  Check the current status of nodes and services.  This endpoint is used only for reading and returns the current state of nodes and services, as well as lists of checks performed. <br><br>  <i>kv</i> <br>  This endpoint has only one method and is used to manage data in the distributed key / value storage provided by Consul.  The only method in this endpoint is: <br> <code>/v1/kv/[key]</code> <br>  The difference in processing is in the request method.  GET will return the value by key, PUT will save the new value or overwrite the old one, and DELETE will delete the record. <br><br>  <i>query</i> <br>  Prepared queries management.  Such queries allow you to perform complex manipulations on the Consul configuration and can be saved and executed later.  Stored requests are assigned a unique ID.  With it, the request can be executed at any time without the need for re-preparation. <br><br>  <i>session</i> <br>  Session mechanism in Consul is used to build distributed locks.  Sessions are the connecting layer between the nodes performed by the checks and the k / v storage.  Each session has a name and it can be stored in the repository.  The name is used to implement locks in the framework of sequential actions with nodes and services in a competitive mode.  The mechanism of the session is described in the <a href="https://www.consul.io/docs/internals/sessions.html">documentation of Consul</a> . <br><br>  <i>status</i> <br>  This endpoint is used to obtain cluster status information.  Here you can find out the current leader and get information about all the cluster members. <br><br><h4>  Health checks </h4><br>  Earlier we talked about load balancing using DNS, and now we will consider a mechanism for checking the status of nodes and services.  Health check is a periodically performed operation, the results of which can determine the state of the system being checked.  In fact, this is automatic monitoring, which maintains the state of the cluster in a healthy state, cleans up inoperative nodes and services and returns them to work upon recovery.  Consul supports several types of checks: <br><ul><li>  Script check - launch a specific script on a specific node with a specified frequency.  Depending on the exit code (any non-zero code will mean that the test failed) turns the site or service on or off. </li><li>  HTTP Check - a check that tries to load the specified URL and, depending on the response code, turns on or off the object being scanned (any 2xx - everything is fine, code 429 Too Many Requests generates a warning, other codes indicate an error). </li><li>  TCP Check - a check that tries to establish a tcp connection at a specified interval to the specified address and port.  Failure to establish a connection means that the test failed. </li><li>  TTL Check - a check that should be periodically updated via the HTTP API.  Its essence is that if a service has not updated this check within a certain interval, then it is marked as disabled.  This is a passive check, that is, the service itself must periodically report that it works.  If a report is not received within the specified interval, then the check is considered to be not passed. </li><li>  Docker Check - check for services running in docker containers.  Consul, using the Docker Exec API, can execute a script inside the container.  The result of the check will depend on the exit code, any non-zero ‚Äúfail‚Äù check. </li></ul><br><h4>  K / V storage </h4><br>  The storage provided by Consul is a distributed key-value database and can be used to store any data available to any member of the cluster (in accordance with the ACL rules, of course).  Services can store data in this repository that is necessary for other cluster members.  These can be the values ‚Äã‚Äãof configuration options, the results of any calculations or, as we indicated above, k / v storage can be used to implement distributed locks using the session mechanism.  Using k / v-storage will allow us to make the cluster more efficient and reduce the percentage of manual intervention.  Services can adjust their state depending on the information in the storage, guaranteed by the cluster.  Please note: do not save any data related to the business logic of your services in this repository.  The storage provided by Consul is used to store and distribute meta-information about the status of cluster members, and not about the data they process. <br><br><h4>  Conclusion </h4><br>  It is difficult to overestimate the role of the discovery service in the process of building a distributed architecture on large projects.  Consul is great for this role.  The product develops and does not stand still; a lot of useful functionality has been implemented, which is necessary for the smooth maintenance of a system with a large number of components.  In addition, Consul is written in Go and is distributed as a single executable file, which makes the process of updating and supporting it very convenient. </div><p>Source: <a href="https://habr.com/ru/post/278101/">https://habr.com/ru/post/278101/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../278087/index.html">DIY: SQL JOIN in Java</a></li>
<li><a href="../278089/index.html">How does split-testing in Badoo work?</a></li>
<li><a href="../278091/index.html">Funny tabs on MAC OS X or a story about that Tab View</a></li>
<li><a href="../278095/index.html">How board and various other games are balanced - a brief overview of the ways</a></li>
<li><a href="../278099/index.html">The digest of interesting materials for the mobile developer # 142 (February 24-28)</a></li>
<li><a href="../278103/index.html">Integrating Webpack in Visual Studio 2015</a></li>
<li><a href="../278109/index.html">Jade tutorial for beginners</a></li>
<li><a href="../278111/index.html">My "Smart Home" on the PLC and with the web interface. Part 2. Web interface</a></li>
<li><a href="../278115/index.html">BIM technology: an example of practical interdisciplinary interaction</a></li>
<li><a href="../278123/index.html">Symfony how to use FOSRestBundle</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>