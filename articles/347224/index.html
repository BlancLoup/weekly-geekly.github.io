<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PBX in the container. Asterisk 14 + Nginx + Freepbx 14 + srtp on Centos 7 in Proxmox VE 4 lxc container</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In containers, in our time, you can install many interesting systems 
 but under the cut you can find only relatively standard installation instructio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PBX in the container. Asterisk 14 + Nginx + Freepbx 14 + srtp on Centos 7 in Proxmox VE 4 lxc container</h1><div class="post__text post__text-html js-mediator-article">  In containers, in our time, you can install many interesting systems <img src="https://habrastorage.org/webt/kp/rr/95/kprr95ghxl8ejoa4ohu_be5e2fc.jpeg" align="right"><br>  but under the cut you can find only relatively standard installation instructions for asterisk + freepbx.  The boredom will slightly dispel the fact that the versions of all software are ‚Äúlatest stable‚Äù, there is encryption, instead of apache - nginx, and the whole installation under the recently ‚Äúmatured‚Äù lxc.  The output will be quite mobile, compact and modern IP PBX, consuming 200-300 MB of RAM alone <br><a name="habracut"></a><br><br>  <b>0. Before installation</b> <br><br>  Before you begin, take into account that the instruction does not involve installing DAHDI and working with analog lines.  In addition, since the system is not an <a href="https://www.freepbx.org/downloads/freepbx-distro/">officially distributed FreePBX distribution</a> , you will not be able to connect commercial FreePBX modules in the future. <br><blockquote>  At this time we only support commercial modules in the distro.  Yoy <a href="https://community.freepbx.org/t/centos-7-freepbx-v14-and-sysadmin-module/42979/11">. Director of Software Engineering</a> </blockquote>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <b>1. LXC.Proxmox</b> <br><br>  First you need to create a container with Centos.  If you, like me, have proxmox ve - it will be most convenient to do this through a web interface.  Settings "equipment" take the minimum.  Then they can be increased to the needs of: cores: 1 memory: 1024 rootfs: 8G swap: 256, and as the OS template we use centos-7-default_20171212_amd64.tar.xz. <br><br>  If you have such a template is not available for download, run pveam update on the host.  After installing and running the container, I usually immediately put ssh, because  Working with the embedded web console proxmox is not very convenient. <br><br><pre><code class="hljs sql">yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> openssh-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> sshd <span class="hljs-comment"><span class="hljs-comment">--now</span></span></code> </pre> <br>  <b>2. LEMP</b> <br><br>  Repositories and Basic Utilities <br><br><pre> <code class="hljs pgsql">yum -y install epel-<span class="hljs-keyword"><span class="hljs-keyword">release</span></span> rpm -Uvh https://mirror.webtatic.com/yum/el7/webtatic-<span class="hljs-keyword"><span class="hljs-keyword">release</span></span>.rpm yum -y <span class="hljs-keyword"><span class="hljs-keyword">update</span></span></code> </pre> <br>  The choice of webtatic is justified by the further installation of php56w, with which freepbx is guaranteed to work well.  But you can try Remi. <br><br>  We put mariadb, nginx and utility.  The net-tools package is also useful because  in centos7, there is no default ifconfig with which freepbx works. <br><br><pre> <code class="hljs sql">yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> wget tar nano bzip2 unzip curl net-tools make gcc gcc-c++ openssl openssl-devel mariadb-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> mariadb-devel nginx tftp-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> crontabs cronie cronie-anacron sendmail sendmail-cf</code> </pre> <br>  Freepbx does not yet support php7, so we put the recommended 5.6. <br><br><pre> <code class="hljs sql">yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> php56w php56w-pdo php56w-mysql php56w-mbstring php56w-pear php56w-process php56w-<span class="hljs-keyword"><span class="hljs-keyword">xml</span></span> php56w-opcache php56w-ldap php56w-intl php56w-soap php56w-fpm php56w-gd</code> </pre> <br>  We launch mariadb and nginx, we disconnect apache, we rule php.ini.  Otherwise, you will not be able to update the freepbx modules via the web interface. <br><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> mariadb.service systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> mariadb sed -i <span class="hljs-string"><span class="hljs-string">'s/\(^upload_max_filesize = \).*/\120M/'</span></span> /etc/php.ini systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> nginx <span class="hljs-comment"><span class="hljs-comment">--now systemctl disable httpd</span></span></code> </pre> <br>  After that you can run mysql_secure_installation but without setting the root password - this is required by the freepbx installer. <br><br>  Now that we have a working ‚Äúpreset‚Äù of the LEMP server, we can make a backup of the system so that we can roll back or use the backup to prepare another server.  It takes less than a minute, and the full archive will be about 350MB. <br><br>  <b>3. Asterisk.SRTP</b> <br><br>  In principle, we are all ready to install asterisk.  We will install SIP and PJSIP when building via the option --with-pjproject-bundled.  What is missing is srtp to enable support for media encryption.  There is a small plug, because  the asterisk 14 documentation says that srtp needs libsrtp 1.5.4 or higher, libsrtp 2.x is theoretically supported, but almost you need to use 1.5.4 to achieve a stable result.  That is, version 1.4.4 of the repositories will not work, and we need to build it ourselves. <br><br><pre> <code class="hljs ruby">cd /usr/src/ wget <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/cisco</span></span><span class="hljs-regexp"><span class="hljs-regexp">/libsrtp/archive</span></span><span class="hljs-regexp"><span class="hljs-regexp">/v1.5.4.tar.gz tar xvzf v1.5.4.tar.gz cd libsrtp-1.5.4 ./configure</span></span> --libdir=<span class="hljs-regexp"><span class="hljs-regexp">/usr/lib</span></span>64 --enable-openssl make shared_library make install</code> </pre> <br>  Just in case, you can check the library at the destination. <br><br><pre> <code class="hljs perl">ls /usr/lib64 | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> srtp</code> </pre> <br>  and through ldconfig <br><br><pre> <code class="hljs perl">ldconfig -p | <span class="hljs-keyword"><span class="hljs-keyword">grep</span></span> srtp</code> </pre> <br>  Hint!  If you do not specify make shared_library, then by default make compiles the archive library libsrtp.a, and requires an intermediate test run runtest.  If you need libsrtp.a, then download the dictionary for this test in advance. <br><br><pre> <code class="hljs ruby">wget -O /usr/share/dict/words <span class="hljs-symbol"><span class="hljs-symbol">https:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/github.com/cisco</span></span><span class="hljs-regexp"><span class="hljs-regexp">/libsrtp/blob</span></span><span class="hljs-regexp"><span class="hljs-regexp">/master/test</span></span><span class="hljs-regexp"><span class="hljs-regexp">/words.txt</span></span></code> </pre> <br>  Download and deploy Asterisk: <br><br><pre> <code class="hljs ruby">cd /usr/src wget <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/downloads.asterisk.org/pub</span></span><span class="hljs-regexp"><span class="hljs-regexp">/telephony/asterisk</span></span><span class="hljs-regexp"><span class="hljs-regexp">/asterisk-14-current.tar.gz tar xvfz asterisk-14-current.tar.gz cd asterisk-14*/</span></span></code> </pre> <br>  At this stage, you can use the script provided by the developers to check the availability of the necessary packages and install them.  Since we have already installed part of the packages, I recommend performing this test in <code>test</code> mode. <br><br><pre> <code class="hljs bash">./contrib/scripts/install_prereq <span class="hljs-built_in"><span class="hljs-built_in">test</span></span></code> </pre> <br>  From the output of the script, remove mysql-devel, srtp-devel, and replace gmime22-devel with gmime-devel.  At the moment, the lame and jansson packages are fresh in the repositories, so we will also install them from the repositories: <br><br><pre> <code class="hljs sql">yum -y <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> <span class="hljs-keyword"><span class="hljs-keyword">patch</span></span> ncurses-devel <span class="hljs-keyword"><span class="hljs-keyword">uuid</span></span>-devel libuuid-devel jansson-devel lame lame-libs libxml2-devel sqlite-devel automake unixODBC-devel libcurl-devel libogg-devel libvorbis-devel speex-devel spandsp-devel freetds-devel net-snmp-devel iksemel-devel corosynclib-devel newt-devel popt-devel libtool-ltdl-devel lua-devel libsqlite3x-devel radiusclient-ng-devel portaudio-devel neon-devel libical-devel openldap-devel sqlite2-devel bluez-libs-devel jack-audio-<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>-kit-devel gsm-devel libedit-devel pjproject-devel gmime-devel subversion git libxslt-devel python-devel</code> </pre> <br>  Next, load the sources of the sound files and run the asterisk configuration. <br><br><pre> <code class="hljs javascript">./contrib/scripts/get_mp3_source.sh ./configure --libdir=<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>lib64 --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-pjproject-bundled --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-crypto --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-ssl=ssl --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-srtp</code> </pre> <br>  If everything went without errors, then run the configuration menu <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">make</span></span> menuselect</code> </pre> <br>  We include mp3 support, choose the necessary sound file packages in Core Sound Packages, Music On Hold File Packages and Extras Sound Packages.  Also, just in case, we check the presence of the res_srtp item in the Resource Modules.  Is done.  Further: <br><br><pre> <code class="hljs go"><span class="hljs-built_in"><span class="hljs-built_in">make</span></span> &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> install &amp;&amp; <span class="hljs-built_in"><span class="hljs-built_in">make</span></span> config &amp;&amp; ldconfig</code> </pre> <br>  Now you can try to run asterisk and check if the srtp module has picked up: <br><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> asterisk systemctl status asterisk rasterisk Asterisk <span class="hljs-number"><span class="hljs-number">14.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span>, Copyright (C) <span class="hljs-number"><span class="hljs-number">1999</span></span> - <span class="hljs-number"><span class="hljs-number">2016</span></span>, Digium, Inc. <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> others. Created <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> Mark Spencer &lt;markster@digium.com&gt; Asterisk comes <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> ABSOLUTELY <span class="hljs-keyword"><span class="hljs-keyword">NO</span></span> WARRANTY; <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> <span class="hljs-string"><span class="hljs-string">'core show warranty'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. This <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> free software, <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> components licensed under the GNU General <span class="hljs-built_in"><span class="hljs-built_in">Public</span></span> License <span class="hljs-keyword"><span class="hljs-keyword">version</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> other licenses; you are welcome <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> redistribute it under certain conditions. <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span> <span class="hljs-string"><span class="hljs-string">'core show license'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. =============================================================== Connected <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> Asterisk <span class="hljs-number"><span class="hljs-number">14.7</span></span><span class="hljs-number"><span class="hljs-number">.5</span></span> currently running <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> pbx4 (pid = <span class="hljs-number"><span class="hljs-number">28020</span></span>) pbx4*CLI&gt;</code> </pre> <br>  Asterisk is working, now we are looking at whether the srtp module is loaded.  In the asterisk console we execute: <br><br><pre> <code class="hljs pgsql">pbx4*CLI&gt; module <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> srtp Module Description Use Count Status Support <span class="hljs-keyword"><span class="hljs-keyword">Level</span></span> res_srtp.so Secure RTP (SRTP) <span class="hljs-number"><span class="hljs-number">0</span></span> Running core <span class="hljs-number"><span class="hljs-number">1</span></span> modules loaded</code> </pre><br>  If the module is not loaded - try to load it: <br><br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">pbx4</span></span>*<span class="hljs-selector-tag"><span class="hljs-selector-tag">CLI</span></span>&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">module</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">load</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">res_srtp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.so</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">Loaded</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">res_srtp</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.so</span></span></code> </pre><br>  If everything went well, we stop the service and disable the asterisk autoload.  In the future, it will run the freepbx service. <br><br><pre> <code class="hljs sql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> asterisk systemctl <span class="hljs-keyword"><span class="hljs-keyword">disable</span></span> asterisk</code> </pre> <br>  <b>4. Freepbx.Nginx</b> <br><br>  We get the user asterisk and give him the rights to directories <br><br><pre> <code class="hljs perl">adduser asterisk -<span class="hljs-keyword"><span class="hljs-keyword">m</span></span> -c <span class="hljs-string"><span class="hljs-string">"Asterisk User"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> asterisk. /var/run/asterisk <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> asterisk. /var/spool/mqueue/ <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R asterisk. /etc/asterisk <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R asterisk. /var/{lib,<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>,spool}/asterisk <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R asterisk. /usr/lib64/asterisk <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R asterisk. /var/www/ <span class="hljs-keyword"><span class="hljs-keyword">chown</span></span> -R asterisk. /var/lib/nginx</code> </pre> <br>  Install nodeJS: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">curl</span></span> -sL https://rpm.nodesource.com/setup_8.x | bash - yum install -y nodejs</code> </pre> <br>  We configure nginx and php-fpm.  To do this, delete all the files in /etc/nginx/conf.d/ and /etc/php-fpm.d/, and create our own instead.  In the example, access by IP of the machine is indicated: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">nano</span></span> /etc/nginx/conf.d/freepbx.conf</code> </pre> <br><pre> <code class="hljs nginx"> <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> <span class="hljs-number"><span class="hljs-number">10.10.0.126</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">120m</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /var/www/html/; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ [^/]\.php(/|$)</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_split_path_info</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^(.+?\.php)(/.*)$</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (!-f <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">return</span></span> <span class="hljs-number"><span class="hljs-number">404</span></span>; } <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_pass</span></span> unix:/var/run/php-fpm.sock; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_index</span></span> index.php; <span class="hljs-attribute"><span class="hljs-attribute">include</span></span> fastcgi_params; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SCRIPT_FILENAME <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_script_name</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> PATH_INFO <span class="hljs-variable"><span class="hljs-variable">$fastcgi_path_info</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> PATH_TRANSLATED <span class="hljs-variable"><span class="hljs-variable">$document_root</span></span><span class="hljs-variable"><span class="hljs-variable">$fastcgi_path_info</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">fastcgi_param</span></span> SERVER_NAME <span class="hljs-variable"><span class="hljs-variable">$host</span></span>; } }</code> </pre><br><pre> <code class="hljs nginx"> <span class="hljs-attribute"><span class="hljs-attribute">nano</span></span> /etc/php-fpm.d/freepbx.conf</code> </pre> <br><pre> <code class="hljs pgsql">[freepbx] <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = /var/run/php-fpm.sock <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>.owner = asterisk <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = asterisk <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span>.mode = <span class="hljs-number"><span class="hljs-number">0666</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> = asterisk <span class="hljs-keyword"><span class="hljs-keyword">group</span></span> = asterisk pm = dynamic pm.max_children = <span class="hljs-number"><span class="hljs-number">30</span></span> pm.start_servers = <span class="hljs-number"><span class="hljs-number">3</span></span> pm.min_spare_servers = <span class="hljs-number"><span class="hljs-number">3</span></span> pm.max_spare_servers = <span class="hljs-number"><span class="hljs-number">21</span></span> pm.max_requests = <span class="hljs-number"><span class="hljs-number">1000</span></span> php_admin_value[memory_limit] = <span class="hljs-number"><span class="hljs-number">512</span></span>M</code> </pre> <br><br>  Allow autorun php-fpm and restart nginx: <br><br><pre> <code class="hljs pgsql">systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> php-fpm systemctl <span class="hljs-keyword"><span class="hljs-keyword">restart</span></span> nginx</code> </pre><br><br>  Download and install FreePBX: <br><br><pre> <code class="hljs dos"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src wget http://mirror.freepbx.org/modules/packages/freepbx/freepbx-<span class="hljs-number"><span class="hljs-number">14</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-latest.tgz tar xvfz freepbx-<span class="hljs-number"><span class="hljs-number">14</span></span>.<span class="hljs-number"><span class="hljs-number">0</span></span>-latest.tgz <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> freepbx ./start_asterisk <span class="hljs-built_in"><span class="hljs-built_in">start</span></span> ./install -n</code> </pre> <br>  We are checking.  If everything went fine, then we should get to the FreePBX admin panel by the IP address that was specified in /etc/nginx/conf.d/freepbx.conf You can set the admin password / email and see errors, if any. <br><br>  Next, create a systemd unit for autoloading freepbx: <br><br><pre> <code class="hljs pgsql">nano /etc/systemd/<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>/freepbx.service [Unit] Description=FreePBX VoIP <span class="hljs-keyword"><span class="hljs-keyword">Server</span></span> <span class="hljs-keyword"><span class="hljs-keyword">After</span></span>=mariadb.service [Service] <span class="hljs-keyword"><span class="hljs-keyword">Type</span></span>=oneshot RemainAfterExit=yes ExecStart=/usr/sbin/fwconsole <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> -q ExecStop=/usr/sbin/fwconsole stop -q [Install] WantedBy=multi-<span class="hljs-keyword"><span class="hljs-keyword">user</span></span>.target</code> </pre><br>  Stop freepbx, start the service, check: <br><br><pre> <code class="hljs sql">fwconsole <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> systemctl <span class="hljs-keyword"><span class="hljs-keyword">enable</span></span> freepbx <span class="hljs-comment"><span class="hljs-comment">--now</span></span></code> </pre><br><br>  If all is well, congratulations!  Your PBX is ready! <br><br>  Possible errors that I encountered while writing instructions: <br><br><blockquote>  - If there is an error on the web gui that cannot communicate with Asterisk: Check passwords.  /etc/asterisk/manager.conf and /etc/amportal.conf password from manager.conf section [admin] must match the password from amportal.conf <br><br>  - If any of the modules are marked as tampered: Run the <code>fwconsole ma refreshsignatures</code> in the <code>fwconsole ma refreshsignatures</code> , restart the freepbx service and try updating the module online </blockquote><br><br>  In preparing the instructions used materials: <br>  <a href="https://wiki.freepbx.org/display/FOP/Installing%2BFreePBX%2B14%2Bon%2BCentOS%2B7">Installing FreePBX 14 on CentOS 7</a> <br>  <a href="http://wiki.merionet.ru/ip-telephoniya/32/ustanovka-asterisk-14-na-centos-7/">Installing Asterisk 14 on Centos 7</a> <br>  <a href="https://asterisk-pbx.ru/wiki/asterisk/pjsip-tls-srtp">Asterisk TLS SRTP setup for PJSIP</a> . <br><br>  Thank you all for your attention!  I would welcome comments and amendments. <br><br>  Special thanks to <a href="https://habr.com/users/generick/" class="user_link">Generick</a> , <a href="https://habr.com/users/otkachov/" class="user_link">otkachov</a> and <a href="https://habr.com/users/chents/" class="user_link">chents</a> for any inaccuracies found! </div><p>Source: <a href="https://habr.com/ru/post/347224/">https://habr.com/ru/post/347224/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347212/index.html">Configuring squid or how not to buy a paid solution</a></li>
<li><a href="../347216/index.html">The principle of the stream cipher with examples in C #. From One-time pad to stream cipher based on hashf and CTR</a></li>
<li><a href="../347218/index.html">Projection Modeling Technique</a></li>
<li><a href="../347220/index.html">Microchip implantation: myths and reality</a></li>
<li><a href="../347222/index.html">Postgres logging experience</a></li>
<li><a href="../347226/index.html">Cool internship</a></li>
<li><a href="../347230/index.html">Five major trends in the development of the Internet of Things in 2018</a></li>
<li><a href="../347232/index.html">Identify anomalies using user behavior analysis</a></li>
<li><a href="../347234/index.html">Thinking in HTML</a></li>
<li><a href="../347236/index.html">InfoWatch Group of Companies has summed up the year</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>