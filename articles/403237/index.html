<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Adding SDM-220 counter to OpenHab</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Almost a year has passed since my first publication on an electric meter with an RS485 / ModBus interface SDM-220 , then there was a second article on...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Adding SDM-220 counter to OpenHab</h1><div class="post__text post__text-html js-mediator-article">  Almost a year has passed since my <a href="https://geektimes.ru/post/277358/">first publication</a> on an electric meter with an RS485 / ModBus interface <b>SDM-220</b> , then there was a <a href="https://habrahabr.ru/post/309580/">second article</a> on how to collect data from it and process statistics.  This is the third, hopefully the last.  It is about how to integrate the counter with <a href="https://www.openhab.org/">OpenHab</a> .  The result finally suits me completely. <br><br><img src="https://habrastorage.org/files/47d/b1b/9a8/47db1b9a82544d269fa610d403687edb.png"><br><a name="habracut"></a><br>  So, the first attempt to collect statistics from the counter was made using the external cloud service <a href="https://thingspeak.com/">ThingSpeak</a> .  A thin client (mini-computer) with an <b>Ubuntu Server</b> installed on the USB flash drive was used as a local server that polls the meter.  It was the first mistake - the flash drive "died" after 3 months (accident, I thought).  Without making any conclusions, I killed the second flash drive in 2 months (pattern).  In the third version, a usb-pocket with a 2.5 "screw was already used as storage. <br><br>  The ThingSpeak service itself allows some processing, but does not allow sufficient flexibility with data manipulation.  Data per day, for example, was collected as the sum of data for hours.  If some data packet to the server did not arrive or I sent several data during testing, an error appeared.  Thoughts about having to keep dvuhtarifny accounting with reference to the time of day, optimism did not add. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      In general, I decided to learn <b>OpenHab</b> . <br><br><h3>  Task one: get raw data from the meter. </h3><br>  Installation of OpenHab itself is detailed in the <a href="http://docs.openhab.org/installation/linux.html">instructions</a> .  After installation, through the <b>Paper UI ‚Üí Bindings</b> panel you need to install <b>ModBus binding</b> - <i>binding-modbus1 - 1.9.0</i> <br><br>  The Modbus bus is polled via the USB-RS485 adapter, so you need to make sure that the adapter is in the system and add the port access rights to the openhab user: <br><br><pre><code class="bash hljs">lsusb Bus 002 Device 002: ID 0403:6001 Future Technology Devices International, Ltd FT232 Serial (UART) IC ls /dev/ttyUSB* /dev/ttyUSB0 sudo adduser openhab dialout sudo adduser openhab tty</code> </pre> <br>  Then it is recommended to set permissions for Java (this is also described in detail in the OpenHab installation instructions): <br><br><pre> <code class="bash hljs">sudo vi /etc/default/openhab2 EXTRA_JAVA_OPTS=<span class="hljs-string"><span class="hljs-string">"-Dgnu.io.rxtx.SerialPorts=/dev/ttyUSB0"</span></span></code> </pre><br>  After these manipulations, you need to configure the <b>services / modbus.cfg</b> configuration file: <br><br><pre> <code class="hljs pgsql"> sudo vi /etc/openhab2/services/modbus.cfg #   poll=<span class="hljs-number"><span class="hljs-number">30000</span></span> #        ,        .  <span class="hljs-keyword"><span class="hljs-keyword">start</span></span> -  .   <span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>      (<span class="hljs-number"><span class="hljs-number">9600</span></span>,<span class="hljs-number"><span class="hljs-number">8</span></span>,n,<span class="hljs-number"><span class="hljs-number">1</span></span>),        . # - <span class="hljs-number"><span class="hljs-number">0x00</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave1.<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>=/dev/ttyUSB0:<span class="hljs-number"><span class="hljs-number">9600</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:rtu:<span class="hljs-number"><span class="hljs-number">2000</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave1.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave1.start=<span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave1.length=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave1.valuetype=float32 # - <span class="hljs-number"><span class="hljs-number">0x06</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave2.<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>=/dev/ttyUSB0:<span class="hljs-number"><span class="hljs-number">9600</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:rtu:<span class="hljs-number"><span class="hljs-number">2000</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave2.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave2.start=<span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave2.length=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave2.valuetype=float32 #  - <span class="hljs-number"><span class="hljs-number">0x0C</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave3.<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>=/dev/ttyUSB0:<span class="hljs-number"><span class="hljs-number">9600</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:rtu:<span class="hljs-number"><span class="hljs-number">2000</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave3.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave3.start=<span class="hljs-number"><span class="hljs-number">12</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave3.length=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave3.valuetype=float32 #  ( ) - <span class="hljs-number"><span class="hljs-number">0x156</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave4.<span class="hljs-keyword"><span class="hljs-keyword">connection</span></span>=/dev/ttyUSB0:<span class="hljs-number"><span class="hljs-number">9600</span></span>:<span class="hljs-number"><span class="hljs-number">8</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-number"><span class="hljs-number">1</span></span>:rtu:<span class="hljs-number"><span class="hljs-number">2000</span></span>:<span class="hljs-number"><span class="hljs-number">1000</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span>:<span class="hljs-keyword"><span class="hljs-keyword">none</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave4.<span class="hljs-keyword"><span class="hljs-keyword">type</span></span>=<span class="hljs-keyword"><span class="hljs-keyword">input</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave4.start=<span class="hljs-number"><span class="hljs-number">342</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave4.length=<span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-type"><span class="hljs-type">serial</span></span>.slave4.valuetype=float32</code> </pre><br>  Then you need to create the data <b>items</b> in the <b>items / sdm220.items file</b> : <br><br><pre> <code class="hljs objectivec">sudo vi /etc/openhab2/items/sdm220.items <span class="hljs-meta"><span class="hljs-meta">#    Group gSDM220 # ,      , energy -       Number sdm220_voltage </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" [%.1f ]"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;energy&gt;</span></span></span><span class="hljs-meta"> (gSDM220) {modbus=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"slave1:0"</span></span></span><span class="hljs-meta">} Number sdm220_current </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" [%.2f ]"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;energy&gt;</span></span></span><span class="hljs-meta"> (gSDM220) {modbus=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"slave2:0"</span></span></span><span class="hljs-meta">} Number sdm220_actpower </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">" [%.1f ]"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;energy&gt;</span></span></span><span class="hljs-meta"> (gSDM220) {modbus=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"slave3:0"</span></span></span><span class="hljs-meta">} Number sdm220_actcounter </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"  [%.1f *]"</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;energy&gt;</span></span></span><span class="hljs-meta"> (gSDM220) {modbus=</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"slave4:0"</span></span></span><span class="hljs-meta">}</span></span></code> </pre><br>  It remains to add the current readings on the dashboard.  To do this, edit the <b>sitemaps / default.sitemap</b> file: <br><br><pre> <code class="hljs pgsql">sudo vi /etc/openhab2/sitemaps/<span class="hljs-keyword"><span class="hljs-keyword">default</span></span>.sitemap sitemap <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> label="alk0v SmartHome (default sitemap)" { Frame label="" { <span class="hljs-type"><span class="hljs-type">Text</span></span> item=sdm220_voltage <span class="hljs-type"><span class="hljs-type">Text</span></span> item=sdm220_current <span class="hljs-type"><span class="hljs-type">Text</span></span> item=sdm220_actpower <span class="hljs-type"><span class="hljs-type">Text</span></span> item=sdm220_actcounter } }</code> </pre><br>  In principle, this is enough to see the current meter reading: <br><br><img src="https://habrastorage.org/files/2b5/2df/18b/2b52df18bc8e4f5aa2bfdf7e55b56e09.png"><br><br><h3>  Task two: HabPanel setup and visualization of readings </h3><br>  OpenHab supports multiple control panels.  I apparently liked <b>HabPanel the most</b> .  Via <b>Paper UI ‚Üí User Interfaces</b> , <b>we</b> install <b>HabPanel</b> - <i>ui-habpanel - 2.0.0</i> . <br><br>  To draw graphs, you also need to store data somewhere.  OpenHab uses the term <b>Persistence</b> for databases.  I wanted to use the MySQL base, the community discussed a lot of problems with this base, in the end I found <a href="https://community.openhab.org/t/openhab2-mysql-persistence-setup/15829">instructions</a> that worked for me. <br><br>  So, install MySQL Persistence (persistence-mysql - 1.9.0). <br><br>  Install MySQL: <br><br><pre> <code class="hljs pgsql">sudo apt-<span class="hljs-keyword"><span class="hljs-keyword">get</span></span> install mysql-<span class="hljs-keyword"><span class="hljs-keyword">server</span></span> sudo mysql -u root -p</code> </pre> <br>  Configuring the database: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> OpenHAB; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> <span class="hljs-string"><span class="hljs-string">'openhab'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'YOURPASSWORD'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> OpenHAB.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'openhab'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>; quit</code> </pre> <br>  Restart openhab: <br><br><pre> <code class="hljs sql">sudo service openhab2 <span class="hljs-keyword"><span class="hljs-keyword">stop</span></span> sudo service openhab2 <span class="hljs-keyword"><span class="hljs-keyword">start</span></span></code> </pre> <br>  Rules <b>services / mysql.cfg</b> : <br><br><pre> <code class="hljs pgsql"># the <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> url <span class="hljs-keyword"><span class="hljs-keyword">like</span></span> <span class="hljs-string"><span class="hljs-string">'jdbc:mysql://&lt;host&gt;:&lt;port&gt;/&lt;database&gt;'</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">without</span></span> quotes) url=jdbc:mysql://localhost:<span class="hljs-number"><span class="hljs-number">3306</span></span>/openhab # the <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> <span class="hljs-keyword"><span class="hljs-keyword">user</span></span>=openhab # the <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span> <span class="hljs-keyword"><span class="hljs-keyword">password</span></span>=YOURPASSWORD</code> </pre> <br>  Rule <b>persistence / mysql.persist</b> .  By default, the values ‚Äã‚Äãof all Items will be entered into the database with each change: <br><br><pre> <code class="hljs pgsql">Strategies { // <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">no</span></span> strategy <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> specified <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> an item entry below, the <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> list will be used everyMinute : "0 * * * * ?" every5Minutes : "0 */5 * * * ?" everyHour : "0 0 * * * ?" everyDay : "0 0 0 * * ?" default = everyChange } Items { // persist <span class="hljs-keyword"><span class="hljs-keyword">all</span></span> items once a day <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> every change <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> restore them <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> the db at startup * : strategy = <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>, restoreOnStartup }</code> </pre><br>  If everything is set up correctly, the Items table and the ItemXX tables for each Item should appear in the database. <br><br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> openhab; Database changed mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> <span class="hljs-keyword"><span class="hljs-keyword">tables</span></span>; +<span class="hljs-comment"><span class="hljs-comment">-------------------+ | Tables_in_openhab | +-------------------+ | Item1 | | Item2 | | Item3 | | Item4 | | Items | +-------------------+ 5 rows in set (0.00 sec) mysql&gt; select * from Items; +--------+--------------------------+ | ItemId | ItemName | +--------+--------------------------+ | 1 | sdm220_voltage | | 2 | sdm220_actpower | | 3 | sdm220_actcounter | | 4 | sdm220_current | +--------+--------------------------+ 4 rows in set (0.00 sec)</span></span></code> </pre><br>  Now you can bring beauty to HabPanel. <br><br>  Add Dashboard, add new widgets to it.  To display the values ‚Äã‚Äãused by the widget <b>Dummy</b> , for displaying graphs - <b>Chart</b> .  It's all intuitive.  The parameters of power and voltage, I brought on one graph, using two different scales Y. <br><br>  Specify the mysql data source as: <br><br><img src="https://habrastorage.org/files/68b/2ca/963/68b2ca963f91446fa5d2ab96c1b186d5.png"><br><br>  Adjust the thresholds for the voltage axis: <br><br><img src="https://habrastorage.org/files/21b/8cc/e7e/21b8cce7e47f4b7090d5315fe795ac29.png"><br><br>  Add Items, specify color and line type for them, specify Secondary axis for voltage: <br><br><img src="https://habrastorage.org/files/28d/3d1/0e5/28d3d10e515347a59044c272d2e671ed.png"><br><br>  We get the result :) <br><br><img src="https://habrastorage.org/files/065/852/5e5/0658525e52384e3b8b23c1e5597807b0.png"><br><br><h3>  The third task: hourly and daily metering of electricity consumed </h3><br>  Displaying the state change over time is good, but I also wanted to get statistics on consumption per hour, day, month.  That is, the task is to periodically perform some calculations.  This is where the rules mechanism in OpenHab comes to the rescue. <br><br>  So, set up the <b>Rules</b> . <br><br>  First you need to add new Items to <b>items / sdm220.items</b> : <br><br><pre> <code class="hljs lisp">Number sdm220_hourcounter (<span class="hljs-name"><span class="hljs-name">gSDM220</span></span>) Number sdm220_daycounter (<span class="hljs-name"><span class="hljs-name">gSDM220</span></span>)</code> </pre><br>  Then we create the <b>rules / energy.rules file</b> , in which you need to specify 2 rules: one will be executed once an hour, the second - once a day. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Energy by hour" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 * * * ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> // .            var hour = sdm220_actcounter.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusHours(<span class="hljs-number"><span class="hljs-number">1</span></span>), "mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType //      logInfo("TEST","sdm220_hourcounter = "+hour) //  Item postUpdate(sdm220_hourcounter, hour) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Energy by day" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 0 * * ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> var day = sdm220_actcounter.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusDays(<span class="hljs-number"><span class="hljs-number">1</span></span>), "mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType postUpdate(sdm220_daycounter, day)</code> </pre><br>  For debugging, you can use the console OpenHab.  Standard login and password: openhab / habopen.  You can connect to it with the command: <br><br><pre> <code class="hljs pgsql">ssh -p <span class="hljs-number"><span class="hljs-number">8101</span></span> openhab@localhost openhab&gt; <span class="hljs-keyword"><span class="hljs-keyword">log</span></span>:tail <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00.012</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_hourcounter_day = <span class="hljs-number"><span class="hljs-number">0.526123046875</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">00.014</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_daycounter = <span class="hljs-number"><span class="hljs-number">10.861083984375</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">09.462</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [marthome.event.ItemStateChangedEvent] - sdm220_current changed <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">16.0433025360107421875</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">5.69449329376220703125</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">11.500</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [marthome.event.ItemStateChangedEvent] - sdm220_actcounter changed <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">2387.51904296875</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">2387.5458984375</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">13.532</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [marthome.event.ItemStateChangedEvent] - sdm220_voltage changed <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">192.7679595947265625</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">200.4195098876953125</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">22</span></span>:<span class="hljs-number"><span class="hljs-number">15.568</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [marthome.event.ItemStateChangedEvent] - sdm220_actpower changed <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-number"><span class="hljs-number">2271.8486328125</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> <span class="hljs-number"><span class="hljs-number">1132.8717041015625</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">00.014</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_hourcounter_day = <span class="hljs-number"><span class="hljs-number">0.515869140625</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">00.015</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_daycounter = <span class="hljs-number"><span class="hljs-number">10.8769531250</span></span></code> </pre><br>  Or you can view the log file: <br><br><pre> <code class="hljs pgsql">tail -f /var/<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>/openhab2/openhab.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">17</span></span>:<span class="hljs-number"><span class="hljs-number">45.587</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [el.core.internal.ModelRepositoryImpl] - Refreshing model <span class="hljs-string"><span class="hljs-string">'energy.rules'</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">00.259</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_hourcounter_day = <span class="hljs-number"><span class="hljs-number">0.571044921875</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">00.272</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_daycounter = <span class="hljs-number"><span class="hljs-number">10.8330078125</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">00.015</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_daycounter = <span class="hljs-number"><span class="hljs-number">10.83789062500</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">00.025</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_hourcounter_day = <span class="hljs-number"><span class="hljs-number">0.557861328125</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">00.013</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_hourcounter_day = <span class="hljs-number"><span class="hljs-number">0.55517578125</span></span> <span class="hljs-number"><span class="hljs-number">2017</span></span><span class="hljs-number"><span class="hljs-number">-04</span></span><span class="hljs-number"><span class="hljs-number">-18</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span>:<span class="hljs-number"><span class="hljs-number">20</span></span>:<span class="hljs-number"><span class="hljs-number">00.024</span></span> [<span class="hljs-keyword"><span class="hljs-keyword">INFO</span></span> ] [.eclipse.smarthome.model.script.TEST] - sdm220_daycounter = <span class="hljs-number"><span class="hljs-number">10.859130859375</span></span></code> </pre><br>  I plan to change the main electric meter to a two-tariff one, according to which the electricity consumed in the range from 23:00 to 07:00 is paid with a factor of 0.5, so I would like to see the expected effect and keep two tariffs.  At first, I simply added additional conditions for the time in Items and Rules and put the day and night readings in two different tables.  Everything was beautiful in the database, but on the graph it looked clumsy, as the graph connected the last two values ‚Äã‚Äãwith a straight line: <br><br><img src="https://habrastorage.org/files/0a5/3dc/e24/0a53dce24ebd402f98823161a333f479.png"><br><br>  To entertain my sense of beauty, I had to be a little confused. <br><br>  So, the final script Rules for two-tariff accounting looks like this: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Energy by hour" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 * * * ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> var hour = sdm220_actcounter.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusHours(<span class="hljs-number"><span class="hljs-number">1</span></span>), "mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType //   <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(now.getHourOfDay &gt; <span class="hljs-number"><span class="hljs-number">7</span></span> &amp;&amp; now.getHourOfDay &lt; <span class="hljs-number"><span class="hljs-number">23</span></span>) { logInfo("TEST","sdm220_hourcounter_day = "+hour) postUpdate(sdm220_hourcounter_day, hour) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { //        //      <span class="hljs-keyword"><span class="hljs-keyword">primary key</span></span>  <span class="hljs-type"><span class="hljs-type">timestamp</span></span>,               <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(now.getHourOfDay==<span class="hljs-number"><span class="hljs-number">7</span></span>) { postUpdate(sdm220_hourcounter_night, hour) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) postUpdate(sdm220_hourcounter_night, <span class="hljs-number"><span class="hljs-number">0</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) postUpdate(sdm220_hourcounter_day, <span class="hljs-number"><span class="hljs-number">0</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) postUpdate(sdm220_hourcounter_day, hour) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(now.getHourOfDay==<span class="hljs-number"><span class="hljs-number">23</span></span>) { postUpdate(sdm220_hourcounter_day, hour) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) postUpdate(sdm220_hourcounter_day,<span class="hljs-number"><span class="hljs-number">0</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) postUpdate(sdm220_hourcounter_night, <span class="hljs-number"><span class="hljs-number">0</span></span>) Thread::sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>) postUpdate(sdm220_hourcounter_night, hour) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { postUpdate(sdm220_hourcounter_night, hour) } } postUpdate(sdm220_hourcounter, hour) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">rule</span></span> "Energy by day" <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-type"><span class="hljs-type">Time</span></span> cron "0 0 0 * * ?" <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> var day = sdm220_actcounter.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusDays(<span class="hljs-number"><span class="hljs-number">1</span></span>), "mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType //night counter, <span class="hljs-number"><span class="hljs-number">00</span></span>:<span class="hljs-number"><span class="hljs-number">00.</span></span><span class="hljs-number"><span class="hljs-number">.07</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> + <span class="hljs-number"><span class="hljs-number">23</span></span>:<span class="hljs-number"><span class="hljs-number">00.</span></span><span class="hljs-number"><span class="hljs-number">.00</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> var day2 = sdm220_actcounter.historicState(now.minusHours(<span class="hljs-number"><span class="hljs-number">17</span></span>),"mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusDays(<span class="hljs-number"><span class="hljs-number">1</span></span>), "mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType + sdm220_actcounter.state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusHours(<span class="hljs-number"><span class="hljs-number">1</span></span>),"mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType //day counter, <span class="hljs-number"><span class="hljs-number">07</span></span>:<span class="hljs-number"><span class="hljs-number">00.</span></span><span class="hljs-number"><span class="hljs-number">.23</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span> var day1 = sdm220_actcounter.historicState(now.minusHours(<span class="hljs-number"><span class="hljs-number">1</span></span>),"mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType - sdm220_actcounter.historicState(now.minusHours(<span class="hljs-number"><span class="hljs-number">17</span></span>),"mysql":).state <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> DecimalType logInfo("TEST","sdm220_daycounter_day = "+day1) logInfo("TEST","sdm220_daycounter_night = "+day2) logInfo("TEST","sdm220_daycounter = "+day) postUpdate(sdm220_daycounter, day) postUpdate(sdm220_daycounter_day, day1) postUpdate(sdm220_daycounter_night, day2) <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br>  Before editing the script add the necessary Items: <br><br><pre> <code class="hljs lisp">Number sdm220_hourcounter_day (<span class="hljs-name"><span class="hljs-name">gSDM220</span></span>) Number sdm220_hourcounter_night (<span class="hljs-name"><span class="hljs-name">gSDM220</span></span>) Number sdm220_daycounter_day (<span class="hljs-name"><span class="hljs-name">gSDM220</span></span>) Number sdm220_daycounter_night (<span class="hljs-name"><span class="hljs-name">gSDM220</span></span>)</code> </pre><br>  Now the schedule of hourly and daily consumption is as follows: <br><br><img src="https://habrastorage.org/files/0fc/e9c/c0c/0fce9cc0c4cd43fbbf7ac36745309426.png"><br><br>  On this, perhaps, everything.  The plans still add the calculation of the consumption of electricity and money for the month at the day and night rate and generate a report with sending by mail. </div><p>Source: <a href="https://habr.com/ru/post/403237/">https://habr.com/ru/post/403237/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../403227/index.html">We go down - we grow up, or axis Z for cheap</a></li>
<li><a href="../403229/index.html">Computer card games: streamers that are worth paying attention to</a></li>
<li><a href="../403231/index.html">Backspace Invaders or how to connect a 64x64 LED display to Arduino</a></li>
<li><a href="../403233/index.html">NASA: Enceladus has all the conditions for the emergence and maintenance of life</a></li>
<li><a href="../403235/index.html">The second is more interesting than the first: a note on the new scales Xiaomi</a></li>
<li><a href="../403239/index.html">WiFi radio WOLNA. How to create a small startup</a></li>
<li><a href="../403241/index.html">Ask Ethan: How does dark matter interact with black holes?</a></li>
<li><a href="../403245/index.html">How to novice assemble quadrocopter ZMR250 / QAV250 with Aliexpress (1 part)</a></li>
<li><a href="../403247/index.html">Microsoft fixed zero-day vulnerabilities in its software long before they were revealed by the Shadow Brokers group.</a></li>
<li><a href="../403249/index.html">NASA plans change: NASA‚Äôs heavy rocket launches are likely to take</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>