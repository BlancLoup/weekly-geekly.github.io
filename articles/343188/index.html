<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Machine Learning: Azure Machine Learning Time Series Analysis for Anomaly Search</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anomaly detection is one of the most important functions for Internet of Things (IoT) solutions that collect and analyze temporal changes in the data ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Machine Learning: Azure Machine Learning Time Series Analysis for Anomaly Search</h1><div class="post__text post__text-html js-mediator-article">  Anomaly detection is one of the most important functions for Internet of Things (IoT) solutions that collect and analyze temporal changes in the data stream from various sensors.  In many cases, the data stream does not significantly change over time.  However, if they appear, this most often means that an anomaly has arisen in the system that can disrupt its operation.  In this article, I‚Äôll explain how to use the Time Series Anomaly Detection module of the Azure Machine Learning machine learning service to determine anomalous sensor readings. <br><br><img src="https://habrastorage.org/webt/ca/q_/nc/caq_ncdfb3_f1ticvjeu4ytc4v8.jpeg"><a name="habracut"></a><br><br>  To reveal the topic, I will expand the functionality of the RemoteCamera Universal Windows Platform (UWP) application, which I developed to the previous <a href="http://msdn.com/magazine/mt809116">article</a> , and add a list in which anomalous values ‚Äã‚Äãwill be displayed.  The RemoteCamera application receives an image from a webcam and calculates its brightness, which, subject to the unchanged scene in the frame, oscillates around certain values.  Brightness is easily changed, for example, by covering the camera with your hand, which will lead to a noticeable deviation in the data stream.  This helps to get a good sample for the detection of anomalies in the time series. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/7y/y8/zn/7yy8znqqx-9qvigjci89dxqoags.png"><br><br><h2>  Anomaly search </h2><br>  According to a recent <a href="http://msdn.com/magazine/mt826350">article by</a> James McCaffrey, the standard method for detecting anomalies is based on time series regression.  Having superimposed the model on the data, you can predict the trends and then check whether all the indicators correspond to them.  To do this, you need to compare the predicted and actual figures.  A significant difference will indicate a deviation or an anomaly. <br><br>  First, I will show how to find such deviations by analyzing z-scores.  The higher this score, the higher the probability that there is a deviation in the value stream.  To find the anomalies, you need to determine the boundaries of z-scores, taken as normal.  All z-scores outside the specified limits will be considered abnormal.  It should be taken into account that due to the fixed threshold specified in this scenario, numerous false alarms are possible.  To reduce their number, apply more complex algorithms.  In our case, the Azure Time Series Anomaly Detection module is based on <a href="http://bit.ly/2wjBYUU">permutation martingales</a> that analyze whether a series of data can be arbitrarily reorganized without losing the probability of finding a certain value.  Simply put, can each value be detected in the data set with equal probability.  The commutative data set is characterized by a low coefficient of anomalies.  If commutativity is broken, the anomaly coefficient increases, indicating non-standard values. <br><br>  In this article I will explain how to create such machine learning algorithms.  I will use the Microsoft Azure Machine Learning Studio solution.  James McCaffrey also <a href="http://msdn.com/magazine/dn781358">spoke</a> about this product in September 2014.  I will expand the topic of this article and demonstrate machine learning experiments.  In addition, I will show how to deploy the solution in the form of a web service, and then how to use this service in the RemoteCamera application. <br><br><h2>  Training using a dataset </h2><br>  First, we extend the RemoteCamera application by adding a tab where you can collect data for training, and also enable or disable anomaly detection mode using the checkbox. <br><br><img src="https://habrastorage.org/webt/vu/xa/bc/vuxabcwwe1kauwa02jtmy7co5fs.png"><br><br>  The Acquire training dataset button becomes active if you start a preview of the image from the camera (using the control buttons on the main tab).  When you click this button, the application starts collecting data for training.  This process takes place in the background, its course is accompanied by a circular animation.  As a result, a training dataset consisting of 100 data points will be created.  Each of them will be represented by an instance of the BrightnessDataPoint structure: <br><br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">struct</span></span> BrightnessDataPoint { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> DateTime Time { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">byte</span></span> Brightness { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">BrightnessDataPoint</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> brightness</span></span></span><span class="hljs-function">)</span></span> { Time = DateTime.Now; Brightness = brightness; } }</code> </pre> <br>  The BrightnessDataPoint structure stores the brightness value, as well as the time in which it was recorded.  Then the set of such values ‚Äã‚Äãis exported to the file BrightnessData.csv, which looks like this: <br><br><pre> <code class="cs hljs">Time,Brightness <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">00</span></span>,<span class="hljs-number"><span class="hljs-number">103</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">01</span></span>,<span class="hljs-number"><span class="hljs-number">103</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">02</span></span>,<span class="hljs-number"><span class="hljs-number">102</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">03</span></span>,<span class="hljs-number"><span class="hljs-number">42</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">04</span></span>,<span class="hljs-number"><span class="hljs-number">46</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">05</span></span>,<span class="hljs-number"><span class="hljs-number">149</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">06</span></span>,<span class="hljs-number"><span class="hljs-number">99</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">07</span></span>,<span class="hljs-number"><span class="hljs-number">101</span></span> <span class="hljs-number"><span class="hljs-number">9</span></span>/<span class="hljs-number"><span class="hljs-number">8</span></span>/<span class="hljs-number"><span class="hljs-number">2017</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span>:<span class="hljs-number"><span class="hljs-number">30</span></span>:<span class="hljs-number"><span class="hljs-number">08</span></span>,<span class="hljs-number"><span class="hljs-number">104</span></span></code> </pre> <br>  Then, the exact location of the training dataset is displayed in the text box.  I use comma separated values ‚Äã‚Äã(CSV file).  They are easy to upload to Machine Learning Studio. <br><br>  To implement this functionality, I wrote two classes: BrightnessFileStorage and AnomalyDetector.  The first class, BrightnessFileStorage, is defined by the BrightnessFileStorage.cs file in the AnomalyDetection subfolder of the accompanying code.  The BrightnessFileStorage class saves a set of BrightnessDataPoint objects to a CSV file using the <a href="http://bit.ly/2wS31dq">DataWriter</a> class. <br><br>  The second class AnomalyDetector handles logic related to the detection of anomalies.  In particular, it includes the public method Add-TrainingValue, which is called immediately after calculating the image brightness (see the event handler ImageProcessor_ProcessingDone in the MainPage.xaml.cs file in the accompanying code).  AddTrainingValue works as follows.  First, I create an instance of BrightnessDataPoint, which is then added to the set.  When the set has 100 items, I save it to a CSV file.  Then I trigger the TrainingDataReady event, which is handled in the MainPage.  The goal is to interrupt data collection for training and display the file location in the user interface: <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnomalyDetector_TrainingDataReady</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, TrainingDataReadyEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ThreadHelper.InvokeOnMainThread(() =&gt; { remoteCameraViewModel.IsTrainingActive = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; remoteCameraViewModel.TrainingDataSetFilePath = e.FilePath; }); }</code> </pre> <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> trainingDataSetLength = <span class="hljs-number"><span class="hljs-number">100</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;BrightnessDataPoint&gt; trainingDataSet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> List&lt;BrightnessDataPoint&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;TrainingDataReadyEventArgs&gt; TrainingDataReady; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTrainingValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> brightness</span></span></span><span class="hljs-function">)</span></span> { trainingDataSet.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrightnessDataPoint(brightness)); <span class="hljs-comment"><span class="hljs-comment">// Check if all data points were acquired if (trainingDataSet.Count == trainingDataSetLength) { // If so, save them to csv file var brightnessFileStorage = await BrightnessFileStorage.CreateAsync(); await brightnessFileStorage.WriteData(trainingDataSet); // ... and inform listeners that the training data set is ready TrainingDataReady?.Invoke(this, new TrainingDataReadyEventArgs( brightnessFileStorage.FilePath)); } }</span></span></code> </pre> <br>  The location of the training dataset will be displayed in a text box, from where it can be easily copied, pasted into Windows Explorer, and viewed data obtained. <br><br><h2>  Z-score analysis </h2><br>  After receiving the training data set, I will prepare the first experiment in Machine Learning Studio according to the instructions described in the article by James McCaffrey in 2014.  First, I upload the file BrightnessData.csv, then plan an experiment using the visual designer.  In short, all the components are in the menu on the left side of the Machine Learning Studio window.  To place an element on the plan of your experiment, simply drag it to the experiment area (this is the central part of the Machine Learning Studio window).  Each component has its own input and output data.  You need to connect compatible nodes to control the flow of data between modules.  Components can have additional settings that can be set in the properties window (on the right side of the Machine Learning Studio window). <br><br><img src="https://habrastorage.org/webt/pg/vj/nc/pgvjncmi54kgdkdrhjnppzrvnx8.png"><br><br>  The machine learning algorithm shown above can work in two modes: experiment and web service.  The difference is only in the input data.  In experiment mode, the loaded training data set (BrightnessData) appears in their role, and in the web service mode, its own input data.  Regardless of the mode, the input data is converted to a data set, after which the brightness column values ‚Äã‚Äãare normalized by <a href="http://bit.ly/2eWwHAa">conversion to z-scores</a> .  In the course of this transformation, the brightness values ‚Äã‚Äãare recalculated into z-scores, which show their scatter relative to the average value.  The scatter is measured in standard deviations.  The greater this variation, the higher the likelihood that the current value is anomalous.  I apply normalization of z-scores, since often the baseline or normal brightness level depends on what the camera captures.  Thus, converting to a z-score provides the correct brightness level when normalization is close to 0. Untreated brightness values ‚Äã‚Äãdiffer in the approximate range from 40 to 150. After normalization, all brightness values ‚Äã‚Äãfall into the range from approximately ‚Äì4.0 to +4.0.  Therefore, in order to find the anomalous values, I just need to apply a threshold filter.  I use the OutOfRange threshold filter in Azure Machine Learning with a lower threshold of ‚Äì2 and a high of 1.5.  I chose these values ‚Äã‚Äãbased on the z-score graph and set them in the threshold filter properties panel in Machine Learning Studio. <br><br><img src="https://habrastorage.org/webt/qp/u-/1t/qpu-1tfnqwnrufgrz0umjsczm4s.png"><br><br>  After specifying the threshold, the data set is a data column of a logical type, where it is indicated whether at a particular moment the point is outside the specified range.  To supplement this information with actual brightness values ‚Äã‚Äãthat were identified as anomalous, I combine this column with the initial data set, and then break the resulting set into two subsets.  One contains only anomalous values, the second - standard.  Before the breakdown, I change the data type in the column, because the Split Data module does not support boolean values.  After that, as a result of the experiment, the first subset is issued.  In the case of a web service, this result is passed to the client.  To view the values ‚Äã‚Äãof a dataset, you must use the Results dataset |  Visualize from the dataset context menu in Machine Learning Studio.  This option will be available if you have already run this experiment. <br><br><img src="https://habrastorage.org/webt/fz/gv/o6/fzgvo6cyr9eb9fwex4zep6w5bqu.png"><br><br><h2>  Time Series Analysis in Machine Learning </h2><br>  And now let's learn how to use the Azure Time Series Anomaly Detection (ATSAD) module to detect anomalies.  As shown below, the process of this experiment resembles the previous one.  The initial data set is normalized by conversion to z-scores and transferred to the ATSAD module (it is located in the Time Series node in Machine Learning Studio).  To do this, <a href="http://bit.ly/2xUGTg2">you need to configure</a> several input parameters in the properties window (bit.ly/2xUGTg2).  First you need to specify the data and time columns, then configure the martingale type.  In our case, I will use the martingale Power.  Another text field will become available - Epsilon, where you can enter any detector sensitivity value in the range from 0 to 1. Then you need to configure three parameters of the function for determining the strangeness of values: <br><br><ul><li>  RangePercentile: This parameter should be used to detect values ‚Äã‚Äãthat are obviously out of range, such as bursts or dips.  In this experiment, this parameter will work by analogy with the previous experiment, but the analysis will be more complete. </li><li>  SlowPos- and SlowNegTrend: Use this parameter to detect trends in your dataset in the direction of positive or negative values.  This is useful when your solution tracks an increase or decrease in observed values. </li></ul><br><br><img src="https://habrastorage.org/webt/ym/8r/ko/ym8rkotszptzpc4m5h93njydmc4.png"><br><br>  Next, you need to specify the maximum number of martingale and strangeness values ‚Äã‚Äãin the journal.  You can enter any integer from 10 to 1000. Through trial and error, I stopped at the following detector settings: <br><br><ul><li>  Epsilon = 0.4 </li><li>  The length of the journal of martingale and strangeness values ‚Äã‚Äã= 50 </li></ul><br>  The last detector parameter is the warning threshold.  It sets the minimum anomaly value coefficient.  The default warning threshold is 3.5.  For my experiment, I changed this value to 2. <br><br>  By requesting to visualize the output of the ATSAD module, you can see that two columns are added to the input data set: an anomaly coefficient measuring the deviations, and a warning indicator with a binary value (0 or 1) indicating an anomaly value.  Based on the readings of the second indicator, I break the data set into two subsets: standard and anomalous values.  As a result of the experiment, only a subset of anomalous values ‚Äã‚Äãis issued.  In other details, the experiment is identical to the previous one, and I will not describe them again.  I note only that the most important aspect of the experiment for the web service is the description of the input and output data.  Let's call this data as follows: Data (web service input) and AnomalyDetectionResult (web service output). <br><br><h2>  Web Service Client </h2><br>  After setting up the experiments, I can deploy them as web services, access them through the RemoteCamera application, and detect anomalous image luminance values.  To create a web service, you need to run the experiment, and then click the Deploy Web Service icon in the lower pane of the Machine Learning Studio window.  If you have not added a web service input and output modules to your experiment, the Set Up Web Service button will appear in this area.  After clicking it, the input and output modules of the web service will be added to the experiment, and the name of the button will change to Deploy Web Service. <br><br><img src="https://habrastorage.org/webt/qo/bi/p5/qobip5rxfoiqegkjn6ryyo5z3ms.png"><br><br>  When the deployment of the web service is complete, the web service control panel opens.  This panel displays a summary of the deployed web service, an API key, as well as instructions for sending requests and processing responses (API Help Page).  In particular, when you click the request / response hyperlink, the web service URL and the detailed structure of requests and responses in JSON format are displayed. <br><br><img src="https://habrastorage.org/webt/on/m4/af/onm4afrjjq1eq11smqq2i5hdfuk.png"><br><br>  Next, I save the API key and create mappings from JSON to C # using the JSONUtils service (jsonutils.com).  Then I save the resulting classes in the appropriate files - AnomalyDetectionRequest.cs and AnomalyDetectionResponse.cs in the AnomalyDetection subfolder.  Their structures are similar - both files usually contain classes with properties that for the most part are implemented automatically.  AnomalyDetectionRequest and AnomalyDetectionResponse are the transfer of the corresponding JSON objects between the client and the web service.  For example, the definition of the AnomalyDetectionRequest class and dependent objects is shown below.  Notice that I use the ConversionHelper helper class to convert the dataset of brightness data points to the input data format for the Machine Learning Studio web service (two-dimensional arrays of strings).  The complete definition of this auxiliary class is contained in the accompanying code.  This class has two public methods.  With their help, a set of brightness data points is converted to the type string [,] (BrightnessDataToStringTable) and back (AnomalyDetectionResponseToBrightnessData). <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">AnomalyDetectionRequest</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Inputs Inputs { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> GlobalParameters GlobalParameters { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnomalyDetectionRequest</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> IList&lt;BrightnessDataPoint&gt; brightnessData</span></span></span><span class="hljs-function">)</span></span> { Inputs = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Inputs() { Data = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Data() { ColumnNames = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] { <span class="hljs-string"><span class="hljs-string">"Time"</span></span>, <span class="hljs-string"><span class="hljs-string">"Brightness"</span></span> }, Values = ConversionHelper. BrightnessDataToStringTable(brightnessData) } }; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Inputs</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Data Data { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Data</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] ColumnNames { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[,] Values { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">GlobalParameters</span></span> { }</code> </pre> <br>  After creating the mapping of objects from JSON to C #, you can start writing the web service client.  To do this, I first install the Microsoft.AspNet.WebApi.Client NuGet package, and then use it to define the AnomalyDetectionClient class (see the corresponding file in the accompanying code).  There are three private fields in this class: baseAddress, apiKey and httpClient.  The first field contains the URL of the Machine Learning Studio web service, the second contains the API key.  Both of these values ‚Äã‚Äãare used to create an instance of the HttpClient class (from the previously installed NuGet package): <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnomalyDetectionClient</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { httpClient = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HttpClient() { BaseAddress = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Uri(baseAddress), }; httpClient.DefaultRequestHeaders.Authorization = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AuthenticationHeaderValue(<span class="hljs-string"><span class="hljs-string">"Bearer"</span></span>, apiKey); }</code> </pre> <br>  After creating the client, I can start sending requests to the Machine Learning Studio web service using the AnomalyDetectionClient.DetectAnomalyAsync method.  This method provides a set of brightness data points as test data.  This test data is used instead of the CSV file that I used for the experiments.  They create an instance of the AnomalyDetection request.  An instance of this class is then sent to the web service for analysis using the PostAsJsonAsync extension method.  The resulting JSON response is converted to an instance of the AnomalyDetectionResponse class, which is eventually issued by the DetectAnomalyAsync function.  See if there are any errors.  If necessary, throw out exceptions. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">async</span></span> Task&lt;IList&lt;BrightnessDataPoint&gt;&gt; DetectAnomalyAsync(IList&lt;BrightnessDataPoint&gt; brightnessData) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnomalyDetectionRequest(brightnessData); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> response = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> httpClient.PostAsJsonAsync(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.Empty, request); IList&lt;BrightnessDataPoint&gt; result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (response.IsSuccessStatusCode) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> anomalyDetectionResponse = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> response.Content.ReadAsAsync&lt;AnomalyDetectionResponse&gt;(); result = ConversionHelper. AnomalyDetectionResponseToBrightnessData(anomalyDetectionResponse); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Exception(response.ReasonPhrase); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; }</code> </pre> <br>  AnomalyDetectionClient is used in the AddTestValue method of the AnomalyDetector class.  Like AddTrainingValue, AddTestValue is also called by the ImageProcessor_ProcessingDone event handler (see the MainPage.xaml.cs file in the accompanying code).  However, AddTestValue works a little differently than the AddTrainingValue method.  In AddTrainingValue, I add brightness data points to an instance of the BrightnessDataset class, which internally uses the generic List class to enter a sliding interval.  Test values ‚Äã‚Äãare stored in this interval (see James McCaffrey‚Äôs October article).  By default, the sliding interval has 30 elements, but this value can be changed using the designer BrightnessDataset.  As shown below, I send the data for analysis after filling the interval.  Then I check for the presence of elements in the anomalous value set issued by the web service.  If items are present, I trigger the AnomalyDetected event, which is also used to pass anomalies to the listeners. <br><br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">event</span></span> EventHandler&lt;AnomalyDetectedEventArgs&gt; AnomalyDetected; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BrightnessDataset dataSet = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrightnessDataset(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> Task </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AddTestValue</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">byte</span></span></span></span><span class="hljs-function"><span class="hljs-params"> brightness</span></span></span><span class="hljs-function">)</span></span> { dataSet.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> BrightnessDataPoint(brightness)); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (dataSet.IsFull) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> anomalousValues = <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> anomalyDetectionClient. DetectAnomalyAsync(dataSet.Data); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (anomalousValues.Count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) { AnomalyDetected?.Invoke(<span class="hljs-keyword"><span class="hljs-keyword">this</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AnomalyDetectedEventArgs(anomalousValues)); } } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (Exception ex) { Debug.WriteLine(ex); } } }</code> </pre> <br>  To display the anomalous values ‚Äã‚Äãin the interface, I process the AnomalyDetected event in the MainPage class as follows. <br><br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">async</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">AnomalyDetector_AnomalyDetected</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"> </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">object</span></span></span></span><span class="hljs-function"><span class="hljs-params"> sender, AnomalyDetectedEventArgs e</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">await</span></span> ThreadHelper.InvokeOnMainThread(() =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> anomalousValue <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> e.AnomalousValues) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!remoteCameraViewModel.AnomalousValues.Contains(anomalousValue)) { remoteCameraViewModel.AnomalousValues.Add(anomalousValue); } } }); }</code> </pre> <br>  I iterate through the set of obtained values, checking whether they have already been added to the local data repository (the AnomalousValues ‚Äã‚Äãproperty of the view model).  If not, then I add them to the set of observed values.  As a result, only new anomalous values ‚Äã‚Äãappear in the list shown in the first picture.  This additional check is necessary because only one element has changed in the sliding interval between two consecutive requests to the web service. <br><br>  To test my solution, you need to start the RemoteCamera application, start previewing the image from the camera and enable the search for anomalies by checking the box on the Anomaly Detection tab.  You can then create anomalous values ‚Äã‚Äãby covering the camera with your hand.  A machine learning detector will quickly detect these abnormal values ‚Äã‚Äãand display them in a list box. <br><br><h2>  Conclusion </h2><br>  I‚Äôve shown how to create two different anomaly detection experiments in Azure Machine Learning Studio.  Both experiments were also deployed as web services and combined with the RemoteCamera client application, which sends locally obtained time series data for machine analysis in order to detect anomalies.  In this case, I used the Universal Windows Platform (UWP) web service.  The same code can be used to access a web service through an ASP.NET web application, in which the machine learning logic is processed by the server part and not at the end point.  In the context of IoT, this point can be a simple sensor. <br><br><h2>  Microsoft Developer School </h2><br>  November 28-30, in Kiev, for the first time, there will be a school of developers in the Open Hack format. <br><br>  Teams of 2‚Äì5 people will be able to work on the project existing in their company or get acquainted with the technological stack of another relevant project. <br><br>  The main topics will be: <br><br><ul><li>  serverless computing, containers and microservices; </li><li>  IoT; </li><li>  big data and machine learning; </li><li>  augmented and virtual reality. </li></ul><br>  To participate in the event you need to <a href="https://events.techdays.ru/Microsoft-Developer-School/2017-11/">register</a> . </div><p>Source: <a href="https://habr.com/ru/post/343188/">https://habr.com/ru/post/343188/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../343174/index.html">Authorization through Network Policy Server (NPS) for MikroTik</a></li>
<li><a href="../343178/index.html">On fractals, martingales and random integrals. Part one</a></li>
<li><a href="../343180/index.html">Method Lego Serious Play: how to formulate and use the values ‚Äã‚Äãof the team with the help of children's designer</a></li>
<li><a href="../343184/index.html">Facebook Product Development Framework</a></li>
<li><a href="../343186/index.html">Cryptocurrencies and virtual economy</a></li>
<li><a href="../343190/index.html">We consider business processes. Introduction</a></li>
<li><a href="../343194/index.html">Docker and everything is everything</a></li>
<li><a href="../343196/index.html">How does ‚Äútranscribing‚Äù differ from ‚Äúvoice recognition‚Äù?</a></li>
<li><a href="../343198/index.html">How IaaS and SaaS technologies change education</a></li>
<li><a href="../343202/index.html">33 independent blogs on UI design, web development and programming</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>