<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Functional C #: Immutability</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the first article in a small series on C # programming in a functional style. The series is not about LINQ, as one might think, but about more...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Functional C #: Immutability</h1><div class="post__text post__text-html js-mediator-article">  This is the first article in a small series on C # programming in a functional style.  The series is not about LINQ, as one might think, but about more fundamental things.  Inspired by F # th. <br><br><ul><li>  <b>Functional C #: Immutability</b> <br></li><li>  <a href="http://habrahabr.ru/post/266937/">Functional C #: Primitive obsession</a> <br></li><li>  <a href="http://habrahabr.ru/post/267063/">Functional C #: Non-nullable reference types</a> <br></li><li>  <a href="http://habrahabr.ru/post/267231/">Functional C #: work with errors</a> <br></li></ul><br><a name="habracut"></a><br><h2>  Immutability (immutability) </h2><br>  The biggest problem in the world of enterprise development is the struggle with complexity.  Code readability is probably the first thing we should try to achieve when writing any more or less complex project.  Without this, our ability to understand the code and make reasonable decisions based on this is significantly impaired. <br><br>  Do mutable objects help us in reading the code?  Let's look at an example: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="hljs pgsql">// <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> criteria var queryObject = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryObject&lt;Customer&gt;(<span class="hljs-type"><span class="hljs-type">name</span></span>, page: <span class="hljs-number"><span class="hljs-number">0</span></span>, pageSize: <span class="hljs-number"><span class="hljs-number">10</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span> customers IReadOnlyCollection&lt;Customer&gt; customers = <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span>(queryObject); // Adjust criteria <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (customers.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) AdjustSearchCriteria(queryObject, <span class="hljs-type"><span class="hljs-type">name</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> queryObject changed here? <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span>(queryObject);</code> </pre> <br>  Has queryObject changed by the time of searching for customers a second time?  Maybe yes.  Or maybe not.  It depends on whether this object was modified by the AdjustSearchCriteria method.  To find out, we need to look inside this method, its signature does not give us enough information. <br><br>  Compare this with the following code: <br><br><pre> <code class="hljs pgsql">// <span class="hljs-keyword"><span class="hljs-keyword">Create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">search</span></span> criteria var queryObject = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> QueryObject&lt;Customer&gt;(<span class="hljs-type"><span class="hljs-type">name</span></span>, page: <span class="hljs-number"><span class="hljs-number">0</span></span>, pageSize: <span class="hljs-number"><span class="hljs-number">10</span></span>); // <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span> customers IReadOnlyCollection&lt;Customer&gt; customers = <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span>(queryObject); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (customers.Count == <span class="hljs-number"><span class="hljs-number">0</span></span>) { // Adjust criteria <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">nothing</span></span> <span class="hljs-built_in"><span class="hljs-built_in">found</span></span> QueryObject&lt;Customer&gt; newQueryObject = AdjustSearchCriteria(queryObject, <span class="hljs-type"><span class="hljs-type">name</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">Search</span></span>(newQueryObject); }</code> </pre><br>  In this example, it is clear that AdjustSearchCriteria creates a new criterion object and then uses it for a new search. <br><br>  So what's the problem with variable data structures? <br><br><ul><li>  It is difficult to think about the code if there is no certainty whether the data transferred from one method to another changes. <br></li><li>  It is difficult to do the program execution if you have to go down several levels down the stack. <br></li><li>  In the case of a multithreaded application, understanding and debugging code is complicated many times. <br></li></ul><br><h2>  How to create immutable types </h2><br>  In future versions of C #, the immutable keyword may appear.  With its help, it will be possible to understand whether a type is immutable by simply looking at its signature.  In the meantime, we have to use what we have. <br><br>  If you have a relatively simple class, consider making it immutable.  This guideline correlates with the concept of <a href="http://enterprisecraftsmanship.com/2015/01/03/value-objects-explained/">Value Objects</a> . <br><br>  Take, for example, the ProductPile class, which describes a number of products for sale: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductPile</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProductName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre><br>  To make it immutable, we can mark its properties as read-only and add a constructor: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductPile</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProductName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductPile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> price</span></span></span><span class="hljs-function">)</span></span> { Contracts.Require(!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(productName)); Contracts.Require(amount &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); Contracts.Require(price &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ProductName = productName; Amount = amount; Price = price; } }</code> </pre><br>  Now suppose you need to reduce the Amount property by one each time you sell one of the products.  Instead of changing the existing object, we can create a new one based on the existing one: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">ProductPile</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> ProductName { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> Amount { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">decimal</span></span> Price { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ProductPile</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> productName, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> amount, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">decimal</span></span></span></span><span class="hljs-function"><span class="hljs-params"> price</span></span></span><span class="hljs-function">)</span></span> { Contracts.Require(!<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>.IsNullOrWhiteSpace(productName)); Contracts.Require(amount &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>); Contracts.Require(price &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>); ProductName = productName; Amount = amount; Price = price; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ProductPile </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SubtractOne</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ProductPile(ProductName, Amount ‚Äì <span class="hljs-number"><span class="hljs-number">1</span></span>, Price); } }</code> </pre><br>  What does this give us? <br><br><ul><li>  Having an immutable type, we need to validate its contracts only once, in the constructor.  After that we can be absolutely sure that the object is in the correct state. <br></li><li>  Objects of immutable types are thread safe. <br></li><li>  Improved readability of the code, because  it is no longer necessary to go into the stack in order to make sure that the variables with which the method works are not changed. <br></li></ul><br><h2>  Restrictions </h2><br>  Of course, every good practice has its price.  While small classes take full advantage of immutability, such an approach is not always applicable in the case of large types. <br><br>  In the first place, immutability carries potential performance problems.  If the object is quite large, the need to create a copy of it with each change can be a problem. <br><br>  A good example here will be <a href="https://msdn.microsoft.com/en-us/library/dn385366%2528v%3Dvs.110%2529.aspx">unchangeable collections</a> .  The authors took into account potential performance problems and added a special Builder class that allows you to change the state of collections.  After the collection is brought to the required state, it can be finalized by converting it into immutable: <br><br><pre> <code class="hljs pgsql">var builder = ImmutableList.CreateBuilder&lt;string&gt;(); builder.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(‚Äú<span class="hljs-number"><span class="hljs-number">1</span></span>‚Äù); // Adds item <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> the existing <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> ImmutableList&lt;string&gt; list = builder.ToImmutable(); ImmutableList&lt;string&gt; list2 = list.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(‚Äú<span class="hljs-number"><span class="hljs-number">2</span></span>‚Äù); // Creates a <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> items</code> </pre><br><h2>  Conclusion <br></h2><br>  In most cases, immutable types (especially if they are fairly simple) make the code better. <br><br><h2>  The remaining articles in the series: </h2><br><ul><li>  <b>Functional C #: Immutability</b> <br></li><li>  <a href="http://habrahabr.ru/post/266937/">Functional C #: Primitive obsession</a> <br></li><li>  <a href="http://habrahabr.ru/post/267063/">Functional C #: Non-nullable reference types</a> <br></li><li>  <a href="http://habrahabr.ru/post/267231/">Functional C #: work with errors</a> <br></li></ul><br>  English version of the article: <a href="http://enterprisecraftsmanship.com/2015/03/02/functional-c-immutability/">Functional C #: Immutability</a> </div><p>Source: <a href="https://habr.com/ru/post/266873/">https://habr.com/ru/post/266873/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../266861/index.html">Hash array mapped trie</a></li>
<li><a href="../266863/index.html">Jet9 test results and service commissioning</a></li>
<li><a href="../266865/index.html">QuadBraces - based on the MODx parser</a></li>
<li><a href="../266869/index.html">New ‚Äúservice‚Äù from Ubiquiti - replenishment in the model range UniFi AC</a></li>
<li><a href="../266871/index.html">Deploy JetBrains Hub + Youtrack + Upsource + Nginx on your Debian 8 server</a></li>
<li><a href="../266877/index.html">Git for a professional programmer</a></li>
<li><a href="../266879/index.html">Grandstream GVC 3200 Video Conferencing Solution Review - ‚ÄúIt Changes Everything‚Äù</a></li>
<li><a href="../266881/index.html">Using Java 8 Libraries for Android Applications with Maven</a></li>
<li><a href="../266883/index.html">How Russian cloud services for business inhibit their own market</a></li>
<li><a href="../266885/index.html">Google's Faces API Example</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>