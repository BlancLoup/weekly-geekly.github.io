<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Powershell and Cyrillic in console applications (updated)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the development process, it is often necessary to start a console application from the powershell script. What could be easier? 



#test.ps1 & $PS...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Powershell and Cyrillic in console applications (updated)</h1><div class="post__text post__text-html js-mediator-article">  In the development process, it is often necessary to start a console application from the powershell script.  What could be easier? <br><br><pre><code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#test</span></span>.ps1 &amp; <span class="hljs-string"><span class="hljs-string">$P</span></span>SScriptRoot\<span class="hljs-type"><span class="hljs-type">ConsoleApp</span></span>.exe</code> </pre> <br><div style="text-align:center;"><img src="https://habrastorage.org/files/f9b/8f5/bd7/f9b8f5bd78ba4bb88940ce728b191103.png"></div><br><a name="habracut"></a><br>  Let us study the behavior of console applications when they are launched from the command line, via PowerShell, and through PowerShell ISE: <br><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/0d5/852/b0d/0d5852b0dd4249a29d32012047e6340e.png"><br></div></div><br>  In PowerShell ISE, there was a problem with the encoding, since ISE expects output in the 1251 encoding. We use Google and find two solutions to the problem: using [Console] :: OutputEncoding and through the powershell pipeline.  We use the first solution: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">test2.ps1</b> <div class="spoiler_text"><pre> <code class="hljs php">$ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RunConsole</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($scriptBlock)</span></span></span><span class="hljs-function"> </span></span>{ $encoding = [Console]::OutputEncoding [Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding(<span class="hljs-string"><span class="hljs-string">"cp866"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { &amp;$scriptBlock } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { [Console]::OutputEncoding = $encoding } } RunConsole { &amp; $PSScriptRoot\ConsoleApp1.exe }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/5fc/4c1/585/5fc4c158556743d8b90212e53ee14dc2.png"><br></div></div><br>  The command line is fine, but in ISE error.  <i>Exception setting "OutputEncoding": "The handle is invalid."</i> .  Once again, we‚Äôll take Google into our hands, and in the very first result we find a solution - we need to launch some console application to create the console.  Well, let's try. <br><br><div class="spoiler">  <b class="spoiler_title">test3.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">$ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> function RunConsole($scriptBlock) { #   <span class="hljs-string"><span class="hljs-string">""</span></span> : Exception setting <span class="hljs-string"><span class="hljs-string">"OutputEncoding"</span></span>: <span class="hljs-string"><span class="hljs-string">"The handle is invalid."</span></span> &amp; cmd /c ver | Out-Null $encoding = [Console]::OutputEncoding [Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding(<span class="hljs-string"><span class="hljs-string">"cp866"</span></span>) try { &amp;$scriptBlock } finally { [Console]::OutputEncoding = $encoding } } RunConsole { &amp; $PSScriptRoot\ConsoleApp1.exe }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/9f3/ae8/aee/9f3ae8aee5154589a7f487a942e65a2b.png"><br></div></div><br>  Everything is beautiful, everything works.  Who read my last note, noticed that WinRM brings us many sharp impressions.  Let's try to run the test through WinRM.  To run, use this script: <br><br><div class="spoiler">  <b class="spoiler_title">remote1.ps1</b> <div class="spoiler_text"><pre> <code class="hljs php">param($script) $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> $s = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-PSSession <span class="hljs-string"><span class="hljs-string">"."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $path = <span class="hljs-string"><span class="hljs-string">"$PSScriptRoot\$script"</span></span> Invoke-Command -Session $s -ScriptBlock { &amp;$using:path } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Remove-PSSession -Session $s }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/1a4/6c2/092/1a46c20921c8473a9de9bb4480c48607.png"><br></div></div><br>  Something went wrong.  The solution with the creation of the console does not work.  Earlier we found two solutions to the encoding problem.  Let's try the second one: <br><br><div class="spoiler">  <b class="spoiler_title">test4.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">$ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> #$VerbosePreference = <span class="hljs-string"><span class="hljs-string">"Continue"</span></span> function RunConsole($scriptBlock) { function ConvertTo-Encoding ([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$From, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$To) { Begin { $encFrom = [System.Text.Encoding]::GetEncoding($from) $encTo = [System.Text.Encoding]::GetEncoding($to) } Process { $bytes = $encTo.GetBytes($_) $bytes = [System.Text.Encoding]::Convert($encFrom, $encTo, $bytes) $encTo.GetString($bytes) } } Write-Verbose <span class="hljs-string"><span class="hljs-string">"RunConsole: Pipline mode"</span></span> &amp;$scriptBlock | ConvertTo-Encoding cp866 windows<span class="hljs-number"><span class="hljs-number">-1251</span></span> } RunConsole { &amp; $PSScriptRoot\ConsoleApp1.exe }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/bb8/7a5/386/bb87a5386a3a43ac9968ab0ab1854f5e.png"><br></div></div><br>  In ISE and through WinRM, the solution works, but not via the command line and the shell. <br>  It is necessary to combine these two methods and the problem will be solved! <br><br><div class="spoiler">  <b class="spoiler_title">test5.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">$ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> #$VerbosePreference = <span class="hljs-string"><span class="hljs-string">"Continue"</span></span> function RunConsole($scriptBlock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([Environment]::UserInteractive) { #   <span class="hljs-string"><span class="hljs-string">""</span></span> : Exception setting <span class="hljs-string"><span class="hljs-string">"OutputEncoding"</span></span>: <span class="hljs-string"><span class="hljs-string">"The handle is invalid."</span></span> &amp; cmd /c ver | Out-Null $encoding = [Console]::OutputEncoding [Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding(<span class="hljs-string"><span class="hljs-string">"cp866"</span></span>) try { Write-Verbose <span class="hljs-string"><span class="hljs-string">"RunConsole: Console.OutputEncoding mode"</span></span> &amp;$scriptBlock <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } finally { [Console]::OutputEncoding = $encoding } } function ConvertTo-Encoding ([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$From, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$To) { Begin { $encFrom = [System.Text.Encoding]::GetEncoding($from) $encTo = [System.Text.Encoding]::GetEncoding($to) } Process { $bytes = $encTo.GetBytes($_) $bytes = [System.Text.Encoding]::Convert($encFrom, $encTo, $bytes) $encTo.GetString($bytes) } } Write-Verbose <span class="hljs-string"><span class="hljs-string">"RunConsole: Pipline mode"</span></span> &amp;$scriptBlock | ConvertTo-Encoding cp866 windows<span class="hljs-number"><span class="hljs-number">-1251</span></span> } RunConsole { &amp; $PSScriptRoot\ConsoleApp1.exe }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/15a/4d9/218/15a4d9218b5346ad98c9b4ac84dd24c8.png"><br></div></div><br>  It seems that the problem has been solved, but we will continue the study and complicate our console application by adding output to stdError. <br><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/c81/5ca/99e/c815ca99e22e45548b45571eec510387.png"><br></div></div><br>  It becomes more fun :) In ISE, the execution of the script was interrupted in the middle, and through WinRM, not only was it interrupted, it is also impossible to read the message from stdErr.  The first step is to solve the problem with stopping the application launched from the script, to do this, before starting the application, change the value of the global variable $ ErrorActionPreference. <br><br><div class="spoiler">  <b class="spoiler_title">test7.ps1</b> <div class="spoiler_text"><pre> <code class="hljs mel">$ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> #$VerbosePreference = <span class="hljs-string"><span class="hljs-string">"Continue"</span></span> function RunConsole($scriptBlock) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>([Environment]::UserInteractive) { #   <span class="hljs-string"><span class="hljs-string">""</span></span> : Exception setting <span class="hljs-string"><span class="hljs-string">"OutputEncoding"</span></span>: <span class="hljs-string"><span class="hljs-string">"The handle is invalid."</span></span> &amp; cmd /c ver | Out-Null $encoding = [Console]::OutputEncoding [Console]::OutputEncoding = [System.Text.Encoding]::GetEncoding(<span class="hljs-string"><span class="hljs-string">"cp866"</span></span>) try { Write-Verbose <span class="hljs-string"><span class="hljs-string">"RunConsole: Console.OutputEncoding mode"</span></span> $prevErrAction = $ErrorActionPreference $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Continue"</span></span> try { &amp;$scriptBlock <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } finally { $ErrorActionPreference = $prevErrAction } } finally { [Console]::OutputEncoding = $encoding } } function ConvertTo-Encoding ([<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$From, [<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>]$To) { Begin { $encFrom = [System.Text.Encoding]::GetEncoding($from) $encTo = [System.Text.Encoding]::GetEncoding($to) } Process { $bytes = $encTo.GetBytes($_) $bytes = [System.Text.Encoding]::Convert($encFrom, $encTo, $bytes) $encTo.GetString($bytes) } } Write-Verbose <span class="hljs-string"><span class="hljs-string">"RunConsole: Pipline mode"</span></span> $prevErrAction = $ErrorActionPreference $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Continue"</span></span> try { &amp;$scriptBlock | ConvertTo-Encoding cp866 windows<span class="hljs-number"><span class="hljs-number">-1251</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } finally { $ErrorActionPreference = $prevErrAction } } RunConsole { &amp; $PSScriptRoot\ConsoleApp2.exe } Write-Host <span class="hljs-string"><span class="hljs-string">"ExitCode = $LASTEXITCODE"</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/e01/bea/6cc/e01bea6ccf394a1cabf2b67b1a1ebaea.png"><br></div></div><br><div class="spoiler">  <b class="spoiler_title">For those that know about the existence of the -ErrorAction parameter</b> <div class="spoiler_text">  error.cmd <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">echo</span></span> <span class="hljs-literal"><span class="hljs-literal">error</span></span> message <span class="hljs-number"><span class="hljs-number">1</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">2</span></span></code> </pre><br>  errorActionTest.ps1 <br><pre> <code class="hljs mel">#<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>.cmd #echo <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> message <span class="hljs-number"><span class="hljs-number">1</span></span>&gt;&amp;<span class="hljs-number"><span class="hljs-number">2</span></span> #errorActionTest.ps1 $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> Write-Host <span class="hljs-string"><span class="hljs-string">"before"</span></span> Invoke-Expression -ErrorAction SilentlyContinue -Command $PSScriptRoot\<span class="hljs-keyword"><span class="hljs-keyword">error</span></span>.cmd Write-Host <span class="hljs-string"><span class="hljs-string">"after"</span></span></code> </pre><br>  What will be the result of such a script? <br></div></div><br>  The second step is to modify the remote launch script via WinRM so that it does not crash: <br><br><div class="spoiler">  <b class="spoiler_title">remote2.ps1</b> <div class="spoiler_text"><pre> <code class="hljs php">param($script) $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> $s = <span class="hljs-keyword"><span class="hljs-keyword">New</span></span>-PSSession <span class="hljs-string"><span class="hljs-string">"."</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { $path = <span class="hljs-string"><span class="hljs-string">"$PSScriptRoot\$script"</span></span> $err = @() $r = Invoke-Command -Session $s -ErrorAction <span class="hljs-keyword"><span class="hljs-keyword">Continue</span></span> -ErrorVariable err -ScriptBlock ` { $ErrorActionPreference = <span class="hljs-string"><span class="hljs-string">"Stop"</span></span> &amp; $using:path | Out-Host <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $true } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($r -ne $true) { Write-Error <span class="hljs-string"><span class="hljs-string">"The remote script was completed with an error"</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>($err.length -ne <span class="hljs-number"><span class="hljs-number">0</span></span>) { Write-Warning <span class="hljs-string"><span class="hljs-string">"Error occurred on remote host"</span></span> } } <span class="hljs-keyword"><span class="hljs-keyword">finally</span></span> { Remove-PSSession -Session $s }</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Execution result</b> <div class="spoiler_text"><img src="https://habrastorage.org/files/3b0/eda/eae/3b0edaeaef964c9e90be77cce49e3c68.png"><br></div></div><br>  And the only thing left is to correct the message generated by stdErr and not to change its position in the log.  In the process of solving this task, colleagues suggested creating a console on their own, using the win api AllocConsole function. <br><br><div class="spoiler">  <b class="spoiler_title">test8.ps1</b> <div class="spoiler_text"><pre> <code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$E</span></span>rrorActionPreference = <span class="hljs-comment"><span class="hljs-comment">"Stop"</span></span> #<span class="hljs-string"><span class="hljs-string">$V</span></span>erbosePreference = <span class="hljs-comment"><span class="hljs-comment">"continue"</span></span> <span class="hljs-string"><span class="hljs-string">$c</span></span>onsoleAllocated = [<span class="hljs-type"><span class="hljs-type">Environment</span></span>]::<span class="hljs-type"><span class="hljs-type">UserInteractive</span></span> function <span class="hljs-type"><span class="hljs-type">AllocConsole</span></span>() { if(<span class="hljs-string"><span class="hljs-string">$G</span></span>lobal:consoleAllocated) { return } &amp;cmd /c ver | <span class="hljs-type"><span class="hljs-type">Out</span></span>-<span class="hljs-type"><span class="hljs-type">Null</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span> = @<span class="hljs-string"><span class="hljs-string">' [DllImport("kernel32", SetLastError = true)] public static extern bool AllocConsole(); '</span></span>@ <span class="hljs-string"><span class="hljs-string">$p</span></span>arams = <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Object</span></span> <span class="hljs-type"><span class="hljs-type">CodeDom</span></span>.<span class="hljs-type"><span class="hljs-type">Compiler</span></span>.<span class="hljs-type"><span class="hljs-type">CompilerParameters</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>arams.<span class="hljs-type"><span class="hljs-type">MainClass</span></span> = <span class="hljs-comment"><span class="hljs-comment">"methods"</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>arams.<span class="hljs-type"><span class="hljs-type">GenerateInMemory</span></span> = <span class="hljs-string"><span class="hljs-string">$t</span></span>rue <span class="hljs-string"><span class="hljs-string">$p</span></span>arams.<span class="hljs-type"><span class="hljs-type">CompilerOptions</span></span> = <span class="hljs-comment"><span class="hljs-comment">"/unsafe"</span></span> <span class="hljs-string"><span class="hljs-string">$r</span></span> = <span class="hljs-type"><span class="hljs-type">Add</span></span>-<span class="hljs-type"><span class="hljs-type">Type</span></span> -<span class="hljs-type"><span class="hljs-type">MemberDefinition</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> methods -<span class="hljs-type"><span class="hljs-type">Namespace</span></span> kernel32 -<span class="hljs-type"><span class="hljs-type">PassThru</span></span> -<span class="hljs-type"><span class="hljs-type">CompilerParameters</span></span> <span class="hljs-string"><span class="hljs-string">$p</span></span>arams <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-comment"><span class="hljs-comment">"Allocating console"</span></span> [kernel32.methods]::<span class="hljs-type"><span class="hljs-type">AllocConsole</span></span>() | <span class="hljs-type"><span class="hljs-type">Out</span></span>-<span class="hljs-type"><span class="hljs-type">Null</span></span> <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Verbose</span></span> <span class="hljs-comment"><span class="hljs-comment">"Console allocated"</span></span> <span class="hljs-string"><span class="hljs-string">$G</span></span>lobal:consoleAllocated = <span class="hljs-string"><span class="hljs-string">$t</span></span>rue } function <span class="hljs-type"><span class="hljs-type">RunConsole</span></span>(<span class="hljs-string"><span class="hljs-string">$s</span></span>criptBlock) { <span class="hljs-type"><span class="hljs-type">AllocConsole</span></span> <span class="hljs-string"><span class="hljs-string">$e</span></span>ncoding = [<span class="hljs-type"><span class="hljs-type">Console</span></span>]::<span class="hljs-type"><span class="hljs-type">OutputEncoding</span></span> [<span class="hljs-type"><span class="hljs-type">Console</span></span>]::<span class="hljs-type"><span class="hljs-type">OutputEncoding</span></span> = [<span class="hljs-type"><span class="hljs-type">System</span></span>.<span class="hljs-type"><span class="hljs-type">Text</span></span>.<span class="hljs-type"><span class="hljs-type">Encoding</span></span>]::<span class="hljs-type"><span class="hljs-type">GetEncoding</span></span>(<span class="hljs-comment"><span class="hljs-comment">"cp866"</span></span>) <span class="hljs-string"><span class="hljs-string">$p</span></span>revErrAction = <span class="hljs-string"><span class="hljs-string">$E</span></span>rrorActionPreference <span class="hljs-string"><span class="hljs-string">$E</span></span>rrorActionPreference = <span class="hljs-comment"><span class="hljs-comment">"Continue"</span></span> try { &amp; <span class="hljs-string"><span class="hljs-string">$s</span></span>criptBlock } finally { <span class="hljs-string"><span class="hljs-string">$E</span></span>rrorActionPreference = <span class="hljs-string"><span class="hljs-string">$p</span></span>revErrAction [<span class="hljs-type"><span class="hljs-type">Console</span></span>]::<span class="hljs-type"><span class="hljs-type">OutputEncoding</span></span> = <span class="hljs-string"><span class="hljs-string">$e</span></span>ncoding } } <span class="hljs-type"><span class="hljs-type">RunConsole</span></span> { &amp; <span class="hljs-string"><span class="hljs-string">$P</span></span>SScriptRoot\<span class="hljs-type"><span class="hljs-type">ConsoleApp2</span></span>.exe } <span class="hljs-type"><span class="hljs-type">Write</span></span>-<span class="hljs-type"><span class="hljs-type">Host</span></span> <span class="hljs-comment"><span class="hljs-comment">"ExitCode = $LASTEXITCODE"</span></span></code> </pre><br></div></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/57f/8e2/79a/57f8e279ab7140658af997c867b88c15.png"></div><br>  I would not get rid of the information that powershell adds to stdErr. <br><br>  I hope that this information will be useful not only for me!  :) <br><br>  <b>update 1</b> <br>  In some usage scenarios, an additional console was created, into which the result of executing the scripts was issued.  The test8.ps1 script has been fixed. <br><br>  <b>update 2</b> <br>  Since many commentators of the article have a confusion between the concepts of character set (char set) and encoding, I would like to once again note that the article solves the problem of precisely the inconsistency between console encodings and the application being called. <br><br>  As you can see from the test8.ps1 script, the encoding is specified in the static [Console] :: OutputEncoding property, and no one bothers to specify one of the unicode encodings in it: <br><pre> <code class="hljs pgsql">[Console]::OutputEncoding = [<span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.Text.<span class="hljs-keyword"><span class="hljs-keyword">Encoding</span></span>]::GetEncoding("utf-8")</code> </pre><br>  But, for the script to work in the standard windows console (aka cmd.exe), you need to change the console font from the standard ‚ÄúRasters Fonts‚Äù to Consolas or ‚ÄúLucida Console‚Äù.  If we used these scripts only on our own workstations or servers, such a change would be acceptable, but since we have to distribute our solutions to customers, we have no right to interfere with the system settings of the servers.  It is for this reason that cp866 is used in scripts as the default encoding for the console. </div><p>Source: <a href="https://habr.com/ru/post/321076/">https://habr.com/ru/post/321076/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../321066/index.html">Complex neural network based on the Fourier series of a function of many variables</a></li>
<li><a href="../321068/index.html">Roskomnadzor for the Bitcoin ban in Russia</a></li>
<li><a href="../321070/index.html">Perspectives of HR robots / bots in the field of staff recruitment - current realities, opinions and experience of experts</a></li>
<li><a href="../321072/index.html">85% of employees scores on project management systems. How do we do our</a></li>
<li><a href="../321074/index.html">sudo rm -rf, or Chronicle of the incident with the database GitLab.com from 2017/01/31</a></li>
<li><a href="../321078/index.html">Friday JS: How to be inspired by Smalltalk and go to hell</a></li>
<li><a href="../321082/index.html">Friday format: Is there life after the meeting?</a></li>
<li><a href="../321086/index.html">Physics of trains in Assassin's Creed Syndicate</a></li>
<li><a href="../321088/index.html">Network Controller: software-defined networks in Windows Server 2016. Part 1: features and services</a></li>
<li><a href="../321092/index.html">What Xamarin developers should know at the beginning of 2017</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>