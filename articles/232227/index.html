<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>CentOS 7 Review. Part 4: Mitigate TCP SYN Flood DDoS attacks. Test in the cloud for free</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the first part of the CentOS 7 review, we talked about Linux container support in Cent OS 7. In the second part, we talked about identity managemen...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>CentOS 7 Review. Part 4: Mitigate TCP SYN Flood DDoS attacks. Test in the cloud for free</h1><div class="post__text post__text-html js-mediator-article">  In the first part of the CentOS 7 review, we talked about <a href="http://habrahabr.ru/company/infobox/blog/230513/">Linux container support</a> in Cent OS 7. In the second part, we talked about <a href="http://habrahabr.ru/company/infobox/blog/230781/">identity management</a> .  In the third part of the review we touched the <a href="http://habrahabr.ru/company/infobox/blog/231955/">network file system NFS and its environment</a> .  In this article we will talk about mitigating DDoS attacks TCP SYN Flood.  At the end of the post link to the free testing of CentOS 7 in the <a href="http://infoboxcloud.ru/">cloud VPS</a> from Infobox. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/fcc/210/e21/fcc210e2103292bb21031dc162ba2904.png" width="300"><br><br>  DDoS (Distributed Denial of Service) attacks are becoming more frequent, due to the fact that the business is becoming increasingly dependent on the Internet.  One of the most common types of DDoS is the SYN Flood.  This main attack of end hosts puts your server to its knees.  As a result, your server cannot correctly handle incoming requests. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It is important to note that the described protection mechanisms are available in CentOS 7, but are not enabled by default. <br><a name="habracut"></a><br><h4>  Why SYN-flood - pain for the core </h4><br>  The main problem of TCP scalability for the Linux kernel is related to how many new connections can be created in a second.  This refers to blocking on a socket in the "listen" state.  Estabilished (Installed) connections scale very well.  The ‚Äúlisten‚Äù state lock is encountered not only with SYN ‚Äì packets, but also with other packets for the initial connection of ‚ÄúSYN-ACK‚Äù and ‚ÄúACK‚Äù (triple handshake packets in TCP).  In a flood attack scenario, we need a filtering mechanism for fake connection attempts before the socket enters the ‚Äúlisten‚Äù state and blocks new incoming connections. <br><br><h4>  Basics of filtering conntrack </h4><br>  Using Netfilter's connection tracking system (conntrack), we can start filtering spurious SYN-ACK and ACK packets before they cause a blocking ‚Äúlisten‚Äù state.  This was possible for a long time, but was not enabled by default. <br><br>  The following two commands will help you: <br><pre><code class="bash hljs">iptables -A INPUT -m state --state INVALID -j DROP /sbin/sysctl -w net/netfilter/nf_conntrack_tcp_loose=0</code> </pre> <br>  The rule for iptables will catch packets that the connection tracking system has classified as ‚ÄúINVALID‚Äù and not part of known connection states. <br><br>  Configuring sysctl will make the connection tracking system more stringent in categorization and help avoid, including ACK-flood attacks. <br><br><h4>  What about performance? </h4><br>  As a result, we will reduce the effect of attacks based on SYN ‚Äì ACK and ACK 20 times. <br><br>  Conntrack in Netfilter has a bad reputation for low speed, but it was the first time after the advent of technology.  It now offers superior scalability and runs very fast.  Conntrack works without locks, using <a href="http://en.wikipedia.org/wiki/Read-copy-update">RCU</a> (update via copy) for existing connections. <br><br>  In essence, this will prevent problems from all flooding TCP packets except SYN. <br><br><h4>  Why it does not work with SYN-flood? </h4><br>  In conntrack there is a scalability problem (similar to the ‚Äúlisten‚Äù blocking) that occurs when it comes to creating (or deleting) connections that SYN flood causes. <br><br>  Even after configuring the contrack SYN packets will be sent to the socket causing a ‚Äúlisten‚Äù blocking.  The method of mitigating this attack is to send a SYN ‚Äì cookie and prevent the creation of any status until the SYN ‚Äì ACK is visible. <br><br>  Unfortunately, SYN ‚Äì cookies are sent under the same ‚Äúlisten‚Äù blocking, so this mitigation will not solve the scalability problem.  We will discuss how to get around this restriction a bit later. <br><br><h4>  What's new in CentOS 7 </h4><br>  At <a href="http://workshop.netfilter.org/2013/">Netfilter Workshop 2013</a> , the idea of ‚Äã‚Äã‚Äúnetwork countermeasures‚Äù was proposed.  This gave birth to the iptables SYNPROXY module and the corresponding changes in the Netfilter core.  Now this functionality is available in CentOS 7. <br><br>  The SYNPROXY module is designed to solve two problems with scalability.  Firstly, it works with SYN ‚Äì cookies in parallel.  Secondly, it does not create a conntrack until it receives a SYN ‚Äì ACK packet, which allows conntrack not to block new connections. <br><br>  SYNPROXY can be used on the local host or can protect other hosts behind the firewall.  As soon as the initial connection is established, conntrack will take over all necessary translations (by reusing parts of the NAT code). <br><br>  Testing on connections to localhost showed a 10-fold increase in productivity to mitigate SYN ‚Äì attacks. <br><br><h4>  SYNPROXY setting </h4><br>  Setting up SYNPROXY can be quite complicated without a manual.  This article covers the necessary steps, but you can use the <a href="">0</a> and <a href="">script</a> to simplify the configuration. <br><br>  This example can be used to protect a web server on port 80. <br><br><h6>  Step 1 </h6><br>  Make sure that the connections we protect do not create a conntrack for SYN packets. <br><pre> <code class="bash hljs">iptables -t raw -I PREROUTING -i <span class="hljs-variable"><span class="hljs-variable">$DEV</span></span> -p tcp -m tcp --syn --dport <span class="hljs-variable"><span class="hljs-variable">$PORT</span></span> -j CT --notrack</code> </pre><br><h6>  Step 2 </h6><br>  We include a stricter conntrack.  This is necessary in order to have INVALID status for bad ACK packets. <br><pre> <code class="bash hljs">/sbin/sysctl -w net/netfilter/nf_conntrack_tcp_loose=0</code> </pre><br><h6>  Step 3 </h6><br>  Now we need to process these packets and transfer them directly to the SYNPROXY module.  To do this, use the UNTRACKED SYN and INVALID processing rule for packets that contain ACKs from the triple handshake (and others, but they will simply pass through this rule): <br><pre> <code class="bash hljs">iptables -A INPUT -i <span class="hljs-variable"><span class="hljs-variable">$DEV</span></span> -p tcp -m tcp --dport <span class="hljs-variable"><span class="hljs-variable">$PORT</span></span> -m state --state INVALID,UNTRACKED -j SYNPROXY --sack-perm --timestamp --wscale 7 --mss 1460</code> </pre><br><h6>  Step 4 </h6><br>  Catch the packages with the state of INVALID, which fell into SYNPROXY and destroy them.  This will prevent flood SYN ‚Äì ACK. <br><pre> <code class="bash hljs">iptables -A INPUT -m state --state INVALID -j DROP</code> </pre><br><h6>  Step 5 </h6><br>  Remember to include TCP timestamps.  SYN ‚Äì cookies use this TCP field. <br><pre> <code class="bash hljs">/sbin/sysctl -w net/ipv4/tcp_timestamps=1</code> </pre><br><h6>  Step 6 </h6><br>  If you have a busy site, it is recommended to configure conntrack to increase the limit of 64 thousand connections.  Also increase the size of the conntrack hash.  This is very important for performance. <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> 1000000 &gt; /sys/module/nf_conntrack/parameters/hashsize /sbin/sysctl -w net/netfilter/nf_conntrack_max=2000000</code> </pre><br>  You must set a limit value that is relevant to your site and calculate the memory usage for it.  For example, 2,000,000 entries at a time of 288 bytes = maximum of 576 MB of potential memory usage.  For the hash, each head of the hash table only takes 8 bytes per million records = 8 MB of fixed allocated memory (remember the size of your L3 cache on the CPU when you select the cache value).  You can find out which processor is used on the host with the command: <br><pre> <code class="bash hljs">cat /proc/cpuinfo</code> </pre><br><br><h4>  SYNPROXY Considerations </h4><br>  The inclusion of SYNPROXY may not pass unnoticed.  Connection setup will be slower due to the advanced connection setup required by the end host.  When the end host is local, everything happens very quickly and hardly adds delays. <br><br>  The SYNPROXY module parameters must match the TCP options and must be supported by the end host for which the TCP connection is proxied.  The detection and configuration is done manually based on the rules (the useful tool ‚Äúnfsynproxy‚Äù is part of the iptables 1.4.21 release).  Unfortunately, this means that the module cannot simply be deployed firewalls on DHCP. <br><br>  In the future, there are plans to auto-detect the TCP options for end hosts.  <a href="https://bugzilla.redhat.com/show_bug.cgi%3Fid%3D1059679">Vote for the feature</a> in the Red Hat bug tracker. <br><br>  Sources used in the preparation of the article: <br>  <a href="http://rhelblog.redhat.com/2014/04/11/mitigate-tcp-syn-flood-attacks-with-red-hat-enterprise-linux-7-beta/">Mitigate TCP SYN Flood Attacks</a> <br>  <a href="http://rhelblog.redhat.com/">RedHat official blog</a> <br>  <a href="https://access.redhat.com/knowledgebase">RedHat Knowledge Base</a> <br>  <a href="http://seven.centos.org/">CentOS Official Blog</a> <br><br><h6>  Try CentOS 7 in the cloud </h6><br>  Especially for our readers, we provided the opportunity to try CentOS 7 <a href="http://infobox.ru/vps/cloud/">on a cloud-based VPS</a> from Infobox in Amsterdam.  Register the trial version for 15 days <a href="https://store.pa.infobox.ru/index.php%3Fredirect%3Dcloud_2048_trial">via this link</a> .  If you need more resources for testing than in the trial version - write to <a href="">trukhinyuri@infoboxcloud.com</a> </div><p>Source: <a href="https://habr.com/ru/post/232227/">https://habr.com/ru/post/232227/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232213/index.html">Can big data analysis help save the lives of patients?</a></li>
<li><a href="../232217/index.html">D # is a programming language for Doge fans.</a></li>
<li><a href="../232219/index.html">AngularJS: we configure event of initialization</a></li>
<li><a href="../232221/index.html">Rosetta - 2 days to comet Churyumov-Gerasimenko</a></li>
<li><a href="../232223/index.html">Useful resources for the game designer</a></li>
<li><a href="../232229/index.html">Injecting React JS into an Angular JS app or fighting for performance</a></li>
<li><a href="../232231/index.html">What is the work day of an IT engineer, if you are a girl</a></li>
<li><a href="../232233/index.html">Sony will no longer release e-books. The end of another era</a></li>
<li><a href="../232235/index.html">Origami Aircraft and Radio Control: PowerUP 3.0 Project Goes Into People</a></li>
<li><a href="../232237/index.html">Last day of registration for the three-day program ‚ÄúCreating a global IT startup-a‚Äù</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>