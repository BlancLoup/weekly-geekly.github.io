<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Database Encryption Running Firebird 3.0</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the modern information world, information plays a significant role in the life of a person, society and the state. The growing size of the accumula...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Database Encryption Running Firebird 3.0</h1><div class="post__text post__text-html js-mediator-article">  In the modern information world, information plays a significant role in the life of a person, society and the state.  The growing size of the accumulated and processed data raises questions about their storage and privacy.  Already there are many technical solutions and proposals for solving such problems.  Among them, of course, there are also database management systems (DBMS) that support encryption of stored data.  That's about one of these solutions and will be discussed. <br><div style="text-align:center;"><img src="https://habrastorage.org/web/8c1/3a2/f82/8c13a2f82275455caa470824e52381cb.png"></div><br>  In April 2016, a new version of <a href="https://ru.wikipedia.org/wiki/Firebird">Firebird DBMS</a> was released at number 3. Of the innovations, among other things, quite a few mechanisms appeared to protect the stored and transmitted data.  There is also the protection of the data transmission channel, there is the management of users, and there is also encryption of the database itself, which is implemented as transparent encryption at the level of data pages.  This is implemented by writing special extensions for Firebird.  Of course, you can figure it out yourself and write these extensions, but why not take the <a href="https://cipher.kiev.ua/ru/products/modul_shifrovaniya_dannyh_dlya_subd_firebird">existing ones</a> .  Moreover, to write, at a minimum, you need to understand cryptography, be armed with the knowledge of some cryptographic package and deal with the new C ++ Firebird API. <br><a name="habracut"></a><br>  You can use the existing ready-made solution by downloading this <a href="">link</a> for the Windows x64 platform.  In the free trial version, it is limited to the encryption algorithm used ‚Äî <a href="https://ru.wikipedia.org/wiki/Triple_DES">Triple DES (3DES)</a> is supported.  But to protect your database this is quite enough.  The package includes 4 libraries and files with interface descriptions. <br><table><tbody><tr><th>  File Name </th><th>  Description </th></tr><tr><td>  CiKeyHolder.dll </td><td>  Firebird extension - secret key keeper </td></tr><tr><td>  CiDbCrypt.dll </td><td>  Firebird extension - data encryption </td></tr><tr><td>  CiFbEnc_x86.dll </td><td>  encryption key activation module for 32 bit platform. </td></tr><tr><td>  CiFbEnc_x86-64.dll </td><td>  encryption key activation module for 64 bit platform. </td></tr><tr><td>  ICiFbEncActivator.h </td><td>  description of the interface module for C + + </td></tr><tr><td>  CI.ICiFbEncActivator.pas </td><td>  description of the interface module for Delphi </td></tr></tbody></table>  As an example, you can write an application that uses a certain directory (conditionally with confidential data), which as an update is available via a link in the global network.  Anyone can download it, but only our application can decrypt and work with it. <br><br>  In order not to litter the article with unnecessary details of the implementation of such a task, in which it is necessary to ensure that the key is received and the database file is updated, we will assume that this is, and the key will simply be encrypted as a variable array and the database file will be encrypted using this key. <br><br>  Let us take Windows 10 x64 OS as the platform, and use IDE Embarcadero RAD Studio as the task implementation tools (currently Tokyo version 10.2 is a 30-day trial), since it contains convenient components for working with the Firebird database and is often used to develop application solutions (a trial version can be <a href="https://www.embarcadero.com/ru/products/rad-studio/start-for-free">downloaded from the link</a> ) and <a href="https://sourceforge.net/projects/firebird/files/firebird-win64/3.0.2-Release/Firebird-3.0.2.32703_0_x64.exe/download">Firebird 3.0.2 x64 DBMS</a> , which can be downloaded from <a href="https://www.firebirdsql.org/en/firebird-3-0-2/">https://www.firebirdsql.org/en/firebird-3-0-2</a> for its platform.  Since we do not need a constantly running server in development mode, and it may need to be restarted repeatedly, during installation we choose the way to start the server as an application. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div style="text-align:center;"><img src="https://habrastorage.org/web/388/cf0/177/388cf01770014bb185d3d644c8943458.png" alt="Install Firebird"></div><br>  The password for <code>SYSDBA</code> done in the old-fashioned way <code>masterkey</code> and unchecking the box responsible for starting the server after installation is not necessary. <br><br>  After the Firebird package has been installed, it is necessary to configure it.  If you plan to use Firebird in Embedded mode, then the same settings will need to be done in the directory where the library used by the client fbclient.dll will be located.  The base configuration files are located in the root directory of the installed Firebird - <code>%ProgramW6432%\Firebird\Firebird_3_0</code> . <br><br>  Let us write the alias (alias) of the database in the databases.conf file, adding a line indicating the full path to the future database: <br><br><pre> <code class="dos hljs">TESTDB = C:\TESTAPP\DB\TESTDB.FDB</code> </pre> <br>  In order for Firebird to know where to look for keys, it is necessary to define the <code>KeyHolderPlugin</code> parameter.  It can be specified either specifically for the above-described alias or in the firebird.conf file.  Add or change the configuration parameter of the firebird.conf file, defining the plug-in the keeper of the private key: <br><br><pre> <code class="dos hljs">KeyHolderPlugin = CiKeyHolder</code> </pre> <br>  Where to look for plugins Firebird also learns from configuration files.  Modify the plugins.conf file by adding the following lines: <br><br><pre> <code class="dos hljs">Plugin = CiKeyHolder { #      Module = $(dir_plugins)/CiKeyHolder } Plugin = CiDbCrypt { #      Module = $(dir_plugins)/CiDbCrypt }</code> </pre> <br>  The directory under the pseudonym $ (dir_plugins) implies the plugins directory in the root directory of Firebird.  We copy there previously downloaded plugins CiKeyHolder.dll and CiDbCrypt.dll. <br><br>  Since we assume that we already have a database, we will create it with the means of the Firebird package, namely, using the isql application.  Click <code>Win + R</code> and execute the following command: <br><br><pre> <code class="dos hljs"><span class="hljs-variable"><span class="hljs-variable">%ProgramW6432%</span></span>\Firebird\Firebird_3_0\isql -q -user SYSDBA -password masterkey</code> </pre> <br>  Or somehow we launch isql in a different way, for example, using the Far program. <br><br>  The following commands will create a TESTDB database, an alias of which was previously registered in the settings and will display information about the created database: <br><br><pre> <code class="sql hljs">SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">database</span></span> <span class="hljs-string"><span class="hljs-string">'TESTDB'</span></span>; SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> t_1 (i1 <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>, s1 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>), s2 <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">15</span></span>)); SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> t_1 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-string"><span class="hljs-string">'value 1-1'</span></span>,<span class="hljs-string"><span class="hljs-string">'value 1-2'</span></span>); SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> t_1 <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">2</span></span>,<span class="hljs-string"><span class="hljs-string">'value 2-1'</span></span>,<span class="hljs-string"><span class="hljs-string">'value 2-2'</span></span>); SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">commit</span></span>; SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t_1; I1 S1 S2 ============ =============== =============== 1 value 1-1 value 1-2 2 value 2-1 value 2-2 SQL&gt; <span class="hljs-keyword"><span class="hljs-keyword">show</span></span> db; Database: TESTDB Owner: SYSDBA PAGE_SIZE 8192 Number of DB pages allocated = 196 Number of DB pages used = 184 Number of DB pages free = 12 Sweep interval = 20000 Forced Writes are ON Transaction - oldest = 4 Transaction - oldest active = 5 Transaction - oldest snapshot = 5 Transaction - Next = 9 ODS = 12.0 Database not encrypted Default Character <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">NONE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SQL</span></span>&gt; quit;</code> </pre> <br>  As can be seen from the information received by the <code>show db;</code> command <code>show db;</code>  database created is not currently encrypted - <code>Database not encrypted</code> . <br><br>  Now everything is set up and you can start writing the application. <br><br>  Create a new VCL Forms Application project in IDE Embarcadero RAD Studio.  Save the project, for example, as a testapp in the C: \ TESTAPP directory. <br><br>  For a start, we can simply associate our application with a database, providing connectivity and disconnection to it.  Our test database has one table, the data of which can be displayed upon connection.  From the visual design is enough a couple of buttons, a table and a navigator with data management.  To access the Firebird database, use the FireDAC components.  Below is a table with components and their customizable parameters. <br><table><caption>  Components placed on the test application form </caption><tbody><tr><th>  Component class </th><th>  Component Name </th><th>  Parameter </th><th>  Parameter value </th></tr><tr><td>  TFDPhysFBDriverLink </td><td>  FDPhysFBDriverLink1 </td><td>  - </td><td>  - </td></tr><tr><td rowspan="7">  Tfdconnection </td><td rowspan="7">  FDConnection1 </td><td>  Drivername </td><td>  Fb </td></tr><tr><td>  LoginPrompt </td><td>  False </td></tr><tr><td>  Params \ Database </td><td>  TESTDB </td></tr><tr><td>  Params \ UserName </td><td>  Sysdba </td></tr><tr><td>  Params \ Password </td><td>  masterkey </td></tr><tr><td>  Params \ Protocol </td><td>  ipTCPIP </td></tr><tr><td>  Params \ Server </td><td>  localhost </td></tr><tr><td>  TFDGUIxWaitCursor </td><td>  FDGUIxWaitCursor1 </td><td>  - </td><td>  - </td></tr><tr><td>  TFDTransaction </td><td>  FDTransaction1 </td><td>  - </td><td>  - </td></tr><tr><td>  Tfdtable </td><td>  FDTable1 </td><td>  Tablename </td><td>  T_1 </td></tr><tr><td>  TDataSource </td><td>  DataSource1 </td><td>  Dataset </td><td>  FDTable1 </td></tr><tr><td>  TDBGrid </td><td>  DBGrid1 </td><td>  Datasource </td><td>  DataSource1 </td></tr><tr><td>  TDBNavigator </td><td>  DBNavigator1 </td><td>  Datasource </td><td>  DataSource1 </td></tr><tr><td>  Tbutton </td><td>  Button1 </td><td>  Caption </td><td>  Connect </td></tr><tr><td>  Tbutton </td><td>  Button2 </td><td>  Caption </td><td>  Disconnect </td></tr></tbody></table>  As a result, the form may look something like this. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/1c2/2f5/d0b/1c22f5d0b5e84c358f33515fa8f498db.png" alt="Form in the design environment designer"></div><br>  Let's write down the processing of clicking on the ‚ÄúConnect‚Äù button: <br><br><pre> <code class="cpp hljs">FDConnection1-&gt;Connected = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; FDTable1-&gt;Active = <span class="hljs-literal"><span class="hljs-literal">true</span></span>;</code> </pre> <br>  And for ‚ÄúDisconnect‚Äù: <br><br><pre> <code class="cpp hljs">FDTable1-&gt;Active = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; FDConnection1-&gt;Connected = <span class="hljs-literal"><span class="hljs-literal">false</span></span>;</code> </pre> <br>  In the case of Delphi, everything is the same: <br><br><pre> <code class="delphi hljs">FDConnection1.Connected := True; FDTable1.Active := True; . . . FDConnection1.Connected := False; FDTable1.Active := False;</code> </pre> <br>  Before you connect to the database, you must start the server.  To do this, call the administrator command line: <br><br> <code>Win + X ‚Üí   ()</code> <br> <br>  And execute the command: <br><br> <code>‚Äú%ProgramW6432%\Firebird\Firebird_3_0\firebird‚Äù ‚Äìa</code> <br> <br>  The tray icon appears running server.  From the context menu called above this icon, you can complete its operation or view the properties of the running server. <br><br>  Now you can build and run the application to test connectivity to the database.  After connecting to the database, the table displays the data. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/82a/01a/a7b/82a01aa7b6c94a12a3356855fd5fdada.png" alt="Successful connection to the database"></div><br>  It is time to connect the key activation and encryption control module to our application.  To do this, copy the files CiFbEnc_x86.dll and ICiFbEncActivator.h, CI.ICiFbEncActivator.pas to the directory C: \ TESTAPP.  It is worth noting that since a project is created under 32-bit Windows by default in the development environment and the trial version of the development environment does not allow changing the target platform, the application needs the CiFbEnc_x86.dll file module. <br><br>  Connect the header file with the description of the activation module interface to the application file: <br><br><pre> <code class="cpp hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">include</span></span></span><span class="hljs-meta"> </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"ICiFbEncActivator.h"</span></span></span></span></code> </pre> <br>  Or the Ci.ICiFbEncActivator.pas file for Delphi. <br><br><pre> <code class="delphi hljs"><span class="hljs-keyword"><span class="hljs-keyword">uses</span></span> . . . , CI.ICiFbEncActivator;</code> </pre> <br>  Add three more buttons to the form: ‚ÄúEncrypt‚Äù, ‚ÄúDecrypt‚Äù and ‚ÄúGet State‚Äù. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/ca4/4a5/db8/ca44a5db8ab94eb6b7fda00b022f84bf.png" alt="Additional buttons to launch module operations"></div><br>  First, consider the ‚ÄúGet State‚Äù button handler.  What follows from the name, it will give us the opportunity to get the current state of the database. <br><br>  The most important thing is to get access to the activation module interface.  It can be obtained both for each operation, and globally or by aggregating into a certain object.  In order not to fence the wrapper classes, we will assume that we get the object of the activation module during each operation.  Below is one of the possible ways to do this. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// C++ Builder //   std::unique_ptr&lt;HINSTANCE__, decltype(&amp;::FreeLibrary)&gt; mHandle( ::LoadLibraryEx(L"C:\\TESTAPP\\CiFbEnc_x86.dll",0,LOAD_WITH_ALTERED_SEARCH_PATH), &amp;::FreeLibrary); if (!mHandle) { MessageBox( NULL, L" CiFbEnc_x86.dll        fbclient.dll", L" ", MB_OK|MB_ICONERROR); return; } //   typedef CALL_CONV int(__stdcall *CREATEFUNCPTR)(CI::ICiFbEncActivator**); CREATEFUNCPTR GetActivator = (CREATEFUNCPTR)::GetProcAddress(mHandle.get(), "createCiFBEncActivator"); if (!GetActivator) { MessageBox( NULL, L"     CiFbEnc_x86.dll " "createCiFBEncActivator" " -  ,   tdump.", L" ", MB_OK|MB_ICONERROR); return; } CI::ICiFbEncActivator* pActivator = NULL; GetActivator(&amp;pActivator); if (!pActivator) { ShowMessage("ERROR GetActivator!"); return; } // . . . // //      // // . . . //    pActivator-&gt;Destroy(); pActivator = NULL;</span></span></code> </pre> <br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">// Delphi var pActivator : ICiFbEncActivator; res : Integer; CreateActivator: TActivatorFunction; mHandle : HINST; . . . begin //   mHandle := LoadLibraryEx( PChar('C:\TESTAPP\CiFbEnc_x86.dll'), 0, LOAD_WITH_ALTERED_SEARCH_PATH); if mHandle = 0 then begin MessageBox( Application.Handle, ' CiFbEnc_x86.dll        fbclient.dll', ' ', MB_OK OR MB_ICONERROR); Exit; end; //   CreateActivator := GetProcAddress(mHandle, 'createCiFBEncActivator'); if not Assigned(CreateActivator) then begin MessageBox( Application.Handle, '     CiFbEnc_x86.dll  createCiFBEncActivator' + ' -  ,   tdump.', ' ', MB_OK OR MB_ICONERROR); Exit; end; pActivator := nil; res := CreateActivator(pActivator); if not Assigned(pActivator) then begin ShowMessage('ERROR CreateActivator!'); Exit; end; // . . . // //      // // . . . //    pActivator.Destroy; pActivator := nil; FreeLibrary(mHandle); end;</span></span></code> </pre> <br>  Further we will assume that for each of the handlers for clicking on the button, the above code will be added. <br><br>  Now you can go to getting the state of the database. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// C++ Builder . . . //      pActivator-&gt;SetDBAccess("localhost:TESTDB", "SYSDBA", "masterkey"); // ,       Firebird char stat_buf[1024] = { 0 }; size_t bufsize = sizeof(stat_buf); int res = pActivator-&gt;GetStateSVC(stat_buf, bufsize); String sStatMsg = (String)stat_buf; if (Err_OK == res) { MessageBox(NULL, sStatMsg.c_str(), L" ", MB_OK|MB_ICONINFORMATION); } else { String sErrMsg = L"ERROR GetStateSVC: " + sStatMsg; MessageBox( NULL, sErrMsg.c_str(), L" ", MB_OK|MB_ICONERROR); } . . .</span></span></code> </pre> <br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">// Delphi var . . . stat_buf : array[0..1023] of AnsiChar; bufsize : NativeUInt; . . . //      res := pActivator.SetDBAccess('localhost:TESTDB', 'SYSDBA', 'masterkey'); // ,       Firebird bufsize := SizeOf(stat_buf); ZeroMemory(@stat_buf, bufsize); res := pActivator.GetStateSVC(stat_buf, bufsize); if Err_OK = res then begin MessageBox(Application.Handle, PChar(String(stat_buf)), ' ', MB_OK OR MB_ICONINFORMATION); end else begin MessageBox(Application.Handle, PChar(String(stat_buf)), '', MB_OK OR MB_ICONERROR); end; . . .</span></span></code> </pre> <br>  In case you managed to connect to the database and get information, we will see a message with detailed information about the current state. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/16d/2a8/4f6/16d2a84f63ca45a8a7592b0f31bd0a0a.png" alt="Successful obtaining the current status of the database"></div><br>  As you can see, the database is still not encrypted.  It's time to fix it.  But a key is needed for encryption.  And we define it as a global constant in the framework of the example. <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// C++ Builder //  -     192  const uint8_t key[24] = { 0x06,0xDE,0x81,0xA1,0x30,0x55,0x1A,0xC9, 0x9C,0xA3,0x42,0xA9,0xB6,0x0F,0x54,0xF0, 0xB6,0xF9,0x70,0x18,0x85,0x04,0x83,0xBF };</span></span></code> </pre> <br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">// Delphi const key : array [0..23] of Byte = ( $06,$DE,$81,$A1,$30,$55,$1A,$C9, $9C,$A3,$42,$A9,$B6,$0F,$54,$F0, $B6,$F9,$70,$18,$85,$04,$83,$BF );</span></span></code> </pre> <br>  In addition to obtaining the current state of the database, all other operations, such as encrypt, decrypt and access the encrypted data, require activation of the private key.  To do this, add the following code after receiving the activation module object: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// C++ Builder . . . //      pActivator-&gt;SetDBAccess("localhost:TESTDB", "SYSDBA", "masterkey"); //    int res = pActivator-&gt;SetKey(&amp;key, sizeof(key)); if (Err_OK != res) { ShowMessage("ERROR SetKey!"); pActivator-&gt;Destroy(); return; } //     res = pActivator-&gt;Activate(); if (Err_OK != res) { //   char errmsg[512] = {0}; size_t esize = sizeof(errmsg); pActivator-&gt;GetFBStat(errmsg, esize); String sErrMsg = "ERROR Activate: " + String(errmsg); MessageBox( NULL, sErrMsg.w_str(), L"   ", MB_OK|MB_ICONERROR); pActivator-&gt;Destroy(); return; } . . .</span></span></code> </pre> <br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">// Delphi . . . //      res := pActivator.SetDBAccess('localhost:TESTDB', 'SYSDBA', 'masterkey'); //    res := pActivator.SetKey(@key, Length(key)); if Err_OK &lt;&gt; res then begin ShowMessage('ERROR SetKey!'); pActivator.Destroy; Exit; end; //     res := pActivator.Activate; if Err_OK &lt;&gt; res then begin bufsize := SizeOf(errmsg); ZeroMemory(@errmsg, bufsize); pActivator.GetFBStat(errmsg, bufsize); MessageBox( Application.Handle, PChar('ERROR Activate: ' + String(errmsg)), '   ', MB_OK OR MB_ICONERROR); pActivator.Destroy; Exit; end; . . .</span></span></code> </pre> <br>  As you can see, the key is transferred to the activator and the activation function is called.  In this case, the module registers a callback function for accessing the key by means of key keeper extension.  And it does not depend on the Firebird mode.  And the security of the key transfer is guaranteed by encryption on the session keys.  In the above code, after calling the activation function, an example of handling the occurrence of a possible error at the Firebird library level is shown.  Similarly, you can read the current status of the completed task for any of the operations with reference to the Firebird functionality. <br><br>  Now we can write handlers for the ‚ÄúEncrypt‚Äù and ‚ÄúDecrypt‚Äù buttons.  If you omit checking the status of the completed task and pre-activating the key, then all you need to do is add a call to the activation object of the function of the same name: <br><br><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// C++ Builder //  res = pActivator-&gt;Encrypt(); . . . //  res = pActivator-&gt;Decrypt();</span></span></code> </pre> <br><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">// Delphi //  res := pActivator.Encrypt; . . . //  res := pActivator.Decrypt;</span></span></code> </pre><br>  As a result, we get identical handlers with the exception of one call. <br><br>  Now we can encrypt the database.  And the call of her status will tell us that she is already encrypted. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/931/ea4/bde/931ea4bde8bc4bf3b8289e12b7cebf9a.png" alt="Encrypted DB Status"></div><br>  After that, an attempt to connect to the database without changing the ‚ÄúConnect‚Äù button handler will result in an error. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/web/103/eb0/2f3/103eb02f38c14affa78d76cb53f816fe.png" alt="Attempt to connect to encrypted database without key activation"></div><br>  The last step is to change the handler of the connection button to the database.  There you need to add the receipt of the module's interface object and the activation key activation.  Below is the complete code for processing connections to an encrypted database. <br><br><div class="spoiler">  <b class="spoiler_title">For C ++ Builder</b> <div class="spoiler_text"><pre> <code class="cpp hljs"><span class="hljs-comment"><span class="hljs-comment">// C++ Builder void __fastcall TForm1::Button1Click(TObject *Sender) { //   std::unique_ptr&lt;HINSTANCE__, decltype(&amp;::FreeLibrary)&gt; mHandle( ::LoadLibraryEx(L"C:\\TESTAPP\\CiFbEnc_x86.dll", 0, LOAD_WITH_ALTERED_SEARCH_PATH), &amp;::FreeLibrary); if (!mHandle) { MessageBox( NULL, L" CiFbEnc_x86.dll        fbclient.dll", L" ", MB_OK|MB_ICONERROR); return; } //   typedef CALL_CONV int(__stdcall *CREATEFUNCPTR)(CI::ICiFbEncActivator**); CREATEFUNCPTR GetActivator = (CREATEFUNCPTR)::GetProcAddress(mHandle.get(), "createCiFBEncActivator"); if (!GetActivator) { MessageBox( NULL, L"     CiFbEnc_x86.dll" "  createCiFBEncActivator" " -  ,   tdump.", L" ", MB_OK|MB_ICONERROR); return; } CI::ICiFbEncActivator* pActivator = NULL; GetActivator(&amp;pActivator); if (!pActivator) { ShowMessage("ERROR GetActivator!"); return; } //      pActivator-&gt;SetDBAccess("localhost:TESTDB", "SYSDBA", "masterkey"); //    int res = pActivator-&gt;SetKey(&amp;key, sizeof(key)); if (Err_OK != res) { ShowMessage("ERROR SetKey!"); pActivator-&gt;Destroy();return; } //     res = pActivator-&gt;Activate(); if (Err_OK != res) { //   char errmsg[512] = {0}; size_t esize = sizeof(errmsg); pActivator-&gt;GetFBStat(errmsg, esize); String sErrMsg = "ERROR Activate: " + String(errmsg); MessageBox( NULL, sErrMsg.w_str(), L"   ", MB_OK|MB_ICONERROR); pActivator-&gt;Destroy(); return; } //    try { FDConnection1-&gt;Connected = true; FDTable1-&gt;Active = true; } catch(EFDDBEngineException &amp;e) { String sErrMsg = L"    . " + e.Message; MessageBox( NULL, sErrMsg.w_str(), L"  ", MB_OK|MB_ICONERROR); } //    pActivator-&gt;Destroy(); pActivator = NULL; }</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">For delphi</b> <div class="spoiler_text"><pre> <code class="delphi hljs"><span class="hljs-comment"><span class="hljs-comment">// Delphi procedure TForm2.Button1Click(Sender: TObject); var pActivator : ICiFbEncActivator; res : Integer; CreateActivator: TActivatorFunction; mHandle : HINST; errmsg : array[0..511] of AnsiChar; bufsize : NativeUInt; begin //   mHandle := LoadLibraryEx(PChar('C:\TESTAPP\CiFbEnc_x86.dll'), 0, LOAD_WITH_ALTERED_SEARCH_PATH); if mHandle = 0 then begin MessageBox( Application.Handle, ' CiFbEnc_x86.dll        fbclient.dll', ' ', MB_OK OR MB_ICONERROR); Exit; end; //   CreateActivator := GetProcAddress(mHandle, 'createCiFBEncActivator'); if not Assigned(CreateActivator) then begin MessageBox( Application.Handle, '     CiFbEnc_x86.dll  createCiFBEncActivator' + ' -  ,   tdump.', ' ', MB_OK OR MB_ICONERROR); Exit; end; pActivator := nil; res := CreateActivator(pActivator); if not Assigned(pActivator) then begin ShowMessage('ERROR CreateActivator!');Exit; end; //      res := pActivator.SetDBAccess('localhost:TESTDB', 'SYSDBA', 'masterkey'); //    res := pActivator.SetKey(@key, Length(key)); if Err_OK &lt;&gt; res then begin ShowMessage('ERROR SetKey!'); pActivator.Destroy;Exit; end; //     res := pActivator.Activate; if Err_OK &lt;&gt; res then begin bufsize := SizeOf(errmsg); ZeroMemory(@errmsg, bufsize); pActivator.GetFBStat(errmsg, bufsize); MessageBox( Application.Handle, PChar('ERROR Activate: ' + String(errmsg)), '   ', MB_OK OR MB_ICONERROR); pActivator.Destroy; Exit; end; //    try FDConnection1.Connected := True; FDTable1.Active := True; except on E: EFDDBEngineException do begin MessageBox( Application.Handle, PChar('    . ' + String(E.Message)), '  ', MB_OK OR MB_ICONERROR); end; end; //    pActivator.Destroy; pActivator := nil; FreeLibrary(mHandle); end;</span></span></code> </pre> <br></div></div><br>  This is how you can simply work with an encrypted database. <br><br>  Fully project can be taken <a href="">here</a> . <br><br>  Demo package - <a href="">here</a> . </div><p>Source: <a href="https://habr.com/ru/post/331002/">https://habr.com/ru/post/331002/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330992/index.html">Without getting out of the chat: the stages of the development of Unified Communications</a></li>
<li><a href="../330994/index.html">Verizon completed Yahoo takeover</a></li>
<li><a href="../330996/index.html">NTT Com announced the creation of the world's first fully software-defined network</a></li>
<li><a href="../330998/index.html">Fujitsu has developed virtual machine management technology that improves server utilization</a></li>
<li><a href="../331000/index.html">MyTaskHelper.ru in practice: creating a free database to check the results of the OGE</a></li>
<li><a href="../331006/index.html">Redmine + Mercurial project management system on Ubuntu 16.04</a></li>
<li><a href="../331008/index.html">AsyncDisplayKit 2.0 (Texture) Tutorial: Automatic Layout</a></li>
<li><a href="../331010/index.html">Interplanetary File System - no longer need to copy to the network</a></li>
<li><a href="../331014/index.html">Interplanetary File System - We localize the global gateway or sites in IPFS</a></li>
<li><a href="../331016/index.html">Overview of server monitoring systems. Replacing munin with ...</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>