<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Difficult integrity constraint</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Once it became necessary to organize a complex control of logically related information entered simultaneously in several tables in the ORACLE databas...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Difficult integrity constraint</h1><div class="post__text post__text-html js-mediator-article">  Once it became necessary to organize a complex control of logically related information entered simultaneously in several tables in the ORACLE database. <a name="habracut"></a>  The transformation of the initial logically correct data set in the tables into the final logically correct set is performed by a sequence of DML operators.  In this case, the modification can be performed by an arbitrary client whose behavior is uncontrollable, and the data structure is such that during the execution of the step-by-step modification, at some steps the data set may become logically erroneous. <br><br>  The simplest example is a table of the history of values ‚Äã‚Äãof three fields: value, the starting date of the value action, the ending date of the value action.  Logically correct history can not have records that overlap periods of validity values.  To change the boundaries of the action of two adjacent values, you need to change two dates - the end date of the previous value in the previous entry and the start date of the next one in the next entry.  If we move the boundary of the change of values ‚Äã‚Äãin time forward and in the first step move the expiration date of the value of the first record forward, we obtain a logically erroneous data set.  That is why it is impossible to solve the problem with tabular triggers - they work for each data modification operator. <br><br>  The real problem is slightly different from the simplest example.  The data set is decomposed into a dozen tables, the business control rules algorithm has resulted in a 400-line procedure with access to API on other servers via links. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      To implement such control, a trigger was needed, which is triggered only once in a transaction for a COMMIT event, with the possibility of rolling back the transaction based on the result of the development of the business logic control procedure.  Such a trigger was found. <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> &lt;mv_as&gt; <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> MV</code> </pre> <br>  where MV is: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATERIALIZED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> MV <span class="hljs-keyword"><span class="hljs-keyword">REFRESH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMPLETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> &lt;,,,,&gt; <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> &lt;tab&gt;;</code> </pre><br>  Consider the example of implementation details.  Data set. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> EMP (EMPNO <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, ENAME VARCHAR2(<span class="hljs-number"><span class="hljs-number">10</span></span>), JOB VARCHAR2(<span class="hljs-number"><span class="hljs-number">9</span></span>), MGR <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">4</span></span>), HIREDATE <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>, SAL <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), COMM <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">17</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>), DEPTNO <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TABLE</span></span> DEPT (DEPTNO <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>(<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>, DNAME VARCHAR2(<span class="hljs-number"><span class="hljs-number">14</span></span>), LOC VARCHAR2(<span class="hljs-number"><span class="hljs-number">13</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> DEPT (DEPTNO, DNAME, LOC) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">10</span></span>, <span class="hljs-string"><span class="hljs-string">'ACCOUNTING'</span></span>, <span class="hljs-string"><span class="hljs-string">'NEW YORK'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> DEPT (DEPTNO, DNAME, LOC) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">20</span></span>, <span class="hljs-string"><span class="hljs-string">'RESEARCH'</span></span>, <span class="hljs-string"><span class="hljs-string">'DALLAS'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> DEPT (DEPTNO, DNAME, LOC) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">30</span></span>, <span class="hljs-string"><span class="hljs-string">'SALES'</span></span>, <span class="hljs-string"><span class="hljs-string">'CHICAGO'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> DEPT (DEPTNO, DNAME, LOC) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">31</span></span>, <span class="hljs-string"><span class="hljs-string">'OPERATIONS'</span></span>, <span class="hljs-string"><span class="hljs-string">'CHICAGO'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7369</span></span>, <span class="hljs-string"><span class="hljs-string">'SMITH'</span></span>, <span class="hljs-string"><span class="hljs-string">'CLERK'</span></span>, <span class="hljs-number"><span class="hljs-number">7902</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1980-12-17 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">2800</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7499</span></span>, <span class="hljs-string"><span class="hljs-string">'ALLEN'</span></span>, <span class="hljs-string"><span class="hljs-string">'SALESMAN'</span></span>, <span class="hljs-number"><span class="hljs-number">7698</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-02-20 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">1600</span></span>, <span class="hljs-number"><span class="hljs-number">300</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7521</span></span>, <span class="hljs-string"><span class="hljs-string">'WARD'</span></span>, <span class="hljs-string"><span class="hljs-string">'SALESMAN'</span></span>, <span class="hljs-number"><span class="hljs-number">7698</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-02-22 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">1250</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7566</span></span>, <span class="hljs-string"><span class="hljs-string">'JONES'</span></span>, <span class="hljs-string"><span class="hljs-string">'MANAGER'</span></span>, <span class="hljs-number"><span class="hljs-number">7839</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-04-02 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">2975</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7650</span></span>, <span class="hljs-string"><span class="hljs-string">'MARTIN'</span></span>, <span class="hljs-string"><span class="hljs-string">'SALESMAN'</span></span>, <span class="hljs-number"><span class="hljs-number">7698</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-09-28 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">1251</span></span>, <span class="hljs-number"><span class="hljs-number">1400</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7698</span></span>, <span class="hljs-string"><span class="hljs-string">'BLAKE'</span></span>, <span class="hljs-string"><span class="hljs-string">'MANAGER'</span></span>, <span class="hljs-number"><span class="hljs-number">7839</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-05-01 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">2850</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7782</span></span>, <span class="hljs-string"><span class="hljs-string">'CLARK'</span></span>, <span class="hljs-string"><span class="hljs-string">'MANAGER'</span></span>, <span class="hljs-number"><span class="hljs-number">7839</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-06-09 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">2450</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7708</span></span>, <span class="hljs-string"><span class="hljs-string">'SCOTT'</span></span>, <span class="hljs-string"><span class="hljs-string">'ANALYST'</span></span>, <span class="hljs-number"><span class="hljs-number">7566</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1982-12-09 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">3000</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7639</span></span>, <span class="hljs-string"><span class="hljs-string">'KING'</span></span>, <span class="hljs-string"><span class="hljs-string">'PRESIDENT'</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-11-17 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">5000</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7844</span></span>, <span class="hljs-string"><span class="hljs-string">'TURNER'</span></span>, <span class="hljs-string"><span class="hljs-string">'SALESMAN'</span></span>, <span class="hljs-number"><span class="hljs-number">7698</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-09-10 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">1500</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">30</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7876</span></span>, <span class="hljs-string"><span class="hljs-string">'ADAMS'</span></span>, <span class="hljs-string"><span class="hljs-string">'CLERK'</span></span>, <span class="hljs-number"><span class="hljs-number">7788</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1982-01-12 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">1100</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7900</span></span>, <span class="hljs-string"><span class="hljs-string">'JAMES'</span></span>, <span class="hljs-string"><span class="hljs-string">'CLERK'</span></span>, <span class="hljs-number"><span class="hljs-number">7698</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-12-03 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">950</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">31</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7902</span></span>, <span class="hljs-string"><span class="hljs-string">'FORD'</span></span>, <span class="hljs-string"><span class="hljs-string">'ANALYST'</span></span>, <span class="hljs-number"><span class="hljs-number">7566</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1981-12-03 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">3000</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">20</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> EMP (EMPNO, ENAME, JOB, MGR, HIREDATE, SAL, COMM, DEPTNO) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">7934</span></span>, <span class="hljs-string"><span class="hljs-string">'MILLER'</span></span>, <span class="hljs-string"><span class="hljs-string">'CLERK'</span></span>, <span class="hljs-number"><span class="hljs-number">7782</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">TIMESTAMP</span></span> <span class="hljs-string"><span class="hljs-string">'1982-01-23 00:00:00'</span></span>, <span class="hljs-number"><span class="hljs-number">1300</span></span>, <span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> emp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> m_k primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(empno); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> dept <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> dept_pk primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span>(deptno); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> emp <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> emp_fk_dept <span class="hljs-keyword"><span class="hljs-keyword">foreign</span></span> <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (deptno) <span class="hljs-keyword"><span class="hljs-keyword">references</span></span> dept;</code> </pre><br>  The example data is a set of entities of the type - ‚ÄúEmployee‚Äù with information about the division and location of the division.  Let's try to implement a business rule for this data limiting the number of employees with a 'CLERK' position in one city not more than 2x. <br><br>  In the general case, there may be several rules of business control, and in a single transaction, the information of several employees is modified.  Accordingly, at the time of commit, we need to have two sets of information: <br><br>  - the set of fields that have been modified will determine the list of business rules that should be controlled; <br>  - a set of identifiers of employees to be monitored. <br><br>  A practical list of business control rules and their complexity allow, without a critical load on the server, to check each modified employee for all the implemented rules.  This assumption will allow in our case to simplify the implementation of integrity constraints. <br><br>  Create a table that will contain a set of employee IDs modified by the current transaction. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> emp_chk ( emp_no <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, i <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">alter</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> emp_chk <span class="hljs-keyword"><span class="hljs-keyword">add</span></span> <span class="hljs-keyword"><span class="hljs-keyword">constraint</span></span> PK_emp_no primary <span class="hljs-keyword"><span class="hljs-keyword">key</span></span> (emp_no);</code> </pre><br>  On all tables containing information for the control rule, we hang the trigger with which we will insert the identifiers of the modified employees into emp_chk.  Some comments on triggers.  The customer of the combat use of the control functionality demanded compatibility with ORACLE-9, therefore the trigger is not compound. <br><br>  The ability to disable the construst is implemented by the var_chk.chk_on batch function.  The use of the function for this purpose makes it possible to control the control not only statically (via the configuration table) but also dynamically (for example, for different database sessions).  Full package text will be provided later. <br><br>  The use of MERGE is caused by the desire to carry out a modification with one operator.  The emp_chk.i field is the charge for using MERGE since  write MERGE without the phrase WHEN MATCHED failed. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> emp_chk_ar <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> emp <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> var_chk.chk_on != <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> emp_chk a <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> nvl(:new.empno, :old.empno) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> emp_no , <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dual ) b <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (a.emp_no = b.emp_no) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (a.emp_no, ai) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (b.emp_no, bi) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ai = bi; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> emp_chk_ar; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> dept_chk_ar <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dept <span class="hljs-keyword"><span class="hljs-keyword">FOR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EACH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ROW</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> var_chk.chk_on != <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">MERGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> emp_chk a <span class="hljs-keyword"><span class="hljs-keyword">USING</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> emp.empno <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> emp_no , <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> emp <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> emp.deptno = NVL(:new.deptno, :old.deptno) ) b <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (a.emp_no = b.emp_no) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> (a.emp_no, ai) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (b.emp_no, bi) <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATCHED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> ai = bi; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> dept_chk_ar;</code> </pre><br>  The following triggers clean up the emp_chk table at the beginning of a new transaction.  The batch variable var_chk.first_dml_in_commit manages cleaning: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> emp_chk_bs <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> emp <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> var_chk.chk_on != <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; IF var_chk.first_dml_in_commit = 1 THEN <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> emp_chk; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; var_chk.first_dml_in_commit := 0 ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> emp_chk_bs; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> dept_chk_bs <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> dept <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> var_chk.chk_on != <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; IF var_chk.first_dml_in_commit = 1 THEN <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> emp_chk; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; var_chk.first_dml_in_commit := 0; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> dept_chk_bs;</code> </pre><br>  Create a materialized view. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">MATERIALIZED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">VIEW</span></span> chk_emp_mv <span class="hljs-keyword"><span class="hljs-keyword">REFRESH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMPLETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COMMIT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> emp_no,i <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> emp_chk;</code> </pre><br>  The trigger initializing var_chk.first_dml_in_commit ensures that EMP_CHK is cleared at the start of a transaction. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> chk_emp_mv_bs <span class="hljs-keyword"><span class="hljs-keyword">BEFORE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> chk_emp_mv <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> var_chk.chk_on != <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; var_chk.first_dml_in_commit := 1 ; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> chk_emp_mv_bs;</code> </pre><br>  Actually trigger triggering business control. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">TRIGGER</span></span> chk_emp_mv_as <span class="hljs-keyword"><span class="hljs-keyword">AFTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DELETE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> chk_emp_mv <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> v_result <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>; v_errtxt VARCHAR2(512); <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span> var_chk.chk_on != <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; FOR cur IN (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t.emp_no <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> CHK_EMP_MV t) <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"EMP"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">XMLAGG</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"EMPNO"</span></span>,tb.empno, <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"ENAME"</span></span>, tb.ename), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"JOB"</span></span>, tb.job), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"MGR"</span></span>, tb.mgr), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"SAL"</span></span>, tb.sal), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"DEPTNO"</span></span>, tb.DEPTNO), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"COMM"</span></span>, tb.comm), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"HIREDATE"</span></span>, TO_CHAR(tb.hiredate,<span class="hljs-string"><span class="hljs-string">'dd.mm.yyyy'</span></span>)) ,(<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"DEPT"</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">XMLAGG</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"DEPTNO"</span></span>,d.deptno, <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"DNAME"</span></span>,d.dname), <span class="hljs-keyword"><span class="hljs-keyword">XMLELEMENT</span></span>(<span class="hljs-string"><span class="hljs-string">"LOC"</span></span>,d.loc) ))) <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> dept d <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> d.deptno = tb.deptno ) )) ).GETCLOBVAL() <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> var_chk.var_emp_val <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> EMP <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> emp.empno = cur.emp_no ) tb <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> empno,sal,mgr,job,hiredate,ename,deptno,comm ; <span class="hljs-comment"><span class="hljs-comment">--   v_result := emp_logic(cur.emp_no,v_errtxt); var_chk.write_log(v_result,v_errtxt); IF v_result = 1 THEN RAISE_APPLICATION_ERROR (-20555,v_errtxt); END IF; END LOOP; END chk_emp_mv_as;</span></span></code> </pre><br>  Some comments on the text CHK_EMP_MV_AS.  Debugging and control of the functioning of the framework can be facilitated by logging.  Let's consider that in case of an error, the data set presented for commit usually rolls back and is lost.  In this implementation, not only the final processing status is written to the log, but also the entire data set of the employee who has undergone the modification presented to commit-a regardless of the processing result.  Snapshots of datasets are placed in the emp_chk_log.XML field.  The log is written with the var_chk.write_log package function into a table: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> emp_chk_log ( ts <span class="hljs-built_in"><span class="hljs-built_in">DATE</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">status</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">XML</span></span> <span class="hljs-keyword"><span class="hljs-keyword">CLOB</span></span> );</code> </pre><br>  All business rules are implemented in a separate emp_logic function.  The function is not a member of the package.  This allows us to separate in the development and maintenance of business rules of the force and the layer of the system mechanisms of its operation.  Below is the var_chk package text. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PACKAGE</span></span> var_chk <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> first_dml_in_commit <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>; var_emp_val CLOB; FUNCTION chk_on return NUMBER; PROCEDURE write_log (p_status NUMBER ,p_err_txt VARCHAR2); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>;</code> </pre><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">PACKAGE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BODY</span></span> var_chk <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> <span class="hljs-comment"><span class="hljs-comment">-------------------- FUNCTION chk_on RETURN NUMBER IS --  1 -   -- 0 -   BEGIN RETURN 1; END chk_on; --------------------- PROCEDURE write_log (p_status NUMBER ,p_err_txt VARCHAR2) is PRAGMA AUTONOMOUS_TRANSACTION; BEGIN INSERT INTO emp_chk_log (ts,status,xml,err_txt) VALUES (sysdate,p_status,var_emp_val,SUBSTR(p_err_txt,1,512)); COMMIT; END write_log; --------------------- BEGIN first_dml_in_commit :=1; dbms_lob.createtemporary(var_emp_val,true); END;</span></span></code> </pre><br>  The function of controlling business rules. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> emp_logic (p_emp_no <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> ,p_errtxt <span class="hljs-keyword"><span class="hljs-keyword">OUT</span></span> VARCHAR2 ) <span class="hljs-keyword"><span class="hljs-keyword">RETURN</span></span> <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> v_emp_count <span class="hljs-built_in"><span class="hljs-built_in">NUMBER</span></span>; v_emp_loc dept.loc%TYPE; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> dept.loc,<span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(*) <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> v_emp_loc,v_emp_count <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> emp, dept, ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> emp.job, dept.loc <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> emp, dept <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> emp.deptno = dept.deptno <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> emp.empno = p_emp_no <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> emp.job = <span class="hljs-string"><span class="hljs-string">'CLERK'</span></span> ) p <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> emp.deptno = dept.deptno <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.loc=dept.loc <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> p.job=emp.job <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> dept.loc ; IF v_emp_count &gt; 2 THEN p_errtxt:=':  '||v_emp_loc||'  2 '; RETURN 1; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; RETURN 0; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> emp_logic;</code> </pre><br>  Check the bike on the go. <br><br><pre> <code class="hljs javascript">SQL&gt; UPDATE EMP SET JOB=<span class="hljs-string"><span class="hljs-string">'CLERK'</span></span> WHERE EMPNO=<span class="hljs-number"><span class="hljs-number">7708</span></span>; <span class="hljs-number"><span class="hljs-number">1</span></span> row updated. SQL&gt; commit; commit * ERROR at line <span class="hljs-number"><span class="hljs-number">1</span></span>: ORA<span class="hljs-number"><span class="hljs-number">-12008</span></span>: error <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> materialized view refresh path ORA<span class="hljs-number"><span class="hljs-number">-20555</span></span>: :  DALLAS  <span class="hljs-number"><span class="hljs-number">2</span></span>  ORA<span class="hljs-number"><span class="hljs-number">-06512</span></span>: at <span class="hljs-string"><span class="hljs-string">"ZH.CHK_EMP_MV_AS"</span></span>, line <span class="hljs-number"><span class="hljs-number">43</span></span> ORA<span class="hljs-number"><span class="hljs-number">-04088</span></span>: error during execution <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> trigger <span class="hljs-string"><span class="hljs-string">'ZH.CHK_EMP_MV_AS'</span></span> SQL&gt; UPDATE EMP SET JOB=<span class="hljs-string"><span class="hljs-string">'CLERK'</span></span> WHERE EMPNO=<span class="hljs-number"><span class="hljs-number">7369</span></span>; <span class="hljs-number"><span class="hljs-number">1</span></span> row updated. SQL&gt; commit; Commit complete. SQL&gt; select ts,status,to_char(xml) <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> emp_chk_log; TS STATUS --------------- ---------- TO_CHAR(XML) -------------------------------------------------------------------------------- <span class="hljs-number"><span class="hljs-number">30</span></span>-MAR<span class="hljs-number"><span class="hljs-number">-16</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> &lt;EMP&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">EMPNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">7708</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ENAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">SCOTT</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ENAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">JOB</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">CLERK</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">JOB</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MGR</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">7566</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MGR</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SAL</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">3000</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SA</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">L</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">20</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">COMM</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">COMM</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">HIREDATE</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">09.12.1982</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">HIREDATE</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPT</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">2 0</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DNAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">RESEARCH</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DNAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LOC</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">DALLAS</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LOC</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPT</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">EMPNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">EMP</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> TS STATUS --------------- ---------- TO_CHAR(XML) -------------------------------------------------------------------------------- <span class="hljs-number"><span class="hljs-number">30</span></span>-MAR<span class="hljs-number"><span class="hljs-number">-16</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> &lt;EMP&gt;<span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">EMPNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">7369</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ENAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">SMITH</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ENAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">JOB</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">CLERK</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">JOB</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MGR</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">7902</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">MGR</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SAL</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">2800</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">SA</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">L</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">20</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">COMM</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">COMM</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">HIREDATE</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">17.12.1980</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">HIREDATE</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPT</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">2 0</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DNAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">RESEARCH</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DNAME</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LOC</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">DALLAS</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">LOC</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPTNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">DEPT</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">EMPNO</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">EMP</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> SQL&gt;</code> </pre><br>  The real implementation of this solution has been working on three dozen servers of the central office and branches since spring 2015. </div><p>Source: <a href="https://habr.com/ru/post/280834/">https://habr.com/ru/post/280834/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280824/index.html">IL2CPP: generated code tour</a></li>
<li><a href="../280826/index.html">Announcement of the Russian-language catalog of solutions of independent developers certified for Microsoft Azure</a></li>
<li><a href="../280828/index.html">New big css book</a></li>
<li><a href="../280830/index.html">RING buffer - 2D case</a></li>
<li><a href="../280832/index.html">Critical vulnerability in TrendMicro antivirus allows remote code execution</a></li>
<li><a href="../280836/index.html">Do not miss the virtual hackathon from Microsoft with the support of Forbes</a></li>
<li><a href="../280838/index.html">What is Simics?</a></li>
<li><a href="../280840/index.html">How not the most successful default behavior can mask the wrong work for years.</a></li>
<li><a href="../280842/index.html">Archiving as a work of art</a></li>
<li><a href="../280844/index.html">A supercomputer based on a TrueNorth chip with a power consumption of 2.5 W was created in the USA</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>