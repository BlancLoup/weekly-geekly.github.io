<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL Power</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Meeting with a complex non-trivial task of searching and processing data, sometimes you want to solve it head-on. And although you understand that a d...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL Power</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/web/1c0/b91/da9/1c0b91da958d4c49b0d09fc96619ef40.jpg"></div><br>  Meeting with a complex non-trivial task of searching and processing data, sometimes you want to solve it head-on.  And although you understand that a decision may be slow or not viable at all, and there is not enough knowledge and experience to really solve it, you don‚Äôt need to hurry.  It is important to understand that the DBMS were specifically created for this, and you should not solve the tasks intended for them in other ways. <br><a name="habracut"></a><br><h2>  Task </h2><br>  Search for hotels with available rooms for specific dates by a group of people. <br><br><h2>  Project </h2><br>  When the project fell into our hands, the search has already been implemented.  He worked slowly, very slowly.  And all because the calculations and sampling were not carried out on the side of the database, but on the side of the web application: a ton of records was selected from different tables, and the numbers were selected and calculated in cycles, filtered, sorted and output page by page.  Very inefficient.  And the application, by the way, is written in Ruby on Rails. <br>  Do not do it this way. <br><br><h2>  Initial data </h2><br>  <a href="http://sqlfiddle.com/">The original data schema</a> (in the examples is artificially simplified to fit into the sqlfiddle constraints) <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Places</b></a> - destinations, resorts.  Of the fields - only the name. <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Districts</b></a> - areas.  Each direction can have several areas.  Fields: name and direction id. <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Properties</b></a> - hotels, can be tied to the direction or to a specific area.  Fields: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  name - name </li><li>  dest_type - a type of <a href="http://guides.rubyonrails.org/association_basics.html">polymorphic connection</a> with a destination or area ("Place" or "District") </li><li>  dest_id - id of the connection with the direction or area </li><li>  stars - star (from 0 to 5) </li><li>  currency - currency code </li></ul><hr><br>  <a href="http://sqlfiddle.com/"><b>Property_arrival_rules</b></a> - rules of entry to each hotel.  Fields: <br><br><ul><li>  arrival_date - arrival date </li><li>  property_id - hotel id </li><li>  rule - the type of the rule (0 or 1), depending on the type, the departure date is calculated in different ways, more details <a href="https://habr.com/ru/post/338406/">in the solution below</a> </li><li>  min_stay - the minimum number of nights to stay </li></ul><br>  The absence of an entry in the table for a specific date means that entry on that date is not possible.  Why is stored so?  It's all about the types of rules of entry.  More on these types <a href="https://habr.com/ru/post/338406/">in the solution below</a> . <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Rooms</b></a> - hotel rooms, more precisely the types of rooms;  for example, 2-room identical rooms may be several in one hotel.  Fields: name and id of the hotel. <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Room_availabilities</b></a> ‚Äî room availability for each night.  Fields: <br><br><ul><li>  room_id - id numbers </li><li>  date - date </li><li>  initial_count - the number of available numbers </li><li>  sales_count - number of rooms already booked </li></ul><br>  The absence of a record for any night means unavailability of the number. <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Room_price_policies</b></a> - room policies.  The same room may have different rates depending on the number of guests, type of food and other conditions.  Fields: <br><br><ul><li>  room_id - id numbers </li><li>  max_guests - the maximum number of guests </li><li>  meal_type is a type of food, a number from 0 to 8, where 0 is without food, 1 is breakfast, 2 is half board, etc. </li><li>  has_special_requirements - special conditions, boolean </li><li>  before_type - special condition type (0 or 1), 0 - the policy is valid only if the booking occurs before a certain date, 1 - the policy is valid if the booking is made N days before the date of arrival <br></li><li>  before_date - the date for before_type 0 </li><li>  days_before_arrival - the number of days for before_type 1 </li></ul><hr><br>  <a href="http://sqlfiddle.com/"><b>Room_prices</b></a> - prices for room policies for each night in hotel currency.  Fields: <br><br><ul><li>  room_price_policy_id - number policy id </li><li>  price_date - date </li><li>  price - price </li></ul><br>  The absence of a record for any night means the inability to purchase a room that night. <br><hr><br>  <a href="http://sqlfiddle.com/"><b>Currency_rates</b></a> - exchange rates.  Fields: <br><br><ul><li>  sale_currency - code of the currency being sold </li><li>  buy_currency - buy currency code </li><li>  price - the rate, the number of units of currency sold, divided by the rate, will give the number of units of currency being bought <br></li></ul><br><h2>  Input parameters </h2><br>  The user in the search form can choose: <br><br><ul><li>  Direction or area is something from places or districts.  And if this is the direction, then when searching you should look for not only hotels of the direction, but also hotels of all areas of the direction </li><li>  Desired date of arrival </li><li>  Desired departure date </li><li>  The composition of a group of people, for example, 3 adults + 2 children (7 and 9 years old) </li><li>  Optionally, filters for the price per night, hotel stars, food type </li></ul><br><h2>  searching results </h2><br>  The result of the search should be a list of hotels in the direction, area.  And for each hotel: <br><br><ul><li>  Suitable check-out dates </li><li>  Suitable for the cheapest room <i>OR</i> 3 cheapest rooms if there is no room accommodating the whole group. </li><li>  The cost for the period of arrival and departure in the base currency for each number that hit the result </li></ul><br>  The list of hotels should be sorted: first go the hotels with the right number, then the hotels with the cheapest 3, then the hotels without available rooms.  Additionally, you can sort by star hotel or cost for the period. <br><br>  It should be borne in mind that the limited number of entries for a particular page (pagination) should come to the application from the database. <br><br>  Is it possible  Yes, in 2 (two!) Sql-requests (after a small modification of the data scheme) <br><br><h2>  Decision </h2><br>  Suppose a user searches by the following parameters: <br><br><ul><li>  ‚ÄúVal Thorens‚Äù direction, which includes two more districts ‚ÄúTignes Le Lac‚Äù and ‚ÄúTignes Val Clares‚Äù </li><li>  Desired date of arrival: January 2, 2018 </li><li>  Desired departure date: January 8, 2018 (respectively, the number of nights desired is 6) </li><li>  The composition of a group of people: 3 adults + 2 children (7 and 9 years old) </li><li>  Today is: August 17, 2017 </li></ul><br><h3>  Step 1. The nearest arrival date to the desired </h3><br>  In fact, it is necessary to find one entry rule for each hotel of the direction or area with the nearest date to the desired date of entry.  And here we can assume that we are looking for the nearest date no further than N days from the desired, for example, 7 days.  <a href="http://sqlfiddle.com/">This is what this query looks like</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Request the nearest arrival date</b> <div class="spoiler_text"><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff</code> </pre> <br></div></div><br><a name="departure_date"></a><h3>  Step 2. Suitable departure date </h3><br>  We need to calculate the date of departure for each hotel based on the selected entry rules (from step 1) and the number of nights, calculated as the difference between the desired dates of departure and arrival. <br><br>  And then the first problem opened, because  rules of entry were very tricky.  There are two types of rules: <br><br>  Type 1. You can call on a specific day for any number of days, but not less than N days. <br><br>  Type 2. You can call on a specific day strictly for N days <br><br>  And when in the required period type 2 rules fall, then in order to calculate the whole period, you should look through the following rule, which goes on the day the rule ends - the arrival date from the + N days rule. <br><br>  A real example of type 2 rule. You can only enter the hotel on Saturdays for exactly one week.  If I want to enter for a period of 1 to 6 days - I still have to take the whole week.  If I want to take more than 7 days, for example, 9 days, then I will have to take either 14 days or limit myself for less than 7 days.  And so on‚Ä¶ <br><br>  And it turns out that the algorithm for calculating the date of departure is as follows: <br><br>  1. take the found entry rule and the estimated departure date (arrival date from the rule + the desired number of nights) <br>  2. Check whether the departure date is within the minimum rule period: from the ‚Äúarrival date‚Äù to the ‚Äúarrival date + N days‚Äù <br>  2.1.  if inside, i.e.  the rule period covers the desired dates - check to which end of the period is closer <br>  2.1.1.  if closer to the beginning and this is not the first rule to be viewed, then the departure date is the date of arrival from the rule <br>  2.1.2.  otherwise, the departure date is ‚Äúarrival date + N days‚Äù <br>  2.2.  if outside, i.e.  the period of the rule may not be enough - check what type of rule we look at <br>  2.2.1.  if type 1, then the estimated departure date will be the calculated departure date <br>  2.2.2.  if type 2, take the following rule on the date: ‚Äúarrival date + N days‚Äù <br>  2.2.2.1.  if the following rule exists, then we recursively repeat item 2 already for this rule, taking into account that this is not the first rule to be viewed. <br>  2.2.2.2.  if the following rule does not exist, then the departure date will be ‚Äúarrival date + N days‚Äù <br><br>  And how to put this on sql? <br><br>  On the application side, you can pre-calculate all possible check-in / check-out periods for each day by the entry rules and put them in a separate table with fields: <br><br><table><tbody><tr><td>  arrival_date <br>  (arrival date) </td><td>  wanted_departure_date <br>  (desired departure date) </td><td>  departure_date <br>  (actual <br>  calculated <br>  date of departure) </td><td>  property_id <br>  (hotel id) </td></tr></tbody></table><br>  Or even more densely, in order to reduce the number of records, because  Type 2 rules will often coincide with the arrival date and calculated departure date for some nearby days. <br><table><tbody><tr><td>  arrival_date <br>  (arrival date) </td><td>  wanted_departure_range <br>  (desired departure period, <br>  daterange type) </td><td>  departure_date <br>  (actual <br>  calculated <br>  date of departure) </td><td>  property_id <br>  (hotel id) </td></tr></tbody></table><br>  And let's call it <a href="http://sqlfiddle.com/">property_arrival_periods</a> - calculated entry periods. <br><br>  In order to limit the number of entries in this table and make the calculation not infinite, you need to add a certain limit on the maximum booking period, for example, 30 days.  With such a restriction on each hotel for one year, in the worst case, there will be ~ 11000 records, which looks quite good. <br><br>  Thus, when adding / changing / deleting the entry rule, we have the background in the appendix: <br><br><ul><li>  delete calculated periods for dates: from ‚Äúrule date minus 30 days‚Äù to ‚Äúrule date‚Äù </li><li>  we calculate the periods for each day from the ‚Äúdate of the rule minus 30 days‚Äù to the ‚Äúdate of the rule‚Äù for each reservation period: for 1 day, for 2 days, for 3 days, ..., for 30 days </li></ul><br>  And then when searching, we do not need to count anything, but only <a href="http://sqlfiddle.com/">choose from this new table</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Request check-out dates</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>)</code> </pre><br></div></div><br><h3>  Step 3. Available numbers </h3><br>  <a href="http://sqlfiddle.com/">We take all available numbers</a> , i.e.  those that have entries for the calculated entry-exit period (from step 2) and are simultaneously available every night of the period. <br><br><div class="spoiler">  <b class="spoiler_title">Request available numbers</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ), fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_availabilities <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rooms.id = room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> initial_count - sales_count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_availabilities.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date)</code> </pre><br></div></div><br><h3>  Step 4. Room rates and ‚ÄúDoes the group fit?‚Äù </h3><br>  We take the room policies (from step 3), for which there are prices for each day of the calculated period, and we calculate the cost for the period and the average price per night, recalculating the amounts from the hotel currency to a certain base currency (in our case, EUR).  In addition, you must take into account the special conditions of the policies ‚Äúbooking up to date‚Äù and ‚Äúbooking up to N days before entry‚Äù. <br><br>  We will also need the sign ‚Äúwhether the whole group is placed in the number‚Äù for each received policy. <br>  According to the task policy must contain the maximum allowable ages with the number. <br>  For example, a room can have 3 adults + 2 children 5 years old. <br>  In this room can fit groups: <br><br><ul><li>  3 adults </li><li>  3 adults + child 4 years old </li><li>  2 adults + child 10 years old (per adult) </li></ul><br>  But do not fit: <br><br><ul><li>  4 adults </li><li>  3 adults + child 7 years old </li><li>  2 adults + 2 children 9 years old </li></ul><br>  And this is a problem. <br><br>  Not only that initially the maximum number of guests is represented by a hstore type field (to which the conditions will be problematic to write) in a strange way: Map, where the keys are the maximum age, and the values ‚Äã‚Äãare the number, and for adults the key is generally ‚Äúadults‚Äù. <br><br>  It is also not clear how to present such information at all in such a way that it is possible to check whether a group of people fits or not. <br><br>  And let's imagine the maximum number of guests as an array of places (sorted in ascending order), where each place is the maximum age (18 for an adult).  And then the capacity of the room ‚Äú3 adults + 2 children 5 years old‚Äù will look like <br><br> <code>[5, 5, 18, 18, 18]</code> <br> <br>  A group of people will be represented as an array of their ages, and then ‚Äú2 adults + 2 children (5 and 9 years old)‚Äù will look like <br><br> <code>[5, 9, 18, 18]</code> <br> <br>  As a result, a capacity column (capacity) storing it in this form was added to the <a href="http://sqlfiddle.com/">policy table (room_price_policies)</a> . <br><br>  But the question still remains.  How to write a condition (or query) in sql: will it fit [5, 9, 18, 18] in [5, 5, 18, 18, 18]?  It turns out we need for each guest from the group to look for a place in the room, and the age of the place must be greater than or equal to the age of the guest, and take into account that there is only one person for one place.  Such recursive exclusion of guests and places in the room. <br><br>  And here we will help <a href="https://www.postgresql.org/docs/9.6/static/plpgsql.html">stored procedures</a> .  For our task, the procedure is as follows. <br><br><div class="spoiler">  <b class="spoiler_title">The procedure 'does the group fit in the number?'</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FUNCTION</span></span> is_room_fit_guests(guests <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>[], <span class="hljs-keyword"><span class="hljs-keyword">capacity</span></span> <span class="hljs-built_in"><span class="hljs-built_in">INTEGER</span></span>[]) <span class="hljs-keyword"><span class="hljs-keyword">RETURNS</span></span> <span class="hljs-built_in"><span class="hljs-built_in">BOOLEAN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> $$ <span class="hljs-keyword"><span class="hljs-keyword">DECLARE</span></span> guest <span class="hljs-built_in"><span class="hljs-built_in">int</span></span>; seat int; seat_index int; max_array_index CONSTANT int := 2147483647; <span class="hljs-keyword"><span class="hljs-keyword">BEGIN</span></span> guest = guests[<span class="hljs-number"><span class="hljs-number">1</span></span>]; IF guest IS NULL THEN RETURN TRUE; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; seat_index := 1; FOREACH seat IN ARRAY capacity LOOP IF guest &lt;= seat THEN RETURN is_room_fit_guests(guests[2:max_array_index], capacity[1:seat_index-1] || capacity[seat_index+1:max_array_index]); <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IF</span></span>; seat_index := seat_index + 1; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LOOP</span></span>; RETURN FALSE; <span class="hljs-keyword"><span class="hljs-keyword">END</span></span>; $$ LANGUAGE plpgsql;</code> </pre><br></div></div><br>  And <a href="http://sqlfiddle.com/">an example of</a> use. <br><br>  And now our query <a href="http://sqlfiddle.com/">looks like this</a> . <br><br><div class="spoiler">  <b class="spoiler_title">Request with calculation of cost and capacity</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ), fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price)::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> average_night_price, rooms.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> room_id, is_room_fit_guests(<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>], room_price_policies.capacity) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fit_people <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_prices <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> room_price_policies <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_prices.room_price_policy_id = room_price_policies.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_price_policies.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties room_properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_properties.id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> currency_rates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> currency_rates.sale_currency = room_properties.currency <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> currency_rates.buy_currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_availabilities <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rooms.id = room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> initial_count - sales_count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_availabilities.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) ra <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ra.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= price_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> price_date &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_date <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; room_price_policies.before_date) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.days_before_arrival <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.arrival_date - room_price_policies.days_before_arrival) ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, rooms.id, room_properties.currency, currency_rates.price, room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_prices.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date)</code> </pre><br></div></div><br><h3>  Step 5. Suitable hotels </h3><br>  <a href="http://sqlfiddle.com/">We select hotels</a> with data (from step 4) for the cheapest policy of a number with a positive value ‚Äúwhether the whole group is placed in a number‚Äù. <br><br><div class="spoiler">  <b class="spoiler_title">Request suitable hotels</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ), fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>) ), properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price)::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> average_night_price, rooms.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> room_id, is_room_fit_guests(<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>], room_price_policies.capacity) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fit_people <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_prices <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> room_price_policies <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_prices.room_price_policy_id = room_price_policies.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_price_policies.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties room_properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_properties.id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> currency_rates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> currency_rates.sale_currency = room_properties.currency <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> currency_rates.buy_currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_availabilities <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rooms.id = room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> initial_count - sales_count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_availabilities.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) ra <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ra.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= price_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> price_date &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_date <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; room_price_policies.before_date) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.days_before_arrival <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.arrival_date - room_price_policies.days_before_arrival) ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, rooms.id, room_properties.currency, currency_rates.price, room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_prices.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>(property_id) *, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_people = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, total</code> </pre><br></div></div><br><h3>  Step 6. Unsuitable hotels with rooms available </h3><br>  Such hotels, in which there is no room for the whole group of guests, as options for booking several rooms.  <a href="http://sqlfiddle.com/">Select hotels</a> from step 4 with a negative value of ‚Äúwhether the whole group is placed in the room‚Äù, but not included in the result of step 5 <br><br><div class="spoiler">  <b class="spoiler_title">Request unsuitable hotels</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ), fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>) ), properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price)::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> average_night_price, rooms.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> room_id, is_room_fit_guests(<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>], room_price_policies.capacity) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fit_people <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_prices <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> room_price_policies <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_prices.room_price_policy_id = room_price_policies.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_price_policies.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties room_properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_properties.id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> currency_rates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> currency_rates.sale_currency = room_properties.currency <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> currency_rates.buy_currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_availabilities <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rooms.id = room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> initial_count - sales_count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_availabilities.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) ra <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ra.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= price_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> price_date &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_date <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; room_price_policies.before_date) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.days_before_arrival <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.arrival_date - room_price_policies.days_before_arrival) ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, rooms.id, room_properties.currency, currency_rates.price, room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_prices.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ), properties_with_recommended_room <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>(property_id) *, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_people = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, total ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>(property_id) *, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> property_id <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_recommended_room) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, total</code> </pre><br></div></div><br><h3>  Step 7. All hotels of the direction </h3><br>  Finally, we <a href="http://sqlfiddle.com/">combine the results by</a> sorting first suitable hotels (from step 5), then unsuitable hotels with available rooms (from step 6), then all other hotels, additionally sorting by the cost per period or star rating of the hotel if necessary, and also adding pagination ( 20 hotels per page) <br><br><div class="spoiler">  <b class="spoiler_title">Final hotel search request</b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ), fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>) ), properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price)::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> average_night_price, rooms.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> room_id, is_room_fit_guests(<span class="hljs-built_in"><span class="hljs-built_in">ARRAY</span></span>[<span class="hljs-number"><span class="hljs-number">7</span></span>,<span class="hljs-number"><span class="hljs-number">9</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>,<span class="hljs-number"><span class="hljs-number">18</span></span>], room_price_policies.capacity) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> fit_people <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_prices <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> room_price_policies <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_prices.room_price_policy_id = room_price_policies.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_price_policies.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties room_properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_properties.id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> currency_rates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> currency_rates.sale_currency = room_properties.currency <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> currency_rates.buy_currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_availabilities <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rooms.id = room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> initial_count - sales_count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_availabilities.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) ra <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ra.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= price_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> price_date &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_date <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; room_price_policies.before_date) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.days_before_arrival <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.arrival_date - room_price_policies.days_before_arrival) ) <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, rooms.id, room_properties.currency, currency_rates.price, room_price_policies.capacity <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_prices.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ), properties_with_recommended_room <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>(property_id) *, <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_people = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, total ), properties_without_recommended_room <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span>(property_id) *, <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_rooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> property_id <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_recommended_room) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, total ), properties_with_cheapest_room <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_recommended_room <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_without_recommended_room ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> properties.*, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_id <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> room_available, properties_with_cheapest_room.arrival_date, properties_with_cheapest_room.departure_date, properties_with_cheapest_room.room_id, properties_with_cheapest_room.room_price_policy_id, properties_with_cheapest_room.total, properties_with_cheapest_room.average_night_price, properties_with_cheapest_room.all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties_with_cheapest_room <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties_with_cheapest_room.property_id = properties.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> ( (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'Place'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">9</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (properties.dest_type = <span class="hljs-string"><span class="hljs-string">'District'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> properties.dest_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">16</span></span>, <span class="hljs-number"><span class="hljs-number">17</span></span>)) ) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> all_guests_placed <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULLS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LAST</span></span>, room_available <span class="hljs-keyword"><span class="hljs-keyword">DESC</span></span>, total <span class="hljs-keyword"><span class="hljs-keyword">ASC</span></span> <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">20</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OFFSET</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span></code> </pre><br></div></div><br><h3>  Step 8. 3 cheapest rooms </h3><br>  Before giving the result to the user, for unsuitable hotels with available rooms as a separate sql query, select the 3 cheapest rooms.  The query is very similar to the search for hotels themselves.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Unless unique numbers are selected and only on specific hotels (from step 6). </font><font style="vertical-align: inherit;">Suppose that on the current page there are two such hotels, and their id is 1 and 4. The request </font></font><a href="http://sqlfiddle.com/"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">will be like this</font></font></a><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> .</font></font><br><br><div class="spoiler"> <b class="spoiler_title"><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">3 cheap rooms</font></font></b> <div class="spoiler_text"><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (property_id) arrival_date, property_id, <span class="hljs-keyword"><span class="hljs-keyword">abs</span></span>(<span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - arrival_date) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> days_diff <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> properties.id = property_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> - <span class="hljs-number"><span class="hljs-number">7</span></span> &lt;= arrival_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> arrival_date &lt;= <span class="hljs-string"><span class="hljs-string">'2018-01-02'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> + <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> property_id, days_diff ), fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> property_arrival_periods.arrival_date, property_arrival_periods.departure_date, property_arrival_periods.property_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> property_arrival_periods <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_rules <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> property_arrival_periods.property_id = fit_arrival_rules.property_id <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> property_arrival_periods.arrival_date = fit_arrival_rules.arrival_date <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> wanted_departure_range @&gt; (property_arrival_periods.arrival_date + <span class="hljs-number"><span class="hljs-number">6</span></span>) ), properties_with_available_rooms <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DISTINCT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> (rooms.id) rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">SUM</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> total, ( <span class="hljs-keyword"><span class="hljs-keyword">CASE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHEN</span></span> room_properties.currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">THEN</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price)::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ELSE</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">AVG</span></span>(room_prices.price) / <span class="hljs-keyword"><span class="hljs-keyword">COALESCE</span></span>(currency_rates.price, <span class="hljs-number"><span class="hljs-number">1</span></span>))::<span class="hljs-built_in"><span class="hljs-built_in">DECIMAL</span></span>(<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">END</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> average_night_price, rooms.id <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_prices <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> room_price_policies <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_prices.room_price_policy_id = room_price_policies.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_price_policies.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> properties room_properties <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> room_properties.id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> currency_rates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> currency_rates.sale_currency = room_properties.currency <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> currency_rates.buy_currency = <span class="hljs-string"><span class="hljs-string">'EUR'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> room_availabilities <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> rooms.id = room_availabilities.room_id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> initial_count - sales_count &gt; <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_id <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_availabilities.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) ra <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> ra.room_id = rooms.id <span class="hljs-keyword"><span class="hljs-keyword">INNER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> fit_arrival_dates <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> fit_arrival_dates.property_id = rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> fit_arrival_dates.arrival_date &lt;= price_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> price_date &lt; fit_arrival_dates.departure_date <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">FALSE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_date <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; room_price_policies.before_date) <span class="hljs-keyword"><span class="hljs-keyword">OR</span></span> (room_price_policies.has_special_requirements = <span class="hljs-literal"><span class="hljs-literal">TRUE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.before_type = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> room_price_policies.days_before_arrival <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> <span class="hljs-string"><span class="hljs-string">'2017-08-17'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> &lt; fit_arrival_dates.arrival_date - room_price_policies.days_before_arrival) ) <span class="hljs-keyword"><span class="hljs-keyword">GROUP</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> rooms.property_id, fit_arrival_dates.arrival_date, fit_arrival_dates.departure_date, room_price_policy_id, room_price_policies.meal_type, rooms.id, room_properties.currency, currency_rates.price <span class="hljs-keyword"><span class="hljs-keyword">HAVING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">COUNT</span></span>(room_prices.id) = (fit_arrival_dates.departure_date - fit_arrival_dates.arrival_date) ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> distinct_available_rooms.property_id, distinct_available_rooms.room_id, distinct_available_rooms.room_price_policy_id, distinct_available_rooms.total <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> LATERAL ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> properties_with_available_rooms <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> properties.id = properties_with_available_rooms.property_id <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> total <span class="hljs-keyword"><span class="hljs-keyword">LIMIT</span></span> <span class="hljs-number"><span class="hljs-number">3</span></span> ) distinct_available_rooms <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> distinct_available_rooms.property_id = properties.id <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> properties.id <span class="hljs-keyword"><span class="hljs-keyword">IN</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">4</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">ORDER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> distinct_available_rooms.total</code> </pre><br></div></div><br><h2>  Result </h2><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Acceleration of the search operation is dozens of times and this is with a relatively small amount of data, and over time the difference will be felt more and more. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And of course a ton of useful experience gained during the decision.</font></font></div><p>Source: <a href="https://habr.com/ru/post/338406/">https://habr.com/ru/post/338406/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../338394/index.html">Hidden costs in the implementation of CRM-systems. Field experience</a></li>
<li><a href="../338396/index.html">We connect Swagger module in Play Framework</a></li>
<li><a href="../338398/index.html">Libgdx Practical questions and answers</a></li>
<li><a href="../338402/index.html">Choosing a help desk system. 9 typical misconceptions</a></li>
<li><a href="../338404/index.html">We write for UEFI BIOS in Visual Studio. Part 2 - we create our first driver and speed debugging</a></li>
<li><a href="../338408/index.html">Sale of electronic signatures and related services</a></li>
<li><a href="../338410/index.html">IT vs AI: will cars be taken away from their creators?</a></li>
<li><a href="../338412/index.html">RailsClub 2017. Interview with Nikita Sobolev, the organizer of elixir-lang.moscow</a></li>
<li><a href="../338414/index.html">How operators form tariffs in different countries of the world</a></li>
<li><a href="../338416/index.html">10 things that hx writers hate</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>