<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>So damn scary or how we implemented online cashier</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article was written in the form of a post for Habr, mostly due to the fact that a real informational vacuum has arisen around the issue of online...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>So damn scary or how we implemented online cashier</h1><div class="post__text post__text-html js-mediator-article"><p>  This article was written in the form of a post for Habr, mostly due to the fact that a real informational vacuum has arisen around the issue of online cash registers for Internet sites.  On the one hand, the network is full of articles on the topic of online cash registers, on the other hand, there is not very much information about solutions for websites, especially technical ones.  Only the words that "urgently need to" and "will be fined."  We found this quest quite interesting and confusing, if you help someone, we will be happy. </p><br><p> <a href="https://habrahabr.ru/company/tm/blog/331368/"><img src="https://habrastorage.org/web/957/15c/000/95715c000fc94c219748379567254724.jpg" alt="Online ticket office"></a> </p><br><p>  What is an online cashier, how it interacts with the tax authorities and a general description of the technology can be found on specialized sites.  It also contains all the technical information on the products that we managed to find, in essence, this is the processing of our internal Wiki article on this topic. </p><a name="habracut"></a><br><p>  Perhaps the article will lose its relevance very soon, so that it is written as of mid-June 2017.  And yes, it seems like exactly for Internet sites selling services online, the deadline for implementation is not this year, but I don‚Äôt want to experiment with the tax authorities, and it‚Äôs better to prepare a sleigh in summer ... </p><br><p>  So, we sell online services on our sites (subscriptions).  We accept payments through Yandex.Cash and PayPal.  We work in white, all things.  Now, it turns out, we need a cash desk for settlements with individuals (except for paying them from our own bank account).  Somewhere in the payment chain on the website between the ‚Äúapproved‚Äù answer from the payment gateway and the service, you need to insert another operation ‚Äúto knock out a check‚Äù.  ‚ÄúWell, what problems, we rent an online cash desk service and that's it,‚Äù we decided.  And then the harsh reality showed: all beautiful ATOL <a href="http://atol.online/">-online</a> <a href="http://starrys.ru/ecommerce.html">landing pages</a> , <a href="http://starrys.ru/ecommerce.html">Starrus</a> and others are nothing more than advertising landings.  Today there are no SaaS solutions ready for operation; in any case, we could not find them.  As well as the vaunted integration of <a href="https://kassa.yandex.ru/blog/receipt">Yandex.Cash with ATOL-online</a> .  The same request for technical documentation in ATOL stalled right at the entrance, and Starrus advised to put stand alone instead of their unprepared SaaS.  Then it turned out <a href="http://insite-dv.ru/gde-vzyat-fiskal-ny-j-nakopitel/">juicy details about the situation with fiscal drives</a> and it was quite fun. </p><br><p><img src="https://habrastorage.org/web/c1b/ec8/9e2/c1bec89e2108414d8480bc1da6c6fe10.png" alt="Yandeks.Kassa - SPONISHED"></p><br><p>  As a result, after analyzing the market, including on the adequacy of communication with manufacturers' support, we stopped on a solution from Starrus: CCT RP RPF System.  We decided to purchase the complex, install it at our facilities and add our billing to interact with all of this. </p><br><p>  But at the beginning of some terminology: </p><br><ul><li>  KKT - cash register equipment.  In the context of the article - the cash register. </li><li>  FR - fiscal registrar.  In essence, the same as CCP. </li><li>  FN - fiscal drive.  A cryptographic tool in the FR. </li><li>  FD - fiscal document.  Check, PD number - check number. </li><li>  OP is a fiscal feature.  The reference value of PD. </li><li>  OFD - the operator of fiscal data.  An external service that receives and accumulates fiscal data. </li></ul><br><p>  Fiscal registrar RP System 1FS (FA) - the online cash register ( <abbr title="Cash register, in the context of the article - cash register.">CCT</abbr> ) of the new generation with automatic sending of fiscal data to the <abbr title="Fiscal data operator, an external service that receives and accumulates fiscal data.">CRF</abbr> .  Allows the network to accept commands in JSON format and "knock out checks."  All external interaction with the <abbr title="Fiscal data operator, an external service that receives and accumulates fiscal data.">OFD</abbr> is blackbox, it works independently and does not require any additional gestures. </p><br><h2 id="hardware">  Hardware </h2><br><p>  Officially, in the ‚Äúregistry‚Äù there is only the RP model of the 1FA System.  It is designed for vending machines and has a receipt printer included.  The model for Internet sites is called RP System 1FS, it is distinguished by the absence of a printer.  But since the RP model, the 1FS System is not in the registry, the RP model of the 1FA System, but without a printer in the kit, is being sold under its guise.  This information will avoid confusion when choosing and ordering <abbr title="Cash register, in the context of the article - cash register.">CCP</abbr> . </p><br><p>  The <abbr title="Cash register, in the context of the article - cash register.">CCP</abbr> itself is a small metal box painted with black paint.  Markings are marked on the case and all interface connectors are present in the end planes. </p><br><p><img src="https://habrastorage.org/web/d89/af3/920/d89af39201a54e64a81b908e8d11986f.jpg" alt="RP 1FA System"></p><br><p>  On the case there is a flap on the screw mount, followed by a compartment for the fiscal drive ( <abbr title="Fiscal storage, cryptographic tool in the composition of the FR.">FN</abbr> ), which works through the internal interface of the UART.  It will not allow the key to be inserted in the wrong way (muffled by pin), but considering the design features of the hatch, it is not easy to insert and especially remove the drive.  When registering and re-registering an <abbr title="Fiscal storage, cryptographic tool in the composition of the FR.">FN</abbr> , a corresponding entry is made in the <abbr title="Cash register, in the context of the article - cash register.">CCP</abbr> passport. </p><br><p><img src="https://habrastorage.org/web/531/b18/174/531b181748b5483a9e861904f1dee23b.jpg" alt="Hatch for fn"></p><br><p>  The generalized state of the <abbr title="Cash register, in the context of the article - cash register.">CCP</abbr> is displayed on the case by means of four LED indicators.  Status, data exchange, error status. </p><br><p>  Power is supplied from any stabilized DC source from 7.5 to 24 volts.  "Round" plug, "plus" inside.  The power supply unit is not included in the package, as a rule, they are not available from the supplier / manufacturer, they are advised to purchase third-party compatible. </p><br><p><img src="https://habrastorage.org/web/899/0e8/4d5/8990e84d51134726b9440661a981a9fe.jpg" alt="Side view"></p><br><p>  The Ethernet controller has a predefined address, or it receives settings via DHCP (DHCP priority over static settings). </p><br><p>  RS232 (DB-9 in / out) operates in 115200 mode and is used for local connection to a control computer and for connecting a receipt printer, if necessary.  At all stages of the standard interaction with <abbr title="Cash register, in the context of the article - cash register.">CCP</abbr> , starting with registration of the <abbr title="Fiscal storage, cryptographic tool in the composition of the FR.">FN</abbr> and ending with the ‚Äúpunching‚Äù of checks, it can be performed exclusively over a local network via Ethernet, without interacting with RS232. </p><br><p>  On the case there is a USB, but it has not been tested. </p><br><h2 id="fiskalnyy-nakopitel">  Fiscal drive </h2><br><p>  This module is a cryptographic tool, it stores fiscal data (checks), it also generates the result of cryptographic functions with input data (fiscal sign).  Structurally made of gray plastic with a holographic protective tape.  The interface connector provides power to the <abbr title="Fiscal storage, cryptographic tool in the composition of the FR.">FN</abbr> in the working mode and data exchange via the UART, I2C and RS232 protocols.  Inside there is a lithium battery that supports the internal clock (RTC).  <abbr title="Fiscal storage, cryptographic tool in the composition of the FR.">FN</abbr> has an artificially limited period of validity and must be replaced every 13 months. </p><br><p><img src="https://habrastorage.org/web/b96/1a3/d62/b961a3d622064a519d922c5cb541bde4.jpg" alt="FN"></p><br><h2 id="software">  Software </h2><br><p>  It is possible to interact with <abbr title="Cash register, in the context of the article - cash register.">CCT</abbr> through the RS232 interface, or over a local network using the JSON protocol, which communicates via an HTTP connection to port 4444, as well as a "binary" connection to TCP port 3333. </p><br><p>   <code>TestFR</code>,      <abbr title="- ,    ‚Äî  ."></abbr>   RS232,    .      Windows,   ¬´¬ª    .    ,     <abbr title=" ,     ."></abbr>,       ,    <abbr title=" ,     ."></abbr>    ,    .   <abbr title=" ,     ."></abbr>,      .</p><br>
<p><img src="https://habrastorage.org/web/5ff/368/7e5/5ff3687e58db402e801750087fff9da9.png" alt="  "></p><br>
<h2 id="vsya-procedura-vnedreniya">  </h2><br>
<h3 id="priobretenie-kkt"> </h3><br>
<p><abbr title="- ,    ‚Äî  ."></abbr>    / ,       .     .</p><br>
<h3 id="priobretenie-fn"> </h3><br>
<p><abbr title=" ,     ."></abbr>     .  <abbr title=" ,     ."></abbr> ( )           .    ¬´¬ª <abbr title=" ,     ."></abbr>  .  ¬´¬ª   ,     ,      .         <abbr title=" ,     ."></abbr>,        .  .    <abbr title=" ,     ."></abbr>    ¬´¬ª  <abbr title="  ,  ,      ."></abbr>,        <abbr title=" ,     ."></abbr>     ¬´ ¬ª,           -.        <abbr title=" ,     ."></abbr>  ¬´¬ª         .      <abbr title=" ,     ."></abbr>  <a href="https://www.nalog.ru/css/check_kiz/checkFN.html">  </a>.</p><br>
<p><img src="https://habrastorage.org/web/ecd/c63/ff9/ecdc63ff99634c33a0ea24b178995788.png" alt="  "></p><br>
<h3 id="priobretenie-kep"> </h3><br>
<p>      <abbr title="- ,    ‚Äî  ."></abbr>       .  ,        <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title="  ,  ,      ."></abbr>,   <abbr title="- ,    ‚Äî  ."></abbr>       .       ( )            ,       <abbr title="- ,    ‚Äî  ."></abbr>. ,        .</p><br>
<p><img src="https://habrastorage.org/web/ad7/7d2/08d/ad77d208d67e493eb5f7a0a41cdf68e6.jpg" alt="  "></p><br>
<h3 id="zaklyuchenie-dogovora-s-ofd">   </h3><br>
<p>   <abbr title="  ,  ,      ."></abbr> (  )  <a href="https://www.nalog.ru/rn77/related_activities/registries/fiscaloperators/">   </a>.  ,    <abbr title="- ,    ‚Äî  ."></abbr>    .    3000           .</p><br>
<p><em>     ,      .    .</em></p><br>
<h3 id="registraciya-kkt-s-fn-v-fns">     </h3><br>
<p>    .  ,  3-way handshake.        (       ). </p><br>
<h4 id="poluchenie-registracionnogo-nomera-kkt-v-fns">     </h4><br>
<p>               <abbr title="- ,    ‚Äî  ."></abbr>   .  :    <abbr title=" ,     ."></abbr>  <abbr title="- ,    ‚Äî  ."></abbr>       (    ),     ,   ¬´-¬ª    <abbr title="- ,    ‚Äî  ."></abbr>     .       <abbr title="- ,    ‚Äî  ."></abbr>,     .</p><br>
<h4 id="vvod-dannyh-v-kkt-i-inicializaciya-fn">      </h4><br>
<p><strong>   ,     <abbr title=" ,     ."></abbr>      <abbr title=" ,     ."></abbr>  ,        !</strong></p><br>
<p>     <code>TestFR</code>.      <abbr title=" ,     ."></abbr>  <abbr title="- ,    ‚Äî  ."></abbr>,       .   ¬´ ¬ª  ,  11  .       , ,   <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title=" ,     ."></abbr>,   <abbr title="- ,    ‚Äî  ."></abbr>,  .      <abbr title="  ,  ,      ."></abbr>   .   <abbr title="- ,    ‚Äî  ."></abbr>            (<abbr title="  ‚Äî ,   ‚Äî  ."></abbr>)   1 ‚Äî ¬´  ¬ª.         (<abbr title=" ,    ."></abbr>),      <abbr title=" ,     ."></abbr>. ,   <abbr title="  ‚Äî ,   ‚Äî  ."></abbr>                <abbr title=" ,    ."></abbr>.</p><br>
<p> -    (   )    <abbr title="  ‚Äî ,   ‚Äî  ."></abbr> - ,    <abbr title="  ‚Äî ,   ‚Äî  ."></abbr>       ¬´8. ¬ª, ¬´   ¬ª,      1.     , ,    <code>TestFR</code>,     .     <code>CTRL+A</code>    .</p><br>
<h4 id="podtverzhdenie-registracii-kkt-v-fns">    </h4><br>
<p>                <abbr title="- ,    ‚Äî  ."></abbr>,           <abbr title="- ,    ‚Äî  ."></abbr>.         <abbr title="- ,    ‚Äî  ."></abbr>,        <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title=" ,     ."></abbr>.</p><br>
<h3 id="sostavlenie-aktov-i-zapolnenie-pasportov">    </h3><br>
<p>      <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title=" ,     ."></abbr>,       <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title=" ,     ."></abbr>.              .       .</p><br>
<p><img src="https://habrastorage.org/web/6c5/caf/d8c/6c5cafd8ce9246d5a6363c81ecded9e5.jpg" alt="   "></p><br>
<h3 id="podklyuchenie-kkt-v-ofd">   </h3><br>
<p>      <abbr title="- ,    ‚Äî  ."></abbr>     <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title="  ,  ,      ."></abbr>,          <abbr title="- ,    ‚Äî  ."></abbr>   .  <abbr title="  ,  ,      ."></abbr>    ,      .      , <abbr title="- ,    ‚Äî  ."></abbr>    <abbr title="  ,  ,      ."></abbr>.</p><br>
<p>     <abbr title="- ,    ‚Äî  ."></abbr>   .</p><br>
<h3 id="rabota-s-kkt">  </h3><br>
<p>   <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title=" ,     ."></abbr>  <abbr title=" ,    ."></abbr>       <abbr title="  ,  ,      ."></abbr>.      <abbr title="- ,    ‚Äî  ."></abbr>     <abbr title="  ‚Äî ,   ‚Äî  ."></abbr>.      <abbr title="  ,  ,      ."></abbr>, <abbr title="- ,    ‚Äî  ."></abbr>      .    .</p><br>
<p>         .         ‚Äî .       :</p><br>
<ul>
<li>     1: <a href="https://drive.google.com/open%3Fid%3D0B-XKv4yQvbPTWndMdXA5WEw0M0E"> </a>, <a href="https://habrastorage.org/storage/stuff/habr/rpsystem1fs.pdf"></a></li>
<li>     1: <a href="https://drive.google.com/open%3Fid%3D0B-XKv4yQvbPTZm1oajlRUmdTTU0"> </a>, <a href="https://habrastorage.org/storage/stuff/habr/rpsystem1fa.pdf"></a></li>
<li><a href="https://habrastorage.org/storage/stuff/habr/rpsystemprotocol.pdf"> </a></li>
</ul><br>
<p>       <abbr title="- ,    ‚Äî  ."></abbr>  <abbr title="  ,  ,      ."></abbr>,    .       .         .</p><br>
<p>  ¬´¬ª,  ,  -      Complex.      ,      ,   .    ,        -      .</p><br>
<p>  Complex     :</p><br>
<pre><code>{
    "Group": "%personal_uuid%",
    "Device": "auto",
    "RequestId": "%unique_request%",
    "QueueLen": 100,
    "Password": 1,
    "Lines": [{
            "Qty": 2500,
            "Price": 10000,
            "PayAttribute": 4,
            "TaxId": 1,
            "Description": "  "
        }, {
            "Qty": 500,
            "Price": 200000,
            "PayAttribute": 4,
            "TaxId": 2,
            "Description": " , "
        }
    ],
    "Cash": 200000,
    "NonCash": [2000, 3000, 4000],
    "TaxMode": 1,
    "PhoneOrEmail": "%customer_contact%",
    "FullResponse": false
}</code></pre><br>
<p>  <code>RequestId</code>  ,        .      ,   ,       ,       .</p><br>
<p>       ,    .  ¬´¬ª   n  .  ,   : , ,       .    .</p><br>
<p>  <code>FullResponse</code>  true    ,     ,      . </p><br>
<p>      100,      .</p><br>
<p>    ,       <code>Qty</code> = 1000.</p><br>
<p> <code>Cash</code>          (  -   )</p><br>
<p> <code>NonCash</code>         ,             .      .</p><br>
<p> <code>TaxMode</code> ‚Äî    (   ).</p><br>
<h2 id="integraciya"></h2><br>
<p>     <abbr title="- ,    ‚Äî  ."></abbr>   ,       ¬´¬ª  .         1   1-    API,      .</p><br>
<p>     <abbr title="- ,    ‚Äî  ."></abbr>   ,     API.     ,    ,     .           <abbr title="- ,    ‚Äî  ."></abbr>,     .     <abbr title="  ,  ,      ."></abbr>,      .   ,  <abbr title="  ‚Äî ,   ‚Äî  ."></abbr>              .                      .         , ,  ,   .</p><br>
<h2 id="pyatiminutka-nenavisti"> </h2><br>
<p>    , ¬´  ,    ¬ª.      ¬´¬ª:</p><br>
<ul>
<li>          .  ¬´¬ª    <abbr title=" ,     ."></abbr>.         <abbr title=" ,     ."></abbr>  - ,    ‚Äî    .</li>
<li> ,       ¬´¬ª.    ¬´¬ª  ¬´¬ª,    .</li>
<li> ,           .  ¬´¬ª     <code>TestFR.exe</code>,       ‚Äî .  ¬´¬ª    . ,  ,      ,     .</li>
<li>,    -,      <abbr title="  ,  ,      ."></abbr>        .    ¬´ ¬ª,      ,           <abbr title="  ,  ,      ."></abbr>,     .  ,          (     ).</li>
</ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/331368/">https://habr.com/ru/post/331368/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../331356/index.html">Laws and projects that will change the face of Russian IT. Part II</a></li>
<li><a href="../331358/index.html">Configuring the TheOnionBox web interface to monitor Tor's relay node</a></li>
<li><a href="../331360/index.html">Useful features of Google Spreadsheet that are not in Excel</a></li>
<li><a href="../331364/index.html">Russian students dominate programming contests and American students are not surprised</a></li>
<li><a href="../331366/index.html">How to become an independent registrar .RU / .–†–§</a></li>
<li><a href="../331370/index.html">Features of the organization of the IT infrastructure for video surveillance</a></li>
<li><a href="../331374/index.html">How to implement configuration management processes</a></li>
<li><a href="../331376/index.html">Introduction to the ITIL methodology in ITSM</a></li>
<li><a href="../331378/index.html">Introduction to the ISO 20000 standard: Where it came from and how to certify a company</a></li>
<li><a href="../331380/index.html">Financial Management: How to estimate the cost of the services provided</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>