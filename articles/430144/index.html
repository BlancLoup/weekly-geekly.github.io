<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We simulate a realistic river in Houdini and Unreal Engine 4</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When the transition from DX9 to DX10 began, many games began to appear with coolly modeled water with the right effects. Then the difference was very ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We simulate a realistic river in Houdini and Unreal Engine 4</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/webt/zo/cc/o4/zocco49yvcnsbel4siyce03w1jm.jpeg"><br><br>  When the transition from DX9 to DX10 began, many games began to appear with coolly modeled water with the right effects.  Then the difference was very noticeable, especially if we compare the games of past generations and the same Crysis.  Therefore, when I came across a guide, how to make a simple but realistic simulation of the river through the Houdini plug-in for UE4, I didn‚Äôt even think about it and quickly translated it. <br><a name="habracut"></a><br><h3>  Prologue </h3><br><ul><li>  Download Unreal and Houdini <a href="">assets</a> .  Installation video - <a href="https://youtu.be/9nFlCxEx4XI">here</a> . </li><li>  Most of the project I followed the tutorials of <a href="https://www.sidefx.com/community/horizon-zero-dawn-guerrilla-games/">Ben Shriver</a> and <a href="https://vimeo.com/243733565">Andreas Glad</a> . </li><li>  Do not be afraid of nodes and scripts.  It is not as difficult as it may seem. </li><li>  For water, I used the normal map from Unreal Starter content. </li></ul><br><h3>  Introduction </h3><br>  My name is Simon.  I started programming in QBasic and Pascal when I was young (here are some <a href="https://twitter.com/simonschreibt/status/624316758686437376">examples</a> ), I immediately realized that it was difficult to code, and switched to 3D art.  At the same time, I always kept my interest in the technical side of creating games - it turned out that I became a VFX artist.  This profession combines art and technology well. <br><br>  I worked as a 3D artist on <a href="https://store.steampowered.com/app/225640/Sacred_2_Gold/">Sacred 2</a> and <a href="https://www.egosoft.com/games/x_rebirth/info_en.php">X: Rebirth</a> , and a VFX artist on <a href="http://www.tequilaworks.com/en/projects/rime/">RiME</a> , <a href="http://www.tequilaworks.com/en/projects/the-invisible-hours/">The Invisible Hours</a> .  I'm currently working on <a href="http://wildsheepstudio.com/">WiLD</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/webt/kv/d3/0o/kvd30oaovx4wnjixasgjvz3fylg.jpeg"><br><br>  I also have several personal projects related to game development: <a href="https://simonschreibt.de/">Game Art Trick</a> blog, German <a href="https://gamedevpodcast.de/">Game Dev Podcast,</a> and YouTube channels with <a href="https://www.youtube.com/channel/UC9go9jWq2w4iDdZ162ulmug/videos">Unreal</a> tutorials and <a href="https://www.youtube.com/channel/UCHKNOUwxyld0UVTIOk4E0zw/videos">Houdini</a> . <br><br><h3>  Meet Houdini </h3><br>  I made friends with Houdini while working on The Invisible Hours.  Then I made a small fluid simulator that could be paused, deployed and played backwards in real time.  The result was: <br><br><img src="https://habrastorage.org/webt/vj/do/pq/vjdopq_bwik4j18nz56askkairm.gif"><br>  <i>Source: <a href="https://youtu.be/aYZEmaQUrAo%3Ft%3D2103">Fluid Simulation from The Invisible Hours</a></i> <br><br>  I had no idea how to add fluid modeling to Unreal.  Fortunately, an amazing technology called <a href="http://norman3d.com/TextureMorphTargets/Vertex-count-agnostic_Morph_Targets.pdf">Vertex-Count-Agnostic Morph Target-Based Fluid Animation</a> was implemented in Houdini, so I was able to add my fluid simulation to the game.  The technology was originally developed by <a href="https://twitter.com/norman3d">Norman Shaar</a> . <br><br><img src="https://habrastorage.org/webt/ih/2w/_w/ih2w_wc1hwwkj6eoaop-swctcri.gif"><br>  <i>Source: <a href="https://www.youtube.com/watch%3Fv%3DTj3Bz9OFQlE">Vertex-Count-Agnostic Morph targets in UE4 by Norman Shaar</a></i> <br><br>  If you want to learn more about the implementation, then look at this section of my report Cool Stuff with Textures: <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/aYZEmaQUrAo" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><h3>  Effect of the river: the beginning of the project </h3><br>  I wanted to learn how to make a procedurally-generated river for the <a href="https://realtimevfx.com/c/Events/17-river">Realtime VFX River Challenge</a> , but I had no idea where to start.  By chance, I stumbled upon a posh <a href="https://www.sidefx.com/community/horizon-zero-dawn-guerrilla-games/">tutorial from Ben Shriver</a> , where he talks about rivers at Horizon Zero Dawn.  I was hooked and I decided to try it! <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/216727778" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  By the way, there is another very cool tutorial along the Houdini rivers from <a href="https://twitter.com/PartikelVFX">Andreas Glad</a> : <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/.googleusercontent.com/translate_c?depth=1&amp;rurl=translate.google.com&amp;sl=ru&amp;sp=nmt4&amp;tl=en&amp;u=https://player.vimeo.com/video/243733565" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br>  These videos helped me a lot in the beginning and became the foundation. <br><br><h3>  A very difficult way to build landscapes. </h3><br>  The relief was very difficult.  I will illustrate the creation process so that everyone understands: <br><br><img src="https://habrastorage.org/webt/cg/xz/bj/cgxzbjhkufvwcv8gw82rpzrzr1k.gif"><br>  <i>Source: <a href="https://www.sidefx.com/products/houdini/">Houdini Creation</a></i> <br><br>  Just kidding  It's too easy. <br><br><h3>  River effect </h3><br>  The first steps are 100% copied from Ben's tutorial, and they are cool.  First you create a spline and let it ‚Äúfall‚Äù on the ground.  This is done by reading the height of the relief at the points of the spline, and then moving the points to this height: <br><br><img src="https://habrastorage.org/webt/us/yi/xw/usyixwesrlu0b3gnqcsotytydfm.gif"><br><br>  Then you allow spline points to ‚Äúroll‚Äù down the slope to better integrate the river into the relief: <br><br><img src="https://habrastorage.org/webt/ml/zp/-h/mlzp-hvsp1fjpxrpov-rvs6ycyu.gif"><br><br>  In fact, they do not roll down in a physical way.  Instead, the base surface normal and point normal are used to calculate the local axis for each point (which moves down the slope from the spline).  Then you move points a little along the computational axis (this process is very well shown in Ben's video). <br><br>  The next step is to make sure that the river does not flow upstream due to the landscape (because there is a small hill where the river goes along). <br><br><img src="https://habrastorage.org/webt/sd/j2/kw/sdj2kwej7nwjgxii1cwollgw2eu.jpeg"><br><br>  A small Python script ensures that the spline point in 3D space will never be higher than the previous one: <br><br><img src="https://habrastorage.org/webt/ug/b-/y1/ugb-y1cw7pd3cuzph48diedsm7w.gif"><br><br>  Another trick to add naturalness is avoiding continuous slopes.  Instead, let the river flow in stages (for better visualization, I show the geometry of the river here, but in fact we are still working with only one spline). <br><br><img src="https://habrastorage.org/webt/vp/cj/65/vpcj65p-xzp9zb26uzeqvnrddts.gif"><br><br>  Finally, we reach the step where I bring in my own ideas: add colors to the spline to mark where the slope is (green), where it starts (turquoise) and where it ends (red).  This will help me later to mix different water textures and place particle systems. <br><br><img src="https://habrastorage.org/webt/34/kk/je/34kkjekzjvkt1vk71sadbdiw8mk.jpeg"><br><br>  Let's quickly move on to creating the geometry of a river, since all of this is perfectly explained in Ben's video.  The most important point is that only the outer edges of the river are again aligned with the relief (as we did with the spline in the first place): <br><br><img src="https://habrastorage.org/webt/cb/k_/0o/cbk_0oekhh4qv0_rwaxcsh-n1ey.gif"><br><br><h3>  Deforming the landscape according to the flow </h3><br>  Again, this is Ben‚Äôs 100% workflow, starting with the movement of the relief below the river‚Äôs geometry, so that they don‚Äôt intersect in any way: <br><br><img src="https://habrastorage.org/webt/ao/a1/ad/aoa1adr5lgjo6qdqhyxiwc6vv_u.gif"><br><br>  Then for each point of the terrain you draw rays up.  If they fall into the geometry of the river, then these points will move up to the point of impact: <br><br><img src="https://habrastorage.org/webt/w3/ap/nm/w3apnmoupwccs1xzv0pvqmowmgs.gif"><br><br>  Each point that has not got anywhere will receive an initial height. <br><br><img src="https://habrastorage.org/webt/vo/pq/70/vopq70pbljo9t--vuuvs6d4ekto.gif"><br><br>  This gif shows what happens when the spline changes: <br><br><img src="https://habrastorage.org/webt/tv/ej/ly/tvejlykun03wkeuvisao1o-vg-4.gif"><br><br>  Then the height area of ‚Äã‚Äãthe landscape is converted into polygons and re-mixed.  Now it is ready for use in Unreal: <br><br><img src="https://habrastorage.org/webt/5s/z8/bx/5sz8bxsdmnktiotlc83wajh5yh4.gif"><br><br>  Now let's talk about UV conversion, materials, current maps and much more. <br><br><h3>  River geometry </h3><br>  The geometry of the river, which you saw before, was used only for cutting the terrain.  This river is a bit thinner, has UV and was divided (note that my colors of the slopes are still there): <br><br><img src="https://habrastorage.org/webt/sv/b8/av/svb8avrrg1gd_1uhxo38kqry_sy.jpeg"><br><br><h3>  UV generation </h3><br>  Since the spline always varies in length, UV must adapt to this.  Fortunately, it is very easy in Houdini.  First you create UV in 0-1-UV-Space, and then measure the length of the spline.  This value can be used to scale UV.  Here you see how I change the spline, and at the bottom - how UV automatically adapts.  Believe me, if you once tried this, then never again want to create UV manually. <br><br><img src="https://habrastorage.org/webt/wc/xt/bg/wcxtbgtruxdphsewttvvxhz6htk.gif"><br><br><h3>  Channel </h3><br>  One more detail: I wanted to make the course darker and wet.  To do this, I spend up a few rays from each polygon of the landscape, and if I get into the river, I assign color to all points of this polygon.  The created mask looks like this: <br><br><img src="https://habrastorage.org/webt/7n/y5/0y/7ny50yh2opc_nw8vnz7uxbyimxk.jpeg"><br><br>  And here is an example using a mask in a material to assign different values ‚Äã‚Äãof vagueness and roughness: <br><br><img src="https://habrastorage.org/webt/lm/3j/q0/lm3jq0smmrte5rgngq41quczlfk.gif"><br><br><h3>  Flow map </h3><br>  Creating a flow map with Houdini is very easy.  You just say to the special node ‚Äúthis is my river geometry, and this is a spline that indicates the direction of the river‚Äù and a boom, the geometry suddenly gets the vertex colors representing the flow of the river: <br><br><img src="https://habrastorage.org/webt/lo/ni/so/lonisoo-qw1n5sm0fkyvlrrzv6s.gif"><br><br>  You can add another node that will make the flow map respond to obstacles.  Now the water will flow around them: <br><br><img src="https://habrastorage.org/webt/tf/js/le/tfjsle853agjxektemwpibn23ao.gif"><br><br>  And the coolest: you can cause the baking of the flow map in Unreal!  No need to switch between Unreal and Houdini.  Just set the Render button in Houdini as a parameter.  Here you see how I change the obstacles, and then visualize the new flow map (note that baking takes longer than on the gif): <br><br><img src="https://habrastorage.org/webt/cm/6g/n7/cm6gn7hlvksqupcuvohwt6y31xw.gif"><br><br><h3>  Foam mask </h3><br>  To make foam on the water around the obstacles, I use the so-called isoOffset node.  It mainly stores the distance to the object in the color of the top of the river.  Then I added some noise and the mask is ready: <br><br><img src="https://habrastorage.org/webt/su/_b/jq/su_bjqg4awfkxsp4gv4gitep2cu.gif"><br><br>  To make the foam mask less static, I use a simple cloud-based Photoshop template, which I move along the river and subtract it from the original mask: <br><br><img src="https://habrastorage.org/webt/_j/xd/re/_jxdrekk6uxwlynw0dmmqri8l2g.gif"><br><br>  And since we are talking about foam: the cascades also have a simple foam texture, which is shown only on the slope of the river.  The foam structure scrolls faster than river water: <br><br><img src="https://habrastorage.org/webt/dc/s0/vl/dcs0vler9nwiru_ll82wbonigvq.gif"><br><br><h3>  Particle systems </h3><br>  I noted where the upper and lower parts of my cascade are located, so I can filter these elements (the lines were used to create the geometry of the river), create a point in their center and copy the dummy-box into it.  Later we will replace it with the particle system in Unreal: <br><br><img src="https://habrastorage.org/webt/yx/wk/uj/yxwkujd9hyyriqlse1pwytkg9ea.gif"><br><br>  For particles around obstacles, I use a node called Intersection Analysis to get the intersection of obstacles and the river.  These intersection edges have points.  To their random number, I again copy the dummy-box (which later exchanges with the particle system in Unreal): <br><br><img src="https://habrastorage.org/webt/2p/cz/67/2pcz67ex6i3arika_ktlfpb9nae.gif"><br><br>  So it looks like when I replace the dummy-boxes in Unreal: <br><br><img src="https://habrastorage.org/webt/u7/wh/ze/u7whze-vypqb9dlftd1e-t8dhvc.gif"><br><br><h3>  Export project to Unreal </h3><br>  The so-called Houdini engine is a plug-in for Unity, Unreal, 3ds Max, Maya and Cinema 4D and executes the network of nodes that you create in Houdini directly in the specified programs.  I need to make the terrain and river appear to save the Houdini file as a digital asset.  It can be imported and used like any other resource in Unreal: <br><br><img src="https://habrastorage.org/webt/uj/s_/ak/ujs_ak1r7u9sazit7ruj1oh0zm8.gif"><br><br>  Now I can change the parameters (which I set in Houdini) or change the spline so that the river flows in a different way: <br><br><img src="https://habrastorage.org/webt/yk/na/_q/ykna_qoftdpvnkh6paoqpurknl0.gif"><br><br>  Materials are still being created and assigned to Unreal, but you can pre-assign them (my tutorial on this below). <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/U4uLy1P3X4g" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br><h3>  Should we study Houdini workflows in the same way? </h3><br>  There is much to learn in Houdini.  In addition, these are new development tools, so there will be inaccuracies in the documentation. <br><br>  But this is a common situation for game developers.  We are constantly working with advanced technologies that need to be tamed first.  Most importantly: you are not alone.  <a href="https://discordapp.com/invite/b8U5Hdy">Thinking Procedural Discord</a> is full of cool guys who will help and teach.  You can even find SideFX developers in these chat rooms! <br><br><h3>  Links </h3><br><ul><li>  Unreal and Houdini <a href="">Assets</a> .  Installation video - <a href="https://youtu.be/9nFlCxEx4XI">here</a> . </li><li>  <a href="https://discordapp.com/invite/b8U5Hdy">Chat Discord: Houdini Thinking Procedural</a> </li><li>  <a href="https://www.sidefx.com/community/horizon-zero-dawn-guerrilla-games/">Ben Shriver Tutorial</a> </li><li>  <a href="https://vimeo.com/243733565">Andreas Glad Tutorial</a> </li><li>  <a href="https://realtimevfx.com/c/Events/17-river">River challenge thread</a> </li><li>  <a href="https://www.youtube.com/watch%3Fv%3DaYZEmaQUrAo">Liquid Implementation Report in The Invisible Hours</a> </li><li>  YouTube feeds with tutorials on <a href="https://www.youtube.com/channel/UC9go9jWq2w4iDdZ162ulmug/videos">Unreal</a> and <a href="https://www.youtube.com/channel/UCHKNOUwxyld0UVTIOk4E0zw/videos">Houdini</a> </li><li>  <a href="http://norman3d.com/TextureMorphTargets/Vertex-count-agnostic_Morph_Targets.pdf">Vertex-count-agnostic Morph Targets by Norman Shaar</a> </li></ul></div><p>Source: <a href="https://habr.com/ru/post/430144/">https://habr.com/ru/post/430144/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../430134/index.html">Trading robot optimization algorithms: an effective way to trade a million in hindsight</a></li>
<li><a href="../430136/index.html">How Starlink will launch - satellite Internet from Ilona Mask</a></li>
<li><a href="../430138/index.html">Optimizing the trading robot: a genetic algorithm</a></li>
<li><a href="../430140/index.html">Five reasons for SEO failure. Analysis of unsuccessful promotion experience with examples</a></li>
<li><a href="../430142/index.html">Is your Windows so old?</a></li>
<li><a href="../430146/index.html">The math in Gamedev is simple. Vectors and integrals</a></li>
<li><a href="../430148/index.html">Personal data leakage from Moscow MFC</a></li>
<li><a href="../430152/index.html">Build your own professional-grade audio amplifier is not (very) expensive</a></li>
<li><a href="../430154/index.html">"Revival of AI" - no more than expensive iron and advertising, thrown on the implementation of the old idea</a></li>
<li><a href="../430156/index.html">‚ÄúSoar or not‚Äù: a new player will appear on the market of video streaming services</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>