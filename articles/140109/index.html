<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Grid update via ajax</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, habrasoobschestvo! 

 In this topic, I want to discuss the most appropriate use of the CGridView component in Yii. 
 Below I will describe 3 ways ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Grid update via ajax</h1><div class="post__text post__text-html js-mediator-article">  Hi, habrasoobschestvo! <br><br>  In this topic, I want to discuss the most appropriate use of the <b>CGridView</b> component in Yii. <br>  Below I will describe 3 ways that I personally see, and I will be glad to hear your ideas in the comments. <br><br><img src="https://habrastorage.org/storage2/739/811/ed5/739811ed5220212acabf8b772edaca35.png">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So, the <b>task</b> : <br>  <i>A page with several blocks is required, one of which must have a table (grid).</i> <i><br></i>  <i>Need the ability to sort and page-by-page navigation of the grid via ajax.</i> <br><br>  It sounds easy, is not it?  Let's see what Yii offers us. <br><a name="habracut"></a><br><h4>  Method 1. Standard CRUD Generatror </h4><br>  The generated code contains 1 action in the controller and 1 view: <br>  <b>Controller:</b> <br><pre><code class="php hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionAdmin</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $model=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(<span class="hljs-string"><span class="hljs-string">'search'</span></span>); $model-&gt;unsetAttributes(); <span class="hljs-comment"><span class="hljs-comment">// clear any default values if(isset($_GET['Product'])) $model-&gt;attributes=$_GET['Product']; $this-&gt;render('index',array( 'model'=&gt;$model, )); }</span></span></code> </pre> <br>  <b>index.php</b> : <br><pre> <code class="php hljs">... <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.grid.CGridView'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'product-grid'</span></span>, <span class="hljs-string"><span class="hljs-string">'dataProvider'</span></span>=&gt;$model-&gt;search(), <span class="hljs-string"><span class="hljs-string">'filter'</span></span>=&gt;$model, ...</code> </pre><br><br>  In general, everything works, but <b>every time you use ajax sorting or navigation in the grid, the server returns the full html-code of the page!</b>  From which only a small html-piece is used to update the grid.  If the page contains several elements (for example, one more grid), then all of them on the server side are processed for nothing.  Not the most optimal solution in my opinion. <br><br><h4>  Method 2. All through Ajax </h4><br>  To solve the problem of method 1, create a separate action and view to form a grid.  They will work only through Ajax and return the content via the renderPartial () method, which will leave only the necessary html for the grid: <br>  <b>Controller:</b> <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionGrid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Yii::app()-&gt;request-&gt;isAjaxRequest) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(<span class="hljs-string"><span class="hljs-string">'Url should be requested via ajax only'</span></span>); $model=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(<span class="hljs-string"><span class="hljs-string">'search'</span></span>); $model-&gt;unsetAttributes(); <span class="hljs-comment"><span class="hljs-comment">// clear any default values if(isset($_GET['Product'])) $model-&gt;attributes=$_GET['Product']; $this-&gt;renderPartial('_grid',array( 'model'=&gt;$model, )); }</span></span></code> </pre><br>  <b>_grid.php</b> contains only the widget code: <br><pre> <code class="php hljs">... <span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.grid.CGridView'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'product-grid'</span></span>, <span class="hljs-string"><span class="hljs-string">'dataProvider'</span></span>=&gt;$model-&gt;search(), <span class="hljs-string"><span class="hljs-string">'filter'</span></span>=&gt;$model, ...</code> </pre><br>  and <b>index.php</b> pulls up the grid when the page first loads: <br><pre> <code class="php hljs"> &lt;div id=<span class="hljs-string"><span class="hljs-string">"grid-container"</span></span>&gt;&lt;/div&gt; yii::app()-&gt;clientScript-&gt;registerScript(<span class="hljs-string"><span class="hljs-string">'load-grid'</span></span>, <span class="hljs-string"><span class="hljs-string">' $("#grid-container").load("product/grid"); '</span></span>);</code> </pre><br><br>  It looks neat, but does not work :) <b>The renderPartial () method does not return the necessary JS and CSS files to the grid!</b>  Only Html. <br>  But stop!  RenderPartial () has an additional parameter, called ‚Äúprocess output‚Äù, which allows you to return js and css. <br>  Change <b>in the controller</b> : <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionGrid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Yii::app()-&gt;request-&gt;isAjaxRequest) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(<span class="hljs-string"><span class="hljs-string">'Url should be requested via ajax only'</span></span>); $model=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(<span class="hljs-string"><span class="hljs-string">'search'</span></span>); $model-&gt;unsetAttributes(); <span class="hljs-comment"><span class="hljs-comment">// clear any default values if(isset($_GET['Product'])) $model-&gt;attributes=$_GET['Product']; $this-&gt;renderPartial('_grid',array( 'model'=&gt;$model, ), false, true); }</span></span></code> </pre><br>  We <b>load the</b> page and again we see bjaku: <b>jquery.js and the rest of the scripts start loading every time we update the grid via ajax!</b> <br>  Of course, they should be loaded once, but renderPartial () returns them regularly with each request. <br>  How to disable reloading scripts?  To do this, you can put a separate <a href="http://www.yiiframework.com/extension/nlsclientscript">extension</a> , which, with ajax requests, cuts out the scripts already loaded on the page. <br>  Voila, it works!  But personally, I expect Yii to solve this problem by standard means, without extensions ... <br><br><h4>  Method 3. All through Ajax, except for the first time </h4><br>  And what if for the first time to load the grid with a regular request, and then update via ajax? <br>  <b>In the controller,</b> everything remains almost unchanged, just remove the isAjaxRequest check and in the renderPartial without additional parameters: <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">actionGrid</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!Yii::app()-&gt;request-&gt;isAjaxRequest) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CHttpException(<span class="hljs-string"><span class="hljs-string">'Url should be requested via ajax only'</span></span>); $model=<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Product(<span class="hljs-string"><span class="hljs-string">'search'</span></span>); $model-&gt;unsetAttributes(); <span class="hljs-comment"><span class="hljs-comment">// clear any default values if(isset($_GET['Product'])) $model-&gt;attributes=$_GET['Product']; $this-&gt;renderPartial('_grid',array( 'model'=&gt;$model, )); }</span></span></code> </pre><br>  In the main <b>index.php</b> view, we directly call the actionGrid (): <br><pre> <code class="php hljs"> &lt;div id=<span class="hljs-string"><span class="hljs-string">"grid-container"</span></span>&gt;<span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;actionGrid(); <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span>&lt;/div&gt;</code> </pre><br>  and in <b>_grid.php we</b> set the <b>ajaxUrl</b> parameter for future update of the grid.  Otherwise, ajaxUrl will be taken from the current url (for example, product / index): <br><pre> <code class="php hljs"> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.grid.CGridView'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'product-grid'</span></span>, <span class="hljs-string"><span class="hljs-string">'dataProvider'</span></span>=&gt;$model-&gt;search() , <span class="hljs-string"><span class="hljs-string">'filter'</span></span>=&gt;$model, <span class="hljs-string"><span class="hljs-string">'ajaxUrl'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(<span class="hljs-string"><span class="hljs-string">'product/grid'</span></span>), ...</code> </pre><br>  We look at the result: <b>initially the grid loads correctly, but navigation does not work!</b> <br>  Links from pages continue to point to product / index instead of product / grid.  Studying the yii code showed that the <b>links in the pagination are not related to the ajaxUrl parameter and are taken from the current request</b> .  Which at the first boot is not the same, because  we call another from one action.  In my opinion, such a challenge is not even ideologically correct. <br>  But nowhere to go, we fix it by setting the route parameter in the data provider pagination object: <br>  <b>_grid.php</b> : <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dataProvider = $model-&gt;search(); $dataProvider-&gt;pagination-&gt;route = <span class="hljs-string"><span class="hljs-string">'product/grid'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.grid.CGridView'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'product-grid'</span></span>, <span class="hljs-string"><span class="hljs-string">'dataProvider'</span></span>=&gt;$dataProvider , <span class="hljs-string"><span class="hljs-string">'filter'</span></span>=&gt;$model, <span class="hljs-string"><span class="hljs-string">'ajaxUrl'</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>($dataProvider-&gt;pagination-&gt;route), ...</code> </pre><br>  Now almost everything is as it should.  Grid is loading, sorting and navigation work. <br>  But there was a fly in the ointment: <br>  if the grid is somehow sorted and is not on the first page, and we trigger its update via js: <br><pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">"#product-grid"</span></span>).yiiGridView(<span class="hljs-string"><span class="hljs-string">"update"</span></span>);</code> </pre><br>  then it is reset to the first page with standard sorting.  It's a shame, isn't it?  This is because <b>ajaxUrl</b> is explicitly specified and update always sends a request for it.  But <b>if you do not specify ajaxUrl, then when updating the grid, it saves the current page and sorting</b> !  Because inside the grid, the url for which it was obtained is stored (specifically, in the title attribute diva with keys).  But it is also impossible not to specify ajaxUrl, since  then requests will go to the source url of the grid, i.e.  product / index. <br><br>  The only solution that occurred to me is to change the very title during the first (non-ajax) grid formation.  And do not specify ajaxUrl at all. <br>  The final <b>_grid.php</b> looks like this: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> $dataProvider = $model-&gt;search(); $dataProvider-&gt;pagination-&gt;route = <span class="hljs-string"><span class="hljs-string">'product/grid'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;widget(<span class="hljs-string"><span class="hljs-string">'zii.widgets.grid.CGridView'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span>=&gt;<span class="hljs-string"><span class="hljs-string">'product-grid'</span></span>, <span class="hljs-string"><span class="hljs-string">'dataProvider'</span></span>=&gt;$dataProvider , <span class="hljs-string"><span class="hljs-string">'filter'</span></span>=&gt;$model, <span class="hljs-comment"><span class="hljs-comment">// 'ajaxUrl' =&gt; array($dataProvider-&gt;pagination-&gt;route), ... if(!yii::app()-&gt;request-&gt;isAjaxRequest) { yii::app()-&gt;clientScript-&gt;registerScript('grid-first-load', ' $("#product-grid").children(".keys").attr("title", "'.$this-&gt;createUrl($dataProvider-&gt;pagination-&gt;route).'"); '); }</span></span></code> </pre><br><br>  Now everything works as it should!  Only embarrassed by the presence of the above crutches. <br><br><h4>  Conclusion </h4><br>  I would like to hear your ideas / comments on the methods above and on the use of grids in your yii projects. <br>  Thanks for attention! </div><p>Source: <a href="https://habr.com/ru/post/140109/">https://habr.com/ru/post/140109/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../140102/index.html">We translate the numbers between the binary and decimal systems "on the fly", the explanation is "on the fingers"</a></li>
<li><a href="../140103/index.html">Use Git as a tool for web application deployment.</a></li>
<li><a href="../140104/index.html">March 2012 patches - Remote Desktop vulnerability</a></li>
<li><a href="../140105/index.html">MVP experts respond on the TechNet and MSDN forums.</a></li>
<li><a href="../140108/index.html">Canobuvosti, 135th edition</a></li>
<li><a href="../140110/index.html">The new Xbox will not appear before 2013</a></li>
<li><a href="../140111/index.html">Video review of the Samsung Galaxy Note</a></li>
<li><a href="../140114/index.html">What is wrong with the DateTime structure?</a></li>
<li><a href="../140115/index.html">Cambridge has developed technology to remove toner from paper</a></li>
<li><a href="../140117/index.html">Why does the phone consume charge faster than the manufacturers say</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>