<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>As in Dodo Pizza, we lost 8 million in one hour due to a technical error, and then returned</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The story of the notorious technical error "Dodo Pizza", partner Yandex.Cash, the system architect of the company Andrei Morevsky told us - I immediat...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>As in Dodo Pizza, we lost 8 million in one hour due to a technical error, and then returned</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/b44/470/517/b44470517fe64a35a1cdb424eedd68e5.png"></p><br><p>  <strong>The story of the notorious technical error "Dodo Pizza", partner Yandex.Cash, the system architect of the company Andrei Morevsky told us - I immediately give the microphone to the author.</strong> </p><br><p>  I‚Äôm going to Sapsan to open the first Dodo pizzeria in St. Petersburg, when suddenly I get an alert about the multiple cancellations of paid orders.  And not just multiple ones - our system managed to roll back the allegedly paid orders for 8 million rubles in an hour! </p><br><p>  Now this story is only a smile, but that morning it was not funny at all.  Therefore, I want to share some of the technical details of the incident and the conclusions made, and at the same time tell a little about the Dodo Pizza order processing system. <a name="habracut"></a></p><br><p>  That morning, we immediately contacted the Yandex.Cash team, and learned that such situations usually arise with two or three transactions and are resolved individually.  It seemed to be difficult, because for each such operation, the payment system team has to contact a certain bank and exchange requests.  It was especially insulting to realize that we returned the money we did not receive - these were test orders. </p><br><div class="spoiler">  <b class="spoiler_title">A bit of retrospectives and loss information.</b> <div class="spoiler_text"><p>  Our server canceled payments for 7.84 million rubles.  For a network with an annual turnover of almost 3 billion, this is serious money.  In addition, it is more than 10% of investments attracted for the last round.  Agree, too serious a price for one mistake. </p><br><p>  The same day, the network‚Äôs founder, Fyodor Ovchinnikov, reported on the incident on social networks, and the story quickly spread through news sites. </p></div></div><br><h1 id="i-srazu-spoyler--vse-zakonchilos-horosho">  Immediately spoiler - everything ended well </h1><br><p>  While we were doing everything possible to get the money back, the readers wondered how this happened at all and excitedly chose options for the reprisals against "programmers."  Why, I personally received about a dozen alarming messages from my acquaintances: the guys wondered if I was all good and offered vacancies "just in case." </p><br><p>  Over the weekend, everyone connected to the problem, right down to the top management of Yandex.Cash.  The payment system team was able to agree with partner banks on operations to cancel the erroneous return.  It was a really big job: I had to manually sort through over ten thousand transactions. </p><br><p>  The money was eventually returned to us, although we lost 150 thousand rubles for transfers at bank commissions, another 40 thousand were spent on SMS notifications to customers. </p><br><h1 id="v-poiskah-prichin-i-sledstviy">  In search of causes and effects </h1><br><div class="spoiler">  <b class="spoiler_title">From the first day, Dodo Pizza has been developing its own information system (Dodo IS).</b> <div class="spoiler_text"><p>  Today, this system serves around the clock 183 pizzerias in nine countries.  In five years of development, we have gone from a primitive order-taking block to a full-fledged cloud-based ERP system that manages orders, work in the kitchen, planning schedules, stocks, finances ‚Äî almost all aspects of our business. </p></div></div><br><p>  We test Dodo IS on several environments: there are ‚Äúsandboxes‚Äù for demonstration to product managers, there are integration circuits.  Before laying out the production, the final version is tested by analysts and QA in a <strong>stable</strong> environment.  For verification, we use real data that we regularly copy from the ‚Äúcombat‚Äù base.  <strong>Of course, all data when crossing the border production - **</strong> environment <strong>** depersonalized</strong> . </p><br><p>  On the stable environment, we try to fully reproduce the combat conditions - including the cancellation of payments not attached to orders.  In reality, such payments may occur due to errors in the payment process or due to an incorrectly completed order cancellation procedure by the user.  To check how cancellation will occur in the test environment, a special task is started according to the schedule, which cleans up the tails. </p><br><p>  The day before the incident, two unsuccessful coincidences occurred at once, in the best traditions of Murphy's laws: </p><br><ul><li><p>  due to an error in the configuration, it turned out that the background task does not look at the imitation of the payment service, but at the real connection to Yandex.Kass; </p><br></li><li>  at the same time, the background task looked at the version of the test database in which there were impersonal payment transactions, but there were no corresponding orders. </li></ul><br><p>  Therefore, the cleanup task started in good faith, went through all the transactions and found those that need to be canceled.  And ten thousand requests for cancellation came to Yandex.Money. </p><br><h1 id="pro-vinovnyh-otvetstvennost-i-doverie">  Pro guilty, responsibility and trust </h1><br><p>  Not a single meeting with the company‚Äôs management raised the question of the punishment of the guilty, even after some time. </p><br><blockquote>  ‚ÄúOf course, we will draw the most serious conclusions from this critical error.  We will not punish people - we will simply do everything so that this will not happen again. ‚Äù <br>  <em>Post on Fyodor Ovchinnikov's Facebook and VKontakte page immediately after the incident.</em> </blockquote><p>  Fear of punishment sooner or later paralyzes the work of any company.  I am sure that many of you have met companies where they write a lot of documents and letters in order to be as far as possible from the ‚Äúarea of ‚Äã‚Äãdestruction‚Äù.  Where no manager is ready to take anything that is bold, but even a trifling decision without 20 approvals.  I believe that such companies are not capable of creation and development, they can only ‚Äúfinish‚Äù the resources created by their bolder predecessors and pioneers for years. </p><br><p>  Our right to make a mistake does not mean the right to work carelessly and hack-work, it is above all trust and confidence that no employee can make a mistake out of malicious intent. </p><br><blockquote>  ‚ÄúIf there is a possibility that some kind of trouble can happen, then it will definitely happen.‚Äù <br>  <em>Murphy's Law.</em> </blockquote><p>  Trust does magical things with people - we didn‚Äôt have a single employee who would not take this incident to heart, did not live it as our own pain, would not offer help. </p><br><h1 id="teper-samoe-interesnoe--chto-delat">  Now the fun part is what to do. </h1><br><p>  Providing rapid growth of Dodo IS, we often preferred the speed of development to everything else.  Sometimes this happened at the expense of system logic, architecture and infrastructure. </p><br><p>  As a result, the system turned out to be monolithic and strongly connected.  The code for processing payments and interacting with acquirers was located directly on the client site, along with UI and controllers.  So, any changes in the controllers could directly or indirectly affect the payment logic.  Moreover, the location of the payment logic in the general repository led to the already-you-know-what incident.  Loss of money was only a side effect of work in other parts of the system, in fact not related to the processing of payments. </p><br><p>  For the last six months, we have been reengineering the system and shifting our monolith to the rails of SOA (Service-Oriented Architecture).  Today everyone in the company - from programmers to managers - understands that technical debt must be returned. </p><br><p>  As part of the transfer of the system to SOA, we allocate a separate payment processing service - a payment gateway.  This service encapsulates all payment logic, including interactions with acquirers.  In fact, we develop our own payment aggregator for our own needs.  The payment gateway will become a single point of online payments for the client site (dodopizza.ru) and our other online sales channels. </p><br><p>  We decided to certify a PCI DSS Self-Assessment payment gateway.  The idea may seem controversial (we do not keep PAN card numbers), but the PCI DSS standard is not a bureaucratic formality, but a checklist consisting of correct practices and tips for working with sensitive data and written in ‚Äúblood‚Äù. </p><br><h1 id="platezhnyy-shlyuz-iznutri">  Payment gateway from the inside </h1><br><p>  Each payment gateway should have the architecture described by the UML diagram.  This is the component model of our gateway: </p><br><p><img src="https://habrastorage.org/files/fe7/9b6/0a1/fe79b60a12f544e4bd27bdd85f9f0024.png" alt="image alt text"></p><br><p>  But what is inside IBackService, IPlugin and other interfaces: </p><br><p><img src="https://habrastorage.org/files/d19/0ca/d0a/d190cad0a9a344539474b4f85fda596c.png" alt="image alt text"></p><br><p>  But how many diagrams do not draw, and you still have to explain with words :) What does the gateway consist of, and what role do its components play? </p><br><h2 id="klientskiy-sayt">  Client site </h2><br><p>  There is such a site dodopizza.ru, where most of the orders are issued.  Now the site redirects the user to the payment page, depending on the chosen method - for example, on Yandex.Money - and processes the responses from payment systems.  If necessary, the site backend calls the acquirer's backend.  But in the new architecture, the site will not know anything about the payment page, nor about the acquiring.  He will simply redirect the user to the payment gateway, who will decide himself where to send it further and how to interact with the acquirer. </p><br><h2 id="platezhnyy-shlyuz">  Payment gateway </h2><br><p>  The gateway is a RESTful service that accepts requests for returns and payment orders, for which it provides two APIs: </p><br><ol><li><p>  <strong>The Back API is</strong> intended only for calls from Dodo IS and is available only in the DMZ. </p><br></li><li>  <strong>The Public API is</strong> open to the entire Internet ‚Äî it handles requests for acquirers and redirects users from a client site. </li></ol><br><p>  The source code of the payment gateway is located in a special repository, closed from all developers.  For any changes to the source, the developer needs to make a separate application.  The service itself is deployed on isolated environments with increased security requirements. </p><br><h2 id="plaginy">  Plugins </h2><br><p>  The payment gateway contains the basic logic of payment processing, and the specific logic of integration with specific acquirers is located in plug-ins.  Thus, the work on connecting a new acquirer or changing the list of available ones is done on a point-to-point basis, with minimal risk of hooking on the excess. </p><br><h2 id="servisy-dannyh-i-baza-dannyh">  Data Services and Database </h2><br><p>  The payment gateway stores payment information in its own database, closed to the outside world and to other parts of Dodo IS.  Access to them is impossible even for the gateway itself.  The database has its own API for managing entities, which is open only inside the payment loop. </p><br><p>  In order to more clearly see the role of each component and present where and how data flows, I suggest looking at the data flow diagram: </p><br><p><img src="https://habrastorage.org/files/51f/b92/22f/51fb9222f43d459685584a34853a258d.png" alt="image alt text"></p><br><p>  If, after viewing the chart, you still do not understand how the payment is proceeding in the new architecture, look at the detailed example under the spoiler. </p><br><div class="spoiler">  <b class="spoiler_title">A typical scenario of payment in the new architecture on the example of Yandex.Cash.</b> <div class="spoiler_text"><p>  <em>Payment start script</em> </p><br><table><tbody><tr><td>  N </td><td>  Step </td><td>  Example (Yandex.Cassa) </td></tr><tr><td>  one </td><td>  The client is on the Client site and goes to pay for the order. </td><td>  - </td></tr><tr><td>  2 </td><td>  The client site requests the Payment Gateway for non-cash payment methods available for a particular pizzeria, calling the GetPaymentTypes method. </td><td>  - </td></tr><tr><td>  3 </td><td>  The client site displays the client payment methods.  The client chooses the method of payment. </td><td> The client chooses payment through Yandex.Cash. </td></tr><tr><td>  four </td><td>  The client site sends a payment creation request to the Payment Gateway by calling the CreatePayment method.  The selected payment method, pizzeria identifier, order identifier, amount to be paid, URLs of the payment status notification, successful return and unsuccessful return are transmitted. </td><td>  - </td></tr><tr><td>  five </td><td>  The payment gateway creates a payment in the Draft status. </td><td>  - </td></tr><tr><td>  6 </td><td>  The payment gateway validates the payment and assigns it the status Accepted or Rejected. </td><td>  - </td></tr><tr><td>  7 </td><td>  The payment gateway returns payment to the Client Site. </td><td>  - </td></tr><tr><td>  eight </td><td>  If the payment is rejected (Rejected), the Client site shows the client errors and the script ends. </td><td>  - </td></tr><tr><td>  9 </td><td>  The client site determines the type of embedding of the Payment Gateway.  The type of embedding is indicated for each payment method. <br>  if the embedding type is ‚Äúvia redirect‚Äù, the Client site redirects the client to the PaymentPage Payment Gateway payment page, passing the payment identifier. <br>  if the frame-in type of embedding, the Client's site displays the frame in which the PaymentPage Payment Gateway payment page is displayed to the client, passing the payment identifier. </td><td>  The embedding type for Yandex.Cash is ‚Äúvia redirect‚Äù.  Therefore, the Client site redirects the client to the PaymentPage PaymentPage payment page, passing the payment ID. </td></tr><tr><td>  ten </td><td>  The payment gateway assigns the status Started to the payment if the payment is in the Accepted status.  Otherwise, proceed to the scenario of unsuccessful completion of payment. </td><td>  - </td></tr><tr><td>  eleven </td><td>  The payment gateway displays a payment page with a wait animation. </td><td>  - </td></tr><tr><td>  12 </td><td>  The payment gateway validates payment by ID.  If validation is not passed, proceed to the scenario of unsuccessful completion of payment. </td><td>  - </td></tr><tr><td>  13 </td><td>  The payment gateway determines the plug-in by the payment method that will conduct the payment through the acquirer.  If the plugin is not found, go to the scenario of unsuccessful completion of payment. </td><td>  A plugin for Yandex.Money is selected. </td></tr><tr><td>  14 </td><td>  The payment gateway calls the plugin's StartPayment method, transferring the payment. </td><td>  - </td></tr><tr><td>  15 </td><td>  The plugin performs its specific actions, calls the acquirer system and returns the result to the gateway. </td><td>  The plugin returns to the Payment Gateway the result of the "redirect" and the URL of the payment page in Yandex.Kassa. </td></tr><tr><td>  sixteen </td><td>  The payment gateway processes the result of the plugin: <br>  if the result is an ‚Äúerror‚Äù, the Payment Gateway proceeds to the scenario of unsuccessful completion of payment. <br>  if the result is ‚Äúpayment made‚Äù, the Payment Gateway returns the response received from the plug-in and proceeds to the scenario of successful completion of payment. <br>  if the result is ‚Äúwaiting‚Äù, the Payment Gateway returns the response received from the plugin. <br>  if the result is a ‚Äúredirect‚Äù, the Payment Gateway redirects to the URL obtained from the plugin and proceeds to the scenario of waiting for payment. </td><td>  The payment gateway redirects the client to the URL of the payment page in the Yandex.Money service and proceeds to the scenario of waiting for payment. </td></tr></tbody></table><br><p>  <em>Payment Waiting Scenario</em> </p><br><table><tbody><tr><td>  N </td><td>  Step </td><td>  Example (Yandex.Cassa) </td></tr><tr><td>  one </td><td>  The payment gateway listens for acquirer requests through universal endpoint acquiring.  The same endpoint handles client redirects initiated by the acquirer. </td><td>  Yandex.Cassa sends HTTPS POST to pay.dodopizza.com/acquiring/yamoney/checkOrder <br>  or <br>  Yandex.Cassa sends HTTPS POST to pay.dodopizza.com/acquiring/yamoney/checkAviso <br>  or <br>  Yandex.Kassa redirects the client to the address pay.dodopizza.com/acquiring/yamoney/success <br></td></tr><tr><td>  2 </td><td>  Upon receiving the request, the Payment Gateway extracts the plug-in name from the request parameters and creates the appropriate plug-in. </td><td>  Payment gateway named yamoney finds a plugin for Yandex.Cash </td></tr><tr><td>  3 </td><td>  The payment gateway authorizes the request by calling the plugin AuthorizeAcquiringRequest method </td><td>  Plugin verifies the authenticity of the request. </td></tr><tr><td>  four </td><td>  The payment gateway sends a plug-in request by calling the ProcessAcquiringRequest method.  The plugin performs its specific actions and returns the result to the gateway. </td><td>  According to the request parameters, the plugin selects the appropriate handler. <br>  CheckOrder: <br>  The plugin returns the result of the ‚Äúwait‚Äù and response for sending to Yandex.Kassa to the gateway. <br>  CheckAviso: <br>  The plugin returns to the gateway the result ‚Äúpayment made‚Äù and the response to send Yandex.Kassa <br>  success: <br>  The plugin returns the result of the "redirect" and the URL of a successful return to the gateway. </td></tr><tr><td>  five </td><td>  The payment gateway processes the result of the plugin: <br>  if the result is "error", the Payment Gateway proceeds to the scenario of unsuccessful completion of payment. <br>  if the result is ‚Äúpayment made‚Äù, the Payment Gateway returns the response received from the plug-in and proceeds to the successful payment completion scenario. <br>  if the result is ‚Äúwaiting‚Äù, the Payment Gateway returns the response received from the plugin. <br>  if the result is "redirect", the Payment Gateway redirects to the URL obtained from the plugin and proceeds to the scenario of waiting for payment. </td><td>  - </td></tr></tbody></table></div></div><br><p>  At this point, I was asked to stop copying the internal documentation in Habr, so I‚Äôll get round.  I would be glad if the article pushes you to some thoughts about your own architecture or tells you new solutions.  And it will be quite cool if you find something unnoticed by us and tell us what we are doing wrong.  But do not be too harsh - perhaps many of the nuances are not forgotten, but simply remained outside the scope of the article, then I will explain them in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/325762/">https://habr.com/ru/post/325762/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../325748/index.html">Games and the cloud. Myths and reality. We expect a heated discussion on April 12. Come virtually</a></li>
<li><a href="../325752/index.html">A bug in Telegram VoIP, which allows you to find out the address of the interlocutor</a></li>
<li><a href="../325756/index.html">Evolution on React + Redux</a></li>
<li><a href="../325758/index.html">Petri net with symfony a la WorkFlow component</a></li>
<li><a href="../325760/index.html">CSS Grid Layout. Fast start</a></li>
<li><a href="../325764/index.html">Meta development tool: FutoIn CID</a></li>
<li><a href="../325770/index.html">Parametric modeling in CAD SolveSpace: Degrees of freedom and constraint equations</a></li>
<li><a href="../325772/index.html">Interfaces of the aggregator of tours: what we have done and where we need the help of Habr</a></li>
<li><a href="../325776/index.html">‚ÄúShaw, again?‚Äù Or hacking transport Citycard (Nizhny Novgorod)</a></li>
<li><a href="../325778/index.html">Life programmers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>