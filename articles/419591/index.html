<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How to make email-mailing and do not mow: practical advice</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="A developer who first encountered generating emails has little chance of writing an application that will do this correctly. About 40% of letters gene...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How to make email-mailing and do not mow: practical advice</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/webt/le/ph/rs/lephrsp-4zc6zhbbo-fgmhcceec.jpeg" height="500"></div><br>  A developer who first encountered generating emails has little chance of writing an application that will do this correctly.  About 40% of letters generated by corporate applications have some kind of violation of standards, and, as a result, problems with delivery and display.  There are reasons for this: e-mail is technically much more complicated than the web, mail is governed by several hundred standards and an uncountable number of generally accepted (and not so) practices, and mail clients are diverse and unpredictable.  Testing can significantly improve the situation, but there is almost no material on testing mail. <br><br>  Mail Mail.Ru regularly interacts with its users through e-mails.  In our project, all components that are responsible for generating letters, and even single mailings are subject to mandatory testing.  In this article we will share our experience (and stuffed cones). <br><br><ul><li>  <a href="https://habr.com/company/mailru/blog/419591/">What are the emails</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Who is involved in the testing and control process</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Mailing and postal transport</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">The interface of the postal infrastructure and the boundaries of the application under test</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Determination of test parameters</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Typical Generating Application Structure</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">What and when to test</a> <br><ol><li>  <a href="https://habr.com/company/mailru/blog/419591/">Delivery infrastructure</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Generating Application</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Structural and Layout Letter Templates</a> </li></ol></li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Basic requirements for checking infrastructure</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Authorization Requirements</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Verification of the generating application</a> <br><ul><li>  <a href="https://habr.com/company/mailru/blog/419591/">Requirements for postal addresses</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Mail Header Requirements</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Requirements for the structure of the letter</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">URI requirements</a> </li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Letter layout requirements</a> </li></ul></li><li>  <a href="https://habr.com/company/mailru/blog/419591/">Split tests</a> </li></ul><br><a name="habracut"></a><br><a name="1"></a><h2>  What are the emails </h2><br>  The application can generate various types of letters.  They can be classified into several categories.  By the method of selecting recipients: trigger - selective - group.  By appointment: transactional - marketing - official.  You can set different requirements for different types of letters and apply different testing scenarios. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Trigger letters are generated in response to any events, such as user actions or status changes of any system objects.  They are generated by the application, and therefore the most interesting in terms of testing.  Trigger letters can be both transactional and marketing. <br><br>  Selective letters are sent to a dynamic selection of users that meet some criteria. <br><br>  Group emails are sent to a known group of recipients, for example, all users or partners.  Selective and group letters are most often marketing, sending such letters is initiated manually or on a schedule. <br><br>  Transaction letters are generated in the process of the user committing an action.  Such letters include, for example, invoices, tickets or delivery status notifications, letters with an access recovery code, etc.  Transactional emails are always trigger.  Maximum compatibility is important for them, which means that they should be as simple as possible, and they need to be tested on a large number of clients. <br><br>  Marketing letters encourage the user to take any action, for example, it may be an offer of individual discounts based on previous purchases.  In these letters, transactional data can be used; they can be either trigger or mass - periodic or one-time.  For these letters, efficiency is more important, usually it is determined by the results of the split test.  Some aspects of compatibility can be sacrificed for efficiency. <br><br>  Group marketing letters, for example, messages about seasonal offers, promotions and sales, are often sent ‚Äúmanually‚Äù and are not part of your application, but you can also (and should) apply the general principles of testing. <br><br>  In addition, there may be service letters generated for employees for automated or automated CRM systems, journaling, auditing, or DWH.  Such letters are triggered, which means that they are also part of the application and must be tested. <br><br><a name="2"></a><h2>  Who is involved in the testing and control process </h2><br><ol><li>  QA Engineer - participates at all stages of the process. </li><li>  Network Engineer - Responsible for configuring network infrastructure and message delivery infrastructure.  Network engineer should be involved in planning infrastructure testing. </li><li>  A deliverability specialist is a person who monitors the deliverability of letters, who also participates in monitoring the technical and administrative parameters of all sent messages and monitors the progress of the mailing process.  He is responsible for ensuring that the letters sent reach the maximum possible percentage of users and do not end up in spam, and for this, the specialist must have certain knowledge and contacts.  If problems arise with the delivery of letters, it is he who must understand the probable cause and eliminate it: either by removing technical obstacles;  or changing something in the content of the letters;  or having solved the problem together with the support service of the mail provider, to which the letters do not reach.  Such a specialist (if any) should also be involved in drawing up the checklist and testing the infrastructure generating applications and letters.  However, the testing process itself must be controlled by the QA service. </li><li>  Email-marketer - determines the effectiveness of marketing newsletters.  Under his control, the split-testing for the audience‚Äôs marketing newsletters is held.  The email marketer also controls the segmentation of the user base, the composition and frequency of emails sent, and the visual ‚Äúpresentation‚Äù of the email to the user. </li></ol><br>  All these roles are not necessarily performed by a dedicated employee: the role of the marketer can be performed by one of the product managers, and the role of the deliverability specialist, for example, a support employee or a network engineer.  And in startups, with a high degree of probability, all this will have to be dealt with by one person, and they may be a quality specialist. <br><br><a name="3"></a><h2>  Mailing and postal transport </h2><br>  The structure of the mail is similar to a huge iceberg, and there are two levels in it.  There are more than a hundred different standards governing mail, but almost all of them belong to one of these two levels: <br><br>  <b>The underwater part of an iceberg</b> is a network service, the basic protocol of which is the SMTP application protocol defined by RFC 5321. It is responsible for the delivery of letters.  For the delivery of the letter, a so-called SMTP envelope is formed, which includes the addresses of the sender and recipient of the SMTP level.  Also for the delivery of the letter are responsible other network services, such as DNS.  The main component of the network infrastructure is the Message Transfer Agent (Mail Transfer Agent, or more commonly used abbreviation MTA).  The MTA is responsible for handling the message delivery queue and the delivery process itself to the recipient servers.  MTA examples are Postfix, Sendmail, exim, Microsoft SMTP service. <br><br>  This underwater part of the iceberg, which includes the MTA, DNS parameters and other network parameters, we will call the mail infrastructure, or message delivery infrastructure. <br><br>  <b>The tip of the iceberg</b> is the letter itself.  The basic structure of a letter is defined by the standard RFC 5322. A letter consists of service headers and one or more data parts.  The data may contain plain text text and / or HTML, inline images or attachments of almost any type. <br><br><a name="4"></a><h2>  The interface of the postal infrastructure and the boundaries of the application under test </h2><br>  The mail infrastructure, as a rule, has one or several interfaces through which an email is sent (enters the MTA delivery queue).  For example, the SMTP Submission service, the <code>mail()</code> function in PHP, data transfer to an external mail or sendmail application, the API of internal or external services (for example, GetResponse, SendPulse, or Amazon SES).  We will consider these interfaces as part of the infrastructure.  It often happens that application A prepares data for a letter and a list of recipients, and then sends it to application B through its API (for marketing mass mailings, this can be done manually via the user interface - UI), and application B generates a mail message in RFC 5322 and in some way puts it in the MTA delivery queue.  From the point of view of application A (and when testing it), application B will be part of the mail infrastructure.  The API or UI of Application B will be for the Application A interface of the mail infrastructure.  Although from the point of view of application B, the situation will be different, and the mail infrastructure for it will be lower-level network applications or protocols. <br><br><a name="5"></a><h2>  Determination of test parameters </h2><br>  When testing each application, it is important to select all the mail infrastructures used by it (there may be several of them), and for each infrastructure to identify the interfaces used (there may also be several of them for each infrastructure).  For each interface, the composition and format of the data transmitted to it is determined as accurately as possible, for example: letter text in TEXT / HTML, letter text in TEXT / PLAIN, letter subject, recipient name, recipient address, sender name, sender address (RFC5321.From ), the sender address of the SMTP convector (RFC5322.mailfrom).  Next, a set of requirements is developed for each parameter (representations, encodings, boundary values, etc.), methods for monitoring each of the parameters are determined (how you can compare the actual result with the expected one). <br><br><a name="6"></a><h2>  Typical Generating Application Structure </h2><br>  For the generation of letters and data in it, as a rule, the same product that we are testing is responsible.  This is usually a server (but sometimes client) application.  It defines the structure of the letter, part of the service headers, data encapsulation formats, string representations and text encoding.  A simple example of such an application is the script that forms the letter and calls the <code>mail()</code> function. <br><br>  The main elements of the application that must be controlled: <br><br><ul><li>  the code responsible for generating headers and / or letter structure, if the letter structure is dynamically generated, and / or a static letter pattern describing its structure; </li><li>  HTML layout of the letter (ideally, it is a separate entity or part of the letter template / layout, but can be embedded in the application code); </li><li>  substitution of application data into a letter (or letter pattern); </li><li>  integration of the application with the letter delivery infrastructure, the correctness of the parameters passed to the infrastructure interface. </li></ul><br><a name="7"></a><h2>  What and when to test </h2><br>  Whether we like it or not, the iceberg should be tested all.  There are several main components that require testing: <br><br><a name="8"></a><h4>  1. Delivery infrastructure </h4><br>  Emphasis in testing should be done on: letter deliverability;  correct DNS records, including PTR / FCrDNS, MX and A records;  SMTP protocol parameters (HELO, use TLS);  letter authorization (SPF / DKIM / DMARC);  SMTP envelope addresses (if they are not managed by the application);  correctness of processing the input parameters of the infrastructure interface;  tracking, recording and processing of undelivered emails. <br><br>  It is necessary to test the infrastructure during the initial implementation and every time changes are made to the infrastructure itself (the configuration of the MTA, DNS or network changes) or the interface for sending a letter;  using a new domain, network, or API;  characteristics of sent letters, such as their language, size or number, change significantly.  According to experience, the infrastructure tends to change without declaring war, so basic tests should be carried out periodically, even if there is no information about any changes. <br><br>  It is possible and necessary to involve the network engineer and the deliverability-specialist in drawing up the plan and checklists for testing the infrastructure. <br><br><a name="9"></a><h4>  2. Generating application </h4><br>  The addresses of the SMTP envelope should be monitored (if they are controlled by the application, that is, they are transmitted to the interface ‚Äî envelope-from, envelope-to), the values ‚Äã‚Äãof the service headers of the letter (Date, Message-ID, List-Unsubscribe, Auto-Submitted, etc.). p.), letter authorization (DKIM / DMARC), MIME-coding (base64, quoted-printable), general correctness of the letter format, for example, the absence of non-ASCII characters in the headers, the composition of the data to be substituted, the correct triggering of triggers, unsubscribe mechanisms, tracking mechanisms writing and collecting statistics (postmaster headers, for example, Feedback-ID or X-Mailru-Msgtype, as well as tracking pixels)  . <br><br>  It is necessary to test an application during its development, when all its related components that are responsible for generating and storing data change, with significant changes in letter templates, when changing the used infrastructure or interface to it, as well as within the framework of general regressions. <br><br><a name="10"></a><h4>  3. Structural and bump letter templates (can be part of a generating application or are developed separately) </h4><br>  The structure of the letter is checked (Content-Type, Content-Disposition, nesting of Multipart-parts of the letter, text encoding, string parameters), the value of the target and displayed headers (From, To, Reply-to, Subject), the letter is displayed in the list of letters and when reading in various interfaces, microformats (for example, that a calendar event is recognized as a calendar event, or an air ticket as an air ticket), branding. <br><br>  Letter templates should be tested every time you make at least the slightest changes, as well as separately, for example, in a situation where letters get into the application before the server part is ready. <br><br>  It is recommended that an email marketing specialist and a deliverability specialist be invited to compile a checklist for testing a letter template. <br><br><a name="11"></a><h2>  Basic requirements for checking infrastructure </h2><br>  The IP address selected for the mail server should be as close as possible to the IP address of the mail server.  It is recommended to check it using the whois utility.  In particular, the sender's address should not belong to the network, which can be perceived as dynamic;  the selected network must have active contacts to which complaints can be sent;  the network must be used (have the status ASSIGNED in RIPE).  The IP address must have a correctly configured PTR record.  It can be configured independently through the hosting control panel, or with the help of the service provider.  A PTR record must point to the real host name and still be meaningful, resolved back to the same IP address (so-called FCrDNS check), not remind the name of the dynamic host, and not include a large group of numbers or characters.  A good example is mailserver.example.com. <br><br>  Each domain used in envelope addresses or letter headers must have a valid MX record pointing to a host A record, which, at a minimum, can handle undeliverable messages.  MX is not allowed to directly refer to the IP address. <br><br>  Control the passage of SPF, DKIM, DMARC.  SPF allows the domain owner to specify in the TXT records a list of servers that have the right to send email messages with return addresses in this domain.  It is configured for the address used in the envelope-from (SMTP-envelope), in the section of managing DNS zones of the domain.  DKIM provides verification of the authorship of a message or of the originator‚Äôs address to a specific domain using digital signature technologies that are added to the letter itself (in its DKIM-Signature header).  Typically, the DKIM signature is configured at the MTA (infrastructure) level.  DMARC sets the policy of checking incoming mail in a specific domain and actions on letters that do not pass SPF or DKIM authentication.  When attempting to violate this policy, a structured report comes along with information about the attempt.  DMARC, as well as SPF, is published as a TXT record in the domain zone. <br><br>  Check the deliverability of letters to the main postal services - for Russia Mail.Ru, Yandex, GMail, Microsoft (Hotmail / Outlook.com / Office365), Rambler, nic.ru.  In the incoming letters you need to check the correctness of HELO;  the presence and passage of checks PTR / FCrDNS, SPF, DKIM and DMARC;  the validity of the headers and data in them, in particular, the synchronism of the clock in the dates and the correctness of the time zones. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2dc/8b4/9bc/2dc8b49bc147ae9369cbc232bd4dfdb3.png"><br><br>  The formation of some parameters, for example, authorization, deliverability, and spam, are integrally influenced by all components, but for their control there are usually separate operational tools - DMARC and FBL reports, API postmaster services, letter tracking tools, delivery statistics.  Testing should take into account the level of implementation of operational monitoring tools in the company - for example, in the absence of operational control of DMARC reports, the authorization of letters should be regularly tested, in the absence of operational control of deliverability - regularly check how and where the letters get, even if there is no development related to sending letters is not conducted. <br><br>  To test the infrastructure, you can use specialized services, for example, <a href="https://www.mail-tester.com/">mail-tester.com</a> , <a href="https://mxtoolbox.com/">mxtoolbox.com</a> .  Detailed infrastructure requirements can be found <a href="https://habr.com/company/mailru/blog/239963/">in this article</a> . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/3ee/d3f/4d3/3eed3f4d3e9ad8df1edb1a90d115e318.png"><br><br><a name="12"></a><h2>  Authorization Requirements </h2><br>  Check the passage of SPF, DKIM, DMARC can usually be on the Authentication-Results header on the recipient server. <br><br>  Check the validity of the SPF record for syntax, limit for DNS queries (for example, using mxtoolbox.com).  When forming SPF, all sources of mailings should be taken into account (do not forget CRM systems, all delivery infrastructures used, including those through which one-time marketing campaigns are conducted).  It is recommended to specify allowed servers for the domain through the list of networks ('ip4' / 'ip6').  SPF is checked for the sender address from the SMTP envelope.  Verify that the SMTP envelope domain (envelope-from) matches the domain from the From header.  Typical SPF errors are listed <a href="https://habr.com/company/mailru/blog/338700/">in this article</a> . <br><br>  Check the DKIM DNS record, the validity and composition of the DKIM signature (DKIM-Signature).  Verify that the DKIM key is at least 1024 bits in size.  The recommended DKIM signature hash mode is relaxed / relaxed.  Make sure that all important headers are signed (From, To, Subject, Date, Message-ID, MIME-Version, Content-Type), the tracking headers are not signed (Received, Delivered-To, Return-Path), and DKIM is validated on main postal services.  Set up on one of the postal services forwarding to another, DKIM should not "beat" on the forwarded letters.  Ensure that the DKIM signature domain matches the sender's domain from the From header. <br><br>  Check out the progress of the DMARC on the main postal services.  Check for DMARC reports, identify and fix problems with SPF and DKIM for all IP addresses of your infrastructure. <br><br>  Verify that letters are delivered to external servers using encryption (TLS).  It is sometimes possible to check the presence of TLS by the Received header on the recipient's server: for example, specifying the ESMTPS protocol or the presence of type parameters <i>(version = TLS1_2 cipher = ECDHE-RSA-AES128-GCM-SHA256 bits = 128/128);</i>  indicates the presence of TLS. <br><br><a name="13"></a><h2>  Verification of the generating application </h2><br><a name="14"></a><h4>  Requirements for postal addresses </h4><br>  <b>Envelope addresses</b> <br>  We will begin verification of the generating application from the addresses in the SMTP envelope. <br><br>  Envelope addresses are addresses of the level of postal infrastructure.  They are not visible to the user, but are important for delivery, because the mail box in which box is determined by the address of the envelope. <br><br>  The recipient's address in the envelope (envelope-to, aka RCPT TO :) is the address to which the letter will actually be delivered. <br><br><ul><li>  for all letters, except for registration, the address must be legally signed and validated for distribution in accordance with administrative requirements. </li><li>  for mailings, the address must be ‚Äúlive‚Äù, addresses to which it is regularly impossible to deliver letters should be marked as inactive, mailings should not be made to them.  But some categories of letters (for example, restoration of access) may need to be sent to addresses previously marked as inactive. </li></ul><br>  The sender's address in the SMTP envelope (usually called envelope-from, smtp.mailfrom or Return-Path) - messages on the inability to deliver the letter and auto-replies will be delivered to this address.  User this address is invisible.  This address is also used to authorize SPF.  Check that: <br><br><ul><li>  the address is available; </li><li>  It is not an employee‚Äôs address and is not redirected to it in order to exclude auto replies, inaccessibility messages, etc .; </li><li>  processed by a script that will mark the addresses of inaccessible users as inactive; </li><li>  the address can be automatically generated, i.e.  unique to each letter; </li><li>  a letter to this address should not lead to the generation of any response letter, for example, a message that the box is full. </li></ul><br>  <b>Email address addresses</b> <br><br>  These addresses are either directly visible to the user or used when replying to an email. <br><br>  The sender's address (From :) header is the address and the name of the sender displayed in the list of letters and when reading a letter.  Check that: <br><br><ul><li>  This is a ‚Äúhuman readable‚Äù friendly address that identifies the company. </li><li>  Contains not only the e-mail, but also the name of the sender. </li><li>  noreply @ is possible, but only if we want to emphasize that we do not expect to receive an answer to the letter and it will not be read.  It is better to duplicate this idea in the text of the letter. </li><li>  If there are non-ASCII characters (for example, Cyrillic), the sender's name must be encoded according to MIME, the domain if there are non-ASCII characters must be encoded in Punycode. </li><li>  Letters of the same category should have the same address; the use of auto-generated addresses is not allowed.  This is due to the fact that From: is most often used by people to sort letters into folders using filters. </li><li>  The address should be different (better in different subdomains) for transactional, marketing and urgent letters (such as letters from the support service).  This is also due to the fact that the user can mark marketing letters as spam or filter them into an unreadable folder. </li><li>  The From address and the SMTP envelope address must be in the same domain or in subdomains of the same organizational domain for passing SPF within DMARC. </li><li>  The address must be from the organization's domain.  It is unacceptable to use the domains of free mail services and other public mails in From, since such mailings will not pass SPF and DKIM authentication within DMARC. </li></ul><br>  Address Reply-To - the ‚Äúmanual‚Äù answers will be sent to this address when the user responds to the letter.  It is not obligatory: in its absence, the address from From is used for the response.  Check that Reply-To: <br><br><ul><li>  It can be autogenerated, i.e.  unique to the letter (allows you to know which letter came to answer). </li><li>  It should not fall into the employee's box to avoid auto-responses, and ideally should be ‚Äúwrapped‚Äù in CRM. </li><li>  It can generate a standard CRM auto-reply, but should not generate anything superfluous, for example, messages about a box overflow.  When generating auto-responses, measures should be taken to avoid looping; they are listed in RFC 3834. </li><li>  It may be from any domain that does not necessarily coincide with From, but sometimes it scares users when they answer. </li><li>  May be absent, then its function is performed by the From address. </li><li>  In addition to the address indicated the name of the sender. </li></ul><br>  To address: <br><br><ul><li>  Must contain the recipient's e-mail (otherwise it scares the recipient of the letter and the antispam alarming). </li><li>  Ideally, it should contain the name of the recipient.  But if the name is unknown or doubtful (for example, the address is not confirmed yet), it is better not to indicate it (someone may enter someone else‚Äôs address with a bad name, and the recipient might be offended by you). </li></ul><br><a name="15"></a><h4>  Mail Header Requirements </h4><br>  The actual encoding of the text must match the one specified in the title.  It is advisable to use the same encoding in all headers and parts of the letter.  It is recommended to use UTF-8 as widely supported.  The encoding is specified in the Content-Type headers and in the &lt;MTA&gt; tag of the HTML part. <br><br>  The headers From :, Message-ID: and Date: must be formed directly in the script to send the letter (and by standards - along with the text of the letter) and always in the correct format.  In the case of their absence or incorrect formation, one of the transit servers can add these headers, which leads to a violation of the integrity of the DKIM signature. <br><br>  8-bit characters in the headers, including the subject line (Subject) and the names of the attached files (Content-Type and Content-Disposition), should be absent;  all non-ASCII characters, including Cyrillic, must be encoded in quoted-printable or base64. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/910/ab6/456/910ab6456ccd1ed4ef29f1725dab4bdd.png"><br><br><a name="16"></a><h4>  Requirements for the structure of the letter </h4><br>  For the HTML part of the letter, it is desirable to form an alternative - text (plain) part.  It is also necessary to check the conformity and readability of the plain text-part of the letter (if available) and the general structure of the letter. <br><br>  According to RFC 5322, the length of a string in a letter should not exceed 998 8-bit characters.  Note that in UTF-8, a character may take several octets.  The string terminator in the e-mail is the CRLF pair (&lt;cr&gt; ascii 13, lf&gt; ascii 10), which occupies 2 octets.  It is necessary to check the correctness of the string terminator, since letters are often sent using a Unix script, and on Unix, a single character lf is used as a string terminator - for email, this is an error.  You should also check whether the terminators break strings of characters in the UTF-8 encoding: you should not allow the presence of a terminator of strings between two octets of one character, for example, Cyrillic.          ,     base64. <br><br>        ‚Äî      ¬´Content-Disposition: inline¬ª,   ,   ,  ¬´Content-Disposition: attachment¬ª,     . <br>  ,  ,    :  ,      multipart-   (mixed, alternative, related),  multipart/mixed       , multipart/related ‚Äî    , multipart/alternative ‚Äî   plain text-  HTML-.     ,       -,    : <br><br> multipart/alternative <br> ‚Äî text/plain <br> ‚Äî text/html <br><br>   , text/plain    text/html  multipart/related.    ,     HTML-,       -   ‚Äî  plain-. <br><br>     -      : <br><br> multipart/alternative <br> ‚Äî text/plain <br> ‚Äî multipart/related <br> ‚Äî‚Äî text/html <br> ‚Äî‚Äî image/‚Ä¶ (-) <br> ‚Äî‚Äî image/‚Ä¶ (-) <br><br> -   Content-Disposition: inline     multipart/related-. <br><br>    ,     ,   ,    : <br><br> multipart/mixed <br> ‚Äî multipart/alternative <br> ‚Äî‚Äî text/plain <br> ‚Äî‚Äî multipart/related <br> ‚Äî‚Äî‚Äî text/html <br> ‚Äî‚Äî‚Äî image/png <br> ‚Äî‚Äî‚Äî image/png <br>  ... <br> ‚Äî application/octet-string (content-disposition: attachment) <br> ‚Äî application/octet-string (content-disposition: attachment) <br>  ... <br><br> (multipart/related-  multipart/alternative-     ,     multipart/mixed-) <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b63/896/ef4/b63896ef4964a08327693deae2192641.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/7ab/123/d6d/7ab123d6d0398601b7c62bd1ae57d59a.png"><br><br><a name="17"></a><h4>   URI </h4><br>  URI (  src, href,   ..)       ( <a href="https://example.com/somepath">https://example.com/somepath</a> ).       (/somepath)    (//example.com/somepath),    , ..        file://. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c55/852/64f/c5585264ffa6e6f15246000cd26f9d00.png"><br><br><ul><li>    ASCII- ( , )  URI       percent encoding. </li><li> ,    (..    URL,     ),        &lt;&gt;,         .  -    ,      .  href  A        ,  -          .         ¬´¬ª,     . </li><li>     htt://, htts://  milto:. </li><li>           http://   htts://. </li><li>      (, <a href="http://example.com/">example.com</a> :8080/somepath), ..     . </li><li>     HTML-     -    (, ,    ..)      , ..   -      ,    ;           ,        ,     ,     ( -         GET-,       POST  PUT). </li><li>      List-Unsubscribe, ,      -  , ..          . </li><li>     ,            ,    ,     (,   ).           .  ,    ,   ,    ,   ,     . </li><li>  Since  URI   ,       URI  data:.            URI. </li><li>     ,      . ,        ,          . </li><li>       -     . </li></ul><br><a name="18"></a><h4>     </h4><br>     ? <br><br><blockquote>            .         ‚Äî   (XSS, Crossite scripting),   (interface spoofing), DOM clobbering,   /   (, IP-      )  ..,                 .  ,       .     : <br><br><ul><li>   , </li><li>   / , </li><li>    , </li><li>        (    ), </li><li>       (..      )       , </li><li>  HTML-     ( Microsoft Exchange / Outlook  RTF, -       Outlook      ), </li><li>          . </li></ul><br>      ,   -  URI cid://,     . , Mozilla Thunderbird   cid://   . </blockquote><br>      -     -       . <br><br>          . ,          URI, -    , -   ,       .        :          ,     (  ,               ). <br><br>      : <br><br><ul><li>      , ,  , ,    . </li><li>          . </li><li>   , , ,          .      (      ).      .     ,        . </li><li>       ,   . </li><li>  ,    ,  ..   -,    - ,  c,   , <a href="https://habr.com/company/mailru/blog/354310/">      </a> ( ,   , ,  ,  -       ). ,             ,    . </li><li>       . </li><li>    , ,  , .        (, -  ),   , ,  ,     . </li><li>               . </li><li>   : <br><ul><li>    :  ¬´ ¬ª Mail.Ru, Yandex, Gmail,   Rambler  Outlook.com; </li><li>      ; </li><li>   ,    IMAP,     ,    iPhone, Pixel (  Android), Samsung (   Android), MIUI (    Android-); </li><li>   : Chrome, Firefox, Edge, Internet Explorer, Opera  .; </li><li>   ( ),  Thunderbird, Outlook  Apple Mail,  The Bat!  Opera Mail; </li><li>     - (Exchange,  Roundcube, Communigate, Zimbra, SquirrelMail) ‚Äî  B2B-; </li><li>       Retina-,        . </li></ul></li><li>          : <br><ul><li>   , SPF/DKIM/DMARC. </li><li>   :    ,  . </li><li>     : ,    ,     ,      (,       ¬´¬ª). </li><li>    :    ,       ..,         . </li><li>        . </li><li>     . </li><li>  . </li><li>   ,  . ,        ,    - ,       ,             . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfd/d33/a08/dfdd33a0855e3f55c1ac96534b66a716.png"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/e6a/964/e13/e6a964e1366a217ecd60bdb41f584e2f.png"></li></ul></li><li>      (  )  ,      .        ,      . </li><li>  ,     ,   , ..       ,  , , ¬´¬ª   . </li><li>       . ,    DKIM-   -    (  DNS   DKIM-,   ), -    (   ,    ,      From, Date  Message-ID)  -   (  ,   ,   ).   ¬´¬ª    ,        . </li></ul><br><a name="19"></a><h2>  - </h2><br>       ,      ,     . <br><br>   ,     ,    (   ).       .       ,     ,        . <br><br>      CTR   ‚Äî         .  postmaster.mail.ru      .        (),     . CTR &lt; 10% ‚Äî    ,    .    CTR &gt; 30%.        CTR          (¬´¬ª)   .      (   ).          ,   ‚Äî   .  ,       ,  : <a href="https://help.mail.ru/developers/mailing_rules/technical">https://help.mail.ru/developers/mailing_rules/technical</a> . <br><br>   -       .           CTR        .          (      ).             ¬´¬ª ‚Äî    10 000 ,       . <br><br>  :      , ,      .       ¬´ ¬ª    . ,         . <br><br> <i>          <a href="https://habr.com/users/z3apa3a/" class="user_link">z3apa3a</a>    <a href="https://habr.com/users/s4ever/" class="user_link">s4ever</a> .        <a href="https://habr.com/users/edt/" class="user_link">EdT</a>    <a href="https://habr.com/users/4alexander/" class="user_link">4Alexander</a> .</i> </div><p>Source: <a href="https://habr.com/ru/post/419591/">https://habr.com/ru/post/419591/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../419581/index.html">What non-commercial projects are interesting Y Combinator</a></li>
<li><a href="../419583/index.html">1998‚Äì2008: ten years that Russia has been stepping out of step with the West all the time, until broadband Internet equates everyone</a></li>
<li><a href="../419585/index.html">PWA is easy. Hello Habr</a></li>
<li><a href="../419587/index.html">Contests that change the world. 1567 - 2035</a></li>
<li><a href="../419589/index.html">Use AMP as a general purpose library for creating fast dynamic sites.</a></li>
<li><a href="../419593/index.html">Glasses for color blindness: how it works and what the difficulties of selecting</a></li>
<li><a href="../419597/index.html">Parallels RAS versus Alternative Technologies</a></li>
<li><a href="../419599/index.html">Java REST at the HeadHunter School of Programmers</a></li>
<li><a href="../419601/index.html">An example of designing a digital device "on the fingers"</a></li>
<li><a href="../419603/index.html">Background: companies that produce robomobils</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>