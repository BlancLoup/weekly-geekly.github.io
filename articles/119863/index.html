<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Push + ActiveMQ - ZendFramework = ... or the story of a single drive project</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="One fine morning a young guy ran into our office, with an ambitious idea and ‚Äúmeans for realization‚Äù in his pocket. ‚ÄúYou go to the site, and there - t...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Push + ActiveMQ - ZendFramework = ... or the story of a single drive project</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage/habraeffect/28/77/28776574f362dee303fa7804ea41bd49.png" align="left"><br>  One fine morning a young guy ran into our office, with an ambitious idea and ‚Äúmeans for realization‚Äù in his pocket.  ‚ÄúYou go to the site, and there - the TV.  You can connect to it through your webcam.  Only one person can broadcast at a time, the rest are waiting for their turn (but you can see screenshots from their webcams).  The task of each - to keep on the air, as long as possible.  If the speaker likes the public - everyone shakes ‚ÄúCool!‚Äù, If you disappoint - ‚ÄúGo away!‚Äù.  And the person is replaced by the next in line.  Well, you can write in the chat ". <br><br>  A good idea is a drive project.  We draw a prototype, we decide to implement the update of the chat, user list, rating, etc.  using push technology.  This is when, after loading the page, the connection between the client and the server does not close, but continues to be used to send the server any events to the client. <br><br>  <i>Caution!</i>  <i>This shnyaga can kill your server!</i>  <i>By the way, if you suddenly decide to write a high-loaded Scandinavian auction - the truth and funny pictures are somewhere near, under the cut.</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  A couple of words about push </h4><br><br>  The use of PUSH technology is justified where it is necessary to quickly update many clients with certain changes on the server side.  In general, the client and server communication looks like this. <br><img src="https://habrastorage.org/storage/habraeffect/a5/be/a5be514448416c4a39a892010763f3e5.png"><br><br>  Obviously, for each client, we need one constantly running server-side push process called Comet.  This is expensive in terms of server memory usage, but an alternative to this: constant requests to the server are an order of magnitude worse, slower and heavier.  <i>True, there is another good option - working directly with sockets, but this is a separate topic.</i> <br><br><h5>  Work process </h5><br>  When a client performs an action (for example, writes to a chat or votes), he sends an ajax request to the server with the appropriate command.  The result of this command must be distributed to all connected clients.  To do this, the script that processes the ajax request must notify all the Comets that have already transferred the update command to their clients, and those in turn will accurately draw the change. <br><br>  Needless to say, quite a few requests for updates can come at the same time.  For this, a queue of such events should be organized, from which Comets can take events and send them further. <br><br>  Something like this happens when we wrote something in the chat. <br><img src="https://habrastorage.org/storage/habraeffect/60/6c/606c2679efb5e25fc718c9bec89a8e53.png"><br><br>  There are two key points in this diagram: <br><ol><li>  The implementation of the comet (a good <a href="http://habrahabr.ru/blogs/webdev/104945/">review</a> provided by the user <a href="http://habrahabr.ru/users/balepc/" class="user_link">balepc</a> ) </li><li>  The implementation of the queue.  Let's look at them in more detail. </li></ol><br><br><h4>  Queue implementation </h4><br><br>  For our project it was necessary that: <br><ul><li>  Comets instantly ‚Äúwoke up‚Äù when new events entered the queue, and did not interview her constantly.  This can significantly reduce the load on the server, as well as implement an instant system response to user actions. </li><li>  If the Comet dies for some reason (for example, the user has updated the page), the user must still reach all the events that occurred between the time of the death of the Comet and the moment of the reconnection.  Pauses in sending messages also occur if the Push-channel works through the ‚Äúlong polling‚Äù technology (typical, for example, for the Opera browser).  In this case, the push connection is re-created every time the client receives a message from the server. <br><img src="https://habrastorage.org/storage/habraeffect/6c/35/6c35c0672bcac88ee5ac8cdea4b90348.png"></li><li>  When we have 5 people on our site, the voice of each of them should have a greater impact than when we have 100 people on our site. </li><li>  Users who have disabled cameras must leave the screenshots block. <img src="https://habrastorage.org/storage/habraeffect/c0/82/c08266950cdb5269f25a8bf0ff9b34f3.png"><br>  In this case, we need to reliably know how many and which users are online.  The fact is that after the user closes the browser window, no events occur on the server, so it is impossible to track this moment.  And we came to the conclusion that it is necessary for the comet to wake up and report at a certain frequency (say, every five seconds) that it is alive. <br></li><li>  Each event sent to the queue reached all users, regardless of the quality of their channel. </li></ul><br><br>  In simple cases of interaction between two processes, you can use the functions of working with queues built into PHP, or the Zend_Queue wrapper.  However, they do not provide event distribution to all listening processes (comets) at once. <br><br><h4>  Experimenting with queues </h4><br>  One of the possible solutions is <b>the queue manager</b> . <br>  Method of implementation: <br><ul><li>  Each Comet lifts its turn. </li><li>  The identifier of the new queue is stored in a shared memory for all processes. </li><li>  To prevent simultaneous operation of multiple processes with queues, the semaphore is used. </li><li>  When sending a message to a queue, the event is sent to the queue of each process. </li></ul><br><br>  Like that: <br><img src="https://habrastorage.org/storage/habraeffect/61/00/61009c10c2a88bee9860517b14d8b691.png"><br><br>  <i>// when we drew this picture on a piece of paper - we were already scared, but the brave cyclist can try to bring the implementation to the end.</i> <br><br>  Even if we make such a manager, comets will wake up <b>only when new events arrive</b> , and this is clearly not enough for us (remember to know who is alive now?). <br><br>  Unfortunately, standard php functions make a queue with timeouts impossible.  The thought came to mind to implement some kind of third-party server process, which would periodically "awaken" the comet, throwing events into the queue.  By the way, the same process can also remove dead queue IDs from shared memory.  Here is what we get in the end: <br><br><img src="https://habrastorage.org/storage/habraeffect/ad/cf/adcf318c75bcdfeb9b79fc61ca2db40c.png"><br>  When looking at this picture, the <a href="http://lurkmore.ru/%25D0%25A1%25D0%25BF%25D0%25B8%25D1%2581%25D0%25BE%25D0%25BA_%25D1%2586%25D0%25B8%25D1%2582%25D0%25B0%25D1%2582_%25D0%259B%25D1%2583%25D0%25B3%25D0%25BE%25D0%25B2%25D1%2581%25D0%25BA%25D0%25BE%25D0%25B3%25D0%25BE">statement of Lugovsky is</a> involuntarily remembered. <br><blockquote>  "The human fantasy is boundless on idiotic and ridiculous architecture ..." </blockquote><br><br>  We begin to analyze existing solutions for queuing in terms of usability in our application. <br><img src="https://habrastorage.org/storage/habraeffect/c7/59/c759bde2955a0bd368b4a710029d3a1a.png"><br><br>  Our choice fell on Apache ActiveMQ (really chose between him and RabbitMQ) <br>  <b>Pros:</b> <br><ul><li>  Very fast </li><li>  Very stable </li><li>  Support for multiple protocols, including - stomp </li><li>  There is an interaction implementation in ZendFramework </li><li>  There is a way to send messages to all students (so-called Topics) </li><li>  Able to wake up the waiting process by timeout </li><li>  Scaled well </li></ul><br><br>  <b>Minus</b> : Can not return the number of messages in the queue <br><br>  A more detailed overview of queue managers from aleks_raiden <a href="http://habrahabr.ru/users/aleks_raiden/" class="user_link">habrauzer</a> can be found here <br>  <a href="http://habrahabr.ru/blogs/hi/44907/">http://habrahabr.ru/blogs/hi/44907/</a> <br>  <a href="http://habrahabr.ru/blogs/hi/45891/">http://habrahabr.ru/blogs/hi/45891/</a> <br><br>  The only thing that could not be implemented directly using the Topics mechanism was the restoration of events that could occur when the comet's connection was broken before it rose (this could be done by abandoning the Topics mechanism and using individual queues for each process, but ...) <br><br>  We decided to put fresh N events in shared memory so that the comet could instantly restore its context.  As a result, the architecture was the following: <br><img src="https://habrastorage.org/storage/habraeffect/c3/29/c329244348adf717d680b6a5551ef3a1.png"><br><br><h4>  Branch Marks </h4><br><br>  To implement the application, we used ZendFramework.  Ajax requests came to the appropriate controllers, which processed them, and put the messages into a queue, from where comets took the messages and sent them to clients.  The comets themselves are also implemented as an Action inside the ZendFramework controller. <br><br>  Having launched the Apache Branchmark, we were horrified to find that the system actively eats the processor at 25 simultaneous accesses. <br><img src="https://habrastorage.org/storage/habraeffect/5c/6d/5c6dad6a56c9944e7bdc9a6c9fd38f49.png"><br>  <i>300 requests for 25 simultaneous threads</i> <br><br>  As it turned out, initialization of ZendFramework and connection to the database took 99% of the time.  O-ops  Well, this is old news, and the cure for this is known - it is necessary to exclude the inclusion of the ZendFramework classes, except for the really necessary ones.  And all the necessary classes combine into one file. <br><br>  We concluded that it would be necessary to abandon the MVC framework in processing ajax requests for voting and chat, as well as in the implementation of the comet (since its launch speed is very critical for browsers that support only Long poll).  We also got rid of any queries to the database in the processing of ajax requests.  For what we carried out all necessary data in shared memory.  If necessary, the synchronization of shared memory and the database was performed by a third-party process. <br><br><h4>  Total </h4><br><img src="https://habrastorage.org/storage/habraeffect/e4/62/e46201819724670a87644239dc8877da.png"><br>  <i>300 requests per 100 simultaneous streams</i> <br><br>  The reaction to the events from the client has become almost instantaneous.  Hurray, victory!  Lightweight comets use memory and the processor is very economical.  The narrow neck of the application is the distribution of the video stream (but if you do a Scandinavian auction, where effectively using a similar queue architecture is not your problem ;-), we can write about it in the following articles if we withstand the habraeffect. <br><br>  Below is published our queue manager. <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'Zend/Queue.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">require_once</span></span> <span class="hljs-string"><span class="hljs-string">'Sibirix/Queue/Smemory/Package.php'</span></span>; <span class="hljs-comment"><span class="hljs-comment">/** *   * */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sibirix_Queue_Smemory_Manager</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE = <span class="hljs-string"><span class="hljs-string">"BROKEN_OPTIONS_FOR_INIT"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ERROR_UNKNOWN_IDENTIFIER_STORAGE_MESSAGE = <span class="hljs-string"><span class="hljs-string">"UNKNOWN_IDENTIFIER_STORAGE"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ERROR_CAN_NOT_ACTIVATE_THE_SEMAPHORE_MESSAGE = <span class="hljs-string"><span class="hljs-string">"CAN_NOT_ACTIVATE_THE_SEMAPHORE"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SHM_VAR_LAST_CHAT_POSTS = <span class="hljs-number"><span class="hljs-number">1</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SHM_VAR_LAST_SYSTEM_COMMAND = <span class="hljs-number"><span class="hljs-number">2</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> SHM_VAR_QUEUE_LAST_ID = <span class="hljs-number"><span class="hljs-number">3</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_count_chat_package_storage; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_count_system_package_storage; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_activeMQoptions; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_queue; <span class="hljs-comment"><span class="hljs-comment">/** * semaphore key */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_sem_key; <span class="hljs-comment"><span class="hljs-comment">/** * Shared memory APP_KEY = one symbol */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_app_key; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_shared_memory_id = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_shared_memory_handler = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_shared_memory_size; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_sem_id = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_last_queue_message_id = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($options = array</span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!is_array($options)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'sem_key'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'app_key'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { $options[<span class="hljs-string"><span class="hljs-string">'app_key'</span></span>] = (string)$options[<span class="hljs-string"><span class="hljs-string">'app_key'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (strlen($options[<span class="hljs-string"><span class="hljs-string">'app_key'</span></span>]) != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'activeMQ'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'shared_memory_size'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'count_chat_package_storage'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">isset</span></span>($options[<span class="hljs-string"><span class="hljs-string">'count_system_package_storage'</span></span>])) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_BROKEN_OPTIONS_FOR_INIT_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_key = $options[<span class="hljs-string"><span class="hljs-string">'sem_key'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_app_key = $options[<span class="hljs-string"><span class="hljs-string">'app_key'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_activeMQoptions = $options[<span class="hljs-string"><span class="hljs-string">'activeMQ'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_size = $options[<span class="hljs-string"><span class="hljs-string">'shared_memory_size'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_count_chat_package_storage = $options[<span class="hljs-string"><span class="hljs-string">'count_chat_package_storage'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_count_system_package_storage = $options[<span class="hljs-string"><span class="hljs-string">'count_system_package_storage'</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_id = sem_get(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_key, <span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_id = ftok(<span class="hljs-string"><span class="hljs-string">"."</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_app_key); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler = shm_attach(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_id, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_size); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">connectTopic</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_queue) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_queue = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Zend_Queue(<span class="hljs-string"><span class="hljs-string">'Activemq'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_activeMQoptions); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_queue; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receive</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connectTopic(); $message = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; $msg_receive = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_queue-&gt;receive(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $msg_receive <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $msg ) { $pkg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sibirix_Queue_Smemory_Package($msg-&gt;body); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_last_queue_message_id = $pkg-&gt;id; $message = $pkg; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $message; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">receiveAll</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connectTopic(); $last_queue_message_id_mem = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_getLastQueueMessageId(); $messages = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>) { $msg_receive = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_queue-&gt;receive(<span class="hljs-number"><span class="hljs-number">1</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$msg_receive-&gt;count()) {<span class="hljs-keyword"><span class="hljs-keyword">break</span></span>;} <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> ( $msg_receive <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $message ) { $pkg = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sibirix_Queue_Smemory_Package($message-&gt;body); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_last_queue_message_id = $pkg-&gt;id; $messages[] = $pkg; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_last_queue_message_id &gt;= $last_queue_message_id_mem ) { $last_queue_message_id_mem = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_getLastQueueMessageId(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_last_queue_message_id &gt;= $last_queue_message_id_mem ) { <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $messages; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">send</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action, $data, $recipient = false)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;connectTopic(); $package = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sibirix_Queue_Smemory_Package($action, $data, $recipient); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_lock(); $last_queue_message_id_mem = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getLastQueueMessageId(); $last_queue_message_id_mem++; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_setLastQueueMessageId($last_queue_message_id_mem); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_queue-&gt;send( $package-&gt;normalize( $last_queue_message_id_mem ) ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $package-&gt;isPost() ) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_savePackageToChatStorage( $package ); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_savePackageToSystemStorage( $package ); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_unlock(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $last_queue_message_id_mem; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getLastQueueMessageId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $last_queue_message_id_mem = shm_get_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_QUEUE_LAST_ID); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$last_queue_message_id_mem) { shm_put_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_QUEUE_LAST_ID, <span class="hljs-number"><span class="hljs-number">0</span></span>); $last_queue_message_id_mem = <span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $last_queue_message_id_mem; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_setLastQueueMessageId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($id)</span></span></span><span class="hljs-function"> </span></span>{ shm_put_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_QUEUE_LAST_ID, $id); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_sem_getLastQueueMessageId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_lock(); $last_queue_message_id_mem = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getLastQueueMessageId(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_unlock(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $last_queue_message_id_mem; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_savePackageToChatStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $package )</span></span></span><span class="hljs-function"> </span></span>{ $last_chat_posts = shm_get_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_CHAT_POSTS); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$last_chat_posts) {$last_chat_posts=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>();} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($last_chat_posts) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_count_chat_package_storage) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(count($last_chat_posts) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_count_chat_package_storage) { array_shift($last_chat_posts); } } array_push($last_chat_posts, $package-&gt;normalize()); shm_put_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_CHAT_POSTS, $last_chat_posts); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_savePackageToSystemStorage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($package)</span></span></span><span class="hljs-function"> </span></span>{ $last_sys_cmd = shm_get_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_SYSTEM_COMMAND); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$last_sys_cmd) {$last_sys_cmd=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>();} <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($last_sys_cmd) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_count_system_package_storage) { <span class="hljs-keyword"><span class="hljs-keyword">while</span></span>(count($last_sys_cmd) &gt;= <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_count_system_package_storage) { array_shift($last_sys_cmd); } } array_push($last_sys_cmd, $package-&gt;normalize()); shm_put_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_SYSTEM_COMMAND, $last_sys_cmd); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastPackage</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($storage)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( $storage != <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_SYSTEM_COMMAND &amp;&amp; $storage != <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_CHAT_POSTS ) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_UNKNOWN_IDENTIFIER_STORAGE_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_lock(); $last_packages = shm_get_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, $storage); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!$last_packages) {$last_packages=<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>();} <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_unlock(); $return_last_packages = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>(); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span>($last_packages <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> $normalize_package) { $package = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Sibirix_Queue_Smemory_Package($normalize_package); $return_last_packages[] = $package; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $return_last_packages; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_lock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!sem_acquire(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_id)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_CAN_NOT_ACTIVATE_THE_SEMAPHORE_MESSAGE); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_unlock</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ sem_release(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_sem_id); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">resetMemory</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_lock(); shm_put_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_CHAT_POSTS, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>()); shm_put_var(<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_shared_memory_handler, <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::SHM_VAR_LAST_SYSTEM_COMMAND, <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>()); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_setLastQueueMessageId(<span class="hljs-number"><span class="hljs-number">0</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_lock(); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getLastQueueMessageId</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_lock(); $last_queue_message_id_mem = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getLastQueueMessageId(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_unlock(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> $last_queue_message_id_mem; } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** *    * */</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Sibirix_Queue_Smemory_Package</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ERROR_NOT_SUPPORTED_TYPE_ACTION_MESSAGE = <span class="hljs-string"><span class="hljs-string">'ERROR_NOT_SUPPORTED_TYPE_ACTION'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> ERROR_FOR_NORMALIZE_NEED_ID_MESSAGE = <span class="hljs-string"><span class="hljs-string">'FOR_NORMALIZE_NEED_ID'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> CHAT_ACTION = <span class="hljs-string"><span class="hljs-string">'pasteChatMessages'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_supported_actions = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'updateRating'</span></span>, <span class="hljs-string"><span class="hljs-string">'setChannel'</span></span>, <span class="hljs-string"><span class="hljs-string">'pasteChatMessages'</span></span>, <span class="hljs-string"><span class="hljs-string">'updateTimer'</span></span>, <span class="hljs-string"><span class="hljs-string">'connectToServer'</span></span>, <span class="hljs-string"><span class="hljs-string">'statistics'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_read_private_property = <span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-string"><span class="hljs-string">'id'</span></span>,<span class="hljs-string"><span class="hljs-string">'action'</span></span>,<span class="hljs-string"><span class="hljs-string">'time'</span></span>,<span class="hljs-string"><span class="hljs-string">'data'</span></span>,<span class="hljs-string"><span class="hljs-string">'recipient'</span></span> ); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_action; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_data; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_recipient; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_time; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> $_id; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__construct</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ $fg_args = func_get_args(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (count($fg_args) == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_id, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_action, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_time, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_recipient ) = unserialize($fg_args[<span class="hljs-number"><span class="hljs-number">0</span></span>]); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>($action, $data, $recipient) = $fg_args; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_validation($action, $data, $recipient); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_action = $action; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data = $data; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_time = <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_getmicrotime(); <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_recipient = $recipient; } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">normalize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( $id = false )</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ($id) { <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_id = $id; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_id === <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_FOR_NORMALIZE_NEED_ID_MESSAGE); } } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> serialize(<span class="hljs-keyword"><span class="hljs-keyword">array</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_id, <span class="hljs-number"><span class="hljs-number">1</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_action, <span class="hljs-number"><span class="hljs-number">2</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_time, <span class="hljs-number"><span class="hljs-number">3</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_data, <span class="hljs-number"><span class="hljs-number">4</span></span> =&gt; <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_recipient )); } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_validation</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($action, $data, $recipient)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!in_array($action, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_supported_actions)) { <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Exception</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::ERROR_NOT_SUPPORTED_TYPE_ACTION_MESSAGE); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_getmicrotime</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">list</span></span>($usec, $sec) = explode(<span class="hljs-string"><span class="hljs-string">' '</span></span>, microtime()); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> number_format(((float)$usec + (float)$sec), <span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'.'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__get</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($key)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (in_array($key, <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_read_private_property)) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;{<span class="hljs-string"><span class="hljs-string">'_'</span></span>.$key}; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">isPost</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;_action == <span class="hljs-keyword"><span class="hljs-keyword">self</span></span>::CHAT_ACTION ) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">true</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } } <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span></code> </pre><br><h4>  findings </h4><br><ul><li>  For queues, you must use third-party managers.  In our case, Active MQ showed itself well. </li><li>  Work with comets and requests sent to the server should be carried out by lightweight scripts, without full initialization of the framework, connections to the database and other excesses.  Thanks, Cap. </li></ul><br>  Now, looking at what the path was made, it becomes just scary.  I hope this article will help habravchanam draw the right conclusions and not repeat our mistakes in the future. <br><br>  Thank you for your attention, I will be glad to hear questions and comments and will be happy to answer them. <br><br>  UPD.  At the request of readers - publish a link to the project <a href="http://feelyoustar.com/">http://feelyoustar.com/</a> </div><p>Source: <a href="https://habr.com/ru/post/119863/">https://habr.com/ru/post/119863/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../119854/index.html">Should CRM and ERP systems be integrated</a></li>
<li><a href="../119856/index.html">How we talked about the return of the brand with VKontakte, Facebook, Twitter and Youtube</a></li>
<li><a href="../119857/index.html">Digest Wanted.VC # 3</a></li>
<li><a href="../119861/index.html">ICQ (MailRu) started testing a client under Linux</a></li>
<li><a href="../119862/index.html">Itanium-based HP Integrity users join forces to influence Oracle</a></li>
<li><a href="../119864/index.html">My experience buying iPad2, as well as the diversity of Android tablets in Europe</a></li>
<li><a href="../119867/index.html">Windows 8 is coming in 2012</a></li>
<li><a href="../119870/index.html">Panini launches hi-tech collectible cards</a></li>
<li><a href="../119871/index.html">Droider Chart 53. Hit parade of Android applications</a></li>
<li><a href="../119872/index.html">SQA Days 9 Conference Continues Online</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>