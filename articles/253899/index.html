<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Portable hiking weather station MiniBTH</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day. In this publication I will talk about a portable hiking weather station, which I had long conceived and recently implemented in hardware. 

...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Portable hiking weather station MiniBTH</h1><div class="post__text post__text-html js-mediator-article">  Good day.  In this publication I will talk about a portable hiking weather station, which I had long conceived and recently implemented in hardware. <br><br><img src="https://habrastorage.org/files/b83/bc5/c90/b83bc5c90ea540c6bc41010d2d90be4d.jpg" alt="image"><br><br>  I often go to nature, both on long hikes and on short trips on weekends.  On the one hand, instrumental observation will simply satisfy curiosity by answering the question ‚ÄúIs it warmer today than yesterday?‚Äù, Or ‚ÄúHow cold was it at night?‚Äù, On the other hand, the presence of even primitive meteorological information can help predict the improvement or deterioration of weather or fog .  Hence the desire to create an autonomous instrument for measuring, logging and displaying meteorological information suitable for marching use, and satisfying the following requirements: <br><ul><li>  Sealed shockproof housing; </li><li>  Constant display of real time and current weather data: pressure, temperature, humidity, as well as the history of their change over the past few hours and several days on the screen; </li><li>  Screen readable in bright sun; </li><li>  Operation of the device during the whole trip without recharging or replacing batteries or recharging; </li><li>  It is desirable to preserve the history of weather data in non-volatile memory. </li></ul><br>  It is worth noting that devices of a similar purpose in the form of clocks, key chains and individual devices are available on the market, but their ability to display the history of changes in meteorological information is, in my opinion, insufficient, and logging is usually absent altogether.  Therefore, I decided to develop my own device. <br><a name="habracut"></a><br><h4>  Determination of future instrument </h4><br>  At the initial stage of design, it is necessary to determine the choice of the many available parts, components and technologies, and find the optimal combination of them.  Consider the main components of the future instrument and the reasons for the choice of certain decisions. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Screen </h5><br>  For the proposed device, the color screen, in my opinion, is preferable, since on a color screen it is convenient to display several graphs on one coordinate grid, while on a monochrome screen such a picture will be difficult to read.  Given the requirements of visibility to the sun, constant display, and moderate power consumption, the choice definitely falls on the transflective TFT display.  The main problem here is to get an accessible display.  A quick search showed that transflective screens announced in online stores are not available, the options available on alibaba have an inconvenient RGB interface, and the only available option is the screen from the good old Siemens CX / M / S65 phone.  Of course, it‚Äôs not very good to count on a component with disassembly, but for a small-scale DIY project it will do.  The advantages here are the fact that the screen is controlled by SPI (it will be easier to make a fee).  Despite the fact that the screen is from the phone, information is available on how to manage this screen from <a href="http://www.superkranz.de/christian/S65_Display/DisplayIndex.html">Cristian Kranz</a> (at the time of this writing, Christian‚Äôs site has been half a year already). <br><br><h5>  Sensors </h5><br>  For a start it is worth deciding on a set of measurable parameters and sensors for them.  Three unconditionally required parameters - pressure, temperature, and humidity.  You can still add a light sensor. <br><br>  Now we define the criteria for selecting sensors.  Sensors should be small in size, accurate and, if possible, do not require complication of the instrument design due to the specific features of the specific sensor piping.  Ideally, all sensors are digital and operate on the same voltage.  It is also desirable that pressure and humidity sensors that have direct contact with the atmosphere are protected from dirt and dust. <br><br>  <i><b>Pressure meter.</b></i>  From my experience with quadcopters, I came across BPM085 and MS5611 sensors, both with the I2C interface, and with built-in thermal compensation.  Of these, the second one turned out to be more accurate and stable, with a small averaging it resolves 1 Pa pressure, which corresponds to approximately 10 cm of height.  I initially chose it for the device, and later decided to use a protected version of this sensor, called MS5803. <br><br>  <i><b>Humidity sensor</b></i>  There are many options, both analog and digital.  I liked the sension I2C sensors from the SHT2x family.  Small, accurate, works in the same voltage range as the pressure sensor (1.8V-3.6V), and measures not only humidity, but also temperature.  In addition, it comes with a dirt cap. <br><br>  <i><b>Temperature sensor.</b></i>  The above two sensors already measure the temperature, a separate sensor is not needed. <br><br>  <i><b>Light sensor.</b></i>  Here it is desirable to put the sensor with a very wide range of measurements.  To measure from the light of the direct sun (100 thousand lux) and down to deep twilight and moonlit night (0.2lux), and better still less.  Moreover, the sensor is desirable with factory calibration, because I have nothing to calibrate.  There are options with photodiodes, but require additional strapping, although they can potentially have a large range of measurements.  Therefore, my attention was attracted by a series of integrated I2C sensors max4400x.  There are several similar sensors in the series, some are multispectral, some have an IR emitter and can work as a proximity sensor.  One of the requirements for the measurement range, max44009.  However, it is possible to install two sensors, a monochrome max44009 for high illumination, and an RGB sensor for max44008 for a small one.  And the use of a dimming filter can extend the operating range of max44008 to the required 100 thousand.  luxury  We will select the simple variant with max44009 as the main one, and consider max44008 as a possible addition. <br><br><h5>  Processor and piping </h5><br>  Taking into account the fact that the screen and all sensors work from 3-3.3 volts, and SD cards work from 3.3v.  It is advisable to use a processor running from 3-3.3v.  I chose my usual AVR.  Note that the choice of AVR allows you to use the Arduino IDE to build the project and use the library under the Arduino.  In this project, the use of the library to work with the SD card is particularly relevant.  Although, in principle, Arduin's libraries can be used in projects collected in AVR Studio, but this requires some tricks.  Looking ahead, I will say that the only advantage of using the Arduino was the uploading of the program via UART. <br><br>  According to the initial estimates, a 32kb ROM and 2kb RAM is enough for the project (about 600 bytes for working with SD, and almost everything else is the history of measurements) and, therefore, I chose the ATmega328p processor.  Voltage in 3v dictates the clock frequency not higher than 8 MHz.  I started writing a project under the Arduino IDE.  When assembling for this processor and voltage, simply select target Arduino Pro mini 3.3v.  Since real-time clock is needed to realize all the functions of the device, and RF quartz usually do not provide sufficient frequency stability, you must either use a clock quartz with a processor (in view of the features, the ATmega328p will be clocked from the RC oscillator) or use a separate real-time clock chip .  In view of the latter circumstance, I decided to use a separate I2C chip with a DS1337 calendar clock.  An additional argument in favor of a separate chip with RTC was the possibility of implementing battery change without losing the clock settings.  However, subsequently the option of the device‚Äôs built-in batteries was chosen. <br><br>
<h5>  Control buttons </h5><br>  Although the device interface is planned to be simple, buttons are still needed to switch the display modes, set the time and altitude corrections.  Since the mechanical buttons are difficult to hide in the pressure hulls, (for this you need to make holes in the body and put a flexible seal in them tightly, or insert a pusher through the seal) it was decided to make capacitive touch control buttons.  With a touch pad area of ‚Äã‚Äãabout 1 cm2, a wall thickness of 2-3 mm with a dielectric constant of about 2-4 (typical for plastics), it is necessary to make a device that reliably records the change in capacitance by the fraction of picofarads.  Such a problem has several solutions.  The first option is to install a specialized chip - touch controller.  The second is to make touch buttons on pairs of processor legs, simply measuring the charging time of the input capacitance of the input line with the contact pad through the megohm resistor from the output line.  The method is described on several resources, there are appropriate libraries.  However, since I want to create a sensitive and noise-proof sensor, I chose the third option - the sensor on the phase detector.  The idea is simple.  Two RF signals are fed to the input of the phase detector.  One directly from the source, and the second through an RC circuit, in which a sensor pad is used as a capacitor (and, of course, the parasitic capacitance of the input of the phase detector too).  The signal from the output of the phase detector is averaged and measured using an ADC.  Such a scheme will be much less sensitive to ambient noise, at least at frequencies other than the frequency of the test signal.  As a source of RF signal, you can simply take the processor clock.  For greater noise immunity, you can also introduce phase-code modulation of this signal, however, judging by the operating experience, this is overkill. <br><br><h5>  Housing design </h5><br>  One of the most difficult issues for DIY projects - creating a sealed enclosure.  In this case, the design of the hull is largely determined by the available technological base.  The only tool available for me to make a thermocase is a 3-axis CNC milling machine, suitable for milling plastics, wood and soft metals.  It turns out that the body must be assembled from milled parts from plastic and aluminum.  The question remains the choice of seals.  Special sealing gum, and even the required length could not be found, but tape recorders can be used as sealing seals.  This technology has already been tested earlier on other buildings.  As a result, the body will consist of a central unit with grooves for seals, and the front and rear plastic covers, fixed clamping frames.  The question remains the choice of materials.  It is advisable to manufacture the central unit from corporal.  In this plastic, you can reliably cut threads, like in metal, it is not brittle and wear-resistant.  The front cover should be transparent and preferably not fragile.  From the available options of transparent plastics, I chose polycarbonate.  The disadvantages of this material are not very high transparency compared with polymethyl methacrylate.  But it is plastic and not subject to cracking.  There are no requirements for transparency to the back wall, in the end I settled on a variant of fiberglass laminate.  Clamping frames should have sufficient rigidity to press the gum along the entire length.  In addition, it is they who will account for most of the possible body attacks on surrounding objects.  Therefore, it was decided to make them from aluminum alloy. <br><br><h5>  Sensor placement </h5><br>  Pressure and humidity pressure sensors should communicate with the atmosphere, have good thermal contact with it.  In addition, they should be relatively thermally insulated from the case to reduce the response time to temperature changes.  It is advisable to place them in such a way as to protect them from possible impacts and dirt.  Therefore, the layout of the sensors on the T-shaped protrusion in the recess of the housing looks promising. <br><br><img src="https://habrastorage.org/files/cc1/dc0/d2e/cc1dc0d2ef9d4695a09ee624b77716b2.gif" alt="sensor layout"><br><br>  The light sensor will be placed behind the transparent front panel, near the screen.  The effect of wall transparency can be taken into account by calibrating the sensitivity of the sensor. <br><br><h5>  Power supply </h5><br>  There is little choice, either lithium-ion batteries or metal hydride.  Metal hydride work a little better at low temperatures, and this is where the advantages end.  By energy intensity, lithium is more profitable.  In the end, I chose lithium-ion, although this choice was made at a fairly late stage of the project.  For myself, I defined the following requirements for battery life: <br><ul><li>  9 days (1 week + 2 days) in winter (temperature -10 ..- 20); </li><li>  15 days in the summer in the mountains (the temperature briefly drops below 0); </li><li>  25 days in the warm season (the temperature does not fall below 0). </li></ul><br>  Based on these requirements, the battery capacity will be determined. <br><br><h4>  Electronic part development </h4><br>  According to the solutions described above, the design of the instrument was developed. <br><br><img src="https://habrastorage.org/files/c13/178/ad6/c13178ad65de4196981caf16446e8e18.gif" alt="schematic diagram of the device"><br><br>  Chip 78HC03 stabilizes the supply voltage for the controller and sensors.  On the 74AC00 and 74AC86 microcircuits, a touch button controller is built.  The first one is designed to turn on / off the supply of 8 MHz signal to the sensor plates, the second one contains 3 phase detectors.  The voltage converter for the backlight is made on the chip of the DC / DC converter with PWM control LM2733x and is powered by batteries, bypassing the stabilizer, the OS is made from the current of the LEDs.  The operating voltage at the output is about 12V (in the backlight of the screen 4 LEDs connected in series).  To protect the controller in case of removing the screen from the board, the zener diode works at 15v as a protective load.  The backlight current is set by resistor R9, the voltage drop on which is 1.25V.  The max1879 controller controls the charge of the batteries, the TS321 operational amplifier with strapping is used to measure the charge current.  Real-time clock is made on a chip DS1337.  During the development of the circuit and the board, the possibility of installing a backup battery for the clock was provided.  However, when using non-removable batteries, the battery is not needed. <br><br><h5>  Wireless charger </h5><br>  The implementation of wireless charging turned out to be one of the most underestimated tasks in this device.  For reasons of convenience, the layout of parts in the case, I chose W - shaped core W7x7.  A larger core would lead to an increase in the already not small body, although the size the larger the better, so that the two halves at 1.5mm gap (rear wall thickness) dissipate the flow as little as possible.  However, even with this size of the core and the thickness of the gap, the scattering of the flux is essential, therefore, the resonance phenomenon had to be used for more efficient energy transfer.  Note that the split transformer can operate in several modes: <br><br>  a) The device lies on the charging stand, the battery is charging, the transformer is loaded with a load from a steep CVC. <br>  b) The device lies on the charging stand, the battery is charged or charged in PWM mode, the transformer is not loaded. <br>  c) The device is removed from the charging cradle, but the primary winding of the transformer is connected to its own power source. <br>  d) The intermediate position of parts of the transformer, briefly at the time of installation and removal of the device. <br><br>  It is necessary that the charger can operate in all four states without overheating of the windings and overload of the keys.  There are two options - either to make a complex driver with automatic frequency control and shutdown when there is no load or by selecting the parameters of the elements.  It is impractical to make a resonant circuit out of the secondary winding, since in state b) when the transformer is not loaded, a large voltage will appear on the secondary winding, which can easily exceed the maximum allowable open-circuit voltage for max1879 and the key.  Therefore, we will manage resonance only in the primary winding circuit.  I managed to achieve quite good charging parameters using a very simple power scheme. <br><br><img src="https://habrastorage.org/files/c87/cda/587/c87cda5870c048c185ccd6e8c1f2ea5b.gif" alt="charger circuit"><br><br>  The primary winding is connected to an alternating voltage source consisting of an IR2153 generator-driver and two switches powered from 12V.  In series with the primary winding, capacitor C7 is turned on, they form an oscillating circuit.  Parallel to the primary winding, a neon lamp (in my case, a pair of opposite-connected lamps) with an ignition voltage of about 160V is turned on for protection against overloads.  The oscillator frequency (about 100 kHz) is set by the construction resistor R1 and is adjusted so that in mode a) the circuit works very close to resonance.  In this case, the amplitude value of the voltage on the primary winding reaches 100-110v, and the average current of the secondary winding (battery charge current is about 600 mA).  In mode b), when the load is switched off the circuit goes out of resonance (the resonant frequency of the circuit when the secondary winding is not loaded is lower than the generator frequency), the voltage on the primary winding falls below 60V, and accordingly the useless losses in ferrite also fall, and the amplitude value of the secondary winding voltage does not exceed 14B.  In mode c) the inductance of the ‚Äúhalf‚Äù of the transformer is less, the resonant frequency of the circuit is higher than the frequency of the generator, the voltage on the primary winding drops, and the loss in ferrite is small.  In mode d), the unloaded primary circuit can get into resonance, and for this, a neon lamp is used as a ‚Äúprotective‚Äù load.  The primary winding (in the charger) contains 32 turns of the PEV-1 wire 0.6 and the secondary winding (in the instrument) 32 turns of the PEV-1 0.3.  It should be noted that the quality factor of the circuit and, accordingly, the maximum power transferred to the load is limited by the loss in ferrite.  Parallel to the secondary winding, 15c p6ke15ca suppressors are activated to protect the charge circuit from voltage surges.  With the selected parameters of the scheme in operating modes, the suppressors do not heat up. <br><br><h4>  Software development </h4><br>  For Arduino there are many libraries to work with sensors, and other peripherals, but many of them are inconvenient and cumbersome.  In the development process, I came to the conclusion that other small libraries should be used to a minimum, implementing simple functionality independently.  This saves several controller resources and the amount of ROM used, although it slows down development.  Native Arduino libraries were cumbersome and inconvenient.  As a result, the only third-party library used on the project was <a href="https://github.com/greiman/SdFat">SdFatLib by William Greiman</a> .  The module for working with i2c sensors sht21 and max44009 and RTC was written from scratch, work with ms5611 / 5803 was borrowed from the multiwii project and refined.  The x65 by Christian Kranz screen module has been redesigned to fit the needs of a specific project.  There are 3 types of screens in siemens x65 with different controllers: Epson L2F50, Sharp LS020, and Hitcah LPH88.  I managed to get only the first two samples, so while my project supports only two types of display controllers.  The specific type is set in configs.  It is also worth noting that the FUSES configuration, which is non-standard for the Arduino, is necessary for the device to operate - switching the CLKO line and setting the brownout detector to 2.7 volts. <br><br><h5>  Work with sensors </h5><br>  There were no particular difficulties with interrogating the sensors, they (and the clock too) are interrogated continuously in the main program loop, the duration of the main cycle is approximately equal to about 180 ms.  It is worth noting one feature of the sensors MS5611 / 5803.  They sometimes "freeze" testimony after several thousand measurements.  This feature was noticed by me while debugging multiwii, and here I ran into it again.  The way out of the situation is trivial: once in 256 polls, I simply reset the sensor, and problems with fading no longer arise.  The last digits in the pressure sensor readings constantly fluctuate within 3-4 Pa (the sensor resolution is 1 Pa), but averaging the results of the last 16 measurements makes it possible to remove the fluctuations completely.  And this is not all the features of the MS5611, it also turned out to be photosensitive, which required the installation of a light cap.  The rest of the sensors worked without surprises. <br><br><h5>  Information display </h5><br>  The question of what the displayed information should look like at first seemed uneasy.  But at the initial stage of development a simple mapping principle was laid, and then it was only improved.  The principle is simple - the device has two display modes.  The first shows a graph with meteorological information, and basic data read from the sensors in digital form. <br><br><img src="https://habrastorage.org/files/43e/6d5/3a2/43e6d53a2a2d4b3281320c218afc9366.jpg" alt="screenshot"><br><br>  In the second mode, the screen displays all information about the current state of the device and sensors: battery voltage and charge current, temperature from two sensors, humidity, pressure, calculated dew point and barometric altitude, zero height pressure, illuminance, time, date.  It also has the ability to set the clock and pressure at the altimeter zero mark.  With a screen size of 132x176 pixels, the size of the graphic was made 96x100, while there was room for the signature of the scales in the font of the smallest possible size, and for placing 4 hours of current information in the 8x14 font.  The temperature curve is aligned to the bottom of the coordinate system, the pressure curve to the top.  The scale along the ordinates is adjusted automatically to the displayed data.  Humidity is displayed proportionally fill the background of the graph with a light blue color.  The position of the labels and grid lines of the y-axis is constant, only the labels' labels change.  The grid and labels on the x-axis move with time, along with the graph.  An important question is the choice of the available scales of the x-axis.  Taking into account the available amounts of RAM, it was decided to stop at two scales - fast 2min / pixel (data for the last 3 hours and 10 minutes are displayed), and slow 30min / pixel (data for the last 48 hours are displayed).  In the slow mode, the averaged data for the half-hour interval is displayed.  In the mode, the current data is stored every two minutes at 0 seconds.  This is done in order to remove the visible "lag" of data on the fast graph relative to the current.  For each graph display mode, 96 counts of pressure, humidity and temperature are stored.  Moving on the schedule back in time is not provided.  Data is written to the card once per minute, but with averaging of all readings. <br><br><h5>  Work with touch buttons </h5><br>  To poll the touch buttons, periodically (once per main cycle), they receive a test RF signal (8 MHz from the output of the CLKO processor) for 5 ms, after which the values ‚Äã‚Äãof the signal at the outputs of the phase detectors are read.  The ADC has 10 digits, the output values ‚Äã‚Äãvary from 0 to 1023. With the selected values ‚Äã‚Äãof R1-R3, for free sensor plates 8x10mm in size, the values ‚Äã‚Äãare 500-700, when you lift a finger to the plate located 1.5mm thick behind the PCB, the values ‚Äã‚Äãchange to 70-150 counts in a big way.  On the one hand, this indicates a large input capacitance of the 74AC86 logic elements, on the other hand, the signal change is more than enough to reliably determine the touch and adjust the threshold, even if the dielectric thickness is increased to 2-3 mm.  To determine the logical state of the touch buttons, the currently read value is compared with the average over the last several reads.  If their difference exceeds the threshold, the sensor state is fixed as ‚Äúpressed‚Äù.  If the difference falls below the vacation threshold, the state is fixed as ‚Äúreleased‚Äù.  The thresholds for each sensor are set separately; this makes it easy to make the sensors sensitive enough to avoid false alarms.  Adaptive comparison circuit ensures reliable operation of the touch buttons with changing temperature and possible contamination of the case. <br><br>  The buttons are designed to perform routine actions for switching modes, as well as critical actions, such as setting the clock.  To activate critical actions, you need to select a special "initiating" combination of buttons that is difficult to press randomly.  Since the buttons are arranged in a row, the natural variant of such a combination is to keep the extremes with the average released.  In this case, the remaining actions are performed by pressing and holding one button.  When you press a pair of adjacent buttons, their action is blocked until the release of both.  The initiating combination is also used to turn on the backlight.  And if the illumination is less than the threshold of 100 lux, the initiating combination always turns on the backlight.  Further, depending on the display mode, pressing this combination again either turns off the backlight or turns on the clock setting mode.  To confirm the entered time and date, you must click the initiating combination again.  For the convenience of searching for buttons in the dark, special projections are made on the top cover. <br><br><h5>  Energy saving measures </h5><br>  After writing the main part of the measurement program, it was shown that, on average, when the backlight is off, the device consumes about 7.5 mA, of which about 3 m consumes the display.  The rest of the consumption falls mainly on the processor, on the controller of the touch buttons, the microSD card, and a little on the sensors.    ,   ¬´¬ª      ,        . ,     ,      .             ,          ADC Noise reduction (.  myadc).       , , ,       .   ,          .       6.  ,     sleep modes      ,   5.5,      ,     ,   ,     .            3.5           .           .   ,       SD ,           2. <br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Housing design </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At the initial stage of development, it became clear that the case would consist of two main volumes of an airtight compartment with an electronic part, and a ventilated recess for accommodating sensors. </font><font style="vertical-align: inherit;">The sensors are small and their layout does not cause problems. </font><font style="vertical-align: inherit;">With the main board more difficult. </font><font style="vertical-align: inherit;">It should have a screen, touch pads (under the right arm - to the right of the screen), a light sensor (above the screen). </font><font style="vertical-align: inherit;">It is rational to make a deepening with sensors from above, then when the device is on a support (table, ground, stone, ...) - the sensors will be on top. </font><font style="vertical-align: inherit;">And the mount for hanging the device on the neck should be made from below, then it will be more convenient to look at the screen of the backpack hanging on the shoulder strap or the neck of the device.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The size of the case will be chosen according to the layout of the batteries and the charging transformer. Batteries are selected based on the required operating time. When the current consumption is not more than 6mA and the operating time voiced above, the capacity of the battery should be about 6000 mAh. In this case, it is advisable to choose batteries in such a way that as closely as possible to assemble the instrument compartment. After analyzing the available batteries, I stopped at the option of two Panasonic NCR18650B. At the same time, the size of the pressurized hull of the case and the board can be made 70x50mm. In turn, this size determines the length of the sealing gum (semi-perimeter 70 + 50 + stock = 125mm) and the size of the body. Since the rubber elastic from the belt is tough, you will need a lot of clamping screws.The required number of clamping screws can either be calculated by solving the problem of deformation of the gum and body by the method of finite elements, or determined experimentally. I chose the second option and experimentally determined that 8 screws is enough. With the size of the case did not save much to make a more simple form. The size of the niches containing the sensors is also made with a margin for better ventilation. As a result, the size of the central unit turned out to be 103x68mm, and the pressure frames even more. Then I will give a photo of the elements of the body, and the link at the end of the article you can download the archive with the drawings of the boards, and curves, and a description of the operations for the milling of the body.to make a simpler form. The size of the niches containing the sensors is also made with a margin for better ventilation. As a result, the size of the central unit turned out to be 103x68mm, and the pressure frames even more. Then I will give a photo of the elements of the body, and the link at the end of the article you can download the archive with the drawings of the boards, and curves, and a description of the operations for the milling of the body.to make a simpler form. The size of the niches containing the sensors is also made with a margin for better ventilation. As a result, the size of the central unit turned out to be 103x68mm, and the pressure frames even more. Then I will give a photo of the elements of the body, and the link at the end of the article you can download the archive with the drawings of the boards, and curves, and a description of the operations for the milling of the body.</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Fabrication and assembly of the device </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The central unit is made of corporal by milling. </font><font style="vertical-align: inherit;">The height of the central unit is 31mm. </font><font style="vertical-align: inherit;">The dimensions of the groove for the sealing gum were pre-selected by trial and error. </font><font style="vertical-align: inherit;">The test groove was milled in a soft material (PVC foam sheet), an elastic band was used on it, after which amendments were made to the dimensions of the groove. </font><font style="vertical-align: inherit;">Inside the pressurized compartment there are two projections to which the main board of the device is attached.</font></font><br><br><img src="https://habrastorage.org/files/ae9/009/234/ae90092348554505b2f7a0c03724bcb7.jpg" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The sensor block is mounted on top with two stainless steel M3x10 screws. The tracks leading to the sensors and the point of entry of wires into the case are insulated with silicone sealant. Stainless steel 0.5 mm washers are laid between the sensor board and the case. These washers set the thickness of the sealant layer covering the tracks at the time of pouring. The sealant also glues the SF2 cap over the humidity sensor. According to the documentation, only sealants should be used for mounting the cap and sealing the sensor, evaporation that does not cause irreversible damage to the sensor. One of these is the DOW Conring 732 acid silicone sealant. I used it to seal the sensor. (However, any other silicone is likely to work, but I decided to play it safe).After the sealant dries, the humidity sensor should be degassed, keeping at a temperature of 100-120 degrees Celsius for 10-12 hours, for which I used a regular hairdryer.</font></font><br><br><img src="https://habrastorage.org/files/c37/fa4/688/c37fa4688de9407a9ec3c913ff151def.jpg" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The front panel is milled from 2mm polycarbonate. Back panel of 1.5mm fiberglass. The pressure plates are milled from aluminum alloy (duralumin). The front plate differs from the back plate in that it has protrusions that facilitate the tactile search for sensor plates. The batteries and the charging transformer are fixed on the rear panel with two spacers milled from the capralon and the carbon pressure plate. The printed circuit board is manufactured using LUT technology, copper wires are soldered into the vias.</font></font><br><br><img src="https://habrastorage.org/files/0b3/995/f90/0b3995f906734b22a72cd4691f4f5c7e.jpg" alt="   "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The MS5803 sensor used is water and dirt-protected, however, irradiating the sensor with bright light significantly affects the readings. Therefore, it was decided to close the sensor light cap. The cap is made of polystyrene by gluing with solvent. The inner part of the cap is made black, light-absorbing, and the outer white light-scattering, to prevent heating in the sun. The cap is glued to the sensor board with cyanoacrylate glue. Later it turned out that the light penetrates through the sensor board and illuminates the pressure sensor from below. For this, an additional light shielding plate was installed on top of the sensor board. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Plate with touch pads is installed near the screen flush with the future cover on several layers of thick double-sided tape.</font></font><br><br><img src="https://habrastorage.org/files/db6/b8d/ac9/db6b8dac9e6646b6b99afbb92407239c.jpg" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Since the casing is sealed, it is necessary to ensure that the remaining air inside the casing is drained to avoid condensation at low temperatures. </font><font style="vertical-align: inherit;">To do this, a small fabric bag filled with silica gel was placed in the case (in the photo at the bottom right of the battery). </font></font><br><br><img src="https://habrastorage.org/files/bf9/4ff/00f/bf94ff00fd0d4966a5ac3070a5beab5b.jpg" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The front and rear panels are fastened with eight stainless steel M3x12 screws. </font><font style="vertical-align: inherit;">Flat cap hexagon 2mm selected for aesthetic reasons. </font><font style="vertical-align: inherit;">The weight of the device assembly is 330g, overall dimensions 110x70x38mm (41mm for screw caps).</font></font><br><br><h4><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> Operating experience of the device </font></font></h4><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The device was tested in the summer in a canoe trip in Karelia and the White Sea, and in the fall in a hiking trip in the mountain Crimea. While driving in a kayak, I put the device on the kayak from above, securing the rope to the frame. During the foot radial exits in Karelia, and during the hike in the Crimea, the device was constantly hanging on my neck. During parking and daytime, the device was hung in the shade of a tree branch. The general impressions of using the device are very positive: it seems that literally you have got another sense organ.</font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">When driving in a kayak over a large lake or sea, the measured pressure graph actually corresponds to one height and allows you to judge the weather. An intensive decrease in pressure, as a rule, precedes the deterioration of the weather in 1-2 days, an intensive increase in pressure ‚Äî an improvement in the weather. Intensive can be considered a change in pressure of about 10-20 mm Hg per day. During stable weather, the pressure changes much slower. On time scales of the order of a day, changes in pressure are significantly faster than 20 mm Hg per day I have not seen. However, once in a city during a storm, I observed a pressure surge of 1.5 mm Hg, which occurred within 2-3 minutes.</font></font><br><br>        ¬´¬ª  . ,   ,    ,      .             ,   .  ,     1        10,     200      ,    ,   .      ,      50-300/,                   . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This is how the pressure graph looks like when climbing up the mountain (Mount Calicorva in Karelia):</font></font><br><br><img src="https://habrastorage.org/files/d1a/5fa/e45/d1a5fae4587b41cf8ea40db3e28962e7.jpg" alt="image"><br><br>          .      ,      .         .  ,            20   ,          (               ).    ¬´¬ª    .  ,       .            ,       2-4 .     ,             5-15    .         .     ,             ,    ¬´¬ª     (    sht21  95%). <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Photo of the device, hanging on a pine during the day: </font></font><br><br><img src="https://habrastorage.org/files/b83/bc5/c90/b83bc5c90ea540c6bc41010d2d90be4d.jpg" alt="  "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Another frame, morning. During the day's transition last day, the device lay in a canoe and was heated by the sun to unrealistic temperatures.</font></font><br><br><img src="https://habrastorage.org/files/c3a/6aa/3eb/c3a6aa3eb09d44ff956acfe726235aa3.jpg" alt="  "><br><br>         .        60-90,     3-20,        . ,       9  (3    )      30,  500-2000    .             10,     0.2 .        ,          ,         ,          . <br><br>             .       ‚Äì        ,          .              .    ‚Äî   ,     ,           ,   ,     .       ,    .             ,          . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The device lies on a canoe: </font></font><br><br><img src="https://habrastorage.org/files/97f/7da/d52/97f7dad524ab4898a2b19cd97041a5be.jpg" alt="   "><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">During the autumn hike in the Crimea, the impressions of the device were somewhat different. If pressure information in Karelia allowed us to predict what the weather will change about the weather, in the Crimean mountains the pressure sensor is valuable solely as an altimeter. The presence of an altimeter allows you to learn new things, even about long-timed trails, and makes it possible to track which part of the ascent or descent you went through, if the height difference is known. Those "scraps" of the pressure chart that are recorded at the sites do not provide useful information about the weather. At least in the fall, when tomorrow you may be above the cloud, in a cloud, under a cloud, or there may be no clouds at all.</font></font><br><br><img src="https://habrastorage.org/files/d63/8a9/3e0/d638a93e08784d0ba6af9c7c2f4a232d.jpg" alt="   , "><br><br>        -,       .          ,   . <br>               / ,      . <br><br><img src="https://habrastorage.org/files/77b/d7b/eff/77bd7beffc6a405e9f8660f2ea54a9ba.jpg" alt="  "><br><br>          ,      . <br><br>          ,                    ,           . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Finally, summarize the experience of using the device. It should be noted that all conceived technical solutions and all the planned measurement channels, which turned out to be more or less useful in the campaigns, were implemented. The idea of ‚Äã‚Äãdisplaying graphs that allow you to track how the temperature, pressure, and humidity have changed recently has fully justified itself. Touch buttons work reliably in any weather, including in the rain. The battery life of the device is sufficient. The screen readings are easily readable in any light, the graphs are easily distinguishable, despite the fact that there are three of them on the same coordinate system. The time interval of 2 minutes per countdown is enough to keep track of rapid changes in readings, including short stops when driving on an ascent or descent.For temperature or humidity, this frequency may seem excessive. Wireless charging works, but its use has not contributed to reducing the weight of the device.</font></font><br><br><img src="https://habrastorage.org/files/975/d47/f41/975d47f41d7d4cd6a64264be91bf83a7.jpg" alt="   "><br><br>       : <br><ul><li>    ,      .      ,     . </li><li>            +5  ,       . </li><li> Water falling on the protective cap of the humidity sensor and in the gap between the panels leads to ‚Äústicking‚Äù of the moisture readings. </li><li>  Memorized to display data is not enough.  For example, in the evening it is impossible to see what happened this morning at a resolution of 2 min / pixel.  The data for the day before yesterday at a resolution of 30min / pixel is also not complete. </li><li>  The ability to display a height graph instead of pressure is required. </li><li>  There is a lack of history of changing pressure settings at zero altitude.  It is especially important if several times during a hike you spend a correction at the same height, or at the same point. </li><li>  I would like to increase the resolution of the lux meter in the range of low illumination. </li></ul><br><br>  As a result, a number of solutions are proposed for use in creating the second version of the device.  Since one of the main drawbacks of the first version of the device is a large mass, a number of measures have been proposed to reduce weight and increase usability: <br><ul><li>  Disregard the permanent display to reduce the required capacity and weight of the battery. </li><li>  Reduce the thickness of the side walls of the device. </li><li>  Stop wireless charging in favor of a lighter and more compact pressure input. </li><li>  Reduce the size of the board and the internal compartment to the size of the screen (this is possible due to the reduction of the battery), transfer the sensor plates to the side wall. </li><li>  Reduce the size of the sensor unit and the light sensor of the pressure sensor.  Appear from the humidity sensor cap. </li><li>  Provide for such a construction of the case and the scheme of fastening the rope so that the case can stand vertically on flat horizontal surfaces. </li></ul><br><br>  To expand the functionality of the device, it was decided to transfer the project to AVR Studio and GCC, to switch to using the ATmega1284p processor with 16kb of RAM and 128kb of ROM.  This will complicate the program and realize the following features: <br><ul><li>  Storage of weather data for the last 4 days with a resolution of 1 countdown in 2 minutes. </li><li>  Displaying data on a graph in several time scales with the ability to move the displayed window over the entire stored data set. </li><li>  The ability to display pressure data either as a pressure graph or as a height graph. </li><li>  The ability to display humidity data either as a relative humidity graph or as a dew point temperature graph. </li><li>  Storing pressure history at zero altitude. </li></ul><br><br>  Boards, source codes, curves for milling, and other information can be downloaded <a href="https://drive.google.com/file/d/0B_CJyzdtbmlsdm90dXNUS0JHUHc/view%3Fusp%3Dsharing">here</a> . <br><br>  PS At the moment the second version of the device is assembled and is being tested.  Soon there will be a sequel. </div><p>Source: <a href="https://habr.com/ru/post/253899/">https://habr.com/ru/post/253899/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../253883/index.html">And we have an SDK, and you?</a></li>
<li><a href="../253885/index.html">Solving sql injection tasks from alexbers.com/sql</a></li>
<li><a href="../253889/index.html">How to log in to Linux server on gray IP from Android system with mobile Internet using ipv6</a></li>
<li><a href="../253893/index.html">Non-standard use of the site monitoring service</a></li>
<li><a href="../253895/index.html">Who is this toy for or how to identify the target audience</a></li>
<li><a href="../253901/index.html">Self-assembly 3d-printer or purchase ready-made equipment for the design. BY. Part 2</a></li>
<li><a href="../253903/index.html">CLRium, the last announcement before Moscow</a></li>
<li><a href="../253905/index.html">REG.ru has divided part of domains</a></li>
<li><a href="../253907/index.html">DotHill 4824 storage overview</a></li>
<li><a href="../253909/index.html">(Archive) The first version of the Matreshka.js framework has been released</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>