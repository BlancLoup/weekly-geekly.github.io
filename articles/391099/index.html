<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Emulation of various devices using Pi Zero - how to do it?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If you want to emulate using Pi Zero network adapter, keyboard, drive, and everything else, and at the same time - all this can be done. LibComposite ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Emulation of various devices using Pi Zero - how to do it?</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/01c/bbf/151/01cbbf151a3a5b9e2d8ea94f695165d8.jpg" width="750"><br><br>  If you want to emulate using Pi Zero network adapter, keyboard, drive, and everything else, and at the same time - all this can be done.  LibComposite comes to the rescue, however, in this case it must be remembered that there is no solution under Windows, the method is suitable only for Linux or Mac OS X. A detailed description of the user's actions to achieve the result described in the title is in continuation ( <a href="http://isticktoit.net/%3Fp%3D1383">source</a> ). <br><a name="habracut"></a><br><h3>  Step 0 - configuring the SD card </h3><br>  Download and install the latest distribution of Raspbian Jessie on a suitable SD card (must be sufficiently capacious), and increase the root partition. <br><br><h3>  Step 1 - The Core </h3><br>  You need to use Kernel 4.4, which does not come by default with the Rasbian distribution.  But upgrading is quite easy, you just need to execute this console command: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      <i>sudo BRANCH = next rpi-update</i> <br><br>  After this, do the following: <br><br>  <i>echo "dtoverlay = dwc2" |</i>  <i>sudo tee -a /boot/config.txt</i> <i><br></i>  <i>echo "dwc2" |</i>  <i>sudo tee -a / etc / modules</i> <br><br>  And finally, activate the libcomposite driver: <br><br>  <i>sudo echo "libcomposite" |</i>  <i>sudo tee -a / etc / modules</i> <br><br><h3>  Step 2 - Configuring Devices </h3><br>  Now you need to decide on what device to emulate - a network card, keyboard, or all of this together? <br><br>  Configuring this with ConfigFS, the virtual file system in / sys /.  It is automatically mounted at the start of the ‚Äúraspberry‚Äù, so in the future you can work with it. <br>  There is a great example for a device called USBArmory, an example of <a href="https://github.com/ckuethe/usbarmory/wiki/USB-Gadgets">this here</a> .  Everything else will be shown on the basis of it. <br><br>  <b>Create a configuration script</b> <br><br>  It will have to run every time the device starts.  Create an isticktoit_usb in / usr / bin / file using your favorite text editor.  We write here that: <br>  <i>sudo touch / usr / bin / isticktoit_usb #create the file</i> <i><br></i>  <i>sudo chmod + x / usr / bin / isticktoit_usb #make it executable</i> <i><br></i>  <i>sudo nano / usr / bin / isticktoit_usb #edit the file</i> <br><br>  After that, the script must be run automatically at the start.  For better performance, you can create a systemd unit file, but for now let's get around to rc.local.  (this is part of the old sysvinit system, but it runs on raspberry pi by default). <br><br>  Open under the root /etc/rc.local and add this line (before !!!) with a line containing the word "exit": <br><br>  <i>sudo nano /etc/rc.local</i> <i><br></i>  <i>/etc/rc.local ...</i> <i><br></i>  <i>/ usr / bin / isticktoit_usb # libcomposite configuration</i> <i><br></i>  <i>exit</i> <br><br>  <b>Create a gadget</b> <br><br>  This is a global configuration, so no matter how many USB gadgets you would like to use.  You can change the serial number, manufacturer and product name in this block. <br><br>  <i>/ usr / bin / isticktoit_usbcd / sys / kernel / config / usb_gadget /</i> <i><br></i>  <i>mkdir -p isticktoit</i> <i><br></i>  <i>cd isticktoit</i> <i><br></i>  <i>echo 0x1d6b&gt; idVendor # Linux Foundation</i> <i><br></i>  <i>echo 0x0104&gt; idProduct # Multifunction Composite Gadget</i> <i><br></i>  <i>echo 0x0100&gt; bcdDevice # v1.0.0</i> <i><br></i>  <i>echo 0x0200&gt; bcdUSB # USB2</i> <i><br></i>  <i>mkdir -p strings / 0x409</i> <i><br></i>  <i>echo "fedcba9876543210"&gt; strings / 0x409 / serialnumber</i> <i><br></i>  <i>echo "Tobias Girstmair"&gt; strings / 0x409 / manufacturer</i> <i><br></i>  <i>echo "iSticktoit.net USB Device"&gt; strings / 0x409 / product</i> <i><br></i>  <i>mkdir -p configs / c.1 / strings / 0x409</i> <i><br></i>  <i>echo "Config 1: ECM network"&gt; configs / c.1 / strings / 0x409 / configuration</i> <i><br></i>  <i>echo 250&gt; configs / c.1 / MaxPower</i> <i><br></i>  <i># Add functions here</i> <i><br></i>  <i># see gadget configurations below</i> <i><br></i>  <i># End functions</i> <i><br></i>  <i>ls / sys / class / udc&gt; UDC</i> <br><br>  <b>Ethernet adapter</b> <br><br>  First of all, let's add this to our configuration file: <br><br>  <i>sudo nano / usr / bin / isticktoit_usb</i> <i><br></i>  <i>/ usr / bin / isticktoit_usb # Add functions here</i> <i><br></i>  <i>mkdir -p functions / ecm.usb0</i> <i><br></i>  <i># byte must be even</i> <i><br></i>  <i>HOST = "48: 6f: 73: 74: 50: 43" # "HostPC"</i> <i><br></i>  <i>SELF = "42: 61: 64: 55: 53: 42" # "BadUSB"</i> <i><br></i>  <i>echo $ HOST&gt; functions / ecm.usb0 / host_addr</i> <i><br></i>  <i>echo $ SELF&gt; functions / ecm.usb0 / dev_addr</i> <i><br></i>  <i>ln -s functions / ecm.usb0 configs / c.1 /</i> <i><br></i>  <i># End functions</i> <i><br></i>  <i>ls / sys / class / udc&gt; UDC</i> <i><br></i>  <i>#put this at the end of the file:</i> <i><br></i>  <i>ifconfig $ N 10.0.0.1 netmask 255.255.255.252 up</i> <i><br></i>  <i>route add -net default gw 10.0.0.2</i> <br><br>  Save and exit, then go to host PC: <br>  If there are problems with the automatic connection, disconnect and perform the following: <br><br>  <i>dmesg | grep cdc_ether</i> <i><br></i>  <i>[13890.668557] cdc_ether 1-1: 1.2 eth0: register 'cdc_ether' at usb-0000: 00: 14.0-1, CDC Ethernet Device, 48: 6f: 73: 74: 50: 43</i> <i><br></i>  <i>[13890.674117] usbcore: registered new interface driver cdc_ether</i> <i><br></i>  <i>[13890.687619] cdc_ether 1-1: 1.2 enp0s20u1i2: renamed from eth0</i> <br><br>  You can rename the adapter later, but for now let's call it enp0s20u1i2 <br><br>  <i>sudo ifconfig enp0s20u1i2 10.0.0.2 netmask 255.255.255.252 up</i> <br><br>  And connect via ssh to PI: <br><br>  <i>ssh 10.0.0.1 -l pi</i> <br><br>  <b>Keyboard, Mouse, Joystick (HID)</b> <br><br>  <i>sudo nano / usr / bin / isticktoit_usb</i> <i><br></i>  <i>/ usr / bin / isticktoit_usb # Add functions here</i> <i><br></i>  <i>mkdir -p functions / hid.usb0</i> <i><br></i>  <i>echo 1&gt; functions / hid.0 / protocol</i> <i><br></i>  <i>echo 1&gt; functions / hid.0 / subclass</i> <i><br></i>  <i>echo 8&gt; functions / hid.0 / report_length</i> <i><br></i>  <i>echo -ne \\ x05 \\ x01 \\ x09 \\ x06 \\ xa1 \\ x01 \\ x05 \\ x07 \\ x19 \\ xe0 \\ x29 \\ xe7 \ x15 \\ x00 \\ x25 \\ x01 \\ x75 \\ x01 \\ x95 \\ x08 \\ x81 \\ x02 \\ x95 \\ x01 \\ x75 \\ x08 \\ x81 \\ x03 \\ x95 \\ x05 \\ x75 \\ x01 \ \ x05 \\ x08 \\ x19 \\ x01 \\ x29 \\ x05 \\ x91 \\ x02 \\ x95 \\ x01 \\ x75 \\ x03 \\ x91 \\ x03 \\ x95 \\ x06 \\ x75 \\ x08 \\ x15 \\ x00 \\ x25 \\ x65 \\ x05 \\ x07 \\ x19 \\ x00 \\ x29 \\ x65 \\ x81 \\ x00 \ xc0&gt; functions / hid.0 / report_desc</i> <i><br></i>  <i>ln -s functions / hid.usb0 configs / c.1 /</i> <i><br></i>  <i># End functions</i> <br><br>  Here is the easiest way to send keystrokes to the device file: <br>  <i>echo "\ 0 \ 0 \ x4 \ 0 \ 0 \ 0 \ 0 \ 0"&gt; / dev / hidg0 #press the A-button</i> <i><br></i>  <i>echo "\ 0 \ 0 \ 0 \ 0 \ 0 \ 0 \ 0 \ 0"&gt; / dev / hidg0 #release all keys</i> <br><br>  But this is not the most practical way, so you should use <a href="https://github.com/girst/hardpass">this example</a> and download it to your PC.  Then we extract it to the SD ‚Äúraspberry‚Äù card and launch it. <br><br>  <i>On Pi:</i> <i><br></i>  <i>cd PATH_TO_HARDPASS_REPO</i> <i><br></i>  <i>make #compile the program</i> <i><br></i>  <i>echo -n ‚Äúhello world!‚Äù |</i>  <i>sudo ./scan / dev / hidg0 1 2</i> <br><br>  Here ‚Äö1 'means the American keyboard layout, and‚Äú 2 ‚Ä≥ - German-Austrian.  The second number is needed to enter characters that are not on your keyboard (2 = Linux, 3 = Windows (although there are no drivers for this OS)). <br><br>  <b>Storage device</b> <br><br>  It is more difficult to do.  You can only use the disk image file.  The example creates a very small disk image file to save the host's ethernet configuration. <br>  First, let's make a disc.  This is quite a long process, <a href="http://www.linux-usb.org/gadget/file_storage.html">tutorial here</a> . <br>  Then again go to the configuration: <br><br>  <i>sudo nano / usr / bin / isticktoit_usb</i> <i><br></i>  <i>/ usr / bin / isticktoit_usb # Add functions here</i> <i><br></i>  <i>FILE = / home / pi / usbdisk.img</i> <i><br></i>  <i>mkdir -p $ {FILE / img / d}</i> <i><br></i>  <i>mount -o loop, ro, offset = 1048576 -t ext4 $ FILE $ {FILE / img / d}</i> <i><br></i>  <i>mkdir -p functions / mass_storage.usb0</i> <i><br></i>  <i>echo 1&gt; functions / mass_storage.usb0 / stall</i> <i><br></i>  <i>echo 0&gt; functions / mass_storage.usb0 / lun.0 / cdrom</i> <i><br></i>  <i>echo 0&gt; functions / mass_storage.usb0 / lun.0 / ro</i> <i><br></i>  <i>echo 0&gt; functions / mass_storage.usb0 / lun.0 / nofua</i> <i><br></i>  <i>echo $ FILE&gt; functions / mass_storage.usb0 / lun.0 / file</i> <i><br></i>  <i>ln -s functions / mass_storage.usb0 configs / c.1 /</i> <i><br></i>  <i># End functions</i> <i><br></i> <br>  After that, a removable disk in FAT32 format should be available, which will be shown after the next connection of Pi to the main PC.  To access files saved on Pi, you can unmount and then reconnect it somewhere else. <br><br><h3>  What else? </h3><br><br>  There are about 20 USB gadgets that can be emulated by the Linux kernel.  Here is more <a href="https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt">information about it</a> ! <br><br>  <b>Useful links:</b> <br>  <a href="http://blog.gbaman.info/%3Fp%3D699">Tutorial by gbaman</a> <br>  <a href="https://www.kernel.org/doc/Documentation/usb/gadget_configfs.txt">libcomposite in the Kernel documentation</a> <br>  -&gt; <a href="https://github.com/girst/hardpass">hardpass - PiZero project (Keyboad emulation)</a> &lt;- <a href="https://github.com/ckuethe/usbarmory/wiki/USB-Gadgets">USBArmory Wiki Page</a> </div><p>Source: <a href="https://habr.com/ru/post/391099/">https://habr.com/ru/post/391099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../391087/index.html">Children's version of the search engine - Kiddle</a></li>
<li><a href="../391089/index.html">The story of another 3d cube 10x10x10</a></li>
<li><a href="../391093/index.html">MediaTek Labs invites you to a series of March webinars on the development of smart home gadgets</a></li>
<li><a href="../391095/index.html">Review Paragon NTFS for Mac: working with the Windows file system on the "Mac" without any problems</a></li>
<li><a href="../391097/index.html">"How to measure a bunch" or geodesy today</a></li>
<li><a href="../391101/index.html">Sound # 29 - Audio and Ecosystem Podcast</a></li>
<li><a href="../391103/index.html">They will plant not only for likes and comments, but also for emoji</a></li>
<li><a href="../391105/index.html">Thinking out loud. Four is better than one ... Or the concept of a transport quadrocopter</a></li>
<li><a href="../391107/index.html">Ballmer Peak or superkoder mode "ON"</a></li>
<li><a href="../391109/index.html">The history of reverse engineering of a Chinese fitness bracelet</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>