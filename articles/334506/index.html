<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Do you want to encrypt any TCP connection at all? You now have a NoiseSocket</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi% username%! 

 Not everything in this world revolves around browsers and there are situations when TLS is redundant or not applicable at all. Not a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Do you want to encrypt any TCP connection at all? You now have a NoiseSocket</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/46a/835/c91/46a835c91f0b41f98fa4a7a931dc6256.jpg"><br><br>  Hi% username%! <br><br>  Not everything in this world revolves around browsers and there are situations when TLS is redundant or not applicable at all.  Not always there is a need for certificates, very often the usual public keys are enough, to take the same SSH. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      And there is also IoT, where pushing TLS entirely is generally not a task for the faint of heart.  And the backend, which, I am almost sure, all after the balancer communicates with each other via normal HTTP.  And P2P and more and more and more ... <br><br>  Not so long ago, the <a href="http://noiseprotocol.org/">Noise Protocol Framework</a> specification appeared on the network.  This is essentially the constructor of secure data transfer protocols, which in simple language describes the stage of the handshake and what happens after it.  The author is Trevor Perrin, the leading developer of the Signal messenger, and Noise itself is used in WhatsApp.  So, there was an excellent reason to take a closer look at this protocol framework. <br><br>  We liked it so much with its simplicity and conciseness that we decided to use it on the basis of a whole new network layer protocol that is not inferior to TLS in security, and even surpasses something in some way.  We presented it at DEF CON 25, where it was very warmly received.  It's time to talk about him and us. <br><a name="habracut"></a><br>  First, a little about the direct core of NoiseSocket, namely <br><br><h2>  Noise Protocol Framework </h2><br>  In fact, any of the protocols described by the Noise Framework is a sequence of transmitted public keys and the Diffie-Hellman operations performed on them. <br><br>  The main idea of ‚Äã‚Äãthe Noise Protocol Framework is that absolutely all actions during the handshake affect the state of the protocol and, therefore, the final session keys.  All DH, all additional data that is transmitted or taken into account during the handshake, are mixed into the general state using hashing and form as a result common symmetric keys. <br><br>  All this happens within a simple system of states, which consists of three parts. <br><br><img src="https://habrastorage.org/web/fdb/3fb/7bb/fdb3fb7bbbee4f0e95fdbc9eb86a7375.jpg"><br><br>  There is, by the way, a video in English, where David Wong tells in a fairly accessible manner how things work there. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/ceGTgqypwnQ" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  <b>HandshakeState</b> is responsible for processing tokens and messages. <br><br>  <b>SymmetricState</b> generates symmetric keys from DH results and updates them with each new DH.  Thus, immediately after the very first DH, the data that follows it (static keys, payload) is already encrypted with some kind of symmetric key. <br>  More <b>SymmetricState</b> hashes additional data, such as the keys themselves, the optional <b>prolog</b> , the names of the protocols, etc.  All this allows the protocol to be holistic and protected from outside interference at all stages of data transfer. <br><br>  <b>CipherState</b> is a symmetric AEAD cipher + nonce (counter) just initialized by some key, which is incremented with each call of the encryption function. <br><br>  Protocols in Noise are described in a special language that consists of patterns, messages, and tokens. <br><br><img src="https://habrastorage.org/web/dfc/efc/ff4/dfcefcff4e2344039bcb6800acc62688.jpg"><br><br>  Consider for example one of the protocols, Noise_XX, which allows you to establish a secure connection by exchanging <b>static</b> server and client keys in the process: <br><br> <code>Noise_XX(s, rs): <br> -&gt; e <br> &lt;- e, ee, s, es <br> -&gt; s, se <br></code> <br><br>  Noise_XX is a <b>pattern</b> .  It describes the sequence of messages and their contents. <br><br>  <b>(s, rs)</b> indicates that the client and server are initialized with their static ( <b>s</b> ) key pairs.  These are the ones that are generated once.  <b>r</b> means remote. <br><br>  As we can see there are three lines with arrows.  One line - one message.  Arrow means who sends to whom.  If right, then the client to the server, otherwise vice versa. <br><br>  Each line consists of <b>tokens</b> .  This is one or two letter expressions separated by commas.  Single letter tokens are only <b>e</b> and <b>s</b> and mean ephemeral and static public keys, respectively.  Ephemeral generated once per connection, static reusable. <br>  In general, in Noise, all protocols begin with the transfer of an ephemeral key.  Thus, Perfect Forward Secrecy is achieved.  Approximately the same thing came up in TLS 1.3 when all non-ephemeral ciphersuites were canceled. <br><br>  Two-letter tokens mean Diffie-Hellman between one of the client and server keys.  They are, as it is easy to guess, of four types: <br>  <b>ee</b> , <b>es</b> , <b>se</b> , <b>ss</b> .  Depending on what keys DH is between, it performs different functions.  <b>ee</b> , for example, is needed to randomize the resulting key for the transport session, and DH with the participation of static keys are responsible for mutual authentication. <br><br>  As you can see, in the XX pattern, the client's static key is transmitted to the server, exactly as vice versa.  Therefore, three messages are used here.  There are patterns that suggest that the client has a static server key (for example, when he first made XX) and reduce the number of messages to two.  In addition, it is possible to transmit encrypted data immediately in the first message, which is called 0-RTT and reduces the response time from the server. <br><br><img src="https://habrastorage.org/web/f4a/715/877/f4a7158778ca47888c5c53a0411cdec5.jpg"><br><br>  For each handshake message, you can add a payload.  These can be top-level protocol settings, the same certificates, just digital signatures, in general, anything within 64k bytes.  All Noise packets are limited to this size.  So parsing is simplified, the length is always placed in 2 bytes, it is easier to work with memory. <br><br><img src="https://habrastorage.org/web/679/cfa/944/679cfa9444804bac907f27aad310b3a2.png"><br><br>  As a result, the handshake in our hands remains essentially only two symmetric key, which are the result of all DH, occurred earlier.  One to send messages, the second to receive them.  Everything, after that we can send encrypted packets, incrementing nonce every time after sending. <br><br>  In addition to the pattern, the Noise Protocol is characterized by algorithms that it uses in each particular case.  The specification lists the algorithms for DH, AEAD and hash.  No more noise needed. <br><br>  DH: Curve25519, Curve448, <br>  AEAD: AES-GCM, ChachaPoly1305, <br>  Hash: Blake2, SHA2 <br><br>  All primitives are very fast, no RSA and other inhibitory junk.  Although, of course, if you want, you can do it yourself, no one forbids it. <br><br><h2>  NoiseSocket </h2><br>  We saw all this beauty and realized that this is an ideal candidate for the role of the next generation transport protocol.  After all, right there out of the box there are all the necessary security features, performance, the ability to screw up their authentication mechanisms.  And the predicted size of the code should allow you to create normal secure connections from any, even the smallest devices.  And they began to think. <br><br>  I wrote the first PoC on Go somewhere around the new year 2017.  Almost nothing added to the original Noise, just the length of the packets.  He showed it to the guys, wrote to the <a href="https://moderncrypto.org/mail-archive/noise/2017/">Noise Mailing List,</a> and by the end of June we finally arrived at a common denominator that could be implemented on more platforms. <br><br>  So, what we finally added to the noise?  After long conversations and dozens of options, there are essentially only three things left: <br><br><ol><li>  Negotiation data </li><li>  Padding </li><li>  Processing rules </li></ol><br><h2>  Negotiation data </h2><br><br>  This is just a set of bytes in which you can put anything.  It is needed in order to align the algorithms and patterns between the client and the server.  In our version it looks like this: <br><br><img src="https://habrastorage.org/web/ba8/762/7c5/ba87627c5cfa45fda210afb26eb927ac.jpg"><br><br>  Only 6 bytes, but this is enough for the server to understand how to handle any Noise messages that get to it. <br><br><h2>  Padding </h2><br>  I am very glad that he got into the final spec, otherwise everyone would have had to invent it himself.  This is packet alignment, which allows you to hide their true size and prevent content from being guessed even without decryption.  It is implemented as an additional 2 bytes at the beginning of the encrypted data, which indicate the actual packet size.  All that is after - garbage that needs to be thrown out. <br><br><img src="https://habrastorage.org/web/293/fec/7bf/293fec7bf0d442c5a93023a6d287ec7e.jpg"><br><br><h2>  Processing rules </h2><br>  These are a few simple rules on how the server responds to the client if it accepts its message or vice versa, does not understand it and wants to switch to another protocol. <br><br><h2>  Why? </h2><br>  <a href="https://virgilsecurity.com/">Virgil</a> has its own PKI and we really lacked the ability to establish secure connections right away using public keys, not using certificates and then validate from above.  And now we have made the <a href="https://github.com/VirgilSecurity/virgil-nginx-noise-socket"><b>NGINX module</b></a> and can serve the entire backend through NoiseSocket, adding digital signatures of static keys to it. <br><br>  You probably think you need to change everything in order to upgrade to NoiseSocket?  But no. <br>  If you are writing to Go and you already have HTTP services, then you only need to change the DialTLS method for clients and Listen for servers, everything else will think what works with TLS.  This is all thanks to the <a href="https://github.com/go-noisesocket/noisesocket/">Go library</a> , which we also implemented. <br><br><img src="https://habrastorage.org/web/3cb/f03/ff0/3cbf03ff033043ba8670a0e89b243a68.jpg"><br><br>  Of course, there is still a lot of work on the code and specifications, but, hell, we have an alternative to TLS! <br><br>  Now you do not need to invent something of your own when you want to build a secure link between two nodes, having only public keys in hand.  Tor, i2p, bitcoin, where the node is often identified by the public key, can use NoiseSocket immediately without any additives. <br><br>  SSH, VPN, all kinds of tunnels can add digital signatures of static keys and get a full-featured secure link with a minimum overhead without having to drag openssl to yourself, you can do Libsodium or even Nacl. <br><br>  The approximate size of compiled crypto-primitives certainly depends on the architecture, but it gives us hope that we climbed into 30 or even 20 kilobytes with a minimal implementation of NoiseSocket.  In devices, where the private key is sewn in hardware, this solution simply will not have any special alternatives. <br><br><h2>  Conclusion </h2><br>  I had high hopes for TLS 1.3, since there and handshake roundtrips were reduced from 8-9 to three, as in Noise, and added 25519. But <br><br>  First, we decided not to add the ability to work without certificates, simply by key, although there was such a proposal. <br>  Secondly, the ed25519 certificates are not clear when they appear, and in Noise I can use the signatures of 25519 today. <br><br>  Moreover, not so long ago, one of the Noise patterns, IK (which is 0-RTT), received a <a href="https://www.wireguard.com/formal-verification/">formal proof of</a> correctness from the authors of WireGuard VPN, which only increased our confidence in the correctness of the choice. <br><br>  I suggest to get acquainted with the specification of NoiseSocket and I am sure that in some projects it will suit you more than TLS.  Meanwhile, we are waiting for your comments. <br><br><h2>  Links </h2><br>  <a href="http://noiseprotocol.org/specs/noisesocket.html">Specification Noise Socket</a> <br>  <a href="https://github.com/noisesocket/spec">Github</a> <br>  <a href="http://noiseprotocol.org/noise.html">Noise Protocol Framework specification</a> </div><p>Source: <a href="https://habr.com/ru/post/334506/">https://habr.com/ru/post/334506/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../334490/index.html">Hackathon during working hours</a></li>
<li><a href="../334492/index.html">iRobot will sell data from IoT devices manufactured by the company</a></li>
<li><a href="../334498/index.html">How Chrome and Firefox agree to transfer two video streams</a></li>
<li><a href="../334500/index.html">Why Node.js as a frontend base is cool [updated]</a></li>
<li><a href="../334502/index.html">‚ÄúI work on projects that integrate a book and an interactive‚Äù: Kay Horstmann about books and not only</a></li>
<li><a href="../334510/index.html">In a section: the news aggregator on Android with backend. Introduction, idea, technology</a></li>
<li><a href="../334512/index.html">Nontrivial problems with generics and possible solutions.</a></li>
<li><a href="../334514/index.html">In a section: the news aggregator on Android with backend. Version Control System</a></li>
<li><a href="../334516/index.html">"Halfway": The five major news of the company ServiceNow for 2017</a></li>
<li><a href="../334518/index.html">"Pot, cook": 50 tools for managing development</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>