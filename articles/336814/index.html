<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hanami Getting Started</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! Some time ago, I became interested in the Hanami framework and, in order to better lay in my head, began to translate the official guide for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hanami Getting Started</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/web/21a/3de/629/21a3de629cfb48e781c7bdd2bd6256c8.jpg"><br>  Hi, Habr!  Some time ago, I became interested in the Hanami framework and, in order to better lay in my head, began to translate the official guide for beginners.  This and want to share with the community.  I tried to translate closer to the original, but I am more a reader than a writer, and if you have comments on the translation, do not hesitate to express them, I will correct. </p><br><p>  In this guide, we will create our first project in Hanami, make a simple web application.  We will touch all the main components of the framework and cover everything that is written with tests. </p><a name="habracut"></a><br><h2 id="chto-takoe-hanami">  What is Hanami? </h2><br><p>  Hanami is a Ruby MVC framework consisting of multiple micro libraries. <br>  It has a simple, stable API, a minimum DSL, and a preference for using simple objects for magic, overcomplicated classes with many responsibilities. </p><br><p>  The price of using simple objects with pure duties is more than a template code.  Hanami provides ways to reduce this extra work by serving low-level code implementations. </p><br><h2 id="pochemu-hanami">  Why Hanami? </h2><br><p>  There are three reasons why you should choose Hanami: </p><br><h3 id="hanami-legkovesen">  Hanami lightweight </h3><br><p>  The Hanami code is relatively short.  He is responsible only for the things that are needed in order not to write the very thing that every web application needs.  Hanami comes with several optional modules, and other libraries can also be easily connected.  The meaning of Hanami in architecture. </p><br><h3 id="esli-tebe-nadoedaet-rails-way-to-stoit-obratit-vnimanie-na-hanami">  If you get bored with the "Rails way", then you should pay attention to Hanami </h3><br><p>  Hanami bases the actions of the controllers on the classes, which simplifies their testing in isolation. <br>  Hanami also encourages you to write business logic in interactors (usage scenarios). <br>  Views are separated from patterns, so their logic can also be tested in isolation. </p><br><h3 id="hanami-potokobezopasen">  Hanami is thread safe </h3><br><p>  Using multithreading is a great way to improve application performance.  It should not be difficult to write thread-safe code, and Hanami (the whole application or its parts) are thread-safe. </p><br><h2 id="rukovodstva">  Manuals </h2><br><p>  The manuals explain the high-level components and how to prepare them (set up, use and test) in a full-fledged application.  The imaginary project in question is the "Bookshelf": an online community in which people read and buy books. </p><br><h1 id="getting-started">  Getting Started </h1><br><h2 id="vstupitelnoe-slovo-sozdatelya">  Introductory word of the creator </h2><br><p>  Hey.  If you read this page, you probably want to know more about Hanami.  This is great, congratulations!  If you're looking for new ways to build supported, secure, fast, and testable applications, you're in good hands.  <strong>Hanami is made for people like you.</strong> </p><br><p>  It is necessary to warn you, regardless of whether you are completely new, or an experienced developer, <strong>the learning process will be difficult</strong> .  After 10 years, during which you have formed a certain view on the development, it may be difficult to break some of their habits.  Change is always a challenge to yourself. </p><br><p>  Sometimes it will seem that some features do not look particularly sensible, but it is not always the case in your views.  This can be a matter of habit, a mistake in design or even a bug.  With the best of intentions, we try to improve Hanami every day. </p><br><p>  In this guide, we will create our first project in Hanami, make a simple web application 'bookshelf'.  We will touch all the main components of the framework and cover everything that is written with tests. </p><br><p>  <strong>If you encounter any difficulties or just get confused, do not give up, go to our <a href="http://chat.hanamirb.org/">chat</a> and ask questions.</strong>  There will always be someone who will be happy to help. </p><br><p>  Have fun <br>  Luca guidi <br>  Creator hanami </p><br><h2 id="predislovie">  Foreword </h2><br><p>  Before we begin, we will clarify some things.  First, suppose you need some basic knowledge of web application development. </p><br><p>  You should be familiar with some things like <a href="http://bundler.io/">Bundler</a> , <a href="http://rake.rubyforge.org/">Rake</a> , be able to work in the terminal and build applications using the <a href="https://ru.wikipedia.org/wiki/Model-View-Controller">Model, View, Controller</a> patterns. </p><br><p>  Later in the tutorial, we will use the <a href="https://sqlite.org/">SQLite</a> <a href="https://postgrespro.ru/docs/postgresql/9.6/index.html">Postgresql</a> database. <br>  To go further, you need a working version of Ruby 2.3 or higher and SQLite 3+. </p><br><h2 id="sozdadim-novyy-hanami-proekt">  Create a new Hanami project </h2><br><p> To create a project in Hanami, we first need to install gem Hanami through Rubygems. <br>  Then we can use the console command <code>hanami new</code> to generate a new project: </p><br><pre> <code class="hljs sql">% gem <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> hanami % hanami <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> bookshelf</code> </pre> <br><p>  By default, the project will be configured to use SQLite.  For real projects, you can specify another database engine, for example, Postgres: </p><br><p> <code>% hanami new bookshelf --database=postgres</code> </p> <br><p>  This will create a new <code>bookshelf</code> folder in the one from which the command was run.  See what it will contain: </p><br><pre> <code class="hljs dos">% <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> bookshelf % <span class="hljs-built_in"><span class="hljs-built_in">tree</span></span> -L <span class="hljs-number"><span class="hljs-number">1</span></span> . ‚îú‚îÄ‚îÄ Gemfile ‚îú‚îÄ‚îÄ Rakefile ‚îú‚îÄ‚îÄ apps ‚îú‚îÄ‚îÄ config ‚îú‚îÄ‚îÄ config.ru ‚îú‚îÄ‚îÄ db ‚îú‚îÄ‚îÄ lib ‚îú‚îÄ‚îÄ public ‚îî‚îÄ‚îÄ spec <span class="hljs-number"><span class="hljs-number">6</span></span> directories, <span class="hljs-number"><span class="hljs-number">3</span></span> files</code> </pre> <br><p>  Here, at least, is the cost to know about it: </p><br><ul><li>  <code>Gemfile</code> defines our Rubygems dependencies (using Bundler). </li><li>  <code>Rakefile</code> describes our Rake tasks. </li><li>  <code>apps</code> contains one or more Rack compatible applications. <br>  Here we can find the first Hanami generated application called <code>Web</code> . <br>  There we will find our controllers, views, routes and patterns. </li><li>  <code>config</code> contains (all of a sudden!) configuration files. </li><li>  <code>config.ru</code> (rack up) for Rack servers. </li><li>  <code>db</code> contains our database and migration schema. </li><li>  <code>lib</code> contains our business logic and domain model, including entities and repositories. </li><li>  <code>public</code> will contain compiled assets and static files. </li><li>  <code>spec</code> contains our tests. </li></ul><br><p>  Move on and install the dependencies specified in the Gemfile using Bundler;  then run the server in development mode: </p><br><pre> <code class="hljs sql">% bundle <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> % bundle exec hanami <span class="hljs-keyword"><span class="hljs-keyword">server</span></span></code> </pre> <br><p>  And ... we meet your first Hanami project at <a href="http://localhost:2300/"></a>  <a href="http://localhost:2300/">http: // localhost: 2300</a> !  We should see in the browser something like this: </p><br><p><img src="https://habrastorage.org/web/885/c68/b6c/885c68b6cd5540c1bc5f46b977180c9d.png"></p><br><h2 id="arhitektura-hanami">  Hanami architecture </h2><br><p>  The Hanami architecture <strong>allows</strong> you <strong>to contain multiple Hanami (and Rack) applications in a single Ruby process</strong> . </p><br><p>  These applications are in the <code>apps/</code> directory.  Each of them can be a component of your product, such as a user interface, control panel, dashboard or, for example, HTTP API .. </p><br><p>  These are all parts of <em>the</em> business logic <em>delivery mechanism</em> living in the <code>lib/</code> folder.  This is the place where our domain models are described, their interaction with each other, constituting the <strong>functionality</strong> provided by our product. </p><br><p>  Hanami‚Äôs architecture was strongly influenced by Uncle Bob‚Äôs <a href="https://blog.8thlight.com/uncle-bob/2012/08/13/the-clean-architecture.html">Pure Architecture</a> ideas. </p><br><h2 id="pishem-nash-pervyy-test">  We write our first test </h2><br><p>  The start screen of the application, which we saw in the browser, is the page that is shown by default until we have defined a single route. </p><br><p>  Hanami encourages <a href="https://en.wikipedia.org/wiki/Behavior-driven_development">Behavior Driven Development</a> (BDD) as a way to develop web applications.  Before creating our first page, we first write a high-level test describing its work: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/features/visit_home_spec.rb require 'features_helper' describe 'Visit home' do it 'is successful' do visit '/' page.body.must_include('Bookshelf') end end</span></span></code> </pre> <br><p>  Please note that despite the fact that Hanami out of the box supports the Development Through Behavior (BDD), <strong>you are not forced to use some special framework for testing</strong> - there is also no need for any special integration or libraries. </p><br><p>  We start with <a href="https://github.com/seattlerb/minitest">Minitest</a> (which is the default), but we can also use <a href="http://rspec.info/">RSpec</a> if we create a project with the option <code>--test=rspec.</code> <br>  Hanami will in this case generate helpers and file templates for it. </p><br><h3 id="vypolnyaem-trebovaniya">  We fulfill the requirements </h3><br><p>  We already have a test and we can see how it falls: </p><br><pre> <code class="hljs xml">% rake test Run options: --seed 44759 # Running: F Finished in 0.018611s, 53.7305 runs/s, 53.7305 assertions/s. 1) Failure: Homepage#test_0001_is successful [/Users/hanami/bookshelf/spec/web/features/visit_home_spec.rb:6]: Expected "<span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE html&gt;</span></span>\n<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>\n <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span>\n <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Not Found<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>\n <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span>\n <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>\n <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Not Found<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>\n <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span>\n<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span>\n" to include "Bookshelf". 1 runs, 1 assertions, 1 failures, 0 errors, 0 skips</code> </pre> <br><p>  It's time to make it go.  We will write a few lines of code required to pass the test, step by step. </p><br><p>  The first thing we need to add is the route: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/config/routes.rb root to: 'home#index'</span></span></code> </pre> <br><p>  We redirect the root (root) URL of our application to the action <code>index</code> <code>home</code> controller (see the <a href="http://hanamirb.org/guides/routing/overview">routing guide</a> for a more detailed explanation).  Now we can create an action <code>index</code> . </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/controllers/home/index.rb module Web::Controllers::Home class Index include Web::Action def call(params) end end end</span></span></code> </pre> <br><p>  This is an empty action and does not contain any logic.  Each action has a corresponding view that represents the Ruby object to be given in response to a request that arrives at the action. </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/views/home/index.rb module Web::Views::Home class Index include Web::View end end</span></span></code> </pre> <br><p>  ... which, in turn, is also empty and does nothing except render the template.  By default, this is an <code>erb</code> file, but no one will forbid you to use <code>slim</code> or <code>haml</code> .  We will have to fix it to pass the test.  All we have to do is add the title Bookshelf. </p><br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta"># apps/web/templates/home/index.html.erb </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;h1&gt;</span></span></span><span class="hljs-meta">Bookshelf</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;/h1&gt;</span></span></span></span></code> </pre> <br><p>  Save the changes, run the tests again and this time have to pass.  Sumptuously! </p><br><pre> <code class="hljs pgsql">Run <span class="hljs-keyword"><span class="hljs-keyword">options</span></span>: <span class="hljs-comment"><span class="hljs-comment">--seed 19286 # Running: . Finished in 0.011854s, 84.3600 runs/s, 168.7200 assertions/s. 1 runs, 2 assertions, 0 failures, 0 errors, 0 skips</span></span></code> </pre> <br><h2 id="generiruem-novye-eksheny">  We generate new actions </h2><br><p>  Let's take advantage of learning about the main components of Hanami to add a new action.  The project Bookshelf is designed to account for books. </p><br><p>  We will store information about books in the database and give the user the ability to manage it.  The first step is to display a list of all books stored in the system. </p><br><p>  We describe the functionality to which we aspire, using a feature test: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/features/list_books_spec.rb require 'features_helper' describe 'List books' do it 'displays each book on the page' do visit '/books' within '#books' do assert page.has_css?('.book', count: 2), 'Expected to find 2 books' end end end</span></span></code> </pre> <br><p>  The test is quite simple and falls because the address <code>/books</code> is not yet recognized by the application.  Create a controller action to fix this. </p><br><h3 id="generatory-hanami">  Hanami Generators </h3><br><p>  Hanami comes with some <strong>generators</strong> to write less template code framing the new functionality. <br>  Type in the terminal: </p><br><pre> <code class="hljs perl">% bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> hanami generate action web books<span class="hljs-comment"><span class="hljs-comment">#index</span></span></code> </pre> <br><p>  This command should generate a new action <em>index</em> in the <em>books</em> controller of the <em>web</em> application. <br>  This will give us an empty action, a view and a template, and also add a route to <code>apps/web/config/routes.rb</code> : </p><br><pre> <code class="ruby hljs">get <span class="hljs-string"><span class="hljs-string">'/books'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> <span class="hljs-string"><span class="hljs-string">'books#index'</span></span></code> </pre> <br><p>  In ZSH, you can get the error <code>zsh: no matches found: books#index</code> .  In this case, try another syntax: </p><br><pre> <code class="hljs pgsql">% hanami generate action web books/<span class="hljs-keyword"><span class="hljs-keyword">index</span></span></code> </pre> <br><p>  Now, in order to pass the test, we just need to make the template in the file <code>apps/web/templates/books/index.html.erb</code> look like: </p><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Bookshelf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>All books<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"books"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"book"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Patterns of Enterprise Application Architecture<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>by <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>Martin Fowler<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"book"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>Test Driven Development<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span>by <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span>Kent Beck<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">strong</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Save the changes and see that the tests pass! </p><br><p>  The terminology of controllers and actions can be confusing, so it is worth clarifying: actions constitute the basis of the Hanami application;  controllers are simply modules that combine several actions. <br>  In general, despite the <em>conceptual</em> presence of "controllers" in the application, in practice we will work only with actions. </p><br><p>  We used a generator to create a new entry point into the application.  But you should pay attention to the fact that our new template contains the same <code>&lt;h1&gt;</code> as in <code>home/index.html.erb</code> .  Let's fix it. </p><br><h3 id="makety">  Layouts </h3><br><p>  To avoid repeating the same lines from the template to the template, we can use the layout.  Open the <code>apps/web/templates/application.html.erb</code> file and make it look like this: </p><br><pre> <code class="hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE HTML&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Bookshelf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span>Bookshelf<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">yield</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Now you can remove duplicate lines from other templates. </p><br><p>  <strong>The layout</strong> is similar to any other pattern, but it is used to wrap standard patterns.  The <code>yield</code> keyword is replaced with the contents of the regular template.  This is a great place for repeating items like caps, footers or menus. </p><br><h3 id="migracii-dlya-izmeneniya-shemy-bazy-dannyh">  Migrations to change the database schema </h3><br><p>  Hard-wired in the pattern of the book is cheating, to be honest.  It's time to add live data to the app. </p><br><p>  First, we need a table in the database for storing data about books.  We can use <strong>migration</strong> to create it.  Let's use the generator to create an empty migration: </p><br><pre> <code class="hljs matlab"><span class="hljs-comment"><span class="hljs-comment">% bundle exec hanami generate migration create_books</span></span></code> </pre> <br><p>  This will give us a file with a name like <code>db/migrations/20161115110038_create_books.rb</code> , edit it: </p><br><pre> <code class="ruby hljs">Hanami::Model.migration <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> change <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> create_table <span class="hljs-symbol"><span class="hljs-symbol">:books</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> primary_key <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span> column <span class="hljs-symbol"><span class="hljs-symbol">:title</span></span>, String, <span class="hljs-symbol"><span class="hljs-symbol">null:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> column <span class="hljs-symbol"><span class="hljs-symbol">:author</span></span>, String, <span class="hljs-symbol"><span class="hljs-symbol">null:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> column <span class="hljs-symbol"><span class="hljs-symbol">:created_at</span></span>, DateTime, <span class="hljs-symbol"><span class="hljs-symbol">null:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> column <span class="hljs-symbol"><span class="hljs-symbol">:updated_at</span></span>, DateTime, <span class="hljs-symbol"><span class="hljs-symbol">null:</span></span> <span class="hljs-literal"><span class="hljs-literal">false</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre> <br><p>  Hanami provides a special language to describe changes to the database schema.  You can learn how to use it from <a href="http://hanamirb.org/guides/migrations/overview">the migration guide</a> . </p><br><p>  In this case, we define a new table with columns for each attribute of our entity. <br>  Let's prepare the database: </p><br><pre> <code class="hljs pgsql">% bundle exec hanami db <span class="hljs-keyword"><span class="hljs-keyword">prepare</span></span></code> </pre> <br><h2 id="vyrazhaem-nashi-dannye-v-vide-suschnostey">  We express our data in the form of Entities </h2><br><p>  We store books in our database and display them on the page.  For this, we need a way to read and write in the database.  Introducing entities and repositories: </p><br><ul><li>  <strong>An entity</strong> is an object from a subject area (of type <code>Book</code> ) that is uniquely identified by its identifier. </li><li>  <strong>The repository</strong> is located between the entities and the layer that ensures the continuity of their existence. </li></ul><br><p>  Entities are completely database independent.  This makes them <strong>light</strong> and <strong>easy to test</strong> . </p><br><p>  For this reason, we need a repository for storing data on which <code>Book</code> depends. <br>  Learn more about entities and repositories in <a href="http://hanamirb.org/guides/models/overview">the model manual</a> . </p><br><p>  Hanami provides a generator for the models, so let's create the <code>Book</code> entity and the corresponding repository: </p><br><pre> <code class="hljs pgsql">% bundle exec hanami generate model book <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> lib/bookshelf/entities/book.rb <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> lib/bookshelf/repositories/book_repository.rb <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> spec/bookshelf/entities/book_spec.rb <span class="hljs-keyword"><span class="hljs-keyword">create</span></span> spec/bookshelf/repositories/book_repository_spec.rb</code> </pre> <br><p>  The generator gives us the entity, the repository and the accompanying test files. </p><br><h3 id="rabotaem-s-suschnostyami">  We work with Entities </h3><br><p>  Entities are something inherently close to simple Ruby objects.  We need to focus on the behavior that we want from them and only later on how to save them. </p><br><p>  Right now we need a simple entity class: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># lib/bookshelf/entities/book.rb class Book &lt; Hanami::Entity end</span></span></code> </pre> <br><p>  This class will generate getters and setters for each attribute passed as a parameter during initialization.  We can verify this by writing a unit test: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/bookshelf/entities/book_spec.rb require 'spec_helper' describe Book do it 'can be initialised with attributes' do book = Book.new(title: 'Refactoring') book.title.must_equal 'Refactoring' end end</span></span></code> </pre> <br><h3 id="ispolzovanie-repozitoriev">  Using Repositories </h3><br><p>  Now we are ready to play with the repository.  Using the Hanami <code>console</code> command, we will launch IRb in the context of our application, which will allow us to use existing objects: </p><br><pre> <code class="hljs ruby">% bundle exec hanami console <span class="hljs-meta"><span class="hljs-meta">&gt;&gt; </span></span>repository = BookRepository.new =&gt; =&gt; #&lt;BookRepository:0x007f9ab61fbb40 ...&gt; &gt;&gt; repository.all =&gt; [] &gt;&gt; book = repository.create(<span class="hljs-symbol"><span class="hljs-symbol">title:</span></span> <span class="hljs-string"><span class="hljs-string">'TDD'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">author:</span></span> <span class="hljs-string"><span class="hljs-string">'Kent Beck'</span></span>) =&gt; #&lt;Book:0x007f9ab61c23b8 @attributes={:id=&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:title=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"TDD"</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:author=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"Kent Beck"</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:created_at=&gt;</span></span><span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span>-<span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">38</span></span> UTC, <span class="hljs-symbol"><span class="hljs-symbol">:updated_at=&gt;</span></span><span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span>-<span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">38</span></span> UTC}&gt; &gt;&gt; repository.find(book.id) =&gt; #&lt;Book:0x007f9ab6181610 @attributes={:id=&gt;<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:title=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"TDD"</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:author=&gt;</span><span class="hljs-string"><span class="hljs-symbol"><span class="hljs-string">"Kent Beck"</span></span></span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:created_at=&gt;</span></span><span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span>-<span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">38</span></span> UTC, <span class="hljs-symbol"><span class="hljs-symbol">:updated_at=&gt;</span></span><span class="hljs-number"><span class="hljs-number">2016</span></span>-<span class="hljs-number"><span class="hljs-number">11</span></span>-<span class="hljs-number"><span class="hljs-number">15</span></span> <span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">11</span></span><span class="hljs-symbol"><span class="hljs-symbol">:</span></span><span class="hljs-number"><span class="hljs-number">38</span></span> UTC}&gt;</code> </pre> <br><p>  Hanami repositories have methods for loading both one and several entities from the database;  as well as to create and update existing ones.  You can also define new methods in the repository for your own queries. </p><br><p>  In summary, we have seen how Hanami uses entities and repositories to model our data.  Entities reflect behavior, and repositories are used to link entities and a data warehouse.  We can use migrations to apply changes to the database schema. </p><br><h3 id="pokazyvaem-dinamicheskie-dannye">  Show dynamic data </h3><br><p>  With our new data modeling experience, we can make a book listing page show changing data.  Let's adapt the test written earlier for this: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/features/list_books_spec.rb require 'features_helper' describe 'List books' do let(:repository) { BookRepository.new } before do repository.clear repository.create(title: 'PoEAA', author: 'Martin Fowler') repository.create(title: 'TDD', author: 'Kent Beck') end it 'displays each book on the page' do visit '/books' within '#books' do assert page.has_css?('.book', count: 2), 'Expected to find 2 books' end end end</span></span></code> </pre> <br><p>  We created the required entries in the test and then stated that the number of classes of books on the page corresponds to them.  When we run the tests again, we will most likely see an error related to the database - remember that we have already migrated the <em>development</em> base, but have not yet migrated the <em>test</em> database. </p><br><pre> <code class="hljs bash">% HANAMI_ENV=<span class="hljs-built_in"><span class="hljs-built_in">test</span></span> bundle <span class="hljs-built_in"><span class="hljs-built_in">exec</span></span> hanami db prepare</code> </pre> <br><p>  Now we can change the template and remove static HTML.  Our views must go through all the available records and render them.  We write a test that requires such a change for the form: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/views/books/index_spec.rb require 'spec_helper' require_relative '../../../../apps/web/views/books/index' describe Web::Views::Books::Index do let(:exposures) { Hash[books: []] } let(:template) { Hanami::View::Template.new('apps/web/templates/books/index.html.erb') } let(:view) { Web::Views::Books::Index.new(template, exposures) } let(:rendered) { view.render } it 'exposes #books' do view.books.must_equal exposures.fetch(:books) end describe 'when there are no books' do it 'shows a placeholder message' do rendered.must_include('&lt;p class="placeholder"&gt;There are no books yet.&lt;/p&gt;') end end describe 'when there are books' do let(:book1) { Book.new(title: 'Refactoring', author: 'Martin Fowler') } let(:book2) { Book.new(title: 'Domain Driven Design', author: 'Eric Evans') } let(:exposures) { Hash[books: [book1, book2]] } it 'lists them all' do rendered.scan(/class="book"/).count.must_equal 2 rendered.must_include('Refactoring') rendered.must_include('Domain Driven Design') end it 'hides the placeholder message' do rendered.wont_include('&lt;p class="placeholder"&gt;There are no books yet.&lt;/p&gt;') end end end</span></span></code> </pre> <br><p>  We have indicated that the index page will show a message when there are no books and nothing to show;  when there are books, it will show their list.  Note that rendering a view with data is relatively straightforward.  Hanami is designed from simple objects with minimal interfaces, which makes it easy to test them separately, and they work well together. </p><br><p>  Let's rewrite our template to make it happen: </p><br><pre> <code class="hljs xml"># apps/web/templates/books/index.html.erb <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span>All books<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">if</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">books.any</span></span></span><span class="hljs-tag">? %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"books"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">books.each</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> |</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">book</span></span></span><span class="hljs-tag">| %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"book"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">book.title</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h2</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">book.author</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">else</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"placeholder"</span></span></span><span class="hljs-tag">&gt;</span></span>There are no books yet.<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">p</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre> <br><p>  If we run our functional test again, it will drop, since our controller action <br>  still not <a href="http://hanamirb.org/guides/actions/exposures"><em>expose the</em></a> books for our view.  We can write a test for this case: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/controllers/books/index_spec.rb require 'spec_helper' require_relative '../../../../apps/web/controllers/books/index' describe Web::Controllers::Books::Index do let(:action) { Web::Controllers::Books::Index.new } let(:params) { Hash[] } let(:repository) { BookRepository.new } before do repository.clear </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@book</span></span></span><span class="hljs-comment"> = repository.create(title: 'TDD', author: 'Kent Beck') end it 'is successful' do response = action.call(params) response[0].must_equal 200 end it 'exposes all books' do action.call(params) action.exposures[:books].must_equal [</span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@book</span></span></span><span class="hljs-comment">] end end</span></span></code> </pre> <br><p>  Writing tests for action games usually has two sides: you make a statement about the response object, which is a Rack-compatible array of status, headers, and content;  or about the fact that the data is visible from the action after we called it.  Now we have indicated that the action shows the variable variable <code>:books</code> , which we will do: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/controllers/books/index.rb module Web::Controllers::Books class Index include Web::Action expose :books def call(params) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@books</span></span></span><span class="hljs-comment"> = BookRepository.new.all end end end</span></span></code> </pre> <br><p>  Using the <code>expose</code> action class method, we can expose the contents of the <code>@books</code> instance <code>@books</code> , which makes it available on the view.  This is enough to pass the tests again! </p><br><pre> <code class="hljs mel">% bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake Run options: --<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">59133</span></span> # Running: ......... Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.042065</span></span>s, <span class="hljs-number"><span class="hljs-number">213.9543</span></span> runs/s, <span class="hljs-number"><span class="hljs-number">380.3633</span></span> assertions/s. <span class="hljs-number"><span class="hljs-number">6</span></span> runs, <span class="hljs-number"><span class="hljs-number">7</span></span> assertions, <span class="hljs-number"><span class="hljs-number">0</span></span> failures, <span class="hljs-number"><span class="hljs-number">0</span></span> errors, <span class="hljs-number"><span class="hljs-number">0</span></span> skips</code> </pre> <br><h2 id="stroenie-form-dlya-sozdaniya-zapisey">  The structure of the forms to create records </h2><br><p>  It remains only to create the ability to add new books to the system.  The plan is simple: we will make a page with a form where you can enter details. </p><br><p>    ,    ,          .    : </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/features/add_book_spec.rb require 'features_helper' describe 'Add a book' do after do BookRepository.new.clear end it 'can create a new book' do visit '/books/new' within 'form#book-form' do fill_in 'Title', with: 'New book' fill_in 'Author', with: 'Some author' click_button 'Create' end current_path.must_equal('/books') assert page.has_content?('New book') end end</span></span></code> </pre> <br><h3 id="zakladyvaem-osnovy-form">    </h3><br><p>   ,    ,   ,   . </p><br><p>    ,      .       <code>New Book</code> : </p><br><pre> <code class="hljs perl">% bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> hanami generate action web books<span class="hljs-comment"><span class="hljs-comment">#new</span></span></code> </pre> <br><p>      : </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/config/routes.rb get '/books/new', to: 'books#new'</span></span></code> </pre> <br><p>      ,        Hanami  ,   HTML    <code>Book</code> : </p><br><h3 id="ispolzovanie-helperov-form">    </h3><br><p>  <a href="http://hanamirb.org/guides/helpers/forms"> </a>    <code>apps/web/templates/books/new.html.erb</code> : </p><br><pre> <code class="hljs pgsql"># apps/web/templates/books/<span class="hljs-built_in"><span class="hljs-built_in">new</span></span>.html.erb &lt;h2&gt;<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span> book&lt;/h2&gt; &lt;%= form_for :book, <span class="hljs-string"><span class="hljs-string">'/books'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: <span class="hljs-string"><span class="hljs-string">'input'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> label :title text_field :title <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: <span class="hljs-string"><span class="hljs-string">'input'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> label :author text_field :author <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> div <span class="hljs-keyword"><span class="hljs-keyword">class</span></span>: <span class="hljs-string"><span class="hljs-string">'controls'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> submit <span class="hljs-string"><span class="hljs-string">'Create Book'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> %&gt;</code> </pre> <br><p>    <code>&lt;label&gt;</code>    ,      <br>  <code>&lt;div&gt;</code> c Hanami <a href="http://hanamirb.org/guides/helpers/html5"> HTML</a> . </p><br><h3 id="otpravka-nashih-form">    </h3><br><p>   ,     .    <code>Books::Create</code> : </p><br><pre> <code class="hljs pgsql">% bundle exec hanami generate action web books#<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-comment"><span class="hljs-comment">--method=post</span></span></code> </pre> <br><p>      : </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/config/routes.rb post '/books', to: 'books#create'</span></span></code> </pre> <br><h3 id="voploschaem-ekshn-create">   Create </h3><br><p>   <code>books#create</code>    .    -: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/controllers/books/create_spec.rb require 'spec_helper' require_relative '../../../../apps/web/controllers/books/create' describe Web::Controllers::Books::Create do let(:action) { Web::Controllers::Books::Create.new } let(:params) { Hash[book: { title: 'Confident Ruby', author: 'Avdi Grimm' }] } before do BookRepository.new.clear end it 'creates a new book' do action.call(params) action.book.id.wont_be_nil action.book.title.must_equal params[:book][:title] end it 'redirects the user to the books listing' do response = action.call(params) response[0].must_equal 302 response[1]['Location'].must_equal '/books' end end</span></span></code> </pre> <br><p> ,     .   ,        ,     <code>redirect_to</code>   : </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/controllers/books/create.rb module Web::Controllers::Books class Create include Web::Action expose :book def call(params) </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@book</span></span></span><span class="hljs-comment"> = BookRepository.new.create(params[:book]) redirect_to '/books' end end end</span></span></code> </pre> <br><p>       ,      . </p><br><pre> <code class="hljs mel">% bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake Run options: --<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">63592</span></span> # Running: ............... Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.081961</span></span>s, <span class="hljs-number"><span class="hljs-number">183.0142</span></span> runs/s, <span class="hljs-number"><span class="hljs-number">305.0236</span></span> assertions/s. <span class="hljs-number"><span class="hljs-number">12</span></span> runs, <span class="hljs-number"><span class="hljs-number">14</span></span> assertions, <span class="hljs-number"><span class="hljs-number">0</span></span> failures, <span class="hljs-number"><span class="hljs-number">0</span></span> errors, <span class="hljs-number"><span class="hljs-number">2</span></span> skips</code> </pre> <br><p>    ! </p><br><h3 id="zaschitim-formy-validaciyami">    </h3><br><p>  !   ,       . ,  ,  -     ? </p><br><p>              .           ! </p><br><p>     ,   :   <em></em>   ?     <code>bookshelf#new</code> ,          .     -: </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/controllers/books/create_spec.rb require 'spec_helper' require_relative '../../../../apps/web/controllers/books/create' describe Web::Controllers::Books::Create do let(:action) { Web::Controllers::Books::Create.new } after do BookRepository.new.clear end describe 'with valid params' do let(:params) { Hash[book: { title: '1984', author: 'George Orwell' }] } it 'creates a new book' do action.call(params) action.book.id.wont_be_nil end it 'redirects the user to the books listing' do response = action.call(params) response[0].must_equal 302 response[1]['Location'].must_equal '/books' end end describe 'with invalid params' do let(:params) { Hash[book: {}] } it 're-renders the books#new view' do response = action.call(params) response[0].must_equal 422 end it 'sets errors attribute accordingly' do response = action.call(params) response[0].must_equal 422 action.params.errors[:book][:title].must_equal ['is missing'] action.params.errors[:book][:author].must_equal ['is missing'] end end end</span></span></code> </pre> <br><p>       :       ,    .   ,  . </p><br><p> , ,        , Hanami           ,     .  Hanami     <code>params</code>     . </p><br><p>    :     ( ,       ) <em></em>  ,    ‚Äî   ,  ,   ,        . </p><br><p>   ,    ,      ,     </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/controllers/books/create.rb module Web::Controllers::Books class Create include Web::Action expose :book params do required(:book).schema do required(:title).filled(:str?) required(:author).filled(:str?) end end def call(params) if params.valid? </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@book</span></span></span><span class="hljs-comment"> = BookRepository.new.create(params[:book]) redirect_to '/books' else self.status = 422 end end end end</span></span></code> </pre> <br><p>   ,         URL.    ,   ? </p><br><p>    HTTP   <br> <a href="https://ru.wikipedia.org/wiki/List_of_HTTP_status_codes">422 ( )</a> . <br>     ,   ,   .    <code>apps/web/templates/books/new.html.erb</code>      . </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/views/books/create.rb module Web::Views::Books class Create include Web::View template 'books/new' end end</span></span></code> </pre> <br><p>   ,     Hanami  ,   <code>params</code>        ,   .        ,     ,   ,      . </p><br><p>         . </p><br><h3 id="pokazyvaem-oshibki-validacii">    </h3><br><p>         ,  -   ,    ,     .          . </p><br><p>  ,         ,  <code>params</code>  : </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/views/books/new_spec.rb require 'spec_helper' require_relative '../../../../apps/web/views/books/new' class NewBookParams &lt; Hanami::Action::Params params do required(:book).schema do required(:title).filled(:str?) required(:author).filled(:str?) end end end describe Web::Views::Books::New do let(:params) { NewBookParams.new(book: {}) } let(:exposures) { Hash[params: params] } let(:template) { Hanami::View::Template.new('apps/web/templates/books/new.html.erb') } let(:view) { Web::Views::Books::New.new(template, exposures) } let(:rendered) { view.render } it 'displays list of errors when params contains errors' do params.valid? # trigger validations rendered.must_include('There was a problem with your submission') rendered.must_include('Title is missing') rendered.must_include('Author is missing') end end</span></span></code> </pre> <br><p>            : </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># spec/web/features/add_book_spec.rb require 'features_helper' describe 'Add a book' do # Spec written earlier omitted for brevity it 'displays list of errors when params contains errors' do visit '/books/new' within 'form#book-form' do click_button 'Create' end current_path.must_equal('/books') assert page.has_content?('There was a problem with your submission') assert page.has_content?('Title must be filled') assert page.has_content?('Author must be filled') end end</span></span></code> </pre> <br><p>       <code>params.errors</code> (  )    . <br>  <code>apps/web/templates/books/new.html.erb</code> : </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">unless</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">params.valid</span></span></span><span class="hljs-tag">? %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"errors"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span>There was a problem with your submission<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">h3</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">params.error_messages.each</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">do</span></span></span><span class="hljs-tag"> |</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag">| %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">message</span></span></span><span class="hljs-tag"> %&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">li</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">end</span></span></span><span class="hljs-tag"> %&gt;</span></span></code> </pre> <br><p>  ,       "is required",           ,    .      . </p><br><pre> <code class="hljs mel">% bundle <span class="hljs-keyword"><span class="hljs-keyword">exec</span></span> rake Run options: --<span class="hljs-keyword"><span class="hljs-keyword">seed</span></span> <span class="hljs-number"><span class="hljs-number">59940</span></span> # Running: .................. Finished <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> <span class="hljs-number"><span class="hljs-number">0.078112</span></span>s, <span class="hljs-number"><span class="hljs-number">230.4372</span></span> runs/s, <span class="hljs-number"><span class="hljs-number">473.6765</span></span> assertions/s. <span class="hljs-number"><span class="hljs-number">15</span></span> runs, <span class="hljs-number"><span class="hljs-number">27</span></span> assertions, <span class="hljs-number"><span class="hljs-number">0</span></span> failures, <span class="hljs-number"><span class="hljs-number">0</span></span> errors, <span class="hljs-number"><span class="hljs-number">1</span></span> skips</code> </pre> <br><h3 id="ispolzuem-router-bolee-osmyslenno">     </h3><br><p>     ,     .     "web": </p><br><pre> <code class="ruby hljs"><span class="hljs-comment"><span class="hljs-comment"># apps/web/config/routes.rb post '/books', to: 'books#create' get '/books/new', to: 'books#new' get '/books', to: 'books#index' root to: 'home#index'</span></span></code> </pre> <br><p> Hanami         REST- ,       : </p><br><pre> <code class="ruby hljs">resources <span class="hljs-symbol"><span class="hljs-symbol">:books</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">only:</span></span> [<span class="hljs-symbol"><span class="hljs-symbol">:index</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:new</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:create</span></span>] root <span class="hljs-symbol"><span class="hljs-symbol">to:</span></span> <span class="hljs-string"><span class="hljs-string">'home#index'</span></span></code> </pre> <br><p>  ,   ,  ,    ,  <br>     <code>routes</code>   : </p><br><pre> <code class="hljs php">% bundle exec hanami routes Name Method Path Action books GET, HEAD /books Web::Controllers::Books::Index new_book GET, HEAD /books/<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Web::Controllers::Books::New books POST /books Web::Controllers::Books::Create root GET, HEAD / Web::Controllers::Home::Index</code> </pre> <br><p>   <code>hanami routes</code>       (     <code>_path</code>  <code>_url</code>     <code>routes</code> ),  HTTP    ,    . </p><br><p> ,     <code>resources</code> ,      . ,      <code>form_for</code> ? </p><br><pre> <code class="hljs mel">&lt;%= form_for :book, <span class="hljs-string"><span class="hljs-string">'/books'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... end %&gt;</code> </pre> <br><p>       , ,     ,      .      <code>routes</code> ,        ,      : </p><br><pre> <code class="hljs mel">&lt;%= form_for :book, routes.books_path <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> # ... end %&gt;</code> </pre> <br><p>        <code>apps/web/controllers/books/create.rb</code> : </p><br><pre> <code class="ruby hljs">redirect_to routes.books_path</code> </pre> <br><h2 id="rezyumiruem">  We summarize </h2><br><p> <strong>     Hanami !</strong> </p><br><p> ,    :        Hanami,  ,      ;         ;      ,         . </p><br><p>    ,      .  <a href="http://hanamirb.org/guides/"> </a> , the <a href="http://www.rubydoc.info/gems/hanami"> Hanami API</a> ,  <a href="https://github.com/hanami"> </a>    <a href="http://hanamirb.org/blog"></a> . </p><br><p> PS       <a href="">Translation Gang</a> ,     ,        <a href="https://github.com/GeorgeGorbanev">GeorgeGorbanev</a> ,     . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/336814/">https://habr.com/ru/post/336814/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../336798/index.html">Kotlin: combat use experience</a></li>
<li><a href="../336800/index.html">Education from Mail.Ru Group: telling live on Tehnostrim about training opportunities</a></li>
<li><a href="../336804/index.html">Gazer: backdoor of the second stage of the ART group Turla</a></li>
<li><a href="../336810/index.html">How to earn on ICO? And how to do it is not necessary</a></li>
<li><a href="../336812/index.html">Lazy Loading in Entity Framework</a></li>
<li><a href="../336816/index.html">Spring MVC - the basic principles</a></li>
<li><a href="../336818/index.html">XBRL: just about the complex - Chapter 6. Immersion in XBRL - Part 6. Multidimensionality</a></li>
<li><a href="../336822/index.html">Factory Testing: The Black Box and Short Testing Cycle</a></li>
<li><a href="../336824/index.html">How to step over legacy and start using static code analysis</a></li>
<li><a href="../336826/index.html">Chinese Application Localization Guide, Part 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>