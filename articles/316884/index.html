<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitoring GPU on Windows servers (TICK + Grafana + crutches)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I had several servers at my disposal, based on Windows, which capture, encode and archive video. A key feature of this system is that coding is based ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitoring GPU on Windows servers (TICK + Grafana + crutches)</h1><div class="post__text post__text-html js-mediator-article">  I had several servers at my disposal, based on Windows, which capture, encode and archive video.  A key feature of this system is that coding is based on Intel Quick Sync Video, i.e.  based on GPU. <br><br>  In this situation, monitoring just the CPU is no longer the main indicator of the server status, and for a complete picture you need to track the load on both the CPU and the GPU.  The servers operate in real time mode, so you have to deal with streams, not files, which means that if the GPU exceeds the maximum load, video losses are possible (in the case of files, encoding will continue, at a speed less than real time), so look out for the video card necessary. <br><br>  The end result, the following props and crutches, are graphs built in Grafana: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/files/bd4/85e/3a3/bd485e3a3f0444a3b3cb49c39e266c55.png"><br><a name="habracut"></a><br>  This article discusses <a href="https://www.influxdata.com/time-series-platform/telegraf/">TICK-</a> based monitoring (telegraf, influxdb, chronograf, kapacitor) + <a href="https://grafana.net/">Grafana</a> , so all settings and script output are adapted specifically for this technology stack, but with some doping, everything below can be transferred to other monitoring systems.  Another nuance - this implementation is made for Windows. <br><br>  If everything is clear with Nvidia video cards, when immediately after installing the driver, both the console utility nvidia-smi and the subsection Nvidia GPU in the standard Performance Monitor appear on the computer, then in the case of tracking the Intel GPU, everything is not so obvious.  All utilities that I came across are oriented to work in the GUI, so the first crutch appears in this place - the utility will be monitored by the GUI. <br><br>  At the moment, one of the leaders among such programs is the <a href="https://www.techpowerup.com/gpuz/">GPU-Z</a> utility, the presence of logging is also important. <br><br>  Setting up logging in GPU-Z (tick below): <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/0db/1ca/d05/0db1cad05b63b1b462d35d45f6e799fd.png" alt="image"></div><br>  At this stage, the first difficulty appears - GPU-Z writes its log in CSV format, with a minimum frequency of 10 seconds, which affects the volume of the log file, so if you read the file line by line or entirely periodically, then because of the infinite growth, with him quite laborious. <br><br>  The second crutch is to configure the rotation of the GPU-Z utility logs.  The log for one day turns out to be small, and it can be quickly processed by the script, so the purpose of the rotation is small files that store information per day.  GPU-Z always runs with administrator rights, when it starts automatically, it requires a circumvention of the Windows UAC protection built into it, therefore, to automate the launch of the rotation script, the Windows Scheduler is used, with the setting set to: Run with the highest privileges. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/1de/04b/ef3/1de04bef3cfa4e108293f19c99858ab3.png"></div><br><div style="text-align:center;"><img src="https://habrastorage.org/files/5d1/ebe/176/5d1ebe176a0c4065a88a73c9f6f6e708.png"></div><br>  Windows Scheduler runs a script that executes a sequence of actions: <br><br>  1) complete the program GPU-Z <br>  2) move the log to the archive <br>  3) run the utility minimized to tray <br><br>  The script is written in PowerShell, and looks like this: <br><br><pre><code class="hljs smalltalk"><span class="hljs-string"><span class="hljs-string">$g</span></span>puz = <span class="hljs-comment"><span class="hljs-comment">"GPU-Z.1.12.0"</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>puzlog = <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\GPU-Z\log\gpu-z.txt"</span></span> <span class="hljs-type"><span class="hljs-type">Stop</span></span>-<span class="hljs-type"><span class="hljs-type">Process</span></span> -<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>puz -<span class="hljs-type"><span class="hljs-type">Force</span></span> <span class="hljs-string"><span class="hljs-string">$l</span></span>ogname = <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>puzlog).<span class="hljs-type"><span class="hljs-type">Name</span></span> <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogname = (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Date</span></span>).<span class="hljs-type"><span class="hljs-type">AddDays</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>).<span class="hljs-type"><span class="hljs-type">ToString</span></span>(<span class="hljs-string"><span class="hljs-string">'yyyy-MM-dd'</span></span>) + <span class="hljs-comment"><span class="hljs-comment">"_"</span></span> + <span class="hljs-string"><span class="hljs-string">$l</span></span>ogname <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogdir = <span class="hljs-string"><span class="hljs-string">$(</span></span><span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">ChildItem</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>puzlog).<span class="hljs-type"><span class="hljs-type">DirectoryName</span></span> + <span class="hljs-comment"><span class="hljs-comment">"\"</span></span> + (<span class="hljs-type"><span class="hljs-type">Get</span></span>-<span class="hljs-type"><span class="hljs-type">Date</span></span>).<span class="hljs-type"><span class="hljs-type">AddDays</span></span>(<span class="hljs-number"><span class="hljs-number">-1</span></span>).<span class="hljs-type"><span class="hljs-type">ToString</span></span>(<span class="hljs-string"><span class="hljs-string">'yyyy_MM'</span></span>) <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogfile = <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogdir + <span class="hljs-comment"><span class="hljs-comment">"\"</span></span> + <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogname <span class="hljs-type"><span class="hljs-type">New</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> -<span class="hljs-type"><span class="hljs-type">ItemType</span></span> directory <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogdir -<span class="hljs-type"><span class="hljs-type">Force</span></span> <span class="hljs-type"><span class="hljs-type">Move</span></span>-<span class="hljs-type"><span class="hljs-type">Item</span></span> <span class="hljs-string"><span class="hljs-string">$g</span></span>puzlog <span class="hljs-string"><span class="hljs-string">$a</span></span>rchivelogfile -<span class="hljs-type"><span class="hljs-type">Force</span></span> &amp; <span class="hljs-comment"><span class="hljs-comment">"C:\Program Files\GPU-Z\$gpuz.exe"</span></span> -minimized</code> </pre> <br>  It turned out that during operation, the GPU-Z does not finish the log, i.e.  it can be considered the same PowerShell, but the telegraf log parser does not see updates.  In addition, the GPU-Z utility writes the log too often (once every 10 seconds) in my case, collecting the readings once a minute is enough.  A third crutch appears at this point - a small parser was written to transfer data to telegraf, which selects the last line from the GPU-Z log and sends the data to telegraf in graphite format. <br><br>  ‚Üí <a href="">github.com/influxdata/telegraf/blob/master/docs/DATA_FORMATS_INPUT.md</a> <br><br>  This format was chosen for the reason that the standard for telegraf format influx does not support the substitution of timestamp, I also want to see an honest timestamp from the log, and not generated at the time of reading the line.  In the following script, this is taken into account, and the timestamp from the log is converted to unix time, in accordance with the graphite format. <br><br>  Script again on PowerShell: <br><br><pre> <code class="hljs mel">$gpuzlog = <span class="hljs-string"><span class="hljs-string">"C:\Program Files\GPU-Z\log\gpu-z.txt"</span></span> $loglaststring = Get-Content $gpuzlog | Select-Object -Last <span class="hljs-number"><span class="hljs-number">1</span></span> $timestamp = $loglaststring.Split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] $unixtimestamp = [int64]((Get-Date <span class="hljs-string"><span class="hljs-string">"$timestamp"</span></span>).ToUniversalTime()-(Get-Date <span class="hljs-string"><span class="hljs-string">"1/1/1970"</span></span>)).TotalSeconds #GPU Temperature [¬∞C] , GPU Load [%] , Memory Usage $gputemperature = (($loglaststring.Split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">1</span></span>]).Replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>)).Split(<span class="hljs-string"><span class="hljs-string">"."</span></span>)[<span class="hljs-number"><span class="hljs-number">0</span></span>] $gpuload = ($loglaststring.Split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">2</span></span>]).Replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) $gpumemoryusage = ($loglaststring.Split(<span class="hljs-string"><span class="hljs-string">","</span></span>)[<span class="hljs-number"><span class="hljs-number">3</span></span>]).Replace(<span class="hljs-string"><span class="hljs-string">" "</span></span>, <span class="hljs-string"><span class="hljs-string">""</span></span>) Write-Host GPUZ.psscript.GPUTemperature $gputemperature $unixtimestamp Write-Host GPUZ.psscript.GPULoad $gpuload $unixtimestamp Write-Host GPUZ.psscript.GPUMemoryUsage $gpumemoryusage $unixtimestamp</code> </pre> <br>  This script is launched by telegraf itself, once a minute, according to the following rule: <br><br><pre> <code class="hljs lua"><span class="hljs-string"><span class="hljs-string">[[inputs.exec]]</span></span> commands = [ <span class="hljs-string"><span class="hljs-string">"powershell.exe C:/PSScripts/gpu-z.ps1"</span></span> ] separator = <span class="hljs-string"><span class="hljs-string">"."</span></span> templates = [ <span class="hljs-string"><span class="hljs-string">"Utility.measurement.field*"</span></span> ] interval = <span class="hljs-string"><span class="hljs-string">"1m"</span></span> timeout = <span class="hljs-string"><span class="hljs-string">"10s"</span></span> name_suffix = <span class="hljs-string"><span class="hljs-string">"_gpuz"</span></span> data_format = <span class="hljs-string"><span class="hljs-string">"graphite"</span></span></code> </pre> <br>  As a result, the TICK system collects data reflecting the state of the GPU, on the basis of which you can either set up monitoring or, as in this case, make graphs, for analyzing work and analytics. </div><p>Source: <a href="https://habr.com/ru/post/316884/">https://habr.com/ru/post/316884/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../316866/index.html">Discuss? Gartner: Virtualization Market Reaches Saturation</a></li>
<li><a href="../316868/index.html">Telegram-bot: my story. Part one</a></li>
<li><a href="../316872/index.html">Testing 15+ virtual hosting for Wordpress or how not to disappear from the Yandex index</a></li>
<li><a href="../316874/index.html">We cover the project with smoke tests until it burns out</a></li>
<li><a href="../316880/index.html">Electron: from motivation to publication</a></li>
<li><a href="../316886/index.html">PIN cards of bank cards. How modern technology replaces paper mail</a></li>
<li><a href="../316888/index.html">What is more profitable to open to the developer: IP or LLC? Small Check Sheet</a></li>
<li><a href="../316890/index.html">Domain-Driven Design: tactical design. Part 2</a></li>
<li><a href="../316894/index.html">5 best books novice entrepreneur + 1 advice</a></li>
<li><a href="../316898/index.html">Monitoring driven operation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>