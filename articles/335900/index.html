<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mountebank: flexible mocking web API</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When it comes to the development of modern IT systems, the issue of mocking external dependencies is always somewhere nearby. An external service may ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mountebank: flexible mocking web API</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/b34/1d3/4dc/b341d34dc6b4ce3b72eb8084031cd293.png" alt="image" align="left">  When it comes to the development of modern IT systems, the issue of mocking external dependencies is always somewhere nearby.  An external service may not be available at the development stage, or its functionality is developed in parallel and cannot be relied upon.  This question is particularly acute at the stage of writing autotests, because you need to check not only the regular behavior of your system, but also exceptional cases: the inaccessibility of the external service, cases when the external service responds with an error, and so on. <br><br>  Even if you are lucky and your product has a minimum of dependencies on external services, most likely inside it is divided into components (classics of the genre - backend / frontend), which can and should be tested separately.  This means that the external dependency is already the api of a neighboring component, whose development team is not at all eager to provide you with tools for managing its state. <br><br>  According to my observations, testing teams prefer to limit themselves to the most basic autotest cases, explaining this as the impossibility of redefining the behavior of the external system. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Mocking the external system API can solve this problem. <br><br>  Usually in this place testers begin to be sad, because  the previous sentence means that besides the autotests themselves they need to write a service duplicating the external system in terms of functionality, and in addition to this, it is necessary to somehow manage its state so that it can respond to the same requests differently depending on the test case study <br><br>  In this article I will describe <a href="http://www.mbtest.org/">Mountebank</a> : a tool that allows you to quickly and very flexibly mock the API directly from autotests without having to write your web service. <br><br>  Mountebank features: <br><br><ul><li>  API mocking on tcp, http, https, smtp protocols; </li><li>  mocking an unlimited number of API at the same time; </li><li>  flexible redefinition of mock-API logic directly during the tests using the mountebank configuration API; </li><li>  proxying requests to the external service API, saving responses and the possibility of their subsequent use in the mock-API; </li><li>  client libraries for most programming languages ‚Äã‚Äã(JS, Python, Ruby, Java, and many others). </li></ul><br><h2>  Concept </h2><br>  The idea behind mountebank is simple and ingenious: it‚Äôs not necessary to write one universal mock-API for all test cases at once, it is more efficient to override the behavior of the mock-API before each test exactly to the extent required by a specific test case. <br><br>  Mountebank is a web service that runs on your test site and that has its own web API.  Let's call this API configuration.  The configuration API is used to tell mountebank what logic you want to put in your mock-API.  After that, mountebank raises imposter - a web service that implements your mock-API.  In this case, mountebank does not limit you in how often you will override the behavior of the imposter. <br><br>  This means that you can redefine it literally before each test and describe exactly the logic that is needed by a specific test.  And nothing more! <br><br><h2>  Installation and first mocked method </h2><br>  You should start with mountebank with installation.  Since this is a node.js application, it is most logical to do this via npm (a pre-installed <a href="https://nodejs.org/en/">node.js</a> is required): <br><br><pre><code class="hljs coffeescript">&gt;<span class="hljs-built_in"><span class="hljs-built_in">npm</span></span> install -g mountebank</code> </pre> <br>  If you don‚Äôt want to install node.js separately, there are <a href="http://www.mbtest.org/docs/install">alternative ways for different platforms</a> . <br>  Next, run mountebank from the console: <br><br><pre> <code class="hljs">&gt;mb</code> </pre> <br>  By default, mountebank takes port 2525 and if everything is good, then we see the greeting: <br><br><img src="https://habrastorage.org/web/675/89a/a75/67589aa75c754497947ddc5d1a5f3b44.jpg" alt="image"><br><br>  It is on localhost: 2525 that the mountebank‚Äôs configuration API now hangs. <br><br>  For training, we will create a simple imposter, which would implement the POST / test method and if there is JSON with the object in the request body <br><br><pre> <code class="hljs dos">{ ‚Äúmessage‚Äù: ‚Äú<span class="hljs-built_in"><span class="hljs-built_in">ping</span></span>‚Äù }</code> </pre> <br>  JSON should be sent back: <br><br><pre> <code class="hljs cmake">{ ‚Äú<span class="hljs-keyword"><span class="hljs-keyword">message</span></span>‚Äù: ‚Äúpong‚Äù }</code> </pre> <br>  In all other cases, we want 400 status (Bad Request) to be returned. <br><br>  We will communicate with mountebank'om and with imposter'ami through <a href="https://www.getpostman.com/">Postman</a> . <br><br>  To create our imposter, we send the following request to the mountebank configuration API: <br><br><img src="https://habrastorage.org/web/789/65e/a99/78965ea99119466d9ee649c02524b893.PNG"><br><br>  A few words about what the request to create an imposter consists of. <br><br>  First, we specify the protocol by which the imposter will work and the port that it will listen to.  This will be the port on which our mock-API will rise.  Next comes the stubs array: rules for the imposter how to respond to a particular incoming request. <br><br>  Each rule consists of predicates and responses: <br><br><ul><li>  predicates describes the parameters that the incoming request must match for the imposter to react to it </li><li>  Responses describes the response that will be sent by the imposter if the incoming request matches the predicates. </li></ul><br>  Every time a request comes in for an imposter, he goes over his own rules for matching the request.  If the request satisfies the predicate of the rule, an appropriate response is formed to it and the further bypass of the rules ends. <br><br>  Now that we know how the imposter works, it's time to check it out. <br><br>  We send the imposter a request that matches the first rule: <br><br><img src="https://habrastorage.org/web/ac2/d5d/f4f/ac2d5df4f1e14ca0a2472a18b889b8fb.PNG"><br><br>  And we get the answer: <br><br><img src="https://habrastorage.org/web/0fa/490/341/0fa4903415c94149ba32390b26d7468d.PNG"><br><br>  Now we will try to send a request not complying with the first rule, which means falling under the second: <br><br><img src="https://habrastorage.org/web/e25/5a7/ed0/e255a7ed0d7d4c87ada32ea48e9c4a73.PNG"><br><br>  In response, as expected, we get 400 Bad Request: <br><br><img src="https://habrastorage.org/web/a36/ac8/e20/a36ac8e20fbf456ba834cb24ad1b9541.PNG"><br><br>  Everything is working! <br><br>  Each imposter can contain an unlimited number of rules, which means that it is possible to lay a rather complex logic of behavior on various requests. <br><br>  At the same time, mountebank, can hold multiple imposhers at different ports and protocols simultaneously, this makes it possible to mock several external APIs at once. <br><br><h2>  Application in autotests </h2><br>  Now that the mechanics of mountebank have become more or less understandable, we will try to apply it where the concept embodied in it will be fully revealed: autotests. <br><br>  Imagine that we are testing a bank site, the function of displaying ATMs on a map.  To implement this function, front sends a request to the server to get the coordinates of the ATMs and, having received the answer, displays them on the map. <br><br>  The test of this function involves two scenarios: <br><br><ul><li>  front received a list of ATMs with valid coordinates: we expect that all of them are correctly displayed on the map; </li><li>  front received a list of ATMs, but some coordinates are invalid: we expect that front displayed only ATMs with valid coordinates. </li></ul><br>  In both cases, the test page sends the same request to the backend: GET / api / points. <br><br>  Without mocking the backend API, it is impossible to check both cases at all: the backend in both cases will return the same set of points not satisfying any of the cases. <br>  Even if we write our service, which will give a certain set of data, this will allow us to check in automatic mode only one of the cases. <br><br>  And now let's see how these test cases can be automated using mountebank. <br>  For the demonstration, I will use the python + <a href="https://docs.pytest.org/en/latest/">pytest bundle</a> (a test framework with a powerful fixture subsystem). <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> pytest <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> requests <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> json <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> page_objects <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> MapPage <span class="hljs-comment"><span class="hljs-comment">#     valid_points = { "point_1": (55.999653, 37.206002), "point_2": (55.996767, 37.184545), "point_3": (55.984932, 37.208749), } #       invalid_points = { "point_1": (255.999653, 37.206002), "point_2": (55.996767, 237.184545), "point_3": (55.984932, 37.208749), } #   @pytest.fixture( scope='module', params=[valid_points, invalid_points], ids=['Valid points case', 'Invalid points case'] ) def fxtr_map(request): points = request.param #   imposter'a imposter_cfg = { "port": 1987, "protocol": "http", "stubs": [ { "predicates": [ { "equals": { "method": "GET", "path": "/api/points" } } ], "responses": [ { "is": { "statusCode": 200, "headers": {"Content-Type": "application/json"}, "body": points } } ] } ] } #   mountebank    imposter'a requests.request('POST', 'http://localhost:2525/imposters', data=json.dumps(imposter_cfg), headers={"content-type": "application/json"}) #      ( ) browser = webdriver.Chrome() browser.implicitly_wait(10) browser.get(MAP_PAGE_URL) map_page = MapPage(browser) #        points_to_check = {k: points[k] for k in points if points[k] == valid_points[k]} #       #     yield map_page, points_to_check browser.close() # ,   def test_points_on_map(fxtr_map): map_page, points_to_check = fxtr_map #           assert map_page.check_points(points_to_check)</span></span></code> </pre><br>  We start. <br><br><img src="https://habrastorage.org/web/859/7bf/9d0/8597bf9d03a247caa3f939b97933c753.png"><br><br>  Voila! <br><br>  Thanks to mountebank, we have directly configured the mock-API from the fixture so that it gives a certain set of points, pulled a test page that turned to the mockable method and got the points we set.  Well, in the test function, we just checked that only valid points were displayed on the user's screen.  Due to the possibility of pytest to parameterize the fixture, we did not even have to write two tests: both test cases are covered by one fixture and one test. <br><br>  In the above example, the configuration of the mock-API took place directly through the mountebank web API.  In real projects, I recommend working with mountebank at a higher level of abstraction, for which a lot of client libraries are written.  For only one python, there are already three of them, I am sure, <a href="http://www.mbtest.org/docs/clientLibraries">there will be for your favorite language</a> . <br><br>  In this article, I showed only a small part of mountebank's capabilities.  In addition to other basic requests for working with imposters, such powerful things as proxying requests to the external systems API, mocking at the <i>tcp</i> protocol level, js-injection also remained unrevealed. <br><br>  So, if you are interested in this tool - welcome to the <a href="http://www.mbtest.org/">documentation</a> , which, by the way, is written in a very ingenious language, match the name of the tool (mountebank - (from English) cheater). </div><p>Source: <a href="https://habr.com/ru/post/335900/">https://habr.com/ru/post/335900/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../335886/index.html">Built-in buttons in Telegram Bot API</a></li>
<li><a href="../335890/index.html">‚ÄúTo each according to a quantum‚Äù: Will quantum computing become a commercial product?</a></li>
<li><a href="../335892/index.html">Show your passport. Part 1</a></li>
<li><a href="../335896/index.html">Avito Office: work hard, play hard</a></li>
<li><a href="../335898/index.html">Linux History (1993‚Äì2003): Testing Distributions</a></li>
<li><a href="../335902/index.html">Virtualization operation: comparison of virtual server and shared-hosting</a></li>
<li><a href="../335904/index.html">A bit of the history of cryptography CCPP: M-105, codenamed Agat</a></li>
<li><a href="../335906/index.html">Available on cryptography on elliptic curves</a></li>
<li><a href="../335908/index.html">Using MVP + TDD in the development of iOS applications</a></li>
<li><a href="../335910/index.html">Own bike for JSON API</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>