<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Pangurman Recipes</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Recently launched a service for booking restaurants Pangurman . Inside is a more or less typical django site. I will try to tell how everything is arr...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Pangurman Recipes</h1><div class="post__text post__text-html js-mediator-article">  Recently launched a service for booking restaurants <a href="http://pangurman.ru/">Pangurman</a> .  Inside is a more or less typical django site.  I will try to tell how everything is arranged there (with pictures).  The article will not be anything super-clever, but I hope someone‚Äôs a couple of tricks or ideas will seem useful and somehow simplify life. <br><a name="habracut"></a><br>  Standard toolkit - PostgreSQL, Django 1.4 (+ GeoDjango), Sentry, Celery (+ redis), Fabric. <br><br><h4>  start page </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/69b/370/85e/69b37085e4f0cc06cffb3796890e47c5.jpg" alt="image"><br><br>  There is nothing unusual on the start page: registration form.  As I already <a href="http://habrahabr.ru/post/141218/">wrote</a> , the self-view forms are self-made, django-registration sawed out with indignation after I realized that I didn‚Äôt use any views or forms from there, I tried to use the model and the bug tracker of the project was disabled :) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When registering, a greeting letter is sent, it is written as html.  To send html letters, we use <a href="https://github.com/philippWassibauer/templated-emails">templated-emails</a> : in templates there is an emails folder in which all letters are stored.  Each letter is in its own folder containing 3 files: email.html (html version of the letter), email.txt (text version of the letter) and short.txt (subject). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/16b/095/dde/16b095dde6d715557c2acd858646b29b.png" alt="image"><br><br>  Letters are sent like this: <br><pre><code class="python hljs">send_templated_email([user], <span class="hljs-string"><span class="hljs-string">'emails/activation'</span></span>, context=context)</code> </pre> <br>  You can send User-s or email addresses to the mailing list.  Nonsense, but simple and convenient, on different projects we have been using this approach for quite some time. <br><br>  There is another problem with html-letters - it is not very clear how to look at them when developing without sending them to myself all the time.  To check locally, we use <a href="https://github.com/kmike/django-eml-email-backend">django-eml-email-backend</a> (the dumbest application with email backend, which saves emails to eml-files instead of sending).  Most email clients open eml files without problems (there is a preview on a poppy even with a space). <br><br><h4>  Ok </h4><br>  After registering and setting up an account, a person goes to the main page. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e2b/ce0/d11/e2bce0d112909a01010cf3b85042ac53.jpg" alt="image"><br><br>  On it you can pay attention to the search form. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c85/d00/714/c85d00714c61293f88bf2c6355846143.png" alt="image"><br><br>  Elements were originally put together like this: <br><br><pre> <code class="html hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"b-filter_selector time"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"persons"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">data-behavior</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Chosen"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1"</span></span></span><span class="hljs-tag">&gt;</span></span>1 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"2"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">selected</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"selected&gt;2 &lt;/option&gt; &lt;option value="</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">3</span></span></span><span class="hljs-tag">"&gt;</span></span>3 <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">option</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">select</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  The guys try to stick with BEM, the input is often wrapped in a div and they often need to add some css-classes, data-attributes and so on. <br><br>  To sew up html in the code - bad form, html should be in templates.  There is no normal built-in tool to influence the rendering of form elements in a template in jang (and here we need to add data-behavior to the field).  Because of these pieces, we are very actively using django-widget-tweaks ( <a href="https://bitbucket.org/kmike/django-widget-tweaks/">bitbucket</a> , <a href="https://github.com/kmike/django-widget-tweaks">github</a> ) when screwing in the layout, this application allows the screwing process to be simplified and cleaned. <br><br><pre> <code class="django hljs"><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b-filter_selector time"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">render_field</span></span></span><span class="hljs-template-tag"> search_form.persons data-behavior='Chosen' %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  If you need some kind of standard binding for the field, do an html-snippet, which can then be connected via {% include%} (something like this): <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span></span><span class="hljs-comment"><span class="hljs-comment">{% comment %} : {% include "inc/input.html" with field=form.query div_classes="search" no_label=0 %} {% endcomment %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">load</span></span></span></span></span><span class="hljs-template-tag"> widget_tweaks %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> no_label != 1 %}</span></span><span class="xml"></span><span class="hljs-template-variable"><span class="xml"></span><span class="hljs-template-variable">{{ field.label_tag }}</span></span><span class="xml"></span><span class="hljs-template-tag"><span class="xml"></span><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b-input </span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ div_classes }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string"> </span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> field.errors %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">error</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ field|</span><span class="hljs-name"><span class="hljs-template-variable"><span class="hljs-name">add</span></span></span><span class="hljs-template-variable">_class:'b-input_input' }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br>  The same for error output. <br><br>  <code>{% render_field %}</code> from django-widget-tweaks can also add attributes (css-classes, for example) to existing ones: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">render_field</span></span></span><span class="hljs-template-tag"> form.emails rows="2" class+="b-input_textarea gray" autofocus="" %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">include</span></span></span></span></span><span class="hljs-template-tag"> "inc/errors.html" with errors=form.emails.errors %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br><br><h5>  "Available today" block </h5><br><br><img src="https://habrastorage.org/getpro/habr/post_images/de2/ec3/33c/de2ec333c104b175fbba1571cdeaf255.png" alt="image"><br><br>  In this block we have 5 restaurants that are available for booking today.  They turn out like this: <br><br><pre> <code class="python hljs">restaurants = Restaurant.objects.enabled().free_today_in_city(city).prefetch_related(<span class="hljs-string"><span class="hljs-string">'scenes'</span></span>)[:<span class="hljs-number"><span class="hljs-number">5</span></span>]</code> </pre><br><br>  As you can see, a chain of own methods is built here ( <code>.enabled().free_today_in_city(city)</code> ).  The built-in jung approach ‚Äî putting such pieces into the manager ‚Äî does not allow this, because  manager methods return a QuerySet, which already has no custom methods ‚Äî for filtering, it turns out, you can only use one of your methods. <br><br>  To get around this limitation, use PassThroughManager from <a href="https://bitbucket.org/carljm/django-model-utils">django-model-utils</a> and write the QuerySet instead of the manager: <br><br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RestaurantQueryset</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(QuerySet)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">enabled</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.filter(enabled=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">free_today_in_city</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, city)</span></span></span><span class="hljs-function">:</span></span> today = city.now().date() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.filter(city=city).free(today) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">free</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, date)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... class Restaurant(models.Model): # ... objects = PassThroughManager.for_queryset_class(RestaurantQueryset)()</span></span></code> </pre><br><br>  Such "managers on steroids" are obtained (I decided not to select a picture :)).  They are used throughout the whole project instead of standard managers. <br><br><h4>  Click on "View all" </h4><br>  ... and get to the page with a list of restaurants.  On this page, a large search form, the results are updated Ajax. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b15/8f6/dec/b158f6dec2aa04fddacd5e89121f40ec.jpg" alt="image"><br><br>  I have a small personal ‚Äúfad‚Äù about js: the site should be available without js.  This gives some advantages when developing.  In addition to the obvious ones (the error in js does not make the site inoperative) there are less obvious ones: for example, such a site is easier to test (you can test most of all without the help of selenium) + perhaps it is easier to write) <br><br>  At the moment, we use the following approach to Ajax: Ajax and ordinary requests are processed by the same view, the only difference is in the template.  Because  Aayaksov template is part of a regular template, then we connect it in a regular template.  Normal pattern: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">extends</span></span></span></span></span><span class="hljs-template-tag"> 'base.html' %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!-- : ,     --&gt;</span></span></span><span class="xml"> ... </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b-search-results_result"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">include</span></span></span></span></span><span class="hljs-template-tag"> 'restaurants/ajax/list.html' %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> ... </span><span class="hljs-comment"><span class="xml"><span class="hljs-comment">&lt;!-- :  ,    --&gt;</span></span></span></span></code> </pre><br><br>  Ajax template: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b-search-results_result_list"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> restaurant </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> restaurants %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">...</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">li</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">ul</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  The template is selected based on request.is_ajax ();  There is a declarative js on the client, which can turn any ordinary html form into an Ajax one: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restaurant_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, city_slug)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... response = TemplateResponse(request, 'restaurants/list.html', {...}) if request.is_ajax(): response.template_name = 'restaurants/ajax/list.html' return response</span></span></code> </pre><br><br>  In PanGurman decided to experiment a bit with this.  At first it was the @ajax_template decorator, which added an AJAX view to the view: <br><br><pre> <code class="python hljs"><span class="hljs-meta"><span class="hljs-meta"> @ajax_template('restaurants/ajax/list.html') def restaurant_list(request, city_slug): # ... return TemplateResponse(request, 'restaurants/list.html', {...})</span></span></code> </pre><br><br>  Those.  you wrap the usual view into the decorator, you prescribe the data attribute of the form and that's it: the form becomes an Ajax one. <br><br>  But this option repeats <code>'restaurants/(ajax/)?list.html'</code> (which is annoying and is a source of errors), + a view can have several return points and not everything needs to be done ayaksovymi (and this means that the option is worse than just checking without decorator). <br><br>  Therefore, from @ajax_template refused and while stopped on this option: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restaurant_list</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, city_slug)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment"># ... return show(request, 'restaurants/list.html', {...})</span></span></code> </pre><br><br>  show is a successor from TemplateResponse, which for Ajax requests, first tries the template in the ajax subfolder.  See <a href="https://gist.github.com/2416695">https://gist.github.com/2416695</a> <br><br>  show has a couple more methods that I have always lacked - but, perhaps, wasn‚Äôt enough, because  there are a couple of subtleties with it and not everything is fine (for example, .with_context will fall if the previous view returns the redirect), but it is quite possible to use it (and problems have little to do with AYAX). <br><br>  In short, we make the site as if ajax does not exist, but add it later, where necessary, by placing the necessary part of the template in a subfolder. <br><br><h4>  Found something, poke in a restaurant </h4><br>  We fall on the restaurant page. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/e79/e87/fda/e79e87fdac21b055071b604c650e2609.jpg" alt="image"><br><br>  It also has an Ajax (the available time is checked in the order form via ajax requests), but it is implemented in another way :) <br><br>  The calendar is built on the client (without js there will be regular input fields) and therefore it is easier to get json from the server, and not html.  Using <a href="https://github.com/toastdriven/django-tastypie">django-tastypie</a> quickly built an API, and through it json is given.  It is not much longer than writing a view that gives json, by hand, but the API still comes in handy + different buns like throttling and freehand formats are obtained. <br><br>  In another project used for the API django-piston;  subjectively - django-tastypie is nicer. <br><br>  A very primitive (and not quite complete) API reference is automatically generated by the following view: <br><br><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_api_resources</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(api)</span></span></span><span class="hljs-function">:</span></span> resources = {} api_name = api.api_name <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> name <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> sorted(api._registry.keys()): resource = api._registry[name] resources[name] = { <span class="hljs-string"><span class="hljs-string">'list_endpoint'</span></span>: api._build_reverse_url(<span class="hljs-string"><span class="hljs-string">"api_dispatch_list"</span></span>, kwargs={ <span class="hljs-string"><span class="hljs-string">'api_name'</span></span>: api_name, <span class="hljs-string"><span class="hljs-string">'resource_name'</span></span>: name, }), <span class="hljs-string"><span class="hljs-string">'schema'</span></span>: api._build_reverse_url(<span class="hljs-string"><span class="hljs-string">"api_get_schema"</span></span>, kwargs={ <span class="hljs-string"><span class="hljs-string">'api_name'</span></span>: api_name, <span class="hljs-string"><span class="hljs-string">'resource_name'</span></span>: name, }), <span class="hljs-string"><span class="hljs-string">'doc'</span></span>: resource.__doc__, <span class="hljs-string"><span class="hljs-string">'resource'</span></span>: resource } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> resources <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">browse</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request, api)</span></span></span><span class="hljs-function">:</span></span> resources = _api_resources(api) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> TemplateResponse(request, <span class="hljs-string"><span class="hljs-string">'tasty_browser/index.html'</span></span>, { <span class="hljs-string"><span class="hljs-string">'api'</span></span>: api, <span class="hljs-string"><span class="hljs-string">'resources'</span></span>: resources })</code> </pre><br><br>  Template: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">API </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ api.api_name }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">h1</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">table</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'tastypie-api'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Resource</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">url</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Structure</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Description</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">th</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">for</span></span></span></span></span><span class="hljs-template-tag"> name, resource </span><span class="hljs-keyword"><span class="hljs-template-tag"><span class="hljs-keyword">in</span></span></span><span class="hljs-template-tag"> resources.items %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ name }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ resource.list_endpoint }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">?format=json'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ resource.list_endpoint }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ resource.schema }}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">?format=json'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ resource.schema }}</span></span><span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ resource.doc }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">td</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">tr</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endfor</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">table</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  You can see here: <a href="http://pangurman.ru/api-docs/">http://pangurman.ru/api-docs/</a> <br><br>  Payment is bolted through <a href="http://pypi.python.org/pypi/django-robokassa/">django-robokassa</a> (then more options will be added), SMS notification of reservation - via <a href="https://bitbucket.org/kmike/imobis">imobis</a> + celery. <br><br><h4>  Finance </h4><br><img src="https://habrastorage.org/getpro/habr/post_images/2a7/3ed/6d4/2a73ed6d40ce7f3cb16b7db71b5c376d.png" alt="image"><br><br>  In Pangurman, the user has a personal account from which to pay for purchases.  You can replenish it with the help of robokassa, inviting friends, entering promotional codes.  Then more ways will be added anyway. <br><br>  Having read Fowler, for several years I have been using the following approach to the implementation of a ‚Äúpersonal account‚Äù: the amount is not stored anywhere on the account (however, it can be cached sometimes), we keep transactions on a personal account in the database.  This allows you to naturally get a history of operations + saves from errors. <br><br>  For example, if a person through the payment system pays an amount insufficient to pay for the purchase, the amount will first be credited to a personal account, then they will try to write off, the write-off will not succeed and the person, as needed, will remain without a purchase, but with the amount on the account. <br><br>  A similar model wanders from project to project with minor changes: <br><br><pre> <code class="python hljs"> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MoneyTransfer</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(models.Model)</span></span></span><span class="hljs-class">:</span></span> PURCHASE = <span class="hljs-string"><span class="hljs-string">'purchase'</span></span> ROBOKASSA = <span class="hljs-string"><span class="hljs-string">'robokassa'</span></span> INVITE_BONUS = <span class="hljs-string"><span class="hljs-string">'invite-bonus'</span></span> REFUND = <span class="hljs-string"><span class="hljs-string">'refund'</span></span> PROMOCODE = <span class="hljs-string"><span class="hljs-string">'promocode'</span></span> TRANSFER_TYPE_CHOICES = ( (<span class="hljs-string"><span class="hljs-string">u'  '</span></span>, ( (PURCHASE, <span class="hljs-string"><span class="hljs-string">u' '</span></span>), )), (<span class="hljs-string"><span class="hljs-string">u' '</span></span>, ( (ROBOKASSA, <span class="hljs-string"><span class="hljs-string">u'  '</span></span>), (INVITE_BONUS, <span class="hljs-string"><span class="hljs-string">u'   '</span></span>), (PROMOCODE, <span class="hljs-string"><span class="hljs-string">u' '</span></span>), (REFUND, <span class="hljs-string"><span class="hljs-string">u''</span></span>), )), ) user = models.ForeignKey(User, verbose_name=<span class="hljs-string"><span class="hljs-string">u''</span></span>) amount = models.DecimalField(<span class="hljs-string"><span class="hljs-string">u''</span></span>, max_digits=<span class="hljs-number"><span class="hljs-number">10</span></span>, decimal_places=<span class="hljs-number"><span class="hljs-number">2</span></span>) created_at = models.DateTimeField(<span class="hljs-string"><span class="hljs-string">u'/ '</span></span>, auto_now_add=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) comment = models.CharField(<span class="hljs-string"><span class="hljs-string">u''</span></span>, max_length=<span class="hljs-number"><span class="hljs-number">255</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) transfer_type = models.CharField(<span class="hljs-string"><span class="hljs-string">u''</span></span>, max_length=<span class="hljs-number"><span class="hljs-number">20</span></span>, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, choices=TRANSFER_TYPE_CHOICES) content_type = models.ForeignKey(ContentType, null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) object_id = models.PositiveIntegerField(null=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>, blank=<span class="hljs-keyword"><span class="hljs-keyword">True</span></span>) reason = GenericForeignKey(<span class="hljs-string"><span class="hljs-string">'content_type'</span></span>, <span class="hljs-string"><span class="hljs-string">'object_id'</span></span>)</code> </pre><br><br>  Here you can pay attention to the way choices.  Write more, but there are no magic constants and you cannot mistakenly write to the base 'invite_bonus' instead of 'invite-bonus' - MoneyTransfer.INVITE_BONUS is always one and immediately falls with AttributeError, if you write it incorrectly (and the autocomplex appears). <br><br><h4>  The table was booked, but stop, and how does it work? </h4><br>  Go to <a href="http://pangurman.ru/how-it-works/">the help page</a> .  On this page, part of the text, obviously, it would be good to allow editors to edit without the participation of the programmer. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/43b/2e7/030/43b2e7030a3832fcb95d01bab9f6aa9e.png" alt="image"><br><br>  In django, there are flatpages for this, but we usually use a different approach: we make all the pages with regular views with normal templates, store everything in VCS, and mark the <a href="https://github.com/zerok/django-flatblocks">django-flatblocks</a> with pieces of text that need to be edited: <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b-text"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name">flatblock</span></span></span><span class="hljs-template-tag"> "how-it-works" 600 %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre><br><br>  For admins when you hover the mouse over the text shows a link to edit <br>  (this is done by setting your flatblocks / flatblock.html template): <br><br><pre> <code class="django hljs"><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">load</span></span></span></span></span><span class="hljs-template-tag"> url from future %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">load</span></span></span></span></span><span class="hljs-template-tag"> markup %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">if</span></span></span></span></span><span class="hljs-template-tag"> user.is_staff %}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"b-flatblock-edit"</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">"flatblock-edit-link markitup-flatblocks-edit-icon"</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">title</span></span></span></span><span class="xml"><span class="hljs-tag"> = </span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">" "</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'</span></span></span></span></span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">url</span></span></span></span></span><span class="hljs-template-tag"> "edit_flatblock" flatblock.pk %}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">?next=</span></span></span></span></span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{request.path}}</span></span><span class="xml"><span class="hljs-tag"><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">'</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">a</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ flatblock.content|markdown:</span><span class="hljs-string"><span class="hljs-template-variable"><span class="hljs-string">"video"</span></span></span><span class="hljs-template-variable"> }}</span></span><span class="xml"><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">else</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-variable"><span class="hljs-template-variable">{{ flatblock.content|markdown:</span><span class="hljs-string"><span class="hljs-template-variable"><span class="hljs-string">"video"</span></span></span><span class="hljs-template-variable"> }}</span></span><span class="xml"><span class="xml"> </span></span><span class="hljs-template-tag"><span class="hljs-template-tag">{% </span><span class="hljs-name"><span class="hljs-name"><span class="hljs-template-tag"><span class="hljs-name"><span class="hljs-name">endif</span></span></span></span></span><span class="hljs-template-tag"> %}</span></span><span class="xml"></span><span class="xml"></span></code> </pre><br><br>  In blocks, markup is stored in markdown, on the edit page we show the widget from <a href="https://bitbucket.org/carljm/django-markitup/">django-markitup</a> (with preview): <br><br><img src="https://habrastorage.org/getpro/habr/post_images/089/51f/cce/08951fcce56e2a5337e222b050e4d878.png" alt="image"><br><br>  All texts on the site, in which some markup is allowed, are edited using django-markitup (inspirational descriptions of restaurants with photos, for example).  The markdown filter is configured in such a way that it does not touch the html-tags, so if necessary, any markup can be added to the text. <br>  And, the extension is also screwed ( <a href="https://bitbucket.org/kmike/python-markdown-video">python-markdown-video</a> ), which turns youtube or vimeo links into videos - in a good way it is done through oembed, you probably need it. <br><br><h4>  Dashboard for restaurants </h4><br>  For restaurants there is a special panel through which they can now control the opening hours (when tables are available when not).  The panel is implemented through another separate instance of AdminSite.  There can be users who are appointed by "restaurant managers".  The subtlety is that these users should not have the is_staff flag, otherwise they will be able to enter the regular admin panel, which they would not want.  And so - the usual customized admin panel. <br><br>  [rant on] <br>  <i>Often they write that, they say, Djang's admin panel is inflexible and so on.</i>  <i>- I did not understand what people specifically mean :) The admin panel provides CRUD, layout and out-of-box design, and if you know what can be customized and what is difficult, then there are no problems.</i>  <i>As an Orthodox alternative, some kind of framework for writing dashboards is usually suggested - this is a CRUD perpendicular thing, and there are such frameworks for django admins ( <a href="https://bitbucket.org/izi/django-admin-tools/wiki/Home">django-admin-tools</a> , <a href="https://github.com/dcramer/nexus">nexus</a> ).</i> <i><br><br></i>  <i>If any interaction does not fit into the CRUD - no problems, nothing prevents you from writing your view and putting a link to it from somewhere in the admin area (readonly_fields and list_display are often convenient here; you can also override the template).</i>  <i>To throw out or rewrite the admin panel of desire for several years never occurred, use it in all projects, saves a lot of time.</i>  <i>Perhaps the specific nature of such projects, or I am really missing something obvious, I don‚Äôt know.</i> <i><br></i>  [rant off] <br><br>  Instead of raw_id_fields, we actively use the application with the <a href="https://github.com/lincolnloop/django-salmonella">django-salmonella</a> name in <a href="https://github.com/lincolnloop/django-salmonella">the admin panel</a> , which ‚Äúinfects‚Äù widgets to select related records with useful behavior (for FK and M2M: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/08d/260/a9a/08d260a9a4a7a46721cd06630078cf0f.png" alt="image"><br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d9/8ac/4d0/8d98ac4d04ba0f09d4df40af6c84bf33.png" alt="image"><br><br>  In addition to the id of the object, its name becomes visible (updated by the Ajax);  by clicking on the name, you can immediately get to the page of the object change, which is also convenient <br><br><h4>  Tests </h4><br>  For the tests began to use <a href="https://github.com/rbarrois/factory_boy">factory-boy</a> (fork), about which it was already on the habr.  Since that recording, one super-useful thing has appeared in the factory-boy: RelatedFactory.  It's like a SubFactory, just the opposite (for example, you can make a factory for the user, who will immediately create a profile for him).  Documentation can be read <a href="">here</a> .  Example: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ProfileF</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(factory.DjangoModelFactory)</span></span></span><span class="hljs-class">:</span></span> FACTORY_FOR = Profile city = factory.SubFactory(CityF) balance = <span class="hljs-number"><span class="hljs-number">0</span></span> @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_prepare</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, create, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-comment"><span class="hljs-comment">#  'balance=555' balance = kwargs.pop('balance') profile = super(ProfileF, cls)._prepare(create, **kwargs) if balance &gt; 0: MoneyTransferF(user=profile.user, amount=balance) return profile class UserF(factory.DjangoModelFactory): FACTORY_FOR = User username = factory.Sequence(lambda n: "username%s" % n) first_name = factory.Sequence(lambda n: u" %s" % n) last_name = factory.Sequence(lambda n: u" %s" % n) email = factory.Sequence(lambda n: "email%s@example.com" % n) is_staff = False is_active = False is_superuser = False password = '123' profile = factory.RelatedFactory(ProfileF, 'user') @classmethod def _prepare(cls, create, **kwargs): kwargs['password'] = make_password(kwargs['password']) return super(UserF, cls)._prepare(create, **kwargs)</span></span></code> </pre><br><br>  Now in the tests, you can write: <br><br><pre> <code class="python hljs">user = UserF(profile__balance=<span class="hljs-number"><span class="hljs-number">100</span></span>)</code> </pre><br><br>  <i>As a warm-up I did a factory-boy pull request with the addition of support for the 3rd python, but the 3rd python is a topic for a separate story)</i> <br><br>  There is one more trick in Django 1.4 with tests.  By default, the PBKDF2 algorithm was used to hash passwords.  In PBKDF2, one of the characteristics that provide security is low speed.  But apart from being protected, a low speed of work still provides a low speed of work :) On the main site, this is not a problem at all (users don't log in so often and log in, and the delay is small), but in tests it turned out that this is a critical thing, especially if you use factory -boy and create many users by assigning them a password through a hash. <br><br>  In the case of PanGurman, the installation of this line in test_settings.py accelerated the tests by 2 times: <br><br><pre> <code class="python hljs"> PASSWORD_HASHERS = [<span class="hljs-string"><span class="hljs-string">'django.contrib.auth.hashers.MD5PasswordHasher'</span></span>]</code> </pre></div><p>Source: <a href="https://habr.com/ru/post/142703/">https://habr.com/ru/post/142703/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142696/index.html">Accessibility - OS test for people with disabilities (Part 1)</a></li>
<li><a href="../142697/index.html">Writing your Core Image Filter</a></li>
<li><a href="../142699/index.html">MS SCOM and group policies: are there any drawbacks?</a></li>
<li><a href="../142701/index.html">Home electronic library: MyHomeLib + FBD</a></li>
<li><a href="../142702/index.html">GeekTool - customization of the desktop in OS X</a></li>
<li><a href="../142704/index.html">OT Routes - 8 New Cities and a Pedestrian Update</a></li>
<li><a href="../142705/index.html">Certification by Yandex.Direct. Want to become an expert?</a></li>
<li><a href="../142706/index.html">ebay What did your neighbor buy?</a></li>
<li><a href="../142707/index.html">OpenStreetMap: reviewing licensing agreements and Russian legislation</a></li>
<li><a href="../142708/index.html">User Authorization Management System on thousands of servers</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>