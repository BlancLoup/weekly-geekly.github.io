<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating your own image with pure CentOS 5.9 in the Amazon cloud</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As you know, in the Amazon cloud virtual instances run on the basis of images (the so-called AMI ). Amazon provides a large number of them, you can al...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating your own image with pure CentOS 5.9 in the Amazon cloud</h1><div class="post__text post__text-html js-mediator-article">  As you know, in the Amazon cloud virtual instances run on the basis of images (the so-called <a href="https://aws.amazon.com/amis">AMI</a> ).  Amazon provides a large number of them, you can also use public images prepared by third-party organizations, for which the cloud provider, of course, does not bear any responsibility.  But sometimes you need an image of a clean system with the necessary parameters, which is not in the list of images.  Then the only way out is to make your AMI. <br><br>  The official documentation describes a <a href="http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/creating-loopback-s3-linux.html">method for</a> creating an ‚Äúinstance store-backed AMI‚Äù.  The disadvantage of this approach is that the finished image will also need to be converted into ‚ÄúEBS-backed AMI‚Äù <br><br>  How to create your EBS-backed AMI in the Amazon cloud without intermediate steps will be discussed in this article. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Action plan: <br><ul><li>  Prepare the environment </li><li>  Install a clean system, make the necessary settings </li><li>  Snapshot a disk </li><li>  Register AMI </li></ul><br><br><h4>  Environment preparation </h4><br>  Any instance of any shape, even t1.micro, is suitable for our purposes.  You can run it through the CLI: <br><pre><code class="bash hljs">aws ec2 run-instances --image-id ami-1624987f --max-count 1 --min-count 1 --key-name mel --instance-type t1.micro</code> </pre> <br>  Let's create ebs-volume, where we will install our system later: <br><pre> <code class="bash hljs">aws ec2 create-volume --availability-zone us-east-1a --size 10</code> </pre>  This team will make a 10 Gb disk for us.  Important: the drive must be in the same zone as the instance (in our case it is us-east-1a). <br>  Next, you need to attach the disk to the instance: <br><pre> <code class="bash hljs">aws ec2 attach-volume --instance-id i-2bc0925b --volume-id vol-08ab3079 --device /dev/xvdf</code> </pre><br>  Now log in to the instance by ssh, format the disk and mount it to the directory: <br><pre> <code class="bash hljs">mkfs.ext3 /dev/xvdf mkdir /mnt/centos-image mount /dev/xvdf /mnt/centos-image <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> !$</code> </pre><br><h4>  Installing Clean Centos 5.9 </h4><br>  Before installing the system, you need to create a directory tree, mount proc and sysfs, create a minimum set of devices: <br><pre> <code class="bash hljs">mkdir centos-image/{boot,tmp,dev,sys,proc,etc,var} mount -t proc none /mnt/centos-image/proc/ mount -t sysfs none /mnt/centos-image/sys/ <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> console null zero ; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> /sbin/MAKEDEV -d /mnt/centos-image/dev -x <span class="hljs-variable"><span class="hljs-variable">$i</span></span> ; <span class="hljs-keyword"><span class="hljs-keyword">done</span></span></code> </pre><br>  We will install the system using yum and the following configuration file: <br><div class="spoiler">  <b class="spoiler_title">yum-centos.conf</b> <div class="spoiler_text"><pre> <code class="bash hljs">[main] cachedir=/var/cache/yum debuglevel=2 logfile=/var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/yum.log exclude=*-debuginfo gpgcheck=0 obsoletes=1 reposdir=/dev/null [base] name=CentOS-5.9 - Base mirrorlist=http://mirrorlist.centos.org/?release=5.9&amp;arch=x86_64&amp;repo=os <span class="hljs-comment"><span class="hljs-comment">#baseurl=http://mirror.centos.org/centos/5.9/os/x86_64/ gpgcheck=1 gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-5 [updates] name=CentOS-5.9 - Updates mirrorlist=http://mirrorlist.centos.org/?release=5.9&amp;arch=x86_64&amp;repo=updates #baseurl=http://mirror.centos.org/centos/5.9/updates/x86_64/ gpgcheck=1 gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-CentOS-5 [extras] name=CentOS-5.9 - Extras mirrorlist=http://mirrorlist.centos.org/?release=5.9&amp;arch=x86_64&amp;repo=extras #baseurl=http://mirror.centos.org/centos/5.9/extras/x86_64/ gpgcheck=1 gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-5 [centosplus] name=CentOS-5.9 - Plus mirrorlist=http://mirrorlist.centos.org/?release=5.9&amp;arch=x86_64&amp;repo=centosplus #baseurl=http://mirror.centos.org/centos/5.9/centosplus/x86_64/ gpgcheck=1 enabled=0 gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-5 [contrib] name=CentOS-5.9 - Contrib mirrorlist=http://mirrorlist.centos.org/?release=5.9&amp;arch=x86_64&amp;repo=contrib #baseurl=http://mirror.centos.org/centos/5.9/contrib/x86_64/ gpgcheck=1 enabled=0 gpgkey=http://mirror.centos.org/centos/RPM-GPG-KEY-5</span></span></code> </pre></div></div><br><pre> <code class="bash hljs">yum -c ~/yum-centos.conf --installroot=/mnt/centos-image/ -y groupinstall Base</code> </pre><br>  After the installation process is completed, in the same way, you can install any necessary packages: <br><pre> <code class="bash hljs">yum -c ~/yum-centos.conf --installroot=/mnt/centos-image/ install <span class="hljs-variable"><span class="hljs-variable">$packet_name</span></span></code> </pre><br>  Edit fstab: <br><pre> <code class="bash hljs">vi /mnt/centos-image /dev/xvda1 / ext3 defaults 0 0 none /dev/pts devpts gid=5,mode=620 0 0 none /dev/shm tmpfs defaults 0 0 none /proc proc defaults 0 0 none /sys sysfs defaults 0 0</code> </pre><br>  On CentOS 5.9, you also need to install a kernel with xen support: <br><pre> <code class="bash hljs">yum -c ~/yum-centos.conf --installroot=/mnt/centos-image/ -y install kernel-xen</code> </pre><br>  Install Grub: <br><pre> <code class="bash hljs">chroot /mnt/centos-image/ grub-install /dev/xvdf</code> </pre><br>  and generate a new initrd: <br><pre> <code class="bash hljs">chroot /mnt/centos-image/ <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> boot/ mkinitrd --omit-scsi-modules --with=xennet --with=xenblk --fstab=/etc/fstab --preload=xenblk initrd-2.6.18-348.1.1.el5xen.img 2.6.18-348.1.1.el5xen</code> </pre><br>  It is very important to specify all these parameters and the new fstab, otherwise the system will not boot. <br>  Next you need to create a menu.lst file for grub: <br><pre> <code class="bash hljs">default=0 timeout=5 hiddenmenu title CentOS_5.9_(x86_64) root (hd0) kernel /boot/vmlinuz-2.6.18-348.1.1.el5xen ro root=/dev/xvda1 initrd /boot/initrd-2.6.18-348.1.1.el5xen.img</code> </pre><br>  Configure the network and sshd: <br><pre> <code class="bash hljs">vi etc/sysconfig/network-scripts/ifcfg-eth0 ONBOOT=yes DEVICE=eth0 BOOTPROTO=dhcp TYPE=Ethernet USERCTL=yes PEERDNS=yes IPV6INIT=no vi etc/sysconfig/network NETWORKING=yes chroot /mnt/centos5img/ chkconfig --level 2345 network on vi /mnt/centos5img/etc/ssh/sshd_config ... UseDNS no PermitRootLogin without-password</code> </pre><br>  Thus, we get a working network and the ability to login to the instance by keys.  But, the key itself needs to be somehow thrown onto the instance.  This can be done using a script that will take the key and save it to the instance: <br><pre> <code class="bash hljs">vi /mnt/centos5img/etc/init.d/ec2-get-ssh</code> </pre><div class="spoiler">  <b class="spoiler_title">ec2-get-ssh</b> <div class="spoiler_text">  #! / bin / bash <br>  # chkconfig: 2345 95 20 <br>  # processname: ec2-get-ssh <br>  # description: Capture AWS public key credentials for EC2 user <br><br>  # Source function library <br>  .  /etc/rc.d/init.d/functions <br><br>  # Source networking configuration <br>  [-r / etc / sysconfig / network] &amp;&amp;.  / etc / sysconfig / network <br><br>  # Replace the environment variables for your system <br>  export PATH =: / usr / local / bin: / usr / local / sbin: / usr / bin: / usr / sbin: / bin: / sbin <br><br>  # Check that networking is configured <br>  if ["$ {NETWORKING}" = "no"];  then <br>  echo "Networking is not configured." <br>  exit 1 <br>  fi <br><br>  start () { <br>  if [!  -d /root/.ssh];  then <br>  mkdir -p /root/.ssh <br>  chmod 700 /root/.ssh <br>  fi <br>  # Retrieve public key from metadata server using HTTP <br>  curl -f <a href="http://169.254.169.254/latest/meta-data/public-keys/0/openssh-key">169.254.169.254/latest/meta-data/public-keys/0/openssh-key</a> &gt; / tmp / my-public-key <br>  if [$?  -eq 0];  then <br>  echo "EC2: Retrieve public key from metadata server using HTTP." <br>  cat / tmp / my-public-key &gt;&gt; /root/.ssh/authorized_keys <br>  chmod 600 /root/.ssh/authorized_keys <br>  rm / tmp / my-public-key <br>  fi <br>  } <br><br>  stop () { <br>  echo "Nothing to do here" <br>  } <br><br>  restart () { <br>  stop <br>  start <br>  } <br><br>  # See how we were called. <br>  case "$ 1" in <br>  start) <br>  start <br>  ;; <br>  stop) <br>  stop <br>  ;; <br>  restart) <br>  restart <br>  ;; <br>  *) <br>  echo $ "Usage: $ 0 {start | stop | restart}" <br>  exit 1 <br>  esac <br><br>  exit $? </div></div><br>  Let's make it executable and add it to autoload: <br><pre> <code class="bash hljs">chmod +x /mnt/centos-image/etc/init.d/ec2-get-ssh /usr/sbin/chroot /mnt/centos-image/ /sbin/chkconfig --level 34 ec2-get-ssh on</code> </pre><br>  It is also desirable to disable Selinux, or configure it correctly.  Otherwise, for example, the key may not be saved on the instance. <br>  This can stop the system configuration.  We already have a clean CentOS, ready to launch in the cloud.  It remains only to unmount the ebs-disk with our system and register ami. <br><pre> <code class="bash hljs">umount /mnt/centos-image/proc/ umount /mnt/centos-image/sys/ umount /mnt/centos-image/</code> </pre><br><h4>  AMI Registration </h4><br>  To get ami from an ebs disk, you need to first snapshot the disk: <br><pre> <code class="bash hljs">aws ec2 create-snapshot --volume-id vol-0b4bd07a --description centos-snap</code> </pre><br>  The easiest way to register ami is through the AWS Management Console.  To do this, simply in the EC2 service, go to the ‚ÄúSnapshots‚Äù section, select the desired one (in our case it is a centos-snap), right-click on it and select ‚ÄúCreate Image from Snapshot‚Äù <br>  Then, in the window that opens, you need to select approximately the following parameters: <br><br><img src="https://habrastorage.org/storage2/4d8/f21/e12/4d8f21e124f9f22e23c172ad269254ef.png"><br><br>  Which Kernel ID to choose, you can find out like this: <br><pre> <code class="bash hljs">aws ec2 describe-images --owner amazon --region us-east-1 --output text | grep <span class="hljs-string"><span class="hljs-string">"\/pv-grub-hd0.*-x86_64"</span></span> | awk <span class="hljs-string"><span class="hljs-string">'{print $7}'</span></span> | grep aki aki-88aa75e1 aki-b4aa75dd</code> </pre><br><br>  That's all.  Now you can run instances. <br>  In this way, you can make an image, most likely with any Linux distribution.  At least, exactly Debian- (using debootstrap to install a clean system) and the Rhel-family. </div><p>Source: <a href="https://habr.com/ru/post/169331/">https://habr.com/ru/post/169331/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../169319/index.html">Veeam Backup Cloud Edition has been released with support for Azure, Amazon, Google, HP Cloud and several other cloud platforms.</a></li>
<li><a href="../169321/index.html">New perspectives on Java Enterprise with the Polyglot JVM</a></li>
<li><a href="../169323/index.html">Habra Kadabra - literacy support for authors of articles on Habrahabr</a></li>
<li><a href="../169327/index.html">In the wake of the movie "The Pirate Bay: Away From Keyboard" or the future of the Internet</a></li>
<li><a href="../169329/index.html">Continuous Integration in Dnevnik.ru</a></li>
<li><a href="../169333/index.html">Data storage systems: how slowly but surely they are decoupled from iron</a></li>
<li><a href="../169339/index.html">What's wrong with your open source project</a></li>
<li><a href="../169341/index.html">redmine_wiki_encryptor - wiki data encryption plugin Redmine</a></li>
<li><a href="../169343/index.html">John Resig: WebKit is jQuery for browser engines</a></li>
<li><a href="../169347/index.html">Theory of Relativity in Pictures</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>