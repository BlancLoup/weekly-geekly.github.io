<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Haxe and PHP: static typing, arrow functions, metaprogramming and much more</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! I bring to your attention the translation of the report of Alexander Kuzmenko from the recently held (June 14-15) conference of the Hong Kon...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Haxe and PHP: static typing, arrow functions, metaprogramming and much more</h1><div class="post__text post__text-html js-mediator-article"><p>  Hi, Habr!  I bring to your attention the translation of the <a href="https://www.youtube.com/watch%3Fv%3DIeXgTkh9NAs">report of Alexander Kuzmenko</a> from the recently held (June 14-15) conference of the Hong Kong Open Source Conference 2019. </p><br><p><img src="https://habrastorage.org/webt/rc/jl/b3/rcjlb3szs-q64jnzbf24jp-pkbi.jpeg" alt="image"></p><br><p>  Before joining the Haxe Foundation as a developer of the Haxe compiler, Alexander has been professionally programming in PHP for about 10 years, so he knows the subject of the report. <a name="habracut"></a></p><br><p><img src="https://habrastorage.org/webt/dd/ge/uz/ddgeuzdpnucbeqtsoesmwsigcqy.png" alt="image"></p><br><p>  A small introduction to what Haxe is is a cross-platform toolkit for creating software, which includes: </p><br><ul><li>  depending on the target platform, the compiler either translates the Haxe source code into source code in other programming languages ‚Äã‚Äã(C ++, PHP, Java, C #, JavaScript, Python, Lua), or compiles directly into a virtual machine byte code (JVM, neko HashLink, Flash) </li><li>  standard library implemented for all supported platforms </li><li>  Haxe also provides tools for interacting with code written in the target platform language. </li><li>  standard library manager - haxelib </li></ul><br><p><img src="https://habrastorage.org/webt/t_/vz/6b/t_vz6bmv3hsecjwjg49kqxcwjwy.png" alt="image"></p><br><p>  PHP support in Haxe appeared quite a long time ago - back in 2008.  In versions of Haxe up to 3.4.7, PHP 5.4 and higher was supported inclusively, and starting from the fourth version, Haxe supports PHP version 7.0 and higher. </p><br><p><img src="https://habrastorage.org/webt/ij/ku/hj/ijkuhjvcmki9lxrik0xudelbboq.png" alt="image"></p><br><p>  You ask: why does a PHP developer use Haxe? <br>  The main reason for this is the ability to use the same logic on both the server and the client. <br>  Consider this example: you have a server written in PHP using the Laravel framework, and several clients written in JavaScript, Java, C #.  In this case, to handle the network interaction between the server and the client (the logic of which is the same), you will need to write 4 implementations for each of the languages ‚Äã‚Äãused.  But with the help of Haxe, you can write the network protocol code once and then compile / translate it for different platforms, saving considerable time on it. </p><br><p><img src="https://habrastorage.org/webt/48/ib/h_/48ibh_6amyom9nhq24zjkkyinmq.png" alt="image"></p><br><p>  Here is another example - a gaming application - a clone of Clash of Clans.  Alexander participated in the development of a similar game: its server was written in PHP, the mobile client in C # (Xamarin), and the browser client in JavaScript using the Phaser framework.  On the client and the server, one logic was processed - the so-called "boevka", which calculated the behavior of the players' units at the location.  Initially, the code was written for each of the platforms separately.  But over time (and the project has been developing for about 5 years), differences in its behavior on the server and on the clients accumulated.  This was due to the fact that it was written by different people, each of whom implemented it in its own way.  Because of this, there was no reliable way to detect cheaters, because the logic on the server behaved quite differently than on the client, and as a result, honest players suffered as well.  the server could count them cheaters and not count the results of a fair fight. <br>  In the end, it was decided to transfer the combat to Haxe, which made it possible to completely solve the problem with the cheaters, since  Now the boevka logic behaved equally on all platforms.  In addition, this solution has reduced the cost of further development of the combat system, because  now there was enough one programmer familiar with Haxe, instead of three, each of whom would be responsible for his platform. </p><br><p><img src="https://habrastorage.org/webt/6r/2s/z0/6r2sz0kteijlry-ty8q-apoehqw.png" alt="image"></p><br><p>  What are the differences between Haxe and PHP?  In general, the Haxe syntax does not seem like something alien to a PHP programmer.  Yes, it is different, but in most cases it will be very similar to PHP. <br>  The slide shows a comparison of the code for outputting the string to the console.  In Haxe, the code looks almost the same, except that to work with PHP functions, you need to import them (see the first line). </p><br><p><img src="https://habrastorage.org/webt/ls/lo/gz/lslogzfyevnbebfjkmbvgqv1vra.png" alt="image"></p><br><p>  And this is how the generated PHP code looks in comparison with the handwritten code. <br>  The Haxe compiler automatically adds a block of comments to the code with a description of the types of function arguments and return types, so the resulting code can be connected to a PHP project and auto-completion will work fine for it. </p><br><p>  Consider some significant differences in the syntax of Haxe and PHP. </p><br><p><img src="https://habrastorage.org/webt/7w/g_/ri/7wg_rixmfysd_w6i5t6wsagbjie.png" alt="image"></p><br><p> Let's start with the differences in the syntax of anonymous functions (for example, using them to sort an array). <br>  The slide shows an anonymous function that captures and modifies the value of the local variable <code>desc</code> .  In PHP, it is necessary to explicitly indicate which variables are available in the body of an anonymous function.  In addition, to be able to change the value of a variable, you must add <code>&amp;</code> before its name. <br>  In Haxe, this need is eliminated, because  the compiler itself determines which variables you refer to.  In addition, in Haxe 4 there are arrow functions (a short form for describing anonymous functions), using which we can reduce our example with sorting the array to just one line. </p><br><p><img src="https://habrastorage.org/webt/nn/kt/fx/nnktfxc6ms0wcichaevl1gqccro.png" alt="image"></p><br><p>  Another difference in syntax is the differences in the description of the <code>switch</code> control construct.  In PHP, the <code>switch</code> works the same as in C.  In Haxe, it works differently: </p><br><ul><li>  first, switch does not use the <code>break</code> keyword </li><li>  secondly, you can combine several conditions with <code>|</code>  (and not duplicate the <code>case</code> keyword) </li><li>  Thirdly, pattern matching (pattern matching mechanism) is used for <code>switch</code> in Haxe.  For example, you can apply <code>switch</code> to an array, and in conditions you can define actions depending on the contents of the array (the <code>_</code> sign means that we don‚Äôt care about this value and can be anything).  Condition <code>[1, _, 3]</code> will be satisfied if the array consists of three elements, with the first element being 1, the third is 3, and the value of the second is any. </li></ul><br><p><img src="https://habrastorage.org/webt/-k/pl/zt/-kplzt2ulu5dhpkkdlfepebrneu.png" alt="image"></p><br><p>  In Haxe, everything is an expression, and it allows you to write more compact code.  You can return a value from <code>try</code> / <code>catch</code> , <code>if</code> or <code>switch</code> without using the <code>return</code> keyword inside these constructs.  In the above example with <code>try</code> / <code>catch</code> compiler "knows" that you want to return some value, and will be able to pass it from this construct. </p><br><p><img src="https://habrastorage.org/webt/ut/la/te/utlatecvj5wozwt9wnqmnpuo8xs.png" alt="image"></p><br><p>  PHP is gradually moving towards stricter typing, but Haxe already has strong static typing! <br>  In the example above, we assign the variable <code>s</code> value obtained from the <code>functionReturnsString()</code> , which returns a string.  Thus, the type of the variable <code>s</code> is a string.  And if you try to pass it to the <code>giveMeInteger()</code> function, which <code>giveMeInteger()</code> for an integer as an argument, the Haxe compiler will generate an error about the type mismatch. <br>  This example also demonstrates another important feature of Haxe - type inference (type inference) - the ability of the compiler to independently determine the types of variables, depending on what value it is assigned to. </p><br><p><img src="https://habrastorage.org/webt/4c/or/ik/4corikloq4gvhkdvba7njqnmdfm.png" alt="image"></p><br><p>  For a programmer, this means that in most cases it is not necessary to explicitly specify the types of variables.  So in the <code>isSmall()</code> function, the compiler will determine that the type of the argument <code>a</code> is an integer, since  in the first line of the function body, we compare the value of <code>a</code> with an integer.  Further, the compiler, based on the fact that we return <code>true</code> in the second line of the function body, determines that the return type is a Boolean value.  And since  Since the compiler has already determined the type of the return value, then when further attempts to return any other type from the function, it will generate a type mismatch error. </p><br><p><img src="https://habrastorage.org/webt/ja/ol/tv/jaoltvlbh3cj9auycpbmvgchfbg.png" alt="image"></p><br><p>  In Haxe, unlike PHP, there is no automatic type conversion.  For example, in PHP it is possible to return a string from a function for which it is indicated that it returns an integer, in which case the string will be converted to a number (not always successfully) when the script is executed.  And in Haxe, the same code simply won't compile - the compiler will generate a type mismatch error. </p><br><p><img src="https://habrastorage.org/webt/tl/tc/wr/tltcwryptyinh6qqnmcks_2lhmi.png" alt="image"></p><br><p>  Another difference with Haxe is its extended type system, including: </p><br><ul><li>  function types consisting of function argument types and return type </li><li>  generalized (parameterized) types (for example, these include arrays for which the type of stored values ‚Äã‚Äãis used as a parameter) </li><li>  enumerated types </li><li>  <a href="https://code.haxe.org/category/functional-programming/enum-gadt.html">generalized algebraic data types</a> </li><li>  types of anonymous structures allow you to declare types for objects without declaring classes </li><li>  <a href="https://haxe.org/manual/types-abstract.html">abstract data types</a> (abstractions over existing types, but without loss of performance in runtime) </li></ul><br><p>  All the types listed are compiled into PHP classes when compiled. </p><br><p><img src="https://habrastorage.org/webt/ue/mj/ou/uemjouzws_zkiiqcq2dnpdrm0i8.png" alt="image"></p><br><p>  One of the main distinguishing features of Haxe is metaprogramming (in Haxe it is called macros), that is, the ability to automatically generate the source code of a program. <br>  Macros are executed during the compilation of the program and are written in the usual Haxe. <br>  Macros have full access to the abstract syntax tree, that is, they can read (search for the required expressions in it) and modify it. <br>  Macros can generate expressions, modify existing types, and also create new ones. </p><br><p><img src="https://habrastorage.org/webt/r9/ex/rb/r9exrb2netrzi3l_lbpsismdmt8.png" alt="image"></p><br><p>  In the context of PHP, macros can for example be used for routing.  Let's say you have a simple class router that implements a method for displaying a page by its identifier, as well as a method for logging out of the system.  Using a macro, you can generate code for the <code>route()</code> method, which, based on an http request, will redirect it to the appropriate method of the <code>Router</code> class.  Thus, there is no need to manually write ifs for calls to each of the methods of this class (the macro will do this automatically when compiling the project in PHP).  Note that the resulting code does not use reflection, does not require any special configuration files, or any additional tweaks, so it will work very quickly. </p><br><p><img src="https://habrastorage.org/webt/5y/ni/cr/5ynicr8ntme8219uf4wkdmrmv8u.png" alt="image"></p><br><p>  Another example of using macros is code generation for parsing and validating JSON.  For example, you have a <code>Data</code> class, whose objects should be created on the basis of data obtained from JSON.  This can be done using a macro, but since the macro has access to the structure of the <code>Data</code> class, in addition to parsing, you can generate code for JSON validation by adding an exception to exclude if there are no fields or data type mismatch.  Thus, you can be sure that your application will not miss incorrect data received from users or from a third-party server. </p><br><p>  It is also worth mentioning the important features of the implementation of some data types for the PHP platform, since  if you do not take them into account, then you can face unpleasant consequences. </p><br><p><img src="https://habrastorage.org/webt/3-/_o/ey/3-_oeyqa5gnuukfhpp8jf3febpk.png" alt="image"></p><br><p>  In PHP, binary safe ( <a href="http://en.wikipedia.org/wiki/Binary-safe">binary safe</a> ) strings, so in PHP, if you do not need Unicode support, the methods for working with strings work very quickly. <br>  In Haxe, starting with the fourth version, strings support Unicode, so when they are compiled in PHP, the methods from the module for working with multibyte strings mbstring will be used, which means slow access to arbitrary characters in the string, slow calculation of the string length. <br>  Therefore, if you don‚Äôt need Unicode support, you can use the methods of the <code>php.NativeString</code> class to work with strings, which will use native PHP strings. </p><br><p><img src="https://habrastorage.org/webt/al/nb/2s/alnb2s8m9ihmys8vow4o0jaq8su.png" alt="image"></p><br><p>  The slide on the left shows PHP code that uses methods that support Unicode or not. <br>  On the right is the equivalent Haxe code.  As you can see, if you need Unicode support, you must use the methods of the <code>String</code> class, if not, then the methods of the <code>php.NativeString</code> class. </p><br><p><img src="https://habrastorage.org/webt/kw/9l/dh/kw9ldhmnf1hnml9bfmlekjeii38.png" alt="image"></p><br><p>  Another important point is the work with arrays. <br>  In PHP, arrays are passed by value, and arrays support both numeric and string keys. <br>  In Haxe, arrays are passed by reference and only support numeric keys (if string keys are required, then in Haxe, you should use the <code>Map</code> class for this).  Also in the Haxe-arrays are not allowed "holes" in the indices (indices must go continuously). <br>  It is also worth noting that writing to an array by index in Haxe is rather slow. </p><br><p><img src="https://habrastorage.org/webt/dp/kn/ce/dpkncez8twsdarekcxh15v0pqqs.png" alt="image"></p><br><p>  Here is the code for mapping an array using an arrow function.  As you can see, the Haxe compiler is rather actively optimizing the PHP code output: the anonymous function in the resulting code is missing, instead its code is applied in a loop to each element of the array.  In addition to <code>map()</code> this optimization is also applied to the <code>filter()</code> method. <br>  Also, if necessary, in Haxe you can use the <code>php.NativeArray</code> class and the corresponding PHP methods for working with arrays. </p><br><p><img src="https://habrastorage.org/webt/ht/20/pw/ht20pwdazaxb1ex9ivyepd0arqs.png" alt="image"></p><br><p>  Anonymous objects are implemented using the <code>HxAnon</code> class, which is inherited from the <code>StdClass</code> class from PHP. </p><br><p><img src="https://habrastorage.org/webt/2o/jl/vc/2ojlvclpiimnwmumla6twuwtnka.png" alt="image"></p><br><p>  In PHP, <code>StdClass</code> is a class whose instances turn everything we are trying to convert into an object.  And it would be ideally suited for the implementation of anonymous objects if it were not for one specification feature: in Haxe, accessing a nonexistent field of an anonymous object should return <code>null</code> , and in PHP it throws out a warning.  Because of this, I had to inherit from the standard class from PHP and add the magic method to it, which returns <code>null</code> when accessing non-existent properties. </p><br><p><img src="https://habrastorage.org/webt/hn/lz/0x/hnlz0x9h37vs6p80yyjraxmmqzi.png" alt="image"></p><br><p>  Haxe can interact with code written in PHP.  To do this, you have the following options (similar to the possibilities of interacting with JavaScript code): </p><br><ul><li>  externs </li><li>  inserting PHP code directly into Haxe code </li><li>  special classes from the <code>php.*</code> package <br><ul><li>  <code>php.Syntax</code> - for special PHP constructs that are not in Haxe </li><li>  <code>php.Global</code> - for native PHP global functions </li><li>  <code>php.Const</code> - for PHP's "native" global constants </li><li>  <code>php.SuperGlobal</code> - for superglobal PHP variables accessible from everywhere ( <code>$_POST</code> , <code>$_GET</code> , <code>$_SERVER</code> , etc.) </li></ul></li></ul><br><p><img src="https://habrastorage.org/webt/is/lw/au/islwauvbxj9xquckiqxykbfyeyq.png" alt="image"></p><br><p>  Because  PHP uses the classic OOP model, then writing externs for it is a fairly simple process.  In fact, external classes for PHP classes are almost literal "translations" in Haxe, with the exception of some keywords. <br>  As an example, the external code for the PHP class from the slide above will look like this: </p><br><p><img src="https://habrastorage.org/webt/ee/rc/rh/eercrhkebrovfemykunvunuk-qm.png" alt="image"></p><br><p>  Constants from the PHP class are "transformed" into static variables in the Haxe code (but with the addition of special meta tags). <br>  The static variable <code>$useBuiltinEncoderDecoder</code> becomes the static variable <code>useBuiltinEncoderDecoder</code> . <br>  This shows that external classes for PHP classes can be created automatically (Alexander plans to implement <a href="https://github.com/RealyUniqueName/peg">an external generator</a> this year). </p><br><p><img src="https://habrastorage.org/webt/rc/ew/6m/rcew6mtquxvjmsjpqfvazhup-ga.png" alt="image"></p><br><p>  For PHP code inserts, the special module <code>php.Syntax</code> .  The code added in this way is not subject to any transformations and optimizations by the Haxe compiler. <br>  In addition to <code>php.Syntax</code> in Haxe, the possibility of using <a href="https://haxe.org/manual/target-php-untyped.html">untyped-code</a> has remained. <br><img src="https://habrastorage.org/webt/tc/tu/oj/tctuojxtqw6ixuwohcma0apv2-0.png" alt="image"></p><br><p>  Also worth mentioning are the features of Haxe that are not in PHP: </p><br><ul><li>  real properties with methods for reading and writing </li><li>  read-only fields and variables </li><li>  static extensions </li><li>  Meta tags that can be used to annotate fields and are readable in macros.  Thus, meta tags are mainly used for metaprogramming. </li><li>  Null security (experimental feature) </li><li>  conditional compilation, which allows you to enable / disable parts of the code that may be available, for example, in the debug version of the application </li><li>  The Haxe compiler generates highly optimized PHP code that can run many times faster than handwritten PHP code. </li></ul><br><p>  More information about Haxe and its functions is available in its <a href="https://haxe.org/manual">official manual</a> . </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/458184/">https://habr.com/ru/post/458184/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../458170/index.html">Dipping into convolutional neural networks. Part 5/10 - 18</a></li>
<li><a href="../458172/index.html">Coupling methods for electrical connections when tracing differential pairs on printed circuit boards</a></li>
<li><a href="../458176/index.html">Exaflops barrier will be overcome in 2021</a></li>
<li><a href="../458180/index.html">Failover Kea based DHCP server</a></li>
<li><a href="../458182/index.html">We read VKontakte via RSS</a></li>
<li><a href="../458186/index.html">WAL in PostgreSQL: 1. Buffer cache</a></li>
<li><a href="../458188/index.html">How I did a social network in 2019</a></li>
<li><a href="../458192/index.html">STM32 + PPP + GSM + LwIp + TLS 1.2</a></li>
<li><a href="../4582/index.html">Ru-Center: by the end of 2007 there will be 1 million domains in RuNet</a></li>
<li><a href="../458204/index.html">How to evaluate the performance of storage on Linux: benchmarking using open tools</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>