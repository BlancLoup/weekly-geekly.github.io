<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating the game on your eyes - part 3: Screwing the scripting language to Unity (UniLua)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="As promised, I continue to share with you those technical details that we encounter in the process of creating our game. 

 This time let's talk about...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating the game on your eyes - part 3: Screwing the scripting language to Unity (UniLua)</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/118/7a6/2f5/1187a62f58d421298c017ba67ad5fe83.png"></div><br>  As promised, I continue to share with you those technical details that we encounter in the process of creating our game. <br><br>  This time let's talk about the language for writing in-game scripts. <br><br>  In this article I will tell why Lua, and not a handwritten bicycle.  Why in general the game may need a scripting language.  What subtleties are there when screwing this case to Unity and show how this is done using the example of UniLua integration. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      I must say that the latest information on the Internet is almost zero, and half of this zero is in Chinese.  So, you can say - keep exclusive. <br><a name="habracut"></a><br><h4>  Why do we need scripts? </h4><br>  In our game we have the need to show a variety of scripted scenes. <br><br>  I will give a typical example of a quest.  The character enters the store and sees that there is a robbery.  A picture showing thugs holding a bat at the temple of a frightened seller is shown.  Then some kind of dialogue is shown.  Then we see how our character comes to the mess and the action selection window appears - to help the seller and distribute to the racketeers or fit in for them. <br><br>  Obviously, you need to move sprites here, change animations for them, show the player different dialogues and pictures ... There are not many options here - either hardcore each quest, or try to script this thing. <br><br>  Obviously, such things are hard work at all. <br><br><h4>  Why Lua? </h4><br>  Actually, initially there was a choice between own bike and Lua. <br><br>  It would seem that from the first approximation the language does not require much and you can write your own.  Call yourself a team in order and that's it.  But if you think deeper ... Will the script events be related to the game parameters?  For example, a previously killed NPC should not appear in the scenes.  Or something else.  And this already means some conditions, triggers, etc. <br><br>  As a result, the ‚Äúunpretentious language‚Äù parser can turn into a very complicated thing, which will have to parse heaps of logical expressions, etc.  etc. <br><br>  Without thinking, it was decided to use someone else's and proven.  Lua.  Perhaps there are also other languages ‚Äã‚Äã... but Lua is what I see constantly in other games.  In the same World of Warcraft, the mods were written in this strange language, where indexation starts from one. <br><br>  So, again, it was decided to use a solution proven by others. <br><br><h4>  Unity Integration </h4><br>  Here begins the first fun.  The very first library that implements Lua in Unity, which you will find, will look good.  But if you dig deeper, it turns out that it uses some specific .Net methods that, for example, are not available on mobile phones (and, possibly, some other platforms). <br><br>  And we would like a library that would be supported everywhere (just in case) and preferably even fully with the sources, and not in a closed DLL. <br><br>  Digging in the internet, we found the free creation of Chinese programmers - <a href="https://github.com/xebecnan/UniLua">UniLua</a> .  Full sortsy and works everywhere. <br><br>  It's all good except that the docks are incredibly scarce and partly written in Chinese. <br><br>  Well, okay, we also have the source!  And the brain ... =) Downloading, throwing the UniLua folder into the plugins (so as not to be recompiled each time) and forth. <br><br><h4>  Call Lua Script from C # </h4><br>  It's all relatively simple: <br><pre><code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> UniLua; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ILuaState _lua; <span class="hljs-comment"><span class="hljs-comment">//        Lua private ThreadStatus _status; //       ... _lua = LuaAPI.NewState(); //  string lua_script = ""; //      Lua _status = _lua.L_LoadString(lua_script); //   if (_status != ThreadStatus.LUA_OK) { Debug.LogError("Error parsing lua code"); } _status.Call(0, 0); //  Lua-</span></span></code> </pre> <br>  You can try to run.  If no one curses, then everything is fine.  An empty script was successfully executed. <br><br><h4>  Calling C # Functions from Lua </h4><br>  Now we need to learn how to steer at least something from this script.  Obviously, we need to learn how to call C # code from Lua. <br><br>  Let's write a method that simply writes a parameter to the log: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L_Trace</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ILuaState s</span></span></span><span class="hljs-function">)</span></span> { Debug.Log(<span class="hljs-string"><span class="hljs-string">"Lua trace: "</span></span> + s.L_CheckString(<span class="hljs-number"><span class="hljs-number">1</span></span>)); <span class="hljs-comment"><span class="hljs-comment">//    return 1; //   }</span></span></code> </pre><br>  As you can see, we used the class <code>ILuaState</code> .  It is there that all input parameters are stored (which we want to transfer from Lua and that is where the result should be returned. Note! The result in Lua is not returned via <code>return</code> , but through <code>s.PushInteger()</code> , <code>s.PushString()</code> , etc. <br><br>  The function is written.  Now you need to connect it to Lua. <br><br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OpenLib</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ILuaState lua</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> define = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> NameFuncPair[] <span class="hljs-comment"><span class="hljs-comment">// ,     ( Lua -&gt; C#) { new NameFuncPair("trace", L_Trace), }; lua.L_NewLib(define); return 1; }</span></span></code> </pre><br>  Next, after creating the _lua object, we need to add a connection to this library description: <br><pre> <code class="cs hljs">_lua.L_OpenLibs(); _lua.L_RequireF(<span class="hljs-string"><span class="hljs-string">"mylib"</span></span>, OpenLib, <span class="hljs-literal"><span class="hljs-literal">true</span></span>);</code> </pre><br>  Done!  Now you can do this: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">string</span></span> lua_script = <span class="hljs-string"><span class="hljs-string">@" local lib = require ""mylib"" lib.trace(""Test output"") "</span></span>;</code> </pre><br>  It would seem that all?  But no.  Now the most difficult. <br><br><h4>  Yield </h4><br>  A little thought, it can be understood that our Lua script should not run continuously.  There will obviously be pauses, waiting for the end of some kind of animation, keystroke, etc.  That is, the script should return control back to the Sharps, and then, at some point, continue. <br><br>  It was here that I broke a lot of copies.  Explanatory description of how to do this was very difficult to find (and that was for another library). <br><br>  The first thing we need to do is to run the script not by Call, but through a separate stream: <br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">//_status.Call(0, 0);     .   : _thread = _lua.NewThread(); _status = _thread.L_LoadString(lua_script); _thread.Resume(null, 0);</span></span></code> </pre><br>  Now imagine that we in C # wrote the function ‚Äúwait for the animation to end‚Äù ( <code>L_WaitForAnimationStop</code> ), which we call from Lua.  The implementation here may be different, then I will describe the general principle. <br><br>  In this function, we need to hang up some callback at the end of this animation, and most importantly, instead of <code>return 1</code> we should do this: <br><pre> <code class="cs hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">int</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">L_WaitForAnimationStop</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">ILuaState s</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//    callback'  .. _temp_state = s; //  ILuaState     return s.YieldK(s.GetTop(), 0, null); //  Lua,       }</span></span></code> </pre><br>  And directly in the callback, we will need to continue executing the script from the place where it stopped. <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (_temp_state.GetTop() &gt; <span class="hljs-number"><span class="hljs-number">0</span></span>) _thread.Resume(<span class="hljs-literal"><span class="hljs-literal">null</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>);</code> </pre><br>  That's all.  Now script type: <br><pre> <code class="lua hljs">lib.trace(<span class="hljs-string"><span class="hljs-string">"starting"</span></span>) lib.wait_for_animation_stop() lib.trace(<span class="hljs-string"><span class="hljs-string">"stopped"</span></span>)</code> </pre><br>  after <code>lib.wait_for_animation_stop()</code> pause and continue only when you want it (i.e. in the case described above, call the callback, which <code>Resume()</code> will do). <br><br><h4>  What has been achieved </h4><br>  Using the above method, as well as <a href="http://habrahabr.ru/post/182018/">shamanism to simulate OOP</a> , we managed to achieve the following syntax: <br><br><pre> <code class="lua hljs"><span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ch1 = CharacterGfx() ch1.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">"char_0"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">local</span></span> ch2 = CharacterGfx() ch2.<span class="hljs-built_in"><span class="hljs-built_in">create</span></span>(<span class="hljs-string"><span class="hljs-string">"char_1"</span></span>) ch1.moveto(<span class="hljs-string"><span class="hljs-string">"workout"</span></span>) ch2.moveto(<span class="hljs-string"><span class="hljs-string">"fridge"</span></span>) ch2.wait_move_finish() ch1.wait_move_finish() vh.trace(<span class="hljs-string"><span class="hljs-string">"finished ok"</span></span>)</code> </pre><br>  The script creates two sprites of characters, moves the first one to the ‚Äúworkout‚Äù point, the second one - to the ‚Äúfridge‚Äù point, then waits for both to finish their movement, and only then writes ‚Äúfinished ok‚Äù. <br><br>  From the documentation I can advise only the <a href="http://www.lua.org/manual/5.2/manual.html">Lua 5.2 Reference Manual</a> , where all these shamanism are described, albeit slightly for a different implementation. <br><br>  <b>All articles in the series:</b> <br><ol><li>  <a href="http://habrahabr.ru/post/210534/">Idea, vision, choice of setting, platform, distribution model, etc.</a> </li><li>  <a href="http://habrahabr.ru/post/211140/">Shaders for styling images under the CRT / LCD</a> </li><li>  <a href="http://habrahabr.ru/post/211576/">We fasten the scripting language to Unity (UniLua)</a> </li><li>  <a href="http://habrahabr.ru/post/213253/">Shader for fade in on the palette (a la NES)</a> </li><li>  <a href="http://habrahabr.ru/post/214799/">Subtotal (prototype)</a> </li><li>  <a href="http://habrahabr.ru/post/225761/">Let's talk about the indie games</a> </li><li>  <a href="http://habrahabr.ru/post/235011/">2D animations in Unity ("as in flash")</a> </li><li>  <a href="http://habrahabr.ru/post/244493/">Visual scripting of cut scenes in Unity (uScript)</a> </li></ol></div><p>Source: <a href="https://habr.com/ru/post/211576/">https://habr.com/ru/post/211576/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../211566/index.html">Google will show ads on competitors in search results: EU antitrust investigation results</a></li>
<li><a href="../211568/index.html">Freedom from habits. Myth or fiction?</a></li>
<li><a href="../211570/index.html">IBM improves graphene transistors</a></li>
<li><a href="../211572/index.html">We set up our own SMTP server on the Jelastic platform in the InfoboxCloud cloud</a></li>
<li><a href="../211574/index.html">Modifying UEFI BIOS, Part One: Introduction to UEFITool</a></li>
<li><a href="../211578/index.html">FreeRTOS + STM32F4 C ++ for Linux</a></li>
<li><a href="../211580/index.html">What exactly do I hate for some individual marketers - or as an IT pros go shopping</a></li>
<li><a href="../211582/index.html">Results of CES 2014: Samsung AV News</a></li>
<li><a href="../211584/index.html">Dr.Web for licensed content</a></li>
<li><a href="../211588/index.html">Live webcast ALM Summit</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>