<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Entity Framework 6 (7) vs NHibernate 4: a DDD perspective</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The network already has quite a few comparisons of the Entity Framework and NHibernate, but all of them mostly focus on the technical side of the issu...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Entity Framework 6 (7) vs NHibernate 4: a DDD perspective</h1><div class="post__text post__text-html js-mediator-article">  The network already has quite a few comparisons of the Entity Framework and NHibernate, but all of them mostly focus on the technical side of the issue.  In this article, I would like to compare these two technologies in terms of Domain Driven Design (DDD).  We will look at a few code examples and see how these two ORMs allow us to cope with difficulties. <br><br><a name="habracut"></a><br><br><h2>  Layered architecture (Onion architecture) </h2>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/getpro/habr/post_images/e1f/a3c/7a8/e1fa3c7a868346a30b352989df752e6e.png" alt="image"><br><br>  Today, it is quite common practice to use Onion (layered) architecture to design complex systems.  It allows you to isolate domain logic from the rest of the system so that we can focus on the most important parts of the application. <br><br>  Isolation of domain logic means that <b>domain classes can interact only with other domain classes</b> .  This is one of the most important principles to follow in order to make the code clean and coherent. <br><br>  The picture below shows the onion architecture using the classic n-tier scheme. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1f6/c70/46a/1f6c7046a0c593b0b4d7f308832a485a.png" alt="image"><br><br><h2>  Persistence ignorance </h2><br>  When using the ORM, it is important to maintain a good degree of isolation between the domain logic and the logic of storing data in the database (Persistence Ignorance).  This means that the code should be structured in such a way that all the logic relating to storing data in the database is removed from the domain classes.  Ideally, <b>domain entities should not contain any information about how they are stored in the database</b> .  Following this rule allows you to adhere to the <a href="https://ru.wikipedia.org/wiki/%25D0%259F%25D1%2580%25D0%25B8%25D0%25BD%25D1%2586%25D0%25B8%25D0%25BF_%25D0%25B5%25D0%25B4%25D0%25B8%25D0%25BD%25D1%2581%25D1%2582%25D0%25B2%25D0%25B5%25D0%25BD%25D0%25BD%25D0%25BE%25D0%25B9_%25D0%25BE%25D0%25B1%25D1%258F%25D0%25B7%25D0%25B0%25D0%25BD%25D0%25BD%25D0%25BE%25D1%2581%25D1%2582%25D0%25B8">principle of a single duty</a> and, thus, keep the code simple and supported. <br><br>  If you write code similar to the example below, you are on the wrong path: <br><br><pre><code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> MyEntity { // Perstisted <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> the DB <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">int</span></span> Id { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> string <span class="hljs-type"><span class="hljs-type">Name</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } // <span class="hljs-keyword"><span class="hljs-keyword">Not</span></span> persisted <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-type"><span class="hljs-type">bool</span></span> Flag { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } }</code> </pre> <br><br>  If the domain logic is separated from the data retention logic, it can be said that the domain classes are persistence ignorant.  This means that you can change the way in which you save data to the database without affecting the domain logic.  Persistence ignorance is a prerequisite for isolating domain logic. <br><br><h2>  Example 1: Deleting a child entity from an aggregate root </h2><br>  Let's look at code samples from real projects. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/651/91c/380/65191c38045eca1fb682a3ab11eacd06.png" alt="image"><br><br>  The figure above shows a <a href="http://martinfowler.com/bliki/DDD_Aggregate.html">unit</a> containing two classes.  The Order class is the root of the aggregate.  This means that Order controls the lifetime of the objects in the Lines collection.  If the Order is deleted, the objects from this collection will be deleted along with it;  OrderLine cannot exist without an Order object. <br><br>  Suppose we need to implement a method that removes one of the items in the order.  Here is how we can implement this if our code is not associated with any ORM: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> ICollection&lt;OrderLine&gt; Lines { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OrderLine line</span></span></span><span class="hljs-function">)</span></span> { Lines.Remove(line); }</code> </pre><br><br>  You simply delete the position from the collection, and that's it.  As long as the order is the root of an aggregate, customers of this class can access its positions only through a reference to the Order object.  If it does not have this position, we can assume that it is deleted, because  other objects cannot keep references to child objects of the aggregate. <br><br>  If you try to execute this code using the Entity Framework, you will get an exception: <br><br>  <i>It is not a nillable.</i> <br><br>  In the Entity Framework, there is no way to set the mapping so that deleted items from the collection (orphaned) are automatically removed from the database.  You need to do it yourself: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;OrderLine&gt; Lines { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OrderLine line, OrdersContext db</span></span></span><span class="hljs-function">)</span></span> { Lines.Remove(line); db.OrderLines.Remove(line); }</code> </pre><br><br>  Passing OrdersContext to the domain object method violates the principle of <a href="http://enterprisecraftsmanship.com/2014/12/06/separation-of-concerns-in-orm/">responsibility sharing</a> , since  class Order in this case contains information about how it is stored in the database. <br><br>  Here's how it can be done in NHibernate: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> IList&lt;OrderLine&gt; Lines { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">virtual</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RemoveLine</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">OrderLine line</span></span></span><span class="hljs-function">)</span></span> { Lines.Remove(line); }</code> </pre><br><br>  Note that this code is almost inefficient to the code that we would write if we didn‚Äôt need to save data to the database.  You can tell NHibernate to remove positions from the database automatically after they are removed from the collection: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> OrderMap : ClassMap&lt;<span class="hljs-keyword"><span class="hljs-keyword">Order</span></span>&gt; { <span class="hljs-built_in"><span class="hljs-built_in">public</span></span> OrderMap() { Id(x =&gt; x.Id); HasMany(x =&gt; x.Lines).<span class="hljs-keyword"><span class="hljs-keyword">Cascade</span></span>.AllDeleteOrphan().Inverse(); } }</code> </pre><br><br><h2>  Example 2: Link to related entity </h2><br><img src="https://habrastorage.org/getpro/habr/post_images/e00/bff/192/e00bff1927c842147b68402546f7a027.png" alt="image"><br><br>  Suppose that in one of the classes we need to add a link to the associated class.  Here is a sample code, not tied to any ORM: <br><br><pre> <code class="hljs swift"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderLine</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-type"><span class="hljs-type">Order</span></span> <span class="hljs-type"><span class="hljs-type">Order</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Other members }</span></span></code> </pre><br><br>  Here is how this is done in the default Entity Framework: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderLine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Order Order { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> OrderId { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Other members }</span></span></code> </pre><br><br>  The default method in NHibernate is: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrderLine</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> Order Order { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-comment"><span class="hljs-comment">// Other members }</span></span></code> </pre><br><br>  As you can see, by default, in the Entity Framework, you need to add an additional property with an identifier in order to associate two entities.  This approach violates the principle of sole responsibility: identifiers are part of the implementation of how data is stored in the database;  domain objects should not contain such information.  The Entity Framework encourages you to work directly with database terms, while in this case the best solution would be to create a single Order property and give up the rest of the work of the ORM itself. <br><br>  Moreover, this code violates the principle <a href="https://ru.wikipedia.org/wiki/Don%25E2%2580%2599t_repeat_yourself">do not repeat yourself</a> .  Declaring both OrderId and Order allows the OrderLine class to very easily go to the inconsistent state: <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">Order</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">order</span></span>; // An <span class="hljs-keyword"><span class="hljs-keyword">order</span></span> <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> Id == <span class="hljs-number"><span class="hljs-number">1</span></span> OrderId = <span class="hljs-number"><span class="hljs-number">2</span></span>;</code> </pre><br><br>  It should be noted that EF still allows you to declare references to related entities without specifying a separate identifier property, but this approach has two drawbacks: <br>  - Access to the identifier of the associated object (i.e. orderLine.Order.Id) results in loading the entire object from the database, despite the fact that this identifier is already in memory.  NHibernate, in turn, is smart enough and does not load the associated object from the database if the client accesses its Id. <br>  - Entity Framework encourages developers to use identifiers.  Partly due to the fact that this is the default way to refer to related entities, partly due to the fact that all the examples in the documentation use this approach.  In NHibernate, by contrast, the default way to declare a link to a related entity is a link to an object of that entity. <br><br><h2>  Example 3: Read-only collection of related entities </h2><br>  If you want a collection of positions in the order with a read-only collection for customers of this class, you can write the following code (a version that is not tied to any ORM): <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">private</span></span> List&lt;OrderLine&gt; _lines; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> IReadOnlyList&lt;OrderLine&gt; Lines { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _lines.ToList(); } }</code> </pre><br><br>  The official way to do this in EF is: <br><br><pre> <code class="hljs cpp"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class"> {</span></span> <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;OrderLine&gt; LinesInternal { get; <span class="hljs-built_in"><span class="hljs-built_in">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> IReadOnlyList&lt;OrderLine&gt; Lines { get { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LinesInternal.ToList(); } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderConfiguration</span></span></span><span class="hljs-class"> :</span></span> EntityTypeConfiguration&lt;Order&gt; { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OrderConfiguration</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HasMany(p =&gt; p.LinesInternal).WithRequired(x =&gt; x.Order); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrdersContext</span></span></span><span class="hljs-class"> :</span></span> DbContext { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> override </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(DbModelBuilder modelBuilder)</span></span></span><span class="hljs-function"> </span></span>{ modelBuilder.Configurations.Add(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Order.OrderConfiguration()); } }</code> </pre><br><br>  Obviously, this is not the way you want to use when designing a domain model, since  it directly mixes the infrastructure logic with the domain one.  The unofficial way is not much better: <br><br><pre> <code class="hljs cs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Order</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> Expression&lt;Func&lt;Order, ICollection&lt;OrderLine&gt;&gt;&gt; LinesExpression = f =&gt; f.LinesInternal; <span class="hljs-keyword"><span class="hljs-keyword">protected</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> ICollection&lt;OrderLine&gt; LinesInternal { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">set</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">virtual</span></span> IReadOnlyList&lt;OrderLine&gt; Lines { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> LinesInternal.ToList(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">OrdersContext</span></span> : <span class="hljs-title"><span class="hljs-title">DbContext</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">protected</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">override</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">OnModelCreating</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">DbModelBuilder modelBuilder</span></span></span><span class="hljs-function">)</span></span> { modelBuilder.Entity&lt;Order&gt;() .HasMany(Order.LinesExpression); } }</code> </pre><br><br>  Again, the Order class contains the infrastructure code.  In the Entity Framework there is no way that would allow the separation of the infrastructure code from the domain code in such cases. <br><br>  Here's how to do this with NHibernate: <br><br><pre> <code class="hljs kotlin"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Order</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> IList&lt;OrderLine&gt; _lines; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> virtual IReadOnlyList&lt;OrderLine&gt; Lines { <span class="hljs-keyword"><span class="hljs-keyword">get</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> _lines.ToList(); } } } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">OrderMap</span></span></span><span class="hljs-class"> : </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ClassMap</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">Order</span></span></span><span class="hljs-class">&gt; </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> OrderMap() { HasMany&lt;OrderLine&gt;(Reveal.Member&lt;Order&gt;(‚ÄúLines‚Äù)) .Access.CamelCaseField(Prefix.Underscore); } }</code> </pre><br><br>  Again, the code above is almost identical to code that is not tied to any ORM.  The Order class here is clean and does not contain any information about how it is stored in the database, which allows us to focus on the subject area. <br><br>  Code using NHibernate has one flaw.  It is prone to errors when refactoring, because  The property name is specified as a string.  However, this is a reasonable compromise, because  This approach allows you to clearly separate the logic of the subject area from the logic of storing data in the database.  In addition, such errors are quite easily caught by integration tests. <br><br><h2>  Example 4: Unit of Work Pattern </h2><br>  Below is the code from the task I was working on a couple of years ago.  I omitted details for krakost, but the main idea should be clear: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">public</span></span> IList&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; MigrateCustomers(IEnumerable&lt;CustomerDto&gt; customerDtos, CancellationToken token) { List&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt; ids = <span class="hljs-built_in"><span class="hljs-built_in">new</span></span> List&lt;<span class="hljs-type"><span class="hljs-type">int</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ISession <span class="hljs-keyword"><span class="hljs-keyword">session</span></span> = CreateSession()) <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> (ITransaction <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span> = <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.BeginTransaction()) { <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (CustomerDto dto <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> customerDtos) { token.ThrowIfCancellationRequested(); Customer customer = CreateCustomer(dto); <span class="hljs-keyword"><span class="hljs-keyword">session</span></span>.Save(customer); ids.<span class="hljs-keyword"><span class="hljs-keyword">Add</span></span>(customer.Id); } <span class="hljs-keyword"><span class="hljs-keyword">transaction</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">Commit</span></span>(); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ids; }</code> </pre><br><br>  The method takes some data, converts it into domain objects and stores thereafter.  It returns a list of customer identifiers.  External code can mark the migration process using the CancellationToken passed as a parameter. <br><br>  If you use the Entity Framework for this task, it will insert records into the database as they are saved in the session in order to get Id, since  The only available strategy for generating integer identifiers in EF is database identity.  This approach works quite well in most cases, but it has a significant drawback: it violates the principle of the <a href="http://martinfowler.com/eaaCatalog/unitOfWork.html">Unit of Work</a> .  If the calling code cancels the execution of the method, EF will have to delete all the records inserted in the database at the time of the cancellation, which results in a significant performance drop. <br><br>  With NHibernate, you can choose the Hi / Lo strategy, so the records will simply not be saved in the database until the session is closed.  In this case, identifiers are generated on the client, so there is no need to save records in the database in order to receive them.  NHibernate can help save a significant amount of time in tasks of this type. <br><br><h2>  Example 5: Work with cached objects </h2><br>  Suppose that the list of your clients does not change often and you decide to cache it so as not to refer to the database each time to receive it.  Suppose also that the order class has a precondition according to which each order should belong to one of the customers.  You can implement this precondition using the constructor: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Order</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Customer customer</span></span></span><span class="hljs-function">)</span></span> { Customer = customer; }</code> </pre><br><br>  Thus, we can be sure that no order will be created without specifying its customer. <br><br>  With the Entity Framework, you cannot assign a reference to a detached object to a new object.  If you write the code as in the example above, EF will try to insert the client into the database, since  he was not attached to the current context.  To fix this, you need to explicitly indicate that the customer already exists in the database: <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Order</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">Customer customer, OrdersContext context</span></span></span><span class="hljs-function">)</span></span> { context.Entry(customer).State = EntityState.Unchanged; Customer = customer; }</code> </pre><br><br>  Again, this approach violates the principle of sole responsibility and establishes a relationship between the domain and infrastructure logic.  Unlike EF, NHibernate can determine whether a customer object is new by its identifier and does not attempt to insert it into the database if it is already present there.  The version of the code that uses NHibernate is the same as the version without ORM. <br><br><h2>  results </h2><br>  There is an easy way to measure how well ORM allows you to isolate domain logic from the logic of storing data in the database.  <b>The closer the code that uses ORM to the code that is not tied to any ORM, the better this ORM allows to share responsibilities in the code</b> . <br><br>  EF is too closely tied to the database.  When you write code with the Entity Framework, you constantly have to think in terms of foreign-key constraints and relationships between tables.  Without a clean and isolated domain model, your attention is constantly distracted, you cannot focus on the logic of the domain. <br><br>  The peculiarity here is that you may not notice these distractions until your system grows to a sufficiently large size.  And when this happens, it becomes really difficult to maintain the old level of development of new functionality due to the increased cost of maintaining the current code. <br><br>  In sum, NHibernate is still ahead of the Entity Framework.  In addition to a better degree of isolation of the domain code from the infrastructure logic, NHibernate has quite a few useful features that are not found in the Entity Framework: level 2 cache, strategies for simultaneous access to data in the database (concurrency strategies), more flexible ways of data mapping, etc. .  Perhaps the only thing that EF boasts is a non-casting I / O when working with a database (async database operations). <br><br>  What is the matter?  The Entity Framework has been under development for many years, hasn‚Äôt it?  Unfortunately, apparently, nobody in the EF team considers ORM from the point of view of DDD.  The Entity Framework team is still thinking about ORM in terms of data, and not in terms of model.  This means that, despite the fact that the Entity Framework is a good tool in many simple situations, if you are working on more complex projects, NHibernate will be the best choice for you. <br><br>  As for me, this situation is very disappointing.  With all the support that EF receives from Microsoft and with all the confidence that developers put into it due to the fact that this is a recommended (and default for many) ORM, Entity Framework could be better.  Apparently, once again, Microsoft did not take into account the experience of the community and went their own way. <br><br><h2>  Update </h2><br>  The program manager of the Entity Framework team at Microsoft Rowan Miller <a href="http://blogs.msdn.com/b/adonet/archive/2014/05/19/ef7-new-platforms-new-data-stores.aspx">responded</a> that some of the problems described above will be fixed in EF7.  Although this is only a part, let's hope that the EF will change for the better in the future. <br><br>  Link to original article: <a href="http://enterprisecraftsmanship.com/2014/11/29/entity-framework-6-7-vs-nhibernate-4-ddd-perspective/" title="Entity Framework vs NHibernate">NHibernate vs Entity Framework</a> </div><p>Source: <a href="https://habr.com/ru/post/262407/">https://habr.com/ru/post/262407/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../262393/index.html">Video Switch for TV</a></li>
<li><a href="../262395/index.html">Working environment for "lazy" web developers (Vagrant + Scotchbox)</a></li>
<li><a href="../262397/index.html">Your cloud hosting in 5 minutes. Part 2: Service Discovery</a></li>
<li><a href="../262401/index.html">PHP Digest number 66 - interesting news, materials and tools (June 28 - July 12, 2015)</a></li>
<li><a href="../262403/index.html">40+ useful tools for the developer of applications for Android</a></li>
<li><a href="../262409/index.html">Introduction to Octopus Deploy</a></li>
<li><a href="../262411/index.html">Fundamentals of successful implementation of push notifications for mobile applications</a></li>
<li><a href="../262413/index.html">What do anti-virus protection profiles provide?</a></li>
<li><a href="../262415/index.html">Objective C Class Organization</a></li>
<li><a href="../262419/index.html">Windows Remote Arduino - control a desk lamp directly from a universal Windows application</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>