<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Create an isomorphic / universal application on Next.JS + Redux</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This is the second article on Server Side Rendering and Isomorphic / Universal React applications. The first one titled ‚Äú Simplifying the universal / ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Create an isomorphic / universal application on Next.JS + Redux</h1><div class="post__text post__text-html js-mediator-article"><p>  This is the second article on Server Side Rendering and Isomorphic / Universal React applications.  The first one titled ‚Äú <a href="https://habrahabr.ru/post/323500/">Simplifying the universal / isomorphic application on React + Router + Redux + Express</a> ‚Äù was more about a custom solution, the same article is aimed more at those who do not want to bother, but want a ready-made solution, with the community, and generally less headaches with setup, debugging, selection of libraries, etc. </p><br><p><img src="https://habrastorage.org/getpro/habr/post_images/db7/5d9/8d9/db75d98d94cc57a2fe2e01ff9328375b.png" height="60">  + <img src="https://habrastorage.org/getpro/habr/post_images/360/603/20d/36060320dcbdf438d24d050e41107c66.png" height="80"></p><br><p>  In this article we will consider <a href="https://zeit.co/blog/next">Next.JS</a> , which has advantages in the form of lack of configuration, server rendering and a ready ecosystem. </p><br><p>  Out of the box, Next.JS does not know how to work with Redux, so in the process of writing a trial project, I selected the resulting common code into a separate repository <a href="https://github.com/kirill-konshin/next-redux-wrapper">next-redux-wrapper</a> , with which in this article we will build an example application on Next.JS + Redux. <a name="habracut"></a></p><br><h1 id="o-chem-vse-eto">  What is it all about </h1><br><p>  For newcomers, I remind you that the essence of server rendering is quite simple: on the server we need to determine, based on the rules of the router, which component will be shown on the page, find out what data it needs to work, request this data, render HTML, and send this HTML along with data to the client. </p><br><p>  Nowadays, solutions such as the <a href="https://github.com/facebookincubator/create-react-app">Create React App</a> , which postulate the "configuration zero" approach, are rapidly gaining popularity, everything is set up by one team, it works right out of the box, but contains a lot of restrictions, and it does not have server rendering at all.  You can read my article on this topic: <a href="https://habrahabr.ru/post/323458">What to take as a basis React applications</a> . </p><br><p>  For this there are alternatives like <a href="https://zeit.co/blog/next">Next.JS</a> and <a href="http://electrode.io/">Electrode</a> .  Why not take them and forget about the torment?  Or do not forget?  Maybe things will only get worse.  But in fact, it all depends on the task, and in order to quickly slap the application there is usually enough flexibility, but here are some limitations to keep in mind when starting work with Next.JS: </p><br><ol><li> It does not have a React Router, routing out of the box is very stupid, and even the path with substitutions of the form <code>/path/:id/:foo</code> does not know how (there are separate solutions for this), but at least there is support for the <code>query</code> . </li><li>  Does not support importing CSS / LESS / SASS, etc., instead there is CSS in JSX, but you can add styles directly to the document, but then their Hot Reload will not work. </li><li>  The configuration of the Webpack (which is used internally), although it can be changed manually, but the addition of Loaders is not strongly recommended. </li></ol><br><h1 id="zhiznennyy-cikl-nextjs">  Next.js life cycle </h1><br><p>  In the process of rendering pages, the mini-router takes the corresponding file from the <code>./pages</code> directory, takes default export from it and uses the static <code>getInitialProps</code> method from the exported component in order to throw these props into it.  The method can be asynchronous, i.e.  return <code>Promise</code> .  This method is called both on the server and on the client, the only difference is in the number of arguments received, for example, there is a <code>req</code> on the server (which is a NodeJS Request).  Both the client and server get the normalized <code>pathname</code> and <code>query</code> . </p><br><p>  The code for the page looks like this: </p><br><pre> <code class="hljs scala">export <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Page</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Component</span></span></span><span class="hljs-class"> </span></span>{ getInitialProps({pathname, query}) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {custom: <span class="hljs-symbol"><span class="hljs-symbol">'custo</span></span>m'}; <span class="hljs-comment"><span class="hljs-comment">//     props   } render() { return ( &lt;div&gt; &lt;div&gt;Prop from getInitialProps {this.props.custom}&lt;/div&gt; &lt;/div&gt; ) } }</span></span></code> </pre> <br><p>  Or in a functional style: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Page = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{custom}</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Prop from getInitialProps {this.props.custom}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); Page.getInitialProps = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{pathname, query}</span></span></span><span class="hljs-function">) =&gt;</span></span> ({ <span class="hljs-attr"><span class="hljs-attr">custom</span></span>: <span class="hljs-string"><span class="hljs-string">'custom'</span></span> }); <span class="hljs-keyword"><span class="hljs-keyword">export</span></span> <span class="hljs-keyword"><span class="hljs-keyword">default</span></span> Page;</code> </pre> <br><p>  The static <code>getInitialProps</code> method <code>getInitialProps</code> ideally suited as a place where we can otdatcatch some actions to bring the Redux Store in the right state, so that then during the rendering the page can read all the necessary data from there. </p><br><pre> <code class="hljs pgsql">getInitialProps({store, pathname, query}) { // component will <span class="hljs-keyword"><span class="hljs-keyword">read</span></span> it <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> stor<span class="hljs-string"><span class="hljs-string">e's state when rendered store.dispatch({type: '</span></span>FOO<span class="hljs-string"><span class="hljs-string">', payload: '</span></span>foo<span class="hljs-string"><span class="hljs-string">'}); // pass some custom props to component return {custom: '</span></span>custom<span class="hljs-string"><span class="hljs-string">'}; }</span></span></code> </pre> <br><p>  But in order for this to work, the Store needs to be created somewhere, both on the server and on the client, and on the Store client, as a rule, always one, and on the server it must be created for each request separately. </p><br><p>  In addition to the <code>getInitialProps</code> argument <code>getInitialProps</code> the same Store should be provided to Redux Provider so that all the components nested in it can access the Store. </p><br><p>  The Higher Order Components concept is best suited for this purpose.  In two words, it is a function that takes a component as an argument and returns its wrapped version, which is also a component, for example, React Router <code>withRouter(Cmp)</code> .  Sometimes a function can take arguments and return another function that the component already accepts; this is called currying, for example React Redux <code>connect(mapStateToProps, mapDispathToProps)(Cmp)</code> .  The wrapper that we are going to use must be applied to all pages in order to be sure that all the initial conditions are always the same. </p><br><h1 id="sozdanie-prilozheniya">  Create application </h1><br><p>  First, put all the packages: </p><br><pre> <code class="bash hljs">npm install next-redux-wrapper next@^2.0.0-beta redux react-redux --save</code> </pre> <br><p>  Create the things needed for Redux: </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> React, {Component} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"react"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> {createStore} <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"redux"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> reducer = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">state = {foo: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">''</span></span></span></span><span class="hljs-function"><span class="hljs-params">}, action</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">switch</span></span> (action.type) { <span class="hljs-keyword"><span class="hljs-keyword">case</span></span> <span class="hljs-string"><span class="hljs-string">'FOO'</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {...state, <span class="hljs-attr"><span class="hljs-attr">foo</span></span>: action.payload}; <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> state } }; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> makeStore = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">initialState</span></span></span><span class="hljs-function">) =&gt;</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> createStore(reducer, initialState); };</code> </pre> <br><p>  Now wrap the page in <code>next-redux-wrapper</code> : </p><br><pre> <code class="hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> withRedux <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> <span class="hljs-string"><span class="hljs-string">"next-redux-wrapper"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">const</span></span> Page = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{foo, custom}</span></span></span><span class="hljs-function">) =&gt;</span></span> ( <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Prop from Redux {foo}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml">Prop from getInitialProps {custom}</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span><span class="xml"> </span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">div</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span> ); Page.getInitialProps = <span class="hljs-function"><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">{store, isServer, pathname, query}</span></span></span><span class="hljs-function">) =&gt;</span></span> { store.dispatch({<span class="hljs-attr"><span class="hljs-attr">type</span></span>: <span class="hljs-string"><span class="hljs-string">'FOO'</span></span>, <span class="hljs-attr"><span class="hljs-attr">payload</span></span>: <span class="hljs-string"><span class="hljs-string">'foo'</span></span>}); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> {<span class="hljs-attr"><span class="hljs-attr">custom</span></span>: <span class="hljs-string"><span class="hljs-string">'custom'</span></span>}; }; <span class="hljs-comment"><span class="hljs-comment">//    makeStore     Page = withRedux(makeStore, (state) =&gt; ({foo: state.foo}))(Page); export default Page;</span></span></code> </pre> <br><p>  <a href="">You can also dispute Promise</a> , in which case you will need to wait for its completion and even then return the initial props. </p><br><p>  That's all.  All the magic happens inside the wrapper, and from the outside we see a clean and beautiful implementation.  You can see the full example in the Next.js repository: <a href="">https://github.com/zeit/next.js/blob/master/examples/with-redux/README.md</a> or look at the example in the wrapper repository: <a href="">https: // github .com / kirill-konshin / next-redux-wrapper / blob / master / pages / index.js</a> . </p><br><p>  To start, just write in the console: </p><br><pre> <code class="bash hljs">node_modules/.bin/next</code> </pre> <br><h1 id="ps">  PS </h1><br><p>  I found one unpleasant moment, if you want to use <code>pages/_document.js</code> (which allows you to build a template for the entire page) and dispatch actions from its <code>getInitialProps</code> , as well as from the destination page, then race condition may occur.  The order of calling these functions is not particularly controlled and it may happen that they will work in parallel, therefore at the moments when the page template is rendered and the page itself the state may be different. </p><br><p>  The wrapper itself supports this script, because it stores the Store in the request itself, and also ensures that there is always one on the Store client.  However, the authors of Next.js say that it is a bad practice to have disputes in <code>_document.js</code> .  They propose instead to write another HOC, already a custom one, and do everything there, but this remains outside the scope of the article. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/323588/">https://habr.com/ru/post/323588/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323578/index.html">Shamoon Returns: Saudi Oil Hunt</a></li>
<li><a href="../323580/index.html">25 practical examples of using iBeacon technology in retail</a></li>
<li><a href="../323582/index.html">Can bosses like change</a></li>
<li><a href="../323584/index.html">Logging in Yii 2.0 and PSR-3</a></li>
<li><a href="../323586/index.html">Blockchain 200 lines of code</a></li>
<li><a href="../323590/index.html">Electrical circuit simulation</a></li>
<li><a href="../323592/index.html">Recruitment to St. Petersburg Academic University</a></li>
<li><a href="../323594/index.html">Localization of Unity games in Hindi</a></li>
<li><a href="../323596/index.html">‚ÄúExclude cannot be used‚Äù - new risk management method</a></li>
<li><a href="../323598/index.html">Digitizing sound on STM32 (ADC + DMA) and encoding to Speex for transmission</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>