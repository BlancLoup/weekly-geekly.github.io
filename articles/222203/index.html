<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Sphinx - Distributed Search. Running REPLACE for the distributed index</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article is aimed at those who already know what Sphinx and SphinxQL are. 
 Objective: To ensure the continuity of the site search with the help of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Sphinx - Distributed Search. Running REPLACE for the distributed index</h1><div class="post__text post__text-html js-mediator-article">  The article is aimed at those who already know what Sphinx and SphinxQL are. <br>  Objective: To ensure the continuity of the site search with the help of Sphinx at the time of the technical work on one of the Sphinx nodes of the cluster. <br><br>  Sphinx is an excellent tool for organizing site searches.  In the project in which I participate, the search for ads takes place using Sphinx.  The ads are stored in the database in the EAV model and the search for them is performed by Sphinx and then the ads are retrieved by the identifiers found in Sphinx.  Thus, if Sphinx stops working, it will affect the whole site. <br><br>  For work, rt sphinx indices are used to instantly make changes to the search results if an ad is edited or banned.  As long as it worked on one node, everything was fine until there was no need to make changes to the structure of the indices themselves.  To change the list of attributes in the search index, it was necessary to edit the configuration, restart the sphinx and re-index the ads.  In order to do this without stopping the site, it was decided to build a cluster with one main node actually performing the role of a balancer and two child nodes containing an index and being mirrored among themselves. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Setting up the indexer and searchd sections is generally normal</b> <div class="spoiler_text"><pre><code class="hljs pgsql">indexer { } searchd { <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3301</span></span> #   Sphinx Api <span class="hljs-keyword"><span class="hljs-keyword">listen</span></span> = <span class="hljs-number"><span class="hljs-number">127.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.1</span></span>:<span class="hljs-number"><span class="hljs-number">3309</span></span>:mysql41 #   SphinxQL <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> = ./sphinx-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-searchd.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> query_log = ./sphinx-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-query.<span class="hljs-keyword"><span class="hljs-keyword">log</span></span> pid_file = ./sphinx-<span class="hljs-keyword"><span class="hljs-keyword">log</span></span>-searchd.pid binlog_path = ./sphinx-binlog read_timeout = <span class="hljs-number"><span class="hljs-number">5</span></span> max_children = <span class="hljs-number"><span class="hljs-number">30</span></span> max_matches = <span class="hljs-number"><span class="hljs-number">1000</span></span> seamless_rotate = <span class="hljs-number"><span class="hljs-number">1</span></span> preopen_indexes = <span class="hljs-number"><span class="hljs-number">0</span></span> unlink_old = <span class="hljs-number"><span class="hljs-number">1</span></span> workers = threads }</code> </pre> <br></div></div><br>  To organize a search cluster in Sphinx there are distributed indexes. <br>  On the main node, all indexes have the following form. <br><pre> <code class="sql hljs">index distributed_section_1 { type = distributed agent = 127.0.0.1:9301:rt_section_1|127.0.0.1:9302:rt_section_1 ha_strategy = nodeads }</code> </pre><br>  By the way, there is a difference between how to describe the child nodes, in the previous example, they are described as mirrors, and in the following they are described as nodes that store two different parts of the same index.  The difference is that in the first case, the select request is sent to one of the nodes, and in the second example, the select is sent to all the nodes and the search result from each of the nodes is combined. <br><pre> <code class="sql hljs">index distributed_section_1 { type = distributed agent = 127.0.0.1:9301:rt_section_1 agent = 127.0.0.1:9302:rt_section_1 ha_strategy = nodeads <span class="hljs-comment"><span class="hljs-comment">#     . nodeads -       }</span></span></code> </pre><br>  On child nodes, indices are described as the most common real time indices in Sphinx: <br><pre> <code class="sql hljs">index rt_section_1 { type = rt mlock = 1 morphology = stem_en, stem_ru min_word_len = 3 min_infix_len = 1 index_exact_words = 1 dict = keywords path = ./notices_rt_section_1 rt_field = title rt_field = text rt_attr_uint = date rt_attr_uint = active rt_attr_multi = location }</code> </pre><br>  Everything with sampling on the cluster is no problem. <br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> rt_section_1; +<span class="hljs-comment"><span class="hljs-comment">---------+------------+--------+----------+ | id | date | active | location | +---------+------------+--------+----------+ | 185191 | 1398749772 | 1 | 145430 | | 185234 | 1398749771 | 1 | 145425 | +---------+------------+--------+----------+ 2 rows in set (0.03 sec)</span></span></code> </pre><br>  It already seemed to me that the problem was solved on this, but it was not the same.  The sample works, and what about the REPLACE or INSERT requests? <br>  As it turned out, <a href="http://sphinxsearch.com/bugs/view.php%3Fid%3D1701">there was an ambush here</a> - REPLACE and INSERT by default work only on local indexes, and I use distributed. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      But it does not matter.  Since the sphinx project is open source, I made <a href="https://github.com/Levhav/sphinxsearch">my own assembly</a> that allows you to perform REPLACE queries on distributed indexes. <br>  To build <a href="https://github.com/Levhav/sphinxsearch">it you need to download the source</a> and run the command <br><pre> <code class="bash hljs">cmake . &amp;&amp; make</code> </pre><br>  Now, running this build with exactly the same settings as before, the query will be executed on all the mirror nodes. <br><pre> <code class="sql hljs">mysql&gt; <span class="hljs-keyword"><span class="hljs-keyword">REPLACE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> rt_section_130054 (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, <span class="hljs-string"><span class="hljs-string">`location`</span></span>, <span class="hljs-string"><span class="hljs-string">`title`</span></span>, <span class="hljs-string"><span class="hljs-string">`text`</span></span>, <span class="hljs-string"><span class="hljs-string">`active`</span></span>, <span class="hljs-string"><span class="hljs-string">`date`</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> ( <span class="hljs-number"><span class="hljs-number">2435558</span></span>, ( <span class="hljs-number"><span class="hljs-number">145411</span></span> ) , <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-string"><span class="hljs-string">' '</span></span>, <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'1399529047'</span></span>); Query OK, 2 rows affected (0.04 sec)</code> </pre><br>  I used two mirrors for testing, and we see that 2 records are affected, that is, one record on each node. </div><p>Source: <a href="https://habr.com/ru/post/222203/">https://habr.com/ru/post/222203/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../222195/index.html">A coward does not play air hockey: how to win when there is no chance</a></li>
<li><a href="../222199/index.html">Squeeze the maximum out of DDMS</a></li>
<li><a href="../2222/index.html">South Korean company technologies used in MS Office illegally</a></li>
<li><a href="../22220/index.html">What we pay for when buying Windows Server 2008. Part 2: Server Core and RODC.</a></li>
<li><a href="../222201/index.html">Arduino Pro Mini Firmware via Nano</a></li>
<li><a href="../222207/index.html">Survey: what methodology is used in your project or how much we have through it?</a></li>
<li><a href="../222209/index.html">New scanning business cards in Evernote with LinkedIn</a></li>
<li><a href="../222211/index.html">The smallest comics in the world "painted" on the tip of the hair</a></li>
<li><a href="../222213/index.html">HealthWatch seeks FDA approval for its T-shirt tracking ECG</a></li>
<li><a href="../222219/index.html">PHP New Generation</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>