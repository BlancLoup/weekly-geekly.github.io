<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Time Machine: backup OS X Lion on Ubuntu 12.04 LTS server</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="If anyone knows, Time Machine is such a great backup service out of the box for Apple OS X, here and here you can read more. If you have a poppy, and ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Time Machine: backup OS X Lion on Ubuntu 12.04 LTS server</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/847/208/08a/84720808a1974d6874b8fd51f20d64f9.png"><br><img src="https://habrastorage.org/storage2/5b4/a39/bf5/5b4a39bf526910e4467b6ff2ce28cce0.png"><br><br>  If anyone knows, Time Machine is such a great backup service out of the box for Apple OS X, <a href="http://ru.wikipedia.org/wiki/Time_Machine_(%25D0%25BF%25D1%2580%25D0%25BE%25D0%25B3%25D1%2580%25D0%25B0%25D0%25BC%25D0%25BC%25D0%25B0)">here</a> and <a href="http://www.apple.com/ru/macosx/apps/">here</a> you can read more.  If you have a poppy, and you do not use the "time machine", then it is absolutely in vain.  Time Machine makes permanent differential backups, so it is convenient even in the case of the wonderful life of your HDD / SSD.  You can unscrew the history at any time and restore the accidentally deleted file, or, more importantly, the previous version of the modified file. <br><br>  It is assumed that users will use either a regular hard drive or a special network device <a href="http://www.apple.com/ru/timecapsule/">Time Capsule</a> .  A traditional external hard drive is a solution for very organized people who will regularly (at least daily) connect it to an automatic backup, otherwise the benefits of the time machine will be very limited (although last year‚Äôs backup is still better than nothing at all).  With a time capsule will be much more convenient and reliable.  In addition to the backup function, it can also perform the function of network balls, Wi-Fi distributions (in fact, Time Capsule is a Wi-Fi router with HDD).  But the device costs money, and it is not so universal.  I wanted to fasten the ability to make backups of the time-machine working on Ubuntu to my server.  And it's not so difficult, and this note will be about. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><br>  So we have Ubuntu 12.04 LTS.  The functionality we need is in the netatalk package, this is an open source implementation of the AppleTalk protocol, we also need to install an avahi-daemon package to implement the zeroconf infrastructure in our network, in this case, an imitation of the favorite Apple technology Bonjour. <br><br>  avahi-daemon can be delivered immediately: <br><pre><code class="bash hljs">sudo aptitude install avahi-daemon</code> </pre> <br><br>  C netatalk is a bit more complicated, at the time of this writing, release version 2.2.2 was already released with a bunch of new fixes (see <a href="http://netatalk.sourceforge.net/">http://netatalk.sourceforge.net</a> ), and there was still a version of half a year ago 2.2.1 in the ubunt reps.  I wanted to put a newer version.  This can be done by building from source, but at that moment it could have been done differently.  A ready-made package <a href="">2.2.2</a> has already appeared on the <a href="https://launchpad.net/netatalk">launchpad</a> , so download it and install it. <br><br><pre> <code class="bash hljs">wget http://launchpadlibrarian.net/103717335/netatalk_2.2.2-1_amd64.deb sudo dpkg -i netatalk_2.2.2-1_amd64.deb</code> </pre> <br><br>  Next, you need to configure the services. <br><br>  Create an afpd.service file that describes specific services distributed by AppleTalk Filing Protocol by the afpd daemon: <br><br><pre> <code class="bash hljs">sudo nano /etc/avahi/services/afpd.service</code> </pre> <br><br>  with the following content: <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" standalone='no'?&gt;</span></span> <span class="hljs-meta"><span class="hljs-meta">&lt;!DOCTYPE service-group SYSTEM "avahi-service.dtd"&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service-group</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">replace-wildcards</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"yes"</span></span></span><span class="hljs-tag">&gt;</span></span>%h<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">name</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>_afpovertcp._tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>548<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span>_device-info._tcp<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">type</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span>0<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">port</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">txt-record</span></span></span><span class="hljs-tag">&gt;</span></span>model=Xserve<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">txt-record</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">service-group</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  Here you can change the name of the service and the icon of the remote computer that are displayed in the Finder on the poppy, they are responsible for the lines <br><br><pre>  &lt;name replace-wildcards = "yes"&gt;% h &lt;/ name&gt; </pre>  where% h is the computer name (host); <br><pre>  &lt;txt-record&gt; model = Xserve &lt;/ txt-record&gt; </pre>  where instead of Xserve you can put: Macmini, iMac, MacPro, Xserve, MacBook, MacBookPro, MacBookAir. <br><br>  Next, configure netatalk.  The config in / etc / default / netatalk can not be changed, everything should work and so.  But /etc/netatalk/AppleVolumes.default needs to be changed. <br><br><pre> <code class="bash hljs">sudo nano /etc/netatalk/AppleVolumes.default</code> </pre> <br><br>  Go to the end of the file <i>(Ctrl + V run through the pages faster)</i> . <br><br>  Add a line: <br><pre> <code class="bash hljs">/data/backups/TimeMachine <span class="hljs-string"><span class="hljs-string">"TimeMachine"</span></span> cnidscheme:dbd options:tm,upriv,usedots allow:alex</code> </pre> <br><br>  where / data / backups / TimeMachine is the path to the directory where backups will be stored; <br>  TimeMachine is the name of the shared resource. <br>  In options should be tm - resource for the time machine. <br>  allow: alex - user with access to the directory.  He (in this case, alex) should be on your server (for convenience, I also made the user on ubunt and on the poppy have one name), you can create a user using the useradd command. <br><br>  You can add another shared ball, for example: <br><br><pre> <code class="bash hljs">/data/common <span class="hljs-string"><span class="hljs-string">"Common"</span></span> cnidscheme:dbd options:usedots,upriv dperm:0776 fperm:0666 allow:@shares</code> </pre> <br><br>  Here in the options no longer need to specify tm. <br>  Here dperm: 0777 fperm: 0666 - rights to the created directories and files, <br>  allow: @shares - access only to users belonging to the shares group (you can create a group using groupadd and add a user to an existing group usermod -a -G groupname username) <br><br>  Rights and group - so that this ball can be conveniently used by several people.  To do this, people create accounts, and they add a group of shares.  Unfortunately, I did not find the opportunity to do it like in a samba, so that new files were created on behalf of the group, so I had to give full rights to others, otherwise the files created by one person could not be edited by others. <br><br>  Restart the service: <br><br><pre> <code class="bash hljs">sudo service netatalk restart</code> </pre> <br><br>  Restart avahi <br><br><pre> <code class="bash hljs">sudo service avahi-daemon restart</code> </pre> <br><br>  That's all. <br><br>  PS <br>  Although no, it was not without a file.  Those.  Immediately nifiga did not work, the symptom is this: in the finder, we try to connect to the ball, and he says that there is nothing there, where to connect?  It turned out that afpd did not really start. <br><br><pre> <code class="bash hljs">cat /var/<span class="hljs-built_in"><span class="hljs-built_in">log</span></span>/syslog</code> </pre> <br><br>  gave the following: <br><br><pre>  May 12 03:13:26 mini-server afpd [13367]: =================================== ============================
 May 12 03:13:26 mini-server afpd [13367]: INTERNAL ERROR: Signal 11 in pid 13367 (2.2.2)
 May 12 03:13:26 mini-server afpd [13367]: =================================== ============================
 May 12 03:13:26 mini-server afpd [13367]: BACKTRACE: 3 stack frames:
 May 12 03:13:26 mini-server afpd [13367]: # 0 / usr / sbin / afpd (netatalk_panic + 0x1c) [0x7fd5ac5e6b0c]
 May 12 03:13:26 mini-server afpd [13367]: # 1 / usr / sbin / afpd (+ 0x53c0c) [0x7fd5ac5e6c0c]
 May 12 03:13:26 mini-server afpd [13367]: # 2 /lib/x86_64-linux-gnu/libc.so.6(+0x364c0) [0x7fd5aaf444c0]
</pre><br><br>  Googling problems gave a solution.  Open /etc/netatalk/afpd.conf: <br><br><pre> <code class="bash hljs">sudo nano /etc/netatalk/afpd.conf</code> </pre> <br><br>  and change the most recent line to <br><pre> <code class="bash hljs">- -tcp -noddp -uamlist uams_dhx.so,uams_dhx2_passwd.so -nosavepassword</code> </pre> <br><br>  The problem was in the library uams_dhx2.so, which is not friendly with Lion, helped replace the uams_dhx2_passwd.so. </div><p>Source: <a href="https://habr.com/ru/post/143980/">https://habr.com/ru/post/143980/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../143974/index.html">Judge Alsup knows how to program and instructs Oracle attorney</a></li>
<li><a href="../143975/index.html">Calculate CRC32 strings in compile-time</a></li>
<li><a href="../143976/index.html">The practice of removing the IT department from a crisis</a></li>
<li><a href="../143978/index.html">Practical application of the piezoelectric effect for energy utilization</a></li>
<li><a href="../143979/index.html">Processing messages in RTOS on the example of FreeRTOS</a></li>
<li><a href="../143981/index.html">Graphic "bicycle" based on Turbo Vision (cases of bygone days)</a></li>
<li><a href="../143982/index.html">Navigation in rooms where GPS does not work</a></li>
<li><a href="../143983/index.html">Beginners "ministers"</a></li>
<li><a href="../143986/index.html">MeeGo programming for beginners</a></li>
<li><a href="../143988/index.html">Combining CKEditor 3.6.3, prettyPhoto and AjexFileManager</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>