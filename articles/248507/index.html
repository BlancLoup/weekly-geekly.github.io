<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WebSocket RPC or how to write a live web browser application</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The article focuses on technology WebSocket. More precisely, not about the technology itself, but about how it can be used. I've been watching her for...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WebSocket RPC or how to write a live web browser application</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/960/20a/2f5/96020a2f5946495699ac1e1816cc6a6d.jpg"><br><br>  The article focuses on technology WebSocket.  More precisely, not about the technology itself, but about how it can be used.  I've been watching her for a long time.  Even when in 2011 one of my colleagues sent me a link to the <a href="https://tools.ietf.org/html/rfc6455">standard</a> , having run my eyes, I was somehow upset.  It looked so cool, and I thought that at the moment when it will appear in popular browsers, I will already plan on what to spend my retirement.  But everything turned out to be wrong, <a href="http://caniuse.com/">and as caniuse.com</a> WebSocket <a href="http://caniuse.com/">says, it is</a> not supported only in Opera Mini (it would be necessary to vote how long someone has seen Opera Mini). <br><br>  Who touched the WebSocket with his hands, he probably knows that working with the API is hard.  The Javascript API is quite low-level (to accept a message ‚Äî to send a message), and it will be necessary to develop an algorithm for how to exchange these messages.  Therefore, an attempt was made to simplify the work with web-based software. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      This is how <a href="https://github.com/mosquito/wsrpc">WSRPC</a> appeared.  For the impatient, <a href="https://github.com/mosquito/wsrpc">here is a simple demo</a> . <br><a name="habracut"></a><br><h4>  Idea </h4><br>  The basic idea is to give the developer a simple Javascript API like: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> url = (<span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.protocol===<span class="hljs-string"><span class="hljs-string">"https:"</span></span>?<span class="hljs-string"><span class="hljs-string">"wss://"</span></span>:<span class="hljs-string"><span class="hljs-string">"ws://"</span></span>) + <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.location.host + <span class="hljs-string"><span class="hljs-string">'/ws/'</span></span>; RPC = WSRPC(url, <span class="hljs-number"><span class="hljs-number">5000</span></span>); <span class="hljs-comment"><span class="hljs-comment">//   RPC.call('test').then(function (data) { //    *args RPC.call('test.serverSideFunction', [1,2,3]).then(function (data) { console.log("Server return", data) }); //    **kwargs RPC.call('test.serverSideFunction', {size: 1, id: 2, lolwat: 3}).then(function (data) { console.log("Server return", data) }); }); //      'whoAreYou',    //    ,   return RPC.addRoute('whoAreYou', function (data) { return window.navigator.userAgent; }); RPC.connect();</span></span></code> </pre> <br>  And in python: <br><br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.web <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.httpserver <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> tornado.ioloop <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> time <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> wsrpc <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> WebSocketRoute, WebSocket, wsrpc_static <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExampleClassBasedRoute</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(WebSocketRoute)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self.socket.call(<span class="hljs-string"><span class="hljs-string">'whoAreYou'</span></span>, callback=self._handle_user_agent) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_handle_user_agent</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ua)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> ua <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">serverSideFunction</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, *args, **kwargs)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> args, kwargs WebSocket.ROUTES[<span class="hljs-string"><span class="hljs-string">'test'</span></span>] = ExampleClassBasedRoute WebSocket.ROUTES[<span class="hljs-string"><span class="hljs-string">'getTime'</span></span>] = <span class="hljs-keyword"><span class="hljs-keyword">lambda</span></span>: time.time() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> __name__ == <span class="hljs-string"><span class="hljs-string">"__main__"</span></span>: http_server = tornado.httpserver.HTTPServer(tornado.web.Application(( <span class="hljs-comment"><span class="hljs-comment">#  url   q.min.js  wsrpc.min.js # (    ) wsrpc_static(r'/js/(.*)'), (r"/ws/", WebSocket), (r'/(.*)', tornado.web.StaticFileHandler, { 'path': os.path.join(project_root, 'static'), 'default_filename': 'index.html' }), )) http_server.listen(options.port, address=options.listen) WebSocket.cleapup_worker() tornado.ioloop.IOLoop.instance().start()</span></span></code> </pre><br><br><h4>  Special features </h4><br>  I will explain some moments of how it works. <br><br><h5>  Javascript </h5><br>  The browser initializes a new RPC object, after which we call methods, but WebSocket has not yet connected.  It does not matter, the calls are in the queue, which we rake at a successful connection, or reject all promises (promises), clearing the queue at the next failed connection.  The library tries to connect to the server all the time (you can also subscribe to connection and disconnect events RPC.addEventListener ("onconnect", func)).  But until we run RPC.connect (), we peacefully add calls to the queue inside the RPC. <br><br>  After connection, we serialize our parameters into JSON and send a message to the server like this: <br><br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"serial"</span></span>:<span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-string"><span class="hljs-string">"call"</span></span>:<span class="hljs-string"><span class="hljs-string">"test"</span></span>,<span class="hljs-string"><span class="hljs-string">"arguments"</span></span>: <span class="hljs-literal"><span class="hljs-literal">null</span></span>}</code> </pre><br>  To which the server responds: <br><br><pre> <code class="javascript hljs">{<span class="hljs-string"><span class="hljs-string">"data"</span></span>: {}, <span class="hljs-string"><span class="hljs-string">"serial"</span></span>: <span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">"type"</span></span>: <span class="hljs-string"><span class="hljs-string">"callback"</span></span>}</code> </pre><br>  where serial is the call number. <br><br>  After receiving the answer, the JS library resolves the promise (resolve promise), and we call what is then.  After this, we make another challenge and so on ... <br><br>  I also note that between the challenge and the answer to it, it may take some time. <br><br><h5>  Python </h5><br>  In Python, calls are logged in the WebSocket object.  Class attribute (class-property) ROUTES is a dictionary (dict) that stores the association of the name of the call, and which function or class serves it. <br><br>  If a function is specified, it is simply called and its result is passed to the client. <br><br>  When we specify a class, and the client calls it at least once, we create an instance of this class and store it together with the connection until its very end.  This is very convenient, you can make a statefull connection to the browser. <br><br>  Access to methods is via point.  If the method is called with an underscore (_hidden), then it cannot be accessed from Javascript. <br><br>  More from the client to the server, and from the server to the client, exceptions are thrown.  When I implemented it, I was just stunned.  See the Javascript traceback in the python logs - guaranteed cognitive dissonance.  Well, about the Python Exceptions in JS, I am silent. <br><br><h4>  Total </h4><br>  I use this module on several projects.  Everywhere it works as it should, the main bugs are cleaned. <br><br><h4>  Instead of conclusion </h4><br>  Thanks to my colleagues and friends for helping me find bugs and sometimes sending patches.  Well, and you, the reader.  If you read this, given the dryness of the article, then you certainly are interested in this topic. <br><br>  upd 1: Added WebSocket.cleapup_worker () to examples. </div><p>Source: <a href="https://habr.com/ru/post/248507/">https://habr.com/ru/post/248507/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../248493/index.html">Non-recursive permutation generation algorithm</a></li>
<li><a href="../248497/index.html">The influence of cables on the parameters of the systems "amplifier-speaker" and "microphone-mixer"</a></li>
<li><a href="../248501/index.html">Why do we need an understandable language?</a></li>
<li><a href="../248503/index.html">JetBrains products at last year's prices</a></li>
<li><a href="../248505/index.html">Repository pattern. Basics and explanations</a></li>
<li><a href="../248509/index.html">Qt Android and system audio control dialog</a></li>
<li><a href="../248511/index.html">Website without backend: user authentication in BaaS parse.com through social networks</a></li>
<li><a href="../248517/index.html">CMakeProjectManager2: a bit of convenience when working with CMake in Qt Creator</a></li>
<li><a href="../248519/index.html">PID problem 1 zombie reaping in Docker</a></li>
<li><a href="../248521/index.html">We collect bad data - 2. 1.5 years later, about how not to publish open data</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>