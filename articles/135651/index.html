<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Hibernate-Extender or Hibernate, Spring and OSGi</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Unfortunately, at the moment Hibernate does not have the necessary integration mechanisms for working in the OSGi environment, although progress in th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Hibernate-Extender or Hibernate, Spring and OSGi</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/storage2/0ec/c25/f3d/0ecc25f3dd09841a09f7e6ae32451c53.png"></div><br>  Unfortunately, at the moment Hibernate does not have the necessary integration mechanisms for working in the OSGi environment, although progress in this direction is noticeable (the initial OSGi-fikatsiya by separating packages in the 4th branch).  This encourages the development of their own mechanisms, which requires considerable additional effort. <br><br>  This article is intended for those developers who are interested: how to use Hibernate with a bunch of Spring + OSGi;  What is the Extender pattern;  how to implement a ClassLoader with specific behavior;  how Hibernate is supported in the Spring Framework and a little bit about extending this code.  Of course, to read the article, it is necessary to understand the technologies Spring, Hibernate, OSGi, and also to understand the main problems of code execution in a multithreaded environment.  Those unfamiliar with using the Spring Framework in an OSGi environment can refer to the introductory article <a href="http://habrahabr.ru/blogs/java/128653/">‚ÄúUsing Spring in an OSGi Container‚Äù</a> . <br><br>  All submitted code is part of the educational project, the link to which is located at the end of the article.  Therefore, please consider all the examples presented as a prototype rather than as ready-to-use fragments. <br><a name="habracut"></a><br><h3>  Pattern Extender </h3>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Software running in the OSGi-container consists of separate modules (bundle), each of which performs its specific duties.  What to do when one module must use any complex runtime mechanisms located in another module?  The answer is obvious - use OSGi services.  And what to do when these mechanisms require, for example, initialization (registration of a servlet in a servlet-container or, as in our case, registration of mapped classes of Hibernate-entities).  The answer to this question is less obvious.  In fact, there are only two main options: the first - each module that needs such initialization calls it independently (for example, from the BundleActivator);  the second is that a module that needs such initialization has some characteristic metadata on which another module can initiate the execution of all the necessary work, since OSGi has a well-developed event system.  The second option has an undoubted advantage - we do not distribute a bunch of the same code across the modules and do not burden them with additional work, but transfer this responsibility into a separate module.  Actually by this principle works Spring DM.  This principle of operation is the Extender pattern [http://www.aqute.biz/Snippets/Extender] and it is very common in the OSGi world. <br><br><div style="text-align:center;"><img alt="C   Extender" title="Scheme of work typical Extender" src="https://habrastorage.org/storage2/305/1cf/ccc/3051cfccc2e7de8a9640e9aea185f127.png"></div><br><br><h3>  Description of the overall picture of the work of Hibernate-Extender </h3><br><br>  We proceed to discuss the general scheme of work Hibernate-Extender.  First of all, it is necessary to choose metadata due to which our extender will distinguish modules that need to be expanded from non-extensions.  Let this be the Entity-Classes header in META-INF / MANIFEST.MF containing a list of classes of Hibernate-entities (fans of xml-mapping will remain out of work for now).  Next, you need to receive events from modules that go to the Active state and from modules that go out of this state. To do this, use the OSGi event mechanism and implement the SynchronousBundleListener interface.  We use a synchronous event handler from the modules in order to immediately respond to changes in the states of the modules before calling the asynchronous BundleListener.  At the same time, we must ensure the shortest possible event handling time, so as not to block the thread that caused our handler.  This is achieved by implementing the Producer-Consumer pattern (Producer-Consumer), where Producer is our event handler, which sends information about the modules to Consumer, which performs all long-running operations in a separate thread.  In our case, it reinitializes the runtime structure of Hibernate. <br><br>  The Extender mechanism is fairly generic, so the implementation presented below follows Dependency Inversion Principle (SOLID) to facilitate code reuse. <br><br><pre><code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Extender</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SynchronousBundleListener</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BundleContext bundleContext; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Executor executor; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BlockingQueue&lt;ExtendedBundle&gt; bundles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> LinkedBlockingQueue&lt;ExtendedBundle&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> BundleConsumer bundleConsumer; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ExtendedBundleFactory extendedBundleFactory; <span class="hljs-comment"><span class="hljs-comment">// getter's  setter's @Override public void bundleChanged(BundleEvent event) { Actions action = null; switch (event.getType()) { case BundleEvent.STARTED: action = Actions.ADDING; break; case BundleEvent.STOPPING: action = Actions.REMOVING; break; }; if (action == null) return; ExtendedBundle extendedBundle = extendedBundleFactory.newExtendedFactory( event.getBundle(), action ); try { bundles.put(extendedBundle); } catch (InterruptedException e) { Thread.currentThread().interrupt(); } } public void initialize() { getBundleConsumer().initialize(getBundles()); getExecutor().execute(bundleConsumer); getBundleContext().addBundleListener(this); for (Bundle bundle: getBundleContext().getBundles()) { if (Bundle.ACTIVE != bundle.getState()) continue; ExtendedBundle extendedBundle = extendedBundleFactory.newExtendedFactory( bundle, Actions.ADDING ); try { bundles.put(extendedBundle); } catch (InterruptedException e) { Thread.currentThread().interrupt(); break; } } } }</span></span></code> </pre> <br><br>  The Extender implementation involves: BundleContext in which the Extender itself is registered as a listener for events from the modules;  Executor implementation of the artist from the java.util.concurrent framework, in which the consumer performs long-running operations;  BlockingQueue The blocking queue with which the Producer-Consumer execution threads are synchronized;  BundleConsumer is a concrete implementation of the event consumer of the modules;  ExtendedBundleFactory factory "extended" modules. <br><br>  The public void initialize () method is called immediately after the object is constructed.  In this method, we register our Extender as a handler, start the runtime of the consumer and process the modules that are already in the OSGi container, in the event that the Extender starts after the extensible modules. <br><br><h3>  BundleConsumer </h3><br><br>  BundleConsumer is an interface, an object with a type that implements this interface must perform processing of modules queued in the Extender queue. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">interface</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BundleConsumer</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Runnable</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">run</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">initialize</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( BlockingQueue&lt;ExtendedBundle&gt; newBundles )</span></span></span></span>; }</code> </pre><br><br>  From the code above, it is clear that this is just Runnable with an additional initialization method.  All interesting things should happen in the implementation of the void run () method.  Let's look at the concrete implementation of this interface, which performs the main work for our Hibernate-Extender. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SessionFactoryCreator</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">implements</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">BundleConsumer</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> Extendable extendable; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> ExtenderClassLoader extenderClassLoader; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> BlockingQueue&lt;ExtendedBundle&gt; newBundles; <span class="hljs-comment"><span class="hljs-comment">// getter's, setter's    @Override public void run() { ExtendedBundle bundle = null; while (!Thread.currentThread().isInterrupted()) { try { bundle = newBundles.take(); } catch (InterruptedException e) { Thread.currentThread().interrupt(); break; } if (!bundle.isValidForExtending()) continue; if (Actions.ADDING.equals(bundle.getAction())) { addBundle(bundle); } else if (Actions.REMOVING.equals(bundle.getAction())) { removeBundle(bundle); } } } private void addBundle(ExtendedBundle bundle) { bundle.extend(); extenderClassLoader.addBundle(bundle); extendable.addBundle(bundle); bundle.markAsCompleted(); } private void removeBundle(ExtendedBundle bundle) { bundle.extend(); extendable.removeBundle(bundle); extenderClassLoader.removeBundle(bundle); bundle.markAsCompleted(); } }</span></span></code> </pre><br><br>  The main loop in the void run () method handles the newBundles queue.  If there are no extensible modules in the queue, execution is blocked in the call to the newBundles.take () method.  When expandable modules appear, they move one by one.  On each of these modules, the isValidForExtending () method is called, which should return a true value if the module is suitable for extension.  This verification method can take considerable time when accessing internal packet resources (for example, to trigger I / O operations), so it is called here, and not in the Extender.  If the module is suitable for expansion, then meta information is checked about the action that needs to be performed on it by Actions.ADDING or Actions.REMOVING.  Depending on the required action, an add or delete operation is performed and the modules are marked as processed. <br><br>  I want to draw the reader‚Äôs attention to the conditions for exiting the main processing loop! Thread.currentThread (). IsInterrupted (); it ensures the correct termination of the thread when the interrupt flag is set.  Another place where this flag is involved is the handling of the exception thrown by the blocking method newBundles.take () when it occurs, setting the stream interrupt flag and exiting the main loop. <br><br>  Class attributes are marked volatile to guarantee visibility in a multi-threaded environment.  The creation of an object occurs in one stream, and further use in another.  The implementation of BlockingQueue is thread-safe, so its use in a multi-threaded environment does not require additional synchronization. <br><br><h3>  HibernateSessionFactoryBean </h3><br><br>  A large variety of frameworks are not accidental.  Using a third-party, well-tested, ready-for-use code greatly facilitates development.  Therefore, we also try not to invent too much.  The Spring Framework supports integration with Hibernate.  One of the main classes of this integration is LocalSessionFactoryBean.  It initializes and creates a session factory, which is then used in any code using the Hibernate API.  This class has a descendant of AnnotationSessionFactoryBean, which adds some functionality with annotation support.  From the last we will inherit our implementation, the code of which is presented below. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">HibernateSessionFactoryBean</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AnnotationSessionFactoryBean</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> SessionFactory sessionFactoryProxy; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Lock sessionFactoryAccessLock = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReentrantLock(<span class="hljs-keyword"><span class="hljs-keyword">true</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> ClassLoader classLoader; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;Class&lt;?&gt;&gt; annotatedClasses = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CopyOnWriteArraySet&lt;Class&lt;?&gt;&gt;(); <span class="hljs-comment"><span class="hljs-comment">/** *   ClassLoader * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> classLoader */</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setClassLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassLoader classLoader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">super</span></span>.setBeanClassLoader(classLoader); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.classLoader = classLoader; } <span class="hljs-comment"><span class="hljs-comment">/** *   ClassLoader    BeanClassLoaderAware * </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@param</span></span></span><span class="hljs-comment"> beanClassLoader */</span></span> <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setBeanClassLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ClassLoader beanClassLoader)</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">afterPropertiesSet</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> Exception </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//  ClassLoader ProxyFactory.classLoaderProvider = new ClassLoaderProvider() { public ClassLoader get(ProxyFactory pf) { return HibernateSessionFactoryBean.this.classLoader; } }; super.afterPropertiesSet(); sessionFactoryProxy = createSessionFactoryProxy(); } @Override public SessionFactory getObject() { return sessionFactoryProxy; } /** *    Hibernate */ protected void recreateSessionFactory() throws Exception { sessionFactoryAccessLock .tryLock(3000, TimeUnit.MILLISECONDS); try { //  runtime-   Hibernate super.destroy(); //  runtime-   Hibernate super.afterPropertiesSet(); } finally { sessionFactoryAccessLock.unlock(); } } protected SessionFactory createSessionFactoryProxy() throws InstantiationException, IllegalAccessException, InterruptedException { //     //   SessionFactory  Extendable ProxyFactory sessionFactoryProxyFactory = new ProxyFactory(); sessionFactoryProxyFactory.setInterfaces( new Class[] {SessionFactory.class, Extendable.class} ); //    finalize sessionFactoryProxyFactory.setFilter(new MethodFilter() { public boolean isHandled(Method m) { return !m.getName().equals("finalize"); } }); Class&lt;?&gt; sessionFactoryProxyClass = sessionFactoryProxyFactory.createClass(); MethodHandler mi = new MethodHandler() { public Object invoke( Object self, Method thisMethod, Method proceed, Object[] args) throws Throwable { Object result = null; // TCCL ClassLoader defaultClassLoader = Thread.currentThread().getContextClassLoader(); Thread.currentThread().setContextClassLoader(classLoader); try { if (thisMethod.getName().contains("addBundle")) { addBundle((HibernateBundle) args[0]); } else if (thisMethod.getName().contains("removeBundle")) { removeBundle((HibernateBundle) args[0]); } else { sessionFactoryAccessLock .tryLock(3000, TimeUnit.MILLISECONDS); try { //   SessionFactory result = thisMethod .invoke(getSessionFactory(), args); } finally { sessionFactoryAccessLock.unlock(); } } } finally { // TCCL    Thread.currentThread() .setContextClassLoader(defaultClassLoader); } return result; } }; SessionFactory sessionFactory = (SessionFactory)sessionFactoryProxyClass.newInstance(); ((ProxyObject)sessionFactory).setHandler(mi); return sessionFactory; } private void addBundle(HibernateBundle bundle) throws Exception { for (String entityClassName: bundle.getEntityClassNames()) { annotatedClasses.add(classLoader.loadClass(entityClassName)); } setAnnotatedClasses( annotatedClasses.toArray( new Class[annotatedClasses.size()])); recreateSessionFactory(); } private void removeBundle(HibernateBundle bundle) throws Exception { for (Class&lt;?&gt; annotatedClass: annotatedClasses) { if (bundle.getEntityClassNames().contains( annotatedClass.getCanonicalName())) { annotatedClasses.remove(annotatedClass); } } setAnnotatedClasses( annotatedClasses.toArray( new Class[annotatedClasses.size()])); recreateSessionFactory(); } }</span></span></code> </pre><br><br>  The main execution plan for this code is as follows.  AbstractSessionFactoryBean implements the FactoryBean interface; the creation of a class object that implements this interface in a Spring container is handled in a special way.  See the Spring Framework documentation for more details.  It is worth mentioning here that it is just a factory of SessionFactory objects, and not its concrete implementation.  Instead of the SessionFactory object created in LocalSessionFactoryBean, the code returns a proxy object that redirects almost all calls to the native SessionFactory methods while protecting any access to it by global blocking (this architecture can be reworked from the viewpoint of performance, in addition, the possibility of re-creating SessionFactory at the time of using Session objects is not taken into account ).  Each time the set of extensible modules changes, the SessionFactory object is re-created taking this into account. <br><br>  The callback handler for the object's proxy method uses the Thread Context Classloader (TCCL) override.  As a TCCL, at the time of the method call, our own Classloader sets about this later. <br><br><h3>  OSGi and ClassLoader </h3><br><br>  In a typical application running in the jvm environment, class loaders are hierarchically related (link to parent) and load classes and resources first by delegating to their parent and, if unsuccessful, by themselves.  For OSGi environments, this behavior is not appropriate.  Similarly, it is not suitable for our case with Extender.  In the OSGi container, each module receives its own class loader which fully satisfies its (module) needs.  And the module class loaders are connected to a more complex delegation network.  Each such loader has a link to the framework class loader, as well as to the module loaders from which the import is performed.  This delegation network is built as a result of the Resolving process in the OSGi container. <br><br><div style="text-align:center;"><img alt="     OSGi" title="Network delegating class loaders to OSGi" src="https://habrastorage.org/storage2/2f2/e94/390/2f2e94390cfba2486e245f0a694c46d9.png"></div><br><br>  In the case of Extender, the generic module class loader is not suitable, because there is no possibility of declaring imported classes of entities in MANIFEST.MF.  About such classes is simply unknown at the time of development Extender.  Therefore, you need to implement your own bootloader with the behavior we need.  The class loader code for the Extender is shown below. <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ExtenderClassLoader</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">ClassLoader</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">volatile</span></span> ClassLoader defaultClassLoader = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> Set&lt;ExtendedBundle&gt; bundles = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> CopyOnWriteArraySet&lt;ExtendedBundle&gt;(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ClassLoader </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDefaultClassLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> defaultClassLoader; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setDefaultClassLoader</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ClassLoader defaultClassLoader)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.defaultClassLoader = defaultClassLoader; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">addBundle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">( ExtendedBundle bundle)</span></span></span><span class="hljs-function"> </span></span>{ bundles.add(bundle); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">removeBundle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ExtendedBundle bundle)</span></span></span><span class="hljs-function"> </span></span>{ bundles.remove(bundle); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> Class&lt;?&gt; loadClass( String name) <span class="hljs-keyword"><span class="hljs-keyword">throws</span></span> ClassNotFoundException { Class&lt;?&gt; c = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (ExtendedBundle bundle: bundles) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { c = bundle.loadClass(name); <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException e) {} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; getDefaultClassLoader() != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { c = getDefaultClassLoader().loadClass(name); } <span class="hljs-keyword"><span class="hljs-keyword">catch</span></span> (ClassNotFoundException e) {} } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (c == <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ClassNotFoundException(name); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> c; } <span class="hljs-comment"><span class="hljs-comment">//   }</span></span></code> </pre><br><br>  Let's take a closer look at the presented code.  The main logic of his work is in the loadClass method.  It should be emphasized that the methods for loading resources are omitted in the given fragment in a similar way.  ExtenderClassLoader contains a collection of modules containing entity classes and delegates the loading of classes and resources to them.  This provides access to the necessary code without the need for import.  Loading the remaining required classes ExtenderClassLoader delegates to the default boot loader.  Thread safety of this code is ensured by using the non-blocking implementation of the CopyOnWriteArraySet set and thread safe class loaders. <br><br><h3>  Putting it all together </h3><br><br>  At this point, the reader should have an understanding of how the main elements of the Hibernate-Extender work.  Now you need to put all the pieces together.  To do this, you need to configure the module to work in the OSGi environment with spring dm.  For a better understanding of the configuration of objects, consider the class diagram of our system. <br><br><div style="text-align:center;"> <a href=""><img alt="UML-  " title="UML diagram of class interaction" src="https://habrastorage.org/storage2/37c/4b3/76a/37c4b376ad0c1d1690b4d936393824e1.png"></a> </div><br><br>  According to established canons, the spring dm module configuration is split into at least two files.  The first is the actual configuration of the spring-container.  The second is a configuration specific to the OSGi-environment.  In our case, these are the context.xml and osgi-context.xml files. <br><br>  The Hibernate-Extender configuration for spring dm is identical to the class diagram.  At the beginning of the context.xml configuration file, a dataSource object is described - this is the data source with which all interaction with the database is performed.  Next comes the configuration of the transactionManager object that provides transaction support in a Spring environment.  The sessionFactory object is an instance of the HibernateSessionFactoryBean class described above that is responsible for creating the SessionFactory.  The sessionFactory link is passed to the transactionManager.  The next object in the configuration is the extenderClassLoader in which, when created, the default class loader is set as the defaultClassLoader in the Spring environment.  The sessionFactoryCreator object does all the basic work of initiating the reconfiguration of the Hibernate environment, taking into account the changed data on the modules.  The central object of our module is the Extender which, in the process of creation, receives links to the objects: bundleContext, new unnamed Executor, new unnamed ExtendedBundleFactory and sessionFactoryCreator.  In the second configuration file osgi-context.xml, OSGi services are declared: dataSource, transactionManager, sessionFactory. <br><br>  context.xml <br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:context</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/context"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:aop</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/aop"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:osgi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/osgi"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:osgi-compendium</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/osgi-compendium"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleton"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"driverClass"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.hsqldb.jdbc.JDBCDriver"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jdbcUrl"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"jdbc:hsqldb:hsql://localhost/test"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"user"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"SA"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"password"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">""</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transactionManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleton"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iconcerto.hibernate.HibernateSessionFactoryBean"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleton"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"configurationClass"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">value</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.hibernate.cfg.AnnotationConfiguration"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"classLoader"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"extenderClassLoader"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"extenderClassLoader"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iconcerto.extender.ExtenderClassLoader"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleton"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"defaultClassLoader"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.springframework.util.ClassUtils"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">factory-method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"getDefaultClassLoader"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactoryCreator"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iconcerto.hibernate.extender.SessionFactoryCreator"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleton"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"extenderClassLoader"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"extenderClassLoader"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">id</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"extender"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iconcerto.extender.Extender"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">scope</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"singleton"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">init-method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"initialize"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bundleContext"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bundleContext"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"executor"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"java.util.concurrent.Executors"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">factory-method</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"newSingleThreadExecutor"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"extendedBundleFactory"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">class</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"iconcerto.hibernate.extender.HibernateBundleFactory"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">property</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"bundleConsumer"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactoryCreator"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">bean</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  osgi-context.xml <br><br><pre> <code class="xml hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:xsi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:osgi</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/osgi"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xmlns:osgi-compendium</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/osgi-compendium"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">xsi:schemaLocation</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi-1.2.xsd http://www.springframework.org/schema/osgi-compendium http://www.springframework.org/schema/osgi-compendium/spring-osgi-compendium-1.2.xsd"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">osgi:service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"dataSource"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">interface</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"javax.sql.DataSource"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">osgi:service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"transactionManager"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">osgi:interfaces</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> org.springframework.transaction.support.ResourceTransactionManager <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">value</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">osgi:interfaces</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">osgi:service</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">osgi:service</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">ref</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"sessionFactory"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">interface</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"org.hibernate.SessionFactory"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">beans</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br><h3>  Prototype flaws </h3><br><br>  Like any prototype, Hibernate-Extender has a number of flaws.  On the one hand, it is difficult to convey the main idea if it is mixed with a large number of minor details.  On the other hand, it is impossible not to mention quite obvious flaws that prevent the use of this code in a real application. <br><br>  From the spring configuration, the first thing that catches your eye is the presence of setting the properties of the data source directly in the context.xml file itself.  Any real application requires changing this.  For example, setting this data from an external property file using the Spring property-placeholder mechanism or implementing a more complex system for changing the connection parameters to the database at run time. <br><br>  In the above listings, the code responsible for logging is omitted, without which virtually any use of the module is unthinkable. <br><br>  The described implementation has the following serious disadvantage.  What happens if a module is added to an extension at the moment when another, already expanded module, performs an operation using the Hibernate API and is inside a transaction?  Such an operation in the current implementation is doomed to failure, although if it is taken into account in the code, then the handling of specific exceptions associated with invoking operations on the already out of date Session object will cause inconvenience. <br><br>  And the last drawback that I want to highlight is the problem from the point of view of performance arising from the reconfiguration of the Hibernate runtime environment that occurs after each change in the set of extensible modules. <br><br><h3>  OSGi-fikatsiya third-party libraries </h3><br><br>  Many java libraries are already delivered as ready-to-run in OSGi, but unfortunately, not all.  There are two ways out of this situation, either use OSG-based versions prepared by a third party (for example, the SpringSource Enterprise Bundle Repository [http://ebr.springsource.com/repository/app/]), or prepare such versions of the libraries yourself.  In the project with the source code of the examples, such preparation is performed (lib subproject).  I would like to note that for a complex library this is not a trivial task.  You must understand the library structure for exporting packages that can be used by third-party code.  Additional problems may arise due to the internal mechanisms of libraries that are poorly compatible or incompatible with the OSGi environment.  But all this, in most cases, solvable problems.  The technical problems of the library architecture are solved only manually, while the export question can be automated with the help of various utilities (bnd, maven-plugins, etc.) <br><br><h3>  Conclusion </h3><br><br>  This completes the description of the Extender approach to working with Hibernate in OSGi.  The only thing left is to add how to use the resulting module.  The extensible module in the Entity-Classes header in META-INF / MANIFEST.MF should place a list of the full names of the Hibernate entity classes.  Further, when this module is launched, the Extender will load these classes using our implementation of the ClassLoader and reinitialize the Hibernate runtime environment.  In addition, the Hibernate API that needs to use it must import the OSGi service SessionFactory and ResourceTransactionManager.  After that, the module can use the Hibernate API in Spring environment in the usual manner (according to the official manual). <br>  The full Extender code together with modular and integration tests is placed in the googlecode repository link to which is located at the end of the article.  This code will be developed, so everyone who is interested in it can follow the changes.  Whoever wants to participate in the development of this code can contact me.  Well, as usual, who has any questions, welcome to the comments! <br><br><h3>  Additional sources </h3><br><br>  <a href="http://code.google.com/p/iconcerto/source/browse/">code.google.com/p/iconcerto/source/browse</a> <br>  <a href="http://www.aqute.biz/Bnd/Bnd">www.aqute.biz/Bnd/Bnd</a> <br>  <a href="http://www.aqute.biz/Snippets/Extender">www.aqute.biz/Snippets/Extender</a> <br>  <a href="http://static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html/">static.springsource.org/spring/docs/3.1.x/spring-framework-reference/html</a> <br>  <a href="http://docs.jboss.org/hibernate/core/3.6/reference/en-US/html/">docs.jboss.org/hibernate/core/3.6/reference/en-US/html</a> <br>  <a href="http://static.springsource.org/osgi/docs/1.2.1/reference/html/">static.springsource.org/osgi/docs/1.2.1/reference/html</a> </div><p>Source: <a href="https://habr.com/ru/post/135651/">https://habr.com/ru/post/135651/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../135643/index.html">The new law requires Wi-Fi in all restaurants of the capital of Malaysia</a></li>
<li><a href="../135645/index.html">Why is coworking in Thailand covered</a></li>
<li><a href="../135646/index.html">Interview with Dries Bytaertom: About Drupal 8, Open Source, Business and India</a></li>
<li><a href="../135648/index.html">HowTo: continuous integration of the project on Django using TeamCity</a></li>
<li><a href="../135650/index.html">All the most fashionable</a></li>
<li><a href="../135652/index.html">Which KPIs can be measured if the project schedule and budget is not very important?</a></li>
<li><a href="../135653/index.html">Literature for the winter - the new Windows Phone Training Kit</a></li>
<li><a href="../135654/index.html">We emulate PEAR DB when working with MySQL</a></li>
<li><a href="../135655/index.html">Microsoft will allow to run Linux in Windows Azure</a></li>
<li><a href="../135657/index.html">How do we learn</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>