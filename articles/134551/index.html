<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Creating a 1k / 4k intro for Linux, part 1</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="‚ÄúOn the Russian stage, we surprise each other with the fact that we do something at all‚Äù, ¬© manwe 
 (from SCRIMERS status on demoscene.ru/forum ) 

 F...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Creating a 1k / 4k intro for Linux, part 1</h1><div class="post__text post__text-html js-mediator-article">  ‚ÄúOn the Russian stage, we surprise each other with the fact that we do something at all‚Äù, ¬© manwe <br>  (from SCRIMERS status on <a href="http://demoscene.ru/forum/">demoscene.ru/forum</a> ) <br><br>  Five minutes of meta: in this text you, kittens, have to read about how to spend your time completely ineffective in terms of the ratio of the size of the resulting product to the time and effort spent. <br>  Suppose we want to do something such as, for example, an intro up to 4kb in size, but we are rogue, and we have no money for windows and a video card with shaders that support branching.  Or we just do not want to take the standard set of apack / crinkler / sonant / 4klang / God-what-there-else-is, do the next ‚Äúsee everything!  I am also able to reymarching distans fields! ‚Äùand get lost among tens or hundreds <a href="http://pouet.net/prodlist.php%3Fplatform%5B%5D%3DWindows%26type%5B%5D%3D1k%26type%5B%5D%3D4k%26order%3Drelease">of the same</a> .  Well, or we just love to show off at random in the hope that the girls will finally pay attention to us. <br><br>  In general, it does not matter.  Suppose we just have some Linux with a weak video card and all the youth ahead.  Let's try with all this now to create a startup file of no more than, say, 1024 bytes, which at startup would somehow manage to create and show the user something (such). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="https://habrastorage.org/storage1/97a3c6d0/433ac6c6/a8e132fd/2960d841.png"><br><br><a name="habracut"></a><br><br>  What can we use for this?  First of all, we have X11 and OpenGL.  How can they be initialized with the least blood: <br><ol><li>  Directly via Xlib, GLX <br>  +: there is a guarantee in the system; <br>  -: 11 calls only to raise the GL context </li><li>  glut <br>  +: 4-5 functions for GL context; <br>  -: there is not everywhere </li><li>  SDL <br>  +: 2 calls for context, the de facto standard, is almost everywhere; <br>  -: it may not happen somewhere, or in some future, compatibility with new versions could potentially crawl </li><li>  hammer on the library and do everything by hand <br>  +: you can throw out a dynamic link and get rumored (viznut?), about 300 bytes to initialize the GL context <br>  -: you can break everything for yourself while you figure it out </li></ol><br><br>  The last option is undoubtedly the truest, but it‚Äôs too complicated for me yet.  Therefore, we will do the penultimate. <br><br>  Let's uncover gcc and try to feel all that we have to deal with.  Let's start with our intro skeleton - initialize the OpenGL context, specify the viewport and launch a simple eventloop that terminates the application when you press any key: <br><br><pre><code class="hljs lua">#include &lt;SDL.h&gt; #define W <span class="hljs-number"><span class="hljs-number">1280</span></span> #define H <span class="hljs-number"><span class="hljs-number">720</span></span> #define FULLSCREEN <span class="hljs-number"><span class="hljs-number">0</span></span>//SDL_FULLSCREEN int main(int argc, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* argv) { SDL_Init(SDL_INIT_VIDEO); SDL_SetVideoMode(W, H, <span class="hljs-number"><span class="hljs-number">32</span></span>, SDL_OPENGL | FULLSCREEN); glViewport(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, W, H); SDL_Event e; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;;) { SDL_PollEvent(&amp;e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == SDL_KEYDOWN) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; // -    SDL_GL_SwapBuffers(); } SDL_Quit(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>; }</code> </pre> <br><br>  (An attentive reader here may discover the following: <ul><li>  optimism, eclipsing sun - complete lack of error checks </li><li>  the lack of verification on e.type == SDL_QUIT (processing the window closing by the user), which will slightly annoy those who like closing applications by clicking on the cross, rather than pressing an arbitrary key </li></ul>  My answer: whether there will be more!) <br><br>  Compile it: <br><br>  (Note1: for users of binary distributions: you need a compiler (gcc), headers for OpenGL (usually in mesa) and an SDL version for developers (libsdl-dev, or something like that).) <br>  (Note2: the -m32 flag is needed only for owners of 64-bit distributions) <br><br><pre> <code class="hljs lua">cc -m32 -o intro intro.c `pkg-<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> <span class="hljs-comment"><span class="hljs-comment">--libs --cflags sdl` -lGL</span></span></code> </pre> <br><br>  And terrified that such a simple program takes almost 7kb! <br><br>  We scratch the turnips, we understand that we in the fig did not give up crt and other bourgeois excesses, so we cut them out. <br>  Need to: <ul><li>  Instead of main (), declare a _start () function with no arguments and a return value (you can rename it, but why?). </li><li>  Instead of simply exiting from this function, make an exit call from the application (eax = 1, ebx = exit_code). </li></ul><br><br><pre> <code class="hljs lua">#include &lt;SDL.h&gt; #define W <span class="hljs-number"><span class="hljs-number">1280</span></span> #define H <span class="hljs-number"><span class="hljs-number">720</span></span> #define FULLSCREEN <span class="hljs-number"><span class="hljs-number">0</span></span>//SDL_FULLSCREEN void _start() { SDL_Init(SDL_INIT_VIDEO); SDL_SetVideoMode(W, H, <span class="hljs-number"><span class="hljs-number">32</span></span>, SDL_OPENGL | FULLSCREEN); glViewport(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, W, H); SDL_Event e; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;;) { SDL_PollEvent(&amp;e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == SDL_KEYDOWN) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; // -    SDL_GL_SwapBuffers(); } SDL_Quit(); asm ( \ <span class="hljs-string"><span class="hljs-string">"xor %eax,%eax\n"</span></span> \ <span class="hljs-string"><span class="hljs-string">"inc %eax\n"</span></span> \ <span class="hljs-string"><span class="hljs-string">"int $0x80\n"</span></span> \ ); }</code> </pre><br>  In addition, you must specify the gcc parameter -nostartfiles. <br>  And at the same time immediately strip the binary: <br><pre> <code class="hljs lua">cc -m32 -o intro intro.c `pkg-<span class="hljs-built_in"><span class="hljs-built_in">config</span></span> <span class="hljs-comment"><span class="hljs-comment">--libs --cflags sdl` -lGL -Os -s -nostartfiles</span></span></code> </pre> <br><br>  We get ~ 4.7 kilobytes, which is ~ 30% better, but still very much. <br>  In this program, the useful code is still a cat cry, and almost all the place is occupied by various elf-headers.  There is a sstrip utility from the elfkickers suite (http://www.muppetlabs.com/~breadbox/software/elfkickers.html) for cutting out the futility of headers: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">sstrip</span></span> intro</code> </pre> <br>  This gives us about 600 bytes more and dangerously brings the size of the binary to 4kb.  And that he still does not do anything useful. <br><br>  Once again we get upset, look at our binary in the hex editor and find zeros.  A lot of them.  And who is the best to fight zeroes and other similarities? <br>  Right: <br><pre> <code class="hljs matlab"><span class="hljs-built_in"><span class="hljs-built_in">cat</span></span> intro | <span class="hljs-number"><span class="hljs-number">7</span></span>z a dummy -tGZip -mx=<span class="hljs-number"><span class="hljs-number">9</span></span> -si -so &gt; intro.gz</code> </pre> <br>  (Note1-obvious: you need to put the p7zip package. Why p7zip and such complexity? Because: (a) gzip and others compress by a few percent worse, (b) you need to remove the gz-header with extra metadata, like the file name) <br>  (Note2: why is gzip at all, and not, say, bzip2? Because empirically p7zip -tGZip gives the best result of everything I've tried, and the unpackers of which are more or less everywhere) <br>  intro.gz is already about 650 bytes!  It remains only to make it run.  Create an unpack_header file with the following content: <br><pre> <code class="hljs perl">T=<span class="hljs-regexp"><span class="hljs-regexp">/tmp/i</span></span>;tail -n+<span class="hljs-number"><span class="hljs-number">2</span></span> $0|zcat&gt;$T;<span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">x</span></span> $T;$T;rm $T;<span class="hljs-keyword"><span class="hljs-keyword">exit</span></span></code> </pre> <br>  and stick this header to our archive: <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">cat</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">unpack_header</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">intro</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.gz</span></span> &gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">intro</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.sh</span></span></code> </pre> <br>  Let's make the file run and take a look at what we did: <br><pre> <code class="hljs perl"><span class="hljs-keyword"><span class="hljs-keyword">chmod</span></span> +<span class="hljs-keyword"><span class="hljs-keyword">x</span></span> intro.sh ./intro.sh</code> </pre> <br>  Make sure that these 700 byte kopecks really create an empty window. <br>  What we have just done is called gzip-dropping, and its roots go to the cab-dropping method, popular in its time (before the crinkler era and the guys), which did exactly the same thing, but under Windows. <br><br>  Let's see, and how many can zahirachit in the remaining 300 bytes.  Traditionally we do the following: displaying glRect to the full screen, which is drawn by special shaders of the form color = f (x, y): <br><pre> <code class="hljs lua">#include &lt;SDL.h&gt; #include &lt;GL/gl.h&gt; #define W <span class="hljs-number"><span class="hljs-number">1280</span></span> #define H <span class="hljs-number"><span class="hljs-number">720</span></span> #define FULLSCREEN <span class="hljs-number"><span class="hljs-number">0</span></span>//SDL_FULLSCREEN <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* shader_vtx[] = { <span class="hljs-string"><span class="hljs-string">"varying vec4 p;"</span></span> <span class="hljs-string"><span class="hljs-string">"void main(){gl_Position=p=gl_Vertex;}"</span></span> }; <span class="hljs-built_in"><span class="hljs-built_in">char</span></span>* shader_frg[] = { <span class="hljs-string"><span class="hljs-string">"varying vec4 p;"</span></span> <span class="hljs-string"><span class="hljs-string">"void main(){"</span></span> <span class="hljs-string"><span class="hljs-string">"gl_FragColor=p;"</span></span> <span class="hljs-string"><span class="hljs-string">"}"</span></span> }; void shader(<span class="hljs-built_in"><span class="hljs-built_in">char</span></span>** src, int <span class="hljs-built_in"><span class="hljs-built_in">type</span></span>, int p) { int s = glCreateShader(<span class="hljs-built_in"><span class="hljs-built_in">type</span></span>); glShaderSource(s, <span class="hljs-number"><span class="hljs-number">1</span></span>, src, <span class="hljs-number"><span class="hljs-number">0</span></span>); glCompileShader(s); glAttachShader(p, s); } void _start() { SDL_Init(SDL_INIT_VIDEO); SDL_SetVideoMode(W, H, <span class="hljs-number"><span class="hljs-number">32</span></span>, SDL_OPENGL | FULLSCREEN); glViewport(<span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span>, W, H); int p = glCreateProgram(); shader(shader_vtx, GL_VERTEX_SHADER, p); shader(shader_frg, GL_FRAGMENT_SHADER, p); glLinkProgram(p); glUseProgram(p); SDL_Event e; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(;;) { SDL_PollEvent(&amp;e); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (e.<span class="hljs-built_in"><span class="hljs-built_in">type</span></span> == SDL_KEYDOWN) <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; glRecti(<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">-1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">1</span></span>); SDL_GL_SwapBuffers(); } SDL_Quit(); asm ( \ <span class="hljs-string"><span class="hljs-string">"xor %eax,%eax\n"</span></span> \ <span class="hljs-string"><span class="hljs-string">"inc %eax\n"</span></span> \ <span class="hljs-string"><span class="hljs-string">"int $0x80\n"</span></span> \ ); }</code> </pre><br>  The code is quite transparent, except, perhaps, the moment with varying vec4 p, which serves to drag the normalized screen coordinates from the vertex shader to the fragment shader, and makes us independent of the physical dimensions of the window. <br><br>  So, let's try to collect: <br><pre> <code class="hljs tex">cc -m32 -o intro intro.c `pkg-config --libs --cflags sdl` -lGL -Os -s -nostartfiles &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>sstrip intro &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>cat intro | 7z a dummy -tGZip -mx=9 -si -so &gt; intro.gz &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>cat unpack_header intro.gz &gt; intro.sh &amp;&amp; chmod +x intro.sh &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>wc -c intro.sh &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>./intro.sh</code> </pre><br><br>  We find out that such a trifle we already hapnuli extra 50 bytes, and got out for the permitted one kilobyte.  ‚ÄúYou will still have a chance to dance with me, you will dance!‚Äù, We think and get the last trick out of the bosom: manual loading of all necessary functions from dynamic libraries: <br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;dlfcn.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">SDL</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">GL</span></span>/gl.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">W</span></span> <span class="hljs-number"><span class="hljs-number">1280</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">FULLSCREEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>//<span class="hljs-type"><span class="hljs-type">SDL_FULLSCREEN</span></span> const char* shader_vtx[] = { <span class="hljs-comment"><span class="hljs-comment">"varying vec4 p;"</span></span> <span class="hljs-comment"><span class="hljs-comment">"void main(){gl_Position=p=gl_Vertex;}"</span></span> }; const char* shader_frg[] = { <span class="hljs-comment"><span class="hljs-comment">"varying vec4 p;"</span></span> <span class="hljs-comment"><span class="hljs-comment">"void main(){"</span></span> <span class="hljs-comment"><span class="hljs-comment">"gl_FragColor=p;"</span></span> <span class="hljs-comment"><span class="hljs-comment">"}"</span></span> }; const char dl_nm[] = <span class="hljs-comment"><span class="hljs-comment">"libSDL-1.2.so.0\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_Init\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_SetVideoMode\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_PollEvent\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_GL_SwapBuffers\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_Quit\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"libGL.so.1\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glViewport\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glCreateProgram\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glLinkProgram\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glUseProgram\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glCreateShader\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glShaderSource\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glCompileShader\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glAttachShader\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glRecti\0\0\0"</span></span>; // : <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_Init ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_SetVideoMode ((void(*)(int,int,int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_PollEvent ((void(*)(void*))dl_ptr[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_GL_SwapBuffers ((void(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">3</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_Quit ((void(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">4</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glViewport ((void(*)(int,int,int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">5</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glCreateProgram ((int(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">6</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glLinkProgram ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">7</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glUseProgram ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">8</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glCreateShader ((int(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">9</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glShaderSource ((void(*)(int,int,const char**,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">10</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glCompileShader ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">11</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glAttachShader ((void(*)(int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">12</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glRecti ((void(*)(int,int,int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">13</span></span>]) void* dl_ptr[<span class="hljs-number"><span class="hljs-number">14</span></span>]; //  -    void dl() { const char* pn = dl_nm; void** pp = dl_ptr; for(;;) //    { void* f = dlopen(pn, <span class="hljs-type"><span class="hljs-type">RTLD_LAZY</span></span>); //  for(;;) //    precious  { while(*(pn++) != <span class="hljs-number"><span class="hljs-number">0</span></span>); //         if (*pn == <span class="hljs-number"><span class="hljs-number">0</span></span>) break; //    ,     so<span class="hljs-string"><span class="hljs-string">' *pp++ = dlsym(f, pn); } //     if (*++pn == 0) break; //   -  ,  ,   } } void shader(const char** src, int type, int p) { int s = _glCreateShader(type); _glShaderSource(s, 1, src, 0); _glCompileShader(s); _glAttachShader(p, s); } void _start() { dl(); _SDL_Init(SDL_INIT_VIDEO); _SDL_SetVideoMode(W, H, 32, SDL_OPENGL | FULLSCREEN); _glViewport(0, 0, W, H); int p = _glCreateProgram(); shader(shader_vtx, GL_VERTEX_SHADER, p); shader(shader_frg, GL_FRAGMENT_SHADER, p); _glLinkProgram(p); _glUseProgram(p); SDL_Event e; for(;;) { _SDL_PollEvent(&amp;e); if (e.type == SDL_KEYDOWN) break; _glRecti(-1,-1,1,1); _SDL_GL_SwapBuffers(); } _SDL_Quit(); asm ( \ "xor %eax,%eax\n" \ "inc %eax\n" \ "int $0x80\n" \ ); }</span></span></code> </pre><br>  Wow!  Finally, it becomes more or less fleshy and confusing! <br>  What is going on here: we store the libraries we need and the functions of them in one line through zero separators, instead of storing all this data in very loose and poorly packed structures inside the elf header.  Functions from a string are loaded into just an array of pointers, from which they are called at the right time through macros.  It should be noted that the specific types of parameters within reasonable limits do not matter - they will still be aligned to 4 bytes in the stack.  And the return value can be ignored altogether, if it is not needed - all the same, the calling function, by convention, does not expect that eax will be saved.  And the more so it is not necessary to check for errors - only dicks and rags that no one gives are checked for errors. <br>  In the build team, we will undress the binary completely to the goal, leaving it to depend only on ld-linux.so (an interpreter that allows dynamic linking in general), and libld.so, in which the dlopen and dlsym functions lie: <br><pre> <code class="hljs tex">cc -Wall -m32 -c intro.c `pkg-config --cflags sdl` -Os -nostartfiles &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>ld -melf_i386 -dynamic-linker /lib32/ld-linux.so.2 -ldl intro.o -o intro &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>sstrip intro &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>cat intro | 7z a dummy -tGZip -mx=9 -si -so &gt; intro.gz &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>cat unpack_header intro.gz &gt; intro.sh &amp;&amp; chmod +x intro.sh &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>wc -c intro.sh &amp;&amp; <span class="hljs-tag"><span class="hljs-tag">\</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name"> </span></span></span></span>./intro.sh</code> </pre><br>  899 bytes!  You can still score as many as a hundred with fat bytes with Creativity ‚Ñ¢! <br><br>  What can fit there?  For example, the old effect of the tunnel, from which everyone is already sick (yes, that one from the screenshot above). <br>  First we need to drag time into the shaders.  We will not do it as nerds through glUniform, but we will act in a simple way, like yard kids: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">float</span></span> t = _SDL_GetTicks() / <span class="hljs-number"><span class="hljs-number">1000.</span></span> + <span class="hljs-number"><span class="hljs-number">1.</span></span>; _glRectf(-t, -t, t, t);</code> </pre><br>  In order to not lose time in interpolation, we need a little help from the vertex shader: <br><pre> <code class="hljs objectivec"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span> <span class="hljs-keyword"><span class="hljs-keyword">char</span></span>* shader_vtx[] = { <span class="hljs-string"><span class="hljs-string">"varying vec4 p;"</span></span> <span class="hljs-string"><span class="hljs-string">"void main(){gl_Position=p=gl_Vertex;pz=length(p.xy);}"</span></span> };</code> </pre><br>  Everything, now in the pz component we have the current time.  It remains only to stick it to the tunnel. <br>  The tunnel is done simply by the angle a = atan (px, py) and the perspective in a rustic way: z = 1. / length (p.xy), it only remains to generate some texture color = f (a, z, t ).  In the coordinates themselves time, of course, can also be mixed.  And in general, everything can be done, for example, quit reading this nonsense and go for a walk - there is such an awesome clear weather, big clean drifts and a pine forest two steps away from home! <br><br><img src="https://habrastorage.org/storage1/2bb2fcb3/291ef9ff/6c48d4f9/fdf3ed0c.jpg"><br><br>  In general, using the method of scientific iteration, we get this: <br><pre> <code class="hljs smalltalk"><span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;dlfcn.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">SDL</span></span>.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#include</span></span> &lt;<span class="hljs-type"><span class="hljs-type">GL</span></span>/gl.h&gt; <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">W</span></span> <span class="hljs-number"><span class="hljs-number">1280</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">H</span></span> <span class="hljs-number"><span class="hljs-number">720</span></span> <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> <span class="hljs-type"><span class="hljs-type">FULLSCREEN</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span>//<span class="hljs-type"><span class="hljs-type">SDL_FULLSCREEN</span></span> const char* shader_vtx[] = { <span class="hljs-comment"><span class="hljs-comment">"varying vec4 p;"</span></span> <span class="hljs-comment"><span class="hljs-comment">"void main(){gl_Position=p=gl_Vertex;pz=length(p.xy);}"</span></span> }; const char* shader_frg[] = { <span class="hljs-comment"><span class="hljs-comment">"varying vec4 p;"</span></span> <span class="hljs-comment"><span class="hljs-comment">"void main(){"</span></span> <span class="hljs-comment"><span class="hljs-comment">"float "</span></span> <span class="hljs-comment"><span class="hljs-comment">"z=1./length(p.xy),"</span></span> <span class="hljs-comment"><span class="hljs-comment">"a=atan(px,py)+sin(p.z+z);"</span></span> <span class="hljs-comment"><span class="hljs-comment">"gl_FragColor="</span></span> <span class="hljs-comment"><span class="hljs-comment">"2.*abs(.2*sin(pz*3.+z*3.)+sin(p.z+a*4.)*p.xyxx*sin(vec4(z,a,a,a)))+(z-1.)*.1;"</span></span> <span class="hljs-comment"><span class="hljs-comment">"}"</span></span> }; const char dl_nm[] = <span class="hljs-comment"><span class="hljs-comment">"libSDL-1.2.so.0\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_Init\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_SetVideoMode\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_PollEvent\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_GL_SwapBuffers\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_GetTicks\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"SDL_Quit\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"libGL.so.1\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glViewport\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glCreateProgram\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glLinkProgram\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glUseProgram\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glCreateShader\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glShaderSource\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glCompileShader\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glAttachShader\0"</span></span> <span class="hljs-comment"><span class="hljs-comment">"glRectf\0\0\0"</span></span>; // : <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_Init ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">0</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_SetVideoMode ((void(*)(int,int,int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">1</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_PollEvent ((void(*)(void*))dl_ptr[<span class="hljs-number"><span class="hljs-number">2</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_GL_SwapBuffers ((void(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">3</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_GetTicks ((unsigned(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">4</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _SDL_Quit ((void(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">5</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glViewport ((void(*)(int,int,int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">6</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glCreateProgram ((int(*)())dl_ptr[<span class="hljs-number"><span class="hljs-number">7</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glLinkProgram ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">8</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glUseProgram ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">9</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glCreateShader ((int(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">10</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glShaderSource ((void(*)(int,int,const char**,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">11</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glCompileShader ((void(*)(int))dl_ptr[<span class="hljs-number"><span class="hljs-number">12</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glAttachShader ((void(*)(int,int))dl_ptr[<span class="hljs-number"><span class="hljs-number">13</span></span>]) <span class="hljs-symbol"><span class="hljs-symbol">#define</span></span> _glRectf ((void(*)(float,float,float,float))dl_ptr[<span class="hljs-number"><span class="hljs-number">14</span></span>]) static void* dl_ptr[<span class="hljs-number"><span class="hljs-number">15</span></span>]; //  -    static void dl() __attribute__((always_inline)); static void dl() { const char* pn = dl_nm; void** pp = dl_ptr; for(;;) //    { void* f = dlopen(pn, <span class="hljs-type"><span class="hljs-type">RTLD_LAZY</span></span>); //  for(;;) //    precious  { while(*(pn++) != <span class="hljs-number"><span class="hljs-number">0</span></span>); //         if (*pn == <span class="hljs-number"><span class="hljs-number">0</span></span>) break; //    ,     so<span class="hljs-string"><span class="hljs-string">' *pp++ = dlsym(f, pn); } //     if (*++pn == 0) break; //   -  ,  ,   } } static void shader(const char** src, int type, int p) __attribute__((always_inline)); static void shader(const char** src, int type, int p) { int s = _glCreateShader(type); _glShaderSource(s, 1, src, 0); _glCompileShader(s); _glAttachShader(p, s); } void _start() { dl(); _SDL_Init(SDL_INIT_VIDEO); _SDL_SetVideoMode(W, H, 32, SDL_OPENGL | FULLSCREEN); _glViewport(0, 0, W, H); int p = _glCreateProgram(); shader(shader_vtx, GL_VERTEX_SHADER, p); shader(shader_frg, GL_FRAGMENT_SHADER, p); _glLinkProgram(p); _glUseProgram(p); SDL_Event e; for(;;) { _SDL_PollEvent(&amp;e); if (e.type == SDL_KEYDOWN) break; float t = _SDL_GetTicks() / 400. + 1.; _glRectf(-t, -t, t, t); _SDL_GL_SwapBuffers(); } _SDL_Quit(); asm ( \ "xor %eax,%eax\n" \ "inc %eax\n" \ "int $0x80\n" \ ); }</span></span></code> </pre><br><br>  This guy is going to my gcc-4.5.3 in exactly 1024 packed bytes. <br><br>  Okay, we think, it‚Äôs hardly possible to do something even better and more difficult here.  Almost satisfied with ourselves climb to look at what the <a href="http://pouet.net/prod.php%3Fwhich%3D52777">other</a> <a href="http://pouet.net/prod.php%3Fwhich%3D55370">guys</a> in this category are doing ... <br><br>  And we fall into despondency. <br><br>  There is nothing left, you have to climb into the assembler. <br>  But more about that next time. </div><p>Source: <a href="https://habr.com/ru/post/134551/">https://habr.com/ru/post/134551/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../134545/index.html">Uploaded additional builds Android-x86 4.0 for x86</a></li>
<li><a href="../134546/index.html">Spring Framework 3.1 GA released</a></li>
<li><a href="../134547/index.html">Accelerate OpenMP in Visual C ++ 2010</a></li>
<li><a href="../134548/index.html">Droider Chart. Issue 82, public</a></li>
<li><a href="../134549/index.html">Sketch - 100 seconds about the history of the smartphone</a></li>
<li><a href="../134552/index.html">What would YouTube, Facebook and Google+ look like in 1997</a></li>
<li><a href="../134554/index.html">Humble Indie Bundle # 4 has started - pay what you want for 5 great indie games</a></li>
<li><a href="../134557/index.html">Bit operations in PHP with examples</a></li>
<li><a href="../134559/index.html">How to create a "green" code</a></li>
<li><a href="../134563/index.html">Premiere with .toster {mobile applications}</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>