<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>To GIF or not to GIF?</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello! My name is Anton, I am developing the server part of iFunny - a mobile comic service. In this article, I will talk about how our approach to wo...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>To GIF or not to GIF?</h1><div class="post__text post__text-html js-mediator-article">  Hello!  My name is Anton, I am developing the server part of iFunny - a mobile comic service.  In this article, I will talk about how our approach to working with animation in the project evolved and what profits were obtained in the end. <br><br><img src="https://habrastorage.org/storage3/8f6/775/e27/8f6775e27b49eea85bd199fda5002c3b.jpg"><br><br><a name="habracut"></a><br>  It is known that humor slows down the aging process, and laughter prolongs life, which is why we are so pleased to do iFunny, which gives smiles and good mood to more than 4 million users every day (at the moment, unfortunately or fortunately, mostly from the USA) .  We strive to become the most convenient fun-browser in the world, as well as a place where the best humor is born.  Our users download more than 250,000 works per day. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Until recently, we distributed around 150TB of statics per day, but with the addition of animation to the project, we received an increase in the amount of downloadable content by 17% and an increase in daily traffic to 750TB. <br><br><h4>  GIF Optimization </h4><br>  It so happened that at present in GIF the most interesting cuts from humorous (and not so) videos are encoded, which sadly affects the volume of the resulting files.  According to our feelings, the average size of GIF-animation in the modern Internet is about 5Mb.  The logical question that we asked during the development is whether we can somehow optimize the animation on the server side in order to reduce its volume? <br><br>  After conducting a series of experiments with various animated files and optimization algorithms (Basic Frame Optimization, Transparency Optimization), we concluded that the gain from optimization for most of the images turned out to be very small, about 10-20%.  Moreover, if the GIF-animation was already well optimized by its author, then with the automatic approach, we could get the opposite effect. <br><br>  The light of hope that it will be possible to somehow ease the volume of animation files has gone out, and we began to use GIF in the form in which users upload it to us. <br><br><h4>  Release version with GIF </h4><br>  If the implementation of GIF support on the server side and in the iOS client was pretty simple, then on the Android client we had to resort to the tools of bearded Jedi - libgif + JNI, which only provoke us. <br><br>  As soon as everything was finished, we passed the test of censors in the App Store, uploaded the application to Google Play and started ... And immediately after the first day we saw a sharp jump in content views and, accordingly, traffic.  In the first 24 hours the traffic has grown 6 times! <br><br><img src="https://habrastorage.org/storage3/369/e09/c0e/369e09c0e76983f0ac03a66c415ab99e.png"><br><br>  In total for half a month the volume of the distributed traffic increased by 200% and in June, thanks to the launch of the animation in iFunny, we distributed 4.75 Petabytes!  The increase in the activity of the audience, of course, can not but rejoice, but did it all turn out well in the end? <br><br>  We were ready for a certain number of GIF-animations in iFunny, but the statistics we received in the first few days made us understand that we are not quite optimistic: the actual number of loaded GIF-animations per day was 5 times higher than expected.  Coupled with massive 3-4 megabyte GIFs running every 3-5 static images, we received a service that could only be used via WiFi.  Even users with unlimited 3G had a hard time: the animation was loading for a long time, and because of the active work of the 3G module, the device was warming up and killing the battery. <br><br><h4>  Need to do something ... </h4><br>  Against the background of sobering statistics, we wondered: to what extent is the GIF (set of images, in fact) suitable for such use?  We see that if we are dealing with a simple animation containing a small number of frames, the use of a GIF is more than justified.  However, as I said above, a modern humorous GIF is a cutting of interesting moments from video clips ... <br><br>  Based on the foregoing, we decided to try to abandon the GIF in favor of some video format suitable for playing short animated videos.  In this case, it was necessary to find the appropriate encoding format.  Standards for coding h.263, h.264, as well as the video codec vp8 in the container WebM were considered. <br><br>  We carried out GIF video recoding tests, and the light at the end of the tunnel loomed: the size of the resulting videos was 2-10 times smaller than the GIF source! <br><br>  It remains to determine the codec.  The use of the retired codec - h.263 gave a terrible resulting picture and contradicted our moral standards, so we brushed it off first. <br>  h.264 is a good codec, but we did not want to get involved with patented technologies, and the resulting file size was quite large: 20-40% more than when encoding the same fragment in vp8.  Therefore, we decided to stop at vp8. <br><br>  An additional argument when choosing vp8 was also the fact that Google is actively implementing and using it on YouTube, and an improved VP9 format is currently being developed, which makes it possible to judge the success and prospects of the entire project. <br><br>  To convert from GIF to WebM, we use ffmpeg assembly with support for GIF decoder and vp8 encoder.  The process of conversion itself goes without special comments and rather quickly, but immediately we encounter a problem in the resulting video.  Take this GIF animation, for example: <br><br><img src="https://habrastorage.org/storage3/163/095/80b/16309580b0d354725bff2fdabd8d35b3.gif"><br><br>  Please note that the last frame has a delay of 2 seconds, after which the animation is played again.  In the resulting WebM file, this delay somewhere magically disappears, and the last frame ‚Äúskips‚Äù.  Analysis of other content showed that the delay after the last frame of the animation is always removed, which is quite a big problem for us, because we want users in the application not to see the difference between the GIF and the video.  The problem was solved, but with such a crutch that we are still blushing with shame: we add a duplicate of the last frame to the convertible GIF. <br><br>  At the time, hardcore reigned in the ranks of mobile developers: they assembled libvpx for the necessary platforms, wrote a wrapper for C and voila. <br><br><h4>  Release version with WebM </h4><br>  After the release of the version where we began to play short videos instead of GIF-animation, it became clear that the work done had borne fruit: the traffic consumption in one session decreased from inadequate 50-100Mb to quite comfortable 7-20Mb, devices became less heated and killed battery, and most importantly, users began to see content more often than its preloader. <br><br>  If we talk about our handing out traffic, the picture is as follows: <br><br><img src="https://habrastorage.org/storage3/20b/d9f/5c6/20bd9f5c604cc1da08411d337a1eaa65.png"><br><br>  The transition from GIF to WebM has reduced the volume of distributed traffic by 30% and reduced CDN costs by about $ 50,000 per month. <br><br><h4>  findings </h4><br>  The GIF87 format, created more than 20 years ago, was intended by the author to be used to transfer raster images over the network, while the GIF89 modification allowed using images with transparency and storing a set of simple slides with a certain delay ‚Äî animation. <br><br>  On his life path, the format managed to make several significant revolutions, now dying, now being born again. <br><br>  For example, we all remember animated banner ads, which, unfortunately, are still used in some advertising networks.  Yes, now memories of flashing and jerky banners are more associated with hallucinations from LSD, but 10-20 years ago it was a revolution - the Internet ceased to be static. <br><br>  Now GIF is also making a revolution, contributing to the avalanche-like distribution of a new format of humorous content - short video clips.  However, from the height of our experience, we can say that using GIF for such content is not correct for a number of reasons listed above, and only one weighty argument forces users to distribute cuts from video clips in GIF - this is its universal support in all browsers.  We have no hands tied to the possibility of web browsers, so we managed to ‚Äúrevive‚Äù iFunny without the drawbacks inherent in the GIF. </div><p>Source: <a href="https://habr.com/ru/post/191892/">https://habr.com/ru/post/191892/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../191878/index.html">Cloud Startup Market</a></li>
<li><a href="../191880/index.html">[NES] Writing level editor for Prince of Persia. Chapter two Bouquet-candy period</a></li>
<li><a href="../191884/index.html">3D modeling of the environment with a video camera</a></li>
<li><a href="../191886/index.html">Attraction of unprecedented generosity from the University of Eastern Finland</a></li>
<li><a href="../191888/index.html">RailsClub'Moscow 2013. Interview with Ernie Miller</a></li>
<li><a href="../191894/index.html">3CXPhone for Android user guide published</a></li>
<li><a href="../191896/index.html">MegaFon launches Russian accounting system in housing and public utilities</a></li>
<li><a href="../191898/index.html">Android component from scratch - 2 - Magnifier for image</a></li>
<li><a href="../191902/index.html">Create autonomous robot Frank. Part two</a></li>
<li><a href="../191904/index.html">PowerLoader 64-bit updated with new LPE exploits</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>