<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PostgreSQL useful tricks</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The manual has it all. But in order to read and understand it entirely, you can spend years. Therefore, one of the most effective methods of teaching ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PostgreSQL useful tricks</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/files/cdc/47f/83c/cdc47f83c64847e3adda8cece9d9b978.jpg"><br><br>  The manual has it all.  But in order to read and understand it entirely, you can spend years.  Therefore, one of the most effective methods of teaching new Postgres features is to see how colleagues are doing.  On specific examples.  This article may be of interest to those who want to make deeper use of postgres capabilities or are considering switching to this DBMS. <br><a name="habracut"></a><br><br><h2>  Example 1 </h2><br>  Suppose you need to get rows from a table that are not found in another exactly the same table, and with all fields checked for identity. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Traditionally it would be possible to write this (suppose, in table 3, the fields): <br><br><pre><code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> t1.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 t1 <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> table2 t2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> t1.field1 = t2.field1 <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t1.field2 = t2.field2 <span class="hljs-keyword"><span class="hljs-keyword">AND</span></span> t1.field3 = t2.field3 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> t2.field1 <span class="hljs-keyword"><span class="hljs-keyword">IS</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre> <br><br>  Too verbose, in my opinion, and depends on the specific fields. <br>  In the same way, you can use the Record type.  You can get it from the table using the table name itself. <br><br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># SELECT table1 FROM table1; table1 --------- (1,2,3) (2,3,4)</span></span></code> </pre><br><br>  (Output in parentheses) <br><br>  Now finally filter the lines with identical fields. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> table1.* <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> table2 <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> table1 = table2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> table2 <span class="hljs-keyword"><span class="hljs-keyword">Is</span></span> <span class="hljs-literal"><span class="hljs-literal">NULL</span></span>;</code> </pre><br><br>  or a bit more readable: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NOT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">EXISTS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> table2 <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> table2 = table1 );</code> </pre><br><br><h2>  Example 2 </h2><br>  Very vital task.  A letter arrives, ‚ÄúPlease insert such data for users 100, 110, 153, 100500‚Äù. <br>  Those.  You need to insert several lines, where id is different, and the rest is the same. <br>  You can manually make such a ‚Äúfootcloth‚Äù: <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> important_user_table (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, date_added, status_id) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-01-01'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-01-01'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">153</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-01-01'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>), (<span class="hljs-number"><span class="hljs-number">100500</span></span>, <span class="hljs-string"><span class="hljs-string">'2015-01-01'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>);</code> </pre><br><br>  If id is a lot, it is slightly annoying.  Also, I'm allergic to duplicate code. <br><br>  To solve such problems, the posgrace has an ‚Äúarray‚Äù data type, as well as the unnest function, which makes data strings from an array. <br><br>  for example <br><br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># select unnest(array[1,2,3]) as id; id ---- 1 2 3 (3 rows)</span></span></code> </pre><br><br>  Those.  in our example we can write like this <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> important_user_table (<span class="hljs-keyword"><span class="hljs-keyword">id</span></span>, date_added, status_id) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">unnest</span></span>(<span class="hljs-built_in"><span class="hljs-built_in">array</span></span>[<span class="hljs-number"><span class="hljs-number">100</span></span>, <span class="hljs-number"><span class="hljs-number">110</span></span>, <span class="hljs-number"><span class="hljs-number">153</span></span>, <span class="hljs-number"><span class="hljs-number">100500</span></span>]), <span class="hljs-string"><span class="hljs-string">'2015-01-01'</span></span>, <span class="hljs-number"><span class="hljs-number">3</span></span>;</code> </pre><br><br>  those.  The id list is just copy-paste from the letter.  Very comfortably. <br><br>  By the way, if on the contrary you need an array from a query, then for this there is a function that is called so - array ().  For example, select array (select id from important_user_table); <br><br><h2>  Example 3 </h2><br>  For similar purposes, you can use another trick.  Few people know the syntax <br><pre> <code class="sql hljs">VALUES (1, 'one'), (2, 'two'), (3, 'three')</code> </pre><br>  can be used not only in INSERT queries, but also in SELECT, you just need to take in parentheses <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> * <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-string"><span class="hljs-string">'one'</span></span>), (<span class="hljs-number"><span class="hljs-number">2</span></span>, <span class="hljs-string"><span class="hljs-string">'two'</span></span>), (<span class="hljs-number"><span class="hljs-number">3</span></span>, <span class="hljs-string"><span class="hljs-string">'three'</span></span>) ) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> t (digit_number, string_number); digit_number | string_number <span class="hljs-comment"><span class="hljs-comment">--------------+--------------- 1 | one 2 | two 3 | three (3 rows)</span></span></code> </pre><br><br>  Very convenient for handling pairs of values. <br><br><h2>  Example 4 </h2><br>  Suppose you need something to insert, proapdeytit, and get the id of the affected elements.  To do this, it is not necessary to do a lot of queries and create temporary tables.  It is enough to cram it all into a CTE. <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">WITH</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">UPDATE</span></span> table1 <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> x = <span class="hljs-number"><span class="hljs-number">5</span></span>, y = <span class="hljs-number"><span class="hljs-number">6</span></span> <span class="hljs-keyword"><span class="hljs-keyword">WHERE</span></span> z &gt; <span class="hljs-number"><span class="hljs-number">7</span></span> <span class="hljs-keyword"><span class="hljs-keyword">RETURNING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ), inserted <span class="hljs-keyword"><span class="hljs-keyword">AS</span></span> ( <span class="hljs-keyword"><span class="hljs-keyword">INSERT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">INTO</span></span> table2 (x, y, z) <span class="hljs-keyword"><span class="hljs-keyword">VALUES</span></span> (<span class="hljs-number"><span class="hljs-number">5</span></span>, <span class="hljs-number"><span class="hljs-number">7</span></span>, <span class="hljs-number"><span class="hljs-number">10</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">RETURNING</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> <span class="hljs-keyword"><span class="hljs-keyword">updated</span></span> <span class="hljs-keyword"><span class="hljs-keyword">UNION</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">id</span></span> <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> inserted;</code> </pre><br>  But be very careful.  All CTE subexpressions are executed in parallel with each other, and their sequence is not defined at all.  Moreover, they use the same version (snapshot), i.e.  if in one subexpression you add something to the table field, in another you subtract it, then it is possible that one of them will work. <br><br><h2>  Example 5 </h2><br><br>  Suppose in some table called stats there is data for only one day: <br><br><pre> <code class="sql hljs">postgres=<span class="hljs-comment"><span class="hljs-comment"># select * from stats; added_at | money ------------+-------- 2016-04-04 | 100.00 (1 row)</span></span></code> </pre><br><br>  And you need to display the article for some period, replacing the missing data with zeros.  This can be done using generate_series <br><br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">SELECT</span></span> gs.added_at, <span class="hljs-keyword"><span class="hljs-keyword">coalesce</span></span>(stats.money, <span class="hljs-number"><span class="hljs-number">0.00</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> money <span class="hljs-keyword"><span class="hljs-keyword">FROM</span></span> generate_series(<span class="hljs-string"><span class="hljs-string">'2016-04-01'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span>, <span class="hljs-string"><span class="hljs-string">'2016-04-07'</span></span>::<span class="hljs-built_in"><span class="hljs-built_in">date</span></span> , <span class="hljs-built_in"><span class="hljs-built_in">interval</span></span> <span class="hljs-string"><span class="hljs-string">'1 day'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> gs(added_at) <span class="hljs-keyword"><span class="hljs-keyword">LEFT</span></span> <span class="hljs-keyword"><span class="hljs-keyword">JOIN</span></span> stats <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> stats.added_at = gs.added_at; added_at | money <span class="hljs-comment"><span class="hljs-comment">------------------------+-------- 2016-04-01 00:00:00+03 | 0.00 2016-04-02 00:00:00+03 | 0.00 2016-04-03 00:00:00+03 | 0.00 2016-04-04 00:00:00+03 | 100.00 2016-04-05 00:00:00+03 | 0.00 2016-04-06 00:00:00+03 | 0.00 2016-04-07 00:00:00+03 | 0.00 (7 rows)</span></span></code> </pre><br><br>  Of course, this trick works not only with dates, but also with numbers.  And you can use several generate_series in one query: <br><pre> <code class="sql hljs">teasernet_maindb=&gt; <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> generate_series (<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">10</span></span>), generate_series(<span class="hljs-number"><span class="hljs-number">1</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span>); generate_series | generate_series <span class="hljs-comment"><span class="hljs-comment">-----------------+----------------- 1 | 1 2 | 2 3 | 1 4 | 2 5 | 1 6 | 2 7 | 1 8 | 2 9 | 1 10 | 2 (10 rows)</span></span></code> </pre><br><h1>  Example n + 1 </h1><br>  In general, I write articles on Habr to get some new experience from the comments) <br>  Please write what you use in your daily work.  Something that is not possible for everyone is obvious, especially for people who have moved from other DBMS, for example, from the same mysql? </div><p>Source: <a href="https://habr.com/ru/post/280912/">https://habr.com/ru/post/280912/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../280902/index.html">Rust and Swift (third, fourth, fifth and sixth parts)</a></li>
<li><a href="../280904/index.html">man! (C => D => Rust)</a></li>
<li><a href="../280906/index.html">5th International Mobile Conference MBLT16 in a month</a></li>
<li><a href="../280908/index.html">Guiding Eyes transfers data to the IBM Cloud to improve the quality of care for blind people.</a></li>
<li><a href="../280910/index.html">Vulnerabilities in MyChat by NetworkSoftwareSolutions (fixed and none)</a></li>
<li><a href="../280914/index.html">Sandbox for programmers</a></li>
<li><a href="../280922/index.html">Konami code or read between the lines</a></li>
<li><a href="../280928/index.html">Easy insertion of multiline pattern literals into JavaScript code</a></li>
<li><a href="../280930/index.html">Palantir: how to detect a botnet</a></li>
<li><a href="../280932/index.html">QtWebApp is a step-by-step chewed example with detailed comments.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>