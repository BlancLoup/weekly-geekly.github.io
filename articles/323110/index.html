<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protect a remote terminal server or two-factor authentication of RDG clients using Azure MFA</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The realities of the countries where most habrovchan people live are such that keeping servers with important information outside the country of busin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protect a remote terminal server or two-factor authentication of RDG clients using Azure MFA</h1><div class="post__text post__text-html js-mediator-article"><div style="text-align:center;"><img src="https://habrastorage.org/files/9a9/0a2/d4b/9a90a2d4b3e34f14bbd07f9e08dab1c4.png" alt="Azure MFA for RDG"></div><br><br>  The realities of the countries where most habrovchan people live are such that keeping servers with important information outside the country of business has become a good tone, allowing you to save your nerves and data. <br><br>  The first question that arises when moving to the cloud after data is encrypted, or maybe before it, is a guarantee that the data is accessed by the user account by the user, and not by someone else.  And if a good way to encrypt data hosted in a private cloud is covered in an <a href="https://habrahabr.ru/post/315972/">article by my colleague</a> , then authentication is more complicated. <br><a name="habracut"></a><br><div class="spoiler">  <b class="spoiler_title">Pro users and methods of protection</b> <div class="spoiler_text">  The nature of a typical user is such that the preservation of passwords from user accounts is a rather frivolous attitude and cannot be corrected.  Our experience shows that even if a company has strict policies, user training, etc., there will still be an unencrypted device that leaves the office, and looking through the list of products of one well-known company you understand that retrieving passwords from an unencrypted device is only a matter of time. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Some companies to establish access to data in the cloud establish tunnels between the cloud and the office, prohibit remote access <a href="https://habrahabr.ru/company/pc-administrator/blog/320016/">https://habrahabr.ru/company/pc-administrator/blog/320016/</a> .  In our opinion, this is not a completely optimal solution, firstly, some of the advantages of the cloud solution are lost, and secondly, there are performance problems noted in the article. <br><br>  The solution using the terminal server and <strong>Remote Desktop Gateway (RDG) is</strong> more flexible, you can configure a high level of security, as described by my colleague <a href="https://habrahabr.ru/post/134860/">https://habrahabr.ru/post/134860/</a> (2011 article, but the principle itself is still relevant) .  This method allows you to prevent the transfer of data from the cloud, but imposes restrictions on the user's work and does not completely solve the authentication problem; rather, it is a DLP solution. <br><br>  Perhaps the best way to ensure that an attacker does not work under a user account is <strong>two-factor authentication</strong> .  The articles of my colleague <a href="https://habrahabr.ru/post/271113/">https://habrahabr.ru/post/271259/ https://habrahabr.ru/post/271113/</a> describes how to configure MFA from Microsoft and Google for client VPN.  The method is good, but, firstly, it requires the availability of CISCO ASA, which is not always easily realizable, especially in budget clouds, and secondly, work via VPN is inconvenient.  Working with a terminal session via RDG is much more comfortable, and the SSL encryption protocol looks more versatile and reliable than VPN from CISCO. <br><br>  There are many solutions with two-factor authentication on the terminal server itself, here is an example of setting up a free solution - <a href="http://servilon.ru/dvuhfaktornaya-autentifikaciya-otp/">http://servilon.ru/dvuhfaktornaya-autentifikaciya-otp/</a> .  This solution, unfortunately, does not work through RDG. <br><br></div></div><br>  The benefits of <a href="http://servilon.ru/dvuhfaktornaya-autentifikaciya-otp/"><strong>Microsoft Azure Multi-Factor Authentication Server (MFAS) are</strong></a> described in the above article, so I‚Äôll not bring them again, but let's start with the settings right away. <br><br>  In order not to increase the volume of this article, we omit the initial installation and configuration of the RDG server, which authorizes users by login and password. <br><br>  For clarity, here‚Äôs an authentication RDG request when using Azure MFA.  The RDG server is running the Network Policy Server (NPS) role, which allows to forward Radius requests.  The MFA server will be deployed in a separate virtual machine in the internal structure of the enterprise. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/eaa/352/d4a/eaa352d4a4334c63bd4595d8453c2797.png" alt="Shema rdg zapros"></div><br><br>  The RDG server asks for confirmation of authorization from the MFA server.  MFA, depending on the chosen authentication method, calls, sends SMS or sends a request to the mobile application.  The user confirms or rejects the request for access.  The MFA returns the result of the second authentication factor to the RDG server. <br><br><h3>  Install and configure Azure Multi-Factor Authentication Server </h3><br><h4>  <b>Creating an authentication provider in the Microsoft Azure portal</b> </h4><br>  Go to Microsoft Azure (account must have a subscription or trial version installed) and find Multi-Factor Authentication (MFA). <br><br>  <i>At the moment, the MFA management is not added to the new version of the Azure portal, so the old version of the portal will open.</i> <br><br>  To create a new multifactor authentication provider, click ‚ÄúCREATE ‚Üí Application Services ‚Üí Active directory ‚Üí Multifactor Authentication Provider ‚Üí Quick Creation‚Äù at the bottom left.  Specify the name and usage model. <br><br>  <i>The usage model depends on how the payment will be charged, either by the number of users, or by the number of authentications.</i> <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/05f/b51/b28/05fb51b28fbb4e6b84fd9f2e058aa8ba.png" alt="sozdanie postavshika mpp"></a> </div><br>  Once created, the MFA will appear in the list.  Next, go to the management by clicking the appropriate button. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/9e1/01d/aee/9e101daee79542d4a9e7736acc451b8c.png" alt="azure active directory"></a> </div><br>  Go to download and download MFA server <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/7a6/43f/555/7a643f5558924c3f9005dddc3f07252f.png" alt="download MFA"></a> </div><br><h4>  <b>Deploying MFA Server</b> </h4><br>  Installing the MFA server is necessary on a virtual machine other than the RDG server.  Operating systems older than Windows Server 2008 or Windows 7 are supported. Microsoft .NET Framework 4.0 is required. <br><br>  The following addresses must be available on port 443: <br><br><ul><li>  <a href="">pfd.phonefactor.net;</a> </li><li>  <a href="">pfd2.phonefactor.net;</a> </li><li>  <a href="https://css.phonefactor.net/">css.phonefactor.net</a> . </li></ul><br>  Install the MFA server, when installing, we refuse the setup wizard. <br><br>  When you first start, you must enter the data from the account that must be generated on the server's boot page. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/59e/0f4/d4e/59e0f4d4e65e4ec48098b1f92827f965.png" alt="dannye ot uchetnoj zapisi"></a> </div><br>  Next, add users.  To do this, go to the Users section and click on Import from Active Directory, select the users to import. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/2fa/c9f/34c/2fac9f34c70c4dacb710b79baaca9082.png" alt="new MFA users"></a> </div><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/917/c51/611/917c51611f0047b28d031510af4ffb68.png" alt="new MFA users"></a> </div><br>  If necessary, you can configure the automatic addition of new users from AD: <br><br>  ‚ÄúDirectory Integration ‚Üí Synchronization ‚Üí Add‚Äù, and so on.  Add a directory that will be automatically synchronized over the specified time interval. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/bb6/3e0/927/bb63e0927bf6496ca8709710393d448f.png" alt="add synchronization item"></a> </div><br>  We will test the server MFA.  Go to the Users section.  For your account, specify the phone number (if not already set) and select the ‚ÄúPhone Ring‚Äù authentication method.  Press the Test button and enter the login, password.  A call should come to the phone.  Answer it and press #. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/27a/aea/c91/27aaeac91fd04d75b84f5727e3977c2f.png" alt="test users MFA"></a> </div><br><h4>  <b>Configuring the MFA server to work with Radius requests</b> </h4><br>  Go to the section Radius Authentication and put a tick "Enable RADIUS Authentication". <br><br>  We add a new client, indicating the IP address of the NPS server and the shared secret key.  If authentication is to be performed for all users, check the corresponding box (in this case, all users must be added to the MFA server). <br><br>  It is also necessary to make sure that the ports specified for the connection correspond to the ports specified on the NPS server and are not blocked by the firewall. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/b76/065/859/b760658592924bf8911aafd168bb2151.png" alt="radius authentication"></a> </div><br>  Go to the Target tab and add the Radius server. <br><br><div style="text-align:center;"> <i><a href=""><img src="https://habrastorage.org/files/110/011/7f3/1100117f3b274f078e896a32e0b6d7b4.png" alt="radius authentication target"></a></i> </div><br>  <i>Note: If there is no central NPS server in the network, the Radius client and server IP addresses will be the same.</i> <br><br><h4>  <b>Configuring RDG and NPS server to work with MFA</b> </h4><br>  Remote Desktop Gateway must be configured to send requests to the MFA Radius server.  To do this, open the gateway properties and go to the ‚ÄúRDG CAP Store‚Äù tab, select ‚ÄúNPS running on a central server‚Äù and specify the address of the MFA server and the shared secret key. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/163/8f2/6e0/1638f26e048e4676a6476c8e6d90730f.png" alt="RDG CAP store"></a> </div><br>  Next, configure the NPS server.  Expand the section "Clients and Servers Radius ‚Üí Remote Radius Server Groups".  Open the properties of the group ‚ÄúTS gateway server group‚Äù (the group is created when configuring RDG) and add our MFA server. <br><br>  When adding, on the tab "Load Balancing" we increase the server timeout limits.  We set "The number of seconds without an answer, after which the request is considered to be dropped" and "The number of seconds between requests, after which the server is considered unavailable" in the range of 30-60 seconds. <br><br>  On the ‚ÄúAuthentication / Accounting‚Äù tab, we check the correctness of the specified ports and set the shared secret key. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/f67/51c/3ba/f6751c3bac6142e191441106c9301808.png" alt="RDG Authentication / Accounting"></a> </div><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/6f4/5d9/52b/6f45d952b87846cb983c0a477f0dca5e.png" alt="RDG Authentication / Accounting"></a> </div><br>  Now go to the section ‚ÄúClients and Servers Radius ‚Üí Clients Radius‚Äù and add the MFA server, specifying the ‚ÄúFriendly name‚Äù, address and shared secret. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/432/a92/9ee/432a929ee95d4ace8eb6c4c346b07e88.png" alt="Radius Friendly name"></a> </div><br>  Go to the "Policies ‚Üí Connection Request Policies" section.  In this section there should be a policy created when configuring the RDG.  This policy sends Radius requests to the MFA server. <br><br>  Duplicate policy and go to its properties.  Add a condition that matches the ‚ÄúClient Friendly Name‚Äù with the ‚ÄúFriendly name‚Äù specified in the previous step. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/405/657/9f6/4056579f69fb4c0c9671f09bcc7706e7.png" alt="Radius policy properties"></a> </div><br>  On the Settings tab, we change the authentication service provider to a local server. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/12a/c87/c15/12ac87c159be4553aa21d25121486415.png" alt="Radius policy properties settings"></a> </div><br>  This policy will ensure that when Radius receives a request from the MFA server, the request will be processed locally, which will eliminate the looping of requests. <br><br>  We check that this policy is located above the original one. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/5c9/81e/123/5c981e1233ed4ecfa0e842ca9c9bf0a5.png" alt="NPS policy"></a> </div><br>  At this stage, a bunch of RDG and MFA is in working condition.  The following steps are necessary for those who need to be able to use authentication using a mobile application or to provide users with access to some multifactor authorization settings through a custom portal. <br><br><h3>  Install SDK, Mobile Application Web Services and Custom Portal </h3><br>  Connection to these components is made via the HTTPS protocol.  Therefore, on the server where they will be deployed, you must install an SSL certificate. <br><br>  The user portal and mobile app web service use the SDK to communicate with the MFA server. <br><br><h4>  <b>Install SDK</b> </h4><br>  The SDK is installed on the MFA server and requires IIS, ASP.NET, Basic Authentication, which must be pre-installed using the Server Manager. <br><br>  To install the SDK, go to the Web Service SDK section of the Multi-Factor Authentication Server and click the install button, follow the installation wizard. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/3cf/dfd/c70/3cfdfdc7013c4aa48bffe3275d26cae0.png" alt="Web Service SDK in Multi-Factor Authentication Server"></a> </div><br><h4>  <b>Installing Mobile Application Web Service</b> </h4><br>  This service is required for the mobile application to interact with the MFA server.  For the service to work correctly, the computer to which it will be installed must have Internet access and port 443 is open for connection from the Internet. <br><br>  The service installation file is located in the <b>C: \ Program Files \ Azure Multi-Factor Authentication</b> folder on the computer with the MFA installed.  Run the installer and follow the installation wizard.  For the convenience of users, you can replace the virtual directory name ‚ÄúMultiFactorAuthMobileAppWebService‚Äù with a shorter one. <br><br>  After installation, go to the folder <b>C: \ inetpub \ wwwroot \ MultiFactorAuthMobileAppWebService and change the file web.config</b> .  In this file, you need to set the keys <b>WEB_SERVICE_SDK_AUTHENTICATION_USERNAME and WEB_SERVICE_SDK_AUTHENTICATION_PASSWORD</b> , responsible for the account included in the security group PhoneFactor Admins.  This account will be used to connect to the SDK. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/249/9a6/c73/2499a6c7393242638946b56c328951b9.png" alt="edit web.config"></a> </div><br>  In the same file, you must specify the URL address where the SDK is available. <br><br>  <i>Note: The connection to the SDK is made using the SSL protocol, therefore, it is necessary to refer to the SDK by the server name (specified in the SSL certificate), and not by the IP address.</i>  <i>If the call is made using a local name, you need to add a corresponding entry to the hosts file in order to use the SSL certificate.</i> <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/a50/456/7b0/a504567b035347fc9403445052f2710e.png" alt="edit web.config"></a> </div><br>  Add the URL for which the mobile application web service is available to the Multi-Factor Authentication Server application in the Mobile App section.  This is necessary to correctly generate the QR code in the user portal for connecting mobile applications. <br><br>  Also in this section, you can tick the ‚ÄúEnable OATH tokens‚Äù checkbox, which allows using the mobile application as a Software token, to generate one-time passwords based on time. <br><br><h4>  <b>Installing a custom portal</b> </h4><br>  Installation requires IIS, ASP.NET and the IIS 6 meta base compatibility role (for IIS 7 or later). <br><br>  If the portal is installed on the MFA server, it is enough to go to the User Portal section in the Multi-Factor Authentication Server, click the install button and follow the installation wizard.  If the computer is joined to a domain, then during installation a user will be created that is a member of the PhoneFactor Admins security group.  This user is required to securely connect to the SDK. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/e54/9ac/397/e549ac397b474a3c9f7f5938186359ba.png" alt="MFA UserPortal"></a> </div><br>  When installing on a separate server, you must copy the installation file from the MFA server (the installation file is located in the <b>C: \ Program Files \ Multi-Factor Authentication Server</b> folder).  Install and edit the <b>web.config file</b> in the location <b>C: \ inetpub \ wwwroot \ MultiFactorAuth</b> .  In this file, you need to change the <b>USE_WEB_SERVICE_SDK</b> key from false to true.  Specify the details of the account belonging to the PhoneFactor Admins group in the keys <b>WEB_SERVICE_SDK_AUTHENTICATION_USERNAME and WEB_SERVICE_SDK_AUTHENTICATION_PASSWORD</b> .  And specify the URL address of the SDK service, not forgetting, if necessary, correct the hosts file so that the SSL protocol works. <br><br>  Add a URL where the user portal is available in the Multi-Factor Authentication Server application in the User Portal section. <br><br><h4>  <b>Showcase Azure MFA for RDG Connection Authentication</b> </h4><br>  Consider the work of MFA will be from the user.  In our case, the second authentication factor will be the mobile application, since the cellular network has a number of vulnerabilities, which, with proper training, intercept calls and SMS. <br><br>  First of all, the user will need to log in to the user portal and enter his phone number (if not listed in AD) and link the mobile application to the account.  We go to the portal under your account and enter the answers to secret questions (we will need them in case of restoration of access to the account). <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/2c5/071/122/2c507112270b4a94ad8ef7c1662b783d.png" alt="MFA UserPortal test"></a> </div><br>  Next, select the authentication method, in our case, the mobile application and press the "Create activation code" button.  A QR code will be generated, which must be scanned in a mobile application. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/1ae/d97/fd5/1aed97fd5a9d4946abacf3ca495cfadf.png" alt="MFA UserPortal test"></a> </div><br>  Since when importing users to the MFA server, authentication was provided using a PIN code, we will be asked to create it.  Enter the desired PIN code and click "Verify my authenticity."  In the mobile application, you must confirm the appeared request.  After these actions, we have an application attached to the account and full access to the portal to change personal settings. <br><br><div style="text-align:center;"> <i><a href=""><img src="https://habrastorage.org/files/eed/ef2/df0/eedef2df09f74f67931c671dc36014f2.png" alt="MFA UserPortal test"></a></i> </div><br>  <i>Note: The list of settings that a user can change through the portal is set by the administrator in the Multi-Factor Authentication Server application.</i> <br><br>  Next, consider connecting via RDG. <br><br>  We create RDP connection, we specify our gateway and we are connected. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/ec1/407/0d6/ec14070d6949494793c507f60b04a827.png" alt="RDP connection"></a> </div><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/2fe/716/d01/2fe716d014084039a0d4941b0e2b793e.png" alt="RDP connection"></a> </div><br>  Enter the account information for authorization on the RDG server. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/66a/f5e/8a0/66af5e8a090a49ba992592f5f961aba4.png" alt="RDP connection"></a> </div><br>  We confirm the request in the mobile application <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/82d/8b5/07d/82d8b507da2141038dfce2a430e1ca38.png" alt="RDP connection"></a> </div><br>  Enter the account information for authorization on the connected machine and wait for the connection. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/740/d33/ae3/740d33ae3edc4632ba1c9d0ff3b5f0e1.png" alt="RDP connection"></a> </div><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/f7d/d32/e4b/f7dd32e4b1444111b4513993b711e366.png" alt="RDP connection"></a> </div><br>  <i>Note: If the phone is equipped with a fingerprint sensor, the Authenticator application will offer to associate the PIN code with the fingerprint, in order to further confirm the authentication by simply touching the phone.</i> <br><br>  <b>The authentication methods offered by Azure MFA:</b> <br><br>  Phone ring: <br><br><ul><li>  pressing # </li><li>  enter PIN code and press # </li></ul><br>  SMS - you can use OTP or OTP + PIN: <br><br><ul><li>  One-Way - the received code must be entered in the additional field during authorization </li><li>  Two-Way - the received code must be sent back by SMS </li></ul><br>  Mobile app: <br><br><ul><li>  Simple confirmation </li><li>  You must enter the PIN code to confirm </li></ul><br><br>  OATH token - during authorization, you will need to enter a code from the token screen in the additional field.  You can use a mobile application as a token. <br><br>  <i>SMS One-Way and OATH token methods are not universal, as they require an additional field to enter the code when authorizing.</i> <br><br>  In conclusion, we will talk about the MFA function, which allows you to monitor and defend against intruders trying to gain access without having the second authentication factor. <br><br>  In the Azure portal in the MFA control panel, you can enable the feature that allows users to mark the incoming authentication request as fraudulent.  It is also possible to automatically block the user upon receipt of this message and send an email notification to the support service. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/c0c/eaf/093/c0ceaf09334745bb9a5f29db8845d5fc.png" alt="MFA portal"></a> </div><br>  After this feature is enabled, users who have denied the authentication request will be shown a message asking them to notify the helpdesk about an illegitimate login attempt. <br><br> <a href=""><img src="https://habrastorage.org/files/800/6f3/ba9/8006f3ba91b9485db4c2fe37b2798c37.png" alt="MFA portal" width="197" height="350"></a> <a href=""><img src="https://habrastorage.org/files/be6/df4/15f/be6df415f4fe41aeba0fa85734fbfd85.png" alt="MFA portal" width="197" height="350"></a> <br><br>  In the Azure MFA control panel there is a report displaying notifications of fraud: <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/131/014/d9b/131014d9b4e142b3b8513de450568fa4.png" alt="Report Azure MFA"></a> </div><br>  If you need to know the IP address from which the RDP session was initialized, you can view the logs of the RDG server in the Event Viewer.  If the second authentication factor is not passed, the event will have the status Error, and the description will indicate the IP address from which the RDP connection was established. <br><br><div style="text-align:center;"> <a href=""><img src="https://habrastorage.org/files/9d2/a73/703/9d2a73703867466eb4a313518135f19c.png" alt="MFA error 23003"></a> </div><br>  <b>References on the article:</b> <br><br>  ‚Üí <a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication-get-started-server-rdg" rel="nofollow">Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS</a> <br>  ‚Üí <a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication-get-started-portal" rel="nofollow">User Portal</a> <br>  ‚Üí <a href="https://docs.microsoft.com/en-us/azure/multi-factor-authentication/multi-factor-authentication-get-started-server-webservice" rel="nofollow">Mobile App Web Service</a> </div><p>Source: <a href="https://habr.com/ru/post/323110/">https://habr.com/ru/post/323110/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323096/index.html">.Net Core, AppDomain, WCF, RPC marshalling TCP / Ip your bike</a></li>
<li><a href="../323100/index.html">IceCash 2.0 Web Workstation Cashier and AIS for exchanging data with cash registers for Linux to Python</a></li>
<li><a href="../323102/index.html">Another way to localize applications</a></li>
<li><a href="../323106/index.html">Accelerate Node.js with Rust</a></li>
<li><a href="../323108/index.html">Two providers simultaneously or Dual ISP with VRF on Cisco | Part 2</a></li>
<li><a href="../323112/index.html">OSSEC note on configuring parsers (decoders)</a></li>
<li><a href="../323114/index.html">Quadstor - a virtual SAN for state employees</a></li>
<li><a href="../323116/index.html">Solving Winter CrackMe Problems</a></li>
<li><a href="../323118/index.html">We put networks - we catch robots</a></li>
<li><a href="../323120/index.html">Rust game development. My history</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>