<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>QML application integration with web resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello, dear habrazhitel! I want to tell how to integrate the program in the newfangled QML language with web resources. 

 QML itself is a declarative...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>QML application integration with web resources</h1><div class="post__text post__text-html js-mediator-article">  Hello, dear habrazhitel!  I want to tell how to integrate the program in the newfangled QML language with web resources. <br><br>  QML itself is a declarative JavaScript-like programming language that is included in the Qt framework.  Qt developers are serious and promote it as the main interface creation tool.  Moreover, a lot of things can be done without resorting to C ++ at all, including the ability to work with web servers. <br><br>  Web technologies are increasingly penetrating our lives, we often use various web resources.  It is not always convenient to launch a browser for this, sometimes a separate client application is much more convenient, as the number of clients for various social networks, for example, on mobile platforms, speaks eloquently. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Given that Qt 5.1, the alpha version of which came out last week, includes initial support for Android and iOS, this topic may be of particular interest to those who are eyeing Qt or are actively mastering it.  In this article I will tell you how to organize work with web resources from a QML application using the example of the VKontakte API. <br><br>  Just in case, I note that I am considering the latest stable version of Qt 5.0.2.  In earlier versions of some features may not be. <br><a name="habracut"></a><br><h5>  What is XMLHttpRequest and why is it needed? </h5><br>  Surely, many of the readers have heard about such technology as AJAX (Asynchronous JavaScript And XML).  It allows you to send asynchronous requests to the server and update the page content without reloading it.  In modern browsers there are various tools for this, XMLHttpRequest is one of them.  Since QML is a JavaScript-like language and the JavaScript environment is similar to browser-based, XMLHttpRequest is also present.  Further in the text I will also write down its name in abbreviated form - XHR. <br><br>  Actually, what is it and what does it give us?  It is a tool for asynchronous (synchronous also supported in browsers) HTTP requests.  Despite its name, it allows you to transfer data not only in XML format, although it was originally designed specifically for this.  The implementation in the QML engine supports the following HTTP requests: GET, POST, HEAD, PUT and DELETE.  Basically, we will use the first two. <br><br>  A distinctive feature of the XHR implementation in QML is that requests can be sent to any host, there are no such restrictions as in the browser. <br><br><h5>  XMLHttpRequest procedure </h5><br>  The process of working with XHR is as follows. <br><br>  1. Create an XHR object: <br><br><pre><code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest()</code> </pre> <br><br>  2. Initialize the object, specifying the type of the request (also known as the HTTP method), the address and, if necessary, the request parameters <a href="http://ru.wikipedia.org/wiki/URL">[1]</a> that need to be sent to the server: <br><br><pre> <code class="javascript hljs">request.open(<span class="hljs-string"><span class="hljs-string">'GET'</span></span>, <span class="hljs-string"><span class="hljs-string">'http://site.com?param1=value1&amp;param2=value2'</span></span>)</code> </pre><br><br>  The first parameter is the request type, the second is the URL.  For a GET request, the parameters must be passed here, separating them from the address with a '?'.  Parameters are separated by '&amp;'. <br><br>  For a POST request, you need to specify the content type.  If we pass the data to the request parameters, this is done as follows: <br><br><pre> <code class="javascript hljs">request.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>)</code> </pre><br><br>  3. Set the handler to change the status of the request.  In most cases, we just have to wait until the request is completed and then process the result or errors.  At the end of the request, the readyState parameter will be equal to XMLHttpRequest.DONE (for details, see values ‚Äã‚Äãin <a href="https://developer.mozilla.org/en-US/docs/DOM/XMLHttpRequest">[2]</a> ). <br><br><pre> <code class="javascript hljs">request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.readyState === XMLHttpRequest.DONE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.status === <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(request.responseText) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"HTTP request failed"</span></span>, request.status) } } }</code> </pre><br><br>  Our anonymous function will call each time the readyState property changes.  We are interested in the completion of the request, after which we check whether it was successful.  To do this, we check the code of its status with the code of successful completion (200).  HTTP is a text protocol and in addition to numeric code values, a text description is also transmitted, so you can compare the statusText property with the string corresponding to this status, in this case, the ‚ÄúOK‚Äù string: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.statusText === <span class="hljs-string"><span class="hljs-string">'OK'</span></span>)</code> </pre><br><br>  In case of an error, status and statusText will contain the code and text description of the HTTP status codes (for example, 404 and ‚ÄúNot Found‚Äù, respectively). <br><br>  4. Send the request. <br><br><pre> <code class="javascript hljs">request.send()</code> </pre><br><br>  In the case of POST, here you need to pass the request parameters: <br><br><pre> <code class="javascript hljs">request.send(<span class="hljs-string"><span class="hljs-string">'param1=value1&amp;param2=value2'</span></span>)</code> </pre><br><br>  In the query parameters, you can pass not all characters.  Therefore, both the parameter and the value should be encoded and, if necessary, decoded respectively by special functions - encodeURIComponent () and decodeURIComponent ().  Usage example: <br><br><pre> <code class="javascript hljs">request.send(<span class="hljs-string"><span class="hljs-string">'%1=%2'</span></span>.arg(<span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(param)).arg(<span class="hljs-built_in"><span class="hljs-built_in">encodeURIComponent</span></span>(value)))</code> </pre><br><br>  It is recommended that the encoded string be further processed and replaced with the sequence "% 20" (i.e., the encoded space) with the '+' character.  Before decoding, respectively, do the opposite. <br><br>  Typically, request parameters are passed simple type values.  You can pass an array, but the syntax is somewhat muddy.  For example, sending a params array of two values ‚Äã‚Äãwould look like this: <br><br><pre> <code class="javascript hljs">request.send(<span class="hljs-string"><span class="hljs-string">'params[]=value1&amp;params[]=value2'</span></span>)</code> </pre><br><br>  If you get it, you can even pass objects as values ‚Äã‚Äã(!), But this may not be entirely reliable, in the sense that on the receiving side it can turn into an array :) <br><br>  Using POST requests we can transmit data not only by the parameters of the request but also in the body of the request.  For example, you can send data in JSON format.  To do this, you need to set the correct Content-Type and Content Size (Content-Length).  An example of sending such a request: <br><br><pre> <code class="javascript hljs">request.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/json'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-attr"><span class="hljs-attr">param1</span></span>: value1, <span class="hljs-attr"><span class="hljs-attr">param2</span></span>: value2 } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> data = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.stringify(params) request.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Length'</span></span>, data.length) request.send(data)</code> </pre><br><br>  Here JSON is a global object available in QML that provides tools for working with this format <a href="https://developer.mozilla.org/en-US/docs/JavaScript/Reference/Global_Objects/JSON">[3]</a> . <br><br>  In fact, the format in which we can transfer data is determined by the server.  If he accepts JSON - fine, JSON helmet.  Expects that the data will come in the request parameters - so it should be sent. <br><br>  Now that we have studied the necessary theoretical information, we will begin to practice and work with VKontakte. <br><br><h5>  Retrieving and displaying friends list </h5><br>  To begin, consider a simple example with methods that do not require authorization and other unnecessary gestures.  Getting a list of friends falls into this category.  We will write a simple program that, when it starts, sends an XHR to receive a list of friends and after receiving it, displaying the names of users and their avatars. <br><br>  Most of the code is the display interface and it makes no sense to describe it specifically.  I note only that if a JavaScript object or an array is used as a model, then modelData is used instead of model to get the data to the model. <br><br>  The most interesting part here is working with the server.  To access the VK API there is a special address: <a href="https://api.vk.com/method/">api.vk.com/method</a> .  We add the name of the method to the received address (the list of methods can be found in <a href="https://vk.com/dev/methods">[4]</a> ), in our case it is the friends.get method.  To this address you need to send a POST or GET request with the necessary parameters.  The answer will come in JSON format.  We need to pass the user ID in the uid parameter.  Also, in the fields parameter, we will also pass photo_medium to get a photo and so that it is not of the smallest size. <br><br>  Below the actual source code.  The userId in main is the user ID. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> QtQuick <span class="hljs-number"><span class="hljs-number">2.0</span></span> Rectangle { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: main property int userId: XXX property <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> friends width: <span class="hljs-number"><span class="hljs-number">320</span></span> height: <span class="hljs-number"><span class="hljs-number">640</span></span> color: <span class="hljs-string"><span class="hljs-string">'skyblue'</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFriends</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> request = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> XMLHttpRequest() request.open(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://api.vk.com/method/friends.get'</span></span>) request.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.readyState === XMLHttpRequest.DONE) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.status &amp;&amp; request.status === <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"response"</span></span>, request.responseText) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(request.responseText) main.friends = result.response } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"HTTP:"</span></span>, request.status, request.statusText) } } } request.setRequestHeader(<span class="hljs-string"><span class="hljs-string">'Content-Type'</span></span>, <span class="hljs-string"><span class="hljs-string">'application/x-www-form-urlencoded'</span></span>) request.send(<span class="hljs-string"><span class="hljs-string">'fields=photo_medium&amp;uid=%1'</span></span>.arg(main.userId)) } ListView { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: view anchors.margins: <span class="hljs-number"><span class="hljs-number">10</span></span> anchors.fill: parent model: friends spacing: <span class="hljs-number"><span class="hljs-number">10</span></span> delegate: Rectangle { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: view.width height: <span class="hljs-number"><span class="hljs-number">100</span></span> anchors.horizontalCenter: parent.horizontalCenter color: <span class="hljs-string"><span class="hljs-string">'white'</span></span> border { <span class="hljs-attr"><span class="hljs-attr">color</span></span>: <span class="hljs-string"><span class="hljs-string">'lightgray'</span></span> width: <span class="hljs-number"><span class="hljs-number">2</span></span> } radius: <span class="hljs-number"><span class="hljs-number">10</span></span> Row { anchors.margins: <span class="hljs-number"><span class="hljs-number">10</span></span> anchors.fill: parent spacing: <span class="hljs-number"><span class="hljs-number">10</span></span> Image { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: image height: parent.height fillMode: Image.PreserveAspectFit source: modelData[<span class="hljs-string"><span class="hljs-string">'photo_medium'</span></span>] } Text { <span class="hljs-attr"><span class="hljs-attr">width</span></span>: parent.width - image.width - parent.spacing anchors.verticalCenter: parent.verticalCenter elide: Text.ElideRight renderType: Text.NativeRendering text: <span class="hljs-string"><span class="hljs-string">"%1 %2"</span></span>.arg(modelData[<span class="hljs-string"><span class="hljs-string">'first_name'</span></span>]).arg(modelData[<span class="hljs-string"><span class="hljs-string">'last_name'</span></span>]) } } } } Component.onCompleted: { getFriends() } }</code> </pre><br><br>  I made a conclusion in the console that will come in response, it is convenient if there is a desire to play with this example. <br><br>  By running the program, if a valid ID was specified, we will get something like this: <br><br><img src="https://habrastorage.org/storage2/1ba/092/3e2/1ba0923e2e45d25a6c52f6d64ce869bf.png"><br><br>  The biggest difficulty here is precisely in working with XHR.  Let's try to figure it out and simplify the code a bit. <br><br><h5>  Simplify XMLHttpRequest </h5><br>  There are two difficulties with working with XHR. <br><br>  1. When transmitting data by request parameters, this request must be compiled.  In case these parameters can change, then most likely in the code there will be many operations sticking query parameters from pieces.  In addition, you need to remember that it would be nice to encode the keys and values ‚Äã‚Äãusing the encodeURIComponent, as I already wrote above.  In total, the code that forms these parameters can be cumbersome and not very clear.  It would be much more convenient to use the object in which the corresponding fields are set as parameters. <br><br>  I wrote a small JavaScript library that converts an object into request parameters, encodes everything, in general, produces a ready-made string that can be sent immediately.  There is also a function that decodes the request parameters and creates an object from them (but it only supports simple types, an array or an object does not parse the parameters, however, it is unlikely to be necessary).  You can get it here: <a href="">github.com/krnekit/qml-utils/blob/master/qml/URLQuery.js</a> . <br><br>  2. Depending on the type of request, you need to send data differently, and you may also need to set additional headers.  I have written a library that simplifies sending XHR by providing a single interface.  It can send data in any format, for this you can pass a content type to the parameter, by default the same ‚Äúapplication / x-www-form-urlencoded‚Äù is considered, it is worth remembering that data of another type cannot be transmitted using a GET request in this case, you will need to use POST.  Content-Length is also automatically calculated and installed.  Accepts the request type, URL, callback function (optional), which will be called when the request is completed, and the data type (optional).  The function returns the request object itself or null in case of an error.  You can get it here: <a href="">github.com/krnekit/qml-utils/blob/master/qml/XHR.js</a> <br><br>  Using the two library data I simplified the previous example.  I will not give all the code here, we will consider only what has changed. <br>  At the beginning of the file we include the libraries (in this example, the library files are in the same directory as the qml file): <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'URLQuery.js'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> URLQuery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'XHR.js'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> XHR</code> </pre><br><br>  We import libraries and set namespaces for them, through which we will access functions from libraries. <br><br>  The function that sends the XHR now looks like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getFriends</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-attr"><span class="hljs-attr">fields</span></span>: <span class="hljs-string"><span class="hljs-string">'photo_medium'</span></span>, <span class="hljs-attr"><span class="hljs-attr">uid</span></span>: main.userId } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.status &amp;&amp; request.status === <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"response"</span></span>, request.responseText) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(request.responseText) main.friends = result.response } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"HTTP:"</span></span>, request.status, request.statusText) } } XHR.sendXHR(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://api.vk.com/method/friends.get'</span></span>, callback, URLQuery.serializeParams(params)) }</code> </pre><br><br>  First, we define an object with request parameters.  Then the callback function that will be called when the request is completed.  The function receives the request itself as a parameter.  And then we send the request itself, converting the object with the parameters using the serializeParams function. <br>  As a result, the code size, one might say, has not changed, but it has become much more structured and understandable. <br><br>  I will use these functions in the future to make the code easier.  If they are useful to someone, you can take and use the MIT license. <br><br><h5>  Log in to VKontakte from QML </h5><br>  Not all methods work without authorization, so most likely we will need to log in.  As a result, we should get a so-called.  Authorization Token, which we will then transmit in requests to VKontakte.  In order for us to log in, you need to create an application in VK.  You can do it here: <a href="http://vk.com/editapp%3Fact%3Dcreate">vk.com/editapp?act=create</a> .  Select the type of Standalone application.  Then we will pass its ID with one of the request parameters. <br><br><h6>  1. Authorization methods </h6><br>  Since we are doing a standalone application, there are two methods of authorization, both of them have their own problems, so you need to choose the least evil :) <br><br>  1. Direct authorization.  An HTTP request is sent with login details to a specific address.  In response, data will come in JSON format containing a token or error description. <br><br>  Benefits: <br><ul><li>  Simplicity. </li></ul><br>  Disadvantages: <br><ul><li>  It is necessary to transfer the secret code of the application (you may even have to be stitched into the program), respectively, there is a risk of its leakage. </li><li>  This method will only work for trusted applications.  When creating a new application, it will be unavailable and you need to write it in support. </li></ul><br><br>  2. Authorization of OAuth.  Implemented as follows.  In the program you need to embed a browser in which the user will be shown a special login page.  After authorization, a redirect to another page will occur and the current URL will contain a token or error description.  VKontakte this method is positioned as the main. <br><br>  Benefits: <br><ul><li>  The main and very significant advantage is that it works for all applications and for applications that are not allowed direct authorization, it is generally the only way. </li><li>  No need to pass a secret key. </li><li>  OAuth is a standard and you can also log in to Facebook, for example. </li></ul><br><br>  The disadvantages, however, are also significant. <br><br><ul><li>  You need to open a VK page, which means either try to embed it in the program window or open it in a separate window. </li><li>  As we open the page, we need a browser.  Respectively, it is necessary to drag QtWebkit and all that it pulls along with itself, which is why the program will add weight. </li><li>  It will be necessary to intercept events of changing the URL of the embedded browser, parse this URL and select parameters from it, which is somewhat more complicated than XHR. </li></ul><br><br><h6>  2. Direct authorization </h6><br>  Of course, I asked for the possibility of direct authorization to be included, but at first, VKontakte support slowly asked me, why did I need it, and then I squeezed full access :( So let's consider it purely theoretically. It would look something like this: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-attr"><span class="hljs-attr">grant_type</span></span>: <span class="hljs-string"><span class="hljs-string">'password'</span></span>, <span class="hljs-attr"><span class="hljs-attr">client_id</span></span>: <span class="hljs-number"><span class="hljs-number">123456</span></span>, <span class="hljs-attr"><span class="hljs-attr">client_secret</span></span>: <span class="hljs-string"><span class="hljs-string">'XXX'</span></span>, <span class="hljs-attr"><span class="hljs-attr">username</span></span>: <span class="hljs-string"><span class="hljs-string">'XXX'</span></span>, <span class="hljs-attr"><span class="hljs-attr">password</span></span>: <span class="hljs-string"><span class="hljs-string">'XXX'</span></span>, <span class="hljs-attr"><span class="hljs-attr">scope</span></span>: <span class="hljs-string"><span class="hljs-string">'audio'</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.status &amp;&amp; request.status === <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"response"</span></span>, request.responseText) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(request.responseText) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">"Error:"</span></span>, result.error, result.error_description) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { main.authToken = result.auth_token <span class="hljs-comment"><span class="hljs-comment">// Now do requests with this token } } else { console.log("HTTP:", request.status, request.statusText) } } XHR.sendXHR('POST', 'https://oauth.vk.com/token', callback, URLQuery.serializeParams(params)) }</span></span></code> </pre><br><br>  At the beginning we form the parameters, in them I, for example, indicated that access to the user's audio recordings is required (the scope parameter).  Then the callback function, which, in case of an error, writes to the console, and if successful, saves the token and then requests to the API may go further. <br><br>  Just in case, leave a link to the documentation: <a href="https://vk.com/dev/auth_direct">vk.com/dev/auth_direct</a> . <br><br><h6>  3. Authorization through OAuth. </h6><br>  For this type of authorization, we need to show the user a webpage login.  QtQuick has a WebView component that allows you to embed a QML browser in the WebKit engine into an application.  After the user is authorized, the URL in the browser will change and, in case of successful authorization, will contain the token in the request parameters or the description of the error in the anchor <a href="http://ru.wikipedia.org/wiki/URL">[5]</a> . <br><br>  In order not to be bothered with parsing this URL, we use the parseParams function from URLQuery.  You can pass the entire URL to it at once, we will get an object with parameters at the output. <br><br>  The following describes the component that implements this functionality. <br><br>  LoginWindow.qml: <br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> QtQuick <span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> QtQuick.Window <span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> QtWebKit <span class="hljs-number"><span class="hljs-number">3.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">"URLQuery.js"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> URLQuery Window { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: loginWindow property string applicationId property string permissions property <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> finishRegExp: <span class="hljs-regexp"><span class="hljs-regexp">/^https:\/\/oauth.vk.com\/blank.html/</span></span> signal succeeded(string token) signal failed(string error) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">login</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-attr"><span class="hljs-attr">client_id</span></span>: applicationId, <span class="hljs-attr"><span class="hljs-attr">display</span></span>: <span class="hljs-string"><span class="hljs-string">'popup'</span></span>, <span class="hljs-attr"><span class="hljs-attr">response_type</span></span>: <span class="hljs-string"><span class="hljs-string">'token'</span></span>, <span class="hljs-attr"><span class="hljs-attr">redirect_uri</span></span>: <span class="hljs-string"><span class="hljs-string">'http://oauth.vk.com/blank.html'</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (permissions) { params[<span class="hljs-string"><span class="hljs-string">'scope'</span></span>] = permissions } webView.url = <span class="hljs-string"><span class="hljs-string">"https://oauth.vk.com/authorize?%1"</span></span>.arg(URLQuery.serializeParams(params)) } width: <span class="hljs-number"><span class="hljs-number">1024</span></span> height: <span class="hljs-number"><span class="hljs-number">768</span></span> WebView { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: webView anchors.fill: parent onLoadingChanged: { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(loadRequest.url.toString()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loadRequest.status === WebView.LoadFailedStatus) { loginWindow.failed(<span class="hljs-string"><span class="hljs-string">"Loading error:"</span></span>, loadRequest.errorDomain, loadRequest.errorCode, loadRequest.errorString) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (loadRequest.status === WebView.LoadStartedStatus) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!finishRegExp.test(loadRequest.url.toString())) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = URLQuery.parseParams(loadRequest.url.toString()) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result) { loginWindow.failed(<span class="hljs-string"><span class="hljs-string">"Wrong responce from server"</span></span>, loadRequest.url.toString()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.error) { loginWindow.failed(<span class="hljs-string"><span class="hljs-string">"Error"</span></span>, result.error, result.error_description) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!result.access_token) { loginWindow.failed(<span class="hljs-string"><span class="hljs-string">"Access token absent"</span></span>, loadRequest.url.toString()) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } succeeded(result.access_token) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> } } }</code> </pre><br><br>  We display this component in a separate window.  After calling the login () method, the login page will be loaded. <br><br><img src="https://habrastorage.org/storage2/56a/977/09c/56a97709c86a9c57380202e633989fdf.png"><br><br>  After authorization will be made to the transition to the URL in which the address will be <a href="http://oauth.vk.com/blank.html">oauth.vk.com/blank.html</a> , and then through the '?'  or '#' will be the result.  With the permissions parameter we set the permissions we need.  If we specify something there, then when logging in through our widget, the user will see a dialog giving access rights to the application. <br><br>  In order to understand when we went to the right address, we set the onLoadingChanged handler.  It takes a loadRequest object, from which we get all the information we need.  It is called several times and we are interested in the situation either when an error occurred, in which case we send the corresponding signal, or when the necessary page is loaded.  In this case, we check if the token came to us and, if so, send a signal about successful authorization, otherwise an error message. <br><br>  Well, now consider the program itself, which uses this widget.  The program in case of successful authorization sets the status of the user to "test".  The user ID is set by the userId property in main. <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> QtQuick <span class="hljs-number"><span class="hljs-number">2.0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'URLQuery.js'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> URLQuery <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> <span class="hljs-string"><span class="hljs-string">'XHR.js'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> XHR Rectangle { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: main property int userId: XXX property <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> authToken width: <span class="hljs-number"><span class="hljs-number">640</span></span> height: <span class="hljs-number"><span class="hljs-number">320</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">processLoginSuccess</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">token</span></span></span><span class="hljs-function">) </span></span>{ loginWindow.visible = <span class="hljs-literal"><span class="hljs-literal">false</span></span> authToken = token setStatus() } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setStatus</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> params = { <span class="hljs-attr"><span class="hljs-attr">access_token</span></span>: main.authToken, <span class="hljs-attr"><span class="hljs-attr">text</span></span>: <span class="hljs-string"><span class="hljs-string">'test'</span></span> } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">callback</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">request</span></span></span><span class="hljs-function">) </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (request.status == <span class="hljs-number"><span class="hljs-number">200</span></span>) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'result'</span></span>, request.responseText) <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = <span class="hljs-built_in"><span class="hljs-built_in">JSON</span></span>.parse(request.responseText) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result.error) { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Error:'</span></span>, result.error.error_code,result.error.error_msg) } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Success'</span></span>) } } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'HTTP:'</span></span>, request.status, request.statusText) } Qt.quit() } XHR.sendXHR(<span class="hljs-string"><span class="hljs-string">'POST'</span></span>, <span class="hljs-string"><span class="hljs-string">'https://api.vk.com/method/status.set'</span></span>, callback, URLQuery.serializeParams(params)) } LoginWindow { <span class="hljs-attr"><span class="hljs-attr">id</span></span>: loginWindow applicationId: XXX permissions: <span class="hljs-string"><span class="hljs-string">'status'</span></span> visible: <span class="hljs-literal"><span class="hljs-literal">false</span></span> onSucceeded: processLoginSuccess(token) onFailed: { <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Login failed'</span></span>, error) Qt.quit() } } Component.onCompleted: { loginWindow.visible = <span class="hljs-literal"><span class="hljs-literal">true</span></span> loginWindow.login() } }</code> </pre><br><br>  After loading we will see the login window.  After login it is hidden and a request is sent to the server to change the user status.  After that, the program writes the result to the console and ends. <br><br>  After we have logged in, we no longer need to request a token if we didn‚Äôt need any additional access rights or its lifetime has not expired (it is returned to us along with the token, in case of successful authorization). <br><br><h5>  What else can you use XMLHttpRequest </h5><br>  I'll tell you a little story from my experience, not connected with VKontakte, but connected with XHR. <br><br>  Somehow my colleague had the task to receive and process in XML data in QML. <br><br>  QtQuick has a special type of XmlListModel that can be pulled from the network, parsed, and presented as an XML model file.  He needs to specify an XPath type query, according to which the model will be populated.  The problem was that the XML file contained not only the elements that had to be selected and placed in the model, but also some additional information that also needed to be obtained. <br><br>  There are several methods of solution.  You can use two XmlListModel objects, but this is an unambiguous crutch, and besides, I didn‚Äôt want the XML file to be pumped twice (and it will be checked).  You can implement this functionality using Qt, which contains as many as many variants of parsers, but there was a desire to solve the problem in pure QML. <br><br>  Since XMLHttpRequest was originally designed to work with XML, it has the means to work with XML.  Accordingly, you can get and parse XML using its means and select the necessary information.  Then you can transfer the same XML to an XmlListModel (there you can transfer not only the URI, but also the contents of the XML file). <br><br>  So, despite the fact that now XMLHttpRequest is used for anything, you should not forget what it was created for and what tools are there for working with XML. <br><br><h5>  Small summary </h5><br>  QML contains many tools available for JavaScript in the browser.  XMLHttpRequest allows you to send HTTP requests and thus ensure the integration of the application in QML with web resources.  Using XHR makes it possible in many cases to do without using C ++ to exchange data with the server and thereby simplify development. </div><p>Source: <a href="https://habr.com/ru/post/176665/">https://habr.com/ru/post/176665/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../176643/index.html">Creating a custom component from scratch. Part 1</a></li>
<li><a href="../176649/index.html">NASA has developed a navigation system for interstellar flights</a></li>
<li><a href="../176651/index.html">English translation of Angular.js</a></li>
<li><a href="../176657/index.html">Increase the security of the RemoteApp server</a></li>
<li><a href="../176659/index.html">Project Unity: 15 gaming consoles in one or play "warm tube games"</a></li>
<li><a href="../176669/index.html">YaUI - Buddhist Cross-Platform Native JavaScript UI Library</a></li>
<li><a href="../176671/index.html">Eller's algorithm for generating mazes</a></li>
<li><a href="../176675/index.html">Study Google Play and AdMob on the example of a single application</a></li>
<li><a href="../176677/index.html">Stealth Fiber Connection: Methods and Precautions</a></li>
<li><a href="../176685/index.html">Fusion-io ioDrive2 testing</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>