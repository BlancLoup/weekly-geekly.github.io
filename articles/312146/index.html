<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Monitor client PCs in Microsoft AD with Zabbix. Part 2 - Template, Scripts and LLD</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Zabbix has quite large capabilities out of the box, but sometimes this may not be enough, and in this case it is possible to use a third-party script ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Monitor client PCs in Microsoft AD with Zabbix. Part 2 - Template, Scripts and LLD</h1><div class="post__text post__text-html js-mediator-article">  Zabbix has quite large capabilities out of the box, but sometimes this may not be enough, and in this case it is possible to use a third-party script for event handling (Report problems to script).  We‚Äôll go back to the script itself a bit later, while I‚Äôll describe only the main idea, so that it is clear what and why we add triggers to the description.  The script parses the body of the letter and searches for the line MYparsBLOCK: funcname: if it finds it, it executes funcname (), if it does not find it, it simply sends an alert.  It‚Äôs more reasonable to add this to the trigger description, so you need to add the default message - {TRIGGER.DESCRIPTION} to the Actions-Event source ‚ÄìTriggers-operations. <br><a name="habracut"></a><br><h3>  Cooking template </h3><br>  You need to create a monitoring template that will be attached to new hosts using the auto-registration rule.  (Action-&gt; Event Source-&gt; Auto registration-&gt; Link to templates: Win_monitor) I took as a basis the standard zabbix template for windows, as well as the APC Smart UPS Monitoring from somewhere in the open spaces, threw out of them everything superfluous and added what need me <br><br><div class="spoiler">  <b class="spoiler_title">Items</b> <div class="spoiler_text">  <b>Agent ping</b> <b><br></b>  agent.ping <br>  <b>Average disk queue length</b> <b><br></b>  perf_counter [\ 234 (_Total) \ 1400] <br>  <b>Average disk read queue length</b> <b><br></b>  perf_counter [\ 234 (_Total) \ 1402] <br>  <b>Average disk write queue length</b> <b><br></b>  perf_counter [\ 234 (_Total) \ 1404] <br>  <b>CPU Model</b> <b><br></b>  wmi.get [ROOT \ cimv2, SELECT Name FROM Win32_Processor] <br>  <b>CPU utilization</b> <b><br></b>  perf_counter [\ 238 (_Total) \ 6] <br>  <b>APC Smart UPS Monitoring: Driver Caption</b> <b><br></b>  wmi.get [ROOT \ cimv2, SELECT Caption FROM Win32_PNPEntity WHERE PNPDeviceID LIKE '% VID_051D &amp; PID_0002%' OR Service LIKE '% hidbatt%'] <br>  <b>Free disk space on C:</b> <b><br></b>  vfs.fs.size [c:, free] <br>  <b>Free disk space on C: (percentage)</b> <b><br></b>  vfs.fs.size [c:, pfree] <br>  <b>Free memory</b> <b><br></b>  vm.memory.size [free] <br>  <b>Host name of zabbix_agentd running</b> <b><br></b>  agent.hostname <br>  <b>Mainboard Model</b> <b><br></b>  wmi.get [ROOT \ cimv2, SELECT Product FROM Win32_BaseBoard] <br>  <b>System information</b> <b><br></b>  system.uname <br>  <b>System uptime</b> <b><br></b>  system.uptime <br>  <b>Total disk space on C:</b> <b><br></b>  vfs.fs.size [c:, total] <br>  <b>Total memory</b> <b><br></b>  vm.memory.size [total] <br>  <b>Used disk space on C:</b> <b><br></b>  vfs.fs.size [c:, used] <br>  <b>APC Smart UPS Monitoring: Battery Life</b> <b><br></b>  battery.runtime <br>  <b>APC Smart UPS Monitoring: Battery Replacement Date</b> <b><br></b>  battery.mfr.date <br>  <b>APC Smart UPS Monitoring: Battery Charge</b> <b><br></b>  battery.charge <br>  <b>APC Smart UPS Monitoring: UPS Model</b> <b><br></b>  ups.model <br>  <b>APC Smart UPS Monitoring: Load</b> <b><br></b>  ups.load <br>  <b>APC Smart UPS Monitoring: Voltage (input)</b> <b><br></b>  input.voltage <br>  <b>APC Smart UPS Monitoring: Voltage (output)</b> <b><br></b>  output.voltage <br>  <b>APC Smart UPS Monitoring: UPS Status</b> <b><br></b>  ups.status <br>  <b>APC Smart UPS Monitoring: Beeper Status</b> <b><br></b>  ups.beeper.status <br>  <b>APC Smart UPS Monitoring: Battery Temperature</b> <b><br></b>  battery.temperature <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Triggers</b> <div class="spoiler_text">  <b>Free disk space is less than 1GB on volume C: {HOST.NAME}</b> <b><br></b>  {Win_monitor: vfs.fs.size [c:, free] .last (0)} &lt;1073741824 <br>  <b>Lack of free memory on {HOST.NAME}</b> <b><br></b>  {Win_monitor: vm.memory.size [free] .avg (30m)} &lt;10000000 <br>  <b>APC Smart UPS Monitoring: robot_ Data does not come from the UPS {HOST.NAME}</b> <b><br></b>  {Win_monitor: ups.status.str (Error)} = 1 and {Win_monitor: wmi.get [ROOT \ .imv2, SELECT Caption FROM Win32_PNPEntity WHERE PNPDeviceID LIKE '% VID_051D &amp; PID_0002%' OR LIKE Service% Hidbatt% 'OR LIKE% HIDBatt% ") )}&gt; 1 <br>  <b>Zabbix agent on {HOST.NAME} is unreachable for 7 days</b> <b><br></b>  {Win_monitor: agent.ping.nodata (7d)} = 1 <br>  <b>APC Smart UPS Monitoring: Battery not charging on {HOST.NAME}</b> <b><br></b>  {Win_monitor: battery.charge.max (# 120)} &lt;90 <br>  <b>APC Smart UPS Monitoring: Beeper off on {HOST.NAME}</b> <b><br></b>  {Win_monitor: ups.beeper.status.str (disabled)} = 1 <br>  <b>APC Smart UPS Monitoring: Low battery life at {HOST.NAME}</b> <b><br></b>  {Win_monitor: battery.runtime.last (0)} &lt;5 and {Win_monitor: ups.model.str (Smart)} = 1 <br></div></div><br>  I already wrote that the implementation of the ups monitoring was not as smooth as we would like.  Oops constantly fall off, restarting the driver with the help of the devcon utility helps, therefore we add to the trigger (in the description) ‚Äúrobot_ No data comes from the UPS {HOST.NAME}‚Äù our block with the nutp function.  Well, no one needs dead hosts in monitoring, because in the trigger ‚ÄúZabbix agent on {HOST.NAME} is unreachable for 7 days‚Äù we add the function remove_offline, which will remove hosts from zabbix: <br><br><pre><code class="hljs pgsql">MYparsBLOCK:nutpt: HIP:{HOST.DNS} MYparsBLOCK:remove_offline: HID:{HOST.NAME}</code> </pre> <br><h3>  Low-level discovery </h3><br>  As for smarts, ordinary Items and Triggers will not suit us, since there may be different numbers of smarts on different machines.  In zabbix, it is possible to make item and trigger prototype, which will be created for the list of objects obtained using low-level discovery rules, you can read more <a href="https://www.zabbix.com/documentation/3.2/manual/discovery/low_level_discovery">here</a> .  In order for the rule to work, we need to write a script / application that will issue a list of hard drives in a special JSON format at startup.  At first I made a script on powershell, but on the part of the machines the script periodically did not have time to execute in 30 seconds, due to the fact that powershell itself was initialized for a very long time.  I had to give up powershell and make an exe application in c # (I don't know it, but it seemed simple enough to rewrite the script).  An application using smartctl gets a list of hdd, removes duplicate (by serial number) and displays in the format we need. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">hddscan.cs</b> <div class="spoiler_text"><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Collections.Generic; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Linq; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Diagnostics; <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> System.Text.RegularExpressions; <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">hdd_scan</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Program</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">string</span></span></span><span class="hljs-function">[] </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">smartctl</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> arg</span></span></span><span class="hljs-function">)</span></span> { Process p = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Process(); p.StartInfo.FileName = <span class="hljs-string"><span class="hljs-string">"C:\\Program Files\\Zabbix\\extra\\smart\\smartctl.exe"</span></span>; p.StartInfo.Arguments = arg; p.StartInfo.UseShellExecute = <span class="hljs-literal"><span class="hljs-literal">false</span></span>; p.StartInfo.RedirectStandardOutput = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; p.Start(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> output = p.StandardOutput.ReadToEnd(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] list = output.Split(<span class="hljs-string"><span class="hljs-string">'\n'</span></span>); p.WaitForExit(); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> list; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Main</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params">[] args</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">try</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] hddlist = smartctl(<span class="hljs-string"><span class="hljs-string">"--scan"</span></span>); Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt; psarr = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Dictionary&lt;<span class="hljs-keyword"><span class="hljs-keyword">string</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>&gt;(); <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> pattern = <span class="hljs-string"><span class="hljs-string">@"^(?&lt;1&gt;\/[\w]+)\/(?&lt;xer&gt;[\S]+)\s"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> hdd <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> hddlist) { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> match = Regex.Match(hdd, pattern); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (match.Success) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> shdd = match.Groups[<span class="hljs-string"><span class="hljs-string">"xer"</span></span>].Value; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] tmp = smartctl(<span class="hljs-string"><span class="hljs-string">"-a "</span></span> + shdd); <span class="hljs-keyword"><span class="hljs-keyword">foreach</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> line <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> tmp) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (line.Contains(<span class="hljs-string"><span class="hljs-string">"Serial"</span></span>) == <span class="hljs-literal"><span class="hljs-literal">true</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">string</span></span>[] serials = Regex.Split(line, <span class="hljs-string"><span class="hljs-string">@"^Serial\sNumber\:\s+"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (serials.Length &lt; <span class="hljs-number"><span class="hljs-number">2</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">continue</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">string</span></span> serial = serials[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!psarr.ContainsValue(serial)) { psarr.Add(shdd, serial); } } } } } <span class="hljs-comment"><span class="hljs-comment">//Starting output int cnt = 0; Console.WriteLine("{\n"); Console.WriteLine("\t\"data\":[\n\n"); foreach (KeyValuePair&lt;string, string&gt; kvp in psarr) { string[] flist = smartctl("-a "+kvp.Key); string checkstring = "A mandatory SMART command failed: exiting. To continue, add one or more '-T permissive' options."; // bool test= false; for (int i = 0; i &lt; flist.Length; i++) { if (flist[i].Contains(checkstring)) { test = true; } } if (!test) { cnt++; if (cnt &gt; 1) { Console.WriteLine("\t,\n"); } Console.WriteLine("\t{\n"); Console.WriteLine("\t\t\"{{#HDDNAME}}\":\"{0}\"\n", kvp.Key); Console.WriteLine("\t}\n"); } } Console.WriteLine("\n\t]\n"); Console.WriteLine("}\n"); } catch (Exception ex) { Console.WriteLine(ex.Message); } } } }</span></span></code> </pre><br></div></div><br>  Yes, smart machines may be disabled on some machines, so we will add another firstrun function, and place it in the message of the autoregistration rule Action-&gt; Event Source-&gt; Auto registration, add the item Send message to ... via script, place in the body: <br><br><pre> <code class="hljs">MYparsBLOCK:firstrun: HIP:{HOST.IP}</code> </pre> <br>  In the template, create a discovey rule - smart.discovery. <br><br><div class="spoiler">  <b class="spoiler_title">Item prototypes</b> <div class="spoiler_text">  <b>smart _ {# HDDNAME} _CRC_Error_Count</b> <b><br></b>  smart [{# HDDNAME}, crc] <br>  <b>smart _ {# HDDNAME} _Current_Pending_Sector</b> <b><br></b>  smart [{# HDDNAME}, pend] <br>  <b>smart _ {# HDDNAME} _Health_Status</b> <b><br></b>  smart [{# HDDNAME}, health] <br>  <b>smart _ {# HDDNAME} _Model</b> <b><br></b>  smart [{# HDDNAME}, model] <br>  <b>smart _ {# HDDNAME} _Reallocated_Sector_Ct</b> <b><br></b>  smart [{# HDDNAME}, realloc] <br>  <b>smart _ {# HDDNAME} _Temperature</b> <b><br></b>  smart [{# HDDNAME}, temp] <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Triggers prototypes</b> <div class="spoiler_text">  <b>HDD: Current_Pending_Sector on {#HDDNAME} {HOST.NAME} over 5</b> <b><br></b>  {Win_monitor: smart [{# HDDNAME}, pend] .last ()}&gt; 5 <br>  <b>HDD: Reallocated_Sector_Ct to {#HDDNAME} {HOST.NAME} is greater than 5</b> <b><br></b>  {Win_monitor: smart [{# HDDNAME}, realloc] .last ()}&gt; 5 <br>  <b>HDD: HDD temperature is above 55 degrees at {#HDDNAME} {HOST.NAME}</b> <b><br></b>  {Win_monitor: smart [{# HDDNAME}, temp] .last ()}&gt; 55 <br>  <b>HDD: CRC_Error_Count growth has been registered to {#HDDNAME} {HOST.NAME}</b> <b><br></b>  {Win_monitor: smart [{# HDDNAME}, crc] .change ()}&gt; 0 <br>  <b>HDD: Current_Pending_Sector growth is fixed at {#HDDNAME} {HOST.NAME}</b> <b><br></b>  {Win_monitor: smart [{# HDDNAME}, pend] .change ()}&gt; 0 and {Win_monitor: smart [{# HDDNAME}, pend] .last ()}&gt; 6 <br>  <b>HDD: Reallocated_Sector_Ct growth was recorded at {#HDDNAME} {HOST.NAME}</b> <b><br></b>  {Win_monitor: smart [{# HDDNAME}, realloc] .change ()}&gt; 0 and {Win_monitor: smart [{# HDDNAME}, realloc] .last ()}&gt; 6 <br></div></div><br>  In the description of prototypes we add the hddsmart function, it will add the HDD model to the body of the trigger message, so that it is clear what kind of hard disk it is, because smartctl uses sda, sdb, etc. as the name <br><br><pre> <code class="hljs ruby"><span class="hljs-symbol"><span class="hljs-symbol">MYparsBLOCK:</span></span><span class="hljs-symbol"><span class="hljs-symbol">hddsmart:</span></span> <span class="hljs-symbol"><span class="hljs-symbol">HIP:</span></span>{HOST.DNS}<span class="hljs-symbol"><span class="hljs-symbol">:KKEY</span></span><span class="hljs-symbol"><span class="hljs-symbol">:smart</span></span>[{<span class="hljs-comment"><span class="hljs-comment">#HDDNAME},model]</span></span></code> </pre> <br>  The agent does not understand most of the parameters, so it is imperative to register all UserParameter in the client configuration. <br><br><div class="spoiler">  <b class="spoiler_title">UserParameter</b> <div class="spoiler_text"> <code>UserParameter=battery.charge,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.charge <br> UserParameter=battery.charge.low,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.charge.low <br> UserParameter=battery.charge.warning,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.charge.warning <br> UserParameter=battery.mfr.date,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.mfr.date <br> UserParameter=battery.runtime,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.runtime <br> UserParameter=battery.runtime.low,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.runtime.low <br> UserParameter=battery.temperature,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.temperature <br> UserParameter=battery.type,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.type <br> UserParameter=battery.voltage,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.voltage <br> UserParameter=battery.voltage.nominal,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost battery.voltage.nominal <br> UserParameter=input.sensitivity,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost input.sensitivity <br> UserParameter=input.transfer.high,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost input.transfer.high <br> UserParameter=input.transfer.low,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost input.transfer.low <br> UserParameter=input.voltage,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost input.voltage <br> UserParameter=output.current,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost output.current <br> UserParameter=output.frequency,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost output.frequency <br> UserParameter=output.voltage,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost output.voltage <br> UserParameter=output.voltage.nominal,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost output.voltage.nominal <br> UserParameter=ups.beeper.status,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.beeper.status <br> UserParameter=ups.delay.shutdown,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.delay.shutdown <br> UserParameter=ups.delay.start,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.delay.start <br> UserParameter=ups.firmware,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.firmware <br> UserParameter=ups.firmware.aux,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.firmware.aux <br> UserParameter=ups.load,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.load <br> UserParameter=ups.mfr,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.mfr <br> UserParameter=ups.mfr.date,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.mfr.date <br> UserParameter=ups.model,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.model <br> UserParameter=ups.productid,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.productid <br> UserParameter=ups.serial,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.serial <br> UserParameter=ups.status,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.status <br> UserParameter=ups.test.result,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.test.result <br> UserParameter=ups.timer.reboot,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.timer.reboot <br> UserParameter=ups.timer.shutdown,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.timer.shutdown <br> UserParameter=ups.timer.start,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.timer.start <br> UserParameter=ups.vendorid,"c:\Program Files (x86)\NUT\bin\upsc.exe" primary@localhost ups.timer.vendorid <br> UserParameter=smart[*],"C:\Program Files\Zabbix\cmd\smart.cmd" "$1" $2 <br> UserParameter=smart.discovery, "C:\Program Files\Zabbix\cmd\hdd_scan.exe" <br></code> </div></div><br><div class="spoiler">  <b class="spoiler_title">smart.cmd</b> <div class="spoiler_text"><pre> <code class="bash hljs">@<span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> off rem use smart.cmd &lt;disk&gt; &lt; parameter&gt; smart.cmd sda health <span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> <span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\cmd"</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %2==health (<span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\extra\smart\smartctl.exe"</span></span> -H %1 | grep result | awk <span class="hljs-string"><span class="hljs-string">"{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$6</span></span></span><span class="hljs-string">}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %2==model (<span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\extra\smart\smartctl.exe"</span></span> -i %1 | grep <span class="hljs-string"><span class="hljs-string">"Device Model"</span></span> | awk -F<span class="hljs-string"><span class="hljs-string">"Device Model:"</span></span> <span class="hljs-string"><span class="hljs-string">"{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$2</span></span></span><span class="hljs-string">}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %2==realloc (<span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\extra\smart\smartctl.exe"</span></span> --attributes %1 | grep Reallocated_S | awk <span class="hljs-string"><span class="hljs-string">"{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$10</span></span></span><span class="hljs-string">}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %2==crc (<span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\extra\smart\smartctl.exe"</span></span> --attributes %1 | grep CRC | awk <span class="hljs-string"><span class="hljs-string">"{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$10</span></span></span><span class="hljs-string">}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %2==pend (<span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\extra\smart\smartctl.exe"</span></span> --attributes %1 | grep Pend | awk <span class="hljs-string"><span class="hljs-string">"{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$10</span></span></span><span class="hljs-string">}"</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> %2==temp (<span class="hljs-string"><span class="hljs-string">"C:\Program Files\Zabbix\extra\smart\smartctl.exe"</span></span> --attributes %1 | grep Temperature_Celsius | awk <span class="hljs-string"><span class="hljs-string">"{print </span><span class="hljs-variable"><span class="hljs-string"><span class="hljs-variable">$10</span></span></span><span class="hljs-string">}"</span></span>)</code> </pre><br></div></div><br><h3>  Alert script </h3><br>  Actually the script itself, which will send letters and perform our functions: <br><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/env python # -*- coding: utf-8 -*- #/var/lib/zabbixsrv/alertscripts/mail.py import string import re import subprocess import sys import time import os #    ,  ,    def send_mail(recipient, subject, body): import smtplib from email.MIMEText import MIMEText from email.Header import Header from email.Utils import formatdate encoding='utf-8' SMTP_SERVER = 'smtp' SENDER_NAME = u'Zabbix Alert' session = None msg = MIMEText(body, 'plain', encoding) msg['Subject'] = Header(subject, encoding) msg['From'] = Header(SENDER_NAME, encoding) msg['To'] = recipient msg['Date'] = formatdate() try: session = smtplib.SMTP(SMTP_SERVER) session.sendmail(SENDER_NAME, recipient, msg.as_string()) except Exception as e: raise e finally: # close session if session: session.quit() # Zabbix     ,   ,     .(  ,   ) def daemonize (stdin='/dev/null', stdout='/dev/null', stderr='/dev/null'): try: pid = os.fork() if pid &gt; 0: sys.exit(0) except OSError, e: sys.stderr.write("fork #1 failed: (%d) %s\n" % (e.errno, e.strerror)) sys.exit(1) os.chdir("/") os.umask(0) os.setsid() try: pid = os.fork() if pid &gt; 0: sys.exit(0) except OSError, e: sys.stderr.write("fork #2 failed: (%d) %s\n" % (e.errno, e.strerror)) sys.exit(1) for f in sys.stdout, sys.stderr: f.flush() si = file(stdin, 'r') so = file(stdout, 'a+') se = file(stderr, 'a+', 0) os.dup2(si.fileno(), sys.stdin.fileno()) os.dup2(so.fileno(), sys.stdout.fileno()) os.dup2(se.fileno(), sys.stderr.fileno()) #     def hddsmart(): m=re.search('MYparsBLOCK\:\S+\:\s+HIP\:(?P&lt;hostip&gt;\S+)\:KKEY\:(?P&lt;kkey&gt;\S+)',a3) hostip,kkey= m.group('hostip'),m.group('kkey') p = subprocess.Popen('zabbix_get -s '+hostip+' -k '+kkey, shell=True,stdout=subprocess.PIPE) bb = a3[0:string.find(a3,'MYparsBLOCK')] + 'HDD: ' + p.stdout.read() send_mail(sys.argv[1],a2,bb) #    .    api    def remove_offline(): if 'PROBLEM:' in a2: m=re.search('MYparsBLOCK\:\S+\:\s+HID\:(?P&lt;hostid&gt;\S+)',a3) hostid = m.group('hostid') + '\n' hidf=open('/var/log/zabbixsrv/2del_ids', 'a') hidf.write(hostid) hidf.close send_mail(sys.argv[1],a2,a3[0:string.find(a3,'MYparsBLOCK')]) # ,       .      microsoft devcon. def nutpt(): if 'PROBLEM:' in a2: m=re.search('MYparsBLOCK\:\S+\:\s+HIP\:(?P&lt;hostip&gt;\S+)',a3) hostip = m.group('hostip') log = '' i = 0 while i &lt; 5: p = subprocess.Popen("""zabbix_get -s %s -k 'system.run[net stop "Network UPS Tools"]'"""%(hostip), shell=True,stdout=subprocess.PIPE) log +=p.stdout.read() time.sleep(10) p = subprocess.Popen("""zabbix_get -s %s -k system.run['cd "C:\Program Files\Zabbix\cmd\"&amp;devcon.exe restart USB\VID_051D*']"""%(hostip), shell=True,stdout=subprocess.PIPE) log +=p.stdout.read() time.sleep(30) p = subprocess.Popen("""zabbix_get -s %s -k 'system.run[net start "Network UPS Tools"]'"""%(hostip), shell=True,stdout=subprocess.PIPE) log +=p.stdout.read() i += 1 p = subprocess.Popen("""zabbix_get -s %s -k 'ups.status'"""%(hostip), shell=True,stdout=subprocess.PIPE) if 'Error' not in p.stdout.read(): i = 8 if i &lt;&gt; 8: send_mail(sys.argv[1],a2,log) #    .     smart   smartctl.exe --scan-open def firstrun(): m=re.search('MYparsBLOCK\:\S+\:\s+HIP\:(?P&lt;hostip&gt;\S+)',a3) hostip = m.group('hostip') p = subprocess.Popen("""zabbix_get -s %s -k system.run['cd "C:\Program Files\Zabbix\extra\smart\"&amp;smartctl.exe --scan-open']"""%(hostip), shell=True,stdout=subprocess.PIPE) log = p.stdout.read() send_mail(sys.argv[1],a2,log) daemonize(stdout='/var/log/zabbixsrv/script_out.log', stderr='/var/log/zabbixsrv/script_err.log') try: a1,a2,a3 = sys.argv[1],sys.argv[2],sys.argv[3] #debug(      ) #os.system('echo "' + a1+' '+a2+' '+a3 +'" &gt;&gt; /var/log/zabbixsrv/script_dbg.log') if 'MYparsBLOCK' in a3: eval(re.search('MYparsBLOCK\:(?P&lt;myfunc&gt;\S+)\:',a3).group('myfunc'))() #      else: send_mail(sys.argv[1],a2,a3) except: #print sys.exc_info() send_mail('admin@domain.local', 'Error in script', str(sys.exc_info()))</span></span></code> </pre> <br>  Keep in mind that if there are several recipients, then the function will be executed several times.  For some reason this is relevant (for example, the HDD model), and for some reason it can even be harmful, so this <b>must</b> be taken into account when setting up Actions. <br><br><h3>  Script to remove inactive hosts </h3><br><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # import os from pyzabbix import ZabbixAPI, ZabbixAPIException try: os.rename ('/var/log/zabbixsrv/2del_ids','/var/log/zabbixsrv/klist_pr') except: pass user='apirobot' pwd='*******' url = 'https://127.0.0.1/zabbix/' zh = ZabbixAPI(url) zh.session.verify = False zh.login(user=user, password=pwd) f = open('/var/log/zabbixsrv/klist_pr') for hnm in f: try: hid = zh.host.get(filter={"host":hnm.replace('\n','')},output=['hostid'])[0]['hostid'] #zh.host.delete(hostid = hid) - API change zh.host.delete(int(hid)) except: pass f.close() os.remove('/var/log/zabbixsrv/klist_pr')</span></span></code> </pre> <br>  To use the script, you need an account with rights to delete machines.  I run the script on the crown under a different account, because here the password is stored in clear text. <br><br><h3>  We connect agents by dns-name </h3><br>  By default, agents are registered so that zabbix connects to them via ip.  It does not suit me, so we are writing a script that will fix it, and at the same time it will report lookup problems.  I took some script from pyzabbix examples for the basis and redid it a bit. <br><br><div class="spoiler">  <b class="spoiler_title">use_fqdn.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/usr/bin/python # # -*- coding: utf-8 -*- import socket from getpass import getpass from pyzabbix import ZabbixAPI, ZabbixAPIException zapi = ZabbixAPI(server='https://127.0.0.1/zabbix/') zapi.session.verify = False zapi.login('apirobot', '*******') body = '' err = '' def send_mail(recipient, subject, body): import smtplib from email.MIMEText import MIMEText from email.Header import Header from email.Utils import formatdate encoding='utf-8' SMTP_SERVER = 'smtp' SENDER_NAME = u'zabbix@domain.local' MAIL_ACCOUNT = 'zabbix@domain.local' session = None msg = MIMEText(body, 'plain', encoding) msg['Subject'] = Header(subject, encoding) msg['From'] = Header(SENDER_NAME, encoding) msg['To'] = recipient msg['Date'] = formatdate() try: session = smtplib.SMTP(SMTP_SERVER) session.sendmail(MAIL_ACCOUNT, recipient, msg.as_string()) except Exception as e: raise e finally: # close session if session: session.quit() # Loop through all hosts interfaces, getting only "main" interfaces of type "agent" for h in zapi.hostinterface.get(output=["dns","ip","useip"],selectHosts=["host"],filter={"main":1,"type":1}): #print h # Make sure the hosts are named according to their FQDN # if len(h['dns']) == 0: try: zapi.hostinterface.update(interfaceid=h['interfaceid'], dns = socket.gethostbyaddr(h['hosts'][0]['host'])[0]) except: body += ('FQDN_UPD_ERR: ' + h['hosts'][0]['host']) + '\n' try: a = socket.gethostbyaddr(h['hosts'][0]['host'])[2][0] b = socket.gethostbyaddr(h['dns'])[2][0] if (a != b): body += ('Warning: %s has dns "%s"' % (h['hosts'][0]['host'], h['dns'])) + '\n' except: body += ('DNS_LOOKUP_ERR: ' + h['hosts'][0]['host']) + '\n' # Make sure they are using hostnames to connect rather than IPs (could be also filtered in the get request) if h['useip'] == '1': body += ('%s is using IP instead of hostname. Fixing.' % h['hosts'][0]['host']) + '\n' try: zapi.hostinterface.update(interfaceid=h['interfaceid'], useip=0) except ZabbixAPIException as e: #print(e) err += str(e)+'\n' err += '\n' continue body += '\nZabbix Errors:' + err if len(body) &gt; 16: send_mail('admin@domain.local','check agents',body)</span></span></code> </pre></div></div><br><h3>  P.S </h3><br>  ¬ªAll scripts, template and other necessary files are posted on <a href="https://github.com/mikezsin/zabbix_policy">github</a> . <br><br>  ¬ª <a href="https://habrahabr.ru/post/310928/">Monitor client PCs in Microsoft AD with Zabbix.</a>  <a href="https://habrahabr.ru/post/310928/">Part 1 - Auto Install</a> <a href="https://habrahabr.ru/post/310928/"><br></a> </div><p>Source: <a href="https://habr.com/ru/post/312146/">https://habr.com/ru/post/312146/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../312132/index.html">"Everywhere at Home": What technologies does Airbnb use?</a></li>
<li><a href="../312134/index.html">Implementing Business Logic in MySQL</a></li>
<li><a href="../312136/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ231 (October 3 - 9, 2016)</a></li>
<li><a href="../312140/index.html">Cybersecurity games in Rio: how it was</a></li>
<li><a href="../312144/index.html">PHP Digest number 94 - interesting news, materials and tools (September 25 - October 9, 2016)</a></li>
<li><a href="../312148/index.html">We separate the interface and implementation in the functional style in C ++</a></li>
<li><a href="../312154/index.html">Donald Knut: ‚ÄúMy advice to the young‚Äù (93/97) and ‚ÄúFeeling the need to assert oneself‚Äù (9/97)</a></li>
<li><a href="../312158/index.html">Over RethinkDB clouds are gathering?</a></li>
<li><a href="../312162/index.html">Knowledge is power: we analyze product statistics and do not lose customers on the road of progress</a></li>
<li><a href="../312164/index.html">CleverStyle Framework 6 Evolution</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>