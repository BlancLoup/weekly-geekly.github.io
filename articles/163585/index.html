<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Looking for differences in images</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hi, Habr! 

 Based on the article Writing a bot for the game ‚ÄúFind Difference‚Äù, an idea appeared to implement the search for third-party objects in a ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Looking for differences in images</h1><div class="post__text post__text-html js-mediator-article">  Hi, Habr! <br><br>  Based on the article <a href="http://habrahabr.ru/post/163565/">Writing a bot for the game ‚ÄúFind Difference‚Äù,</a> an idea appeared to implement the search for third-party objects in a given image using computer vision algorithms. <br><br>  Details - under the cut. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="habracut"></a><br><h4>  Description of the task. </h4><br>  The problem of identifying a third-party object arises in many situations - for example, in video recording tasks, when, for example, you need to turn on an alarm when an unauthorized person appears at night in a protected area. <br><br>  At the same time, the main difficulty in signal processing is that the registration conditions can change - it depends on the time of day, the smoke in the room, the state of the recorder itself (for example, the lens is dusty).  Therefore, it is necessary to use an algorithm that allows you to select a third-party object, regardless of the conditions in which the shooting is performed. <br><br><h4>  Information from morphological analysis </h4><br>  Without a mathematical introduction, of course, can not do! <br><br>  Call the function <pre><code class="tex hljs">f(x):X ‚Üí R</code> </pre>  image.  In our problem, the <code>f(x)</code> value will correspond to the pixel brightness (ranging from 0 to 255). <br><br>  Let <i>L</i> be the linear space of all images, <b>F the</b> class of all Borel functions that take numerical values, F <sub>f</sub> be a subclass of <b>F</b> : F <sub>f</sub> = {F ‚àà <b>F</b> : F‚äóf () ‚àà L}. <br><br>  And finally, we introduce the important concept <i>of image shape</i> : V <sub>f</sub> = {F‚äóf: F ‚àà F <sub>f</sub> } ‚äÇ L. Thus, the image shape is the maximum invariant of image transformations that it undergoes when changing the conditions of observation, changing shooting parameters.  We will use the concept of form in image processing. <br><br><h4>  Algorithm </h4><br>  The main idea of ‚Äã‚Äãthe algorithm is to single out a certain maximum image invariant, with which then we will compare the incoming images.  The implementation of the algorithm is given in Python. <br><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">from</span></span> PIL <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> Image<span class="hljs-comment"><span class="hljs-comment">#   </span></span></code> </pre><br><br><ul><li>  1. Convert the input (color) image to gray - assign each pixel instead of color a brightness value in the range <code>[0,255]</code> <br><pre> <code class="python hljs">im1 = Image.open(<span class="hljs-string"><span class="hljs-string">'./img/test1.jpg'</span></span>)<span class="hljs-comment"><span class="hljs-comment">#  p1 = im1.convert('L')#     </span></span></code> </pre><br></li><li>  2. Get the piecewise constant approximation of the image.  It is necessary to split the input (smooth) image into a number of areas of constant brightness. <br><br>  g = ‚àë <sup>N</sup> <sub>i = 1</sub> A <sub>i</sub> c <sub>i</sub> (x), <br><br>  where c <sub>i</sub> (x) is the brightness value, constant for the region A <sub>i</sub> . <br><br><pre> <code class="python hljs"> <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(p1.size[<span class="hljs-number"><span class="hljs-number">1</span></span>]):<span class="hljs-comment"><span class="hljs-comment">#   for j in xrange(p1.size[0]):#    for l in xrange(len(split_map[1])): if pix[j,i] in split_map[1][l]: pix[j,i]=split_map[0][l]#    , measure[l]+=1#   - break</span></span></code> </pre><br>  We pre-divide the interval of brightness values ‚Äã‚Äãinto equal intervals [0, ..., a_1], ..., [a_m, ..., 255].  Then we calculate the average brightness value for each group.  After that, it remains only to walk through the image and assign each pixel an average brightness value for the group into which it falls.  As a result, we obtain a partition of the input image into a number of regions of constant brightness A <sub>1</sub> , ..., A <sub>N.</sub>  In parallel, we consider the power of each set of constant brightness (because the set is discrete ‚Äî power is equal to the number of pixels).  How the algorithm works on an example: <br><h6>  Input Image </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/9fb/fcb/a83/9fbfcba83b46b0185f0947522afcddfb.jpg" alt="image"><br><h6>  Piecewise constant approximation </h6><br><img src="https://habrastorage.org/getpro/habr/post_images/288/723/86f/28872386f5f4be03c457d4f1bd723593.jpg" alt="image"><br>  The resulting piecewise constant approximation is the <i>form of the image</i> . <br></li><li>  3. Now let's work with the input image (where we need to select a third-party element).  To do this, find the <i>projection of the</i> input image on our form: <br>  P <sub>V <sub>g</sub></sub> f = ‚àë <sup>N</sup> <sub>i = 1</sub> = (‚àë <sub>x <sub>sk</sub> ‚àà A <sub>i</sub></sub> f (x <sub>sk</sub> )) / (| A | <sub>i</sub> ) ‚ãÖ c <sub>i</sub> (x). <br><br>  In other words, we calculate for the input image the normalized brightness value on each piecewise constant element of the form. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">projector</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(img,split_form)</span></span></span><span class="hljs-function">:</span></span> p1 = img.convert(<span class="hljs-string"><span class="hljs-string">'L'</span></span>);pix = p1.load();summ = [<span class="hljs-number"><span class="hljs-number">0</span></span>]*len(split_form[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>]); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> l <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(len(split_form[<span class="hljs-number"><span class="hljs-number">2</span></span>][<span class="hljs-number"><span class="hljs-number">1</span></span>])):<span class="hljs-comment"><span class="hljs-comment">#     for i in xrange(p1.size[1]): for j in xrange(p1.size[0]): if split_form[3][j,i]==l: summ[l]+=pix[j,i] summ[l] = summ[l] / split_form[1][l]# ""   #         ""  for i in xrange(p1.size[1]): for j in xrange(p1.size[0]): if split_form[3][j,i]==l: pix[j,i] = summ[l] return p1</span></span></code> </pre><br></li><li>  4. That's it!  After we have calculated the projection on our form, all that remains is to subtract from our form (the original image of the piecewise-constant image, without an external object) the projection of the new image onto the form pixel-by-pixel. <br><br>  Œî = g - P <sub>V <sub>g</sub></sub> f <br><br>  The difference of images will be the desired object. <br><br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">differ</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(i1,i2)</span></span></span><span class="hljs-function">:</span></span> map1 = i1.load(); map2 = i2.load() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> xrange(i1.size[<span class="hljs-number"><span class="hljs-number">1</span></span>]):<span class="hljs-comment"><span class="hljs-comment">#   for j in xrange(i1.size[0]):#    map1[j,i] = map1[j,i] - map2[j,i] return i1</span></span></code> </pre><br><br>  As an example, draw a foreign object on the original image.  And further darken it so that it is not quite simple (we will model changes in registration conditions). <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b73/89e/b18/b7389eb181abcef40878a956bea4083a.jpg" alt="image"><br><br>  The result of the script: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b75/392/921/b75392921d2c4f3f6253e967fd134157.jpg" alt="image"><br><br>  Hooray!  We got a third-party object on a uniform background - it is not difficult to select it and mark it on the original image.  The task of detecting a foreign object is solved. <br></li></ul><br><br><h3>  Conclusion </h3><br>  Conclusion: the algorithm of morphological image analysis was implemented - the selection of a foreign object in the image under the changed registration conditions, as well as the <a href="http://codepaste.ru/12916/">implementation in Python</a> . <br><br><br><h5>  References </h5><br><ul><li>  1. Bityukov Yu.I.  Lectures on computer geometry;  MAI, 2012 </li><li>  2. Pytyev Yu.P.  Methods of morphological image analysis;  Moscow, Fizmatlit 2010 </li></ul><br><br><h6>  Ps </h6><br>  Tell me how to type the formula?  I want to see the beauty of Latex in the articles! </div><p>Source: <a href="https://habr.com/ru/post/163585/">https://habr.com/ru/post/163585/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../163573/index.html">Digital Premiere: Minecraft, Story of Mojang</a></li>
<li><a href="../163575/index.html">The interaction history of the ‚Äúteapot‚Äù and DS18B20 through the Raspberry Pi with sending data to narodmon.ru</a></li>
<li><a href="../163577/index.html">Exim + OpenDKIM implementation for bulk email</a></li>
<li><a href="../163581/index.html">just2d - create a ‚Äúperfect‚Äù game engine. Step 1</a></li>
<li><a href="../163583/index.html">Security of SaaS HRM customers and developers</a></li>
<li><a href="../163587/index.html">How the OS distribution model changes and their availability to the end user</a></li>
<li><a href="../163591/index.html">How do I formally "rein in" Intel SpeedStep</a></li>
<li><a href="../163595/index.html">Garland 8r8s</a></li>
<li><a href="../163597/index.html">Introducing Finger TDD (Rails + Rspec)</a></li>
<li><a href="../163601/index.html">How to release a great iOS application that nobody needs</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>