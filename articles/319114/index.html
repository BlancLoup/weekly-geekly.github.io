<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Delivery speed to user</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Anatoly Orlov ( anatolix ), Denis Nagornov ( Yandex ) 
 Anatoly Orlov: Hello everyone! My name is Anatoliy. I worked in the last 10 years in Yandex. I...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Delivery speed to user</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/94c/791/525/94c791525e49b7315ef07dbd96b33d48.jpg"><br><br><h2>  Anatoly Orlov ( <a href="https://habrahabr.ru/users/anatolix/" class="user_link">anatolix</a> ), Denis Nagornov ( <a href="https://habrahabr.ru/company/yandex/">Yandex</a> ) </h2><br>  <strong>Anatoly Orlov:</strong> Hello everyone!  My name is Anatoliy.  I worked in the last 10 years in Yandex.  In Yandex, I did different things, but it turned out that at HighLoad I always do reports about speeds of different types.  I have a co-rapporteur - Denis Nagornov, he still works at Yandex and is engaged, among other things, do not believe it, also at speed. <br><br>  The report is called "Speed ‚Äã‚Äãwith delivery to the user."  As you know, a huge number of companies are trying to optimize the loading of their pages.  Some companies are so proud of the results achieved that they write these results on their pages, and not even at the bottom, but at the top. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      For example, a screenshot from Google: <br><a name="habracut"></a><br><img src="https://habrastorage.org/getpro/habr/post_images/775/5b1/86b/7755b186b20fd7f640c4540e9ec79146.png"><br><br>  If you look at the same page in the Developer Tools in the browser, you will see that the number will be slightly different, not 430 ms, but 625. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b6a/72e/24b/b6a72e24b1ceac9f264a46c62b0a2317.png"><br><br>  Intuitively, it is more or less clear to all that 430 is somewhere on the Google server, and 625 is here in your browser.  Question: which tsiferka more suited to be a metric of speed?  It seems to me that the tsiferka that you have in your browser is more useful, because you can be proud of the dial-up on the server, but there is no longer any benefit from it.  A tsiferka in the browser really speeds up the user experience. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/09a/75b/877/09a75b8774b3558a24ab8dbc5e04a67c.png"><br><br>  We want to make a certain speed metric on the client.  Here the question immediately arises - what to measure and how to measure? <br><br>  How to measure - the question is simple.  And what to measure is not very trivial, because the page loading is a kind of complex process, about which full reports are made.  But, imagine, you download a file with ‚ÄúWar and Peace‚Äù from lib.ru and there you can read it almost immediately, and it will load in a few minutes, perhaps.  This is an example that it is not clear which point to choose during the download. <br><br>  There are a huge number of sites that, for example, instantly work when you go from page to page - you instantly open navigation, because it is all cached, but it takes some time to load the results. <br><br>  The answer to the question of what needs to be measured for all sites around the world does not exist.  For your particular site, you can come up with such an answer.  For a search engine, probably, the download of the first issue is just the mark that should be measured. <br><br>  There is a phrase: if you have only a hammer out of tools, then all your problems look like nails.  In this area there are so many hammers: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/374/045/eb9/374045eb9b725e5f625849472bdee947.png"><br><br>  Those.  There are two more or less standard APIs and two properties, one of which is implemented in Chrome, and the other in IE.  And so you can not measure everything.  You do not know when, for example, the first result of the issue appeared. <br><br>  What can be measured?  There is some very simplified scheme (actually it is 5 times more) of what is happening in your browser: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8d1/29e/dbc/8d129edbc09b610fcee81764ce2cf0e5.png"><br><br>  There is a point in time when the browser asked for a server request.  Then the server starts to produce HTML.  First comes the first byte, then quietly the rest of the baytik, then the last byte.  And here we have a certain set of metrics.  You can measure the time to the first byte, you can measure the transmission time, you can measure the time to the last byte, and this is all pulled out with Java Script, uploaded to the server and on the server to build charts. <br><br>  For comparison.  This is some first byte of the fast server, the server is somewhere not very far from Moscow.  How it looks in different cities of Russia: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b2d/fd1/53a/b2dfd153a0f28cb756696145c3923b94.png"><br><br>  Here in each line there are several values, this is so-called.  percentile.  For those who do not know, the 50th percentile means that 50% of user responses are faster than this value, 50% more.  Well, 95% is the same.  What do we see on this chart?  Here is the server, which is conditionally responsible for 0, i.e.  From the server, the first baytik flies right away.  The size of the page for the first byte does not matter, because it is the first byte - it came as it came.  From interesting data here, for example, we will look at Vladivostok - for some reason he confidently ‚Äúdoes‚Äù Novosibirsk at high percentiles, then, if we look at low percentages.  Low percentiles are conventionally determined by the speed of light, and high percentiles are not clearly defined by what.  To me, here from this graph, it seems that in Novosibirsk there is some kind of problem with connectedness. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dfd/76d/4ff/dfd76d4ff45c8c0f9f1aedaecfe1b196.png"><br><br>  The last byte of the fast server.  In fact, this is a kind of synthetic metric here I have drawn.  Those.  here I took the time of issuing the search, but since here the server time is not much zero, I just subtracted it from the results.  That is, roughly speaking, how much would take a search response, if the server time was zero.  Here we see numbers quite large.  From the interesting - here again, Novosibirsk is breaking out into some kind of anti-leaders, Vladivostok is unexpectedly cool, he ‚Äúmakes‚Äù Almaty and Kiev.  Something like this.  I gave the numbers for you to understand the order.  There on the bottom tsiferke, 95th percentile, 3 seconds with a penny.  Ie, roughly speaking, if you optimize your server for 100 ms, you understand that you are not quite optimizing for some time. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7b2/14d/0b7/7b214d0b79636632e9dcc76714ab7859.png"><br><br>  On the previous two slides was statistics.  There is a saying that there is a lie, a blatant lie and statistics.  This is a statistic. <br><br>  When we talk about statistics, we need to talk about restrictions.  First, these APIs are not supported by all browsers.  Those.  on the desktop, everything is not bad with this, but on mobile phones, these APIs can only Chrome on Android.  Secondly, we must understand that browsers give different numbers.  Those.  different property names in Chome based browsers and in IE, they say that we measure something different. <br><br>  Then, if it is possible to understand from Chrome what this tsiferka means, because there are sources, then tsiferka means in IE, in fact, it is impossible to understand.  Therefore, it is not very correct to compare them formally, but on the other hand, if you are not the author of the browser, and are not trying to overtake IE, you really do not care, because you have approximately the same distribution of browsers on the site, compare it with what was and normal.  And various statistical conclusions are subject to different cognitive errors. <br><br>  Let's look at something more interesting.  Here we have a split time to the first byte in a section on different browsers: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c06/76c/5bb/c0676c5bbef5c72bb13552d50cffe384.png"><br><br>  What do we see here?  We see that Chrome is faster than IE, Opera unexpectedly performs poorly.  And here we have a super browser, called Safari, which works 2.5 times faster than all other browsers.  This is a classic example called bias.  The situation is very simple - if you look around, then Macintosh is at every second, relatively speaking.  So, if you go somewhere in the forest to Lake Baikal, Macintosh will be yours only, there are no other poppies, so yes, it‚Äôs true that all people in Safari very quickly open pages, but this is not because Safari is good, but because they usually have a good Internet.  They are in Moscow, they are IT specialists and all that.  No wonder that such a picture exists.  This is to the fact that when you see some hypotheses, they must somehow be considered and tested. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c3/1ea/f01/5c31eaf01998dd0897961a2f453923d2.png"><br><br>  There is such a magic protocol, it is called HTTPS.  We all love him, everything goes to him.  What do we know about him?  In general, the protocol should be slower.  Everyone understands that there are all kinds of public key calculations, any kind of handshake, there is an extra roundtrip.  In general, everyone knows that HTTPS is slower, this is a common understanding. <br><br>  If we look at these graphs, the first byte in HTTPS comes faster.  I will not show you the schedule, it is not the most important here.  I believe that this is a certain choice of statistics, i.e.  Most likely, the browser considers the first byte of handshake to be the first byte of HTML, so they say it is a little faster.  But there is still such a strange conclusion that it generally becomes faster in sum.  That's real, https is faster.  And for some time this conclusion turned out to be highly paradoxical for us; we began to dig what the problem was there. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dad/a6a/7cb/dada6a7cb84c9175db58fec3ac118f50.png"><br><br>  I already showed it.  But since everyone has already forgotten, I will show it again.  We look at the parameters "time up to the 1st byte" and "html transmission time".  Here is the difference in the relationship of this joke.  So: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/625/e33/1d8/625e331d8313eeeeaa931397dc37b559.png"><br><br>  So: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/48b/656/050/48b656050d34632b4566bb177d2d296a.png"><br><br>  So: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/74d/f68/7e4/74df687e47420da615f11df7a2148214.png"><br><br>  Or so: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/f13/b82/5af/f13b825afb3b69c8720311489685bbf8.png"><br><br>  In short, there is a certain graph, which ... This is actually the first graph in the presentation that you should think about in order to understand what is drawn on it: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/d31/81e/570/d3181e570af2feddf59171320e30ad47.png"><br><br>  See what we do.  X axis is just the number of the request.  But requests are sorted by html transmission time.  And on the Y axis, there is a green dot - the time to the first byte, and a black dot - the time to html transmission.  Since the time of html transmission is all sorted, we have all the black points lined up in one continuous line, which is more or less logical.  And since the time to the first byte is not sorted, they are not lined up, but it shows that there is some kind of correlation, i.e.  there, the longer the load time of the first byte, the longer the transmission time.  But here on the graph we see two clearly different clusters.  The first clusters behave more or less normally, the transfer time there correlates, and it is about 70%, and the right edge 30% is the time of strange requests, which have a load time, conditionally, about 0, and the time of the first byte is not zero.  Ie, roughly speaking, the page for a long, long time was tupila, and then instantly surrendered entirely.  Question: what is it?  You will not believe this is actually antivirus software. <br><br>  How does antivirus work?  Anti-Virus is very, very afraid that you will now upload to your page some kind of scary virus or an image with an exploit, or something else.  Therefore, when you load something over http, the antivirus buffers everything, waits for the last bytetika, quickly checks and then spits everything out to you.  Since the page is already on your computer, it turns out that the page has slowed down for a long time, then quickly came. <br><br>  Question: what happens if we switch to HTTPS in this place?  Immediately all antiviruses will lose the opportunity to create their magical good, and the pages start loading faster after that.  This effect, in fact, about why HTTPS, despite all intuitive judgments, works faster than HTTP.  And this is the reason why all sites like Google and Facebook are switching to HTTPS - it‚Äôs just stupidly faster.  I understand that this is a kind of strongly revolutionary statement, so I will apply proofpic. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/5c6/fb8/47b/5c6fb847bdbbce2a242fadee56c162bd.png"><br><br>  Proofpic - what is it?  This is a picture from some internal Yandex interface.  I redrawn previous graphs in Excel, but if I redrawn this graph in Excel, it would not be Proofpic, I could forge it.  Therefore, it is with thin lines, not very convenient.  This is the load time for a certain Yandex page in HTTPS and not in HTTPS in the city of St. Petersburg.  The percentile is plotted along the X axis, the load time is plotted along the Y axis, while it is logarithmic, i.e.  the scale is 100 thousand, 10 thousand, not 100, 200, 300. And here we see that HTTPS is faster on all percentiles. <br><br>  This is the same in Vladivostok: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/823/584/02f/82358402fff862beb7335787d45d2ace.png"><br><br>  The company Yandex, when fighting with antivirus programs (we have good relations with antivirus companies), we asked them all to end up putting us in the white sheets.  The graph that I built with green dots, it is very old, this is up to this point.  But this effect has not disappeared, these are new graphics, literally in September.  It seemed to me that these graphs give different DPI systems, which our websites are banned from, so God forbid, that there‚Äôs something bad we don‚Äôt see on the Internet.  It seems there is such a thing. <br><br>  This schedule from Kiev: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/8a8/529/062/8a8529062a096b417bbeef66872fdb2f.png"><br><br>  And here is exactly the same situation, which says that perhaps the great Russian DPI is not quite what, although he is somehow involved there. <br><br>  And this schedule from Istanbul: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/58e/fed/5b5/58efed5b5aae5b0aca560ba78c214526.png"><br><br>  In Istanbul, as you see, HTTPS and HTTP are almost the same, there is some other situation, but I don‚Äôt know why. <br><br>  The conclusion I make is about the fact that there is a huge number of different types of systems that consider themselves very smart, they are very interested in what you have there in HTTP, and because of this they are slowing down.  Therefore, I urge you to use HTTPS in almost all cases. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/234/96b/c10/23496bc10ada082d561beb0beaf06b3c.png"><br><br>  This is a kind of intermediate result, the end of the first part. <br><br>  We realized that server time is not everything.  And we understood how to measure client.  What we do not understand here is how it turns out that in Vladivostok, until the ping is clearly less than 200 ms, the page load time in the 95th percentile can be 3 seconds, and the question is: where did these packages go around this time?  And here it becomes clear the lack of those API browsers, about which I spoke, because it returns the number to you, and you yourself have no idea what this number is from, you do not know what is happening there. <br><br>  There is such a magic tool called tcpdump: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/546/921/065/5469210650fdb78946093562756dde3e.png"><br><br>  All admins know and ever used it.  What does the tool do?  You can take off the traffic, and there will be everything, because when the server sends a bag to the user, a bag comes from the user that ‚Äúdude, I received your packet‚Äù, and thus you can check the delivery time.  The problem is that this thing is time consuming, and secondly, it is applied pointwise, you can watch one session, you can watch 10 sessions, but you can‚Äôt watch 1 million sessions in tcpdump.  As if the work is really stupid, the question is: can it be automated?  It turns out that you can. <br><br>  There is such opensource tool.  I wrote it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/4eb/a3c/78e/4eba3c78ec5aadb59d11bcb0b91f387d.png"><br><br>  I realized that I forgot to open a project on GitHub, but I will do it right after the report.  It will be on the second link, and then it will be passed on to the first link. <br><br>  What it is?  This is some tool that parses tcpdumps.  It parses tcpdump into a text file, which can be loaded into Excel and understand what is happening there.  I can immediately say that this is not the final product, this is the hardcore tool.  Do not hesitate to contact me, I'll tell you how to use it, if that. <br><br>  Now I will try to give the result, which can, in fact, tool.  Let's first consider this stand: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/dc2/364/f13/dc2364f13b2c2983368939cc536b5ad2.png"><br><br>  This is a kind of classic stand.  We have a web server, there is some kind of balancer above it, let's say it is nginx.  From the Internet comes a request.  Let's try to understand what are the timings of these requests. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/24e/7b8/cc7/24e7b8cc773d7c89e3d56d8b2b2fd111.png"><br><br>  Customer request from us always always comes to zero millisecond, because we start to count time from it.  Our balancer is very, very fast and well written, so this request goes to the backend right to the same zero millisecond, i.e.  a bag came in and was thrown right away. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b0a/7b7/277/b0a7b72779c3eb128eb05d67e7b38cf2.png"><br><br>  Following.  Time with a web server.  This particular web server is designed like this.  He thinks about something 170 ms, and then fully renders the finished page.  And it is worth noting that if the request is usually one bag, the answer is several bags, we take the first and the last of them, but since it was all born and spit whole, they all go to the same thing. time.  And then the balancer starts distributing this page to the user, for which, in fact, nginx is written. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/aab/bb3/f57/aabbb3f5705f6376568d64b15cdabfd4.png"><br><br>  And since our balancer is fast, it gives the first byte to the user at the 170th millisecond.  Question: when he will give the last baytik? <br><br><img src="https://habrastorage.org/getpro/habr/post_images/840/afd/4f5/840afd4f547dc508c131c2202787c3e0.png"><br><br>  This graph is based on tcplanz results.  What is on the chart here?  On the X axis, the request number, sorted by time.  Here, in fact, there are 4 lines, but the 3 lines below are conditionally connected into one, because they are directly about the same thing, they are all 170 ms, they are on top of each other.  And the purple line is when the last byte of the response to the user from our balancer is gone.  What do we see here?  Our web server made a page for 170 ms, and then, when we started to send to the user, we gave the last byte for 490 ms. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/59c/6be/24f/59c6be24f6bcfbceac15d9a96ba4d3fd.png"><br><br>  Those.  The conclusion is approximately as follows: when you ask the question: ‚Äúwhere have the packages been hanging all this time?‚Äù, they actually lay on your server all this time, oddly enough.  When in Vladivostok the 95th percentile is 3 seconds, all this time you have packages do not leave your server.  This is a paradoxical answer.  Now I will explain where it comes from. <br><br>  In order to get an answer to this question, you need to know how TCP works.  About TCP written a lot of books, right volume.  You can even tell about TCP for a separate speech, but I will try to tell you in one slide.  Although it will turn out very primitive. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/7f8/042/131/7f804213121fce603aa8c038356b91a4.png"><br><br>  Here are three TCP concepts that need to be recognized: <br><br><ul><li>  the first is the so-called  round trip time is the time when the bag comes to the right server and back.  When you use the ping utility, the number you see there is the time of the round trip. <br></li><li>  Then there is the concept of ACK - this is proof of delivery.  You throw a data packet to the user, and a ‚Äúdude, I got the data‚Äù packet comes from the user, and by this packet you can understand when the data is reached, because you divide the time between the packet and ack in half, and around this time it was at the user.  It is worth noting that ack does not come on every packet, because one ack ack contains several packets. <br></li><li>  The third concept is called cwnd.  congestion window.  What it is?  This is a certain number, which means how many packets can be sent without confirmation, i.e.  You send some packets and then wait for confirmation until it arrives. <br></li></ul><br><img src="https://habrastorage.org/getpro/habr/post_images/dda/5dd/ef3/dda5ddef3c3d3990d9e341dee26ca35a.png"><br><br>  What determines the speed of delivery.  The rule is very simple: for every CWND packet, you need rtt time.  Those.  on the Internet, the typical packet size is 1450 bytes, or 1410, when you have cwnd = 10, rtt = 100, then your flow rate will be 145 Kbytes per second.  When you have cwnd = 100, rtt = 50, the speed will be almost 3 meters per second.  And cwnd is not some tough-looking parameter, it is a parameter that controls the speed of the TCP channel.  There are actually many policies that can be applied, but the rule is very simple: cwnd grows slowly, so far so good, that is,  while the sachets go, and it drops a lot when something bad happens in the channel when the packet is lost.  A typical policy that can be applied - for each ack can be increased by one, and when a package is lost - cut in half.  This is such the oldest, now new, more fashionable all sorts of politicians, etc. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/854/31b/af5/85431baf560e827ea874d50cc141fbd5.png"><br><br>  Total, what do we know about TCP?  In general, this is the newest protocol, made in the 70th year, now a little outdated.     ,   ,  70-     .  ,           -  TP-,       ,  -,   . <br><br> ,    , ..   ,    wi-fi,   ,   .    assumption ,   ,  :   congestion.  What it is?  ,        ,     ,        ,        ‚Äî       100-      100- ,   ,   ,      ,    .     TCP ,    ,    ,      ,      ,    .  ,     .  Why?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because packets are no longer transmitted by wire, they are transmitted, for example, via wi-fi, and a wi-fi package can disappear just like that, not because the speed is exceeded, but because it is not lucky. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Many people do not understand how wi-fi works. They believe that this is some kind of radio that hits through the wall. Here is an example of the spread of wi-fi waves in an apartment:</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/c24/3e5/841/c243e5841643b3cce6187cf52efb5225.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Obviously, wi-fi wraps the walls, here it is written in which wall it falls. Wi-fi interferes on itself, waves intersect with themselves, with other devices, etc. You understand that in wi-fi a sachet is just lost and that's it, this is just such a limitation. Wi-fi has a wavelength of 12.5 cm, if a wi-fi router is very, very accurate to the wall, not 12.5 cm from the wall, but 12.5 cm from the iron part of the wall, you can get a so-called standing wave when our router stops working at all. So that you understand, everything is strange. And therefore in wi-fi it is absolutely normal that packets are lost there. But TCP, when he sees lost wi-fi packets, he begins to slow down, which is unclear why.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/cdb/ce1/887/cdbce18878fbf5142127a9ec5bbbd47d.png"><br><br>      ‚Äî wi-fi vs TCP. ,    -       2000   rtt=100.    2000     ,      .    ,  -   ,      .         wi-fi ,      20    .   ,      20      .  Those.     5%  wi-fi ‚Äî    ,  wi-fi.   , , , 80% -   .    ,     TCP-,   : rtt=100    5%.  ,          .    ,       ,   . <br><br>  What to do?       ‚Äî   . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/335/77f/0a8/33577f0a8ffaba912a25e48bd8e8defd.png"><br><br> -,    ,   , -,  ,  -  .   ,   -   , ..     ,    .    -    . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/835/670/c21/835670c21ee60976f59da4dc9dd7cda4.png"><br><br>  ,   CDN,    ,  CDN   - ,   , , - .  In fact, this is not true.  ,     CDN   ,     - ,       loop,     TCP-     5%  rtt=100.       TCP-,       0%  rtt=90,  - ,    0%    KeepAlive-,     CWND   -  ,          .   CDN-       5% ,   ,     ,   rtt  10 . <br><br><img src="https://habrastorage.org/getpro/habr/post_images/b06/e1a/91c/b06e1a91cc4685e4d345ae6188b197c7.png"><br><br>      TCP.   ,  Initial CWND,   CWND,    TCP-.  Initial CWND=10.  ¬´10¬ª        ,  ,     -    . <br><br>       .    RFC,    ,       1  2.  -     RFC,   ,       2  4.        Google    ,      10.  ,    ,   10 ‚Äî        ,  ,    ?   10   ,         ,        3-4 rtt,      10    14 .     ,          3,  4 rtt,  .   ,     , ..  ,  . <br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">This parameter can be tweaked. </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/0ab/aa4/286/0abaa42867deffae7f57d3b8fac0f5f0.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For example, an experiment in Yandex. </font><font style="vertical-align: inherit;">This is a Turkish balancer, they took and set the initial cwnd = 20. </font><font style="vertical-align: inherit;">Note that this is one unix sysctl.</font></font> What happened?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Here are 4 graphics. </font><font style="vertical-align: inherit;">They are in pairs - it was, it became. </font><font style="vertical-align: inherit;">The lower graph shows the delay between the first and the last packet of the tcpdump response.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we see that a third of the pages used to go away immediately, without waiting, now 2/3 began to go away. </font><font style="vertical-align: inherit;">And at the top - this is the time to get the user ack, that the page reached. </font><font style="vertical-align: inherit;">For tcpdump, this is the same value as the time to the last byte in the browser that was.</font></font> Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">we just twisted the sysctl and improved the page load from scratch. This is an example of how you can be creative with TCP. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">For the sake of justice, it must be said that it was a type of face, we tried to do the same thing with the search results, they were just bigger, and it turned out rather strange - some classes of queries got stronger, and some worsened. There apparently you need to be able to rotate this parameter separately for different clients, which the core does not allow to do now. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">There is such a crazy example: </font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/423/fb7/1dd/423fb71ddcd8b61170e3562336dd8baf.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Why mad? Because I did not do it myself and do not urge you to do so. But he well illustrates what can be done in TCP. Imagine that you ignore CWND altogether.</font></font> Those. ,    60  ‚Äî 40 ,      .       ,     ,     1     .    40    . ,        ,   ,   ,   70%.  -   ‚Äî  ,  ,     ,    ,     . ,   - ,  ,      selective ack (,  ¬´  ,  3, 10, 17-     ¬ª,     3, 10, 17- ).  So  :         1-2 rtt.  Those.<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">it's faster, it's not 3 seconds. This is a good example of how to spoil TCP so that it becomes faster. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">The problem is that now this can not be done, because TCP is spinning somewhere in the core, and there are no handles on the outside, and you still have to turn it to the first connection.</font></font> Those.    user agent  ,     mobile safari -,      ,     -  ,       . <br><br>   ,  QUIC.     ,  UD-based.           ,   ,  TCP,   UDP.       ‚Äî           ,       user space.             user agent  ..   ,      QUIC,  ,   ,   .  Why?<font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Because if you do this, you will get better, but if everything is done on the Internet, then the Internet will break. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Can not do. There is an asterisk, it stands for something like this: if you look at your CDN, what is written is exactly what is happening inside. There even without a pause of 1 ms. There are computers that trust each other, that they are able to receive a large amount of data, channels that have nothing to lose, almost no congestion, and any page that you throw inside the CDN, it all goes there, because CWND is awesome, overclocked . And this is how the CDN works with a large, large number of companies. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">At this point, I want to take some results.</font></font><br><br><img src="https://habrastorage.org/getpro/habr/post_images/446/a91/bb6/446a91bb664a02575d015db746136616.png"><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">It is necessary to understand that those 3 seconds of the server that are there, they do not occur because the package on the Internet is hanging around somewhere, the package lies on your machine at this time, and your own machine delays it due to the protocol restriction. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Silver bullet is not here, but here you can optimize something. </font><font style="vertical-align: inherit;">Then, if you work with browsers, you do not have much room for optimization, but if you are writing a mobile application, you can do QUIC right now. </font></font><br><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">And third, when you do optimization, please watch what happens. </font><font style="vertical-align: inherit;">There are tools, Timing API in browsers, there are tcpdump in which you can understand everything that happens. </font><font style="vertical-align: inherit;">Just take and see.</font></font><br><br><h3>  Contacts </h3><br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">¬ª </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">Anatolix@yandex.ru</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font></font><a href=""><font style="vertical-align: inherit;"><font style="vertical-align: inherit;">den@yandex-team.ru</font></font></a> <br><font style="vertical-align: inherit;"><font style="vertical-align: inherit;"> ¬ª </font><a href="https://habrahabr.ru/company/yandex/"><font style="vertical-align: inherit;">Yandex</font></a><font style="vertical-align: inherit;"> company blog</font></font><a href="https://habrahabr.ru/company/yandex/"><font style="vertical-align: inherit;"></font></a> <br><br><blockquote> <font color="gray">      ‚Äî  ,        (   )  . <br><br>   ‚Äî           <a href="http://highload.ru/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad++</a> . <br><br></font>  <font color="gray">Also, some of these materials are used by us in an online training course on the development of high-load systems <a href="http://highload.guide/%3Futm_source%3Dhabr%26utm_medium%3Dmedia%26utm_campaign%3Dpast.articles%26utm_content%3Dcommon">HighLoad.Guide</a> is a chain of specially selected letters, articles, materials, videos.</font>  <font color="gray">Already, in our textbook more than 30 unique materials.</font>  <font color="gray">Get connected!</font> <font color="gray"><br><br></font>  <font color="gray">Well, the main news is that we have begun preparations for the spring festival " <a href="http://ritfest.ru/">Russian Internet Technologies</a> ", which includes eight conferences, including <strong>HighLoad ++ Junior</strong> .</font> <font color="gray">Junior ‚Äî    ! Junior   ,     ,    ,        .     </font> </blockquote></div><p>Source: <a href="https://habr.com/ru/post/319114/">https://habr.com/ru/post/319114/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../319100/index.html">Comparing objects by value - 6: Structure Equality Implementation</a></li>
<li><a href="../319104/index.html">3CX integration with amoCRM</a></li>
<li><a href="../319106/index.html">Is Nuklear the perfect GUI for micro projects?</a></li>
<li><a href="../319110/index.html">One Core API to edit Windows</a></li>
<li><a href="../319112/index.html">VZ7 vs VZ6: Is there a reason to be updated?</a></li>
<li><a href="../319116/index.html">Classes in C ++ Russia 2017</a></li>
<li><a href="../319118/index.html">The way to deal with the brutal anti-adblockers, blockers themselves</a></li>
<li><a href="../319126/index.html">Pure Python Architecture: A Walkthrough. Part 1</a></li>
<li><a href="../319128/index.html">Infrastructure simple electronic signature. Part 3: Personal Data Processing Systems</a></li>
<li><a href="../319132/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ244 (January 2 - 8, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>