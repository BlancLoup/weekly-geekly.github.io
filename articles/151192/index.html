<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Debugging Android applications without source codes: native methods</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="What is this article about 
 In the two previous articles, I talked about how to debug Android applications without Java source code and about some fe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Debugging Android applications without source codes: native methods</h1><div class="post__text post__text-html js-mediator-article"><h4>  What is this article about </h4><br>  In the two previous articles, I talked about <a href="http://habrahabr.ru/post/150825/">how to debug Android applications without Java source code</a> and <a href="http://habrahabr.ru/post/150862/">about some features of installing breakpoints</a> .  If a dear reader has not yet read these articles, I strongly recommend starting with them, and only then read this article. <br><br>  It just so happened that so far I have been talking exclusively about debugging Dalvik bytecode and have not said a word about debugging native methods.  And after all, it is in the native methods that the most tasty things are often hidden ‚Äî tricky defenses, interesting malware features, zero-day vulnerabilities.  Therefore, today I‚Äôm compressed, without ‚Äúwater‚Äù, I‚Äôll tell you how to debug native methods without C / C ++ source code (or what, dear reader, they are written there). <br><a name="habracut"></a><br>  In order to benefit from my story, you need to be a bit "in the subject."  In particular, it is desirable that the reader <br><ul><li>  Understood <a href="http://code.google.com/p/smali/">Smali</a> syntax, could write his code into .smali files and could distinguish declarations and calls to native methods from ordinary methods, could reassemble .apk files using <a href="http://code.google.com/p/android-apktool/">Apktool</a> ; </li><li>  I imagined what the <a href="http://en.wikipedia.org/wiki/Java_Native_Interface">Java Native Interface (JNI) is</a> and <a href="http://docs.oracle.com/javase/7/docs/technotes/guides/jni/spec/jniTOC.html">how it works</a> ; </li><li>  He knew what the <a href="http://developer.android.com/reference/java/lang/System.html">System.load (...)</a> and <a href="http://developer.android.com/reference/java/lang/System.html">System.loadLibrary (...)</a> methods are used for, how they work in Android, and using the arguments to these methods in Smali code could independently determine in which .so libraries there are JNI functions corresponding to those or other native methods; </li><li>  able to find these JNI functions in .so libraries; </li><li>  at least at the <a href="http://www.eng.auburn.edu/~nelson/courses/elec5260_6260/ARM_AssyLang.pdf">initial level I</a> knew the <a href="http://infocenter.arm.com/help/topic/com.arm.doc.dui0068b/index.html">ARM assembler</a> (the article assumes that debugging will be performed on a device with an ARM architecture or on an emulator that emulates this architecture); </li><li>  had some experience with <a href="http://www.gnu.org/software/gdb/documentation/">gdb and gdbserver</a> ; </li></ul><br>  That's probably all the knowledge and skills that will be needed by the reader.  Let's go to the tools. <br><br><h4>  Instruments </h4><br>  Today we will need: <br><ul><li>  gdb and gdbserver for ARM from the latest version of <a href="http://developer.android.com/tools/sdk/ndk/index.html">Android NDK</a> .  Installation is described <a href="http://developer.android.com/tools/sdk/ndk/index.html">here</a> . </li><li> The <code>adb</code> utility from the latest version of the <a href="http://developer.android.com/sdk/index.html">Android SDK</a> .  Installation is described <a href="http://developer.android.com/sdk/installing/index.html">here</a> . </li><li>  If debugging is on a real Android device, you need root rights on it. </li></ul><br>  We turn to the preparation. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  Training </h4><br>  It is assumed that the reader is experienced enough to independently perform the following preparatory actions: <br><ul><li>  Disassemble the .apk application file using Apktool, examine the files in the subdirectory <code>////smali</code> and find out: <br><ul><li>  what native methods are called from Dalvik bytecode; </li><li>  In which .so library are the JNI functions corresponding to these methods; </li></ul><br></li><li>  Pull this .so library from the subdirectory <code>////lib</code> or from the device on which debugging will be performed, examine it and find out how the JNI functions are called which correspond to one or another of the Dalvik bytecode methods. </li><li>  Rebuild the .apk application using Apktool with <code>-d</code> and drive it to debug in NetBeans as written in <a href="http://habrahabr.ru/post/150825/">this article of mine</a> . </li><li>  Make debugging in NetBeans stop <b>after</b> calls to <code>System.loadLibrary(...)</code> or <code>System.load(...)</code> , which load .so with JNI functions that interest us, but <b>before the</b> first call to any of the native methods.  You can use the trick I wrote about <a href="http://habrahabr.ru/post/150862/">here</a> . </li><li>  To push gdbserver on the device or the emulator on which we are debugging. </li></ul><br>  Now that all the preparations have been completed, you can proceed to debugging itself. <br><br><h4>  Debugging </h4><br>  The idea is to push our application directly under two debuggers: under the debugger built into NetBeans - to debug Dalvik bytecode, and under gdb - exclusively to debug calls to native methods.  It sounds a little strange, but in practice it works quite well.  Although not always - see the next section ‚ÄúPitfalls‚Äù. <br><br>  So, if the reader has completed all the preparatory steps from the previous ‚ÄúPreparation‚Äù section, now a reassembled application is probably running on his device or emulator, NetBeans is open on the computer, and debugging is somewhere after calling <code>System.load(...)</code> or <code>System.loadLibrary(...)</code> , but before the first call to the native method.  And the reader is already aware of which library in which JNI functions correspond to which native methods.  From this we begin. <br><br>  Next comes step by step instructions.  It was written for Windows, but I think it will work for Linux and MacOS.  Please follow the instructions exactly: <br><ol><li>  Command <code>abd shell</code> open the ADB console of your device or emulator.  Find the PID of your application process using the <code>ps</code> command in the ADB console.  In the same console, run the command: <br><pre> <code class="hljs pgsql">gdbserver :<span class="hljs-number"><span class="hljs-number">5039</span></span> <span class="hljs-comment"><span class="hljs-comment">--attach %PID%</span></span></code> </pre>  where <code>%PID%</code> is the PID process of your application.  In response, gdbserver should output something like: <br><pre> <code class="hljs vhdl">Attached; pid = %PID% Listening <span class="hljs-keyword"><span class="hljs-keyword">on</span></span> <span class="hljs-keyword"><span class="hljs-keyword">port</span></span> <span class="hljs-number"><span class="hljs-number">5039</span></span></code> </pre>  <b>From now on, debugging in NetBeans will freeze.</b>  <b>Those.</b>  <b>Of course, you can click on the buttons there, but it is useless because</b>  <b>the application that you are trying to debug in NetBeans is currently stopped under the GDB debugger.</b>  <b>Do not panic, everything should be so!</b> </li><li>  Open a new console on your computer, run the command <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">adb</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">forward</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tcp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5039</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">tcp</span></span><span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5039</span></span></code> </pre> </li><li>  In the same console, run gdb from the Android NDK: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">gdb</span></span> libMyNativeLibrary.so</code> </pre>  where <code>libMyNativeLibrary.so</code> is the very .so library where the JNI functions of interest are located.  The library should be located on your computer in a directory that for gdb is current at startup.  This will open the gdb console. </li><li>  In the gdb console, type the following commands: <br><pre> <code class="hljs css">(<span class="hljs-selector-tag"><span class="hljs-selector-tag">gdb</span></span>) <span class="hljs-selector-tag"><span class="hljs-selector-tag">target</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">remote</span></span> <span class="hljs-selector-pseudo"><span class="hljs-selector-pseudo">:5039</span></span></code> </pre>  After these manipulations, a message like this should appear in the gdb console. <br><pre> <code class="hljs cs">Remote debugging <span class="hljs-keyword"><span class="hljs-keyword">using</span></span> :<span class="hljs-number"><span class="hljs-number">5039</span></span> <span class="hljs-number"><span class="hljs-number">0x4009d58c</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ?? ()</code> </pre>  and in the ADB console (it‚Äôs still open, remember?) something like <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">Remote</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">debugging</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">from</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">host</span></span> 127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span></code> </pre> </li><li>  In the gdb console, run <br><pre> <code class="hljs pgsql">(gdb) <span class="hljs-keyword"><span class="hljs-keyword">info</span></span> <span class="hljs-keyword"><span class="hljs-keyword">functions</span></span></code> </pre>  to see the list of functions.  In the list, among other functions, should be the JNI functions that interest you, something like: <br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">0x5b5f</span></span>7bac Java_my_app_for_debug_MainActivity_coolNativeMethod <span class="hljs-number"><span class="hljs-number">0x5b5f</span></span>7c0c Java_my_app_for_debug_MainActivity_anotherCoolNativeMethod <span class="hljs-number"><span class="hljs-number">0x5b5f</span></span>7c1c Java_my_app_for_debug_MainActivity_theCoolestNativeMethodEver</code> </pre> </li><li>  In the gdb console, put breakpoints to the addresses of the functions you are interested in, in our case this <br><pre> <code class="hljs lisp">(<span class="hljs-name"><span class="hljs-name">gdb</span></span>) break *0x5b5f7bac (<span class="hljs-name"><span class="hljs-name">gdb</span></span>) break *0x5b5f7c0c (<span class="hljs-name"><span class="hljs-name">gdb</span></span>) break *0x5b5f7c1c</code> </pre> </li><li>  Resume the execution of your application using the <code>c</code> command in the gdb console.  <b>After executing this command, debugging in NetBeans will ‚Äúfreeze‚Äù and you can again debug Dalvik bytecode.</b> </li></ol><br>  Now, every time there is a call to the native method in Dalvik bytecode, like <br><pre> <code class="hljs php"><span class="hljs-keyword"><span class="hljs-keyword">const</span></span>/high16 v8, <span class="hljs-number"><span class="hljs-number">0x4100</span></span> invoke-<span class="hljs-keyword"><span class="hljs-keyword">static</span></span> {v8}, Lmy/app/<span class="hljs-keyword"><span class="hljs-keyword">for</span></span>/debug/MainActivity;-&gt;theCoolestNativeMethodEver(F)V</code> </pre>  debugging in NetBeans will freeze, but gdb will please you with messages like <br><pre> <code class="hljs cs">Breakpoint <span class="hljs-number"><span class="hljs-number">1</span></span>, <span class="hljs-number"><span class="hljs-number">0x5b5f7c1c</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">in</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Java_my_app_for_debug_MainActivity_theCoolestNativeMethodEver</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">from</span></span></span><span class="hljs-function"> libMyNativeLibrary.so</span></span></code> </pre><br>  That is actually it.  Further <code>x/i $pc</code> , <code>stepi</code> - generally forward to debug one ARM instruction after another (remember, I said at the beginning that the ARM assembler will be needed? - well, here ...) <br><br><h4>  Underwater rocks </h4><br>  Oh, there are a lot of them.  A whole garden of pitfalls.  Here are the most memorable bugs that caught me when using GNU gdb (GDB) 7.4.1 in conjunction with GNU gdbserver (GDB) 7.4.1 on Android 4.0.3 in the Ainol Aurora device ( <a href="http://habrahabr.ru/post/138243/">the old one</a> ): <br><br><ol><li>  If after some time your gdb falls off regularly from gdbserver by watchdog timeout, run <code>set watchdog 18000</code> in the gdb console - this should help. </li><li>  Sometimes as a result of the <code>info functions</code> in the list of functions, not the addresses of functions in memory are displayed, but offsets in the .so file, for example: <br><pre> <code class="hljs">0x000c0bac Java_my_app_for_debug_MainActivity_coolNativeMethod 0x000c0c0c Java_my_app_for_debug_MainActivity_anotherCoolNativeMethod 0x000c0c1c Java_my_app_for_debug_MainActivity_theCoolestNativeMethodEver</code> </pre>  In this case, check or <code>libMyNativeLibrary.so</code> really lies in the directory that for gdb is current at startup, and restart gdb again with the same command <code>gdb libMyNativeLibrary.so</code> . </li><li>  Sometimes, as a result of the <code>info functions</code> , the list of functions displays the addresses of functions in memory and offsets in the .so file, for example: <br><pre> <code class="hljs go"><span class="hljs-number"><span class="hljs-number">0x5b5f</span></span>7bac Java_my_app_for_debug_MainActivity_coolNativeMethod <span class="hljs-number"><span class="hljs-number">0x5b5f</span></span>7c0c Java_my_app_for_debug_MainActivity_anotherCoolNativeMethod <span class="hljs-number"><span class="hljs-number">0x5b5f</span></span>7c1c Java_my_app_for_debug_MainActivity_theCoolestNativeMethodEver <span class="hljs-number"><span class="hljs-number">0x000c0bac</span></span> Java_my_app_for_debug_MainActivity_coolNativeMethod <span class="hljs-number"><span class="hljs-number">0x000c0c0c</span></span> Java_my_app_for_debug_MainActivity_anotherCoolNativeMethod <span class="hljs-number"><span class="hljs-number">0x000c0c1c</span></span> Java_my_app_for_debug_MainActivity_theCoolestNativeMethodEver</code> </pre>  Ignore offsets in the .so file, put breakpoints on the addresses of functions in memory. </li><li>  If the <code>break</code> command for function names works fine, you are lucky, if not ... well, actually it doesn't work for me, so in this article I put breakpoints on the function addresses. </li><li>  <code>set stop-on-solib-events</code> may not work.  It does not work for me. </li><li>  From time to time you will see the words <code>Cannot access memory at address 0x1</code> .  Ignore. </li></ol><br>  I am sure that this is not a complete list of glitches, which is fraught with the debugging of native methods without source codes, and that other researchers will find completely different, unique glitches that have not caught me.  If anyone else finds - please share in the comments.  Also in the comment please ask questions and / or make technical amendments to the text.  I will try to answer as quickly as possible, but if I‚Äôm stupid, please be patient.  I will try to answer all. <br><br>  Happy debugging! <br><br><hr><br>  PS A request to the minus article unsubscribe in the comments what exactly did not like.  I will try to fix it if possible. <br><br>  PPS The article is a big plus, so the topic of debugging and reversing engineering is interesting to people and I will share my experience further.  What were the disadvantages of the article in the beginning I did not understand - but oh well, let's write off the random fluctuations of habrasils. <br><br>  PPPS If anyone needs technical assistance on the topic of the article - contact me, maybe I can help. </div><p>Source: <a href="https://habr.com/ru/post/151192/">https://habr.com/ru/post/151192/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../151185/index.html">Isolating code during testing using Microsoft Fakes (Shims)</a></li>
<li><a href="../151187/index.html">Details on random and pseudorandom number generators</a></li>
<li><a href="../151189/index.html">Miniature technology on the iPhone-control</a></li>
<li><a href="../151190/index.html">If Xerox PARC invented the PC, then Google invented the Internet.</a></li>
<li><a href="../151191/index.html">IBM Augmented Reality Will Change Shopping</a></li>
<li><a href="../151193/index.html">Course lectures "Startup". Peter Thiel. Stanford 2012. Activity 1</a></li>
<li><a href="../151195/index.html">Launch of Delphi XE3 and RAD Studio XE3 in St. Petersburg, Moscow and Online</a></li>
<li><a href="../151196/index.html">An inexpensive alternative to the Arduino. Give a chance?</a></li>
<li><a href="../151197/index.html">Improving the subjective speed of the site with the help of browser prompts</a></li>
<li><a href="../151198/index.html">Steam on your TV</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>