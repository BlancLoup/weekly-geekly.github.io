<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Recovering LSI RAID Controller firmware</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day, habravchane! 

 I want to tell you about how I restored the firmware of the LSI MegaRAID RAID controller after an unsuccessful update. 
 Whe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Recovering LSI RAID Controller firmware</h1><div class="post__text post__text-html js-mediator-article">  Good day, habravchane! <br><br>  I want to tell you about how I restored the firmware of the LSI MegaRAID RAID controller after an unsuccessful update. <br>  When this trouble happened to me, I practically did not find any information about this, although I admit that I did not google it well. <br><br><h4>  Anamnesis </h4><br>  In my work, I have been using Supermicro servers for quite a long time, since they have a large selection of platforms, a fairly affordable price and decent reliability. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Often, especially in the case of 1U servers, I take them already with the integrated LSI MegaRAID controller. <br><br>  But the problem with them is that Supermicro itself is not very willing to post firmware for embedded controllers, so I usually flash them with the latest firmware (oil, yes) from a similar LSI controller.  There were no problems until now. <br><br>  Recently we brought several servers with LSI 2208 controllers on board and fairly old firmware. <br>  Since  I also actively use the discrete controllers on these chips, then, without any hesitation, I booted from a USB flash drive with Linux and launched the usual one: <br><pre><code class="bash hljs">./MegaCli64 -AdpFwFlash -f mr2208.rom -a0</code> </pre>  and went on to do more business. <br><br>  The next time I looked at the server terminal, I saw the same picture as it was - <i>‚ÄúFlashing firmware ...‚Äù</i> and no result.  Trouble, thought Stirlitz. <br><a name="habracut"></a><br>  Logging into the server via SSH failed, looking at the VGA console saw messages that the root file system went into <b>Read Only</b> mode and everything is very bad, and at any moment it will be even worse. <br><br>  I do a reset and see this picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/642/942/d7f/642942d7fba2d9f866429ba3e2ce3347.jpg" alt="image"><br><br>  Yes, trouble.  Searches on the Internet did not lead to any result.  Apparently, the problem is quite rare. <br><br><h4>  Treatment </h4><br>  I tried to boot from the flash drive and flash the controller again, but the MegaCli utility did not detect it at all under DOS or Linux.  Respectively, too, refused to flash. <br><br>  So I turned to LSI support, where a kind person with a Hindu name pointed me to the MegaRAID documentation, namely to page 305, where there is such a rather subtle section that doesn‚Äôt really explain why it does what it says: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1e5/c1c/fbb/1e5c1cfbbeed04c253b78705c22dbfad.jpg" alt="image"><br><br>  Yeah, the partisans thought, probably this is the firmware in recovery mode, and got down to business. <br><br>  Under Windows, a flash drive with FreeDOS is easiest to use using the <a href="http://rufus.akeo.ie/">Rufus</a> utility, just a click away. <br>  Under Linux, you can do the same with improvised tools (using syslinux or GRUB), there are many articles on this topic. <br><br>  Fill it with MegaCli.exe and <a href="">firmware</a> found in the <a href="">ftp.supermicro.com</a> open spaces. <br><br>  Load, run: <br><pre> <code class="bash hljs">MegaCli.exe -AdpM0Flash -f smc2208.rom</code> </pre><br>  I draw your attention to the fact that you do not need to specify an adapter (option -a), apparently it is flashing everything it finds, or the first one found on the PCI bus. <br><br>  The matter went: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/479/5c4/0e7/4795c40e7e9b6e45b623ff814fc82c44.jpg" alt="image"><br><br>  The firmware in this mode takes quite a long time, about 15 minutes, so be patient. <br><br>  When he finishes, turn off the power server, turn it back on and wait for the miracle. <br>  But instead of a miracle, we see such a bleak picture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/2df/7a0/7cc/2df7a07cc3cb0e91b32c087ad3b39947.jpg" alt="image"><br><br>  Googling such an error leads to a single link to our compatriot's <a href="http://www.aos.name/2010/09/07/fw-is-in-fault-state-perc-solution/">blog</a> , where he advises you to disconnect the BBU from the controller in pure English, remove the controller from the server and then put it back. <br><br>  In my case, you can only remove the card from the server with a jigsaw, I don‚Äôt have a BBU, so it‚Äôs not an option. <br>  I try to flash in the standard way, MegaCli detects the controller, but says the same thing, saying <b>F / W is in fault state</b> , so I won‚Äôt do anything. <br><br>  We appeal again to the support, which throws up his hands and advises to try the <a href="http://mycusthelp.info/LSI/_cs/AnswerDetail.aspx%3F%26inc%3D8278">LSI Pre-Boot USB and CD tool</a> , and if it does not help, then take the iron back. <br><br>  Ok, download the ISO, connect it via IPMI to the server and load. <br>  We select the <b>recovmr</b> item in the boot menu, then we are prompted to write <b>recover</b> in the command line and happiness will come.  But it did not come. <br>  The BAT file cannot find the connected <b>D:</b> drive, apparently the CD-ROM driver in FreeDOS on this LSI image is not friendly with the IPMI virtual drive. <br><br>  Well, look into the BAT file and see what he was going to do there: <br><pre> <code class="bash hljs">MegaCli.exe -AdpFwFlash -f D:\FW\RECOVER\TB_16MB.ROM -aALL</code> </pre><br>  Open the ISO, look for this mysterious file and see that it is already 16 megabytes in size (yes, we already guessed from the name) that it is twice the size of the standard firmware.  Apparently, this ROM image completely rewrites the Flash chip on the controller. <br><br>  We are trying to flash it the same way as the BAT nick was going to do, but we get the familiar: <b>F / W is in fault state</b> <br>  Yes, so-so Recovery image has prepared us LSI. <br>  Okay, we use our previous experience and try to flash this file through Mode0. <br><br>  This time, the firmware took about 30 minutes, since the file is twice as long as usual.  After the firmware, we de-energize the server, turn it back on and see the coveted screen: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/10d/ee4/ed3/10dee4ed3a2726eb464d2e092803aa34.jpg" alt="image"><br><br>  <b>Salute, champagne, server saved!</b> <br><br>  But this vivifying image does not contain the latest version of the firmware, so I, with a light heart, booted again from the FreeDOS flash drive and went to flash it with the latest Supermicro firmware ... and again I got stuck at the same stage as at the very beginning: <br><img src="https://habrastorage.org/getpro/habr/post_images/025/e0d/e9b/025e0de9bc450348194211e50d809464.jpg" alt="image"><br><br>  The circle is closed.  I even for loyalty left him in this form for the night, but nothing has changed. <br>  After the reboot, we have again the beaten firmware. <br><br>  By trial and error, it was found that after flashing the recovery image, you need to reset to factory settings: <br><pre> <code class="bash hljs">MegaCli.exe -AdpFacDefSet -a0</code> </pre><br>  and turn off-turn on the server. <br><br>  After that, it is already stitched without a hang, and we see the latest firmware version: <br><img src="https://habrastorage.org/getpro/habr/post_images/a67/328/d84/a67328d847b438289910c1439855322c.jpg" alt="image"><br><br>  Everything, this time it turned out to be a 100% victory over the recalcitrant gland! <br><br><h4>  Statement </h4><br>  The moral of this story is this: if you don‚Äôt want to spend a couple of days restoring or even more to return the equipment, then it‚Äôs better still to flash the firmwares intended by the iron manufacturer (if he uploads them, I found it at the Supermicro just by digging through the wilds of FTP - on There is no reference to the server or motherboard page), or do not touch anything and live with the one that already exists. <br>  Although I‚Äôm not sure that the problem was caused by the ‚Äúforeign‚Äù firmware, and not by some random glitch, I don‚Äôt want to check it again. <br><br>  There are also cases when the firmware simply for some reason deteriorates (the electricity was turned off during the firmware or some other gamma-ray burst occurred in near space), and then you have to resort to disaster recovery. <br><br>  I hope that this article will help those who stumble upon a similar problem in the future. </div><p>Source: <a href="https://habr.com/ru/post/209348/">https://habr.com/ru/post/209348/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../209330/index.html">Microsoft extended support for MSE Windows XP</a></li>
<li><a href="../209332/index.html">Audi Free Parking Prediction System</a></li>
<li><a href="../209336/index.html">The main thing is trust</a></li>
<li><a href="../209342/index.html">Role-playing technology. Part 1. Technology and magic</a></li>
<li><a href="../209346/index.html">How I tested the IDE of the company "Multiklet"</a></li>
<li><a href="../209350/index.html">Components by TJHolowaychuk</a></li>
<li><a href="../209352/index.html">Scaling is simple. Part Two - Caching</a></li>
<li><a href="../209354/index.html">Components. Example</a></li>
<li><a href="../209356/index.html">How to force the process to use the new DNS server address from the updated resolv.conf without restarting the process itself</a></li>
<li><a href="../209360/index.html">Video recordings of reports on the stream ‚ÄúJavaScript on backend‚Äù of the FOSS Sea conference</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>