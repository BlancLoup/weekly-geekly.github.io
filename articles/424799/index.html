<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Two-way analytics of partner iframe widget using Google Tag Manager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Widgets today are an integral part of many large portals, because they allow the use of complex partner development avoiding long implementation proce...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Two-way analytics of partner iframe widget using Google Tag Manager</h1><div class="post__text post__text-html js-mediator-article">  Widgets today are an integral part of many large portals, because they allow the use of complex partner development avoiding long implementation procedures.  The web analytics of widgets are interesting for all parties, but in the case of iFrame there are difficulties in transferring 100% of the data to the participants of the partnership.  What are the difficulties and how we managed to get around them, I would like to tell in this article.  First of all, it will be of interest to everyone who develops and implements widgets on iFrame, as well as to attracted analysts. <br><a name="habracut"></a><br>  For a start, a little background.  We are developing both our own solutions for automation in the field of passenger transportation and products for use on partner sites.  One of them was the project of automated booking of VIP and business lounges at airports in the world and Russia, aimed at meeting the needs of business and premium customers of various airlines.  A single database of thematic services at various airports is primarily interesting for companies associated with passenger air travel, online travel agencies, as well as travel companies with sites on the Internet.  For such companies, a ‚ÄúVIP-room‚Äù widget was created, allowing users of any partner site to access this database. <br><br>  The widget is installed in a standard way via iFrame, the partner only needs to place the code on his website and adjust the appearance parameters according to the general design concept.  As a result, the site contains a module for selecting and booking VIP lounges at the airport of interest with access to premium airport services, such as a shuttle (individual transfer from the lounge to the plane), meeting in the hall with a sign, escorting the employee and parking access for VIP- customers.  The booking process is carried out in a few simple steps within which the user can vary the contents of the order (Fig. 1). <br><br><img src="https://i.imgur.com/hGuf48V.gif" alt="image"><br>  <i>Figure 1 - The appearance of the widget on the site</i> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Given the variability of filling data, of course, the question arises of tracking this process from the point of view of analytics.  Moreover, web analysis is interesting both for <b>the</b> widget's <b>owner</b> and his <b>partner</b> , who establishes it, therefore, during the development, the task of tracking events inside the widget and transmitting them simultaneously in two directions appeared: <br><br>  A. From all sites on which the widget is installed, to the web analytics of the owner (developer). <br>  B. From the site where the specific widget is installed, to the partner‚Äôs web analytics. <br><br>  <b>What is the difficulty here?</b>  Basically, the partner takes a single widget code that is not configured for a specific partner site, but at the same time wants to see information in the analytics only on its own widget.  The second difficulty lies in the fact that the widget developer (owner) must receive data from all partner sites at once in one counter, which runs counter to the partner‚Äôs desire to see only his own information.  In the end, you just need to distinguish between the data that the partner should see and which the owner will see.  The task was solved with the help of <b>Google Tag Manager</b> (hereinafter - GTM). <br><br>  This tool is widely used for web analytics and tag management on websites; it does not make sense to describe in detail the principle of its operation, for understanding it is enough to familiarize yourself with the concept of GTM <a href="https://habr.com/search/%3Fq%3Dgoogle%2Btag%2Bmanager">from other articles</a> .  In this case, it is important to understand that Google Tag Manager (Fig. 2) allows you to consolidate data from the site inside your own containers and distribute it to various web analytics counters using the specified rules. <br><br><img src="https://i.imgur.com/SnMpud3.gif" alt="image"><br>  <i>Figure 2 - Google Tag Manager ‚ÄúTags‚Äù window with already configured tags for the widget</i> <br><br>  To begin with, we will describe the algorithm itself for solving this problem, in order to immediately understand how we moved to achieve the result.  So: <br><br><ol><li>  A partner, like the owner, wants to track the widget's work in one of two ways, or two at once - using Yandex.Metrics or Google Analytics. </li><li>  A satisfying solution should transfer data to 4 counters: Owner‚Äôs Metrics counter, owner‚Äôs Google Analytics counter, Partner‚Äôs Metrics counter and Partner‚Äôs Google Analytics counter. </li><li>  Inside the widget, a single Google Tag Manager container is installed that will collect all the data and distribute it in such a way that each participant receives only the information he needs. </li><li>  The IDs of the owner counters are set by default, the partner IDs must be specified by him at the time of generating the widget code in the partner room for further installation on the site. </li><li>  Since a partner account has already been set up for the partner, identifiers can be set in it and forwarded inside the widget so that Tag Manager uses them. </li><li>  Inside GTM, the substitution of identifiers into the trigger codes of target events occurs, as well as the distribution of data transmission over the owner and partner counters. </li><li>  At the same time, GTM sends all collected data to the owner‚Äôs counters, and the data on the partner‚Äôs site - only to the partner‚Äôs counters, since  during the substitution of identifiers, only the site specified by the partner is tracked. </li></ol><br>  For convenience of understanding, we present a flowchart of the process (Fig. 3) <br><br><img src="https://i.imgur.com/chOfcFZ.jpg" alt="image"><br>  <i>Figure 3 - Diagram of the data transfer process</i> <br><br>  To begin with, we will determine that, in addition to the Google Tag Manager code, the site also contains automatically generated counter codes Yandex.Metrics and Google Analytics.  When generating code for the site, counter identifiers given by the partner are forwarded to them. <br><br>  These codes in the widget can not be set, because the possibilities of GTM allow you to automatically generate them on the site as the corresponding tags (type - Custom HTML - Fig.4), but in this case hard writing to the widget code was necessary - some events on the site require so that the counter is immediately installed inside the widget.  Basically, these are boot events, preroll appearances.  If you do not have such events, then you can generate a counter code via GTM: <br><br><img src="https://i.imgur.com/OlldDXp.gif" alt="image"><br>  <i>Figure 4 - Example of the transfer of the Metrics code to the site via GTM</i> <br><br>  To transfer data at once to two counters (partner and owner), you need to install not two different Metrics or Analytics codes, but create a <b>special dual code</b> .  At the time of writing, the correct codes look like this (Fig. 5): <br><br><img src="https://i.imgur.com/yf9ROGE.gif" alt="image"><br>  <i>Figure 5 - The correct use of dual codes Metrics and GA</i> <br><br>  Next you need to pass inside the counter code identifier specified by the partner.  The difficulty here is that the widget code is automatically generated for all sites, and the identifiers are already set in a separate partner room.  For the programmer to correctly pass the following solution was implemented: <br><br>  When the widget is initialized, an iFrame is created, and the counter identifiers of the partner are passed to the parameters (the counters are transferred to the src iFrame, and then they are sent to the widget from the location).  iFrame opens the widget's application and in the created widget's life cycle (SPA) hook, before mounting, the input parameters of the counter numbers are processed, and the numbers (identifiers) are stored in localStorage. <br><br>  The following construction is used to place the Google Analytics code in index.html: <br><br><pre><code class="javascript hljs">&lt;script&gt; <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.dataLayer = <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>.dataLayer || []; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gtag</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>) </span></span>{ dataLayer.push(<span class="hljs-built_in"><span class="hljs-built_in">arguments</span></span>); } gtag(<span class="hljs-string"><span class="hljs-string">'js'</span></span>, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">Date</span></span>()); gtag(<span class="hljs-string"><span class="hljs-string">'config'</span></span>, <span class="hljs-string"><span class="hljs-string">'UA-15930803-13'</span></span>); gtag(<span class="hljs-string"><span class="hljs-string">'config'</span></span>, <span class="hljs-built_in"><span class="hljs-built_in">window</span></span>[localStorage.getItem(<span class="hljs-string"><span class="hljs-string">'partnerGA'</span></span>)] || <span class="hljs-string"><span class="hljs-string">'UA-15930803-14'</span></span>); <span class="xml"><span class="hljs-tag"><span class="xml"><span class="hljs-tag">&lt;/</span></span><span class="hljs-name"><span class="xml"><span class="hljs-tag"><span class="hljs-name">script</span></span></span></span><span class="xml"><span class="hljs-tag">&gt;</span></span></span></span></code> </pre> <br>  Scripts with src variables are inserted dynamically when the counters are initialized: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">let</span></span> script = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createElement(<span class="hljs-string"><span class="hljs-string">'script'</span></span>) script.setAttribute(<span class="hljs-string"><span class="hljs-string">'src'</span></span>, <span class="hljs-string"><span class="hljs-string">`https://www.googletagmanager.com/gtag/js?id=</span><span class="hljs-subst"><span class="hljs-string"><span class="hljs-subst">${ga || </span></span><span class="hljs-string"><span class="hljs-string"><span class="hljs-subst"><span class="hljs-string">'UA-15930803-14'</span></span></span></span><span class="hljs-string"><span class="hljs-subst">}</span></span></span><span class="hljs-string">`</span></span>) <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head.insertBefore(script, <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.head.firstChild)</code> </pre> <br>  Here, UA-15930803-14 is a ‚Äúdummy‚Äù owner‚Äôs counter, which is used if the counter‚Äôs counter is not set by the partner.  This situation may occur if the partner did not specify the identifiers of the counters as a whole or only one identifier was specified - there must always be a substitute code so that the site does not have JavaScript errors related to the absence of an identifier for the correct transmission of the event.  UA-15930803-13 in this case - the main identifier of the Owner, in which data comes in any case from any site. <br><br>  Similarly to GA, the Yandex.Metrica code is generated, which uses the specified owner metric identifier, the replacement owner default identifier of the counter and the construct for transmitting the partner identifier.  The code is formed according to the scheme shown in Figure 5 using the constructions from the example above. <br><br>  Following the counter codes, you need to forward the identifiers given by the partner inside Google Tag Manager.  Inside the container, they will already be used as internal variables, whose values ‚Äã‚Äãcan be supplied to the generated events. <br><br>  For GTM, the most commonly used method is a data level variable (dataLayer).  The data tier is a javascript variable whose initialization is described within the Google Tag Manager container automatically.  With the help of it, you can transmit both events of the type event occurring on the site, as well as set your own variables for GTM.  This is done using the design <br><br><pre> <code class="javascript hljs">dataLayer.push(<span class="hljs-string"><span class="hljs-string">'_'</span></span>: <span class="hljs-string"><span class="hljs-string">'_'</span></span>);</code> </pre> <br>  Triggered after the announcement of the GTM code on the site.  However, in our case, the data level variable did not work, it is possible that the complexity of working with an iframe is the case.  If we set the push () construction automatically, then the container does not receive variables, and in this case, we wanted just such an implementation of the task.  If you try to set a data level variable manually (for example, for any click on the site), the variable is passed normally. <br><br>  In order not to waste time on the analysis of the process, we used an alternative solution - the creation of global JavaScript variables via <b>localStorage</b> . <br><br>  The localStorage property allows you to store variables with the specified values ‚Äã‚Äãwithout being tied to an open page of the site, and the data inside this storage cannot be simply deleted.  Accordingly, the identifiers of the partner counters were forwarded using the following constructs: <br><br><pre> <code class="javascript hljs">localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'partnerMetrika1'</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>); localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'partnerMetrika2'</span></span>, <span class="hljs-string"><span class="hljs-string">'yaCounter'</span></span>); localStorage.setItem(<span class="hljs-string"><span class="hljs-string">'partnerGA'</span></span>, <span class="hljs-string"><span class="hljs-string">'UA--'</span></span>);</code> </pre> <br>  Here, the first construction passes the partner Metric number itself, the second construction passes the collective value of yaCounter for the convenience of creating the ‚ÄúEvent‚Äù tag in Google Tag Manager (more on this later), and the third - the Google Analytics ID. <br><br>  This completes the transfer of data and the configuration of the GTM itself comes into play. <br><br>  First, we‚Äôll decide on how Google Tag Manager works.  It presents 3 levels of interaction: <br><br>  <b>Tag</b>  This is a piece of code that can be placed on a site with GTM installed and can be executed like any other code, changing the content of the site or transferring data to web analytics counters. <br><br>  The tag is triggered if some condition is met on the site. <br><br>  <b>Trigger</b>  This is the actual condition, the fulfillment of which triggers the tag.  This can be an event on the site, a change in the value of variables or a standard action ‚Äî for example, a click or a page view. <br><br>  <b>Variable</b>  It contains some values ‚Äã‚Äãthat can be passed in various ways, and is used as a data provider for tags or a condition marker. <br><br>  The content of variables entails triggering the trigger, and the trigger in turn calls the corresponding tag.  The identifiers of the partner counters are defined precisely as variables; it is worth starting with the formation of data in the GTM container. <br><br>  We created three main variables of the type ‚ÄúOwn JavaScript code‚Äù (Fig.6): <br><br><img src="https://i.imgur.com/qWZwXhw.gif" alt="image"><br>  <i>Figure 6 - Example of a variable that takes a partner Metric identifier</i> <br><br>  Here the value of the variable is the value we took from localStorage. <br><br>  Now, if GTM accesses a variable, then its value will be obtained - the identifier of the partner Metric.  In the same way, we created variables under the number of the partner Metric and the identifier of the partner Google Analytics. <br><br>  What are these variables used for?  They solve the problem of sending data on the triggering of events on the site to partner counters.  Google Tag Manager has a standard procedure for transferring goals to Google Analytics, where you can use the value of a variable as a counter identifier.  And for Metrics, a tag is used in the form of custom HTML code containing standard JavaScript Metrics: <br><br><pre> <code class="javascript hljs">yaCounterXXXXXX.reachGoal(<span class="hljs-string"><span class="hljs-string">'TARGET_NAME'</span></span>);</code> </pre> <br>  Here TARGET_NAME is the internal name of the target event for the Metric (such goals are created in the counter settings using the ‚ÄúJavaScript event‚Äù type), and  is the counter number. <br><br>  Thus, we create corresponding tags for different types of counters. <br><br>  <b>For Google Analytics:</b> <br><br>  The tag type is ‚ÄúUniversal Analytics‚Äù, the tracking ID is from our variable. <br><br><img src="https://i.imgur.com/WssMHHk.gif" alt="image"><br>  <i>Figure 7 - An example of setting up a tag that transfers data to Google Analytics.</i> <br><br>  Here, Category and Action are the values ‚Äã‚Äãthat Google Analytics should capture as its goal response parameters.  Tracking ID is a previously defined variable that takes the partner ID from localStorage. <br><br>  <b>For Yandex.Metrics:</b> <br><br>  The tag type is ‚ÄúCustom HTML‚Äù using JavaScript constructs. <br><br><img src="https://i.imgur.com/vhg9L0m.gif" alt="image"><br>  <i>Figure 8 - An example of setting up a tag that sends data to Yandex.Metrica</i> <br><br>  Here {{PartnerMetrikaCounter}} is the internal declaration of a variable that takes the ID of the partner Metric from localStorage.  Using the window object, we substitute the value of the variable into the executable code, and at the output we get yaCounterXXXXXXXX.reachGoal ('widget_loading'); where widget_loading is the value that the Metric catches as a trigger parameter. <br><br>  It only remains to set the triggers to trigger the corresponding tags.  Triggers in our case were, for example: <br><br><ul><li>  The events of the successful loading of the widget; </li><li>  Events of successful or unsuccessful passage of a step on the widget; </li><li>  Filling in certain fields; </li><li>  The choice of conditions A or B inside the widget; </li><li>  Interaction with forms, buttons and links. </li></ul><br>  Further, in the settings of the Metrics and Google Analytics counters, it remains only to create the corresponding goals: <br><br><img src="https://i.imgur.com/Tj70YS0.gif" alt="image"><br>  <i>Figure 9 - An example of setting goals in Yandex. Metric</i> <br><br><img src="https://i.imgur.com/HstDw1o.gif" alt="image"><br>  <i>Figure 10 - An example of setting goals in Google Analytics</i> <br><br>  Problem solved.  Dual counter codes substitute the values ‚Äã‚Äãspecified for them into the Metrics and Partner Analytics identifiers, while the values ‚Äã‚Äãof the owner identifiers remain unchanged.  At the same time, the Google Tag Manager only sends the corresponding targets to the partner‚Äôs counters if it receives from the variables exactly the identifiers that were set by a specific partner on its website.  In parallel with this, GTM sends to the owner all target events from all sites. <br><br>  If the partner did not specify one or both identifiers, then the default values ‚Äã‚Äãare used - the identifiers of test counters specified by the owner in advance. </div><p>Source: <a href="https://habr.com/ru/post/424799/">https://habr.com/ru/post/424799/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../424787/index.html">Interview with Aaron Patterson, speaker of the RubyRussia 2018 conference</a></li>
<li><a href="../424789/index.html">How to deploy a Ruby on Rails application with HAProxy Ingress, unicorn / puma, and web sockets</a></li>
<li><a href="../424791/index.html">Expansion of network capabilities of a programmable relay using WI-FI</a></li>
<li><a href="../424793/index.html">How to print an electric motor</a></li>
<li><a href="../424795/index.html">How big can a solar-powered drone be?</a></li>
<li><a href="../424801/index.html">Zeppelin OS - another step towards secure smart contracts</a></li>
<li><a href="../424803/index.html">Taiwan hacker was going to crack Mark Zuckerberg's Facebook page online, but later abandoned his threats</a></li>
<li><a href="../424805/index.html">As I graduated from LaTeX with GitHub, Docker and TravisCI</a></li>
<li><a href="../424807/index.html">EOIP between DD-WRT and Keenetic Giga 2 to merge two apartments into one network or one HDD into two apartments</a></li>
<li><a href="../424809/index.html">DNA Mechanisms for storing and processing information. Part I</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>