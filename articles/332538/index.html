<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>WI-FI in the subway: network architecture and underground stones</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In just a couple of years, the Muscovite‚Äôs trip in the metro has ceased to be a daily routine. Earlier, the only entertainment in the subway was readi...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>WI-FI in the subway: network architecture and underground stones</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/web/4c0/158/5e9/4c01585e948648c0a164b235514e70ea.png"><br>  In just a couple of years, the Muscovite‚Äôs trip in the metro has ceased to be a daily routine.  Earlier, the only entertainment in the subway was reading books, the press and an MP3 player, now they have been added to online shopping, watching TV shows, business correspondence, even acquaintances in Tinder and quests.  And all thanks to the appearance of a free Wi-Fi network in the metro.  About <a href="http://tass.ru/moskva/3268993">80% of</a> Muscovites regularly connect to the MT_FREE network in the metro, without thinking about how it works and with what forces it is done.  There is an opinion that Wi-Fi in the metro was ‚Äúheld‚Äù by the metro itself, but this is not quite true.  A wireless network is a MaximTelecom project.  For the company, this was the first experience of building a high-speed Wi-Fi network with engineering and technical solutions that are unique in world practice.  In this post, we will describe how a Wi-Fi network is organized in the Moscow metro. <br><br><a name="habracut"></a><h2>  <b>We actually have two networks ...</b> </h2><br>  <b>Radio network inside the cars</b> <br><br>  You enter the car, you see a sticker with the name of the network, or, out of habit, you turn on Wi-Fi on your phone.  At the same time, the device connects to the network with the SSID MT_FREE.  It is organized by high-density access points that are located in each car, operate in two 2.4 GHz and 5 GHz bands and support the 802.11a / b / g / n standards.  They are controlled by the controller in the head car.  As part of these cars, two, and therefore the controller, too, two.  All equipment in the rolling stock, including between cars, connect cables - twisted pair. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <div class="spoiler">  <b class="spoiler_title">The matter of technology</b> <div class="spoiler_text">  <i>For the organization of the Wi-Fi network and the network infrastructure in the rolling stock, we used Cisco equipment: in particular, air-cap2602i access points, air-ct2504 controllers, 29 series switches and 8- series routers.</i>  <i>To improve resiliency between the cars, we have laid two cable routes.</i>  <i>If you delve into the network architecture, Layer2 for user traffic is terminated on the router in the rolling stock, and NAT (network address translation) is performed on the border routers of the network in the same way as it is organized with most wired access operators.</i> </div></div><br>  <b>Radio network train tunnel</b> <br><br>  After passing through the internal train network, data is transmitted to the fixed network infrastructure using a train-tunnel radio channel.  It is installed between the base station located in each head car and the base stations located along the route of the rolling stock in the tunnel, as well as in open sections of the track.  The location of base stations along the tracks is such that the train moves in a solid radio field.  Due to this, communication breaks are minimal.  Base stations on the train are located in the same way as the access point controllers on each head car, while only one of the stations is active during the movement of the train.  The radio channel works in the same frequency range as Wi-Fi - 5 GHz, but uses a proprietary data transfer protocol.  Unlike the equipment inside the train, the equipment of the radio channel train-tunnel can be seen outside the rolling stock and in the tunnels / on the open sections of the track. <br><br><div class="spoiler">  <b class="spoiler_title">The matter of technology</b> <div class="spoiler_text">  <i>For the organization of the communication channel, equipment of Radwin 5000 series is used. It uses Wi-Fi chips conforming to the 802.11n standard, and the data is transmitted via a proprietary protocol based on TDM (Time Division Multiplexing), which is formed by an additional microchip.</i>  <i>Base stations are synchronized using a protocol similar to PTP 1588v2.</i> <i><br><br></i>  <i>The permitted frequency spectrum 5150 - 5350 MHz is divided into five non-overlapping channels of 40 MHz each.</i>  <i>Each line uses all five channels, usually in a sequence of 1-3-5-2-4, in order to maximally avoid the influence of interference when neighboring devices operate in the same frequency range.</i> </div></div><br><h2>  <i><b>Network architecture</b></i> </h2><br><img src="https://habrastorage.org/web/641/9c0/cc4/6419c0cc425f4489890e7f5da6a04d9a.jpg"><br><br>  Each base station on the train‚Äôs route is connected to the switching nodes located in the metro office premises using a dedicated fiber-optic network.  Uninterrupted power supply of base stations is also organized with the help of equipment installed in these switching nodes. <br><br>  The architecture of the fixed data network does not differ from the typical architecture of telecom operators.  This is a ‚Äúdouble star‚Äù with geographic redundancy of communication channels and key equipment.  The network has several communication channels with backbone operators, with a total bandwidth of more than 60 Gbit / s. <br><br><div class="spoiler">  <b class="spoiler_title">The matter of technology</b> <div class="spoiler_text">  <i>Network equipment at the access level (switches that directly include base stations), aggregation, and the core are represented by switches and Cisco routers.</i> <i><br><br></i>  <i>Base stations are connected to switches using WDM technology to save fibers (that is, one fiber at different wavelengths simultaneously receives and transmits data).</i>  <i>Access switches have two uplinks with geo-redundancy (fiber optic cables are physically located in different tunnels) into aggregation switches of 1 Gbit / s each.</i>  <i>Those, in turn, are connected via geo-reserved links to the core switches, but already with 10 Gbit / s interfaces.</i> </div></div><br><h2>  <b>Houston, we have problems ...</b> </h2><br>  <i><b>Technological complexity</b></i> <br><br>  To work in the underground you need equipment: <br><br><ul><li>  can withstand harsh operating conditions in the tunnel (suspended metal dust and engine oil) and on rolling stock (extreme temperatures and vibrations); </li><li>  met the requirements of the metro (use non-combustible materials, comply with the requirements for electromagnetic compatibility, work from non-standard power sources); </li><li>  having the necessary network functionality. </li></ul><br>  In the metro in the rolling stock used direct current with a rated voltage of 80V.  However, depending on the state of the batteries and the number of breaks in the contact rail, the <b>actual voltage ‚Äújumps‚Äù from 30V to 150V</b> . <br><br>  We did not manage to find an acceptable power supply unit with such parameters, and the cost of suitable options made the project impractical. <br><br>  Here, Sibcontact, a company from Novosibirsk, really helped us out.  Under our requirements, colleagues made a power supply, which we successfully tested and later used in all compositions.  The devices turned out to be very reliable, they were inexpensive, and the supplier managed to produce the required amount in a few weeks, not months, as it usually happens. <br><br>  We also encountered <b>a non-standard power supply in the tunnel</b> - a two-phase network with a voltage of 127V.  It is impossible to power the equipment operating from a single-phase 220V network from it, and we pulled new cables from our own power sources installed in the technical premises of the stations.  This increased the reliability of the network, as we applied uninterruptible power supplies and automatic input reserve. <br><br><img src="https://habrastorage.org/web/716/c97/9a7/716c979a7be94b9a98943d27350196c3.jpg"><br><br>  The <b>variety of types of trains</b> also caused great difficulties.  This influenced the work on the design of equipment placement of local networks of trains - it was enormous.  Secondly, during the construction it turned out that almost all the compositions, even of one series and year of manufacture, are different.  This is due to the fact that they are constantly upgraded and installed additional equipment.  Such work was carried out separately for each train, and each time we equipped the train in a unique way. <br><br>  Serious questions have arisen in the radio network planning.  They were associated with both the variety of materials from which the <b>tunnels</b> were made, and the lack of basic information on their design, geometry, as well as branches and obstacles. <br><br>  We ourselves completely surveyed all the tunnels - in the Moscow metro there are more than 330 km of them, and in double-track terms more than 660 km.  We applied certain metrics and rules for the placement of base stations, and after installing and launching the equipment during operation, we measured radio coverage and refined the optimal equipment placement points.  Some base stations we had to move after installation. <br><br>  These difficulties forced us, together with colleagues from the Nizhny Novgorod company Radio Gigabit, to conduct research and develop a unique radio planning method in tunnels, which is based on simulation (mathematical modeling) of the channel and system level of the radio network in tunnels and in open areas.  In new projects, we are no longer guessing, but we know exactly how to arrange the equipment for obtaining the specified channel characteristics. <br><br>  <i><b>Architectural complexity</b></i> <br><br>  The main equipment forming the radio channel between the train and the tunnel is located in the ‚Äúhead‚Äù (remember that there are two of them), while the cars are constantly changing when arriving at the depot in rolling stock.  The network operates in constant motion, as a result of which the network ports and physical devices, through which the traffic of the same sessions from the same composition, changes all the time.  In this regard, we solved a number of architectural problems: <br><br><ul><li>  fully automatic configuration of the train network when changing or changing the order of cars </li><li>  distribution of intra-car access points between two W-Fi controllers in the train </li><li>  correct receipt by users and equipment as part of IP addresses </li><li>  ‚ÄúExit‚Äù of user traffic through the correct base station currently active </li><li>  skipping MAC addresses from one port of a fixed switch to another when a train is moving (this does not happen or happens very rarely on a fixed network), requiring constant ‚Äúretraining‚Äù of network ports at the MAC level </li></ul><br>  A separate problem was the monitoring of our network.  Conventional network equipment monitoring systems are unable to distinguish the situation in which the composition leaves the radio coverage area from the equipment failure of the composition.  This leads to a large number of false alarms of the fault warning system.  In addition, the unit of monitoring and maintenance is the train (since you always need to understand where a particular piece of equipment is located at the moment and how it is connected to other network elements), but in practice metro trains are dynamic, the composition of cars in which can be changed daily, or even twice a day.  We have created our own monitoring tools that automatically detect the appearance of a train in the coverage area, ‚Äúbypass‚Äù it, determining the composition and order of the cars and equipment installed in them and provide the network control center operators with data already in terms of the actual trains on the line. <br><br>  These are the key technical tasks that MaksimaTelecom solved when planning and creating a network.  Moreover, this process continues to this day, as the load on the network grows and new metro stations appear.  Many of the lessons learned during the Moscow project, we applied in the construction of a Wi-Fi network in the St. Petersburg metro, thanks to which we managed to make it much more productive and fast.  But we will tell about it in the following posts. <br><br><img src="https://habrastorage.org/web/e6b/27b/233/e6b27b233b9f47c8ab2f461edf941535.jpg"><br><br><div class="spoiler">  <b class="spoiler_title">And we have open vacancies.</b> <div class="spoiler_text">  Watch them <a href="https://habrahabr.ru/company/maximatelecom/vacancies/">here</a> </div></div></div><p>Source: <a href="https://habr.com/ru/post/332538/">https://habr.com/ru/post/332538/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../332528/index.html">AWS EC2 Apache CloudStack-style public cloud using KVM hypervisor and NFS storage</a></li>
<li><a href="../332530/index.html">How to escape from reading tutorials on programming</a></li>
<li><a href="../332532/index.html">Day of the sysadmin: light on the quest, spin the eggplant</a></li>
<li><a href="../332534/index.html">Annealing and freezing: two fresh ideas on how to accelerate the learning of deep networks.</a></li>
<li><a href="../332536/index.html">Making money from rain or drought. The Weather Company Experience</a></li>
<li><a href="../332540/index.html">5 fresh examples of parsing and improving the design in simple ways</a></li>
<li><a href="../332542/index.html">Meanwhile, Proxmox VE has been updated to version 5.0.</a></li>
<li><a href="../332544/index.html">Using timeout & strace utilities to monitor user inactivity to break a Shellinabox connection</a></li>
<li><a href="../332546/index.html">Announcement of Moscow Spark # 2</a></li>
<li><a href="../332548/index.html">Announcement Ruby Meetup # 6</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>