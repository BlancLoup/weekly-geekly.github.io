<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Windows 7: Developing energy-efficient applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="None of us likes it when the battery of a mobile phone or computer sits down on time. It's no secret that the new version of Windows 7, which has rece...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Windows 7: Developing energy-efficient applications</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/geektimes/post_images/844/1ec/24a/8441ec24a249cec3a8ff121f8671c877.png" alt="image"><br><br>  None of us likes it when the battery of a mobile phone or computer sits down on time.  It's no secret that the new version of Windows 7, which has recently become available for download by MSDN subscribers, allows you to create energy-efficient applications.  The article will allow Windows developers to learn new useful methods, techniques and tools that will help increase the operating time of mobile devices. <br><a name="habracut"></a><br>  <b>power usage</b> <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/fa6/8a5/097/fa68a5097cb1856ee9b345731300cbf5.jpg" alt="image">
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Let's first take a look at the trend of modern computing processors.  Researchers at Microsoft Research have analyzed many of the parameters of modern processors (the number of transistors, power, performance, etc.).  Special attention was paid to the power consumption of the processors.  Below is an overview of Intel processors over the past 20 years. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/0c3/e29/87b/0c3e2987bd48308edbff80cfa99cc096.png" alt="image"><br><br>  As we see, according to research by Microsoft Research, the amount of energy consumed by processors is growing rapidly.  The Intel 80386SX processor consumes almost no power, but it also does not have high performance.  If we look at the top processors of recent years with high performance, Core 2 Extreme QX6700 and others, then it becomes obvious how much energy these processors consume (about 100W).  This trend is observed not only in modern processors, but also in many other components of modern computers (GPU, Ethernet, etc.), which is becoming a serious problem. <br><br>  If you study the problem more deeply, the cause of high energy consumption is not only the components (Processor, GPU, Ethernet) and the operating system, but also additional software.  The Windows 7 development team compared the battery life of a computer with a clean installation and the pre-installation of OEM software manufacturers. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/6f2/f98/8ae/6f2f988aea767574744fa9e46d3d0962.png" alt="image"><br><br>  There is a large scatter of values, but in most cases a clean installation allows the computer to run on battery longer.  From here we can conclude that the applications we develop have a strong influence on the power consumption of our device.  Energy-efficient application will increase the operating time of a mobile device, such as a laptop, and reduce energy costs in the event of a server station. <br><br>  <b>Developments in the field of energy efficient solutions</b> <br><br>  Energy consumption is growing rapidly, which causes active development in this direction.  One of them is the concept of ‚ÄúBattery for the whole day‚Äù, which will allow you to use mobile devices for 6.9 hours or more.  Thus, today we are talking about the opportunities that we can use to increase the battery life of our mobile device.  Many OEM manufacturers are developing in the field of energy-efficient devices.  We can observe trends in optimizing solutions not only for mobile devices, but also for desktop and server stations.  Companies want to reduce the power consumption of their offices and data centers.  Today I wanted to talk about the methods of developing such energy-efficient applications and about the tools for diagnosing solutions that will help make these applications better. <br><br>  <b>Energy Efficient Application Development Scheme</b> <br><br>  1) Understand the causes of high power consumption <br><br>  2) Reduce the use of resources <br><br>  3) Pay attention to simple <br><br>  4) Adapt software for system environment <br><br>  5) Use the right tools and technology. <br><br>  6) Pay attention in the application to change the state of the OS (restart, shutdown, sleep, etc.) <br><br>  7) Check using diagnostic tools <br><br>  8) Repeat everything anew (back to step 2) <br><br>  <b>Pay attention to the simple</b> <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b7f/575/c9a/b7f575c9a16f10690939ac4df4d94aff.png" alt="image"><br><br>  When we talk about the battery life of a mobile device, it is important to pay attention to the type of work.  2 hours watching a DVD?  2 hours of office work or 2 hours of downtime?  In each case, the device consumes a different amount of energy.  But the important thing is that they are all associated with downtime.  In idle mode, the processor consumes a small amount of energy.  Therefore, the main task is the greatest reduction in energy consumption in the base layer ‚ÄúSimple‚Äù. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/6dc/496/78e/6dc49678e0686f62b31bb2178809bfba.png" alt="image"><br><br>  You can reduce energy consumption by performing some operations less often or by drawing fewer graphics.  A good example is the color scheme in Windows Vista.  When switching to the ‚ÄúPower saver‚Äù mode, Windows changes the color scheme to a simpler (non-transparent) one, allowing the computer to work a little longer.  Another example is how the team optimized DVD playback in Windows 7. The playback speed was reduced from 60fps to 30fps.  For the user, this change is not noticeable, but imagine how much less our system now consumes. <br><br>  Another method to reduce energy consumption is code optimization, which allows you to add extra battery life at each stage.  All these techniques are a tool to reduce the amount of energy consumed in the mode of the processor. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/57b/2a8/164/57b2a8164d9d5a366232ce6bf25a8679.png" alt="image"><br><br>  Another trick to reducing energy consumption is the method in which we try to do our work as quickly as possible, thereby falling into idle states for the maximum possible amount of time.  Those.  we try to be idle, as often as possible and as long as possible.  Sometimes it is more profitable to rise to a higher level of energy consumption, complete the task as quickly as possible and return to an idle state.  A good example is the processor power manager in Windows, which is very pulsating. <br><br>  <b>Optimization techniques</b> <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/706/dd7/38b/706dd738b48aad611b7fc3a3c57017d6.png" alt="image"><br><br>  If we look at modern mobile processors, we see that they have a large dynamic range of power consumption.  They consume almost nothing in idle mode; on the other hand, they eat up a large amount of energy with maximum productivity.  Therefore, it is very important to focus on the simple! <br><br>  <b>CPU usage</b> <br><br>  Exclude polls in your programs, use events!  In Vista and newer versions of the OS, there is a special API (RegisterPowerSettingNotification), built on events that allow you to track the power status of your device (See the code below).  In the example I am using the Windows API Code Pack for .Net Framework.  An example of a working application can be downloaded from the link at the end of the post. <br><br>  public partial class Window1: Window <br><br>  { <br><br>  public Window1 () <br><br>  { <br><br>  Initializecomponent (); <br><br>  PowerManager.PowerSourceChanged + = new EventHandler (PowerManager_PowerSourceChanged); <br><br>  } <br><br>  private void PowerManager_PowerSourceChanged (object sender, EventArgs e) <br><br>  { <br><br>  lab1.Content = PowerManager.PowerSource; <br><br>  } <br><br>  } <br><br>  If the survey in your program is still necessary, try to do it as rarely as possible.  I recommend that you take advantage of the new Unifying Programming Interface (Coalescing API), which allows you to increase downtime intervals. <br><br>  When the team developed Windows 7, it noticed that many system processes are periodic.  A good example is the processor power controller, which changes the voltage on the processor, thereby adjusting the processing power.  It changes the voltage of the processor based on the previous state, and for this it uses periodic polling. <br><br>  Once again, modern processors consume an incredibly small amount of energy in idle mode.  And our main task is to make the processor stay in this state as long as possible.  I want to draw your attention to the fact that the processor consumes additional energy to change the mode.  Therefore, it is possible that you will spend more energy on switching than save in idle mode.  In this regard, we need to be in idle mode, as long as possible. <br>  <b>Windows timer coalescing API</b> <br><br>  The idea of ‚Äã‚ÄãCoalescing API in combining repetitive activities.  The graph below shows an example of activities in the system (unrealistic data).  As we can see, the Windows graph is controlled by a periodic timer, which runs every 15.6 ms +.  In our system, there are periodic events on a timer, there are many of these events, and they are scattered randomly along the time axis.  The new API allows you to group them, providing a state of downtime for the longest possible period of time. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/b35/515/0f8/b355150f88f4dfead9fa2098766f8e7b.gif" alt="image"><br><br>  You can apply this feature in applications and services using the user-level function <b>SetWaitableTimerEx</b> .  However, I recommend using events.  If you cannot opt ‚Äã‚Äãout of periodic timers, the ‚ÄúWindows timer coalescing API‚Äù will help you do it most effectively. <br><br>  The prototype of the <b>SetWaitableTimerEx</b> function: <br><br>  Bool <br><br>  Winapi <br><br>  SetWaitableTimerEx ( <br><br>  __in HANDLE hTimer, <br><br>  __in const LARGE_INTEGER * lpDueTime, <br><br>  __in LONG lPeriod, <br><br>  __in_opt PTIMERAPCROUTINE pfnCompletionRoutine, <br><br>  __in_opt LPVOID lpArgToCompletionRoutine, <br><br>  __in_opt PREASON_CONTEXT WakeContext, <br><br>  __in ULONG <b>TolerableDelay</b> <br><br>  ); <br><br>  The <b>SetWaitableTimerEx</b> function <b>is</b> very similar to the <b>SetWaitableTimer</b> function, which is used to determine the period for which the timer should expire.  In many situations, you can simply replace the <b>SetWaitableTimer</b> function with <b>SetWaitableTimerEx</b> .  <b>SetWaitableTimerEx</b> has two new parameters: WakeContext and TolerableDelay.  The WakeContext parameter is used only if you want to set a timer that can take the system out of sleep.  The TolerableDelay parameter defines the permissible deviation from the specified time interval in ms. <br><br>  You must use a value not less than 32 ms (2 platform timer interrupt intervals) for the TolerableDelay parameter.  Optimally, when the tolerance value increases along with the interval value.  For example, if the period between interrupts is 1 second, then the appropriate deviation value will be 50 ms.  However, if the period length is 30 seconds, the deviation value must be at least 1,000 ms. <br><br>  <b>SetWaitableTimerEx</b> function requirements <b>table</b> . <br><br><table><tbody><tr><td>  Header </td><td>  Winbase.h </td></tr><tr><td>  Library </td><td>  Kernel32.lib </td></tr><tr><td>  Dll </td><td>  Kernel32.dll </td></tr><tr><td>  Supported OS </td><td>  Windows 7 or Windows Server 2008 R2 or newer </td></tr></tbody></table><br><br>  <b>Practice use</b> <br><br>  You should use the ‚ÄúWindows Timer Coalescing API‚Äù to optimize the power consumption of your applications and device drivers.  However, activity grouping cannot replace a reasonable use of resources.  First you need to try to limit the periodic activity in the application and try to use the event model. <br><br>  When you use the ‚ÄúWindows Timer Coalescing API‚Äù, note: <br><br>  ¬∑ The period between interruptions is not guaranteed.  However, it is always executed subject to error (TolerableDelay). <br><br>  ¬∑ Use the TolerableDelay parameter value of at least 32 ms, which corresponds to two interrupts of the platform timer, which occurs every 15.6 ms. <br><br>  ¬∑ Use as a value of the TolerableDelay parameter a multiple of 50, for example 50,100, 250, 500 ms, etc. <br><br>  [DllImport ("kernel32.dll")] <br><br>  static extern bool SetWaitableTimerEx (IntPtr hTimer, [In] ref long ft, int lPeriod, TimerCompleteDelegate pfnCompletionRoutine, IntPtr pArgToCompletionRoutine, bool fResume, REASON_CONTEXT wakeContext, ulong tolerableDelay); <br><br>  An example using this technology can be downloaded at the end of the post. <br><br>  <b>HDD</b> <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/34d/60a/c05/34d60ac054231f691e1693c36bd6ee9d.png" alt="image"><br><br>  Modern hard drives consume about 8% of the total energy consumption, and therefore it is very important to pay attention to all disk activity in your system.  As we can see on the graph, the most resource-intensive are read and write operations, to achieve which the disk needs to spin up and spend a lot of energy.  Use the hard disk only when it is really required, try to exclude all periodic disk activities. <br><br>  <b>State change</b> <br><br>  In Windows 7, the development team made a new API that allows them not only to maintain the state of the computer (an example of Media Center, which allows you to play videos for hours without going to sleep; for this, he constantly informs the system that he needs to be in working condition), but and report which application, and why it saves or changes the current state. <br><br>  /// Create a context <br><br>  var powerRequestContext = new POWER_REQUEST_CONTEXT (); <br><br>  powerRequestContext.Version = POWER_REQUEST_CONTEXT_VERSION; <br><br>  powerRequestContext.Flags = POWER_REQUEST_CONTEXT_SIMPLE_STRING; <br><br>  powerRequestContext.SimpleReasonString = "App is doing job"; <br><br>  /// Create a query <br><br>  IntPtr powerRequest = PowerCreateRequest (ref powerRequestContext); <br><br>  /// Install the request <br><br>  PowerSetRequest (powerRequest, PowerRequestType.PowerRequestSystemRequired); <br><br>  /// Perform work <br><br>  Console.WriteLine ("Press any key"); <br><br>  Console.ReadLine (); <br><br>  /// Clearing the query <br><br>  PowerClearRequest (powerRequest, PowerRequestType.PowerRequestSystemRequired); <br><br>  <b>Diagnostic tools</b> <br><br>  The Windows 7 development team has added new tools to diagnose your application in the new version of the OS.  One such utility is PowerCFG, which you can call from the console and get a small report on the current state of power consumption. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/cc1/bc5/013/cc1bc5013789cb4f4d9522a245edb45a.png" alt="image"><br><br>  Let's now see the resulting HTML. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/ebd/dd7/de9/ebddd7de9f17086b92734d9112178f06.png" alt="image"><br><br>  This document provides quick information and recommendations for optimizing the processes in the system. <br><br>  For more detailed analysis, you should use the <a href="http://www.microsoft.com/whdc/system/sysperf/perftools.mspx">Windows Performance Tools Kit (XPerf)</a> , which allows you to get a full range of data on all parameters and processes. <br><br><img src="https://habrastorage.org/getpro/geektimes/post_images/431/453/ce4/431453ce4ac2d41438bdf3b5e5fe6c43.png" alt="image"><br><br>  <b>Summary</b> <br><br>  Modern software has a huge impact on energy consumption.  Being as often as possible and longer in idle time, we can save a significant amount of energy.  I hope this short article will help you better understand the techniques and methods for optimizing your application in terms of energy consumption. <br><br>  <a href="http://code.msdn.microsoft.com/Project/Download/FileDownload.aspx%3FProjectName%3Dwin7poweraware%26DownloadId%3D7014">Download examples</a> <br><habracut></habracut></div><p>Source: <a href="https://habr.com/ru/post/68145/">https://habr.com/ru/post/68145/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../68136/index.html">Full review N 900</a></li>
<li><a href="../68139/index.html">Overview of mini-ITX for HTPC Chassis (Part 1)</a></li>
<li><a href="../68140/index.html">Fakebook mini</a></li>
<li><a href="../68141/index.html">Crush pasta with interest</a></li>
<li><a href="../68143/index.html">My monetization Twitter</a></li>
<li><a href="../68148/index.html">Rare features of nginx: random_index</a></li>
<li><a href="../68150/index.html">Data Extracting SDK: Part 1</a></li>
<li><a href="../68151/index.html">Be careful: rushing spam, designed for owners of mobile phones</a></li>
<li><a href="../68152/index.html">C # 4.0, and nonexistent methods</a></li>
<li><a href="../68153/index.html">Habr's re-design continues (user style "Inversion compact skin v1.1")</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>