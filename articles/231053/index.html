<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Start thinking</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Good day dear% username%! 
 I would like to congratulate all admins on this holiday, and in honor of this I wrote a post on me. By the nature of their...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Start thinking</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/e62/c79/490/e62c79490299d564eac4f4b5f205f9a4.png"><br><br>  Good day dear% username%! <br>  I would like to congratulate all admins on this holiday, and in honor of this I wrote a post on me.  By the nature of their activities (* nix admin), I get familiar with various requests for help on servers.  Usually requests in the spirit - we began to slow down the site, or something we have hung, etc.  Very often, problems arise because of the actions of programmers who do not always understand what they are doing, or do not understand the consequences of what they are doing.  After looking at it all, I decided to share with you some cases and exhortations. <br><br>  <i>Initially, I thought of calling the post ‚Äústop admin‚Äù and collect in it the typical mistakes of admin programmers, but the idea went a little different, so the title turned out like this.</i>  <i>In advance I want to apologize for the confusion of the post, just rolled something to write and how the thought went, and wrote.</i> <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h6>  Case 1. </h6><br>  - ‚ÄúAnton, we began to slow down the site.  Take a look? ‚Äù <br>  The wording is fairly standard, so to get some understanding of what is happening, I am climbing ssh to the server. <br>  Looking at the top, I see a php process that eats a bunch of resources.  What is this?  No crime only - remove_old_thumbs.php.  As you might guess, it removes old thumbnail images.  And all would be nothing, but he does it very actively. <br>  iotop says that the script is very actively tormenting the hard drive.  It is understandable, wool in folders and deleting thousands of files is resource-intensive, especially on virtuals.  Decision? <br>  ionice -c3 php remove_old_thumbs.php <br>  Since the procedure for removing old thumbnails is not critical, and does not require high priority, you can run it with low I / O priority.  We start - the process has gone more quietly, the site has ceased to slow down, miniaturks are slowly being removed - everyone is happy. <br><br><h6>  Case 2. </h6><br>  - ‚ÄúAnton, we started doing miniatures here, but something is slowing down‚Äù <br>  Well, we'll see.  Here are those on.  Links to thumbnails look like this.  thumb.php? image = images / 12311.jpg.  Well, here you have to dig into the code. <br><br>  - Pictures for thumbnails are in the same folder, and there are under a million.  There is no need to force fs. <br>  - The script does not save the generated thumbnails.  For each appeal, he generates a new thumbnail - not comme il faut√© gentlemen! <br>  - Generation of thumbnails for all images will take a long time. <br><br>  Parse the case.  For a start, it would be good to decompose all the pictures into folders.  It is proposed to decompose by date, date taken from the publication.  There are no special problems with this, everything is transparent and clear.  And it turned out somehow like this: images / 2013/08 / 12311.jpg. <br>  To kill the last 2 points, it was suggested to make the thumbnail addresses such as thumbs / 2013/08 / 12311.jpg, and in nginx, configure a rule that checks for the presence of a file at the specified url and redirect the request to thump.php if not.  In turn, thumb.php generates a thumbnail, shows it to the client and folds it to disk at the desired address.  Thus, we unloaded cpu and fs, and the site flew. <br><br><h6>  Case 3. </h6><br>  - ‚ÄúAnton, we began to slow down the site.  Take a look? ‚Äù <br>  In processes 10 processes remove_old_thumbs.php hang.  Guys, well, let's in the scripts running about the crown, do a test for neglect?  At least creating a lock file in / tmp, and at the end of the script using the register_shutdown_function, call the function that deletes this file.  Quick and easy. <br><br><h6>  Case 4. </h6><br>  I will not dwell on this in great detail, although the topic is very relevant, but each case is strictly individual.  I will not reproduce an example for memory, but if it is short then: <br>  "SELECT * FROM posts" - we pulled out the entire base of posts, with all the descriptions and garbage, and are actively working with this array of data, although from the whole array only the id and poster_url are needed. <br>  ‚ÄúSELECT description FROM posts WHERE post_time&gt; '2013-01-01' AND post_moderated = '1' ORDER BY name DESC‚Äù - Submit this query with a bunch of joines and quite massive.  And why does he suddenly slow down?  And all because there is no index in the name field, and new programmers have not heard about EXPLAIN. <br><br><h4>  Well.  The above cases are drawing on programmer errors.  In what it is possible to reproach administrators? </h4><br>  To start with this: <br>  <b>ssh</b> : // <b>root</b> : om7ooS3righoob4Xe7ri @ hostname <br><br>  In 90% of cases, remote access to servers is carried out as root and almost immediately, these servers begin to brute force.  This is not right. <br>  What can be done?  To begin with, create a user, under which then log in via ssh.  And then, disable authorization from root (PermitRootLogin no - disable authorization from root) in sshd_config.  To get root rights under the user, you can type ‚Äúsu -‚Äù or configure sudo.  Isn't it difficult? <br>  What else can be done?  You can deny access to ssh from unknown IPs and you do not need to write a stack of rules for iptables, just tweak a couple of files. <br><br>  <b>hosts.deny</b> <br>  sshd: all <br><br>  <b>hosts.allow</b> <br>  sshd: 123.231.132.213 <br><br>  And that's it!  We have forbidden to go to the server via ssh to everyone except 123.231.132.213. <br><br>  Ok, what else? <br>  [root @ localhost ~] # ps auwx |  grep php <br>  root 795 0.0 0.5 321152 9948?  Ss jul22 0:10 php-fpm: master process (/etc/php-fpm.conf) <br>  <b>root</b> 884 0.0 0.3 321696 6724?  S Jul22 0:00 php-fpm: pool www <br>  <b>root</b> 885 0.0 0.3 321696 6644?  S Jul22 0:00 php-fpm: pool www <br>  <b>root</b> 886 0.0 0.3 321696 6720?  S Jul22 0:00 php-fpm: pool www <br>  <b>root</b> 887 0.0 0.3 321728 6720?  S Jul22 0:00 php-fpm: pool www <br>  <b>root</b> 888 0.0 0.3 321728 6728?  S Jul22 0:00 php-fpm: pool www <br><br>  Why do php scripts run from root?  What for?!  It's like leaving your car keys in the car itself.  The solution in each case will be different, in this case in the php-fpm.conf config, the user changes to the one you need. <br><br>  Those who did not run scripts from the root, sinning to others - <b>chmod 777</b> .  I will not describe the consequences and methods of treatment, I will say only one thing.  Expose the rights to the files after considering their actions.  And never exhibit them like this. <br>  ‚ÄúChmod 777 -R.  ‚Äú.  By the will of fate, you can break the OS by running the command in the wrong folder. <br><br>  Many admins sin by compiling software and putting it into the system.  I do not undertake to say that this is a great evil, but still it is evil.  Familiar to <b>./configure &amp;&amp; make &amp;&amp; make install</b> ?  Guys, do not be lazy to find a package.  If there is no package, try using the same checkinstall. <br><br>  In fact, there are many different cases.  You can disassemble them long and hard, but I would like to turn to programmers.  Guys, if you maintain a site with serious traffic, do optimizations and create some kind of austere functionality, seek advice from experienced colleagues (especially admins).  They will help you with advice and save you from dreadful and not very mistakes. </div><p>Source: <a href="https://habr.com/ru/post/231053/">https://habr.com/ru/post/231053/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../231033/index.html">PostgreSQL 9.4 beta2 released. All active branches have been updated.</a></li>
<li><a href="../231039/index.html">Little old iron</a></li>
<li><a href="../231045/index.html">Creating a site funnel and measuring the conversion of a cup of coffee without a line of code</a></li>
<li><a href="../231047/index.html">The second law of thermodynamics -> increase in successful projects</a></li>
<li><a href="../231051/index.html">Game for the sysadmin day: guess the racks in our workshop by the handles?</a></li>
<li><a href="../231055/index.html">InfoboxCloud cloud infrastructure launched in Amsterdam. Technical details of the installation</a></li>
<li><a href="../231057/index.html">Testing flash storage. Violin 6232 Series Flash Memory Array</a></li>
<li><a href="../231059/index.html">Google gives 90 days of Google Play Music All Access in honor of the anniversary of the launch of Chromecast</a></li>
<li><a href="../231061/index.html">Economics of IT for small businesses: an outsourcer or a staff member?</a></li>
<li><a href="../231063/index.html">Google is going to create a genetic-molecular map of an absolutely healthy person.</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>