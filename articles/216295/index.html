<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We define VPN users (and their settings!) And proxy from the site</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="We can save the day from dark 
 There's no one we need 

 Many of you use a VPN or proxy in everyday life. Someone uses it constantly, gaining access ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We define VPN users (and their settings!) And proxy from the site</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/9a0/9fd/d72/9a09fdd724dd397be42b962c8307e408.png" alt="W.I.T.C.H."><br>  <sup><i>We can save the day from dark</i></sup> <sup><i><br></i></sup>  <sup><i>There's no one we need</i></sup> <br><br>  Many of you use a VPN or proxy in everyday life.  Someone uses it constantly, gaining access to resources blocked at the state or corporate level, many use it occasionally to bypass the restrictions on geographic location.  As you may know, major Internet players in the field of video streaming, music, and game sales have never liked users who easily bypass geographical restrictions, unlocking inaccessible content in their country, or making purchases much cheaper.  There is no need to go far for examples: Netflix changed its usage agreement by adding a clause about blocking a VPN, just 2 months ago;  Hulu also sinned blocking users, and Steam is generally suspicious of non-Russian-speaking users from Russia.  Recently, companies are trying to block not specific users, but the IP addresses of VPN services themselves, creating certain inconveniences for the VPN service itself and its users.  It seems that they do not use any special means, but block selectively and manually.  Although I do not support any blockages at all, I was interested in the technical part of the question: can I somehow determine the use of proxy servers and VPN from the server side without making any special efforts? <br>  It is possible, under certain conditions.  And quite accurately. <a name="habracut"></a><br><br><h3>  MSS and MTU </h3>  MTU, or Maximum Transmission Unit - the maximum amount of data that can be transmitted in one packet.  MTU is installed on each network adapter, even on those routers through which traffic from you to the remote server goes in transit.  In the overwhelming majority of cases, MTU 1500 is used on the Internet, however, there are noticeable exceptions, which, by the way, are often subject to certain rules. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      When your browser or any other software working with a network creates a TCP connection to a remote server, the Maximum Segment Size (MSS) value is placed in the packet headers, which tells the server what maximum size of segments it can transmit in one packet.  This value is very close to the MTU, it immediately makes the server understand the possibilities of your Internet connection, eliminating unnecessary fragmentation and allowing you to utilize your channel to the full. <br>  When you send a packet while connected to a VPN using some protocol (PPTP, L2TP (¬± IPsec), IPsec IKE), it is placed (encapsulated) into another packet that introduces its overhead, and large packets that sent without fragmentation without VPN, now have to be fragmented.  To avoid such fragmentation, the OS installs less MTUs on the network interface than the real network interface MTU, which is why the OS does not attempt to create large packets that would require fragmentation. <br>  In the case of PPTP, L2TP (¬± IPsec), IPsec, as I understand it, there are no standards for the MTU of the tunnel, everyone sets these values ‚Äã‚Äãto work in most cases, and they are installed by eye.  As a rule, it is 1400, which allows using, say, PPTP on channels with an MTU of up to 1440 without fragmentation (for example, when you need another tunnel to access the Internet, as is often the case with Russian providers).  OpenVPN - perhaps the most popular VPN option - on the contrary, went the other way. <br><br><h3>  Openvpn </h3>  In order to be compatible with old or simply crooked software, OpenVPN by default does not set a lower MTU value on the VPN interface, but changes the MSS value inside the encapsulated TCP packet.  The mssfix parameter, which is set to 1450 by default, is responsible for this. It modifies the MSS so that it fully utilizes the channel from the MTU 1450, i.e.  calculates their overhead in such a way that they pass through the channel with MTU 1450 or more without fragmentation.  As a result, we have the opportunity not only to define OpenVPN users with standard mssfix 1450, but also to define their connection protocol (IPv4, IPv6), transport protocol (TCP, UDP), encryption, compression and MAC parameters, since  they contribute their unique overhead and are reflected in the MSS. <br>  Let's look at typical MSS values: <table><tbody><tr><th>  Protocol </th><th>  Block size </th><th>  MAC </th><th>  Compression </th><th>  MSS </th></tr><tr><td>  UDP </td><td>  64 </td><td>  SHA1 </td><td>  - </td><td>  1369 </td></tr><tr><td>  UDP </td><td>  64 </td><td>  SHA1 </td><td>  + </td><td>  1368 </td></tr><tr><td>  Tcp </td><td>  64 </td><td>  SHA1 </td><td>  - </td><td>  1367 </td></tr><tr><td>  Tcp </td><td>  64 </td><td>  SHA1 </td><td>  + </td><td>  1366 </td></tr><tr><td>  UDP </td><td>  128 </td><td>  SHA1 </td><td>  - </td><td>  1353 </td></tr><tr><td>  UDP </td><td>  128 </td><td>  SHA1 </td><td>  + </td><td>  1352 </td></tr><tr><td>  Tcp </td><td>  128 </td><td>  SHA1 </td><td>  - </td><td>  1351 </td></tr><tr><td>  Tcp </td><td>  128 </td><td>  SHA1 </td><td>  + </td><td>  1350 </td></tr><tr><td>  UDP </td><td>  128 </td><td>  SHA256 </td><td>  - </td><td>  1341 </td></tr><tr><td>  UDP </td><td>  128 </td><td>  SHA256 </td><td>  + </td><td>  1340 </td></tr><tr><td>  Tcp </td><td>  128 </td><td>  SHA256 </td><td>  - </td><td>  1339 </td></tr><tr><td>  Tcp </td><td>  128 </td><td>  SHA256 </td><td>  + </td><td>  1338 </td></tr></tbody></table>  If a cipher with a block size of 64 bits is used, this is probably Blowfish, if 128 is probably AES. <br><br>  For greater theory testing, 2 VPN services were tested: VyprVPN and ibVPN.  Both services are subject to the definition of settings by the method described. <br>  If you do not want to be detected in this way, you can either disable mssfix by setting it to 0 both on the server and on the clients, thus obtaining MSS 1460 (in the case of IPv4), which corresponds to the MTU 1500 ‚Äî the typical MTU for a normal wired connection that the vast majority of users have.  However, in this case, you will get excessive fragmentation, which leads to increased delays and reduced throughput, so it may make sense to set the MTU to 1400, 1380 or similar (should be a multiple of 2, and better than 10), because  Such values ‚Äã‚Äãare often used by providers, for example, the mobile Internet. <br><br><h3>  Proxy </h3>  There are not many ways to define a proxy server if it does not add any headers (like X-Forwarded-For).  What is the technical difference between a proxy and a VPN?  In the case of VPN, the remote server receives from you the package that your OS created, in an unchanged (often) form.  The proxy, on the contrary, receives only all the information about the remote server (IP, port, other parameters) and data, creating a packet on the side of the proxy itself, and sends it.  Different operating systems create packages in different ways, differences can be found even from version to version.  We can accurately determine the OS of the creator of the package, the version does not interest us much. <br>  As it seems to me, proxies are most often run on Linux and BSD, and are used more often under Windows.  Users often do not think about changing the User-Agent, which includes the operating system used, in the browser, and this is good for us. <br><br><h3>  p0f </h3>  There is a wonderful project <a href="http://lcamtuf.coredump.cx/p0f3/">p0f</a> that fits perfectly with our needs.  Passively listening to the traffic, it can determine the OS, MTU and browser, notify the OS of the creator of the packages and the OS in the User-Agent.  In addition, it has an API.  By slightly <a href="https://github.com/ValdikSS/p0f-mtu">modifying it</a> , adding MTU export via API and updating signatures, we can detect users of popular VPN protocols, proxy users and users who fake a User-Agent with a certain accuracy. <br><br><h3>  Ôº∑Ôº©Ôº¥Ôº£Ôº®Ôºü </h3>  A little thought, I decided to make a small web service to implement my ideas, because, for some reason, I could not find anything like that. <br>  This resulted in <a href="http://witch.valdikss.org.ru/">Ôº∑Ôº©Ôº¥Ôº£Ôº®Ôºü,</a> which will easily tell you about the settings of your OpenVPN connection (if you didn‚Äôt touch mssfix, of course), try to determine your OS and compare it with the OS in the User-Agent, get a PTR record for your IP and compare it with a set of rules, determining whether you are using an Internet channel designed for home or server users. <br><pre><code class="hljs sql">First seen = 2015/07/24 17:19:29 Last <span class="hljs-keyword"><span class="hljs-keyword">update</span></span> = <span class="hljs-number"><span class="hljs-number">2015</span></span>/<span class="hljs-number"><span class="hljs-number">07</span></span>/<span class="hljs-number"><span class="hljs-number">24</span></span> <span class="hljs-number"><span class="hljs-number">18</span></span>:<span class="hljs-number"><span class="hljs-number">39</span></span>:<span class="hljs-number"><span class="hljs-number">37</span></span> Total flows = <span class="hljs-number"><span class="hljs-number">7</span></span> Detected OS = Linux <span class="hljs-number"><span class="hljs-number">3.11</span></span> <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> newer <span class="hljs-keyword"><span class="hljs-keyword">HTTP</span></span> software = Firefox <span class="hljs-number"><span class="hljs-number">10.</span></span>x <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> newer (<span class="hljs-keyword"><span class="hljs-keyword">ID</span></span> seems legit) MTU = <span class="hljs-number"><span class="hljs-number">1409</span></span> Network <span class="hljs-keyword"><span class="hljs-keyword">link</span></span> = OpenVPN UDP bs64 <span class="hljs-keyword"><span class="hljs-keyword">SHA1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">Language</span></span> = Russian Distance = <span class="hljs-number"><span class="hljs-number">15</span></span> Uptime = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">days</span></span> <span class="hljs-number"><span class="hljs-number">19</span></span> hrs <span class="hljs-number"><span class="hljs-number">39</span></span> <span class="hljs-keyword"><span class="hljs-keyword">min</span></span> (modulo <span class="hljs-number"><span class="hljs-number">165</span></span> <span class="hljs-keyword"><span class="hljs-keyword">days</span></span>) PTR <span class="hljs-keyword"><span class="hljs-keyword">test</span></span> = Probably home <span class="hljs-keyword"><span class="hljs-keyword">user</span></span> Fingerprint <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> OS match. <span class="hljs-keyword"><span class="hljs-keyword">No</span></span> proxy detected. OpenVPN detected. <span class="hljs-keyword"><span class="hljs-keyword">Block</span></span> <span class="hljs-keyword"><span class="hljs-keyword">size</span></span> <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-number"><span class="hljs-number">64</span></span> <span class="hljs-keyword"><span class="hljs-keyword">bytes</span></span> <span class="hljs-keyword"><span class="hljs-keyword">long</span></span> (probably Blowfish), MAC <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> SHA1.</code> </pre> <br>  Ôº∑Ôº©Ôº¥Ôº£Ôº®Ôºü also easily identifies users of the Tor Browser, since  it uses the same static User-Agent (with Windows) on all operating systems, and exit nodes are running under Linux and FreeBSD. <br><img src="https://habrastorage.org/getpro/habr/post_images/f43/4d8/519/f434d8519521978a5bbd806fd35b5811.png" alt="Tor Browser with Ôº∑Ôº©Ôº¥Ôº£Ôº®Ôºü opened"><br><br>  During the tests, many interesting details emerged: <br><ul><li>  Mobile Internet from Beeline passes all connections through a proxy for Linux.  It was discovered when a person with Beeline came from the iPhone toÔºü, and the OS was defined as Linux.  It is probably through him that they <a href="http://habrahabr.ru/post/263429/">change HTML tags</a> , <a href="http://habrahabr.ru/post/257133/">add a toolbar with mail.ru search</a> and <a href="http://habrahabr.ru/post/262687/">change the design of sites</a> . </li><li>  The MTU of mobile devices can literally be anything, but, as a rule, ends at 0. The exception is Yota from 1358. What it depends on is not clear, I suspect that from the settings on the operator‚Äôs side and from the telephone module.  The same SIM in different phones uses different MTU. </li><li>  The code that is responsible for mssfix in OpenVPN is very slow.  If you have knowledge of networks, C, desire and time, please see if it can be optimized. </li></ul><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text">  I do not know what I found six months ago, but I decided to review the WITCH animated series, and, not finding a normal release, I bought everything I bought, downloaded everything I downloaded and made a release with English, French, Spanish, Dutch, Italian, German, Russian, Norwegian , Danish, Swedish, Finnish, Czech, Turkish, Polish and Hungarian. <br><br>  <a href="https://kat.cr/w-i-t-c-h-season-1-multilingual-dvdrip-v2-t10822015.html">The first</a> and <a href="https://kat.cr/w-i-t-c-h-season-2-multilingual-dvdrip-t10426848.html">second</a> seasons. </div></div>  So it goes. </div><p>Source: <a href="https://habr.com/ru/post/216295/">https://habr.com/ru/post/216295/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../216285/index.html">Motorola and LG are preparing a smart watch on the OS from Google</a></li>
<li><a href="../216287/index.html">"Memory Component Issue", or large-scale defective network equipment</a></li>
<li><a href="../216289/index.html">Traces of gravitational waves from the Big Bang were found in relic radiation.</a></li>
<li><a href="../216291/index.html">Another story about starting a startup</a></li>
<li><a href="../216293/index.html">How to help to get on Kickstarter in 5 minutes</a></li>
<li><a href="../216297/index.html">The digest of new gadgets and "ducks" from Madrobots # 1</a></li>
<li><a href="../216301/index.html">The logic of thinking. Part 13. Associative memory</a></li>
<li><a href="../216303/index.html">Java 8 Released</a></li>
<li><a href="../216305/index.html">Announcement and pre-order Unity 3D 5</a></li>
<li><a href="../216307/index.html">The book "Systems Engineering for Dummies": an electronic version of the book for everyone</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>