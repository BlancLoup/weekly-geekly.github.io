<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Fell with AWS? Call in without question, documents later, now not before</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="While I was driving to work and listening to a new Dolphin album, someone blocked Amazon and Google‚Äôs IP addresses with entire subnets. Roskomnadzor c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Fell with AWS? Call in without question, documents later, now not before</h1><div class="post__text post__text-html js-mediator-article">  While I was driving to work and listening to a new Dolphin album, someone blocked Amazon and Google‚Äôs IP addresses with entire subnets.  Roskomnadzor called unreliable information about blocking sites that are not related to Telegram, but renting IP addresses on the same services as the instant messenger, and created a hotline to counter the spread of such messages. <br><br>  Therefore, I can‚Äôt even guess why we had to help several services during yesterday‚Äôs day.  Someone hurt quite a bit, and someone had to migrate. <br><br>  In short, we can quickly migrate from AWS.  We have a compatible API.  Migrate customers from Google too.  And in the coming weeks, we are ready to do the migration for free and give a month for tests in our cloud without a contract and without a letter of guarantee, simply by company card.  Do not like it - do not pay anything. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Below - howto for different types of unloading VM from Amazon. <br><a name="habracut"></a><br>  We are seeing a surge of interest in Russian clouds right now.  We understand that those faced with blocking can either wait or urgently migrate their services to an accessible public cloud. <br><br>  Migration requires access, arrangements with support, conclusion of a contract. <br><br>  We are ready to skip these formalities and give access by letter to MBerezin@croc.ru. <br><br><h3>  Compatibility </h3><br>  The KROK cloud is developing largely under the AWS scenario: we ourselves develop our virtualization platform based on KVM.  Naturally, in the process, we are learning from the experience of our Western colleagues, and therefore we can boast of compatibility with AWS, which we ourselves greatly respect. <br><br>  <b>Thesis:</b> <br><br><ul><li>  Two access zones based on our own network of data centers, </li><li>  Equally fast network for all VMs, regardless of their type, </li><li>  Fast network between VM and physical infrastructure located in data center </li><li>  High performance fixed IOPS drives (analogous to io1 in AWS), </li><li>  Full service of import / export of virtual disks, </li><li>  Free user traffic in S3. </li></ul><br>  Your customized automation will work <a href="https://cloud.croc.ru/services/laas/kvm/%3Futm_source%3Dhabr%26utm_medium%3Dblog%26utm_campaign%3D18_04_18">in our cloud</a> without any major problems.  We have implemented the main functionality of the three services Elastic Compute Cloud (EC2), Simple Storage Service (S3), CloudWatch. <br><br><h3>  Migration options </h3><br>  1. The standard procedure for importing / exporting a VM is described <a href="https://docs.aws.amazon.com/vm-import/latest/userguide/vmexport.html">in the documentation</a> . <br>  However, there is an important limitation: exporting is possible only for machines that were previously imported into AWS.  Otherwise, we get an error: <br><br><pre><code class="hljs sql">$ aws ec2 <span class="hljs-keyword"><span class="hljs-keyword">create</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>-task ‚Äî<span class="hljs-keyword"><span class="hljs-keyword">instance</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">id</span></span> i-XXXXXXXXXXXXXXXX ‚Äîtarget-environment vmware ‚Äî<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>-<span class="hljs-keyword"><span class="hljs-keyword">to</span></span>-s3-task DiskImageFormat=vmdk,ContainerFormat=ova,S3Bucket=my-<span class="hljs-keyword"><span class="hljs-keyword">export</span></span>-bucket An <span class="hljs-keyword"><span class="hljs-keyword">error</span></span> occurred (NotExportable) <span class="hljs-keyword"><span class="hljs-keyword">when</span></span> <span class="hljs-keyword"><span class="hljs-keyword">calling</span></span> the CreateInstanceExportTask operation: <span class="hljs-keyword"><span class="hljs-keyword">Only</span></span> imported instances can be exported.</code> </pre> <br>  If you managed to export the instance, then you need to download it from AWS S3. <br><br>  Next, download the downloaded image in the CROC S3.  To do this, you need to download the CROC Cloud API access settings file, configure s3cmd to work with our S3 and load the disk image. <br><br>  2. If you cannot export an instance (machines were created from AWS templates), then you can bypass the limitation as follows: the VM disk must be dumped into an image file, which will need to be loaded into our S3. <br><br>  a) Create a temporary EBS volume slightly larger than the original one. <br>  b) Create a file system on a temporary volume and mount it: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># mkfs.xfs /dev/xvdf1 # mkdir /tmp/export # mount /dev/xvdf1 /tmp/export</span></span></code> </pre> <br>  c) Install qemu-img <br>  d) Stop the entire butt and services, remove the disk image: <br><br><pre> <code class="hljs vala"><span class="hljs-meta"><span class="hljs-meta"># qemu-img -O qcow2 -o compat=0.10 /dev/xvda /tmp/export/web1-xvda.qcow2</span></span></code> </pre> <br>  e) Load the file /tmp/export/web1-xvda.qcow2 into CROC S3, create a template from it and start an instance from it in the same way as in the first version. <br>  f) unmount and delete temporarily created EBS volume <br><br>  3. Similarly for other OS, in Windows you can, for example, create VHD / VHDX through the disk control panel. <br><br>  4. You can consider the option of backup and restore it on another machine. <br><br>  5. If it is enough to transfer files (for example, content), rsync can be used in Linux, robocopy in Windows. <br><br>  6. If downtime or large volumes are completely expensive, you can work with the replication of the OS and file systems through Double Take / Carbonite. <br><br>  In general, there are quite a few options, it all depends on how the specific infrastructure is arranged.  In all these cases, our support understands, and we have experience of similar migrations.  Plus, our certified AWS specialists, so we can definitely help. <br><br>  Have questions - please contact us in the comments or write: MBerezin@croc.ru </div><p>Source: <a href="https://habr.com/ru/post/353704/">https://habr.com/ru/post/353704/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../353684/index.html">One small ventilation</a></li>
<li><a href="../353686/index.html">"Closer to 5G": VMware helps telecom operators deploy new generation networks</a></li>
<li><a href="../353692/index.html">What business and users face the struggle of RKN and Telegram? Expert opinions</a></li>
<li><a href="../353696/index.html">Challenges and challenges in Enterprise E-Commerce. How did the project Virto Commerce?</a></li>
<li><a href="../353698/index.html">Code architecture</a></li>
<li><a href="../353706/index.html">Aviakacathon</a></li>
<li><a href="../353708/index.html">[St. Petersburg, announcement] SpbDotNet # 30 - reports on telemetry of .NET microservices and code analyzers ReSharper and Roslyn</a></li>
<li><a href="../353710/index.html">How to learn to predict late trains</a></li>
<li><a href="../353712/index.html">We write our own clever thread_pool-dispatcher for SObjectizer</a></li>
<li><a href="../353714/index.html">Announcement of AppsConf: 2 days of application, hardcore and HYIP reports</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>