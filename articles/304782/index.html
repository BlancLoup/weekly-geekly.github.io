<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Work with Bluetooth LE from Java applications</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Today we will talk about how, using Java, create applications for IoT that can work with remote Bluetooth Low Energy-based devices. The development of...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Work with Bluetooth LE from Java applications</h1><div class="post__text post__text-html js-mediator-article">  Today we will talk about how, using Java, create applications for IoT that can work with remote Bluetooth Low Energy-based devices.  The development of such applications, thanks to the open source project <a href="https://github.com/intel-iot-devkit/tinyb/">TinyB</a> , supports the Intel IoT Development Kit.  TinyB provides the developer with simple APIs for C ++ and Java that allow you to work with BLE devices.  Here we look at the TinyB API for Java, and we will conduct experiments on Intel Edison. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/375/720/baa/375720baaef744dfb4dccf4c4d388653.jpg"></div><br><a name="habracut"></a><br><h2>  <font color="#0071c5">About compatibility and prerequisites</font> </h2><br>  The current version of the Bluetooth API in TinyB has been tested in Java 8 Runtime (OpenJDK 8).  This environment, like TinyB, is supplied as part of the official Intel IoT Development Kit image for Intel Edison boards. <br><br>  On Linux-based systems, TinyB can be used with BlueZ installed (version 5.37. Or higher).  At the same time, the <b>bluetoothd</b> daemon starts up with the experimental functions enabled (the <code>‚ÄìE</code> flag).  You can read more about this in the <a href="">README file</a> .  In our example, the <a href="http://www.ti.com/ww/en/wireless_connectivity/sensortag2015%3FINTC%3DSensorTag%26HQS%3Dsensortag">SensorTag</a> from Texas Instruments acts as the Bluetooth LE device.  Details about the device can be found <a href="http://processors.wiki.ti.com/index.php/CC2650_SensorTag_User%2527s_Guide">here</a> . 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h2>  <font color="#0071c5">Documentation and sample applications</font> </h2><br>  Here are two options for the Bluetooth API documentation that TinyB provides.  <a href="http://iotdk.intel.com/docs/master/tinyb/">Here</a> are the materials for those who use C ++, and <a href="http://iotdk.intel.com/docs/master/tinyb/java/">here</a> for Java developers. <br><br>  The <b>HelloTinyB</b> example, which is written in Java (or <b>hellotinyb</b> for C ++), uses the above-mentioned SensorTag.  From it is read indicators about the ambient temperature and the temperature of the object.  For proper operation, the application requires the SensorTag MAC address.  It must be passed as the first parameter when starting the program: <br><br><pre> <code class="hljs javascript">./examples/hellotinyb XX:XX:XX:XX:XX:XX java -cp examples/java/HelloTinyB.jar:<span class="hljs-regexp"><span class="hljs-regexp">/usr/</span></span>lib/java/tinyb.jar HelloTinyB XX:XX:XX:XX:XX:XX</code> </pre> <br><h2>  <font color="#0071c5">Java IoT application for working with Bluetooth LE</font> </h2><br>  Here we will use an example of HelloTinyB, which is written in Java.  It can be found in <a href="">the</a> TinyB <a href="">repository</a> .  We will show how to write an application that reads data from the GATT service via Bluetooth LE. <br><br>  In order to start working with SensorTag, you need to initialize the TinyB library.  The <b>BluetoothManager</b> object provides an entry point for using Bluetooth devices.  A program can have only one instance of this manager object.  A link to it can be obtained using the <b>getBluetoothManager ()</b> method: <br><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">BluetoothManager</span></span> manager = BluetoothManager.getBluetoothManager();</code> </pre> <br>  The manager will attempt to initialize the <b>BluetoothAdapter</b> object if there is a Bluetooth adapter on the system.  In order to start the search for other devices, you need to call the <b>startDiscovery ()</b> method, which will <b>put the</b> default adapter into search mode: <br><br><pre> <code class="hljs pgsql"><span class="hljs-type"><span class="hljs-type">boolean</span></span> discoveryStarted = manager.startDiscovery();</code> </pre> <br>  After executing this command, you can wait for the following debug output: <br><br><pre> <code class="hljs pgsql">The discovery started: <span class="hljs-keyword"><span class="hljs-keyword">true</span></span> Address = C4:BE:<span class="hljs-number"><span class="hljs-number">84</span></span>:<span class="hljs-number"><span class="hljs-number">72</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>B:<span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span> = CC2650 SensorTag Connected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span></code> </pre> <br>  After starting the search, a new device was found.  A list of all found devices can be obtained using the <b>getDevices ()</b> manager method.  This list must be viewed in order to find a device with a MAC address specified as a parameter when starting the program.  The search continues either until the desired device is found, or - until 15 attempts are made to detect it (it takes about a minute). <br><br><pre> <code class="hljs cs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> BluetoothDevice </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDevice</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">String address</span></span></span><span class="hljs-function">) throws InterruptedException</span></span> { BluetoothManager manager = BluetoothManager.getBluetoothManager(); BluetoothDevice sensor = <span class="hljs-literal"><span class="hljs-literal">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; (i &lt; <span class="hljs-number"><span class="hljs-number">15</span></span>) &amp;&amp; running; ++i) { List&lt;BluetoothDevice&gt; list = manager.getDevices(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (BluetoothDevice device : list) { printDevice(device); <span class="hljs-comment"><span class="hljs-comment">/* *  ,     . */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (device.getAddress().<span class="hljs-keyword"><span class="hljs-keyword">equals</span></span>(address)) sensor = device; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensor != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sensor; } Thread.sleep(<span class="hljs-number"><span class="hljs-number">4000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; }</code> </pre> <br>  After the desired Bluetooth device is detected, you can start the process of connecting to it using the <b>connect</b> method of the object that corresponds to it.  Here is what the test output should look like at this stage of the work: <br><br><pre> <code class="hljs pgsql"><span class="hljs-built_in"><span class="hljs-built_in">Found</span></span> device: Address = C4:BE:<span class="hljs-number"><span class="hljs-number">84</span></span>:<span class="hljs-number"><span class="hljs-number">72</span></span>:<span class="hljs-number"><span class="hljs-number">2</span></span>B:<span class="hljs-number"><span class="hljs-number">09</span></span> <span class="hljs-type"><span class="hljs-type">Name</span></span> = CC2650 SensorTag Connected = <span class="hljs-keyword"><span class="hljs-keyword">false</span></span> Sensor <span class="hljs-keyword"><span class="hljs-keyword">with</span></span> the provided address connected</code> </pre> <br>  The device to which we are connected must give access to the temperature determination service, the UUID of which can be found in the <a href="http://processors.wiki.ti.com/images/a/a8/BLE_SensorTag_GATT_Server.pdf">documentation</a> .  The service we need has a short UUID <b>AA00</b> .  It should be inserted into the main UUID TI instead of XXXX: f000XXXX-0451-4000-b000-000000000000. <br><br><pre> <code class="hljs pgsql">static BluetoothGattService getService(BluetoothDevice device, String <span class="hljs-type"><span class="hljs-type">UUID</span></span>) throws InterruptedException { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("Services exposed by device:"); BluetoothGattService tempService = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; List&lt;BluetoothGattService&gt; bluetoothServices = <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { bluetoothServices = device.getServices(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (BluetoothGattService service : bluetoothServices) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println("UUID: " + service.getUuid()); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (service.getUuid().equals(<span class="hljs-type"><span class="hljs-type">UUID</span></span>)) tempService = service; } Thread.sleep(<span class="hljs-number"><span class="hljs-number">4000</span></span>); } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (bluetoothServices != <span class="hljs-keyword"><span class="hljs-keyword">null</span></span> &amp;&amp; bluetoothServices.isEmpty() &amp;&amp; running); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> tempService; }</code> </pre> <br>  As a result of the above code, the following should be displayed: <br><br><pre> <code class="hljs cs">Services exposed <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> device: UUID: f000aa64<span class="hljs-number"><span class="hljs-number">-0451</span></span><span class="hljs-number"><span class="hljs-number">-4000</span></span>-b000<span class="hljs-number"><span class="hljs-number">-000000000000</span></span> UUID: <span class="hljs-number"><span class="hljs-number">0000180</span></span>a<span class="hljs-number"><span class="hljs-number">-0000</span></span><span class="hljs-number"><span class="hljs-number">-1000</span></span><span class="hljs-number"><span class="hljs-number">-8000</span></span><span class="hljs-number"><span class="hljs-number">-00805f</span></span>9b34fb UUID: f000ccc0<span class="hljs-number"><span class="hljs-number">-0451</span></span><span class="hljs-number"><span class="hljs-number">-4000</span></span>-b000<span class="hljs-number"><span class="hljs-number">-000000000000</span></span> UUID: f000ac00<span class="hljs-number"><span class="hljs-number">-0451</span></span><span class="hljs-number"><span class="hljs-number">-4000</span></span>-b000<span class="hljs-number"><span class="hljs-number">-000000000000</span></span> ... Found service f000aa00<span class="hljs-number"><span class="hljs-number">-0451</span></span><span class="hljs-number"><span class="hljs-number">-4000</span></span>-b000<span class="hljs-number"><span class="hljs-number">-000000000000</span></span></code> </pre> <br>  First we need to get the characteristics of the service.  There are three such characteristics: value (UUID <b>AA01</b> ), configuration ( <b>AA02</b> ) and period: ( <b>AA03</b> ).  We recognize them by using the following code: <br><br><pre> <code class="hljs pgsql">static BluetoothGattCharacteristic getCharacteristic(BluetoothGattService service, String <span class="hljs-type"><span class="hljs-type">UUID</span></span>) { List&lt;BluetoothGattCharacteristic&gt; <span class="hljs-keyword"><span class="hljs-keyword">characteristics</span></span> = service.getCharacteristics(); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (BluetoothGattCharacteristic characteristic : <span class="hljs-keyword"><span class="hljs-keyword">characteristics</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (characteristic.getUuid().equals(<span class="hljs-type"><span class="hljs-type">UUID</span></span>)) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> characteristic; } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">null</span></span>; } BluetoothGattCharacteristic tempValue = getCharacteristic(tempService, "f000aa01-0451-4000-b000-000000000000"); BluetoothGattCharacteristic tempConfig = getCharacteristic(tempService, "f000aa02-0451-4000-b000-000000000000"); BluetoothGattCharacteristic tempPeriod = getCharacteristic(tempService, "f000aa03-0451-4000-b000-000000000000");</code> </pre> <br>  Now you need to include the service to determine the temperature, writing "1" in the configuration characteristic.  Details on this are in the above documentation.  You can change the update interval of the indicators by writing the desired value in the characteristic of the period, but the default value, "1", suits us. <br><br><pre> <code class="hljs lua"><span class="hljs-built_in"><span class="hljs-built_in">byte</span></span>[] <span class="hljs-built_in"><span class="hljs-built_in">config</span></span> = { <span class="hljs-number"><span class="hljs-number">0x01</span></span> }; tempConfig.writeValue(<span class="hljs-built_in"><span class="hljs-built_in">config</span></span>);</code> </pre> <br>  After setting, you can start reading temperature information from the device.  The temperature service returns data in a coded format.  Features of working with this data format can be found in the documentation for the SensorTag.  We are going to convert the data to degrees Celsius and output it to the console.  The temperature of the object, in accordance with the documentation, depends on the ambient temperature.  Here we will consider that the results without additional transformations suit us. <br><br><pre> <code class="hljs pgsql"><span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (running) { byte[] tempRaw = tempValue.readValue(); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.print("Temp raw = {"); <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (byte b : tempRaw) { <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.print(String.format("%02x,", b)); } <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.print("}"); <span class="hljs-type"><span class="hljs-type">int</span></span> objectTempRaw = tempRaw[<span class="hljs-number"><span class="hljs-number">0</span></span>] + (tempRaw[<span class="hljs-number"><span class="hljs-number">1</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-type"><span class="hljs-type">int</span></span> ambientTempRaw = tempRaw[<span class="hljs-number"><span class="hljs-number">2</span></span>] + (tempRaw[<span class="hljs-number"><span class="hljs-number">3</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>); <span class="hljs-type"><span class="hljs-type">float</span></span> objectTempCelsius = convertCelsius(objectTempRaw); <span class="hljs-type"><span class="hljs-type">float</span></span> ambientTempCelsius = convertCelsius(ambientTempRaw); <span class="hljs-keyword"><span class="hljs-keyword">System</span></span>.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>.println(String.format(" Temp: Object = %fC, Ambient = %fC", objectTempCelsius, ambientTempCelsius)); Thread.sleep(<span class="hljs-number"><span class="hljs-number">1000</span></span>); }</code> </pre> <br>  During this cycle, the temperature information received from the Bluetooth LE sensor will be displayed: <br><br><pre> <code class="hljs javascript">Temp raw = {<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>b,c8,<span class="hljs-number"><span class="hljs-number">0</span></span>d,} Temp: <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> = <span class="hljs-number"><span class="hljs-number">22.125000</span></span>C, Ambient = <span class="hljs-number"><span class="hljs-number">25.562500</span></span>C Temp raw = {<span class="hljs-number"><span class="hljs-number">10</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>b,c8,<span class="hljs-number"><span class="hljs-number">0</span></span>d,} Temp: <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> = <span class="hljs-number"><span class="hljs-number">22.125000</span></span>C, Ambient = <span class="hljs-number"><span class="hljs-number">25.562500</span></span>C Temp raw = {<span class="hljs-number"><span class="hljs-number">04</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>b,cc,<span class="hljs-number"><span class="hljs-number">0</span></span>d,} Temp: <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> = <span class="hljs-number"><span class="hljs-number">22.031250</span></span>C, Ambient = <span class="hljs-number"><span class="hljs-number">25.593750</span></span>C ... Temp raw = {<span class="hljs-number"><span class="hljs-number">34</span></span>,<span class="hljs-number"><span class="hljs-number">0</span></span>b,cc,<span class="hljs-number"><span class="hljs-number">0</span></span>d,} Temp: <span class="hljs-built_in"><span class="hljs-built_in">Object</span></span> = <span class="hljs-number"><span class="hljs-number">22.406250</span></span>C, Ambient = <span class="hljs-number"><span class="hljs-number">25.593750</span></span>C</code> </pre> <br><h2>  <font color="#0071c5">Results</font> </h2><br>  We talked about how to write Java applications that can work with Bluetooth LE devices.  It should be noted that the API used in this example is based on TinyB v0.3.  This version of the library only supports operation in the device polling mode, but in version 0.4.  Presents a simplified API for discovering devices and services. <br><br>  We hope that what you learned today will help you in developing your own IoT projects. </div><p>Source: <a href="https://habr.com/ru/post/304782/">https://habr.com/ru/post/304782/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../304770/index.html">Python3 serials extension support</a></li>
<li><a href="../304772/index.html">If you work with government organizations</a></li>
<li><a href="../304776/index.html">The relevance of the PaaS model for electronic document management systems</a></li>
<li><a href="../304778/index.html">Platypus and Packages. Create and install programs on macOS</a></li>
<li><a href="../304780/index.html">Repost-modern: a selection of materials on how to generate high-quality content</a></li>
<li><a href="../304784/index.html">Typing the names of organizations</a></li>
<li><a href="../304786/index.html">Malicious software is used for cyber espionage over users in Central and Eastern Europe.</a></li>
<li><a href="../304788/index.html">A call from the browser: a tool for business?</a></li>
<li><a href="../304790/index.html">Error in PM error message is ineffective</a></li>
<li><a href="../304794/index.html">First look at the new Cisco Firepower Threat Defense software (UPD 02.09.16)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>