<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>We use Yii2 migrations for working with multiple databases</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Migrations are a convenient tool for changing the structure of the database and keeping it up to date. 

 Yii2 supports migrations out of the box. The...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>We use Yii2 migrations for working with multiple databases</h1><div class="post__text post__text-html js-mediator-article">  Migrations are a convenient tool for changing the structure of the database and keeping it up to date. <br><br>  Yii2 supports migrations out of the box.  The use of migrations is described in detail in the <a href="">documentation</a> .  Manage migrations from the command line. <br><br>  The article describes the use of migrations to manage multiple database schemas.  As it turned out, it is quite easy to implement, but for some reason did not find a single description. <br>  Often I meet projects where more than one database is used.  In this case, I want to manage each base separately.  Alternatively, you can specify in each migration which database to apply it to, or explicitly indicate the database in each request.  But this is not very convenient and there is a high probability that the migration to the wrong base will happen by chance.  In addition, the migration table will still be only in the main database. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Unfortunately, I did not find a ready-made solution, so let's look at the framework code and see how the migrations work. <br><a name="habracut"></a><br>  The yii migrate command <a href="https://github.com/yiisoft/yii2/blob/master/framework/console/Application.php">uses</a> <a href="https://github.com/yiisoft/yii2/blob/master/framework/console/controllers/MigrateController.php">yii \ console \ controllers \ MigrateController</a> <br><br>  To create a new migration, use the <a href="https://github.com/yiisoft/yii2/blob/master/framework/views/migration.php">migration.php</a> template. <br><br>  All migrations are inherited from <a href="https://github.com/yiisoft/yii2/blob/master/framework/db/Migration.php">yii \ db \ Migration</a> . <br><br>  1. To begin with, we redefine the base migration class for each database.  In the components folder, create the classes CustomMigrationDb and CustomMigrationDb2 <br><br>  <b>CustomMigrationDb2.php</b> <br><pre><code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">components</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">db</span></span>\<span class="hljs-title"><span class="hljs-title">Migration</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomMigrationDb2</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Migration</span></span></span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">init</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">$this</span></span>-&gt;db = <span class="hljs-string"><span class="hljs-string">'db2'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">parent</span></span>::init(); } }</code> </pre> <br><br>  2. In the \ views \ migrations folder we create the files migration_db.php and migration_db2.php - templates for new migrations.  Just copy the base template and change the base class to the ones we just created. <br><br>  <b>migration_db2.php</b> <br><br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-comment"><span class="hljs-comment">/** * This view is used by console/controllers/MigrateController.php * The following variables are available in this view: */</span></span> <span class="hljs-comment"><span class="hljs-comment">/* </span><span class="hljs-doctag"><span class="hljs-comment"><span class="hljs-doctag">@var</span></span></span><span class="hljs-comment"> $className string the new migration class name */</span></span> <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;?php\n"</span></span>; <span class="hljs-meta"><span class="hljs-meta">?&gt;</span></span> <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">db</span></span>\<span class="hljs-title"><span class="hljs-title">Schema</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">components</span></span>\<span class="hljs-title"><span class="hljs-title">CustomMigrationDb2</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> &lt;?= $</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">className</span></span></span><span class="hljs-class"> ?&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">CustomMigrationDb2</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">up</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">down</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"&lt;?= $className ?&gt; cannot be reverted.\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">false</span></span>; } <span class="hljs-comment"><span class="hljs-comment">/* // Use safeUp/safeDown to run migration code within a transaction public function safeUp() { } public function safeDown() { } */</span></span> }</code> </pre><br><br>  3. Now we create controllers.  In the commands folder, create the MigrateDbController and MigrateDb2Controller classes.  We inherit them from yii \ console \ controller \ MigrateController. <br><br>  <b>MigrateDb2Controller.php</b> <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-keyword"><span class="hljs-keyword">namespace</span></span> <span class="hljs-title"><span class="hljs-title">app</span></span>\<span class="hljs-title"><span class="hljs-title">commands</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">use</span></span> <span class="hljs-title"><span class="hljs-title">yii</span></span>\<span class="hljs-title"><span class="hljs-title">console</span></span>\<span class="hljs-title"><span class="hljs-title">controllers</span></span>\<span class="hljs-title"><span class="hljs-title">MigrateController</span></span>; <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MigrateDb2Controller</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">MigrateController</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $db = <span class="hljs-string"><span class="hljs-string">'db2'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $templateFile = <span class="hljs-string"><span class="hljs-string">'@app/views/migrations/migration_db2.php'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> $migrationPath = <span class="hljs-string"><span class="hljs-string">'@app/migrations/db2'</span></span>; }</code> </pre><br><br>  Here we specify the database in which the table with the migrations will be created, the template for creating new migrations and the path to the folder with the migrations. <br><br>  4. Disable the standard yii migrate, instead we will use one of the created controllers.  To do this, add the following code to the file \ config \ console.php: <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'controllerMap'</span></span> =&gt; [ ... <span class="hljs-string"><span class="hljs-string">'migrate'</span></span> =&gt; [ <span class="hljs-string"><span class="hljs-string">'class'</span></span> =&gt; <span class="hljs-string"><span class="hljs-string">'app\commands\MigrateDbController'</span></span>, ], ],</code> </pre><br><br>  <i>UPD: <a href="https://habrahabr.ru/users/zvirusz/" class="user_link">zvirusz</a> offers all the migration controllers to render in the controllerMap.</i>  <i>To do this, add this code to \ config \ console.php.</i> <i><br></i> <br><br><pre> <code class="php hljs"><span class="hljs-string"><span class="hljs-string">'controllerMap'</span></span> =&gt; [ ... <span class="hljs-string"><span class="hljs-string">'migrate'</span></span> =&gt; [ <span class="hljs-comment"><span class="hljs-comment">// Fixture generation command line. 'class' =&gt; 'yii\console\controllers\MigrateController', 'db' =&gt; 'db', 'templateFile' =&gt; '@app/views/migrations/migration_db.php', 'migrationPath' =&gt; '@app/migrations/db' ], 'migrate-db' =&gt; [ // Fixture generation command line. 'class' =&gt; 'yii\console\controllers\MigrateController', 'db' =&gt; 'db', 'templateFile' =&gt; '@app/views/migrations/migration_db.php', 'migrationPath' =&gt; '@app/migrations/db' ], 'migrate-db2' =&gt; [ // Fixture generation command line. 'class' =&gt; 'yii\console\controllers\MigrateController', 'db' =&gt; 'db2', 'templateFile' =&gt; '@app/views/migrations/migration_db2.php', 'migrationPath' =&gt; '@app/migrations/db2' ], ],</span></span></code> </pre><br><br>  As a result, we obtain independent migrations for each database.  Migrations are run by commands. <br><br> <code>yii migrate-db <br> yii migrate-db2 <br></code> <br><br>  Work as normal migrations.  New migrations are created in separate folders for each database commands. <br><br> <code>yii migrate-db/create  <br> yii migrate-db2/create <br></code> <br><br>  Wrote a <a href="https://github.com/antonshell/yii2-multiple-db-migration">small application</a> for demonstration.  Laid out on github. <br>  Thanks for attention. </div><p>Source: <a href="https://habr.com/ru/post/279701/">https://habr.com/ru/post/279701/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../279685/index.html">The digest of interesting materials for the mobile # 145 developer (March 14-20)</a></li>
<li><a href="../279687/index.html">Distribution of applications. Part 1: Creating a Formula for Homebrew</a></li>
<li><a href="../279689/index.html">2.3 Working with custom data streams</a></li>
<li><a href="../279695/index.html">Yet another instructions for obtaining the Let's Encrypt ssl certificate</a></li>
<li><a href="../279699/index.html">Security Receivers demonstrate full-featured exploit for Android</a></li>
<li><a href="../279703/index.html">How to create the perfect pull request</a></li>
<li><a href="../279705/index.html">Is there a visible border on the web?</a></li>
<li><a href="../279709/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ203 (March 14 - 20, 2016)</a></li>
<li><a href="../279711/index.html">Access problem and interesting Windows registry key</a></li>
<li><a href="../279713/index.html">Professionalism and TDD</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>