<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Responsible approach to measuring relative humidity</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we continue to talk about sensors from the Swiss company IST. Not so long ago, posts about sensors of electrical conductivity of wate...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Responsible approach to measuring relative humidity</h1><div class="post__text post__text-html js-mediator-article">  In this article, we continue to talk about sensors from the Swiss company IST.  Not so long ago, posts about <a href="https://habrahabr.ru/company/efo/blog/282235/">sensors of electrical conductivity of water</a> and <a href="https://habrahabr.ru/company/efo/blog/280031/">sensors for the velocity of the flow of liquids and gases</a> were published, today the turn has reached relative humidity. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/509/1da/e9a/5091dae9af135b3cdf324102aa40deda.gif"><br><br>  The article is devoted to high-precision sensors of the HYT series.  A description of the sensor device and the sensing element is given, the order of pairing the sensor with the microcontroller is described in detail, an example of development is given. <br><a name="habracut"></a>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h1>  1. Overview </h1><hr><br>  Standard HYT models are three sensors for measuring temperature and relative humidity, built on the basis of the same sensing element, but made in different packages. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/872/948/da9/872948da9b734f9eb8b2c9c75c7936b6.png" height="250"></div><br><br>  We will talk about other variants of the package below, but for now we will give the main characteristics of the HYT sensors. <br><table border="1" cellpadding="5" cellspacing="1"><tbody><tr><td></td><td>  <strong>Relative humidity</strong> </td><td>  <strong>Temperature</strong> </td></tr><tr><td>  Measuring range </td><td>  from 0 to 100% RH </td><td>  from -40 to +125 ¬∞ C </td></tr><tr><td>  Accuracy (maximum error) </td><td>  ¬± 1.8% RH (in the range of 0 ... 80% RH) </td><td>  ¬± 0.2 ¬∞ C (in the range of 0 ... 60 ¬∞ C) </td></tr><tr><td>  Response time </td><td>  HYT 271 &lt;4 s <br>  HYT 221 &lt;12 sec <br>  HYT 939 &lt;10 sec </td><td>  HYT 271 &lt;5 s <br>  HYT 221 &lt;12 sec <br>  HYT 939 &lt;10 sec </td></tr><tr><td>  Repeatability </td><td>  ¬± 0.2% RH </td><td>  ¬± 0.1 ¬∞ C </td></tr><tr><td>  Hysteresis </td><td>  &lt;¬± 1% RH </td><td></td></tr><tr><td>  Long term drift characteristics </td><td>  &lt;¬± 0.5% RH / year </td><td>  &lt;¬± 0.05 ¬∞ C / year </td></tr><tr><td>  Supply voltage </td><td colspan="2" rowspan="1">  2.7 - 5.5 V </td></tr><tr><td>  Current consumption </td><td colspan="2" rowspan="1">  &lt;22 ŒºA at a sampling frequency of 1 Hz, &lt;1 ŒºA in sleep mode </td></tr></tbody></table><br>  It is clear that such high accuracy and stability will not be useful in a home weather station <sup>tm</sup> .  HYT sensors are used in industry - in household appliances, in processes that are associated with drying, evaporation and distillation, in analyzers of residual moisture of various materials, in medical technology, in ventilation systems and in other "critical applications". <br><br><h1>  2. Sensitive element </h1><hr><br><img src="https://habrastorage.org/files/ac4/352/d84/ac4352d84e4e463794a3421d4e9ef180.png" align="right" height="115">  Like most modern sensors of relative humidity, HYT sensors have a capacitive sensing element.  The principles of operation of converters "humidity-capacity" and their advantages are described in a huge number of sources, let me remind you the main thing. <br><br><ul><li>  The sensing element is a capacitor whose capacitance changes in proportion to the relative humidity of the environment. </li><li>  A polymer layer is used as a dielectric, the dielectric constant of which depends on the amount of moisture absorbed by it. </li><li>  The humidity-capacity relationship is linear and allows measurements in the range from 0 to 100% RH. </li></ul><br><br><img src="https://habrastorage.org/files/4d3/81a/a70/4d381aa70ec24db7b15cf262de6cb814.png" height="250"><br><br>  The capacitive sensor is a ceramic substrate on which the lower conductive electrode, the moisture absorbing polymer and the upper electrode are sequentially located.  The output characteristic of the converter is determined by the type of polymer, as well as its thickness and area: <br><div style="text-align:center;"><img src="https://habrastorage.org/files/12e/5a6/212/12e5a62124b944bd9085060622fb27b0.png" height="45"></div><br>  <b>Œµo</b> - Electric constant.  I'm too lazy to even give its value, the point is that it is a constant <br>  <b>Œµr</b> - The dielectric constant of the polymer, changing in proportion to the amount of absorbed moisture <br>  <b>A</b> - Polymer area <br>  <b>d</b> - polymer thickness <br><br>  Depending on the purpose of the sensitive element, transducers with different characteristics are produced, made on the basis of polymers with different parameters. <br><br><img src="https://habrastorage.org/files/079/8f8/6db/0798f86db826444eb74dffc8cfcac67f" height="150" align="right">  For example, for weather probes and some other applications, high speed is an important requirement.  Reducing the response time of the sensing element is achieved by reducing the thickness of the polymer, so the response time of the P14 Rapid sensor is less than 1.5 seconds.  Another example is the MK33 sensors, designed to work with oils.  Here, by increasing the area of ‚Äã‚Äãthe sensitive element, the steepness of the output characteristic, and hence the sensor resolution, increases. <br><br>  IST produces about a dozen different capacitive transducers.  I invite those interested to follow the <a href="http://app.efo.ru/storage/efo/IST/EFO%2520-%2520Datchiki%2520otnositel%27noy%2520vlazhnosti%2520IST.pdf">link to their review</a> , and we return to the digital sensors HYT. <br><br><h1>  3. The structure of the sensors HYT </h1><hr><br>  The use of a ‚Äúbare‚Äù sensing element is justified in very few cases.  As a rule, it is simpler and more profitable to use an integrated module in which, in addition to a capacitive converter, a temperature sensor, thermal compensation and signal processing circuits, as well as a digital or analog interface are already provided.  Such digital sensors are factory calibrated and do not require additional configuration. <br><br>  Digital temperature and relative humidity sensors are produced in different price segments.  A sensor that fits the description from the previous paragraph can cost $ 2 or $ 150.  Such a difference between expensive and cheap sensors is explained by the fact that digital sensors differ not only in accuracy, speed and repeatability of measurement results, but also in other characteristics that are not so simple to ensure.  This is a long-term stability of work, the ability to use the sensor at very low or very high humidity and resistance to environmental influences.  To understand why the listed characteristics have a great influence on the cost of a component, we turn to the features of production. <br><br>  One of the main difficulties in producing digital sensors for relative humidity is the incompatibility of some processes for the production of a capacitive sensing element and semiconductor production (creating a CMOS structure containing a temperature sensor, a signal processing circuit, etc.).  Technologies do not allow to fully preserve the characteristics of a capacitive converter, if it is not made separately, but on the same substrate as the semiconductor structure.  Therefore, the manufacture of a sensor that combines a capacitive element and a digital circuit always implies a compromise between the cost of production and the characteristics of the final product. <br><br>  In the manufacture of HYT sensors, the capacitive SMD converter and the integrated circuit are manufactured separately from each other, tested separately, and only after that they are installed on a common substrate and connected with wires. <br><br><img src="https://habrastorage.org/files/ab7/ffd/c6c/ab7ffdc6c585459f82f5a16839ee7613.png" height="250"><br><br>  By reducing the mutual influence of the IC and capacitive sensor, the use of almost moisture-absorbing materials, gold conductors, as well as the use of other quality improvement measures, the digital module achieves an accuracy close to the accuracy of a separate moisture-capacity converter. <br><br><h1>  4. Calibrate the HYT sensors </h1><hr><br>  Standard factory calibration is carried out at nine points at three temperatures: <br><ul><li>  0% and 85% RH at 5 ¬∞ C </li><li>  0%, 15%, 30%, 50%, 85% RH at 30 ¬∞ C </li><li>  0% and 85% RH at 45 ¬∞ C </li></ul><br>  After calibration, control measurements are taken.  Standard control points: <br><ul><li>  85% RH at 5 ¬∞ C </li><li>  20% and 75% RH at 25 ¬∞ C </li></ul><br>  Here is the time to remind about one of the main IST chips: at the request of the customer, the manufacturer manufactures various modifications of its sensors.  Sensors with modified characteristics, products in non-standard cases and, of course, sensors with non-standard calibration are supplied.  Knowing the specifics of the application conditions of the final product, it is possible, for example, to order a HYT sensor with a calibration from 0 to 50% RH with a shift of + 2% RH over the entire range. <br><br>  Such modifications have little effect on the price and delivery time and, which is especially nice, are available for short-run products. <br><br><h1>  5. HYT sensor housing </h1><hr><br>  We give a description of the sensors series HYT. <br><br><img src="https://habrastorage.org/files/ddf/b5e/8ed/ddfb5e8ed61c47f2845d7cbfe29bec80" height="200" align="left">  The simplest module - HYT 271 - has a size of 5 to 10 mm and consists of a capacitive transducer filled with a ‚Äúblot‚Äù integrated circuit and additional capacitors.  In the absence of a protective filter, maximum speed and minimum price are achieved. <br><img src="https://habrastorage.org/files/54e/24a/680/54e24a680548494883b2c02c35bd8e01"><br><img src="https://habrastorage.org/files/cfa/a96/926/cfaa969261564f41be6f5a517035a58c" height="200" align="left">  The digital sensor HYT 221 has the same filling as the HYT 271, but is covered with a protective filter that allows the sensor to be used, including in the presence of splashing water. <br><img src="https://habrastorage.org/files/54e/24a/680/54e24a680548494883b2c02c35bd8e01"><br><br><img src="https://habrastorage.org/files/5c2/cf0/b20/5c2cf0b20c144bb18a16b4f7e86d6bf2" height="170" align="left">  The HYT 939 sensor also differs only in the type of protective filter - the components are placed under a round metal case, on the upper side of which there is an opening closed by a membrane.  Available to order is a HYT 939 module, resistant to pressure up to 16 bar. <br><img src="https://habrastorage.org/files/bc0/62f/202/bc062f202ecd47a5923059067001c42d"><br><img src="https://habrastorage.org/files/9b2/7ac/513/9b27ac513f724438acdfed5f3969c942" height="220" align="right">  In accordance with customer requirements, both the structure and the overall dimensions of the sensor can be changed.  Instead of the standard I2C interface, the sensor can be equipped with 5-pin SPI, and in addition to the digital interface, additional quasi-analog lines can be added.  The sensor leads can be extended, equipped with a connector.  Sensors are manufactured in specialized cases, for example, as in the photo. <br><br>  Ordering sensors with modified dimensions or non-standard configuration is possible, including for small-scale production. <br><br><a name="polling"></a><br><h1>  4. Order of pairing sensor and control controller </h1><hr><br>  The standard interface for connecting the HYT sensor to the control microcontroller is the I2C bus.  The controller is a master, the sensor is a slave node. <br><br>  There is nothing remarkable in the hardware characteristics of the sensor interface - speeds from 100 to 400 kHz and a standard 7-bit bus address are supported.  The default sensor address is 0x28, the address can be changed to a value from 0x00 to 0x7F.  Data is transmitted in MSB mode, i.e.  high bits first. <br><br>  I see no reason to describe the operation of the I2C bus itself.  I also miss the description of the typical switching circuit, the HYT module requirements for timing on I2C, the description of the procedure for changing the address of the sensor.  All this can be found in Wikipedia and <a href="http://www.ist-ag.com/eh/ist-ag/resource.nsf/imgref/Download_AHHYTM_E2.2.5.pdf/%2524FILE/AHHYTM_E2.2.5.pdf">documentation</a> . <br><br>  Let us dwell on the procedure for collecting data from the HYT sensor - a sequence of two commands to control the module. <br>  In the absence of requests from the microcontroller, the sensor is in sleep mode.  Upon the arrival of the 'Measuring Request ‚Äô(MR) command, it wakes up, starts a measurement cycle and generates a message with data for the controlling controller.  Data preparation takes from 60 to 100 ms, after which the ‚ÄöData Fetch '(DF) command should arrive at the sensor, according to which data from the output register of the sensor are transmitted to the microcontroller. <br><br>  The ‚ÄúMeasuring Request‚Äù command does not imply reading or writing data.  The command contains only the header packet ‚Äî the address of the slave node and the RW bit set to ‚Äú0‚Äù, i.e.  on the record. <br><br><img src="https://habrastorage.org/files/b0d/8e2/8df/b0d8e28df6654b7291f318ec73b38c13.png" height="130"><br><br>  The ‚ÄöData Fetch '(DF) command is used to read data.  The header file contains the address of the sensor and the RW bit set to "1", i.e.  for reading. <br><br><img src="https://habrastorage.org/files/10e/72a/a13/10e72aa13b694535baa3c11452a1cde9.png"><br><br>  The maximum number of bytes that must be taken on a microcontroller is four.  The first two bytes contain data on relative humidity, the third and fourth - on temperature. <br><br>  The microcontroller can request only the first two bytes (humidity data only) or the first three bytes (humidity data and high-order bits of the temperature value). <br><br>  Both humidity and temperature account for 14 bits.  The Data Fetch package also contains two status bits: <br><ul><li>  CMode Bit.  If set to "1", then the sensor is in command mode - in service mode, which is used to change the address of the sensor on I2C </li><li>  Stale bit.  If "1" is set, then after performing the next measurement cycle, the same temperature and humidity values ‚Äã‚Äãare obtained as after the previous cycle </li></ul><br><br>  Processing the received parcel consists in calculating the values ‚Äã‚Äãof temperature and relative humidity from the input data.  First, the status bits are masked, then the absolute values ‚Äã‚Äãof temperature and relative humidity are calculated from the obtained data: <br><br>  RH [%] = (100 / (2 <sup>14</sup> - 1)) * RH <sub>in</sub> <br>  T [¬∞ C] = (165 / (2 <sup>14</sup> - 1)) * T <sub>in</sub> - 40 <br><br><h1>  5. An example of enabling the HYT sensor </h1><hr><br>  From theory to practice.  Consider the task of polling the HYT sensor from the debug board EFM32ZG-STK3200 from Silicon Labs, a detailed description of which was provided in <a href="https://habrahabr.ru/company/efo/blog/277899/">a previous article</a> . <br><br>  This time, on the debug board, we will need a built-in LCD display, a mechanical button and a 20-pin connector with I2C signals, power and ground. <br><br><img src="https://habrastorage.org/files/a6d/dd6/1a2/a6ddd61a24a045fb814388ba1c97dc89.png" height="250"><br><br>  <b>Connection</b> <br><br>  We connect the lines in accordance with the pinout of the sensor and the board connector. <br><br>  For operation of the I2C bus on both its lines, pull-up resistors should be provided.  The <a href="https://www.ist-ag.com/sites/default/files/AHHYTM_E.pdf">HYT sensor documentation</a> lists 2.2 kŒ© ratings, and the circuit was originally assembled using two separate resistors.  However, during the debugging process, it turned out that to interrogate a sensor connected to short leads, it is enough to use the built-in pull-up resistors of the EFM32 microcontroller.  Their nominal is 40 kŒ©. <br><br><img src="https://habrastorage.org/web/709/350/783/709350783cd94fae8280f32e03b6793b.png" height="200"><br><br>  In this case, the sensor is powered from the power line MK (3.3 V), but five-volt levels are also permissible. <br><br>  <b>Microcontroller Programming</b> <br><br>  To work with the debug card EFM32ZG-STK3200, Simplicity Studio is used - a platform containing an IDE, examples of programs, documentation and various utilities for developing an application.  Her description can also be found in <a href="https://habrahabr.ru/company/efo/blog/277899/">previous</a> <a href="https://habrahabr.ru/company/efo/blog/277491/">articles</a> , here I‚Äôll just say that it is a free program that SiLabs distributes to work with SiLabs controllers. <br><br>  When creating the program, the ready-made I2C driver from SiLabs and the glib library, designed to work with the LCD built into the plan, are used.  The SPI interface and the real-time clock are used to communicate with the display, however, work with these modules is hidden in the depths of glib. <br><br>  The program implements the simplest aglorhythm of the HYT sensor survey - by pressing the PB1 button, we receive data from the sensor on temperature and humidity, recalculate the values ‚Äã‚Äãobtained in degrees Celsius and percentages and display them on the screen.  In case an error occurred while receiving data, a corresponding message is displayed. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/9bd/458/00d/9bd45800da56ae54633c8b3e55f3f7ce.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/251/120/1e0/2511201e08b8a6849e56b75b2c075da4.jpg" alt="image"><img src="https://habrastorage.org/getpro/habr/post_images/f1f/42b/69f/f1f42b69fa14420ce2c86d6fb4064302.jpg" alt="image"><br><br>  Full source code is available on <a href="">github</a> .  Below we analyze only the part of the program that is related to polling the sensor, i.e.  to I2C communication. <br>  Basically, the standard library functions from Silicon Labs are used - the main <a href="https://siliconlabs.github.io/Gecko_SDK_Doc/efm32zg/html/group__I2C.html">em_i2c</a> package and its <a href="https://siliconlabs.github.io/Gecko_SDK_Doc/efm32zg/html/group__I2CSPM.html">i2cspm</a> add- <a href="https://siliconlabs.github.io/Gecko_SDK_Doc/efm32zg/html/group__I2CSPM.html">in</a> . <br><br>  For communication with the sensor, i.  implementation commands Measuring Request and Data Fetch, serve the same function. <br><br>  Each of them contains operations on the formation of a packet for I2C and the command to send a packet.  To form a packet, the I2C_TransferSeq_TypeDef structure is used, which contains the sensor address, the value of the RW bit, and the register format for receiving (buf [0]) and transmitting (buf [1]) I2C data. <br><br><pre><code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span><span class="hljs-comment"><span class="hljs-comment">/** * Start a measuring cycle (Measurement Request command) * - [6-bit address] + [W flag] * - w/o data transfer *****************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">performMRCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { I2C_TransferSeq_TypeDef seq; seq.addr = HYT_ADDR; seq.flags = I2C_FLAG_WRITE; seq.buf[<span class="hljs-number"><span class="hljs-number">0</span></span>].len = <span class="hljs-number"><span class="hljs-number">0</span></span>; seq.buf[<span class="hljs-number"><span class="hljs-number">1</span></span>].len = <span class="hljs-number"><span class="hljs-number">0</span></span>; I2CSPM_Transfer(I2C0, &amp;seq); }</code> </pre> <br><br>  The function performDFCommand, in addition to indicating that a four-byte packet has been received with data written to the I2CdataToRead array, contains an algorithm for processing the received message.  As a result of the conversion, the required values ‚Äã‚Äãare written to the temperature and humidity variables. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span><span class="hljs-comment"><span class="hljs-comment">/** * Fetch the last measured value of Humidity / Temperature (Data Fetch command) * - [6-bit address] + [R flag] * - w/ 4-byte data transfer: [CMode bit] + [State bit] + [14 bit humididty] + * + [14 bit temeprature] + [2 insignificant bits] *****************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-function">int8_t </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">performDFCommand</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { I2C_TransferSeq_TypeDef seq; uint8_t I2CdataToRead[<span class="hljs-number"><span class="hljs-number">4</span></span>]; unsigned <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> tempRawData, humididtyRawData; seq.addr = HYT_ADDR; seq.flags = I2C_FLAG_READ; seq.buf[<span class="hljs-number"><span class="hljs-number">0</span></span>].data = I2CdataToRead; seq.buf[<span class="hljs-number"><span class="hljs-number">0</span></span>].len = <span class="hljs-number"><span class="hljs-number">4</span></span>; seq.buf[<span class="hljs-number"><span class="hljs-number">1</span></span>].len = <span class="hljs-number"><span class="hljs-number">0</span></span>; I2CSPM_Transfer(I2C0, &amp;seq); uint8_t sensorCModeBit = (I2CdataToRead[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0x80</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">7</span></span>; uint8_t sensorStateBit = (I2CdataToRead[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0x40</span></span>) &gt;&gt; <span class="hljs-number"><span class="hljs-number">6</span></span>; tempRawData = ((I2CdataToRead[<span class="hljs-number"><span class="hljs-number">2</span></span>] &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | I2CdataToRead[<span class="hljs-number"><span class="hljs-number">3</span></span>]) &gt;&gt; <span class="hljs-number"><span class="hljs-number">2</span></span>; humididtyRawData = ((I2CdataToRead[<span class="hljs-number"><span class="hljs-number">0</span></span>] &amp; <span class="hljs-number"><span class="hljs-number">0x3F</span></span>) &lt;&lt; <span class="hljs-number"><span class="hljs-number">8</span></span>) | I2CdataToRead[<span class="hljs-number"><span class="hljs-number">1</span></span>]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensorCModeBit == <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HYT_COMMAND_MODE; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (tempRawData != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; humididtyRawData != <span class="hljs-number"><span class="hljs-number">0</span></span> &amp;&amp; tempRawData &lt; <span class="hljs-number"><span class="hljs-number">0x3FFF</span></span> &amp;&amp; humididtyRawData &lt; <span class="hljs-number"><span class="hljs-number">0x3FFF</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sensorStateBit != <span class="hljs-number"><span class="hljs-number">1</span></span>) { <span class="hljs-comment"><span class="hljs-comment">/* temperature as 14bit-value in the range from -40¬∞C to +125¬∞C */</span></span> temperature = ((<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) (tempRawData) * <span class="hljs-number"><span class="hljs-number">165.0F</span></span> / <span class="hljs-number"><span class="hljs-number">16383.0F</span></span>) - <span class="hljs-number"><span class="hljs-number">40.0F</span></span>; <span class="hljs-comment"><span class="hljs-comment">/* humidity as 14bit-value in the range from 0%rH to 100%rH */</span></span> humidity = (<span class="hljs-keyword"><span class="hljs-keyword">float</span></span>) humididtyRawData * <span class="hljs-number"><span class="hljs-number">100.0F</span></span> / <span class="hljs-number"><span class="hljs-number">16383.0F</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-comment"><span class="hljs-comment">/* No new value has been created since the last reading */</span></span> } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HYT_IS_OK; } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> HYT_ERROR; } }</code> </pre> <br><br>  When working with ready-made library functions for I2C from SiLabs, there are two main ways to spoil your life: <br><br>  <u>Method 1</u> : Calculate that 0x28 should be written to HYT_ADDR, i.e.  the sensor address specified in the <a href="https://www.ist-ag.com/sites/default/files/AHHYTM_E.pdf">documentation</a> . <br>  Let me remind you that the address on the I2C bus is seven bits, i.e.  0x28 in the documentation means 010 1000. It would be logical to supplement this number with the high bit ‚Äú0‚Äù and still have 0x28, however the library function for some reason considers that the address is not the low, but the high 7 bits.  Thus, instead of <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HYT_ADDR 0x28</span></span></code> </pre>  should indicate <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HYT_ADDR 0x50</span></span></code> </pre>  or <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> HYT_ADDR 0x51</span></span></code> </pre><br>  <u>Method 2</u> : Calculate that I2C_FLAG_READ is ‚Äú0‚Äù and I2C_FLAG_WRITE is ‚Äú1‚Äù, which is provided by the bus protocol.  That is, in fact, everything is as it is, in the header byte of the I2C package there is a single RW bit, which is set to ‚Äú0‚Äù for data recording and to ‚Äú1‚Äù for reading data.  However, in the depths of the em_lib library, such insidious defaults are hidden here: <br><pre> <code class="cs hljs"><span class="hljs-meta"><span class="hljs-meta">#</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> I2C_FLAG_WRITE 0x0001 #</span><span class="hljs-meta-keyword"><span class="hljs-meta"><span class="hljs-meta-keyword">define</span></span></span><span class="hljs-meta"> I2C_FLAG_READ 0x0002</span></span></code> </pre>  So, it is not necessary to set zeros and ones when forming the I2C_TransferSeq_TypeDef structure. <br><br>  The rest of the claims to em_i2c and other packages em _ *** did not arise. <br><br>  There must be a delay between calls to the performMRCommand () and performDFCommand () functions, for which the sensor generates a message with the measurement results. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span><span class="hljs-comment"><span class="hljs-comment">/** * Read temperature and humidity from HYT sensor, show result on the display * - Send MR (Measurement Requests) command * - Wait for 100 msec * - Send DF (Data Fetch) command * - Show result OR show error message *****************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ReceiveDataAndShowIt</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { performMRCommand(); delay100ms(); int8_t HYT_result = performDFCommand(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HYT_result == HYT_IS_OK) { Display_ShowValues(temperature, humidity); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HYT_result == HYT_COMMAND_MODE) { Display_ShowCMode(); } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (HYT_result == HYT_ERROR) { Display_ShowError(); } }</code> </pre><br><br>  We call the ReceiveDataAndShowIt () function, which polls the sensor and displays the measurement results, from the interrupt handler, which is shown below. <br><br><pre> <code class="cs hljs"><span class="hljs-comment"><span class="hljs-comment">/**************************************************************************/</span></span><span class="hljs-comment"><span class="hljs-comment">/** * GPIO Interrupt handler (pushbutton # 1) * - Receive HYT data &amp; show results on the display *****************************************************************************/</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GPIO_ODD_IRQHandler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">void</span></span></span></span></span><span class="hljs-function">)</span></span> { uint32_t interruptMask = GPIO_IntGet(); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (interruptMask &amp; (<span class="hljs-number"><span class="hljs-number">1</span></span> &lt;&lt; BUTTON_PIN)) { Display_WellcomeScreen(); ReceiveDataAndShowIt(); } GPIO_IntClear(interruptMask); }</code> </pre><br><br>  It is important to note here that this program performs a rather trivial task.  To measure the temperature and humidity of the air, which almost do not change in time, any inexpensive sensor will work. <br><br>  The outstanding characteristics of the HYT series are much better illustrated in dynamics.  The video below shows how quickly the HYT-271 responds to changes in air humidity. <br><br><iframe width="560" height="315" src="https://www.youtube.com/embed/nYildtT047Y" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen=""></iframe><br><br>  If you have had the honor of ever observing how quickly the conditional DHT22 reacts to changes in humidity, then, of course, you will feel the difference. <br><br>  PS The process of creating a prototype, which is demonstrated in the video, is devoted to a series of articles " <a href="https://habrahabr.ru/company/efo/blog/308440/">How to stop being afraid and fall in love with mbed</a> " <br><br><h1>  6. Conclusion </h1><hr><br>  In conclusion, I traditionally thank the reader for his attention and remind you that questions about the use of products, about which we write on Habr√©, can also be asked by email, specified in my profile. </div><p>Source: <a href="https://habr.com/ru/post/303350/">https://habr.com/ru/post/303350/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../303340/index.html">Entertaining C #</a></li>
<li><a href="../303342/index.html">Algorithm for calculating the real roots of polynomials</a></li>
<li><a href="../303344/index.html">The book "A good interface is an invisible interface"</a></li>
<li><a href="../303346/index.html">SQL Server 2016 Stretch Database</a></li>
<li><a href="../303348/index.html">Implementation of code style in development</a></li>
<li><a href="../303352/index.html">Proper use of require in node.js</a></li>
<li><a href="../303354/index.html">Music as a startup, or why iTunes is evil</a></li>
<li><a href="../303358/index.html">Russia's place in the global digital transformation</a></li>
<li><a href="../303360/index.html">We work with a budget institution. Part 1</a></li>
<li><a href="../303362/index.html">Why do those who work a little have higher productivity?</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>