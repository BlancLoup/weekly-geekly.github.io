<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>The append (x) .append (y) call chain in StringBuilder is faster than typical sb.append (x); sb.append (y)</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hello everyone, to the last article about the legacy of StringBuffer in the comments left an interesting link . This article has an interesting benchm...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>The append (x) .append (y) call chain in StringBuilder is faster than typical sb.append (x); sb.append (y)</h1><div class="post__text post__text-html js-mediator-article">  Hello everyone, to the <a href="https://habrahabr.ru/post/329956/">last article about the legacy of StringBuffer</a> in the comments left an <a href="http://alblue.bandlem.com/2016/04/jmh-stringbuffer-stringbuilder.html">interesting link</a> .  This article has an interesting benchmark, which I changed to make it more dramatic: <br><br><pre><code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.Throughput) <span class="hljs-meta"><span class="hljs-meta">@Fork</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Thread) <span class="hljs-meta"><span class="hljs-meta">@Warmup</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">10</span></span>, time = <span class="hljs-number"><span class="hljs-number">1</span></span>, batchSize = <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Measurement</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">40</span></span>, time = <span class="hljs-number"><span class="hljs-number">1</span></span>, batchSize = <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Chaining</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String a1 = <span class="hljs-string"><span class="hljs-string">"111111111111111111111111"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String a2 = <span class="hljs-string"><span class="hljs-string">"222222222222222222222222"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String a3 = <span class="hljs-string"><span class="hljs-string">"333333333333333333333333"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">typicalChaining</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder().append(a1).append(a2).append(a3).toString(); } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noChaining</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ StringBuilder sb = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> StringBuilder(); sb.append(a1); sb.append(a2); sb.append(a3); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sb.toString(); } }</code> </pre> <br>  Result: <br><br><pre> <code class="java hljs">Benchmark Mode Cnt Score Error Units Chaining.noChaining thrpt <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">8408.703</span></span> ¬± <span class="hljs-number"><span class="hljs-number">214.582</span></span> ops/s Chaining.typicalChaining thrpt <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">35830.907</span></span> ¬± <span class="hljs-number"><span class="hljs-number">1277.455</span></span> ops/s</code> </pre> <br>  So, concatenating through the <code>sb.append().append()</code> call chain is 4 times faster ... The author from the article above states that the difference is due to the fact that in the case of the call chain less bytecode is generated and, accordingly, it runs faster. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Well, let's check. <br><a name="habracut"></a><br><h3>  Difference in bytecode? </h3><br>  The hypothesis can be easily tested without <a href="">going</a> into the byte code - create a typical <a href="">UriBuilder</a> : <br><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UriBuilder</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String schema; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String host; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String path; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> UriBuilder </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setSchema</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String schema)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.schema = schema; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>; } ... <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">toString</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> schema + <span class="hljs-string"><span class="hljs-string">"://"</span></span> + host + path; } }</code> </pre> <br>  And repeat the benchmark: <br><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@BenchmarkMode</span></span>(Mode.Throughput) <span class="hljs-meta"><span class="hljs-meta">@Fork</span></span>(<span class="hljs-number"><span class="hljs-number">1</span></span>) <span class="hljs-meta"><span class="hljs-meta">@State</span></span>(Scope.Thread) <span class="hljs-meta"><span class="hljs-meta">@Warmup</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">10</span></span>, time = <span class="hljs-number"><span class="hljs-number">1</span></span>, batchSize = <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-meta"><span class="hljs-meta">@Measurement</span></span>(iterations = <span class="hljs-number"><span class="hljs-number">40</span></span>, time = <span class="hljs-number"><span class="hljs-number">1</span></span>, batchSize = <span class="hljs-number"><span class="hljs-number">1000</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">UriBuilderChaining</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String host = <span class="hljs-string"><span class="hljs-string">"host"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String schema = <span class="hljs-string"><span class="hljs-string">"http"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String path = <span class="hljs-string"><span class="hljs-string">"/123/123/123"</span></span>; <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">chaining</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UriBuilder().setSchema(schema).setHost(host).setPath(path).toString(); } <span class="hljs-meta"><span class="hljs-meta">@Benchmark</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">noChaining</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ UriBuilder uriBuilder = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> UriBuilder(); uriBuilder.setSchema(schema); uriBuilder.setHost(host); uriBuilder.setPath(path); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> uriBuilder.toString(); } }</code> </pre> <br>  If the reason is really in the amount of bytecode, then even on such a heavy operation as string concatenation, we should see the difference. <br><br>  Result: <br><br><pre> <code class="java hljs">Benchmark Mode Cnt Score Error Units UriBuilderChaining.chaining thrpt <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">35797.519</span></span> ¬± <span class="hljs-number"><span class="hljs-number">2051.165</span></span> ops/s UriBuilderChaining.noChaining thrpt <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">36080.534</span></span> ¬± <span class="hljs-number"><span class="hljs-number">1962.470</span></span> ops/s</code> </pre><br>  Hmm ... The difference is at the level of error.  So the bytecode amount has nothing to do with it.  Since the anomaly is manifested with <code>StringBuilder</code> and <code>append()</code> , then this is probably due to the well-known JVM option <code>+XX:OptimizeStringConcat</code> .  Let's check.  Repeat the very first test, but with the option disabled. <br><br>  In JMH through annotations you can do it like this: <br><br><pre> <code class="hljs kotlin"><span class="hljs-meta"><span class="hljs-meta">@Fork(value = 1, jvmArgsAppend = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"-XX:-OptimizeStringConcat"</span></span></span><span class="hljs-meta">)</span></span></code> </pre> <br>  Repeat the first test: <br><br><pre> <code class="java hljs">Benchmark Mode Cnt Score Error Units Chaining.noChaining thrpt <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">7598.743</span></span> ¬± <span class="hljs-number"><span class="hljs-number">554.192</span></span> ops/s Chaining.typicalChaining thrpt <span class="hljs-number"><span class="hljs-number">40</span></span> <span class="hljs-number"><span class="hljs-number">7946.422</span></span> ¬± <span class="hljs-number"><span class="hljs-number">313.967</span></span> ops/s</code> </pre> <br>  Bingo! <br><br>  Since joining strings with <code>x + y</code> quite a frequent operation in any application - the Hotspot JVM finds <code>new StringBuilder().append(x).append(y).toString()</code> patterns in bytecode and <a href="">replaces them with optimized machine code</a> , without creating intermediate objects. <br><br>  Unfortunately, this optimization does not apply to <code>sb.append(x); sb.append(y);</code> <code>sb.append(x); sb.append(y);</code>  .  The difference on large lines can be on the order. <br><br><h3>  findings </h3><br>  Use the ‚Äúchain of call‚Äù pattern where possible.  First, in the case of <code>StringBuilder</code> this will help the JIT to optimize string concatenation.  Secondly, less bytes of code are generated this way and it can really help to inline your method in some cases. <br><br>  <a href="https://stackoverflow.com/questions/44334233/why-is-the-stringbuilder-chaining-pattern-sb-appendx-appendy-faster-than-reg">Question on SO</a> <br>  <a href="https://youtu.be/SZFe3m1DV1A">Related report</a> with dirty details from Shipilev. </div><p>Source: <a href="https://habr.com/ru/post/330220/">https://habr.com/ru/post/330220/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../330208/index.html">Understanding the new architectural components in Android</a></li>
<li><a href="../330210/index.html">Deploying Redmine with Capistrano</a></li>
<li><a href="../330214/index.html">The universal function of creating objects on the example of the implementation of $ injector.instantiate in angularjs</a></li>
<li><a href="../330216/index.html">Results of half a day! Break voting on RIT ++ for 50 stickers. Day two</a></li>
<li><a href="../330218/index.html">We roll the "resin ball" or create your own assembly rules using Qbs</a></li>
<li><a href="../330222/index.html">"MDM vs CRM" or who will help sell more?</a></li>
<li><a href="../330224/index.html">‚ÄúThis is not about money and development‚Äù: 5 misconceptions about the work of the community manager</a></li>
<li><a href="../330226/index.html">Global DevOps Bootcamp + video compilation</a></li>
<li><a href="../330228/index.html">What are interactive systems, or something about elise</a></li>
<li><a href="../330230/index.html">Another ex-employee sued Forbes 4 million rubles for unlawful dismissal</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>