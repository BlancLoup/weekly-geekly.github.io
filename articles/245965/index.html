<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Migration from Proxmox to VMmanager</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Hosters, already grown from a home server with 1-2 virtual servers to several high-performance servers in DC, think about automating routine actions a...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Migration from Proxmox to VMmanager</h1><div class="post__text post__text-html js-mediator-article">  Hosters, already grown from a home server with 1-2 virtual servers to several high-performance servers in DC, think about automating routine actions and administering virtual servers. <br>  The most popular free virtualization manager is Proxmox. <br>  With its advantages (it is free, open source and community), it also has disadvantages, which more than overlap these advantages: <br><br><img src="https://habrastorage.org/files/2f2/213/1ea/2f22131ea8074917a2c7dbd6c5700cde.png"><br><a name="habracut"></a><br><ul><li>  Paid updates </li><li>  Paid technical support </li><li>  Lack of official Russian documentation </li><li>  Non-professional localization </li><li>  Relative complexity of installation </li><li>  All additional features and integration - paid </li><li>  Many components are created by third-party developers. </li></ul><br><img src="https://habrastorage.org/files/199/22b/38d/19922b38d44047b8975593c4d94a5075.png"><br><br>  It is quite difficult to switch from the usual software to something new, besides studying a new software product, it is necessary to migrate all the data.  This is a very difficult step and you should approach it as thoroughly as possible.  Not rarely, the choice of free or less expensive products results in additional expenses for adding the necessary functionality, integration with other software, localization, and the like. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Using the ISPsystem software products, the hoster can receive full automation of the entire process of providing services to its customers. <br><br>  In this article I will tell you how to move virtual machines from Proxmox under the control of VMmanager.  VMmanager does not support importing or migrating containers and virtual servers from other virtualization managers.  But it is not difficult to do this using the VMmanager API. <br>  Consider the option of migrating containers from Proxmox to VMmanager-OVZ. <br><br>  <b>Migrating containers from Proxmox to VMmanager-OVZ.</b> <br><br>  Migration is simplified by the fact that it can be done on a single server. <br>  VMmanager-OVZ is installed without any problems on the same server where Proxmox works without any interference with the operation of containers. <br><br>  To do this, download and run the file installer - <br>  <a href="">http://download.ispsystem.com/install.5.sh</a> <br>  then answer a few questions for choosing the desired software product and its version. <br>  The official repository will also automatically connect and the installation of the control panel and related software will begin. <br>  Please note that the openvz settings from proxmox are used without any problems in VMmanager-OVZ. <br>  The only note is: after installing VMmanager-OVZ, you need to manually download an example configuration file for openvz.  It is required to create a container, and is missing from the proxmox distribution, so you will see the following error in the logs when you try to create a container: <br><br>  2014-12-03T10: 39: 28 + 0800 vzctl: CT 100: Sample config /etc/pve/openvz/ve-basic.conf-sample not found: No such file or directory <br>  2014-12-03T10: 39: 28 + 0800 vzctl: CT 100: Creation of container private area failed <br><br>  Download the sample configuration file for openvz from the official repository and put it in the directory where it should be: <br><br>  # wget --no-check-certificate <a href="https://github.com/blueboxgroup/vzctl/blob/master/etc/conf/ve-basic.conf-sample">github.com/blueboxgroup/vzctl/blob/master/etc/conf/ve-basic.conf-sample</a> -O /etc/pve/openvz/ve-basic.conf-sample <br><br>  I want to draw attention to one moment during the transfer.  There is a possibility that the identification numbers of containers may not match. <br>  In both cases, the numbering starts from 100. Although in Proxmox you can select an arbitrary ID for the container being created, in VMmanager this counter starts from 100 and is not reset, after removing all containers, the numbering continues from the number that is subsequent to the deleted ones.  There is one solution to this account: you need to delete all the previously created virtual servers and abort the vmmgr process, then the numbering will start first. <br><br>  <b>Setting parameters in VMmanager-OVZ</b> <br><br><ul><li>  Create an admin user to manage containers </li><li>  Create a user - owner of containers </li><li>  Create an address space from which IP addresses will be issued for containers to be created.  Settings -&gt; IP Address Base </li><li>  In the example, I use the subnet 192.168.0.0/24, since the containers on the Proxmox use the same address range. </li><li>  In ‚ÄúCluster Settings‚Äù =&gt; ‚ÄúContainer Templates‚Äù create a template, the parameters from which will be used by default for all created containers. </li></ul><br><br><img src="https://habrastorage.org/files/24a/c9e/5e3/24ac9e5e34fc4313ad4f5db0ad1f9a20.png"><br>  <i>Create a container template with default settings.</i> <br><br>  Proxmox lacks such concepts as a range of IP addresses and templates for creating containers.  When creating each new container, you must manually specify both the IP address and the resources available for the new container. <br>  In VMmanager, these actions are standardized and made as convenient as possible.  It is required to create several tariff templates and a range of IP addresses once.  When a container is created, an IP address is automatically assigned, and resources are specified by selecting the appropriate template. <br><br><img src="https://habrastorage.org/files/22a/d67/a62/22ad67a6288641efb0a6bd6e541c1baf.png"><br>  <i>Container creation in Proxmox</i> <br><br><img src="https://habrastorage.org/files/95f/2cf/5f2/95f2cf5f2c2d459683cecad9e8a5d4c0.png"><br>  <i>Creating a container in VMmanager</i> <br><br>  Transferring containers is complicated by the fact that both virtual server managers use different methods for storing information about the resources of the managed containers. <br>  Proxmox uses the openvz configuration files, VMmanager - stores everything in the mysql database, duplicating the settings in the files for openvz.  Therefore, the scheme is complicated by the need to create containers from VMmanager-OVZ and then replace this container with a container from Proxmox. <br><br>  After the settings are made, we have working copies of Proxmox and VMmanager-OVZ on the server. <br>  The rest of the migration process leads to a few simple steps: <br><ul><li>  Stopping a container created in Proxmox </li><li>  Create a container dump. </li><li>  Rename container configuration file </li><li>  Deleting or renaming container files </li><li>  Creating a container in VMmanager-OVZ with the same parameters as the portable one </li><li>  Restore dump to new container </li><li>  Launch new container </li></ul><br><br>  To simplify this process, use the sample script that I attach below. <br><br><pre><code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # for i in `vzlist -Ha|awk '{print $1}'` do PASS=`pwgen 10 1` vzctl stop $i vzdump $i -dumpdir /vz-dump/ mv /var/lib/vz/private/$i /var/lib/vz/private/$i.proxmox mv /var/lib/vz/root/$i /var/lib/vz/root/$i.proxmox mv /etc/vz/conf/$i.conf /etc/vz/conf/$i.conf.proxmox /usr/local/mgr/sbin/mgrctl -m vemgr vm.edit id=$i name=`grep HOSTNAME /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}'|awk -F. '{print $1}'` domain=`grep HOSTNAME /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}'`. iptype=public ip=`grep IP_ADDRESS /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}'` user=user1 mem=`grep PHYSPAGES /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}' |awk -F: '{print $2}'|sed -e 's/.$//'` hdd=`grep PHYSPAGES /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}' |awk -F: '{print $2}'|sed -e 's/.$//'` cpu=`grep CPUS /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}'` cpufreq=`grep CPUUNITS /etc/vz/conf/$i.conf.proxmox|awk -F'"' '{print $2}'` ostemplate=debian-6.0-i386-minimal password=$PASS confirm=$PASS preset=1 sok=ok; vzctl stop $i vzrestore /vz-dump/vzdump-openvz-$i-*.tar $i -force vzctl start $i done #</span></span></code> </pre> <br><br>  I will make a few comments about the script: <br><ol><li>  The script does not take into account the status of the container and the activation time.  After all, this is an example considered in a spherical vacuum. </li><li>  The pattern is explicitly specified - debian-6.0-i386-minimal.  Proxmox and VMmanager-OVZ container templates may not match.  But to create a container, you should use the template as a stub, then everything will overwrite the data from the dump that was made from the old container. </li><li>  The minimum number of parameters required to create a container in VMmanager-OVZ is taken from the container configuration file created in Proxmox.  If desired, the configuration file can be returned back if it used parameters other than those created by default. </li><li>  All unspecified parameters are taken from the first container template created in VMmanager-OVZ =&gt; Cluster Settings =&gt; Container Templates </li><li>  After checking the correctness of the transferred containers, backup copies of files and dumps can be deleted. </li></ol><br><br>  Now let's move on to the migration option from Proxmox with virtual servers to VMmanager-KVM. <br><br>  <b>Virtual server migrations from Proxmox to VMmanager-KVM.</b> <br><br>  Unfortunately, not everything here will go as smoothly as in the previous case. <br>  Installing VMmanager-KVM as the primary node on the same server where Proxmox is working will fail due to problems with package dependency.  Therefore, consider the migration using the second server. <br><br>  We configure VMmanager-KVM, which is not very different from what I described above for VMmanager-OVZ <br><br>  And we act according to the following algorithm: <br><br><ul><li>  copy the configuration file of the virtual machine from the Proxmox server </li><li>  create an identical virtual machine on vmmgr </li><li>  stop </li><li>  we stop on the Proxmox server </li><li>  make a copy of the vm image file </li><li>  transfer the image from the Proxmox server to the server with VMmanager-KVM and replace the old image </li><li>  we start vm in VMmanager-KVM </li></ul><br><br>  The proxmox virtual machines settings are stored in the /etc/pve/qemu-server/.conf files. <br>  Proxmox virtual machine image files are stored in the / var / lib / vz / images / directories. In order not to enter authorization data each time to connect servers using ssh-keygen, we will create a pair key and send the public key to the Proxmox server. <br><br>  cat .ssh / id_rsa.pub | ssh root @ proxmox "cat &gt;&gt; /root/.ssh/authorized_keys" <br><br>  And then everything can be done with the help of this script. <br><br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash # scp root@proxmox:/etc/pve/qemu-server/*.conf /root for i in `ls *.conf|awk -F. '{print $1}'` do PASS=`pwgen 10 1` /usr/local/mgr5/sbin/mgrctl -m vmmgr vm.edit id=$i mem=`grep memory /root/$i.conf|awk '{print $2}'` vcpu=`grep cores /root/$i.conf|awk '{print $2}'` cputune=1000 blkiotune=500 vsize=`grep size /root/$i.conf|awk -F= '{print $2}'| sed -e 's/.$//g'` name=`grep name /root/$i.conf|awk '{print $2}'` domain=`grep name /root/$i.conf|awk '{print $2}'`.`hostname` ip= iptype=public preset=1 password=$PASS confirm=$PASS installtype=installtemplate vmi=CentOS-6-amd64 sok=ok virsh shutdown `grep name /root/$i.conf|awk '{print $2}'` ssh root@proxmox ‚Äúqm stop $i‚Äù ssh root@proxmox ‚Äúcp /var/lib/vz/images/$i//vm-$i-disk-1.qcow2 /var/lib/vz/images/$i//vm-$i-disk-1.qcow2.bak‚Äù mv /vm/`grep name /root/$i.conf|awk '{print $2}'` /vm/`grep name /root/$i.conf|awk '{print $2}'`.old echo rsync -avz --partial root@proxmox:/var/lib/vz/images/100/vm-100-disk-1.qcow2 /vm/`grep name /root/$i.conf|awk '{print $2}'` virsh start `grep name /root/$i.conf|awk '{print $2}'` done #</span></span></code> </pre><br><br>  Leave a couple of comments on the script: <br><ul><li>  The server with Proxmox is listed as ‚Äúproxmox‚Äù. </li><li>  I decided to use copies of the virtual machine configuration files from Proxmox on the server with VMmanager, it seemed to me the easiest. </li><li>  When creating each virtual machine using the API, a random password is generated. </li><li>  In the 'vmi =' parameter, the template identifier is set and available for operation.  The identifiers of all installed templates can be viewed by API request via the command line: <br>  / usr / local / mgr5 / sbin / mgrctl -m vmmgr osmgr | grep 'installed = ok' | awk '{print $ 1}' | sed-e's / id = // ' </li><li>  Just as in the previous script, the server deployment time on VMmanager is not taken into account. </li><li>  Image files are transferred without any preprocessing.  Both Proxmox and VMmanager understand the qcow2 format. </li><li>  The original image file of the created VM on VMmanager is renamed and located next to it) </li></ul><br><br>  When describing the possibilities of transferring containers and virtual machines, the proxmox test setup was used with default values ‚Äã‚Äãand the situation with the combat servers may differ.  If you have experience with real-life Proxmox applications and you are ready to share it, it will be very nice to see your comments.  Successful migration and maximum automation in the provision of hosting services! </div><p>Source: <a href="https://habr.com/ru/post/245965/">https://habr.com/ru/post/245965/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../245951/index.html">Interfaces What to read, how to develop</a></li>
<li><a href="../245953/index.html">Typography basics</a></li>
<li><a href="../245955/index.html">Samsung introduced a new line of SSD 850 EVO with 3-bit flash memory chips V-NAND</a></li>
<li><a href="../245961/index.html">How i hacked facebook</a></li>
<li><a href="../245963/index.html">Data center with container</a></li>
<li><a href="../245967/index.html">Live webcast IT Pro Community Day December 17</a></li>
<li><a href="../245969/index.html">Deploy4Me reduces prices and fixes them in rubles</a></li>
<li><a href="../245975/index.html">Exporting data from PostgreSQL to Excel</a></li>
<li><a href="../245977/index.html">Why data centers need operating systems</a></li>
<li><a href="../245979/index.html">Profile the code with Cach√© Monitor</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>