<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>MongoDB and C # driver from 10gen, unobvious moments</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Under the cat, partial loading of objects, search for an object by an element of an array nested in it, and some identifiers. Things that somehow took...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>MongoDB and C # driver from 10gen, unobvious moments</h1><div class="post__text post__text-html js-mediator-article"><img width="200" src="https://habrastorage.org/storage/9d5682d8/17b7225d/dd77ffc3/283613e1.png"><br>  Under the cat, partial loading of objects, search for an object by an element of an array nested in it, and some identifiers.  Things that somehow took away my time to investigate how it works, and sometimes to dig into the source code of the driver when using MongoDB in a real project. <br><a name="habracut"></a><br>  After the first <a href="http://alexeysuvorov.wordpress.com/2010/12/20/mongodb-cssharp-driver/" title="http://alexeysuvorov.wordpress.com/2010/12/20/mongodb-cssharp-driver/">post about mongodb,</a> I switched to f # for a few weeks and when I returned, I realized that everything was forgotten.  I had to re-read my own post, and apparently not one has to disassemble the Mongo, since even <a href="http://nesteruk.wordpress.com/" title="http://nesteruk.wordpress.com/">Dmitry Nesteruk</a> stuck to me like.  Lyrical digression ended.  Immediately make a reservation, in this article, as in the previous discussion, we will focus on the driver, the link to which is posted on the Mongo website, this is the driver from 10gen. <br><br><h2>  Partial loading of objects <br></h2><br>  Starting to translate one of the real projects on Mongo, I immediately faced the need to load objects without nested collections that it contains.  It should be noted that the driver in question works very simply.  Through classes of helpers and wizards, he simply adds lines to get a working request in mongo javascript.  In order not to load some kind of field, it is enough to specify field_name: 0 in the request <br><br><blockquote><code><font color="black">db.users.find({}, {thumbnail:0});&lt;br/&gt; <br></font></code> </blockquote><br>  In the driver, everything is not so obvious, but after some digging we managed to get this code: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote> <code><font color="black">MongoCollection coll = GetCollection();&lt;br/&gt; <br> FieldsBuilder fbExclude = Fields.Exclude( <font color="#00008B">new</font> <font color="#00008B">string</font> []{‚Äúthumbnail‚Äù});&lt;br/&gt; <br> <font color="#006400">//can be FindAllAs&lt;TEntity&gt;()</font> <br> MongoCursor result = coll.FindAll().SetFields(fbExclude);&lt;br/&gt; <br></font></code> </blockquote><br>  All results in the cursor will be without a field thumbnail, checked, works great.  All unloaded fields will be initialized with default values, for collections null.  There is one subtlety here, if you don‚Äôt load any field, and then you record this object, it will completely legally grind the old one into the database and this test will drop on the last Assert: <br><br><blockquote> <code><font color="black"><font color="#00008B">public</font> <font color="#00008B">class</font> Data&lt;br/&gt; <br> {&lt;br/&gt; <br> [BsonId]&lt;br/&gt; <br> <font color="#00008B">public</font> ObjectId Id {get;set;}&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">int</font> Area {get;set;}&lt;br/&gt; <br> }&lt;br/&gt; <br> Data x = <font color="#00008B">new</font> Data();&lt;br/&gt; <br> x.Area = 20;&lt;br/&gt; <br> <font color="#00008B">var</font> db = GetDb();&lt;br/&gt; <br> <font color="#00008B">var</font> coll = db.GetCollection&lt;Data&gt;( <font color="#00008B">typeof</font> (Data).FullName);&lt;br/&gt; <br> db.ClearColl&lt;Data&gt;();&lt;br/&gt; <br> coll.Save(x);&lt;br/&gt; <br> Data y = coll.FindAllAs&lt;Data&gt;().SetFields(Fields.Exclude( <font color="#00008B">new</font> <font color="#00008B">string</font> []{ <font color="#A52A2A">"Area"</font> })).FirstOrDefault();&lt;br/&gt; <br> Assert.AreEqual(0, y.Area);&lt;br/&gt; <br> coll.Save(y);&lt;br/&gt; <br> Data z = coll.FindAllAs&lt;Data&gt;().SetFields( <br> Fields.Exclude( <font color="#00008B">new</font> <font color="#00008B">string</font> [] { <font color="#A52A2A">"Area"</font> }) <br> ).FirstOrDefault();&lt;br/&gt; <br> <font color="#006400">//fail of course</font> <br> Assert.AreEqual(20, z.Area);&lt;br/&gt; <br></font></code> </blockquote><br>  I think this is somehow solved through Find and modify, but so far such a need is not worth it and all that needs to be changed is loaded completely. <br><br><h2>  Select by nested array element <br></h2><br>  In my case, there was a task to choose a region based on the postal code of one European country.  Because  for historical reasons, the general logic did not work in all cases, the region should be determined by the following algorithm: if there is an exact match, then select the region found, if there is no match, then leave the first 2 digits and make an assumption about the region based on the range of postal codes in region, and the ranges themselves may be many.  The object looks something like this: <br><br><blockquote> <code><font color="black"><font color="#00008B">public</font> <font color="#00008B">class</font> HighLevelCodeInterval &lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">public</font> HighLevelCodeInterval() { }&lt;br/&gt; <br> &lt;br/&gt; <br> <font color="#00008B">public</font> HighLevelCodeInterval( <font color="#00008B">int</font> mn, <font color="#00008B">int</font> mx) &lt;br/&gt; <br> {&lt;br/&gt; <br> Min = mn; Max = mx;&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">int</font> Min { get; set; }&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">int</font> Max { get; set; }&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">class</font> RegionObject &lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">public</font> RegionObject() &lt;br/&gt; <br> {&lt;br/&gt; <br> PostalCodes = <font color="#00008B">new</font> List&lt; <font color="#00008B">int</font> &gt;();&lt;br/&gt; <br> }&lt;br/&gt; <br> &lt;br/&gt; <br> [BsonId]&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">int</font> Id { get; set; }&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">string</font> Name { get; set; }&lt;br/&gt; <br> <font color="#00008B">public</font> List&lt;HighLevelCodeInterval&gt; HighLevelCodes { get; set; }&lt;br/&gt; <br> <font color="#00008B">public</font> List&lt; <font color="#00008B">int</font> &gt; PostalCodes { get; set; }&lt;br/&gt; <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  Then the query of the sample for a specific code will be: <br><br><blockquote> <code><font color="black">QueryComplete q = Query.EQ( <font color="#A52A2A">"PostalCodes"</font> , postCode);&lt;br/&gt; <br> MongoCollection coll = GetCollection();&lt;br/&gt; <br> RegionObject result = coll.FindOneAs&lt;RegionObject&gt;();&lt;br/&gt; <br></font></code> </blockquote><br>  I would say unexpectedly simple.  For a range search, I‚Äôll quote only the query itself: <br><br><blockquote> <code><font color="black"><font color="#00008B">int</font> nCodeValue = ‚Ä¶;&lt;br/&gt; <br> Query.And(     &lt;br/&gt; <br> Query.LTE( <font color="#A52A2A">"HighLevelCodes.Min"</font> , nCodeValue),&lt;br/&gt; <br> Query.GTE( <font color="#A52A2A">"HighLevelCodes.Max"</font> , nCodeValue)&lt;br/&gt; <br> )&lt;br/&gt; <br></font></code> </blockquote><br>  It must be admitted that the search by nested arrays in Mongo is very worthy. <br><br><h2>  Identifiers </h2><br>  The driver supports 2 built-in generator of identifiers: for Guid and ObjectId types, i.e.  it is enough to decorate the properties of one of these types with the BsonId attribute and then everything will be done by itself.  But the identifier can be any, my integer identifiers work fine for me, but their uniqueness is monitored by a program external to Mongo.  It is also <a href="http://www.mongodb.org/display/DOCS/CSharp%2BDriver%2BSerialization%2BTutorial" title="http://www.mongodb.org/display/DOCS/CSharp+Driver+Serialization+Tutorial#CSharpDriverSerializationTutorial-WriteacustomIdgenerator">claimed</a> that there is an opportunity to write the generator itself: <br><br><blockquote> <code><font color="black"><font color="#00008B">public</font> <font color="#00008B">class</font> EmployeeIdGenerator : IIdGenerator &lt;br/&gt; <br> {&lt;br/&gt; <br> <font color="#00008B">object</font> GenerateId(){ ‚ãÆ }&lt;br/&gt; <br> <font color="#00008B">bool</font> IsEmpty( <font color="#00008B">object</font> id) { ‚ãÆ }&lt;br/&gt; <br> }&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">class</font> Employee &lt;br/&gt; <br> { &lt;br/&gt; <br> [BsonId(IdGenerator = <font color="#00008B">typeof</font> (EmployeeIdGenerator)]&lt;br/&gt; <br> <font color="#00008B">public</font> <font color="#00008B">int</font> Id { get; set; }&lt;br/&gt; <br> <font color="#006400">// other fields or properties</font> <br> }&lt;br/&gt; <br></font></code> </blockquote><br>  I myself really did not try. <br><br><h2>  Conclusion </h2><br>  Document oriented databases are not suitable for all projects.  If it does not work out beautifully, then DDD may not be applicable.  I found that one of my projects fits perfectly into DDD and is incredibly pleased with the disappearance of a huge number of tables, if everything goes well, there will soon be performance tests in the spirit of MondoDB vs MSSQL on a really working application. <br><br>  PS: I want to mention a utility that really helps to see what is written into the database as a result of the operations performed - this is <a href="http://blog.mongovue.com/" title="http://blog.mongovue.com">Mongo Vue</a> </div><p>Source: <a href="https://habr.com/ru/post/115311/">https://habr.com/ru/post/115311/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../115306/index.html">Soyuzmultfilm on YouTube</a></li>
<li><a href="../115307/index.html">DDoS when not waiting for him</a></li>
<li><a href="../115308/index.html">Cure Windows 7 affected by service pack update 1</a></li>
<li><a href="../115309/index.html">Second day Pwn2own: Firefox, Android, BlackBerry, iPhone, Windows Phone 7</a></li>
<li><a href="../115310/index.html">Torrent client "for housewives"</a></li>
<li><a href="../115312/index.html">Human v1.1</a></li>
<li><a href="../115314/index.html">SQA Days Conference: how do (not) ordinary testers change the world?</a></li>
<li><a href="../115315/index.html">Project Pheon began closed testing</a></li>
<li><a href="../115316/index.html">Presentation of iPad 2 (Russian translation)</a></li>
<li><a href="../115320/index.html">Automatic Skype Call and Voice Synthesizer</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>