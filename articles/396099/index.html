<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Home video surveillance. Implementing with Zoneminder and Debian 8</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 Good day. 

 Having a home NAS that runs on Debian 8 (I used Ubuntu Server 12.04 and 14.04 earlier), the idea arose to assign to it, am...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Home video surveillance. Implementing with Zoneminder and Debian 8</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  Good day. <br><br>  Having a home NAS that runs on Debian 8 (I used Ubuntu Server 12.04 and 14.04 earlier), the idea arose to assign to it, among other things, the role of a video surveillance server.  <a href="https://www.zoneminder.com/">Zoneminder</a> was selected as the server side.  The algorithm of video surveillance should be as follows: round-the-clock recording is not needed, but if necessary, the ability to enable recording upon the occurrence of an event is required - triggering on motion, followed by sending an email to screenshots from the scene.  This is necessary to provide control over the apartment when someone is not at home.  And, of course, you need the ability to remotely connect and check - everything is in order. <br><br>  On the developer‚Äôs site, I found a very detailed <a href="https://wiki.zoneminder.com/Debian_8_64-bit_with_Zoneminder_1.29.0_the_Easy_Way">Wiki</a> dedicated specifically to installation on Debian 8 64-bit.  Accordingly, I will take the installation instructions from there, explaining some points with my comments. <br><a name="habracut"></a><br><h4>  Installing Zoneminder </h4><br>  So, we have a server with Debian 8 64-bit installed in the minimum configuration (I used netinstall).  First you need to edit sources.list, adding Jessie backports to it: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre><code class="bash hljs">sudo nano /etc/apt/sources.list</code> </pre> <br>  At the end of the file, add: <br><br><pre> <code class="bash hljs">deb http://http.debian.net/debian jessie-backports main</code> </pre><br>  Either uncomment this line if it is already there, that is, delete # at the beginning of the line.  Update package index: <br><br><pre> <code class="bash hljs">sudo apt-get update</code> </pre><br>  Now everything is ready to install Zoneminder, which we will do: <br><br><pre> <code class="bash hljs">sudo apt-get install zoneminder</code> </pre><br>  The installation process will also automatically install Apache, MySQL, PHP. <br>  After the installation is complete, create the MySQL database: <br><br><pre> <code class="bash hljs">sudo mysql -uroot -p &lt; /usr/share/zoneminder/db/zm_create.sql</code> </pre><br>  In the process of creating the database, you will be prompted to select the root password for the database.  Then we execute the following commands sequentially (via sudo), entering the password in case of a request: <br><br><pre> <code class="bash hljs">mysql -uroot -p -e <span class="hljs-string"><span class="hljs-string">"grant all on zm.* to 'zmuser'@localhost identified by 'zmpass';"</span></span></code> </pre><br><pre> <code class="bash hljs">mysqladmin -uroot -p reload</code> </pre><br><pre> <code class="bash hljs">chmod 740 /etc/zm/zm.conf</code> </pre><br><pre> <code class="bash hljs">chown root:www-data /etc/zm/zm.conf</code> </pre><br>  Enable autorun Zoneminder: <br><pre> <code class="bash hljs">systemctl <span class="hljs-built_in"><span class="hljs-built_in">enable</span></span> zoneminder.service</code> </pre><br>  We add the user www-data to the sudo group, this is needed to access the local video cameras: <br><br><pre> <code class="bash hljs">adduser www-data sudo</code> </pre><br>  Start Zoneminder: <br><pre> <code class="bash hljs">systemctl start zoneminder.service</code> </pre><br>  Verify that Zoneminder is running: <br><pre> <code class="bash hljs">systemctl status zoneminder.service</code> </pre><br>  If everything is in order, the output of the command should be approximately as follows: <br><br><pre> <code class="bash hljs">‚óè zoneminder.service - ZoneMinder CCTV recording and surveillance system Loaded: loaded (/lib/systemd/system/zoneminder.service; enabled) Active: active (running) since  2016-07-10 18:48:30 IRKT; 5h 31min ago Process: 6413 ExecStop=/usr/bin/zmpkg.pl stop (code=exited, status=0/SUCCESS) Process: 6455 ExecStart=/usr/bin/zmpkg.pl start (code=exited, status=0/SUCCESS) Main PID: 6474 (zmdc.pl) CGroup: /system.slice/zoneminder.service ‚îú‚îÄ6474 /usr/bin/perl -wT /usr/bin/zmdc.pl startup ‚îú‚îÄ6507 /usr/bin/perl -wT /usr/bin/zmfilter.pl ‚îú‚îÄ6514 /usr/bin/perl -wT /usr/bin/zmaudit.pl -c ‚îî‚îÄ6521 /usr/bin/perl -wT /usr/bin/zmwatch.pl</code> </pre><br>  Configure Apache: <br><pre> <code class="bash hljs">a2enmod cgi</code> </pre><br><pre> <code class="bash hljs">a2enmod rewrite</code> </pre><br><pre> <code class="bash hljs">a2enconf zoneminder</code> </pre><br>  Add your time zone in PHP: <br><pre> <code class="bash hljs">sudo nano /etc/php5/apache2/php.ini</code> </pre><br>  We are looking for the [Date] section and change the date.timezone to the required one: <br><pre> <code class="bash hljs">[Date] ; Defines the default timezone used by the date <span class="hljs-built_in"><span class="hljs-built_in">functions</span></span> ; http://php.net/date.timezone date.timezone = Asia/Irkutsk</code> </pre><br>  Save - Ctrl + O, exit - Ctrl + X. <br>  Restart Apache: <br><pre> <code class="bash hljs">service apache2 restart</code> </pre><br>  To be able to manage Zoneminder via Internet Explorer, you need to install Cambozola: <br><br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> /usr/src &amp;&amp; wget http://www.andywilcock.com/code/cambozola/cambozola-latest.tar.gz</code> </pre><br><pre> <code class="bash hljs">tar -xzvf cambozola-latest.tar.gz</code> </pre><br><pre> <code class="bash hljs">replace 936 with cambozola version downloaded</code> </pre><br><pre> <code class="bash hljs">cp cambozola-0.936/dist/cambozola.jar /usr/share/zoneminder</code> </pre><br>  This completes the installation of Zoneminder.  Now you need to configure the mail transport so that Zoneminder can notify about events via email. <br><br><h4>  Setting up mail transport </h4><br>  To send notifications, Zoneminder can use ssmtp, and install it: <br><br><pre> <code class="bash hljs">sudo apt-get update</code> </pre><br><pre> <code class="bash hljs">sudo apt-get install ssmtp</code> </pre><br>  Install mailutils at the same time, if this package is not yet installed: <br><pre> <code class="bash hljs">sudo apt-get install mailutils</code> </pre><br>  Now we will configure the mail settings, on behalf of which notifications will be sent.  Suppose the mailbox is on gmail.com.  Open ssmtp.conf: <br><pre> <code class="bash hljs">sudo nano /etc/ssmtp/ssmtp.conf</code> </pre><br>  and bring to this form, indicating, respectively, your data: <br><pre> <code class="bash hljs">root=mymail@gmail.com mailhub=smtp.gmail.com:587 hostname=localhost RewriteDomain=gmail.com UseSTARTTLS=YES UseTLS=YES AuthUser=mymail@gmail.com AuthPass=myverystrongpassword</code> </pre><br>  Rule revaliases: <br><pre> <code class="bash hljs">sudo nano /etc/ssmtp/revaliases</code> </pre><br>  we lead to this form: <br><pre> <code class="bash hljs">root:pp@gmail.com:smtp.gmail.com:587 www-data:pp@gmail.com:smtp.gmail.com:587</code> </pre><br>  And we check the correctness of the settings by sending a test letter: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Hello, World"</span></span> | mail -s <span class="hljs-string"><span class="hljs-string">"My email check"</span></span> mne@napochtu.ru</code> </pre><br>  If the test was successful, go to the next step - installing MIME :: Lite and Net :: SMTP.  Check if these components are installed: <br><pre> <code class="bash hljs">perl -MMIME::Lite -e <span class="hljs-string"><span class="hljs-string">"print \"Module installed.\\n\";"</span></span></code> </pre><br><pre> <code class="bash hljs">perl -MNet::SMTP -e <span class="hljs-string"><span class="hljs-string">"print \"Module installed.\\n\";"</span></span></code> </pre><br>  Install by going to the perl shell: <br><pre> <code class="bash hljs">sudo perl -MCPAN -e shell</code> </pre><br><pre> <code class="perl hljs">install MIME::Lite install Net::SMTP</code> </pre><br><br>  Now we need to make very important changes, without which the mail transport from Zoneminder will not work.  <u><i>Please note that these changes need only be made if the version of the installed Zoneminder is 1.29 or lower.</i></u>  <u><i>Starting with version 1.30, these actions are not necessary.</i></u> <br><br>  Open the zmfilter.pl file in the editor: <br><br><pre> <code class="bash hljs">sudo nano /usr/bin/zmfilter.pl</code> </pre><br>  Turning to line 1179, we see the following: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">### Send the Message MIME::Lite-&gt;send( "smtp", $Config{ZM_EMAIL_HOST}, Timeout=&gt;60 ); $mail-&gt;send();</span></span></code> </pre><br>  Comment out the lines <pre> <code class="perl hljs">MIME::Lite-&gt;<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>( <span class="hljs-string"><span class="hljs-string">"sendmail"</span></span>, $Config<span class="hljs-string"><span class="hljs-string">{ZM_EMAIL_HOST}</span></span>, <span class="hljs-string"><span class="hljs-string">Timeout=&gt;</span></span><span class="hljs-number"><span class="hljs-number">60</span></span> );</code> </pre>  and <pre> <code class="perl hljs">$mail-&gt;<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>();</code> </pre> <br>  and add a line under them <br><pre> <code class="perl hljs">$mail-&gt;<span class="hljs-keyword"><span class="hljs-keyword">send</span></span>(<span class="hljs-string"><span class="hljs-string">'sendmail'</span></span>,<span class="hljs-string"><span class="hljs-string">'/usr/sbin/ssmtp'</span></span>,$Config<span class="hljs-string"><span class="hljs-string">{ZM_EMAIL_ADDRESS}</span></span>);</code> </pre><br>  As a result, starting from line 1179 (in my case, but not necessarily this line number), the code should look like this: <br><pre> <code class="perl hljs"><span class="hljs-comment"><span class="hljs-comment">### Send the Message #MIME::Lite-&gt;send( "sendmail", $Config{ZM_EMAIL_HOST}, Timeout=&gt;60 ); #$mail-&gt;send(); $mail-&gt;send('sendmail','/usr/sbin/ssmtp',$Config{ZM_EMAIL_ADDRESS});</span></span></code> </pre><br>  Save, exit.  This completes the work with the terminal. <br><br><h4>  Zoneminder web interface </h4><br>  Management is available at <a href="http://ip.adress.servera/zm">ip.adress.servera / zm</a> , we go.  The first thing to do is to go to Options -&gt; Users, and set the password for the admin user: <br><br><img src="https://habrastorage.org/files/c89/d15/76e/c89d1576e93e476eaceac351d8cf9adc.png"><br><br>  Then go to Options -&gt; System, and put a tick in front of OPT_USE_AUTH: <br><br><img src="https://habrastorage.org/files/c63/40a/fe4/c6340afe4f184314abb5dae0fa45210f.png"><br><br>  If you do not do this, then Zoneminder allows you to log in to the web interface or connect through a client application without asking for a username / password, which, of course, is not safe.  It is strange that this very necessary tick is not checked by default. <br><br>  Now let's set up email sending.  Go to Optons -&gt; Email and set up by analogy: <br><br><img src="https://habrastorage.org/files/a4a/33e/6f9/a4a33e6f928245778132e33b7ebda91a.png"><br><br>  In the EMAIL_BODY field, you can customize the format of notifications exactly as you need.  For example, if you add% EI1% in the field, then the first screenshot from the moment the motion sensor is triggered is attached to the message.  A full list of options for notifications is available <a href="http://zoneminder.readthedocs.io/en/stable/userguide/options/options_email.html">here</a> . <br><br><h4>  Adding cameras </h4><br>  Zoneminder can work with both usb and IP cameras.  At the moment, my cameras are still on the way, so as a test-tuning-temporary version of the camera, I use my old Android-smartphone Alcatel Pop C2, on which the <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.pas.webcam">IP Webcam</a> application is installed, which turns the smartphone into a Wi-Fi IP-camera.  After installing and running the application (I recommend to set the resolution of the video stream in the application settings, I set 800x480), the smartphone displays the IP and the port that you can use to access the web interface and see what is interesting here: <br><br><img src="https://habrastorage.org/files/c6b/011/284/c6b0112847f343b9a2f5c1e568a46054.png"><br><br>  There are a lot of settings in general, but we are interested in the address to which the video stream is sent.  And we see that there is information to configure Zoneminder, which is good news.  Namely, the Remote host path is specified, the path that will need to be specified in the settings of Zoneminder - after the IP camera you need to add / video: <br><br><img src="https://habrastorage.org/files/061/07f/348/06107f34875040c3b59c31fdb48be5f6.png"><br><br>  Returning to the web interface of Zoneminder, to add a camera, select Add New Monitor: <br><br><img src="https://habrastorage.org/files/1f5/3f5/7f0/1f53f57f0e1e46f98fb744ff561f9bc0.png"><br><br>  In the Name field, write the desired name, Source type -&gt; Remote: <br><br><img src="https://habrastorage.org/files/fe4/9c3/eb8/fe49c3eb8bff451d868f5717256786f8.png"><br><br>  In the Source tab, we fill in the fields: Remote Host Name -&gt; IP of the smartphone, Remote Host Port -&gt; port on which the IP Webcam is running, Remote Host Path -&gt; the path we saw in the IP Webcam settings, and also specify the resolution of the video stream, which should match with the one we chose earlier in the IP webcam settings: <br><br><img src="https://habrastorage.org/files/edb/332/eaa/edb332eaa0af41929a5c001c85ba250c.png"><br><br>  Save the settings -&gt; Save, and in the main menu of Zoneminder we see the camera we added: <br><br><img src="https://habrastorage.org/files/79b/e8b/134/79be8b13496c4d208c3b7bf71b8f0f78.png"><br><br>  When clicking on the name of which, we see the image: <br><br><img src="https://habrastorage.org/files/658/932/b4b/658932b4bf8e48099191e344fe46a436.png"><br><br>  Cameras can operate in several modes, which is determined by the Function parameter in the main menu: <br><br><img src="https://habrastorage.org/files/f7b/c37/f45/f7bc37f45b0a4b00b91107ff71e2ba86.png"><br><br>  The mode in which the recording is made only when there is motion in the frame is called Modect, and we will select it.  Now the system will not record the video stream constantly, but only if there are compelling reasons.  But we still need to be notified of movement in the frame.  For this you need to configure the filter.  Open Filters in the main menu of Zoneminder, set up according to the screenshot, save under any name: <br><br><img src="https://habrastorage.org/files/e06/f67/7d8/e06f677d87504372b4b2e6a256c2b029.png"><br><br>  And do not forget to put a tick in front of the Run filter in background: <br><br><img src="https://habrastorage.org/files/fa0/028/000/fa0028000ace4cf09efc533db6c5a89a.png"><br><br>  Thus, if motion is detected in a frame, the system will record a video and send an e-mail notification. <br><br><h4>  Client applications </h4><br>  If there is a permanent IP, nothing prevents you from forwarding ports in the router and connecting from your smartphone from the outside via a web interface, especially since you can select the mobile version of the interface in the Zoneminder settings, but in addition, I decided to look for some mobile application for this goals  Searching on Google Play for the keyword "zoneminder", I stopped at <a href="https://play.google.com/store/apps/details%3Fid%3Dcom.pliablepixels.zmninja_pro">zmNinja</a> , because  The rating is quite high and the screenshots are liked.  The application is a paid, trial version for a preliminary assessment, alas, no.  The functionality is more than enough - viewing the video stream in real time, viewing the archive, recorded events, switching camera modes, etc. <br><br><img src="https://habrastorage.org/files/05a/2c6/466/05a2c6466e07423cb4cab1c19441e1ea.png"><br><br><img src="https://habrastorage.org/files/397/6d7/688/3976d76883e74dd39c5c116dff87704a.png"><br><br><img src="https://habrastorage.org/files/41b/8bb/080/41b8bb0802794b62927ac27d493e3cae.png"><br><br><img src="https://habrastorage.org/files/aa0/145/ebd/aa0145ebdc2647d09e10bc9d4b7d8ec3.png"><br><br><img src="https://habrastorage.org/files/ff9/ecb/aba/ff9ecbaba4f64bb08b606ce1a05fb24c.png"><br><br>  There are also <a href="https://github.com/pliablepixels/zmNinja/releases">desktop versions of</a> zmNinja for Linux, Windows, Mac OS X - they are distributed free of charge.  This is the Linux version running on my Mint 18: <br><br><img src="https://habrastorage.org/files/951/e22/5dc/951e225dcbf648b692ff07c42dd32a42.png"><br><br>  In general, the interface is uniform for all systems. <br><br>  That's all, thank you for your attention. </div><p>Source: <a href="https://habr.com/ru/post/396099/">https://habr.com/ru/post/396099/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../396089/index.html">As the origin of man reflected in the genes</a></li>
<li><a href="../396091/index.html">Another candidate is trying to remove his past from search engines.</a></li>
<li><a href="../396093/index.html">IBM blockchain solutions digest, part 1</a></li>
<li><a href="../396095/index.html">How Estonia applies the blockchain to the whole state</a></li>
<li><a href="../396097/index.html">Double trap for poachers. Fake turtle eggs with GPS trackers</a></li>
<li><a href="../396101/index.html">Artem Astafurov: "We started with a soldering iron, but stopped on a cloud"</a></li>
<li><a href="../396103/index.html">Reskin Ingress or a full game? Review Pokemon Go</a></li>
<li><a href="../396105/index.html">What will the cities of the future look like?</a></li>
<li><a href="../396107/index.html">The largest radio telescope MeerKAT launched in test mode at a quarter of the power</a></li>
<li><a href="../396111/index.html">PM2.5 particles: what is it, where is it from and why is everyone talking about it</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>