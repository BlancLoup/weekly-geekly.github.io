<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Analyzing book recommendations for developers with Stack Overflow using Python tools</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Deciding which book on programming to read next is difficult and risky. 

 As befits a developer, you probably have little time, and you spend the lio...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Analyzing book recommendations for developers with Stack Overflow using Python tools</h1><div class="post__text post__text-html js-mediator-article">  Deciding which book on programming to read next is difficult and risky. <br><br>  As befits a developer, you probably have little time, and you spend the lion‚Äôs share on reading books.  You could program.  You could rest.  But instead, you devote valuable time to developing your skills. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/files/cdc/bbe/8c1/cdcbbe8c148b4ea2a9a08ba678073e47.jpeg" width="600"></div><br>  So which book should you read?  My colleagues and I often discuss the read literature, and I noticed that our opinions on specific books are very different. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      So I decided to go deep into the problem.  My idea was this: analyze the most popular resource in the world for programmers for links to a famous bookstore, and then calculate how many times each book is mentioned. <br><a name="habracut"></a><br>  Fortunately, the Stack Exchange (parent company Stack Overflow) has just published its data dump.  I sat down and started coding. <br><br><img src="https://habrastorage.org/files/b6d/20a/8b7/b6d20a8b7944401aa0dceb1bd9ef4f75.png"><br>  <i>Screenshot of the tool I created: dev-books.com</i> <br><br><blockquote>  ‚ÄúIf you're curious, the book‚Äú <a href="https://amazon.co.uk/dp/0131177052/%3Ftag%3Ddevbookscom-21">Effective work with legacy code</a> ‚Äù(Michael Feathers) is most often recommended, followed by the work‚Äú <a href="https://amazon.co.uk/dp/0201633612/%3Ftag%3Ddevbookscom-21">Object-oriented design techniques.</a>  <a href="https://amazon.co.uk/dp/0201633612/%3Ftag%3Ddevbookscom-21">Design patterns</a> ‚Äù(Erich Gamma).  Although the titles of these books are dry, like the Atacama Desert, the content of them, one should think, is of rather good quality.  You can sort books by tags, such as javascript, c, graphics and so on.  Of course, the list of recommendations does not end with these two names, but these are certainly excellent options for starting, if you are just starting to code or want to upgrade your skills, ‚Äùreview on <a href="http://lifehacker.com/dev-books-is-a-massive-collection-of-the-most-recommend-1792134129">Lifehacker.com</a> . </blockquote><br>  Soon after, I launched <a href="http://www.dev-books.com/">dev-books.com</a> , which allows you to examine all the data that I collected and sorted.  As a result, I received more than 100,000 visitors and many reviews in which people asked to describe the entire technical process. <br><br>  So today I will tell you how I did all this. <br><br>  <b>Receiving and importing data</b> <br><br>  I took a dump of the Stack Exchange database from archive.org. <br><br>  From the very beginning, I realized that it is not possible to import a 48 GB XML file into the newly created database (PostgreSQL) using popular methods such as myxml: = pg_read_file ('path / to / my_file.xml'), because I did not have 48 GB of RAM on the server.  So I decided to use the <a href="https://ru.wikipedia.org/wiki/SAX">SAX</a> parser. <br><br>  All values ‚Äã‚Äãwere stored between tags, so I used the Python script to parse: <br><br><pre><code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, attributes)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name == <span class="hljs-string"><span class="hljs-string">'row'</span></span>: self.cur.execute(‚ÄúINSERT INTO posts (Id, Post_Type_Id, Parent_Id, Accepted_Answer_Id, Creation_Date, Score, View_Count, Body, Owner_User_Id, Last_Editor_User_Id, Last_Editor_Display_Name, Last_Edit_Date, Last_Activity_Date, Community_Owned_Date, Closed_Date, Title, Tags, Answer_Count, Comment_Count, Favorite_Count) VALUES (%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s,%s)‚Äù, ( (attributes[<span class="hljs-string"><span class="hljs-string">'Id'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'Id'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'PostTypeId'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'PostTypeId'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'ParentID'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'ParentID'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'AcceptedAnswerId'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'AcceptedAnswerId'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'CreationDate'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'CreationDate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'Score'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'Score'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'ViewCount'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'ViewCount'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'Body'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'Body'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'OwnerUserId'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'OwnerUserId'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'LastEditorUserId'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'LastEditorUserId'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'LastEditorDisplayName'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'LastEditorDisplayName'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'LastEditDate'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'LastEditDate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'LastActivityDate'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'LastActivityDate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'CommunityOwnedDate'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'CommunityOwnedDate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'ClosedDate'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'ClosedDate'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'Title'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'Title'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'Tags'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'Tags'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'AnswerCount'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'AnswerCount'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'CommentCount'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'CommentCount'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>), (attributes[<span class="hljs-string"><span class="hljs-string">'FavoriteCount'</span></span>] <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-string"><span class="hljs-string">'FavoriteCount'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> attributes <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>) ) );</code> </pre> <br>  After three days of import (almost half of the XML was imported during this time), I realized that I had made a mistake: the ParentID value should have the form ParentId. <br><br>  At that moment, I didn‚Äôt want to wait another week and switched from AMD E-350 (2 x 1.35GHz) to Intel G2020 (2 x 2.90GHz).  But this did not speed up the process. <br><br>  The next solution is batch insert: <br><br><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">docHandler</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(xml.sax.ContentHandler)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, cusor)</span></span></span><span class="hljs-function">:</span></span> self.cusor = cusor; self.queue = <span class="hljs-number"><span class="hljs-number">0</span></span>; self.output = StringIO(); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">startElement</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, name, attributes)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> name == <span class="hljs-string"><span class="hljs-string">'row'</span></span>: self.output.write( attributes[<span class="hljs-string"><span class="hljs-string">'Id'</span></span>] + <span class="hljs-string"><span class="hljs-string">'\t` + (attributes['</span></span>PostTypeId<span class="hljs-string"><span class="hljs-string">'] if '</span></span>PostTypeId<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>ParentId<span class="hljs-string"><span class="hljs-string">'] if '</span></span>ParentId<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>AcceptedAnswerId<span class="hljs-string"><span class="hljs-string">'] if '</span></span>AcceptedAnswerId<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>CreationDate<span class="hljs-string"><span class="hljs-string">'] if '</span></span>CreationDate<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>Score<span class="hljs-string"><span class="hljs-string">'] if '</span></span>Score<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>ViewCount<span class="hljs-string"><span class="hljs-string">'] if '</span></span>ViewCount<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>Body<span class="hljs-string"><span class="hljs-string">'].replace('</span></span>\\<span class="hljs-string"><span class="hljs-string">', '</span></span>\\\\<span class="hljs-string"><span class="hljs-string">').replace('</span></span>\n<span class="hljs-string"><span class="hljs-string">', '</span></span>\\\n<span class="hljs-string"><span class="hljs-string">').replace('</span></span>\<span class="hljs-string"><span class="hljs-string">r', '</span></span>\\\<span class="hljs-string"><span class="hljs-string">r').replace('</span></span>\t<span class="hljs-string"><span class="hljs-string">', '</span></span>\\\t<span class="hljs-string"><span class="hljs-string">') if '</span></span>Body<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>OwnerUserId<span class="hljs-string"><span class="hljs-string">'] if '</span></span>OwnerUserId<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>LastEditorUserId<span class="hljs-string"><span class="hljs-string">'] if '</span></span>LastEditorUserId<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>LastEditorDisplayName<span class="hljs-string"><span class="hljs-string">'].replace('</span></span>\n<span class="hljs-string"><span class="hljs-string">', '</span></span>\\n<span class="hljs-string"><span class="hljs-string">') if '</span></span>LastEditorDisplayName<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>LastEditDate<span class="hljs-string"><span class="hljs-string">'] if '</span></span>LastEditDate<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>LastActivityDate<span class="hljs-string"><span class="hljs-string">'] if '</span></span>LastActivityDate<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>CommunityOwnedDate<span class="hljs-string"><span class="hljs-string">'] if '</span></span>CommunityOwnedDate<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>ClosedDate<span class="hljs-string"><span class="hljs-string">'] if '</span></span>ClosedDate<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>Title<span class="hljs-string"><span class="hljs-string">'].replace('</span></span>\\<span class="hljs-string"><span class="hljs-string">', '</span></span>\\\\<span class="hljs-string"><span class="hljs-string">').replace('</span></span>\n<span class="hljs-string"><span class="hljs-string">', '</span></span>\\\n<span class="hljs-string"><span class="hljs-string">').replace('</span></span>\<span class="hljs-string"><span class="hljs-string">r', '</span></span>\\\<span class="hljs-string"><span class="hljs-string">r').replace('</span></span>\t<span class="hljs-string"><span class="hljs-string">', '</span></span>\\\t<span class="hljs-string"><span class="hljs-string">') if '</span></span>Title<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>Tags<span class="hljs-string"><span class="hljs-string">'].replace('</span></span>\n<span class="hljs-string"><span class="hljs-string">', '</span></span>\\n<span class="hljs-string"><span class="hljs-string">') if '</span></span>Tags<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>AnswerCount<span class="hljs-string"><span class="hljs-string">'] if '</span></span>AnswerCount<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>CommentCount<span class="hljs-string"><span class="hljs-string">'] if '</span></span>CommentCount<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\t<span class="hljs-string"><span class="hljs-string">' + (attributes['</span></span>FavoriteCount<span class="hljs-string"><span class="hljs-string">'] if '</span></span>FavoriteCount<span class="hljs-string"><span class="hljs-string">' in attributes else '</span></span>\\N<span class="hljs-string"><span class="hljs-string">') + '</span></span>\n<span class="hljs-string"><span class="hljs-string">' ); self.queue += 1; if (self.queue &gt;= 100000): self.queue = 0; self.flush(); def flush(self): self.output.seek(0); self.cusor.copy_from(self.output, '</span></span>posts<span class="hljs-string"><span class="hljs-string">') self.output.close(); self.output = StringIO();</span></span></code> </pre><br>  StringIO allows you to use a file type variable to process the copy_from function that uses COPY.  Thus, the whole import process took only a night. <br><br>  Great, now is the time to create indexes.  In theory, the GiST indexes are slower than the GIN, but take up less space.  So I decided to use GiST.  A day later, I had an index that occupied 70 GB. <br><br>  When I tried to enter a couple of test requests, I realized that it took too much time to process them.  Why?  Due to Disk I / O wait.  SSD GOODRAM C40 120Gb helped a lot, even if it is not the fastest SSD today. <br><br>  I created a new PostgreSQL cluster: <br><br><pre> <code class="python hljs">initdb -D /media/ssd/postgresq/data</code> </pre> <br>  Then I changed the path in my config service (using the Manjaro distribution): <br><br><pre> <code class="python hljs">vim /usr/lib/systemd/system/postgresql.service Environment=PGROOT=/media/ssd/postgres PIDFile=/media/ssd/postgres/data/postmaster.pid</code> </pre> <br><br>  I reloaded the configuration and started postgreSQL: <br><br><pre> <code class="python hljs">systemctl daemon-reload postgresql systemctl start postgresql</code> </pre> <br>  This time it took a couple of hours to import, but I used the GIN.  Indexing took 20 GB of memory on the SSD, and simple requests were processed in less than a minute. <br><br>  <b>Extract books from the database</b> <br><br>  When my data was finally imported, I started looking for posts that mentioned books, and then copied them into a separate table using SQL: <br><br><pre> <code class="python hljs">CREATE TABLE books_posts AS SELECT * FROM posts WHERE body LIKE <span class="hljs-string"><span class="hljs-string">'%book%'</span></span>‚Äù;</code> </pre> <br>  The next step was to find all the hyperlinks inside these posts: <br><br><pre> <code class="python hljs">CREATE TABLE http_books AS SELECT * posts WHERE body LIKE <span class="hljs-string"><span class="hljs-string">'%http%'</span></span>‚Äù;</code> </pre> <br>  At this point, I realized that StackOverflow proxied such links as follows: <br><br><pre> <code class="python hljs">rads.stackowerflow.com/[$isbn]/</code> </pre> <br>  I created another table for all posts with links: <br><br><pre> <code class="python hljs">CREATE TABLE rads_posts AS SELECT * FROM posts WHERE body LIKE <span class="hljs-string"><span class="hljs-string">'%http://rads.stackowerflow.com%'</span></span><span class="hljs-string"><span class="hljs-string">";</span></span></code> </pre> <br>  In doing so, I used regular expressions to extract all <a href="https://ru.wikipedia.org/wiki/%25D0%259C%25D0%25B5%25D0%25B6%25D0%25B4%25D1%2583%25D0%25BD%25D0%25B0%25D1%2580%25D0%25BE%25D0%25B4%25D0%25BD%25D1%258B%25D0%25B9_%25D1%2581%25D1%2582%25D0%25B0%25D0%25BD%25D0%25B4%25D0%25B0%25D1%2580%25D1%2582%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BA%25D0%25BD%25D0%25B8%25D0%25B6%25D0%25BD%25D1%258B%25D0%25B9_%25D0%25BD%25D0%25BE%25D0%25BC%25D0%25B5%25D1%2580">ISBN</a> numbers.  I extracted the Stack Overflow tags to a separate table using regexp_split_to_table. <br><br>  After extracting and counting data on the most popular tags, it turned out that the top 20 books with the maximum number of references are approximately the same for all tags. <br><br>  My next step: tag refinement. <br><br>  The idea was to take the top 20 most frequently mentioned books for each tag and exclude those books that have already been processed. <br><br>  Since this was a ‚Äúone-off‚Äù job, I decided to use PostgreSQL arrays.  I wrote a script to create a query, like this: <br><br><pre> <code class="python hljs">SELECT * , ARRAY(SELECT UNNEST(isbns) EXCEPT SELECT UNNEST(to_exclude )) , ARRAY_UPPER(ARRAY(SELECT UNNEST(isbns) EXCEPT SELECT UNNEST(to_exclude )), <span class="hljs-number"><span class="hljs-number">1</span></span>) FROM ( SELECT * , ARRAY[<span class="hljs-string"><span class="hljs-string">'isbn1'</span></span>, <span class="hljs-string"><span class="hljs-string">'isbn2'</span></span>, <span class="hljs-string"><span class="hljs-string">'isbn3'</span></span>] AS to_exclude FROM ( SELECT tag , ARRAY_AGG(DISTINCT isbn) AS isbns , COUNT(DISTINCT isbn) FROM ( SELECT * FROM ( SELECT it.* , t.popularity FROM isbn_tags AS it LEFT OUTER JOIN isbns AS i on i.isbn = it.isbn LEFT OUTER JOIN tags AS t on t.tag = it.tag WHERE it.tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( SELECT tag FROM tags ORDER BY popularity DESC LIMIT <span class="hljs-number"><span class="hljs-number">1</span></span> OFFSET <span class="hljs-number"><span class="hljs-number">0</span></span> ) ORDER BY post_count DESC LIMIT <span class="hljs-number"><span class="hljs-number">20</span></span> ) AS t1 UNION ALL SELECT * FROM ( SELECT it.* , t.popularity FROM isbn_tags AS it LEFT OUTER JOIN isbns AS i on i.isbn = it.isbn LEFT OUTER JOIN tags AS t on t.tag = it.tag WHERE it.tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( SELECT tag FROM tags ORDER BY popularity DESC LIMIT <span class="hljs-number"><span class="hljs-number">1</span></span> OFFSET <span class="hljs-number"><span class="hljs-number">1</span></span> ) ORDER BY post_count DESC LIMIT <span class="hljs-number"><span class="hljs-number">20</span></span> ) AS t2 UNION ALL SELECT * FROM ( SELECT it.* , t.popularity FROM isbn_tags AS it LEFT OUTER JOIN isbns AS i on i.isbn = it.isbn LEFT OUTER JOIN tags AS t on t.tag = it.tag WHERE it.tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( SELECT tag FROM tags ORDER BY popularity DESC LIMIT <span class="hljs-number"><span class="hljs-number">1</span></span> OFFSET <span class="hljs-number"><span class="hljs-number">2</span></span> ) ORDER BY post_count DESC LIMIT <span class="hljs-number"><span class="hljs-number">20</span></span> ) AS t3 ... UNION ALL SELECT * FROM ( SELECT it.* , t.popularity FROM isbn_tags AS it LEFT OUTER JOIN isbns AS i on i.isbn = it.isbn LEFT OUTER JOIN tags AS t on t.tag = it.tag WHERE it.tag <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> ( SELECT tag FROM tags ORDER BY popularity DESC LIMIT <span class="hljs-number"><span class="hljs-number">1</span></span> OFFSET <span class="hljs-number"><span class="hljs-number">78</span></span> ) ORDER BY post_count DESC LIMIT <span class="hljs-number"><span class="hljs-number">20</span></span> ) AS t79 ) AS tt GROUP BY tag ORDER BY max(popularity) DESC ) AS ttt ) AS tttt ORDER BY ARRAY_upper(ARRAY(SELECT UNNEST(arr) EXCEPT SELECT UNNEST(la)), <span class="hljs-number"><span class="hljs-number">1</span></span>) DESC;</code> </pre> <br>  With the data on hand, I went to the Internet. <br><br>  <b>Creating a web application</b> <br><br><img src="https://habrastorage.org/files/16a/9a7/832/16a9a7832d6e4c9482a382e42bbe1297.png"><br>  <i>Nginx vs.</i>  <i>Apache</i> <br><br>  Since I am not a web developer and definitely not an expert in creating web interfaces, I decided to make a very simple one-page application based on the standard theme from Bootstrap. <br><br>  I created the ‚Äúsearch by tag‚Äù option and then extracted the most popular tags to make each search clickable. <br><br>  I visualized the search results using a histogram.  I also tried Hightcharts and D3, but they are more suitable for dashboards.  They found some problems with the response, and it turned out to be quite difficult to configure.  With this in mind, I created my own responsive SVG-based diagram.  To provide this responsiveness, it had to change when the screen orientation changed: <br><br><pre> <code class="python hljs">var w = $(<span class="hljs-string"><span class="hljs-string">'#plot'</span></span>).width(); var bars = <span class="hljs-string"><span class="hljs-string">""</span></span>;var imgs = <span class="hljs-string"><span class="hljs-string">""</span></span>; var texts = <span class="hljs-string"><span class="hljs-string">""</span></span>; var rx = <span class="hljs-number"><span class="hljs-number">10</span></span>; var tx = <span class="hljs-number"><span class="hljs-number">25</span></span>; var max = Math.floor(w / <span class="hljs-number"><span class="hljs-number">60</span></span>); var maxPop = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(var i =<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; max; i ++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(i &gt; books.length - <span class="hljs-number"><span class="hljs-number">1</span></span> ){ <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } obj = books[i]; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(maxPop &lt; Number(obj.pop)) { maxPop = Number(obj.pop); } } <span class="hljs-keyword"><span class="hljs-keyword">for</span></span>(var i =<span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; max; i ++){ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(i &gt; books.length - <span class="hljs-number"><span class="hljs-number">1</span></span>){ <span class="hljs-keyword"><span class="hljs-keyword">break</span></span>; } obj = books[i]; h = Math.floor((<span class="hljs-number"><span class="hljs-number">180</span></span> / maxPop ) * obj.pop); dt = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-string"><span class="hljs-string">''</span></span> + obj.pop + <span class="hljs-string"><span class="hljs-string">''</span></span>).length == <span class="hljs-number"><span class="hljs-number">1</span></span>){ dt = <span class="hljs-number"><span class="hljs-number">5</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>((<span class="hljs-string"><span class="hljs-string">''</span></span> + obj.pop + <span class="hljs-string"><span class="hljs-string">''</span></span>).length == <span class="hljs-number"><span class="hljs-number">3</span></span>){ dt = <span class="hljs-number"><span class="hljs-number">-3</span></span>; } var scrollTo = <span class="hljs-string"><span class="hljs-string">'onclick="scrollTo(\''</span></span>+ obj.id +<span class="hljs-string"><span class="hljs-string">'\'); return false;" "'</span></span>; bars += <span class="hljs-string"><span class="hljs-string">'&lt;rect id="rect'</span></span>+ obj.id +<span class="hljs-string"><span class="hljs-string">'" class="cla" x="'</span></span>+ rx +<span class="hljs-string"><span class="hljs-string">'" y="'</span></span> + (<span class="hljs-number"><span class="hljs-number">180</span></span> - h + <span class="hljs-number"><span class="hljs-number">30</span></span>) + <span class="hljs-string"><span class="hljs-string">'" width="50" height="'</span></span> + h + <span class="hljs-string"><span class="hljs-string">'" '</span></span> + scrollTo + <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>; bars += <span class="hljs-string"><span class="hljs-string">'&lt;title&gt;'</span></span> + obj.name+ <span class="hljs-string"><span class="hljs-string">'&lt;/title&gt;'</span></span>; bars += <span class="hljs-string"><span class="hljs-string">'&lt;/rect&gt;'</span></span>; imgs += <span class="hljs-string"><span class="hljs-string">'&lt;image height="70" x="'</span></span>+ rx +<span class="hljs-string"><span class="hljs-string">'" y="220" href="img/ol/jpeg/'</span></span> + obj.id + <span class="hljs-string"><span class="hljs-string">'.jpeg" onmouseout="unhoverbar('</span></span>+ obj.id +<span class="hljs-string"><span class="hljs-string">');" onmouseover="hoverbar('</span></span>+ obj.id +<span class="hljs-string"><span class="hljs-string">');" width="50" '</span></span> + scrollTo + <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span>; imgs += <span class="hljs-string"><span class="hljs-string">'&lt;title&gt;'</span></span> + obj.name+ <span class="hljs-string"><span class="hljs-string">'&lt;/title&gt;'</span></span>; imgs += <span class="hljs-string"><span class="hljs-string">'&lt;/image&gt;'</span></span>; texts += <span class="hljs-string"><span class="hljs-string">'&lt;text x="'</span></span>+ (tx + dt) +<span class="hljs-string"><span class="hljs-string">'" y="'</span></span>+ (<span class="hljs-number"><span class="hljs-number">180</span></span> - h + <span class="hljs-number"><span class="hljs-number">20</span></span>) +<span class="hljs-string"><span class="hljs-string">'" class="bar-label" style="font-size: 16px;" '</span></span> + scrollTo + <span class="hljs-string"><span class="hljs-string">'&gt;'</span></span> + obj.pop + <span class="hljs-string"><span class="hljs-string">'&lt;/text&gt;'</span></span>; rx += <span class="hljs-number"><span class="hljs-number">60</span></span>; tx += <span class="hljs-number"><span class="hljs-number">60</span></span>; } $(<span class="hljs-string"><span class="hljs-string">'#plot'</span></span>).html( <span class="hljs-string"><span class="hljs-string">' &lt;svg width="100%" height="300" aria-labelledby="title desc" role="img"&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">' &lt;defs&gt; '</span></span> + <span class="hljs-string"><span class="hljs-string">' &lt;style type="text/css"&gt;&lt;![CDATA['</span></span> + <span class="hljs-string"><span class="hljs-string">' .cla {'</span></span> + <span class="hljs-string"><span class="hljs-string">' fill: #337ab7;'</span></span> + <span class="hljs-string"><span class="hljs-string">' }'</span></span> + <span class="hljs-string"><span class="hljs-string">' .cla:hover {'</span></span> + <span class="hljs-string"><span class="hljs-string">' fill: #5bc0de;'</span></span> + <span class="hljs-string"><span class="hljs-string">' }'</span></span> + <span class="hljs-string"><span class="hljs-string">' ]]&gt;&lt;/style&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">' &lt;/defs&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">' &lt;g class="bar"&gt;'</span></span> + bars + <span class="hljs-string"><span class="hljs-string">' &lt;/g&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">' &lt;g class="bar-images"&gt;'</span></span> + imgs + <span class="hljs-string"><span class="hljs-string">' &lt;/g&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">' &lt;g class="bar-text"&gt;'</span></span> + texts + <span class="hljs-string"><span class="hljs-string">' &lt;/g&gt;'</span></span> + <span class="hljs-string"><span class="hljs-string">'&lt;/svg&gt;'</span></span>);</code> </pre> <br>  <b>Web server crash</b> <br><br>  As soon as I managed to launch dev-books.com, I had already discovered on my website a huge crowd of people.  Apache could not serve more than 500 visitors at the same time, so I quickly set up Nginx and switched to it along the way.  I was very surprised when the number of visitors in real time immediately increased to 800 people. <br><br>  <b>Conclusion</b> <br><br>  I hope I explained everything quite clearly.  If you have questions, feel free to ask them.  You can find me on <a href="https://twitter.com/VLPLabs">twitter</a> and on <a href="https://www.facebook.com/VLP-Labs-727090070789985/">facebook</a> . <br><br>  As promised, at the end of March, I will publish my full report from Amazon.com and Google Analytics.  While the results are very unexpected. </div><p>Source: <a href="https://habr.com/ru/post/323522/">https://habr.com/ru/post/323522/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323512/index.html">Who is interested in the Russian IaaS</a></li>
<li><a href="../323514/index.html">CocoaHeads video footage March 1, 2017</a></li>
<li><a href="../323516/index.html">Complete latent semantic analysis with Python tools</a></li>
<li><a href="../323518/index.html">Development for Sailfish OS: Qt / C ++ Unit Testing under Sailfish OS</a></li>
<li><a href="../323520/index.html">Write me money: iMessage transfers</a></li>
<li><a href="../323524/index.html">Learning to learn. Create self-improving AI</a></li>
<li><a href="../323526/index.html">Magic newtype in haskell</a></li>
<li><a href="../323528/index.html">Quality management system: how to understand the standards and start the process of their implementation in the company</a></li>
<li><a href="../323532/index.html">Turquoise Organizations: Examples and Common Answers</a></li>
<li><a href="../323534/index.html">Crowdinvesting in Russia: the StartTrack Experience</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>