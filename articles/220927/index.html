<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>R + C + CUDA = ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Sometimes there is a need to speed up the calculations, and preferably at once at times. At the same time, it is necessary to abandon convenient, but ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>R + C + CUDA = ...</h1><div class="post__text post__text-html js-mediator-article"><img align="left" src="https://habrastorage.org/getpro/habr/post_images/ef6/ad5/ec5/ef6ad5ec526ad577bccf516e99761c06.png">  Sometimes there is a need to speed up the calculations, and preferably at once at times.  At the same time, it is necessary to abandon convenient, but slow tools and resort to something lower and faster.  R has quite advanced features for working with dynamic libraries written in C / C ++, Fortran or even Java.  Out of habit, I prefer C / C ++. <br><a name="habracut"></a><br><br><h3>  R and C </h3><br>  At once I will make a reservation that I work under Debian Wheezy (under Windows, probably, there are some nuances).  When writing a library in C for R, consider the following: <br><ul><li>  Functions written in C and called in R must be of type void.  This means that if a function returns some results, then they must be returned via the function arguments. </li><li>  All arguments are passed by reference (and when working with pointers, you need to remain vigilant!) </li><li> In C code, it is desirable to include <code>Rh</code> and <code>Rmath.h</code> (if mathematical functions R are used) </li></ul><br>  Let's start with a simple function that calculates the scalar product of two vectors: <br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/82d/a31/598/82da3159820a34881903605d2cab7b89.png"></div><br><pre> <code class="hljs vbscript">#include &lt;Rh&gt; void iprod(double *v1, double *v2, <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> *n, double *s) { double ret = <span class="hljs-number"><span class="hljs-number">0</span></span>; <span class="hljs-built_in"><span class="hljs-built_in">int</span></span> <span class="hljs-built_in"><span class="hljs-built_in">len</span></span> = *n; <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-built_in"><span class="hljs-built_in">int</span></span> i = <span class="hljs-number"><span class="hljs-number">0</span></span>; i &lt; <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>; i++) { ret += v1[i] * v2[i]; } *s = ret; }</code> </pre><br>  Next, you need to get a dynamic library - you can directly through gcc, but you can use this command (by the way, you should remember the output, since it will be useful to us later): <br><pre> <code class="hljs objectivec">R <span class="hljs-built_in"><span class="hljs-built_in">CMD</span></span> SHLIB inner_prod.c</code> </pre><br>  At the output we get the file inner_prod.so, for which we will use the <code>dyn.load()</code> function.  To call the function itself on C, <code>.C()</code> use <code>.C()</code> (there is also <code>.Call()</code> and. <code>.External()</code> , but with slightly different functionality, and <a href="http://permalink.gmane.org/gmane.comp.lang.r.devel/30552">hot arguments</a> are sometimes between supporters of <a href="http://mazamascience.com/WorkingWithData/%3Fp%3D1099">.C () and .Call ()</a> ).  I will only note that when writing C code to call through <code>.C()</code> it turns out to be cleaner and more readable.  Special attention should be paid to the correspondence of the types of variables in R and C (in the documentation on the function <code>.C()</code> this is written in detail).  Wrapper function on R: <br><pre> <code class="hljs pgsql">iprod &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(a, b) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>.loaded(<span class="hljs-string"><span class="hljs-string">'iprod'</span></span>)) { dyn.<span class="hljs-keyword"><span class="hljs-keyword">load</span></span>("inner_prod.so") } n &lt;- length(a) v &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(.C("iprod", <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.double(a), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.double(b), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer(n), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.double(v))[[<span class="hljs-number"><span class="hljs-number">4</span></span>]]) }</code> </pre><br>  Now you can find out what we have achieved: <br><pre> <code class="hljs haskell">&gt; n &lt;- <span class="hljs-number"><span class="hljs-number">1e7</span></span>; a &lt;- rnorm(n); b &lt;- rnorm(n); &gt; iprod(a, b) [<span class="hljs-number"><span class="hljs-number">1</span></span>] <span class="hljs-number"><span class="hljs-number">3482.183</span></span></code> </pre><br>  And a small check: <br><pre> <code class="hljs css">&gt; <span class="hljs-selector-tag"><span class="hljs-selector-tag">sum</span></span>(<span class="hljs-selector-tag"><span class="hljs-selector-tag">a</span></span> * <span class="hljs-selector-tag"><span class="hljs-selector-tag">b</span></span>) <span class="hljs-selector-attr"><span class="hljs-selector-attr">[1]</span></span> 3482<span class="hljs-selector-class"><span class="hljs-selector-class">.183</span></span></code> </pre><br>  In any case, he considers it right. <br><br><h3>  R and CUDA </h3><br>  To take advantage of all the benefits that the Nvidia graphics accelerator provides in Debian, you need to install <a href="https://wiki.debian.org/NvidiaGraphicsDrivers">the Nvidia proprietary driver</a> and the <code>nvidia-cuda-toolkit</code> package.  CUDA, of course, deserves a separate huge topic, and since my level in this topic is ‚Äúbeginner‚Äù, I will not frighten people with my curves and unfinished code, but allow myself to copy a few lines from the manual. <br>  Suppose you need to raise each element of the vector to the third degree and find the Euclidean norm of the resulting vector: <br><div style="text-align:center;"><img src="http://habrastorage.org/files/0b0/399/405/0b03994055c541d09ea07bd7513930a4.png"></div><br>  To make working with GPU somewhat easier, let us use the library of parallel algorithms <code>Thrust</code> , which allows us to abstract from low-level CUDA / C operations.  The data are presented in the form of vectors, to which some standard algorithms are applied (elementwise operations, reductions, prefix-sums, sorting). <br><pre> <code class="hljs objectivec"><span class="hljs-meta"><span class="hljs-meta">#include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;thrust/transform_reduce.h&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;thrust/device_vector.h&gt;</span></span></span><span class="hljs-meta"> #include </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;cmath&gt;</span></span></span><span class="hljs-meta"> // ,     6   GPU (device) template </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;typename T&gt;</span></span></span><span class="hljs-meta"> struct power{ __device__ T operator()(const T&amp; x) const{ return std::pow(x, 6); } }; extern </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"C"</span></span></span><span class="hljs-meta"> void nrm(double *v, int *n, double *vnorm) { // ,    GPU,     *v thrust::device_vector</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;double&gt;</span></span></span><span class="hljs-meta"> dv(v, v + *n); // Reduce- , ..        power //    . *vnorm = std::sqrt( thrust::transform_reduce(dv.begin(), dv.end(), power</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;double&gt;</span></span></span><span class="hljs-meta">(), 0.0, thrust::plus</span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">&lt;double&gt;</span></span></span><span class="hljs-meta">()) ); }</span></span></code> </pre><br>  Using <code>extern "C"</code> necessary here, otherwise R will not see the function nrm ().  To compile the code we will now use nvcc.  Remember the output of the command <code>R CMD SHLIB...</code> ?  Here we adapt it a bit so that a library using CUDA / Thrust can be called from R without any problems: <br><pre> <code class="hljs pgsql">nvcc -g -G -O2 -arch sm_30 -I/usr/<span class="hljs-keyword"><span class="hljs-keyword">share</span></span>/R/<span class="hljs-keyword"><span class="hljs-keyword">include</span></span> -Xcompiler "-Wall -fpic" -c thr.cu thr.o nvcc -shared -lm thr.o -o thr.so -L/usr/lib/R/lib -lR</code> </pre><br>  At the output we get DSO thr.so.  The wrapper function is almost the same: <br><pre> <code class="hljs pgsql">gpunrm &lt;- <span class="hljs-keyword"><span class="hljs-keyword">function</span></span>(v) { <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">is</span></span>.loaded(<span class="hljs-string"><span class="hljs-string">'nrm'</span></span>)) dyn.<span class="hljs-keyword"><span class="hljs-keyword">load</span></span>("thr.so") n &lt;- length(v) vnorm &lt;- <span class="hljs-number"><span class="hljs-number">0</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>(.C("nrm", <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.double(v), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.integer(n), <span class="hljs-keyword"><span class="hljs-keyword">as</span></span>.double(vnorm))[[<span class="hljs-number"><span class="hljs-number">3</span></span>]]) }</code> </pre><br>  The graph below clearly shows how the execution time increases depending on the length of the vector.  It should be noted that if simple operations such as addition / subtraction predominate in the calculations, there will be practically no difference between the time spent on the CPU and the GPU.  Moreover, it is very likely that the GPU will lose due to the overhead of working with memory. <br><div style="text-align:center;"><img src="http://habrastorage.org/files/170/959/8ed/1709598ed0ad451099c188f3cdd97f8d.png"></div><br><div class="spoiler">  <b class="spoiler_title">Hidden text</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">gpu_time &lt;- c() cpu_time &lt;- c() n &lt;- seq.int(<span class="hljs-number"><span class="hljs-number">1e4</span></span>, <span class="hljs-number"><span class="hljs-number">1e8</span></span>, length.<span class="hljs-keyword"><span class="hljs-keyword">out</span></span>=<span class="hljs-number"><span class="hljs-number">30</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> n) { v &lt;- rnorm(i, <span class="hljs-number"><span class="hljs-number">1000</span></span>) gpu_time &lt;- c(gpu_time, <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time({p1 &lt;- gpunrm(v)})[<span class="hljs-number"><span class="hljs-number">1</span></span>]) cpu_time &lt;- c(cpu_time, <span class="hljs-keyword"><span class="hljs-keyword">system</span></span>.time({p2 &lt;- sqrt(sum(v^<span class="hljs-number"><span class="hljs-number">6</span></span>))})[<span class="hljs-number"><span class="hljs-number">1</span></span>]) }</code> </pre><br></div></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h3>  Conclusion </h3><br>  In fact, in R, operations for working with matrices and vectors are very well optimized, and the need to use a GPU in everyday life does not occur very often, but sometimes a GPU can significantly reduce the calculation time.  In CRAN, there are already ready-made packages (for example, <code>gputools</code> ) adapted for working with the GPU ( <a href="https://thirdwing.github.io/2013/10/06/r-and-gpu/">here</a> you can read more about this). <br><br><h4>  Links </h4><br>  1. <a href="http://www.biostat.jhsph.edu/~rpeng/docs/interface.pdf">An Introduction to the .C Interface to R</a> <br>  2. <a href="https://www.stat.berkeley.edu/classes/s243/calling.pdf">Calling C Functions in R and Matlab</a> <br>  3. <a href="http://www.themattsimpson.com/2012/06/29/writing-cuda-c-extensions-for-r/">Writing CUDA C extensions for R</a> <br>  4. <a href="http://docs.nvidia.com/cuda/thrust/">Thrust :: CUDA Toolkit Documentation</a> <br><br>  PS Corrected the first code snippet on the recommendation of <a href="https://habrahabr.ru/users/vird/" class="user_link">vird</a> . </div><p>Source: <a href="https://habr.com/ru/post/220927/">https://habr.com/ru/post/220927/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../220911/index.html">Consoles games: like falling in love with video games turned into an interesting game dev</a></li>
<li><a href="../220913/index.html">Nimbus Note - now on Android</a></li>
<li><a href="../220917/index.html">How is the musical search. Lecture in Yandex</a></li>
<li><a href="../220919/index.html">Ilon Musk officially confirmed the successful landing of the first stage of the Falcon-9</a></li>
<li><a href="../220921/index.html">Is the string operator + simple?</a></li>
<li><a href="../220931/index.html">Ultimaker 2</a></li>
<li><a href="../220937/index.html">Samsung will develop Tizen as a platform for smart home and is preparing a new flagship</a></li>
<li><a href="../220941/index.html">SKALA - ChNPP computer, history of creation</a></li>
<li><a href="../220947/index.html">AdMob, Qt 5.2 and Android or what happens when there is no answer on the Internet</a></li>
<li><a href="../220949/index.html">New requirements for Stanford University passwords: a balance between length and complexity</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>