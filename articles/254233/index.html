<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>System of centralized management of user authorization on FreeIPA in Docker</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the wake of Docker's popularity on Habr√©, after participating in some discussions in the comments regarding Docker, and due to the recent need to c...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>System of centralized management of user authorization on FreeIPA in Docker</h1><div class="post__text post__text-html js-mediator-article">  In the wake of Docker's popularity on Habr√©, after participating in some discussions in the comments regarding Docker, and due to the recent need to configure centralized authorization for a cluster of Linux machines, I decided to write a short note.  A bright, in my opinion, example of Docker‚Äôs application for a small private task will be shown here. <br><br>  This is, by the way, the FreeIPA WebUI ( <a href="https://www.freeipa.org/page/Demo">official demo</a> ) (clickable): <br><br> <a href=""><img src="https://habrastorage.org/files/9f1/a74/89a/9f1a7489a07f4455a8f4aa06374c555c.png"></a> <a href=""><img src="https://habrastorage.org/files/adb/b5a/e67/adbb5ae672254ce396d3e5fbfe997b3b.png"></a> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      What tasks I wanted to solve with the help of FreeIPA: <br><ol><li>  Have the ability to create / change / delete user accounts centrally, rather than on each individual server </li><li>  Centralized melting for sudo </li><li>  Later we will connect VPN authentication to this system, and then maybe other internal office services. </li></ol><br>  Yes, most likely FreeIPA in our case is a gun shot on sparrows, but on the other hand, there is no alternative to something.  I considered the following options: NIS (I think he should have gone on holiday for a long time), OpenLDAP + ... + ... (not very friendly, and FreeIPA has LDAP as a result, only we don‚Äôt have to deal with it directly) here the list ends, I have not found anything else. <br><br><a name="habracut"></a>  So let's get started! <br><br><h1>  Server Tuning </h1><br>  The list of technologies used: <br><ul><li>  <a href="https://www.freeipa.org/">FreeIPA</a> is an open source RedHat project that combines many other open source projects: 389 Directory Server, MIT Kerberos, NTP, DNS (bind), Dogtag certificate system, SSSD, and others.  At the same time, this solution has Web UI, CLI, XMLRPC, JSONRPC API and Python SDK. </li><li>  Dnsmasq is a lightweight DNS server (later I will explain why I needed it in addition to the bind that is used in FreeIPA). </li><li>  <a href="https://www.docker.com/">Docker</a> is an open-source platform that automates the deployment of applications into lightweight, portable, self-contained containers that can be transferred between servers without changes.  ¬© <a href="http://habrahabr.ru/company/infobox/blog/237405/">Use Docker and don't worry about vendor-lock</a> </li></ul><br><br>  FreeIPA, due to the fact that it is a product of RedHat, is naturally able to unfold well on CentOS and Fedora and practically doesn‚Äôt unfold on other distributions.  <i>(Note. I didn‚Äôt really set a goal, so there may be instructions somewhere, but there are no servers in Debian / Ubuntu for FreeIPA, but there is a client package <code>freeipa-client</code> , but more on that later.)</i> <br><br>  This fact never upset me, but, on the contrary, inspired me!  This is also an ideal task for Docker when on Debian / Ubuntu / Gentoo / etc servers.  That is, I could take the basic Fedora image, put the necessary packages there, pile everything up and run, BUT even the more pleasant news for me was the <a href="https://registry.hub.docker.com/u/adelton/freeipa-server/">official Docker freeipa-server image</a> (they have a client, but I was interested in the version with the client on Ubuntu , so I ran the ubuntu image in Docker and thus modeled and quickly started from the beginning to debug the process from scratch). <br><br>  In general, the launch of freeipa-server did not cause any problems, everything is in accordance with the documentation for the Docker image: <br><br><ol><li>  Create a directory that will be mounted into the FreeIPA configuration file, which must be left after the restart (the documentation suggests using <code>/var/lib/ipa-data/</code> , but I don‚Äôt like to clutter up the system, therefore <code>/opt/</code> ): <br><pre> <code class="bash hljs">$ sudo mkdir -p /opt/dockers/freeipa-data</code> </pre><br></li><li>  Add a file with options that will be used during the installation of freeipa-server: <br><pre> <code class="bash hljs">$ sudo tee /opt/dockers/freeipa-data/ipa-server-install-options --ds-password=The-directory-server-password --admin-password=The-admin-password</code> </pre><br></li><li>  Everything, we are launching (in the dock there is not enough port forwarding, although it is obvious what needs to be done; it is also worth noting that the dock says that you need to connect a partition with a postfix <code>:Z:rw</code> , but if you do not have SELinux, you need this option not needed (thanks to <a href="https://habrahabr.ru/users/grossws/" class="user_link">grossws</a> )): <br><pre> <code class="bash hljs">$ docker run \ --name freeipa-server-test \ -it \ --rm \ --hostname freeipa.example.test \ --volume /opt/dockers/freeipa-data:/data \ --publish <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> \ --publish <span class="hljs-string"><span class="hljs-string">"389:389"</span></span> \ --publish <span class="hljs-string"><span class="hljs-string">"636:636"</span></span> \ --publish <span class="hljs-string"><span class="hljs-string">"88:88"</span></span> \ --publish <span class="hljs-string"><span class="hljs-string">"88:88/udp"</span></span> \ --publish <span class="hljs-string"><span class="hljs-string">"464:464"</span></span> \ --publish <span class="hljs-string"><span class="hljs-string">"464:464/udp"</span></span> \ adelton/freeipa-server</code> </pre><br></li><li>  After a short installation, you will be kindly provided with <code>bash</code> - this is where the installation and configuration of FreeIPA Server is complete.  You can add freeipa.example.test to yourself in / etc / hosts, go to <a href="https://freeipa.example.test/">https: //freeipa.example.test/</a> , login as admin and create a user. </li></ol><br>  FreeIPA in its image raised a whole zoo of services, including bind (DNS), which it set up on its own (magic, which is almost impossible to repeat on other DNS).  For FreeIPA clients, it is expected that they will have access to this DNS, which still somehow cleverly failover to handle, only in the case of how it is here - all in one Docker image, I don‚Äôt really see the benefits of such a failover.  However, I didn‚Äôt go overboard and took into account the wishes of the FreeIPA developers (by the way, this is a feature of Kerberos, after all, FreeIPA simply combines many packages). <br><br>  So, what am I talking about DNS?  I needed DNS inside the cluster, but I absolutely did not want to get into the bind inside the FreeIPA container.  Therefore, I decided to use a proven solution - Dnsmasq.  The Docker Hub has a <a href="https://registry.hub.docker.com/u/andyshinn/dnsmasq/">minimalistic image of Dnsmasq, based on Alpine Linux</a> - 6MB. <br><br>  Here is how I prepared it: <br><ol><li>  Created a directory for configs: <br><pre> <code class="bash hljs">$ sudo mkdir -p /opt/dockers/dnsmasq.d</code> </pre><br></li><li>  I added dnsmasq config there: <br><pre> <code class="bash hljs">$ sudo tee /opt/dockers/dnsmasq.d/dnsmasq.conf address=/freeipa.example.test/10.12.0.172 address=/server00.example.test/10.12.0.172 address=/server01.example.test/10.12.0.173 address=/server02.example.test/10.12.0.174</code> </pre><br></li><li>  We start (DNS works on 53 / tcp and 53 / udp ports, so we forward them, the folder with configs): <br><pre> <code class="bash hljs">$ docker run \ --name dnsmasq-test \ --rm \ --publish 53:53 \ --publish 53:53/udp \ --<span class="hljs-built_in"><span class="hljs-built_in">cap</span></span>-add NET_ADMIN \ --volume /opt/dockers/dnsmasq.d:/etc/dnsmasq.d \ --entrypoint /bin/sh \ andyshinn/dnsmasq \ -c <span class="hljs-string"><span class="hljs-string">'/usr/sbin/dnsmasq -k -h --conf-dir /etc/dnsmasq.d/'</span></span></code> </pre><br></li><li>  Checking what works: <br><pre> <code class="bash hljs">$ nslookup server00.example.test 127.0.0.1</code> </pre></li></ol><br>  So we have FreeIPA Server in one container and Dnsmasq in another.  By the way, Dnsmasq, as you can see, doesn‚Äôt interact with the bind DNS server at all. <br><br>  Further I connected these two services in one <code>docker-compose.yml</code> : <br><div class="spoiler">  <b class="spoiler_title">docker-compose.yml</b> <div class="spoiler_text"><pre> <code class="hljs mel">dnsmasq: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: andyshinn/dnsmasq ports: - <span class="hljs-string"><span class="hljs-string">"53:53"</span></span> - <span class="hljs-string"><span class="hljs-string">"53:53/udp"</span></span> cap_add: - NET_ADMIN links: - freeipa volumes: - <span class="hljs-string"><span class="hljs-string">"/opt/dockers/dnsmasq.d:/etc/dnsmasq.d"</span></span> entrypoint: [<span class="hljs-string"><span class="hljs-string">"/bin/sh"</span></span>, <span class="hljs-string"><span class="hljs-string">"-c"</span></span>, <span class="hljs-string"><span class="hljs-string">"/usr/sbin/dnsmasq -k -h --conf-dir /etc/dnsmasq.d/ -S /example.test/`getent hosts freeipa | cut -f1 -d' '`"</span></span>] freeipa: <span class="hljs-keyword"><span class="hljs-keyword">image</span></span>: adelton/freeipa-server hostname: freeipa.example.test ports: - <span class="hljs-string"><span class="hljs-string">"443:443"</span></span> - <span class="hljs-string"><span class="hljs-string">"389:389"</span></span> - <span class="hljs-string"><span class="hljs-string">"636:636"</span></span> - <span class="hljs-string"><span class="hljs-string">"88:88"</span></span> - <span class="hljs-string"><span class="hljs-string">"88:88/udp"</span></span> - <span class="hljs-string"><span class="hljs-string">"464:464"</span></span> - <span class="hljs-string"><span class="hljs-string">"464:464/udp"</span></span> cap_add: - NET_ADMIN volumes: - <span class="hljs-string"><span class="hljs-string">"/opt/dockers/freeipa-data:/data"</span></span></code> </pre></div></div><br>  You may notice a little magic with an additional option to the dnsmasq command; this option will redirect requests to * .example.test to the bind DNS installed in the freeipa container. <br><br>  The convenience of <a href="https://docs.docker.com/compose/">Docker Compose</a> in this particular case is that its config is still easier to read than a bash script with a <code>docker run</code> .  And it's better to do it right away.  Save <code>docker-compose.yml</code> and run: <br><pre> <code class="bash hljs">$ docker-compose up -d</code> </pre><br>  C server is finally finished. <br><br><h1>  Customer setup </h1><br>  Here I have a solution in 3 teams :) <br><br><ol><li>  You need to fix / etc / hosts so that the first in the list is the fully qualified domain name (FQDN): <br><pre> <code class="hljs css">127<span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.1</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server00</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.test</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">server00</span></span></code> </pre><br></li><li>  Configure DNS (via <code>/etc/network/interfaces</code> or <code>/etc/resolvconf/resolv.conf.d/head</code> ) so that the following lines appear in <code>/etc/resolv.conf</code> : <br><pre> <code class="hljs css"><span class="hljs-selector-tag"><span class="hljs-selector-tag">nameserver</span></span> 10<span class="hljs-selector-class"><span class="hljs-selector-class">.12</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.0</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.172</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">search</span></span> <span class="hljs-selector-tag"><span class="hljs-selector-tag">example</span></span><span class="hljs-selector-class"><span class="hljs-selector-class">.test</span></span></code> </pre><br></li><li>  And now, by changing the admin password to FreeIPA in the following command, you can run it: <br><pre> <code class="bash hljs">$ sudo bash -c <span class="hljs-string"><span class="hljs-string">'bash -c "cat &gt; /usr/share/pam-configs/mkhomedir &lt;&lt;EOF Name: activate mkhomedir Default: yes Priority: 900 Session-Type: Additional Session: required pam_mkhomedir.so umask=0022 skel=/etc/skel EOF" &amp;&amp; DEBIAN_FRONTEND=noninteractive apt-get install -y freeipa-client &amp;&amp; ipa-client-install -U -N -p admin -w The-admin-password &amp;&amp; sed -i "s/services = .*/services = nss, pam, ssh, sudo/" /etc/sssd/sssd.conf &amp;&amp; restart sssd &amp;&amp; restart ssh'</span></span></code> </pre><br>  Here you will add a PAM module to automatically create home directories, install freeipa-client, launch the ipa-client installation, add sudo service to sssd.conf, and reload sssd and ssh. </li></ol><br>  That's all, now you can do su / sudo / ssh on this host, where the user will be forced to change the password during the very first login, and when you first log in on the new host, the user will automatically create a home directory from <code>/etc/skel</code> . <br><br><h1>  findings </h1><br>  Docker can simplify the deployment of complex projects in any infrastructure.  Docker has many uses and this is just one of them. <br><br>  In the future, I may be willing to write about another project that intensively uses resource limits integrated in Docker (CPU, RAM). </div><p>Source: <a href="https://habr.com/ru/post/254233/">https://habr.com/ru/post/254233/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../254221/index.html">MMORPG without too much detail: a year later</a></li>
<li><a href="../254223/index.html">About the effect of the applet on the iPhone in the LTE network</a></li>
<li><a href="../254227/index.html">Ban on bitcoin in Russia this fall?</a></li>
<li><a href="../254229/index.html">Dart 1.9. The release you have been waiting for</a></li>
<li><a href="../254231/index.html">We achieve OCSP stapling = Yes for certificates from WoSign on Nginx</a></li>
<li><a href="../254235/index.html">"The poor people" language Fortran</a></li>
<li><a href="../254237/index.html">From today, Intel is controlled by a computer</a></li>
<li><a href="../254239/index.html">Broadcast Event Messaging in Unity3D</a></li>
<li><a href="../254243/index.html">Setting up IPTV in OpenWRT Asus RT-N13U</a></li>
<li><a href="../254247/index.html">Launch the latest Linux kernel on Intel Edison</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>