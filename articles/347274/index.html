<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Own DBMS for 3 weeks. You just need a little time every day ...</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Own DBMS for 3 weeks. All you need is just a little time each day to devote to architecture; and all the rest of the time to work on the result, typin...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Own DBMS for 3 weeks. You just need a little time every day ...</h1><div class="post__text post__text-html js-mediator-article">  Own DBMS for 3 weeks.  All you need is just a little time each day to devote to architecture;  and all the rest of the time to work on the result, typing and reprinting hundreds of lines of code. <br><br>  By law, Murphy, if there is more than one project to choose from - I will take up the most difficult of the proposed.  It happened with the last task of the course on database management systems (DBMS). <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/rc/0n/pg/rc0npgm2cp9pwpwb6hpcknftmd0.jpeg" alt="cover / dropSQL"></div><br><a name="habracut"></a><br><h2>  Formulation of the problem </h2><br>  According to the statement of work, it was necessary to create a DBMS from scratch on Vanilla Python 3.6 (without third-party libraries).  The final product must have the following properties: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <ul><li>  stores database in binary format in a single file </li><li>  DDL: supports three data types: Integer, Float and Varchar (N).  For simplicity, they are all fixed lengths. </li><li>  DML: supports basic SQL operations: <br><ul><li>  INSERT </li><li>  UPDATE </li><li>  DELETE </li><li>  SELECT with WHERE and JOIN.  With which particular JOIN - it was not indicated, so just in case we did both CROSS and INNER </li></ul></li><li>  maintains 100'000 records </li></ul><br><hr><br><h2>  Design Approach </h2><br>  Developing a DBMS from scratch seemed like a non-trivial task (oddly enough, the way it turned out).  Therefore, we - <a href="https://github.com/ecat3">ecat3</a> and <a href="http://ratijas.tk/">@ratijas</a> - have approached this matter scientifically.  There are only two of us in the team (apart from myself and my person), which means it is easier to cut tasks and coordinate their implementation than, in fact, to fulfill them.  At the end of the cut came out as follows: <br><table><tbody><tr><th>  Task </th><th>  Artist (s) </th></tr><tr><td>  Parser + AST + REPL </td><td>  ratijas, who wrote more than one calculator on every lex / yacc </td></tr><tr><td>  Base file structure </td><td>  ecat3, who ate the dog on file systems </td></tr><tr><td>  Engine <br>  (low-level base operations) </td><td>  ecat3 </td></tr><tr><td>  Interface <br>  (high-level gluing) </td><td>  Together </td></tr></tbody></table><br>  Initially, the time was allocated two weeks, so it was supposed to perform individual tasks for the week, and the remaining time was spent jointly on gluing and testing. <br><br>  With the formal part finished, we turn to the practical.  DBMS should be modern and relevant.  In modern Innopolis, the Telegraph messenger, chat bots and group communication with the help of "/ slash tags" (this is # hashtags, just start with / slash) is relevant.  Therefore, the query language, closely resembling SQL, is not only case-insensitive, it is also not sensitive to / slash immediately before any identifier: 'SELECT' and '/ select' are absolutely the same thing.  In addition, like any university student, each language statement (statement) must be completed with '/ drop'.  (Of course, also irrespective of the register. Who in general in such a situation is concerned with some sort of register?) <br><br><div class="spoiler">  <b class="spoiler_title">Typical / day in / chat</b> <div class="spoiler_text"><img src="https://habrastorage.org/webt/ss/kn/f3/ssknf3opseg5poir4yqfpqpu5ai.png" alt="/ autist_s_dr" align="left"></div></div><br>  So the idea of ‚Äã‚Äãthe name was born: <strong>dropSQL</strong> .  Actually <em>/ drop'om</em> is called the expulsion of a student from the university;  for some reason, this word has become widespread in our Innopolis.  (Another local phenomenon: autism, or, more correctly, / autism. But we saved it for a special occasion.) <br><br>  First of all, decomposed the dropSQL grammar on BNF (and in vain - left-handed recursions are not suitable for downstream parsers). <br><br><div class="spoiler">  <b class="spoiler_title">BNF grammar dropSQL</b> <div class="spoiler_text">  <a href="https://github.com/ratijas/dropSQL/blob/master/src/dropSQL/parser/__init__.py">Full version of the link</a> <br><br><pre><code class="hljs sql">/stmt : /create_stmt | /drop_stmt | /insert_stmt | /update_stmt | /delete_stmt | /select_stmt ; /create_stmt : "/<span class="hljs-keyword"><span class="hljs-keyword">create</span></span><span class="hljs-string"><span class="hljs-string">" "</span></span><span class="hljs-keyword"><span class="hljs-keyword">table</span></span><span class="hljs-string"><span class="hljs-string">" existence /table_name "</span></span>(<span class="hljs-string"><span class="hljs-string">" /columns_def "</span></span>)<span class="hljs-string"><span class="hljs-string">" "</span></span>/<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span><span class="hljs-string"><span class="hljs-string">" ; existence : /* empty */ | "</span></span><span class="hljs-keyword"><span class="hljs-keyword">if</span></span><span class="hljs-string"><span class="hljs-string">" "</span></span><span class="hljs-keyword"><span class="hljs-keyword">not</span></span><span class="hljs-string"><span class="hljs-string">" "</span></span><span class="hljs-keyword"><span class="hljs-keyword">exists</span></span><span class="hljs-string"><span class="hljs-string">" ; /table_name : /identifier ; /columns_def : /column_def | /columns_def "</span></span>,<span class="hljs-string"><span class="hljs-string">" /column_def ; /column_def : /column_name type /primary_key ; ...</span></span></code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Examples of valid dropSQL commands from the online product help</b> <div class="spoiler_text"><pre> <code class="sql hljs">/<span class="hljs-keyword"><span class="hljs-keyword">create</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> t(a <span class="hljs-built_in"><span class="hljs-built_in">integer</span></span>, b <span class="hljs-built_in"><span class="hljs-built_in">float</span></span>, c <span class="hljs-built_in"><span class="hljs-built_in">varchar</span></span>(<span class="hljs-number"><span class="hljs-number">42</span></span>)) /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">insert</span></span> <span class="hljs-keyword"><span class="hljs-keyword">into</span></span> t (a, c, b) <span class="hljs-keyword"><span class="hljs-keyword">values</span></span> (<span class="hljs-number"><span class="hljs-number">42</span></span>, <span class="hljs-string"><span class="hljs-string">'morty'</span></span>, <span class="hljs-number"><span class="hljs-number">13.37</span></span>), (?<span class="hljs-number"><span class="hljs-number">1</span></span>, ?<span class="hljs-number"><span class="hljs-number">2</span></span>, ?<span class="hljs-number"><span class="hljs-number">3</span></span>) /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">select</span></span> *, a, <span class="hljs-number"><span class="hljs-number">2</span></span> * b, c /<span class="hljs-keyword"><span class="hljs-keyword">as</span></span> d <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">Alias</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">where</span></span> (a &lt; <span class="hljs-number"><span class="hljs-number">100</span></span>) /<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (c /= <span class="hljs-string"><span class="hljs-string">''</span></span>) /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">update</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">set</span></span> c = <span class="hljs-string"><span class="hljs-string">'rick'</span></span>, a = a + <span class="hljs-number"><span class="hljs-number">1</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">delete</span></span> <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> t <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> c &gt; <span class="hljs-string"><span class="hljs-string">'r'</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span> <span class="hljs-keyword"><span class="hljs-keyword">table</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">exists</span></span> t /<span class="hljs-keyword"><span class="hljs-keyword">drop</span></span></code> </pre></div></div><br><hr><br><h2>  We work on the result!  No exceptions! </h2><br>  After several months with Rust as the main language, I really didn‚Äôt want to get bogged down again in exception handling.  An obvious argument against exceptions is that it is expensive to throw them around and cumbersome to catch.  The situation is worsened by the fact that Python, even in version 3.6 with Type Annotations, in contrast to the same Java, does not allow you to specify the types of exceptions that can fly out of the method.  In other words: looking at the method signature, it should become clear what to expect from it.  So why not unite these types under one roof, which is called ‚Äúenum Error‚Äù?  And above this, create another ‚Äúroof‚Äù called Result;  it will be discussed below.  Of course, in the standard library there are places that can "explode";  but such calls in our code are reliably enclosed with try'yami from all sides, which reduce any exception to the return of an error, minimizing the occurrence of abnormal situations during execution. <br><br>  So, it was decided to cycle the algebraic type of the result (hello, Rust).  In python with algebraic types, everything is bad;  and the module of the standard <a href="https://docs.python.org/3/library/enum.html">enum</a> library is more like a clean sishechka. <br><br>  In the worst traditions of OOP, we use inheritance to determine the result constructors: Ok and Err.  And don't forget about static typing ( <em>Well, maaam, I already have the third version! Can I finally have static typing in Python, well, please?</em> ): <br><br><div class="spoiler">  <b class="spoiler_title">result.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-keyword"><span class="hljs-keyword">import</span></span> abc <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> typing <span class="hljs-keyword"><span class="hljs-keyword">import</span></span> * <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Generic[T, E], metaclass=abc.ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" enum Result&lt; T &gt; { Ok(T), Err(E), } """</span></span> <span class="hljs-comment"><span class="hljs-comment">#        def is_ok(self) -&gt; bool: return False def is_err(self) -&gt; bool: return False def ok(self) -&gt; T: raise NotImplementedError def err(self) -&gt; E: raise NotImplementedError ... class Ok(Generic[T, E], Result[T, E]): def __init__(self, ok: T) -&gt; None: self._ok = ok def is_ok(self) -&gt; bool: return True def ok(self) -&gt; T: return self._ok ... class Err(Generic[T, E], Result[T, E]): def __init__(self, error: E) -&gt; None: self._err = error def is_err(self) -&gt; bool: return True def err(self) -&gt; E: return self._err ...</span></span></code> </pre><br></div></div><br>  Fine!  Spice up a bit of functional transformation sauce.  Not all are needed, so take the necessary minimum. <br><br><div class="spoiler">  <b class="spoiler_title">result.py (continued)</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Result</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Generic[T, E], metaclass=abc.ABCMeta)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">ok_or</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, default: T)</span></span></span><span class="hljs-function"> -&gt; T:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">err_or</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, default: E)</span></span></span><span class="hljs-function"> -&gt; E:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">map</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, f: Callable[[T], U])</span></span></span><span class="hljs-function"> -&gt; 'Result[U, E]':</span></span> <span class="hljs-comment"><span class="hljs-comment"># -!           ? # ,   Python    "forward declaration". #    -.    PEP 484: # https://www.python.org/dev/peps/pep-0484/#forward-references ... def and_then(self, f: Callable[[T], 'Result[U, E]']) -&gt; 'Result[U, E]': ... def __bool__(self) -&gt; bool: #    `if` return self.is_ok()</span></span></code> </pre><br></div></div><br>  And immediately use example: <br><br><div class="spoiler">  <b class="spoiler_title">Result usage example</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">try_int</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(x: str)</span></span></span><span class="hljs-function"> -&gt; Result[int, str]:</span></span> <span class="hljs-keyword"><span class="hljs-keyword">try</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(int(x)) <span class="hljs-keyword"><span class="hljs-keyword">except</span></span> ValueError <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> e: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Err(str(e)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">fn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(arg: str)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> r = try_int(arg) <span class="hljs-comment"><span class="hljs-comment"># 'r' for 'Result' if not r: return print(r.err()) # one-liner, shortcut for `if r.is_err()` index = r.ok() print(index) # do something with index</span></span></code> </pre><br></div></div><br>  Scribble in this style still takes 3 lines for each challenge.  But, on the other hand, there comes a clear understanding of where any mistakes could occur, and what will happen to them.  Plus, the code continues at the same level of nesting;  this is a very important quality if the method contains half a dozen homogeneous calls. <br><br><hr><br><h2>  Parser, iResult, Error :: {Empty, Incomplete, Syntax}, REPL, 9600 baud and all </h2><br>  Parser took a significant part of the development time.  A competently composed parser should provide the user with the convenience of using the front-end of the product.  The most important tasks of the parser are: <br><br><ol><li>  Distinct error reports </li><li>  Interactive incremental line input, or, more simply, REPL </li></ol><br>  Having ‚Äúnot only the whole‚Äù standard python library, but also our modest knowledge of writing parsers, we understood that we would have to roll up our sleeves, and scroll down to a manual recursive descending parser.  This is a long, dreary business, but it gives a high degree of control over the situation. <br><br>  One of the first questions that required an answer: how to deal with errors?  How to be - have already figured out above.  But what exactly is a mistake?  For example, after ‚Äú/ create table‚Äù there may be ‚Äúif not exists‚Äù or it may not be ‚Äî is this a mistake?  If so, what kind?  where should be processed?  ("Pause," and offer your options in the comments.) <br><br>  <a href="https://github.com/ratijas/dropSQL/blob/ec01b4fda5e4137c4bee2ccc0082365451635935/src/dropSQL/parser/expected.py">The first version of the</a> parser distinguished two types of errors: Expected (they expected one, but received something else) and EOF (end of file) as a subclass of the previous one.  Nothing, until it came to the REPL.  Such a parser does not distinguish between partial input (the beginning of a command) and the absence of something (EOF, if you can say so about interactive input from a terminal).  Only a week later, through trial and error, we managed to find a scheme that would satisfy our domain domain. <br><br>  The scheme is that everything is a thread, and the parser is only a modest <em>next ()</em> method for the stream.  And also that the error class should be rewritten to algebraic (like Result), and instead of <em>EOF</em> , the <em>Empty</em> and <em>Incomplete</em> variants are introduced. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/8fe/48e/b71/8fe48eb71aa5f92aa6be3d22d135aa32.jpg" alt="everything is a stream"></div><br><br><div class="spoiler">  <b class="spoiler_title">New type of error</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Error</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=abc.ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-string"><span class="hljs-string">""" enum Error { Empty, Incomplete, Syntax { expected: str, got: str }, } """</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">empty_to_incomplete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; 'Error':</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(self, Empty): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Incomplete() <span class="hljs-keyword"><span class="hljs-keyword">else</span></span>: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> self <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Empty</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Error)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Incomplete</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Error)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Syntax</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Error)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, expected: str, got: str)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> ... <span class="hljs-comment"><span class="hljs-comment"># stream-specific result type alias IResult = Result[T, Error] IOk = Ok[T, Error] IErr = Err[T, Error]</span></span></code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">Flow interface</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Stream</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Generic[T], metaclass=abc.ABCMeta)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">current</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; IResult[T]:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; IResult[T]:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">collect</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; IResult[List[T]]:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">peek</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; IResult[T]:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">back</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, n: int = </span></span><span class="hljs-number"><span class="hljs-function"><span class="hljs-params"><span class="hljs-number">1</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> ... @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_impl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; IResult[T]:</span></span> ...</code> </pre><br></div></div><br>  Stream is an abstraction.  Flow anyway, what elements to produce.  The stream knows when to stop.  All that is required to implement your thread is to rewrite the single abstract method <em>next_impl () -&gt; IResult [T]</em> .  What should this method return?  Consider the flow of tokens as an example: <br><table><tbody><tr><th>  What's next </th><th>  Example (input) </th><th>  Result Type </th><th>  Example (result) </th></tr><tr><td>  Everything is fine, another element </td><td><pre>  / delete from t ... </pre></td><td>  IOk (token) </td><td>  IOk (Delete ()) </td></tr><tr><td>  Only spaces and comments left </td><td><pre>  \ n - wubba </pre><br><pre>  - lubba </pre><br><pre>  - dub dub! </pre></td><td>  IErr (Empty ()) </td><td>  IErr (Empty ()) </td></tr><tr><td>  The beginning of something bigger </td><td><pre>  'string ... </pre>  (no closing quote) </td><td>  IErr (Incomplete ()) </td><td>  IErr (Incomplete ()) </td></tr><tr><td>  Do you rub me some game </td><td><pre>  # $% </pre></td><td>  IErr (Syntax (...)) </td><td>  IErr (Syntax (expected = 'token', got = '#')) </td></tr></tbody></table><br><br>  Threads are organized into a <a href="https://github.com/ratijas/dropSQL/tree/master/src/dropSQL/parser/streams">hierarchy</a> .  Each level contains its own buffer, which allows you to look ahead ( <em>peek () -&gt; IResult [T]</em> ) and roll back ( <em>back (n: int = 1) -&gt; None</em> ) if necessary. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/zz/_z/hc/zz_zhcvelzsfonpcyqwvkxaf6sa.png" alt="Thread hierarchy"></div><br><br>  And the best part is that the stream can be " <a href="https://github.com/ratijas/dropSQL/blob/12cb1c6137c33f2ab249caa620bad3c7b2b2fd70/src/dropSQL/parser/streams/stream.py">collected</a> " into one big list of all <em>IOk (</em> elements <em>)</em> , which gives <em>next ()</em> - before the first <em>IErr ()</em> , of course.  At what the list will return only when <em>IErr</em> contained <em>Empty</em> ;  otherwise, an error is forwarded above.  This design makes it easy and elegant to build a REPL. <br><br><div class="spoiler">  <b class="spoiler_title">The basis of the REPL</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Repl</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">reset</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.buffer = <span class="hljs-string"><span class="hljs-string">''</span></span> self.PS = self.PS1 <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">start</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function">:</span></span> self.reset() <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> <span class="hljs-keyword"><span class="hljs-keyword">True</span></span>: self.buffer += input(self.PS) self.buffer += <span class="hljs-string"><span class="hljs-string">'\n'</span></span> stmts = Statements.from_str(self.buffer).collect() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> stmts.is_ok(): ... <span class="hljs-comment"><span class="hljs-comment"># execute one-by-one self.reset() elif stmts.err().is_incomplete(): self.PS = self.PS2 # read more elif stmts.err().is_syntax(): print(stmts.err()) self.reset() else: pass # ignore Err(Empty())</span></span></code> </pre><br></div></div><br><h3>  Characters </h3><br>  This thread traverses the string characters.  The only type of error: <em>Empty</em> at the end of the line. <br><br><h3>  Tokens </h3><br>  Stream tokens.  His middle name is Lexer.  There are errors, strings without closing quotes, and all ... <br><br>  Each type of tokens, including each keyword separately, is represented by a separate class-variant of the abstract class Token (or is it better to think about it as enum Token?) This is so that the statements parser can conveniently cast tokens to specific types. <br><br><div class="spoiler">  <b class="spoiler_title">Typical lexer part</b> <div class="spoiler_text"><pre> <code class="python hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_impl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, ...)</span></span></span><span class="hljs-function"> -&gt; IResult[Token]:</span></span> ... char = self.characters.current().ok() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> char == <span class="hljs-string"><span class="hljs-string">','</span></span>: self.characters.next() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IOk(Comma()) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> char == <span class="hljs-string"><span class="hljs-string">'('</span></span>: self.characters.next() <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> IOk(LParen()) <span class="hljs-keyword"><span class="hljs-keyword">elif</span></span> ...</code> </pre><br></div></div><br><h3>  Statements </h3><br>  The climax, the parser itself.  Instead of a thousand words, a couple of snippets: <br><br><div class="spoiler">  <b class="spoiler_title">streams / statements.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Statements</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(Stream[AstStmt])</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, tokens: Stream[Token])</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> super().__init__() self.tokens = tokens @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from_str</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, source: str)</span></span></span><span class="hljs-function"> -&gt; 'Statements':</span></span> <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Statements(Tokens.from_str(source)) <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">next_impl</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; IResult[AstStmt]:</span></span> t = self.tokens.peek() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> t: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Err(t.err()) tok = t.ok() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(tok, Create): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> CreateTable.from_sql(self.tokens) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(tok, Drop): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DropTable.from_sql(self.tokens) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(tok, Insert): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> InsertInto.from_sql(self.tokens) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(tok, Delete): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> DeleteFrom.from_sql(self.tokens) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(tok, Update): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> UpdateSet.from_sql(self.tokens) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> isinstance(tok, Select): <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> SelectFrom.from_sql(self.tokens) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Err(Syntax(<span class="hljs-string"><span class="hljs-string">'/create, /drop, /insert, /delete, /update or /select'</span></span>, str(tok)))</code> </pre><br></div></div><br><div class="spoiler">  <b class="spoiler_title">ast / delete_from.py</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">DeleteFrom</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(AstStmt)</span></span></span><span class="hljs-class">:</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">__init__</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, table: Identifier, where: Optional[Expression])</span></span></span><span class="hljs-function"> -&gt; </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">None</span></span></span><span class="hljs-function">:</span></span> super().__init__() self.table = table self.where = where @classmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">from_sql</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(cls, tokens: Stream[Token])</span></span></span><span class="hljs-function"> -&gt; IResult['DeleteFrom']:</span></span> <span class="hljs-string"><span class="hljs-string">""" /delete_stmt : "/delete" "from" /table_name /where_clause /drop ; """</span></span> <span class="hljs-comment"><span class="hljs-comment"># next item must be the "/delete" token t = tokens.next().and_then(Cast(Delete)) if not t: return IErr(t.err()) t = tokens.next().and_then(Cast(From)) if not t: return IErr(t.err().empty_to_incomplete()) t = tokens.next().and_then(Cast(Identifier)) if not t: return IErr(t.err().empty_to_incomplete()) table = t.ok() t = WhereFromSQL.from_sql(tokens) if not t: return IErr(t.err().empty_to_incomplete()) where = t.ok() t = tokens.next().and_then(Cast(Drop)) if not t: return IErr(t.err().empty_to_incomplete()) return IOk(DeleteFrom(table, where))</span></span></code> </pre><br></div></div><br>  It is important to note that any errors of type <em>Empty</em> , except the very first one, parsers must convert to <em>Incomplete</em> , for the REPL to work correctly.  For this there is an auxiliary function <em>empty_to_incomplete () -&gt; Error</em> .  What is not, and never will be, is a macro: the line <em>if not t: return IErr (t.err (). Empty_to_incomplete ())</em> occurs in the codebase at least 50 times, and nothing can be done here.  Seriously, at some point, I wanted to use Sishny preprocessor. <br><br><hr><br><h2>  Pro binary format </h2><br>  Globally, the database file is divided into blocks, and the file size is a multiple of the block size.  The default block size is 12 KiB, but can optionally be increased to 18, 24, or 36 KiB.  If you are a Satanist on the master's date, and you have very big data, you can even raise up to 42 KiB. <br><br>  The blocks are numbered from scratch.  The null block contains metadata about the entire database.  Behind him are 16 blocks under the table metadata.  Block # 17 begins with data blocks.  <strong>A pointer to the block</strong> is the ordinal number of the block. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/6d/np/xp/6dnpxprn9mbznje8tcv-o3ljsbc.png" alt="File"></div><br>  <strong>The base metadata is</strong> currently not so much: the name is up to 256 bytes in length and the number of data blocks. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/4u/05/up/4u05upvnj-rccevgxf40lacisbm.png" alt="Database meta"></div><br>  <strong>Meta-block table is the</strong> most difficult.  The table name, the list of all columns with their types, the number of records and pointers to data blocks are stored here. <br><br>  The number of tables is fixed in the code.  Although this can be corrected relatively easily, if you store pointers to table meta-blocks in the base meta-block. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/db/xt/rd/dbxtrd_bvzk0fey90paacc8lxve.png" alt="Table meta"></div><br>  Pointers to blocks operate on the principle of <a href="https://en.wikipedia.org/wiki/Inode_pointer_structure">pointers in the inode</a> .  Tanenbaum and dozens of other respected people wrote beautifully about this.  Thus, the tables see their data blocks as ‚Äúpages‚Äù.  The difference is that the pages that come from the point of view of the table in order, are physically located in the file as God will put per capita.  Drawing analogies with virtual memory in operating systems, page: virtual page number, block: physical page number. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/getpro/habr/post_images/288/13c/9ce/28813c9cea052290bae8051669fa5536.gif" alt="inode pointer structure"></div><br>  Data blocks do not have a specific structure by themselves.  But when they are combined in the order dictated by pointers, they will appear as a continuous stream of records (record / tuple) of a fixed length.  Thus, knowing the sequence number of the record, extract or write it - an operation of almost constant time, O (1 <sup>*</sup> ), with depreciation on the allocation of new blocks, if necessary. <br><br>  The first byte of the record contains information about whether this record is alive or has been deleted.  The rest of the work on packing and unpacking data takes the standard module <a href="https://docs.python.org/3/library/struct.html">struct</a> . <br><br>  The / update operation always does an in-place rewrite, and the / delete only replaces the first byte.  VACUUM operation is not supported. <br><br><div style="text-align:center;"><img src="https://habrastorage.org/webt/em/_g/n4/em_gn4s3q2avpystlsgg3swfzfa.png" alt="Data blocks"></div><br><hr><br><h2>  About table operations, RowSet and joins </h2><br>  The time has come to firmly fasten the best of two worlds with a few skeins of tape. <br><br>  <strong>MC on the left</strong> - AST top level nodes (AstStmt subclasses).  Their execution occurs in the context of a database connection.  Positional arguments are also supported - "? N" tokens in expressions in the request body, for example: "/ delete from student / where name =? 1 / drop".  The <a href="https://github.com/ratijas/dropSQL/blob/master/src/dropSQL/ast/expression.py">expressions</a> themselves are recursive, and their calculation does not constitute a scientific breakthrough. <br><br>  <strong>The MC on the right</strong> is the database driver, which operates on the records one at a time, using the sequence number inside the table as an identifier.  Only he knows which tables exist and how to work with them. <br><br>  Go! <br><br>  Their first joint single about <strong>creativity</strong> .  Creating a new table is no more difficult than taking the first empty descriptor from 16, and enter the name and list of columns there. <br><br>  Then, the track with the symbolic name <strong>/ drop</strong> .  In the home version of the demo, the following happens: 1) find the table descriptor by name;  2) reset.  Who cares about non-freed blocks with data pages? <br><br>  <strong>Insert is</strong> lenient to disrupting the order of columns, so before sending a tuple to write, it is passed through a special filter <a href="https://github.com/ratijas/dropSQL/blob/8c2431a96ff5216d09d92ba8089ae6ddac057f93/src/dropSQL/ast/insert_into.py">transition_vector</a> . <br><br>  Next, we will talk about working with records of tables, so let us immediately introduce our referee: <strong>RowSet</strong> . <br><br><div class="spoiler">  <b class="spoiler_title">Spherical RowSet in vacuum</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">RowSet</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(metaclass=abc.ABCMeta)</span></span></span><span class="hljs-class">:</span></span> @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">columns</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; List[Column]:</span></span> <span class="hljs-string"><span class="hljs-string">""" Describe columns in this row set. """</span></span> @abc.abstractmethod <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">iter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self)</span></span></span><span class="hljs-function"> -&gt; Iterator['Row']:</span></span> <span class="hljs-string"><span class="hljs-string">""" Return a generator which yields rows from the underlying row stream or a table. """</span></span></code> </pre><br></div></div><br>  The main specific subspecies of this beast - <a href="https://github.com/ratijas/dropSQL/blob/8c2431a96ff5216d09d92ba8089ae6ddac057f93/src/dropSQL/engine/row_set/table.py">TableRowSet</a> - is engaged in the selection of all live (not deleted) records in order.  Other varieties of RowSet in dropSQL implement the necessary minimum of <a href="https://habrahabr.ru/post/145381/">relational algebra</a> . <br><br><table><tbody><tr><th>  Relational algebra operator </th><th>  Designation </th><th>  Class </th></tr><tr><td>  Projection </td><td>  œÄ <sub>(ID, NAME)</sub> expr </td><td><pre>  ProjectionRowSet </pre></td></tr><tr><td>  Rename </td><td>  œÅ <sub>a / b</sub> expr </td><td><pre>  ProjectionRowSet +
 RenameTableRowSet </pre></td></tr><tr><td>  Sample </td><td>  œÉ <sub>(PRICE&gt; 90)</sub> expr </td><td><pre>  FilteredRowSet </pre></td></tr><tr><td>  Cartesian product </td><td>  PRODUCTS √ó SELLERS </td><td><pre>  CrossJoinRowSet </pre></td></tr><tr><td>  Inner join <br>  (let's call it an extension) </td><td>  œÉ <sub>(cond)</sub> (A x B) </td><td><pre>  InnerJoinRowSet =
 FilteredRowSet (
     CrossJoinRowSet (...)) </pre></td></tr></tbody></table><br>  In addition, there is still a programmable MockRowSet.  It is good for testing.  Also, it can be used to access the <strong>master table</strong> called " <u>/ autism</u> ". <br><br>  The beauty is that different RowSets can be combined as you wish: choose the student table, specify the alias S, filter the / where scholarship&gt; 12k, choose another table of courses, connect the / on (course / sid = S / id) / and (course / grade &lt;'B') ", project to" S / id, S / first_name / as / name "- this is represented by the following hierarchy: <br><br><pre> <code class="python hljs">ProjectionRowSet([S/id, S/first_name/<span class="hljs-keyword"><span class="hljs-keyword">as</span></span>/name]) FilteredRowSet((course/sid = S/id) /<span class="hljs-keyword"><span class="hljs-keyword">and</span></span> (course/grade &lt; <span class="hljs-string"><span class="hljs-string">'B'</span></span>)) CrossJoinRowSet FilteredRowSet(scholarship &gt; <span class="hljs-string"><span class="hljs-string">'12k'</span></span>) RenameTableRowSet(<span class="hljs-string"><span class="hljs-string">'S'</span></span>) TableRowSet(<span class="hljs-string"><span class="hljs-string">'student'</span></span>) TableRowSet(<span class="hljs-string"><span class="hljs-string">'courses'</span></span>)</code> </pre><br>  So, armed with such a powerful instrument, we return to the lute music of the XVI century ... <br><br>  About the fourth track, <strong>/ select</strong> , there is nothing more to add.  The symphony from RowSet is such that it fascinates the soul.  Due to this, the implementation was extremely concise. <br><br><div class="spoiler">  <b class="spoiler_title">Implementation / select ... from</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SelectFrom</span></span></span><span class="hljs-params"><span class="hljs-class"><span class="hljs-params">(AstStmt)</span></span></span><span class="hljs-class">:</span></span> ... <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(self, db: </span></span><span class="hljs-string"><span class="hljs-function"><span class="hljs-params"><span class="hljs-string">'fs.DBFile'</span></span></span></span><span class="hljs-function"><span class="hljs-params">, args: ARGS_TYPE = </span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params"><span class="hljs-params">()</span></span></span></span><span class="hljs-function"><span class="hljs-params">)</span></span></span><span class="hljs-function"> -&gt; Result['RowSet', str]:</span></span> r = self.table.row_set(db) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> r: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Err(r.err()) rs = r.ok() <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> join <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> self.joins: r = join.join(rs, db, args) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> r: <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Err(r.err()) rs = r.ok() <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> self.where <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">not</span></span> <span class="hljs-keyword"><span class="hljs-keyword">None</span></span>: rs = FilteredRowSet(rs, self.where, args) rs = ProjectionRowSet(rs, self.columns, args) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> Ok(rs)</code> </pre><br></div></div><br>  The last two: <strong>/ update</strong> and <strong>/ delete</strong> use the predecessor's work.  With that, / update uses a technique similar to the ‚Äútransition_vector‚Äù described above. <br><br>  Such a concert!  Thanks for attention!  A curtain!.. <br><br><hr><br><h2>  Wishlist </h2><br>  Dreams that haven't come true yet: <br><br><ol><li>  Support / primary key not only in the parser </li><li>  Unary operators </li><li>  Subqueries </li><li>  Type inference for expressions </li><li>  Convenient API for Python </li></ol><br>  Since this was an educational project, we did not get a penny for it.  Although, judging by the statistics of sloc, you could now eat red caviar. <br><br><div class="spoiler">  <b class="spoiler_title">Sloccount report</b> <div class="spoiler_text"><pre> <code class="hljs coffeescript">Have a non-directory at the top, so creating directory top_dir Creating filelist <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> dropSQL Creating filelist <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> tests Creating filelist <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> util Categorizing files. Finding a working MD5 command.... Found a working MD5 command. Computing results. SLOC Directory SLOC-<span class="hljs-keyword"><span class="hljs-keyword">by</span></span>-Language (Sorted) <span class="hljs-number"><span class="hljs-number">2764</span></span> dropSQL python=<span class="hljs-number"><span class="hljs-number">2764</span></span> <span class="hljs-number"><span class="hljs-number">675</span></span> tests python=<span class="hljs-number"><span class="hljs-number">675</span></span> <span class="hljs-number"><span class="hljs-number">28</span></span> util python=<span class="hljs-number"><span class="hljs-number">28</span></span> Totals grouped <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> language (dominant language first): python: <span class="hljs-number"><span class="hljs-number">3467</span></span> (<span class="hljs-number"><span class="hljs-number">100.00</span></span>%) Total Physical Source Lines <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Code (SLOC) = <span class="hljs-number"><span class="hljs-number">3</span></span>,<span class="hljs-number"><span class="hljs-number">467</span></span> Development Effort Estimate, Person-Years (Person-Months) = <span class="hljs-number"><span class="hljs-number">0.74</span></span> (<span class="hljs-number"><span class="hljs-number">8.85</span></span>) (Basic COCOMO model, Person-Months = <span class="hljs-number"><span class="hljs-number">2.4</span></span> * (KSLOC**<span class="hljs-number"><span class="hljs-number">1.05</span></span>)) Schedule Estimate, Years (Months) = <span class="hljs-number"><span class="hljs-number">0.48</span></span> (<span class="hljs-number"><span class="hljs-number">5.73</span></span>) (Basic COCOMO model, Months = <span class="hljs-number"><span class="hljs-number">2.5</span></span> * (person-months**<span class="hljs-number"><span class="hljs-number">0.38</span></span>)) Estimated Average Number <span class="hljs-keyword"><span class="hljs-keyword">of</span></span> Developers (Effort/Schedule) = <span class="hljs-number"><span class="hljs-number">1.55</span></span> Total Estimated Cost to Develop = $ <span class="hljs-number"><span class="hljs-number">99</span></span>,<span class="hljs-number"><span class="hljs-number">677</span></span> (average salary = $<span class="hljs-number"><span class="hljs-number">56</span></span>,<span class="hljs-number"><span class="hljs-number">286</span></span>/year, overhead = <span class="hljs-number"><span class="hljs-number">2.40</span></span>). SLOCCount, Copyright (C) <span class="hljs-number"><span class="hljs-number">2001</span></span><span class="hljs-number"><span class="hljs-number">-2004</span></span> David A. Wheeler SLOCCount <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> Open Source Software/Free Software, licensed under the GNU GPL. SLOCCount comes with ABSOLUTELY NO WARRANTY, <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> you are welcome to redistribute it under certain conditions <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> specified <span class="hljs-keyword"><span class="hljs-keyword">by</span></span> the GNU GPL license; see the documentation <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> details. Please credit <span class="hljs-keyword"><span class="hljs-keyword">this</span></span> data <span class="hljs-keyword"><span class="hljs-keyword">as</span></span> <span class="hljs-string"><span class="hljs-string">"generated using David A. Wheeler's 'SLOCCount'."</span></span></code> </pre><br></div></div><br><h2>  Thanks </h2><br><ul><li>  University Innopolis for a cozy environment and cool acquaintances. </li><li>  Professor Evgeny Zuev for the course on compilers in general, and for a lecture on parsers in particular </li><li>  Professor Manuel Mazzara and TA <a href="https://vk.com/id18222919">Ruslan</a> for the course on DBMS.  <a href="">/ GodBlessMazzara</a> </li></ul><br>  And next time we will implement our non-relational, with aggregate pipelines and transactions;  and call it - / noDropSQL! </div><p>Source: <a href="https://habr.com/ru/post/347274/">https://habr.com/ru/post/347274/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../347262/index.html">Che Burashka and hacking systems selling tickets to Moscow electric trains</a></li>
<li><a href="../347264/index.html">ATM Security: Application Control Application Difficulties</a></li>
<li><a href="../347266/index.html">Making games in Python 3 and Pygame: Part 4</a></li>
<li><a href="../347268/index.html">As we inventories reduced. 500 million</a></li>
<li><a href="../347272/index.html">I hate constants in ruby</a></li>
<li><a href="../347276/index.html">Smart search: how artificial intelligence hh.ru selects jobs to resume</a></li>
<li><a href="../347278/index.html">Learning online programming - is everything as simple as it seems?</a></li>
<li><a href="../347280/index.html">[DotNetBook] Stack stream. Its editing and stream cloning</a></li>
<li><a href="../347282/index.html">How to write a diploma using three open projects</a></li>
<li><a href="../347284/index.html">About errors and exceptions</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>