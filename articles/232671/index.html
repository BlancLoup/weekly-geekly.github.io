<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Asynchronous JavaScript: without callbacks and promises</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Probably everyone who has used JavaScript has ever encountered (or will face in the future) asynchronous calls. Maybe this will be an appeal to the da...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Asynchronous JavaScript: without callbacks and promises</h1><div class="post__text post__text-html js-mediator-article">  Probably everyone who has used JavaScript has ever encountered (or will face in the future) asynchronous calls.  Maybe this will be an appeal to the database on the server side.  Maybe - work with a timer to create animation on the site. <br><br>  In order to "overcome" asynchrony, different tools are used from promises to changing the programming language.  But sometimes you really want to drop everything and write linear code on pure JS: <br><br><pre><code class="javascript hljs">timeout(<span class="hljs-number"><span class="hljs-number">1000</span></span>); <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(<span class="hljs-string"><span class="hljs-string">'Hello, world!'</span></span>);</code> </pre> 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      Is it possible to implement something like that?  Of course, you can. <br>  In this article we will consider one dangerous, but effective way. <br><a name="habracut"></a><br><h4>  Options for action </h4><br>  If you are unhappy with the collectives, you can find several ways of development: <br><ul><li>  To accept and continue to use callbacks, </li><li>  Go to a completely different language </li><li>  Switch to JavaScript compiled language </li><li>  Use language features. </li></ul><br>  Of course, we will not consider the first and second options, leaving them to life on the conscience of the reader.  The third option is more interesting: we don‚Äôt seem to write in JS, but despite everything, despite all our naive expectations, the output is a code on it.  This suggests: "And let me expand JS, add async operator and call AJS?" <br>  The implementation of such a solution leads to the addition of an unnecessary entity - the compiler of a new language.  At the same time, the author will have to advertise well his New Innovative Product and force the public to install another compiler, as well as introduce another explicit code conversion into the development process.  If the author does not represent the interests of large companies and is not a recognized authority of his time, nothing will be done. <br><br>  But wait, you can always pull yourself by the hair!  Dynamic language allows us to compile anything on the go, it remains only to determine the convenient form for the programmer to write. <br><br><h4>  Record form selection </h4><br>  As a first approximation, you can write asynchronous code using string literals, process it, and call eval.  True, this is not very different in bulkiness from a stack of callbacks.  A little thought, you can use the comments inside the functions.  The toString method applied to the function returns us its source code as a string.  With the implementation of <a href="http://habrahabr.ru/post/230887/">multi-line lines</a> inside the comments you will not surprise anyone.  Depending on the author‚Äôs wish, adding a couple of lines of code removes or does not remove spaces at the beginning or line breaks.  Using this technology, you can, for example, implement multi-line regular expressions with comments or an interpreter of some language like Brainfuck <s>or JavaScript itself, just add a couple more lines</s> . <br><div class="spoiler">  <b class="spoiler_title">Multiline regular expressions</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">createRegExp</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> func !== <span class="hljs-string"><span class="hljs-string">'function'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TypeError</span></span>(func + <span class="hljs-string"><span class="hljs-string">' is not a function'</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> m = func.toString(). replace(<span class="hljs-regexp"><span class="hljs-regexp">/\s+|--.*?((?=\*\/)|$)/gm</span></span>, <span class="hljs-string"><span class="hljs-string">''</span></span>). <span class="hljs-comment"><span class="hljs-comment">//       /* */,    -- match(/^.*?\/\*\/((?:\\\/|.)*?)\/(?:([img]+?)\/?)?\*\/\}$/); //    if(!m) throw new TypeError('Invalid RegExp format'); return new RegExp(m[1], m[2] || undefined); }</span></span></code> </pre><br><br>  And for example - parsing a regular expression to parse regular expressions in the comments of a multi-line regular expression: <br><br><pre> <code class="javascript hljs"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> re = createRegExp(<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{<span class="hljs-comment"><span class="hljs-comment">/* / ^.*?\/\* -- -        \/ --  "/" -    ( (?: \\\/ | . )*? )--     "\/"   , \/ --    "/" (?:([img]+?)\/?)? --      i, m, g, ,   "/", --   \*\/\}$ --        --     / */</span></span>});</code> </pre><br><br>  Note that the sequence of "-" characters can still be used in a regular expression by separating hyphens with a space. <br></div></div><br><br>  Such tricks help when working with strings, but they completely kill syntax highlighting, and it is extremely important for the source code for ULVA.  Therefore, the code should be used not commented out, but working.  That is, one that can at least be parsed and represented as an AST, otherwise we get an interpreter error. <br><br><h5>  Designs that we can use </h5><br>  To implement our dialect, while remaining within the framework of the language, we can use: <br><br><ul><li>  Directives in comments: <code>var a = getAsync(b); //! async</code> <code>var a = getAsync(b); //! async</code> </li><li>  Special variable names: <code>var _async_a = getAsync(b);</code> </li><li>  Special function names: <code>var a = getAsync(async(b));</code> </li><li>  Rarely used constructs: <code>var a = +++getAsync(b);</code> </li></ul><br><br>  All this will allow us, having received the source code of the function, to find places where the ‚Äúcherished‚Äù construction is used and replace them with the use of promises / nested functions / sending a complaint about the illegal use of asynchronous calls. <br>  Each design has its pros and cons.  For example, you can get a warning or an error about an undefined variable, warnings from static analyzers, etc.  But in the end, what to use, the developer decides for himself. <br><br><h4>  Implementation </h4><br>  For example, choose the option shown in the picture. <br><br><img src="https://habrastorage.org/files/44f/db6/7f9/44fdb67f9008461fa4b5abb25ea75892.png"><br><br>  In the original function, add the argument __cb - the function to which control will pass after the completion of the last asynchronous operation.  Asynchronous calls will be denoted by an arrow (&lt;-), indicating that the variables to the left of it would be nice to put the result of the function to the right.  All arrows replace the generation of a call to an enclosed callback;  all subsequent code will be "packed" into it.  Each return from the function is replaced by a return with a call to the __cb callback. <br><br>  This will allow us to call asynchronous functions, transfer control to another function and use all the variables created (each new variable in front of the arrow is in the lexical context of the subsequent code or one of its parent contexts).  The arrow is a sequence of familiar operators "&lt;" and "-", forming a valid expression comparing two numbers. <br><br>  For simplicity, consider a stripped-down implementation of the transformation of the source code, in which there is no possibility to transfer the execution context, but already demonstrating the possibilities of the approach, since there is an arrow in it: <br><br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">async</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-comment"><span class="hljs-comment">//    "function..." (prefix)   (code) var parsed = func.toString() .match(/(function.*?\{)([\s\S]*)\}.*/); var prefix = parsed[1], code = parsed[2]; //  lines       ,  "&lt;-" //  nends     -   //     //        var lines = ['(' + prefix], nends = 2; //   ... (    \n) code.split('\n').forEach(function(line){ // ... ,     "&lt;-", //   -     if(!/&lt;-/.test(line)) return void lines.push(line, '\n'); //   -          , //         lines var parsed = /([\w\d_$\s,]+)&lt;-(.+)\)/.exec(line); lines.push(parsed[2], ', function(', parsed[1], '){\n'); ++nends; //       }); //        return lines.join('') + Array(nends).join('\n});'); }</span></span></code> </pre><br><br>  It looks and is recorded quite simply for the created functionality! <br><br><div class="spoiler">  <b class="spoiler_title">Those interested can see a more detailed version that describes the declared transformation.</b> <div class="spoiler_text"><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">async</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">func</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">typeof</span></span> func != <span class="hljs-string"><span class="hljs-string">'function'</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">throw</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-built_in"><span class="hljs-built_in">TypeError</span></span>(<span class="hljs-string"><span class="hljs-string">'First argument of "async" must be a function.'</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  ,   "function...",    var parsed = func.toString() .replace(/\/\*[\s\S]*?\*\/|\/\/.*$/mg, '') .match(/(function.*?)\((.*?)\)\s*\{([\s\S]*)\}.*/); var prefix = parsed[1], args = parsed[2], code = parsed[3]; //   ,     __cb if(!/^\s*$/.test(args)) args += ','; //      "})" //        , ends  //    var lines = ['(', prefix, '(', args, '__cb', '){'], ends = ['\n})']; code.split('\n').forEach(function(line){ //        line = line.replace(/return\s*(.*?);/, 'return void __cb($1);'); // ,   "&lt;-"    if(!/&lt;-/.test(line)) return void lines.push(line, '\n'); if(/&lt;-.*?&lt;-/.test(line)) throw new Error('"&lt;-" is found more than 1 times in "'+line+'".'); //       var parsed = /([\w\d_$\s,]+)&lt;-(.+)\((.*)\)/.exec(line); if(!parsed) throw new Error('"&lt;-" is used incorrectly in "' + line + '".'); lines.push(parsed[2], '('); if(parsed[3]) lines.push(parsed[3], ', '); lines.push('function(', parsed[1], '){\n'); ends.push('\n});'); }); //     "})" return lines.concat(ends.reverse()).join(''); }</span></span></code> </pre><br></div></div><br><br><h4>  Using </h4><br>  Suppose that in order to get an avatar in an <i>overly</i> distributed system, by an email address, the server must access one database, retrieve the user ID, then obtain the user data (including the file path) using the identifier from the second database, access the file system and upload the file. <br><br><img src="https://habrastorage.org/files/430/391/987/43039198749c4409b3ab1b739896f661.png"><br><br>  A naive solution looks like: <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAvatarData</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">eMail, callback</span></span></span><span class="hljs-function">)</span></span>{ db1.getID(eMail, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">id</span></span></span><span class="hljs-function">)</span></span>{ db2.getData(id, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">user</span></span></span><span class="hljs-function">)</span></span>{ fs.exists(user.avatarPath, <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">exists</span></span></span><span class="hljs-function">)</span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">if</span></span>(!exists) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">void</span></span> callback(<span class="hljs-literal"><span class="hljs-literal">null</span></span>); fs.readFile(user.avatarPath, callback); }); }); }); }</code> </pre> <br><br>  And with the arrow you can make it more "flat": <br><pre> <code class="javascript hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getAvatarData_src</span></span></span><span class="hljs-function"> (</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">eMail</span></span></span><span class="hljs-function">) </span></span>{ id &lt;- db1.getID(eMail); user &lt;- db2.getData(id); exists &lt;- fs.exists(user.avatarPath); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!exists) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>; data &lt;- fs.readFile(user.avatarPath); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> data; } <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> getAvatarData = <span class="hljs-built_in"><span class="hljs-built_in">eval</span></span>(<span class="hljs-keyword"><span class="hljs-keyword">async</span></span>(getAvatarData_src));</code> </pre><br><br><h4>  results </h4><br>  It turned out that you can quite easily implement your syntactic sugar in JavaScript.  We retained syntax highlighting and autocompletion, got rid of the external preprocessor and a lot of callbacks.  Perhaps they got a tool for prototyping. <br>  Of course, in the ideal case, you should use the normal JS parser, rather than regular expressions (although the fact of adding functionality in a couple of dozen lines pleases) to rid itself of syntax surprises and correctly handle all situations. <br><br>  You may have to abandon the minimization of the code, since the construction of "a &lt;- f ()" can be optimized or transformed into another form.  Also have to follow the context.  As the attentive reader noted, the functions described above return a string, and not a ready-made function.  This behavior is chosen because of the possible separation of async and the code that uses it into different files - in this case, eval will not ‚Äúcapture‚Äù the desired lexical context of the function;  eval needs to be called in the same file as the user code. <br><br>  Also, the presented implementation does not work correctly with exceptions, but their processing can be easily implemented.  And of course, she conflicts with serious bosses and √ºber-enterprise-projects. <br><br>  Therefore, repeat this only at home! </div><p>Source: <a href="https://habr.com/ru/post/232671/">https://habr.com/ru/post/232671/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../232653/index.html">Dead "Ksyusha" and a dusty kettle. Why "AutomaticTable" - evil corporation</a></li>
<li><a href="../232655/index.html">Microsoft will stop supporting older versions of Internet Explorer by 2016</a></li>
<li><a href="../232657/index.html">Robots can use Wi-Fi for x-ray vision.</a></li>
<li><a href="../232661/index.html">Wikipedia for the week brought Bitcoin donations for 140 thousand dollars</a></li>
<li><a href="../232665/index.html">Vscan: a portable ultrasound sensor from GE Healthcare</a></li>
<li><a href="../232673/index.html">To help create a supplier of performance counters v 2.0 in NET. Framework</a></li>
<li><a href="../232675/index.html">Experience using Google Apps for Business</a></li>
<li><a href="../232677/index.html">We learn to make prototypes</a></li>
<li><a href="../232685/index.html">The company uBeam introduced the technology of wireless charging devices based on ultrasound</a></li>
<li><a href="../232687/index.html">Microsoft recreated 1994 website</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>