<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Optimize iOS application resources</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="When building applications for iOS, the iphoneos-optimize script from the Xcode set is used to optimize resources. It works fine, but if you dig deepe...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Optimize iOS application resources</h1><div class="post__text post__text-html js-mediator-article">  When building applications for iOS, the iphoneos-optimize script from the Xcode set is used to optimize resources.  It works fine, but if you dig deeper, it becomes clear that some files are not pinched, while others are slightly smaller, but still far from ideal.  We can say that the task of the script is to make the files more compatible with the iPhone, so that they can be read or unpacked faster, but most likely it made sense only on old iPhones 1 and others like them, and already on 1GHz processors with ARM 7 this is clearly not relevant. <br>  Using simple optimizations and a couple of programs from the MacPorts suite, you can achieve a significant reduction in PNG and JPG images in the final program, and, if desired, other types of data. <br><a name="habracut"></a><br><h5>  Intelligence service </h5><br>  First, let's see what the original iphoneos-optimize is.  This is a small Perl script that lies in the /Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/ folder.  For Xcode 4.3 and higher, this will be the folder /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/usr/bin/ <br><br>  The main part of the script is quite simple and well readable: <br><pre><code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$SCRIPT_NAME: Converting plists to binary in $dstroot\n"</span></span>; find( { <span class="hljs-string"><span class="hljs-string">wanted =&gt;</span></span> \&amp;optimizePlists }, $dstroot ); <span class="hljs-keyword"><span class="hljs-keyword">exit</span></span>(<span class="hljs-number"><span class="hljs-number">0</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-keyword"><span class="hljs-keyword">defined</span></span> $options <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> $options =~ <span class="hljs-regexp"><span class="hljs-regexp">/-skip-PNGs/</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$SCRIPT_NAME: Optimizing PNGs in $dstroot\n"</span></span>; find( { <span class="hljs-string"><span class="hljs-string">wanted =&gt;</span></span> \&amp;optimizePNGs }, $dstroot );</code> </pre> <br><br>  All files in dstroot are searched and sent to the optimizePlists and OptimizePNGs functions.  To optimize PNG, use the modified Apple version of the pngcrunch with the iphone key: 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @args = ( $PNGCRUSH, <span class="hljs-string"><span class="hljs-string">"-iphone"</span></span>, <span class="hljs-string"><span class="hljs-string">"-f"</span></span>, <span class="hljs-string"><span class="hljs-string">"0"</span></span>, $name, $crushedname ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>(@args) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> STDERR <span class="hljs-string"><span class="hljs-string">"$SCRIPT_NAME: Unable to convert $name to an optimized png!\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">unlink</span></span> $name <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"Unable to delete original file: $name"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">rename</span></span>($crushedname, $name) <span class="hljs-keyword"><span class="hljs-keyword">or</span></span> <span class="hljs-keyword"><span class="hljs-keyword">die</span></span> <span class="hljs-string"><span class="hljs-string">"Unable to rename $crushedname to $name"</span></span>;</code> </pre> <br><br><h5>  Pngcrush vs OptiPNG </h5><br>  What exactly does the-iphone key do not recognize us, but by and large it is not so important.  Upon closer inspection, it is clear that if pngcrush returned an error or could not shrink the file, the temporary file is deleted, but the main file remains unchanged.  In my case this was the case with a certain browser.png file: <br><br> <code>Recompressing browser.png <br> Total length of data found in IDAT chunks = 433949 <br> IDAT length with method 120 (fm 1 zl 9 zs 1) = 512501 <br> Best pngcrush method = 120 (fm 1 zl 9 zs 1) for browser_iphone.png <br> <b>(18.10% IDAT increase) <br> (18.11% filesize increase)</b> <br> <br> CPU time used = 2.569 seconds (decoding 0.040, <br> encoding 2.490, other 0.039 seconds)</code> <br> <br>  Without the -iphone switch, the situation was better and the file did decrease: <br><br> <code>Recompressing browser.png <br> Total length of data found in IDAT chunks = 433949 <br> IDAT length with method 1 (fm 0 zl 4 zs 0) = 740769 <br> IDAT length with method 2 (fm 1 zl 4 zs 0) = 611778 <br> IDAT length with method 3 (fm 5 zl 4 zs 1) = 485419 <br> IDAT length with method 9 (fm 5 zl 2 zs 2) = 743935 <br> IDAT length with method 10 (fm 5 zl 9 zs 1) = 427514 <br> Best pngcrush method = 10 (fm 5 zl 9 zs 1) for browser_tmp.png <br> <b>(1.48% IDAT reduction) <br> (1.47% filesize reduction)</b> <br> <br> CPU time used = 3.949 seconds (decoding 0.176, <br> encoding 3.766, other 0.007 seconds)</code> <br> <br>  But there is another way - GPL <a href="http://optipng.sourceforge.net/">optipng</a> utility.  From MacPorts, it installs without problems with the command <br> <code>sudo port install optipng</code> <br> <br>  Here is the result of the utility with the same browser.png: <br> <code>** Processing: browser_opti.png <br> 1024x1024 pixels, 4x8 bits/pixel, RGB+alpha <br> Input IDAT size = 433949 bytes <br> Input file size = 434043 bytes <br> <br> Trying: <br> zc = 9 zm = 8 zs = 1 f = 5 IDAT size = 427390 <br> <br> Selecting parameters: <br> zc = 9 zm = 8 zs = 1 f = 5 IDAT size = 427390 <br> <br> <b>Output IDAT size = 427390 bytes (6559 bytes decrease) <br> Output file size = 427484 bytes (6559 bytes = 1.51% decrease)</b></code> <br> <br>  As you can see, the file size is even smaller than that of pngcrush, and the speed of operation is much higher.  In some other cases, the gap is even more noticeable. <br>  The most important thing is that the PNG files obtained are perfectly open on the iPhone and iPad, there are no visual distortions in them, the difference in opening speed is missing or not noticeable. <br><br>  Integrating optipng into a script is quite simple: in the header of the script we change the variable indicating the PNG optimizer and the path to it: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $PNGCRUSH_NAME = <span class="hljs-string"><span class="hljs-string">"optipng"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $PNGCRUSH = <span class="hljs-string"><span class="hljs-string">"/opt/local/bin/$PNGCRUSH_NAME"</span></span>;</code> </pre> <br>  In the body of the optimizePNGs function, only the string with parameters is changed.  I got the optimal result with the -o2 and -f0 parameters: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @args = ( $PNGCRUSH, <span class="hljs-string"><span class="hljs-string">"-o2"</span></span>, <span class="hljs-string"><span class="hljs-string">"-f0"</span></span>, $name, <span class="hljs-string"><span class="hljs-string">"-out"</span></span>, $crushedname );</code> </pre> <br><br>  Of course, we must not forget to backup the script, and at the same time have administrator rights to edit it. <br><br><h5>  Jpg optimization </h5><br>  JPEG files often contain EXIF ‚Äã‚Äãinformation, and sometimes various garbage not needed on the phone.  There is also a difference when using progressive mode and other settings.  The most convenient way is to use the jpegoptim utility, which itself discards the unnecessary, optimizes the Huffman tables and selects the optimal settings for the same quality level.  If desired, you can set the parameters so that the utility reduces the quality of the image, then it will be compressed again with the specified quality.  You can also install it from MacPorts: <br><br> <code>sudo port install jpegoptim</code> <br> <br>  It remains only to add a call to this program in iphoneos-optimize. <br>  In the title: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $JPGCRUSH_NAME = <span class="hljs-string"><span class="hljs-string">"jpegoptim"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $JPGCRUSH = <span class="hljs-string"><span class="hljs-string">"/opt/local/bin/$JPGCRUSH_NAME"</span></span>;</code> </pre> <br>  In body: <br><pre> <code class="perl hljs"><span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$SCRIPT_NAME: Optimizing jpgs in $dstroot\n"</span></span>; find( { <span class="hljs-string"><span class="hljs-string">wanted =&gt;</span></span> \&amp;optimizeJPGs }, $dstroot );</code> </pre> <br>  New feature: <br><pre> <code class="perl hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">sub</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">optimizeJPGs</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> $name = $File::Find::name; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( -f $name &amp;&amp; $name =~ <span class="hljs-regexp"><span class="hljs-regexp">/^(.*)\.jpg$/i</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">my</span></span> @args = ( $JPGCRUSH, <span class="hljs-string"><span class="hljs-string">"--strip-all"</span></span>, $name ); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">system</span></span>(@args) != <span class="hljs-number"><span class="hljs-number">0</span></span>) { <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> STDERR <span class="hljs-string"><span class="hljs-string">"$SCRIPT_NAME: Unable to convert $name to an optimized jpg!\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } <span class="hljs-keyword"><span class="hljs-keyword">print</span></span> <span class="hljs-string"><span class="hljs-string">"$SCRIPT_NAME: Optimized JPG: $name\n"</span></span>; } }</code> </pre> <br>  I deliberately did not repeat the result of the program, because in case of failure of optimization, it simply does not change the source file. <br>  The utility works very quickly and displays a minimum of information: <br><br> <code>jpegoptim --strip-all english.jpg <br> english.jpg 320x480 24bit JFIF [OK] 66466 --&gt; 59686 bytes (10.20%), optimized.</code> <br> <br>  Now it is enough to rebuild the project in XCode and the process of optimizing resources with iphoneos-optimize will go much faster, and the result will be 10-15% less. <br><br><h5>  Other optimizations </h5><br>  Additionally, you can add other extensions to the script (JPEG, JFIF, JPE, JIF, etc.), add a reduction in quality, etc. Anyway, there are enough different optimizers PNG, JPEG, CAF and other files that can be used on the network.  For example, SQLite databases can be optimized using the following command: <br> <code>sqlite3 database.sqlite vacuum;</code> <br> <br>  The team will re-create the database with all the data, discarding various garbage, remnants of old transactions, etc.  The integration of this and other commands in the script will be left to the discretion of the reader. <br><br>  In fact, there are at least two interesting methods for reducing the size of PNG files (if you tilt the other optimizers and manually simplify the drawing).  The first is not entirely canonical and can be perceived as heresy, but fact is a fact: the Android compiler (or rather, apktool) can track pictures with a small number of colors and translate them into the Paletted format.  Moreover, even full-color PNGs can become even smaller.  It is enough to add the necessary images to the res / drawable folder of the working project, to collect it and then write off the optimized files from the bin / res / drawable folder.  Of course, this requires some skills with the Android SDK and does not really relate to iOS development. <br><br>  The second method is more universal: reduce the color gamut of a file from RGBA8888 to RGB565 or RGBA4444.  At the same time, the size can both grow due to dithering, and significantly decrease in the case of hand-drawn images.  For these operations, I wrote my own console utility, but its consideration is beyond the scope of this article. <br><br>  PS The text of the finished script iphoneos-optimize: <a href="http://paste2.org/p/2045147">paste2.org/p/2045147</a> <br></div><p>Source: <a href="https://habr.com/ru/post/145555/">https://habr.com/ru/post/145555/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../145549/index.html">Visual Studio Express 2012 for Windows Desktop</a></li>
<li><a href="../145550/index.html">Automation of music management in the office, any song on order via ICQ</a></li>
<li><a href="../145551/index.html">Test task for the Connected FixedThreadPool on C #. What is wrong here? UPD</a></li>
<li><a href="../145552/index.html">Some OSM and OpenLayers for enterprise systems</a></li>
<li><a href="../145553/index.html">Effective role assignment through the RACI matrix (Updated)</a></li>
<li><a href="../145558/index.html">Mozilla Shumway - open source SWF to HTML5 converter</a></li>
<li><a href="../145559/index.html">Icenium: cross-platform cloud environment for creating mobile applications</a></li>
<li><a href="../145560/index.html">A little about the beauty of T-fractals</a></li>
<li><a href="../145561/index.html">Windows 8 Release Preview eyes of a little more ordinary user</a></li>
<li><a href="../145563/index.html">Runet Today, June 9, 2012. Experts of the issue: Sergey Zhuravlev, Gavriil Levy</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>