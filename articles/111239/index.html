<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Working with sockets in Qt</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 

 Some years ago, on one of the forums, I found such a wonderful phrase - ‚ÄúEvery self-respecting programmer in life should write his cha...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Working with sockets in Qt</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br><img src="http://ufna.ru/wp-content/uploads/2010/03/Qt_logostrap_CMYK-300x149.png" alt="image"><br>  Some years ago, on one of the forums, I found such a wonderful phrase - ‚ÄúEvery self-respecting programmer in life should write his chat client.‚Äù  Then my knowledge did not allow to do this.  I just smiled and passed this phrase.  But just recently I ran into this particular problem - I had to write my own chat.  Well, since lately my interest was directed to the study and development of Qt-applications, on which it will be made, it was decided by itself. <br><a name="habracut"></a><br>  Working with the network in Qt is done through QtNetwork.  And in order for the project to start supporting it, in the .pro file you need to add QT + = network.  Qt supports several types of socket connections.  The main ones are: QUdpSocket and QTcpSocket.  QUdpSocket is a datagram socket for exchanging data packets.  With this socket, the data is sent without checking whether the data has reached or not.  QTcpSocket, on the other hand, establishes a point-to-point connection and provides additional mechanisms against anti-corruption and data loss. <br><br>  Both classes are inherited from the QAbstractSocket class.  There is also a QSslSocket class, but I was not needed at that time, so I will not touch it. <br><br><h4>  Chat </h4><br>  When I started designing the application architecture, the question became: ‚ÄúHow will the chat users interact with each other?‚Äù.  Just the chat itself had to support both the general chat window and private messages with the ability to transfer files.  If everything was clear with the transfer of files - there is only TCP, since there should be control and check whether packets came, then there were difficulties with the main chat.  After all, in the chat there is no clearly defined server.  And if their interaction is done via TCP, then for each user you will need to select a port, which is a little expensive.  Well, if not TCP, then UDP!  It is completely suitable for this.  Listening to a specific port, we receive messages from the user who sent them to the same port for everyone.  And if some chat message is lost, it will not be so scary. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h4>  QUdpSocket </h4><br>  As it turned out, working with the QUdpSocket class is not easy, but very simple.  We create a class object, bind the specified port, connect it with the QIODevice class signal and wait for messages to arrive at this port. <br><blockquote><code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black">UdpChat(QString nick, <font color="#0000ff">int</font> port) { <br> nickname = nick; <br> socket = <font color="#0000ff">new</font> QUdpSocket( <font color="#0000ff">this</font> ); <br> _port = port; <br> socket-&gt;bind(QHostAddress::Any, port); <br> <font color="#008000">//       //</font> <br> connect(socket, SIGNAL(readyRead()), SLOT(read())); <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  I would also like to say before the next block of code that in our case the chat does not know the number of people on the network.  We will just make a broadcast request.  But in order to create a list of people, we will send something like ‚ÄúWho is online?‚Äù, To which those who receive this message will send ‚ÄúI!‚Äù.  Thus, we will have 3 message types: <br><ol><li>  regular message from user </li><li>  messages - online user </li><li>  message - who is online? </li></ol><br>  As a result, we obtain: <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">void</font> send(QString str, qint8 type) { <br> QByteArray data; <br> QDataStream <font color="#0000ff">out</font> (&amp;data, QIODevice::WriteOnly); <br> <font color="#0000ff">out</font> &lt;&lt; qint64(0); <br> <font color="#0000ff">out</font> &lt;&lt; qint8(type); <br> <font color="#0000ff">out</font> &lt;&lt; str; <br> <font color="#0000ff">out</font> .device()-&gt;seek(qint64(0)); <br> <font color="#0000ff">out</font> &lt;&lt; qint64(data.size() - <font color="#0000ff">sizeof</font> (qint64)); <br> socket-&gt;writeDatagram(data, QHostAddress::Broadcast, _port); <br> } <br> <br> <font color="#0000ff">void</font> read() { <br> QByteArray datagram; <br> datagram.resize(socket-&gt;pendingDatagramSize()); <br> QHostAddress *address = <font color="#0000ff">new</font> QHostAddress(); <br> socket-&gt;readDatagram(datagram.data(), datagram.size(), address); <br> <br> QDataStream <font color="#0000ff">in</font> (&amp;datagram, QIODevice::ReadOnly); <br> <br> qint64 size = -1; <br> <font color="#0000ff">if</font> ( <font color="#0000ff">in</font> .device()-&gt;size() &gt; <font color="#0000ff">sizeof</font> (qint64)) { <br> <font color="#0000ff">in</font> &gt;&gt; size; <br> } <font color="#0000ff">else</font> <font color="#0000ff">return</font> ; <br> <font color="#0000ff">if</font> ( <font color="#0000ff">in</font> .device()-&gt;size() - <font color="#0000ff">sizeof</font> (qint64) &lt; size) <font color="#0000ff">return</font> ; <br> <br> qint8 type = 0; <br> <font color="#0000ff">in</font> &gt;&gt; type; <br> <br> <font color="#0000ff">if</font> (type == USUAL_MESSAGE) { <br> QString str; <br> <font color="#0000ff">in</font> &gt;&gt; str; <br> <font color="#008000">//        //</font> <br> } <font color="#0000ff">else</font> <font color="#0000ff">if</font> (type == PERSON_ONLINE) { <br> <font color="#008000">//     QHostAddress //</font> <br> } <font color="#0000ff">else</font> <font color="#0000ff">if</font> (type == WHO_IS_ONLINE) { <br> sending(nickname, qint8(PERSON_ONLINE)); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  Everything is transparent and clear.  It remains to fasten the interface, connect all the signals and the main chat window is ready. <br><br><h4>  QTcpSocket </h4><br>  As for this socket, it implements the client-server model.  That is, in our case, each user can become as a server if he starts someone first to write a private message or send a file.  Or the client, if he wrote the first in private. <br><br>  There are no difficulties with sending a message.  But to send the file we do a classic trick.  Since the whole file cannot be inserted into the stream, it will read the data from the file and write it in portions to the stream, and then send it. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">void</font> sendFile(QString fileName) { <br> <font color="#0000ff">if</font> (sendFile != NULL){ <br> <font color="#0000ff">return</font> ; <br> } <br> sendFile = <font color="#0000ff">new</font> QFile(fileName); <br> <font color="#0000ff">if</font> (sendFile-&gt;open(QFile::ReadOnly)){ <br> QByteArray data; <br> QDataStream <font color="#0000ff">out</font> (&amp;data, QIODevice::WriteOnly); <br> <font color="#008000">//     //</font> <br> clientSocket-&gt;write(data); <br> clientSocket-&gt;waitForBytesWritten(); <br> connect(clientSocket, SIGNAL(bytesWritten(qint64)), <font color="#0000ff">this</font> , SLOT(sendPartOfFile())); <br> sendPartOfFile(); <br> } <font color="#0000ff">else</font> { <br> emit <font color="#0000ff">this</font> -&gt;errorSendFile(QString( <font color="#A31515">"File not can open for read"</font> )); <br> <font color="#0000ff">return</font> ; <br> } <br> } <br> <br> <font color="#0000ff">void</font> sendPartOfFile() { <br> <font color="#0000ff">char</font> block[SIZE_BLOCK_FOR_SEND_FILE]; <br> <font color="#0000ff">if</font> (!sendFile-&gt;atEnd()){ <br> qint64 <font color="#0000ff">in</font> = sendFile-&gt;read(block, <font color="#0000ff">sizeof</font> (block)); <br> qint64 send = clientSocket-&gt;write(block, <font color="#0000ff">in</font> ); <br> } <font color="#0000ff">else</font> { <br> sendFile-&gt;close(); <br> sendFile = NULL; <br> disconnect(clientSocket, SIGNAL(bytesWritten(qint64)), <font color="#0000ff">this</font> , SLOT(sendPartOfFile())); <br> emit endSendFile(); <br> } <br> }</font> <br> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  It remains to consider reading the stream.  Since only 2 types of data come in - MESSAGE and SENDFILE, then it‚Äôs easy to write a regular input stream parser.  It is identical to the class method implementing a UDP socket.  Of interest is reading from the file stream. <br><blockquote> <code><a href="http://virtser.net/blog/post/source-code-highlighter.aspx"></a> <font color="black"><font color="#0000ff">void</font> receiveFile(QString fileName) { <br> QString savePath = <font color="#A31515">"Downloads/"</font> ; <br> QDir dir; <br> dir.mkpath(savePath); <br> receiveFile = <font color="#0000ff">new</font> QFile(savePath + fileName); <br> sizeReceivedData = 0; <br> receiveFile(); <br> } <br> <br> <font color="#0000ff">void</font> receiveFile() { <br> QDataStream <font color="#0000ff">in</font> (clientSocket); <br> <font color="#0000ff">if</font> (!bufferForUnreadData.isEmpty()){ <br> receiveFile-&gt;write(bufferForUnreadData); <br> sizeReceivedData += bufferForUnreadData.size(); <br> bufferForUnreadData.clear(); <br> } <br> <font color="#0000ff">char</font> block[SIZE_BLOCK_FOR_SEND_FILE]; <br> <font color="#0000ff">while</font> (! <font color="#0000ff">in</font> .atEnd()){ <br> qint64 toFile = <font color="#0000ff">in</font> .readRawData(block, <font color="#0000ff">sizeof</font> (block)); <br> sizeReceivedData += toFile; <br> receiveFile-&gt;write(block, toFile); <br> } <br> <font color="#0000ff">if</font> (sizeReceivedData == sizeReceiveFile){ <br> receiveFile-&gt;close(); <br> receiveFile = NULL; <br> sizeReceiveFile = 0; <br> sizeReceivedData = 0; <br> } <br> } <br></font> <br> <font color="gray">* This source code was highlighted with <font color="gray">Source Code Highlighter</font> .</font></code> </blockquote> <br>  This is the essence of the work of private messages.  Of course, there is a shortage of signals, connections and specific code.  For example, a send and recieve file is only a general view.  Much has been missed.  But if you add everything, fasten the interface, you can get quite a working chat client written by you. <br><br>  The purpose of the article was to show by example that working with sockets is simple and easy.  I hope that this article will help someone in the future.  Good luck. </div><p>Source: <a href="https://habr.com/ru/post/111239/">https://habr.com/ru/post/111239/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../111232/index.html">Identification of an individual. Problems and lack of solution</a></li>
<li><a href="../111233/index.html">Increase the search capabilities of genetic algorithms using time series prediction</a></li>
<li><a href="../111236/index.html">Drag & Drop between TreePanel and GridPanel in ExtJS</a></li>
<li><a href="../111237/index.html">Modeling in ns-2. Approximate 802.11b wireless network bandwidth to real</a></li>
<li><a href="../111238/index.html">[Programming] Working with the status bar in Android</a></li>
<li><a href="../111241/index.html">FTP protocol + WinSocks on the example of a simple FTP client (mirror) on ASM!</a></li>
<li><a href="../111242/index.html">Symfony Code'n'Coffee Minsk (Belarus) Jan 2011</a></li>
<li><a href="../111243/index.html">Evernote: 2010 in numbers</a></li>
<li><a href="../111244/index.html">Pro Video Compression - Introduction</a></li>
<li><a href="../111246/index.html">Lab DC power supply from power supply</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>