<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>How I used gem gon in Groupon</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="The other day I released a new version of my gem Gon - 4.0.0 and decided to give a couple of examples of its capabilities and use. This library is use...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>How I used gem gon in Groupon</h1><div class="post__text post__text-html js-mediator-article">  The other day I released a new version of my gem <a href="https://github.com/gazay/gon">Gon</a> - 4.0.0 and decided to give a couple of examples of its capabilities and use.  This library is used to simplify working with data in the MVC architecture.  It allows you to work with the controller's data from JS by skipping the steps of transferring this data through the twist.  Today there are rut implementations for <a href="https://github.com/gazay/gon">RoR applications</a> , <a href="https://github.com/gazay/gon-sinatra">sinatra-like applications</a> (sinatra, padrino, etc.) and for <a href="https://github.com/brooklynDev/NGon">.Net MVC</a> . <br><br><h5>  Card in admin </h5><br>  My task was to implement the division of proposals in the Group into territorial regions that the administrator could edit.  Offers from areas are shown to people who live in these areas with a higher priority than offers from other areas. <br><br><a name="habracut"></a><br>  It was decided to make in the admin an interactive map based on Yandex.Maps, on which the offer points and areas should be displayed.  Regions can be added and edited and their coordinates will be stored in the database respectively.  Yandex.Maps provide an extensive API for drawing various elements on maps; I was approached from there by polygons to display areas and points with tooltips for sentences.  A screenshot below without points of offers, the secret information;) 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <img src="http://cl.ly/image/3k1t3P461b1A/Screen%20Shot%202012-07-25%20at%2010.48.10%20AM.png" alt="image"><br><br>  I created several data models - CityArea to describe the essence of the territorial area in the city, CityAreaPoint to store the coordinates of the points that make up the CityArea, and AreaOffer - the sentence belongs to a specific area.  Prepared a page, JS for drawing areas, server logic for linking objects to each other, and the question arose of outputting data to a page.  One of the standard methods in MVC for me is to select the necessary data in the controller action, edit it to the required format, write the final data array into a variable and then add the item with the data attribute to which this data will be written and JS will read from there. th  That is, I did something like this: <br><br> <code>app/controllers/admin/map_controller.rb</code> <br> <pre> <code class="ruby hljs">@location = City.find(params[<span class="hljs-symbol"><span class="hljs-symbol">:city_id</span></span>].to_i) @offers = Offer.sorted.by_city(@location).by_day(params[<span class="hljs-symbol"><span class="hljs-symbol">:date</span></span>]) @offers.map! <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|offer|</span></span> points = offer.points.map <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|point|</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> it.id, <span class="hljs-symbol"><span class="hljs-symbol">longitude:</span></span> it.longitude, <span class="hljs-symbol"><span class="hljs-symbol">latitude:</span></span> it.latitude } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">id:</span></span> offer.id, <span class="hljs-symbol"><span class="hljs-symbol">permalink:</span></span> offer.permalink, <span class="hljs-symbol"><span class="hljs-symbol">title:</span></span> offer.short_title, <span class="hljs-symbol"><span class="hljs-symbol">points:</span></span> points } <span class="hljs-keyword"><span class="hljs-keyword">end</span></span> @city_areas = CityArea.find_by_city @location @city_areas.map! <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> <span class="hljs-params"><span class="hljs-params">|area|</span></span> <span class="hljs-comment"><span class="hljs-comment">#        end</span></span></code> </pre><br><br> <code>app/views/admin/map/map.html.haml</code> <br> <pre> <code class="ruby hljs">.data-container{ <span class="hljs-symbol"><span class="hljs-symbol">data:</span></span> { <span class="hljs-symbol"><span class="hljs-symbol">areas:</span></span> @city_areas.to_json, <span class="hljs-symbol"><span class="hljs-symbol">offers:</span></span> @offers.to_json } }</code> </pre><br><br> <code>app/assets/javascripts/admin/map.js</code> <br> <pre> <code class="javascript hljs">$(<span class="hljs-string"><span class="hljs-string">'.data-container'</span></span>).data(<span class="hljs-string"><span class="hljs-string">'offers'</span></span>) ...</code> </pre><br><br>  The result was a very loaded controller - too much code that should not be there.  You can bring it to the model, but the code will still look like this.  I decided to use my gem gon which has support for templates <a href="https://github.com/nesquena/rabl">rabl</a> and <a href="https://github.com/rails/jbuilder">jbuilder</a> .  Rabl is a great gem that works great with collections of objects and associations of objects from a database, so the code inside the templates is more optimal.  Well, rut allows you to use the power of rabl easily and simply: <br><br> <code>app/controllers/admin/map_controller.rb</code> <br> <pre> <code class="ruby hljs">@location = City.find(params[<span class="hljs-symbol"><span class="hljs-symbol">:city_id</span></span>].to_i) @offers = Offer.sorted.by_city(@location).by_day(params[<span class="hljs-symbol"><span class="hljs-symbol">:date</span></span>]) @city_areas = CityArea.find_by_city @location gon.rabl <span class="hljs-symbol"><span class="hljs-symbol">template:</span></span> <span class="hljs-string"><span class="hljs-string">'app/rabl/offers.json.rabl'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">as:</span></span> <span class="hljs-string"><span class="hljs-string">'offers'</span></span> gon.rabl <span class="hljs-symbol"><span class="hljs-symbol">template:</span></span> <span class="hljs-string"><span class="hljs-string">'app/rabl/areas.json.rabl'</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">as:</span></span> <span class="hljs-string"><span class="hljs-string">'areas'</span></span></code> </pre><br><br> <code>app/rabl/offers.json.rabl</code> <br> <pre> <code class="ruby hljs">collection @offers =&gt; <span class="hljs-string"><span class="hljs-string">'offers'</span></span> attributes <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:permalink</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:short_title</span></span> child <span class="hljs-symbol"><span class="hljs-symbol">:points</span></span> <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> attributes <span class="hljs-symbol"><span class="hljs-symbol">:id</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:latitude</span></span>, <span class="hljs-symbol"><span class="hljs-symbol">:longitude</span></span> <span class="hljs-keyword"><span class="hljs-keyword">end</span></span></code> </pre><br><br> <code>app/assets/javascripts/admin/map.js</code> <br> <pre> <code class="javascript hljs">gon.offers ‚Ä¶</code> </pre><br><br>  Thus, having spent a minimum of efforts on data conversion and transferring this data to JS, I received a ‚Äúclean‚Äù controller and arrays of the data I needed in JS. <br><br><h5>  Gon gem </h5><br>  In addition to working with the <a href="https://github.com/nesquena/rabl">rabl</a> and <a href="https://github.com/rails/jbuilder">jbuilder templates</a> , gon is great for displaying any initial data or global data that is set at any point in the project and is accessible from any point of the project.  That is, for example, if the value of a variable should be on all pages of the project - it is enough to set this variable in the utility.  To do this, use the method <a href="https://github.com/gazay/gon/wiki/Usage-gon-global">gon.global</a> , which works similarly to gon, except that the scope of the variables written to it is global.  In JS, variables are available through the gon.global namespace. <br><br>  In addition, yesterday I released version 4.0.0 in which the functionality of updating data in a variable without reloading the page appeared - <a href="https://github.com/gazay/gon/wiki/Usage-gon-watch">gon.watch</a> .  New functionality allows you to update the data in a loop with an interval of n-seconds, and one-time response to any event.  As an example, I will show how you can display the results of the top command in real time with several lines of code: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/69a/0c5/b6c/69a0c5b6ccc5a2bff4de715fd85af5fc.png" alt="image"><br><br>  Suppose we have a new rails application.  To display the terminal top we just need to do the following: <br><br>  1. Add the line <code>gem 'gon'</code> to the Gemfile and run <code>bundle install</code> <br><br>  2. Add a controller with an action such as home # foo, view for it <code>app/views/home/foo.html.erb</code> and JS <code>app/assets/javascripts/home.js.coffee</code> <br><pre> <code class="bash hljs">rails g controller home foo</code> </pre><br><br>  3. In the <code>app/controllers/home_controller.rb</code> controller action, <code>app/controllers/home_controller.rb</code> write to gon.watch the variable one-time execution of the top command: <br><pre> <code class="ruby hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">foo</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">gon</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">watch</span></span></span><span class="hljs-function">.</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">top</span></span></span><span class="hljs-function"> = </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">`</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">top</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">-</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">l1</span></span></span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">`</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">end</span></span></span></span></code> </pre><br><br>  4. In the <code>app/views/layouts/application.html.erb</code> layout, add a helper with the watch option to the head: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">head</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">%=</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">include_gon</span></span></span><span class="hljs-tag">(</span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">watch:</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">true</span></span></span><span class="hljs-tag">) %&gt;</span></span></code> </pre><br><br>  5. In the view <code>app/views/home/foo.html.erb</code> add a tag in which we will display top: <br><pre> <code class="html hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">'font-family:monospace;'</span></span></span><span class="hljs-tag">&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">pre</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre><br><br>  6. In the coffee file, add the code that we will have to monitor the variable and update the contents of the pre tag: <br><pre> <code class="coffeescript hljs">$(<span class="hljs-built_in"><span class="hljs-built_in">document</span></span>).ready -&gt; renewPre = <span class="hljs-function"><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(data)</span></span></span><span class="hljs-function"> -&gt;</span></span> $(<span class="hljs-string"><span class="hljs-string">'pre'</span></span>).html(data.replace(<span class="hljs-regexp"><span class="hljs-regexp">/\\n/</span></span>, <span class="hljs-string"><span class="hljs-string">"\n"</span></span>)) gon.watch(<span class="hljs-string"><span class="hljs-string">'top'</span></span>, interval: <span class="hljs-number"><span class="hljs-number">1000</span></span>, renewPre)</code> </pre><br><br>  <code>gon.watch</code> accepts two or three parameters - the name of a variable, options (optional), callback.  In this case, we passed the <code>interval: 1000</code> option, which will loop the gon.watch code at intervals of 1 second.  This means that every second <code>gon.watch</code> sends a request to the controller action in which the variable was assigned and returns the current value. If the request is successful, the callback is called, which in turn overwrites the contents of the pre tag.  To stop the loop, there is a function gon.unwatch, which takes a variable name and a callback function.  Naturally, if you do not pass the <code>interval</code> option, then there will be no cycle, there will be a one-time request and, if successful, a one-time callback call. <br><br>  That's it, launch <code>rails s</code> , open <code>0.0.0.0:3000/foo</code> - there we have a live top. </div><p>Source: <a href="https://habr.com/ru/post/148437/">https://habr.com/ru/post/148437/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../148430/index.html">Nokia Play 360 ¬∞</a></li>
<li><a href="../148431/index.html">Pyxel Edit: pixelart tileset editor</a></li>
<li><a href="../148434/index.html">AmazonVPC IPsec bypassing standard tools</a></li>
<li><a href="../148435/index.html">Library files will be named after the abbreviated names of the objects they define.</a></li>
<li><a href="../148436/index.html">Command Pattern Remote Procedure Call (RPC) in Android</a></li>
<li><a href="../148438/index.html">Erlang plugin for IntelliJ IDEA version 0.4</a></li>
<li><a href="../148439/index.html">Is it possible to reduce the cost of implementing an ERP system?</a></li>
<li><a href="../148443/index.html">Five Years School Data Analysis</a></li>
<li><a href="../148444/index.html">Informative about PGM protocol</a></li>
<li><a href="../148445/index.html">What if you have a lot of third-party repositories</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>