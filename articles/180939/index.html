<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Decorators in PHP. Implementation of the extension</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="According to the results of the survey in the first article , it was decided to review the implementation of the expansion. At this point, the syntax ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Decorators in PHP. Implementation of the extension</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/storage2/82d/57c/176/82d57c17672893a8197bbf13f0a27cfc.png" align="left">  According to the results of the survey in the <a href="http://habrahabr.ru/post/180827/">first article</a> , it was decided to review the implementation of the expansion.  At this point, the syntax has slightly changed for the existing IDE, which, perhaps, was the most negotiable point. <br>  This is not another article-o-hello-world expansion, because  Those who wish to understand the basics can easily find a lot of materials both <a href="http://habrahabr.ru/post/98862/">on</a> <a href="http://habrahabr.ru/post/144582/">Habr√©</a> itself and in the <a href="http://highloadblog.ru/articles/10.html">Russian-language</a> <a href="http://adobkin.com/blog/categories/development-extensions-to-php/">RTFG</a> . <br>  An article about the prerequisites, implementation and pitfalls.  It will be a little PHP, mainly C. <br><a name="habracut"></a><br><br><h2>  Prerequisites </h2><br>  If it is not interesting to read tl; dr, then you can go straight to <a href="https://habr.com/ru/post/180939/">Realization</a> . <br><br><div class="spoiler">  <b class="spoiler_title">I'll start from afar</b> <div class="spoiler_text">  I like Python, especially some of its syntax.  And since the last time I write mostly in PHP, I want the work tool to be more convenient and functional.  PHP is developing well in recent versions, but there are still no such decorators.  So you have to take everything into your own hands.  First there was the idea of ‚Äã‚Äãunification in terms of names and passing the parameters of core functions ( <i>another <a href="">extension of mine</a> , which is still at the stage of idea formation. If necessary, I can write about its creation</i> ), now here are the decorators and some other things. <br></div></div><br>  Function decorators (the methods are not mentioned here and hereafter, since they are no different for decoration) allow you to change the work of the latter, wrapping their calls with an additional layer of logic.  In a declarative form, a list of wrappers is described, which in the end should return something that will replace the original function.  In the python syntax, we get the <a href="http://www.python.org/dev/peps/pep-0318/">following</a> : <br><pre><code class="python hljs"><span class="hljs-meta"><span class="hljs-meta">@decomaker(argA, argB, ...) def func(arg1, arg2, ...): # ... # : func = decomaker(argA, argB, ...)(func)</span></span></code> </pre> <br>  There is no such possibility in PHP.  At first, I decided to take this syntax as it is and transfer it unchanged (except for passing the parameters of the decorator when calling; see below).  The first article describes exactly this syntax.  However, the IDE with syntax checking and one of two camps of commentators made us think.  As a result, the syntax is made more portable.  Now the decorator's description should be described in a single-line comment #: <br><ul><li>  # is partially deprecated, so its use will be more noticeable than ordinary //, / * and / **; </li><li>  A single-line comment does not collapse and is harder to lose sight of; </li><li>  <s>Suddenly decorators in php 5.x still appear and the need for this extension with a strange syntax will disappear.</s> </li></ul><br>  Having decided on the description format, you need to decide how the decorators themselves will be implemented.  The decorator function must return a function that replaces the original decorating.  This is where the anonymous functions and closures come in: <br><div class="spoiler">  <b class="spoiler_title">some PHP code</b> <div class="spoiler_text"><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($func)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">echo</span></span> <span class="hljs-string"><span class="hljs-string">"Decorator!\n"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">use</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($func)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> call_user_func_array($func, func_get_args()); }; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">a</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($v)</span></span></span><span class="hljs-function"> </span></span>{ var_dump($v); } $b = decor(<span class="hljs-string"><span class="hljs-string">'a'</span></span>); $b(<span class="hljs-number"><span class="hljs-number">42</span></span>); <span class="hljs-comment"><span class="hljs-comment">/* : Decorator! int(42) */</span></span></code> </pre><br>  In PHP, a mediated function call with passing parameters to it is, of course, verbose, this cannot be taken away. <br></div></div><br>  The result is a syntax from the image at the beginning of the article: <br><pre> <code class="php hljs"><span class="hljs-meta"><span class="hljs-meta">&lt;?php</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">decor</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">($func)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span></span>{} } <span class="hljs-comment"><span class="hljs-comment"># @decor function original() { // ... }</span></span></code> </pre><br>  And I want to get it without <a href="http://habrahabr.ru/post/179441/">rewriting the Zend lexer</a> , so that PHP itself does not have to be rebuilt (it <s>works - do not touch it</s> ). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <br><h2>  Implementation </h2><br>  There are two options for doing this: <br><ul><li>  Change the source code before it gets to the PHP tutor; </li><li>  Change the finished opcode, but then the syntax should be compatible with the existing one. </li></ul><br>  The second option looked dubious on the issue of compatibility with all sorts of opcode caches and optimizers.  And the initial version of the decorators syntax (without the # comment) in this case would not work. <br>  The first option was chosen. <br>  Zend has two sources of source code ‚Äúincome‚Äù: <br><ul><li>  Just a line with a code (similar to eval): <a href="">zend_eval_string [l] [_ ex]</a> , which all eventually boil down to calling <a href="">zend_compile_string</a> ; </li><li>  A file obtained from various sources (stdin, stream, etc. All options are listed in the <a href="">zend_stream_type</a> enumeration).  In this case, we are interested in <a href="">zend_compile_file</a> . </li></ul><br>  In both cases, we have pointers to functions with a specific implementation.  Standard implementations can be found by looking at the initialization of pointers in <a href="">zend_startup</a> : <br><ul><li>  zend_compile_file is implemented in <a href="">compile_file</a> ; </li><li>  zend_compile_string is in the equally obvious <a href="">compile_string</a> . </li></ul><br>  Both functions accept input in one form or another and source the array of opcode as <a href="">_zend_op_array</a> .  Unfortunately, despite the similarity of the tasks performed, their implementation is different.  So we will influence both. <br><br>  The effect on similar function pointers in Zend and PHP extensions has been put on stream.  For example, the same zend_compile_file is replaced in <a href="">ZendAccelerator</a> and <a href="">phar</a> .  This is not counting third-party extensions. <br><br>  For substitution, you only need to implement your analogue, and replace the pointer, retaining the original.  Everything as usual. <div class="spoiler">  <b class="spoiler_title">It turns out about the following</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">PHP_MINIT_FUNCTION</span></span>(decorators); <span class="hljs-type"><span class="hljs-type">PHP_MSHUTDOWN_FUNCTION</span></span>(decorators); zend_module_entry decorators_module_entry = { // ... decorators_functions, <span class="hljs-type"><span class="hljs-type">PHP_MINIT</span></span>(decorators), <span class="hljs-type"><span class="hljs-type">PHP_MSHUTDOWN</span></span>(decorators), // ... }; zend_op_array *(*decorators_orig_zend_compile_string)(zval *source_string, char *filename <span class="hljs-type"><span class="hljs-type">TSRMLS_DC</span></span>); zend_op_array *(*decorators_orig_zend_compile_file)(zend_file_handle *file_handle, int <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">); zend_op_array* decorators_zend_compile_string(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zval</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_string</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">); zend_op_array* decorators_zend_compile_file(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_file_handle</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">); /* {{{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PHP_MINIT_FUNCTION</span></span></span><span class="hljs-class"> */ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PHP_MINIT_FUNCTION(decorators)</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_orig_zend_compile_string</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_compile_string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_compile_string</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_zend_compile_string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_orig_zend_compile_file</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_compile_file</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_compile_file</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_zend_compile_file</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SUCCESS</span></span></span><span class="hljs-class">; } /* }}} */ /* {{{ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PHP_MSHUTDOWN_FUNCTION</span></span></span><span class="hljs-class"> */ </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">PHP_MSHUTDOWN_FUNCTION(decorators)</span></span></span><span class="hljs-class"> { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_compile_string</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_orig_zend_compile_string</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_compile_file</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_orig_zend_compile_file</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">SUCCESS</span></span></span><span class="hljs-class">; } /* }}} */ zend_op_array* decorators_zend_compile_string(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zval</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_string</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">) /* {{{ */ { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_orig_zend_compile_string</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">source_string</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">); } /* }}} */ zend_op_array* decorators_zend_compile_file(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_file_handle</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">int</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">) /* {{{ */ { </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">return</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">decorators_orig_zend_compile_file</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">); } /* }}} */</span></span></code> </pre></div></div><br>  During the initialization of the module (our extension), the pointers were replaced, and upon completion of the work, they did not forget to return everything.  Directly in the substituted functions we call the original implementation. <br>  Not everything can be done during module initialization, but in our case this is quite enough. <br><br>  And if everything is more or less clear with the compile_string (the input string comes to the input), then with compile_file everything is not so rosy - we don‚Äôt have the source code, only the source description in <a href="">zend_file_handle</a> .  And in different cases, different sets of fields are used. <div class="spoiler">  <b class="spoiler_title">Direct reading of the source is buried pretty far.</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">ZEND_API</span></span> zend_op_array *compile_file(zend_file_handle *file_handle, int <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">) { // ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">open_file_for_scanning</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">) // ... } </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">ZEND_API</span></span></span><span class="hljs-class"> int open_file_for_scanning(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_file_handle</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">) { // ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_stream_fixup</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">, &amp;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">size</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">) // ... }</span></span></code> </pre></div></div><br>  And the most interesting thing for us here is <a href="">zend_stream_fixup</a> , a function that unifies all sources of input of the source code and outputs the read buffer and its size.  That seems to be what we need, but we cannot influence the work of zend_stream_fixup and open_file_for_scanning, we only have control over compile_file.  <i>Someone went to copy-paste to himself these functions and all their dependencies, but we will make it easier.</i>  If you look at the source zend_stream_fixup, then you can see that all types are reduced to a single ZEND_HANDLE_MAPPED, which has the source code and its length in file_handle-&gt; handle.stream.mmap.buf and file_handle-&gt; handle.stream.mmap.len .  Moreover, if this data type is already specified in file_handle, then almost nothing needs to be changed and everything is given as is. <br>  It turns out that if we send zend_file_handle * file_handle in compile_file () already in the format ZEND_HANDLE_MAPPED with the correct value of all the fields, compile_file will accept this as it was.  And we can do this by calling zend_stream_fixup (which is a function of the Zend API, and not a replaceable pointer) once more before the compile_file call.  Then re-calling inside open_file_for_scanning just won't change anything. <div class="spoiler">  <b class="spoiler_title">We try</b> <div class="spoiler_text"><pre> <code class="hljs pgsql">zend_op_array* decorators_zend_compile_file(zend_file_handle *file_handle, <span class="hljs-type"><span class="hljs-type">int</span></span> <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TSRMLS_DC) <span class="hljs-comment"><span class="hljs-comment">/* {{{ */</span></span> { <span class="hljs-type"><span class="hljs-type">char</span></span> *buf; size_t size; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_stream_fixup(file_handle, &amp;buf, &amp;size TSRMLS_CC) == FAILURE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">NULL</span></span>; } //   file_handle    ZEND_HANDLE_MAPPED <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> decorators_orig_zend_compile_file(file_handle, <span class="hljs-keyword"><span class="hljs-keyword">type</span></span> TSRMLS_CC); } <span class="hljs-comment"><span class="hljs-comment">/* }}} */</span></span></code> </pre></div></div><br>  Hooray, it works.  Moreover, we have the source file in file_handle-&gt; handle.stream.mmap.buf / len, from where PHP would take it: stdin, fd, include http stream ... It remains to put our modified version of the code there and call the original zend_compile_file. <br><br>  <i>How decorators_preprocessor () does not work: I‚Äôll get an obvious string, pass it to the preprocessor, and return the result string.</i>  <i>Below, and so will the pieces of code from this function.</i> <br><br>  It remains to consider the preprocessor itself. <br><div class="spoiler">  <b class="spoiler_title">Transfer of separate raw data to a single function</b> <div class="spoiler_text"><pre> <code class="hljs lua">void preprocessor(zval *source_zv, zval *return_value TSRMLS_DC) { //    source_zv    return_value } /* {{{ DECORS_CALL_PREPROCESS */ #define DECORS_CALL_PREPROCESS(result_zv, buf, <span class="hljs-built_in"><span class="hljs-built_in">len</span></span>) \ <span class="hljs-keyword"><span class="hljs-keyword">do</span></span> { \ zval *source_zv; \ ALLOC_INIT_ZVAL(result_zv); \ ALLOC_INIT_ZVAL(source_zv); \ ZVAL_STRINGL(source_zv, (buf), (<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>), <span class="hljs-number"><span class="hljs-number">1</span></span>); \ preprocessor(source_zv, result_zv TSRMLS_CC); \ zval_dtor(source_zv); \ FREE_ZVAL(source_zv); \ } <span class="hljs-keyword"><span class="hljs-keyword">while</span></span> (<span class="hljs-number"><span class="hljs-number">0</span></span>); \ /* }}} */ /* {{{ proto <span class="hljs-built_in"><span class="hljs-built_in">string</span></span> decorators_preprocessor(<span class="hljs-built_in"><span class="hljs-built_in">string</span></span> $code) */ PHP_FUNCTION(decorators_preprocessor) { <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *source; int source_len; zval *result; <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (zend_parse_parameters(ZEND_NUM_ARGS() TSRMLS_CC, <span class="hljs-string"><span class="hljs-string">"s"</span></span>, &amp;source, &amp;source_len) == FAILURE) { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>; } DECORS_CALL_PREPROCESS(result, source, source_len); // ... } /* }}} */ zend_op_array* decorators_zend_compile_string(zval *source_string, <span class="hljs-built_in"><span class="hljs-built_in">char</span></span> *filename TSRMLS_DC) /* {{{ */ { zval *result; DECORS_CALL_PREPROCESS(result, Z_STRVAL_P(source_string), Z_STRLEN_P(source_string)); // ... } /* }}} */ zend_op_array* decorators_zend_compile_file(zend_file_handle *file_handle, int <span class="hljs-built_in"><span class="hljs-built_in">type</span></span> TSRMLS_DC) /* {{{ */ { // ... zval *result; DECORS_CALL_PREPROCESS(result, file_handle-&gt;handle.stream.mmap.buf, file_handle-&gt;handle.stream.mmap.<span class="hljs-built_in"><span class="hljs-built_in">len</span></span>); // ... } /* }}} */</code> </pre></div></div><br><br><h3>  Find and redo! </h3><br>  The task of the preprocessor is to find descriptions of decorators and to modify the code of the functions that decorators influence.  And for this it is best to work with source text tokens.  In order not to reinvent the wheel, the native Zend lexical scanner <a href="">lex_scan</a> was used, an example of the use of which for its own purposes can be seen in the implementation of <a href="">token_get_all</a> and <a href="">tokenize</a> , called inside token_get_all. <br><ol><li>  Save the current environment of the scanner in which our code works: <br><blockquote>  zend_lex_state original_lex_state; <br>  zend_save_lexical_state (&amp; original_lex_state TSRMLS_CC); <br></blockquote><br></li><li>  Prepare the source line for parsing: <br><blockquote>  zend_prepare_string_for_scanning (&amp; source_z, "" TSRMLS_CC) </blockquote><br></li><li>  Set the initial state of the lexer (all options <a href="">here</a> ): <br><blockquote>  LANG_SCNG (yy_state) = yycST_IN_SCRIPTING; </blockquote><br>  In contrast to token_get_all, we already parse the PHP code, so the presence of the opening tag is not necessary for us.  Appropriately, the initial state is not yycINITIAL, but yycST_IN_SCRIPTING. <br></li><li>  In the loop, we get all the tokens of the source line: <br><blockquote>  zval token_zv; <br>  int token_type; <br>  while (token_type = lex_scan (&amp; token_zv TSRMLS_CC)) { <br>  // ... <br>  } <br></blockquote><br>  token_type - token type: <br><ul><li>  &lt;256 is the character code of a single-character token; </li><li>  &gt; = 256 - the value of the constant <a href="">T_ *</a> .  The string description by token_type can be obtained via PHP_FUNCTION (token_name) / get_token_type_name. </li></ul><br>  token_zv contains the lexeme value itself.  However, as an alternative, you can use the yy_text and yy_leng fields of the zend_lex_state structure, which store the address of the first byte of the current token and its length, respectively.  Access to these fields, like many things in Zend, is implemented through the appropriate macros: <br><blockquote>  #define zendtext LANG_SCNG (yy_text) <br>  #define zendleng LANG_SCNG (yy_leng) <br></blockquote><br>  Now we use char * zendtext and unsigned int zendleng. <br><br>  In order to avoid memory leak, you need to take into account that the token_zv value is sometimes taken as it is from the source buffer, and sometimes memory is allocated for it.  Which needs to be released.  Those who are interested can look at the lex_scan () code, but for now just take the necessary piece of logic from token_get_all. <br></li><li>  We restore the environment of the scanner in which our code works: <br><blockquote>  zend_restore_lexical_state (&amp; original_lex_state TSRMLS_CC); </blockquote><br></li></ol><br>  Everything, we have a lexical analysis of the source code.  But I would like to highlight some more points of parsing. <br><br>  If PHP parses errors, the handler generates an error or exception, the file name and line number in the text of which are taken from the <a href="">_zend_compiler_globals</a> state.  The file name, for example, is taken from the compiled_filename field.  Which is set when calling zend_prepare_string_for_scanning ().  It is used inside <a href="">zend_error</a> (used to generate any E_ * errors; it is also used in this extension to generate E_PARSE).  But compiled_filename in zend_error () is used only if Zend is in the compile state (zend_bool in_compilation; everything is in the same _zend_compiler_globals).  Which in itself is not activated if we parse the source. <br>  So before parsing we switch to ‚Äúcompiling‚Äù: <br><blockquote>  zend_bool original_in_compilation = CG (in_compilation); <br>  CG (in_compilation) = 1; <br></blockquote><br>  And at the end we return everything back: <br><blockquote>  CG (in_compilation) = original_in_compilation; <br></blockquote><br>  Now, if we pass the correct filename to zend_prepare_string_for_scanning, the possible errors will be much more informative.  You can get the current file name via zend_get_compiled_filename (), which, however, can return NULL, from which php (if NULL is passed to zend_prepare_string_for_scanning) falls into segfault. <br><div class="spoiler">  <b class="spoiler_title">It remains to set the correct file name in decorators_preprocessor and decorators_zend_compile_file</b> <div class="spoiler_text"><pre> <code class="hljs haskell"><span class="hljs-type"><span class="hljs-type">PHP_FUNCTION</span></span>(decorators_preprocessor) { // ... char *prev_filename = zend_get_compiled_filename(<span class="hljs-type"><span class="hljs-type">TSRMLS_CC</span></span>) ? zend_get_compiled_filename(<span class="hljs-type"><span class="hljs-type">TSRMLS_CC</span></span>) : <span class="hljs-string"><span class="hljs-string">""</span></span>; zend_set_compiled_filename(<span class="hljs-string"><span class="hljs-string">"-"</span></span> <span class="hljs-type"><span class="hljs-type">TSRMLS_CC</span></span>); <span class="hljs-type"><span class="hljs-type">DECORS_CALL_PREPROCESS</span></span>(result, source, source_len); zend_set_compiled_filename(prev_filename <span class="hljs-type"><span class="hljs-type">TSRMLS_CC</span></span>); // ... } zend_op_array* decorators_zend_compile_file(zend_file_handle *file_handle, int <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">type</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_DC</span></span></span><span class="hljs-class">) /* {{{ */ { // ... </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_filename</span></span></span><span class="hljs-class"> = </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_get_compiled_filename</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">) ? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_get_compiled_filename</span></span></span><span class="hljs-class">(</span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">) : ""; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">const</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">char</span></span></span><span class="hljs-class">* </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class"> = (</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opened_path</span></span></span><span class="hljs-class">) ? </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">opened_path</span></span></span><span class="hljs-class"> : </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class">; </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_set_compiled_filename</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">filename</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zval</span></span></span><span class="hljs-class"> *</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">; </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">DECORS_CALL_PREPROCESS</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">result</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mmap</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">buf</span></span></span><span class="hljs-class">, </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">file_handle</span></span></span><span class="hljs-class">-&gt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">handle</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">stream</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">mmap</span></span></span><span class="hljs-class">.</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">len</span></span></span><span class="hljs-class">); </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">zend_set_compiled_filename</span></span></span><span class="hljs-class">(</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">prev_filename</span></span></span><span class="hljs-class"> </span><span class="hljs-type"><span class="hljs-class"><span class="hljs-type">TSRMLS_CC</span></span></span><span class="hljs-class">); // ... }</span></span></code> </pre><br>  In decorators_zend_compile_string, the file name is already known. <br></div></div><br><br><h3>  Source code modification </h3><br>  Having received everything that is needed for preprocessing, it remains to actually produce it.  The task of translating text composed of pieces (tokens) into the final text might not be so simple in C due to the active work with stitching together lines.  However, in <a href="">/PHP/ext/standard/php_smart_str.h</a> there is an implementation of smart strings, which will be very useful to us. <br><div class="spoiler">  <b class="spoiler_title">Short</b> <div class="spoiler_text"><pre> <code class="hljs axapta"> smart_str <span class="hljs-keyword"><span class="hljs-keyword">str</span></span> = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; smart_str str2 = {<span class="hljs-number"><span class="hljs-number">0</span></span>}; smart_str_appendc(&amp;<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>, <span class="hljs-string"><span class="hljs-string">'!'</span></span>); smart_str_appendl(&amp;<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>, <span class="hljs-string"><span class="hljs-string">"hello"</span></span>, <span class="hljs-number"><span class="hljs-number">5</span></span>); smart_str_append(&amp;<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>, &amp;str2); smart_str_append_long(&amp;<span class="hljs-keyword"><span class="hljs-keyword">str</span></span>, <span class="hljs-number"><span class="hljs-number">42</span></span>); <span class="hljs-comment"><span class="hljs-comment">//  .. //    size_t str.len     char* str.c //  : smart_str_free(&amp;str);</span></span></code> </pre></div></div><br>  In the loop parsing of lexemes, we glue the resulting string from tokens (zendtext, zendleng), where you need to change / add from yourself.  Directly replacement algorithm decorators, IMHO, is not so interesting.  From the potentially interesting - check that the T_COMMENT type token is similar to the decorator's description: the regular check '^ # [\ t] * @' (simple cycle, without regexp) is being checked and the address '@' is returned. <br><br><br><h3>  Little PHP last </h3><br>  When processing decorators, the source code of the function being decorated changes slightly: the body of the function is wrapped in an anonymous function, which is passed by the parameter to the nearest decorator.  Those.  for code <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// comment @a(A) @b @c(C, D) /** * yet another comment */ function x(X) { Y }</span></span></code> </pre><br>  As a result of preprocessing, the following code will be obtained: <br><pre> <code class="php hljs"><span class="hljs-comment"><span class="hljs-comment">// comment /** * yet another comment */ function x(X) { return call_user_func_array(a(b(c(function(X) { Y }, C, D)), A), func_get_args());}</span></span></code> </pre><br>  By A, C, D, X is meant an arbitrary code that is copied as is. <br>  From this the following consequences follow: <br><ul><li>  If the function being decorated is declared with parameters that have a default value, then the anonymous function will also have everything: <br><blockquote>  function foo ($ a, $ b = 42, $ c = array (100, 500)) <br>  {... <br>  =&gt; <br>  function foo ($ a, $ b = 42, $ c = array (100, 500)) <br>  {return call_user_func_array (... (function ($ a, $ b = 42, $ c = array (100, 500)) {... <br></blockquote><br></li><li>  In case of errors in the description of the names of the decorators, the line with the code in the description of the error will be the line with the function body '{'.  Similarly, with the parameters of the decorators - they will be on the line with the body closing the function '}'; </li><li>  Decorator parameters can be given the variable names of the function being decorated.  It turns out read / write control over the parameters; </li><li>  Since  func_get_args () is used to pass parameters, then passing a parameter by reference to the function being decorated is currently not working. </li></ul><br><br>  Well that's all.  If you really read up here, I hope it was interesting. <br><br>  I will provide and in this article the link to <a href="https://github.com/AterCattus/php-decorators">github</a> . </div><p>Source: <a href="https://habr.com/ru/post/180939/">https://habr.com/ru/post/180939/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../180929/index.html">One of the six remaining in working condition Apple-1 computers sold for $ 671,400</a></li>
<li><a href="../180931/index.html">In open offices, employees are more often ill and worse off.</a></li>
<li><a href="../180933/index.html">Hiding the process in Windows Task Manager</a></li>
<li><a href="../180935/index.html">Writing your template engine in Python</a></li>
<li><a href="../180937/index.html">New look at old MS Ajax</a></li>
<li><a href="../180941/index.html">Using RESTful Controllers for AngularJS Resources</a></li>
<li><a href="../180943/index.html">Microsoft has patented the achievement system for watching TV.</a></li>
<li><a href="../180949/index.html">The future of anonymity: What is it?</a></li>
<li><a href="../180951/index.html">27 days left before the first O3b satellite goes into orbit</a></li>
<li><a href="../180953/index.html">WebRTC at Google I / O 2013</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>