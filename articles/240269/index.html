<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using Caching Infrastructure in ASP.NET, continued</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In the last post I told you how to use the cache infrastructure in ASP.NET to increase the performance of the site. By adding a few lines of code I wa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using Caching Infrastructure in ASP.NET, continued</h1><div class="post__text post__text-html js-mediator-article">  In the <a href="http://habrahabr.ru/post/227129/">last post</a> I told you how to use the cache infrastructure in ASP.NET to increase the performance of the site.  By adding a few lines of code I was able to increase the performance of the site‚Äôs home page 5 times.  This time, let's go ahead and squeeze even more performance without resorting to different hacks. <br><a name="habracut"></a><br>  For example, I still use <a href="https://mvcmusicstore.codeplex.com/">the Mvc Music Store project</a> . <br>  If you have not read the previous posts, then it's time to see <a href="http://habrahabr.ru/post/168869/">how the home page was sped</a> . <br><br>  All optimization concerned the home page, now I will pass in the internal. <br><br><h4>  Load test </h4><br>  For verification, I made a load test in Visual Studio for 25 "virtual users" with the following script: <br>  1) Request home page <br>  2) Request a page of the genre (catalog) <br>  3) Request an album page (product) <br>  For fidelity, I‚Äôve made visits not on the same page of the catalog \ product, but randomly assigned to different pages. <br>  And also increased the percentage of new users to 80%, which is true. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The result is 42 scripts per second. <br><br><h4>  Adding Caching - A Simple Approach </h4><br>  In ASP.NET, you can set attributes, caching with dependencies on the database. <br>  To do this, you need to follow a few simple steps: <br><h6>  1. Enter caching parameters in web.config </h6><br><pre><code class="xml hljs"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">caching</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sqlCacheDependency</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">pollTime</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"1000"</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">databases</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MusicStore"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">connectionStringName</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MusicStoreEntities"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">databases</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">sqlCacheDependency</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">outputCacheSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">outputCacheProfiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">add</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">name</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Catalog"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">sqlDependency</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"MusicStore:Genres;MusicStore:Albums"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">duration</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"86400"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">location</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"ServerAndClient"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">varyByParam</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"Genre"</span></span></span><span class="hljs-tag"> </span><span class="hljs-attr"><span class="hljs-tag"><span class="hljs-attr">enabled</span></span></span><span class="hljs-tag">=</span><span class="hljs-string"><span class="hljs-tag"><span class="hljs-string">"true"</span></span></span><span class="hljs-tag"> /&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">outputCacheProfiles</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">outputCacheSettings</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">caching</span></span></span><span class="hljs-tag">&gt;</span></span> <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-name"><span class="hljs-tag"><span class="hljs-name">system.web</span></span></span><span class="hljs-tag">&gt;</span></span></code> </pre> <br>  The <code>sqlCacheDependency</code> element defines cache dependencies on the database.  The database dependency will check for changes at the <code>pollTime</code> interval, in this case 1000 milliseconds (1 second). <br>  The outputCacheProfiles element sets profiles so as not to repeat the same settings for different actions.  In addition, it allows you to manage caching, without rebuilding the project. <br><br><h6>  2. Make changes to the database schema so that dependencies work </h6><br>  To do this, at the start of the application, call the following lines of code <br><pre> <code class="cs hljs">String connStr = System.Configuration.ConfigurationManager.ConnectionStrings[<span class="hljs-string"><span class="hljs-string">"MusicStoreEntities"</span></span>].ConnectionString; System.Web.Caching.SqlCacheDependencyAdmin.EnableNotifications(connStr); System.Web.Caching.SqlCacheDependencyAdmin.EnableTableForNotifications(connStr, <span class="hljs-string"><span class="hljs-string">"Genres"</span></span>); System.Web.Caching.SqlCacheDependencyAdmin.EnableTableForNotifications(connStr, <span class="hljs-string"><span class="hljs-string">"Albums"</span></span>);</code> </pre><br><br><h6>  3. Add Attributes </h6><br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">OutputCache(CacheProfile = </span><span class="hljs-meta-string"><span class="hljs-meta"><span class="hljs-meta-string">"Catalog"</span></span></span><span class="hljs-meta">)</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Browse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> genre</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-comment"><span class="hljs-comment">//... } [OutputCache(CacheProfile = "Catalog")] public ActionResult Details(int id) { //... }</span></span></code> </pre><br><br>  Run the test again - 60 scripts per second.  That is, it was possible to increase the speed in this case by almost 50%. <br><br><h4>  Installing dependencies from code </h4><br>  If you use WebAPI, you will not be able to use caching attributes.  But in this case the <code>SqlCacheDependency</code> class will help you.  It is very simple to use it - in the constructor you specify the database name from the web.config and the table name.  An instance of SqlCacheDependency can be used to specify dependencies of items in the local cache. <br><br>  So you can make caching navigation, if you cache all the pages will be unprofitable. <br><pre> <code class="cs hljs">[<span class="hljs-meta"><span class="hljs-meta">ChildActionOnly</span></span>] <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">GenreMenu</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cacheKey = <span class="hljs-string"><span class="hljs-string">"Nav"</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> genres = <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.HttpContext.Cache.Get(cacheKey); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (genres == <span class="hljs-literal"><span class="hljs-literal">null</span></span>) { genres = storeDB.Genres.ToList(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.HttpContext.Cache.Insert(cacheKey, genres, <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SqlCacheDependency(<span class="hljs-string"><span class="hljs-string">"MusicStore"</span></span>,<span class="hljs-string"><span class="hljs-string">"Genres"</span></span>)); } <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> PartialView(genres); }</code> </pre><br><br>  There is another <code>SqlCacheDependency</code> constructor that takes a <code>SqlCommand</code> .  This is a completely different mechanism for tracking changes in the database, built on alerts from SQL Server Service Broker.  I tried to use these alerts, but they do not work for all requests.  And if the request is ‚Äúwrong‚Äù, then no errors occur and the alert arrives immediately after creation.  In addition, alerts are very slow.  According to my measurements in 8 times slow down the entry in the table. <br><br><h4>  but on the other hand </h4><br>  Dependencies on the database are not at all free. For their work, triggers are created that trigger the creation, modification and deletion of records.  These triggers update information in the service table about which tables and when they were changed.  And the flow on the side of the application periodically reads the table and notifies the dependencies. <br><br>  If volume changes occur infrequently, then the overhead of triggers is small.  And if changes occur often, the cache efficiency drops.  In the example of the Mvc Music Store, any change to any album will reset the entire cache for the entire catalog. <br><br><h4>  What to do? </h4><br>  If you stay within one server, then the same approach as used for caching a basket in the Mvc Music Store is suitable - to save individual items or data samples in the cache, and when writing - to reset the cache (more in <a href="http://habrahabr.ru/post/168869/">early post</a> ).  With proper selection of the granularity of caching and flushing, you can achieve high cache efficiency. <br><br>  But when scaling to multiple servers, this approach almost always does not work.  In the case of the basket, it will work only in the case of client affinity, when the same client comes to the same server.  Modern NLBs provide this, but in the case of, for example, caching goods, the client affinity will not help. <br><br><h5>  The distributed cache will help us. </h5><br>  If you have already installed more than one web server to service requests, then it is worth thinking about distributed cache. <br>  One of the best options for today is Redis.  It is available both on premises and in the Microsoft Azure cloud. <br><br>  To add Redis to an ASP.NET project, open the Package Manager Console and execute a couple of commands. <br><pre> <code class="dos hljs">Install-Package Redis-<span class="hljs-number"><span class="hljs-number">64</span></span> Install-Package StackExchange.Redis</code> </pre><br><br>  Redis supports an excellent feature - the so-called Keyspace Notifications (http://redis.io/topics/notifications).  This allows you to track when an item has been changed, even if changes occur on another server. <br><br>  To integrate this feature in ASP.NET, I wrote a small class: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">RedisCacheDependency</span></span>: <span class="hljs-title"><span class="hljs-title">CacheDependency</span></span> { <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">RedisCacheDependency</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">):</span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">base</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span> { Redis.Client.GetSubscriber().Subscribe(<span class="hljs-string"><span class="hljs-string">"__keyspace@0__:"</span></span> + key, (c, v) =&gt; { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.NotifyDependencyChanged(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> <span class="hljs-keyword"><span class="hljs-keyword">object</span></span>(), EventArgs.Empty ); }); } }</code> </pre><br>  This class implements CacheDependency in Redis. <br><br>  And now the client himself: <br><pre> <code class="cs hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">class</span></span> <span class="hljs-title"><span class="hljs-title">Redis</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> <span class="hljs-keyword"><span class="hljs-keyword">readonly</span></span> ConnectionMultiplexer Client = ConnectionMultiplexer.Connect(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>); <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> CacheDependency </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">CreateDependency</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> RedisCacheDependency(key); } <span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> T GetCached&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">string</span></span> key, Func&lt;T&gt; getter) <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> T:<span class="hljs-keyword"><span class="hljs-keyword">class</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> localCache = HttpRuntime.Cache; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> result = (T) localCache.Get(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redisDb = Client.GetDatabase(); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> <span class="hljs-keyword"><span class="hljs-keyword">value</span></span> = redisDb.StringGet(key); <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>.IsNullOrEmpty) { result = Json.Decode&lt;T&gt;(<span class="hljs-keyword"><span class="hljs-keyword">value</span></span>); localCache.Insert(key, result, CreateDependency(key)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } result = getter(); redisDb.StringSet(key, Json.Encode(result)); localCache.Insert(key, result, CreateDependency(key)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result; } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">DeleteKey</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> key</span></span></span><span class="hljs-function">)</span></span> { HttpRuntime.Cache.Remove(key); <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> redisDb = Client.GetDatabase(); redisDb.KeyDelete(key); } }</code> </pre><br>  The GetCached method saves the result in the ASP.NET local cache.  The local cache is very fast, checking the item in the cache takes nanoseconds.  This is much faster than a remote request to Redis + serialization-deserialization. <br><br>  Now I can bind the item in the Redis cache to the page cache: <br><pre> <code class="cs hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> ActionResult </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">Browse</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">string</span></span></span></span><span class="hljs-function"><span class="hljs-params"> genre</span></span></span><span class="hljs-function">)</span></span> { <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cacheKey = <span class="hljs-string"><span class="hljs-string">"catalog-"</span></span> + genre; <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> genreModel = Redis.GetCached(cacheKey, () =&gt; (<span class="hljs-keyword"><span class="hljs-keyword">from</span></span> g <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> storeDB.Genres <span class="hljs-keyword"><span class="hljs-keyword">where</span></span> g.Name == genre <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> GenreBrowse { Name = g.Name, Albums = <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> a <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> g.Albums <span class="hljs-keyword"><span class="hljs-keyword">select</span></span> <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> AlbumSummary { Title = a.Title, AlbumId = a.AlbumId, AlbumArtUrl = a.AlbumArtUrl } } ).Single() ); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Response.AddCacheItemDependency(cacheKey); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Response.Cache.SetLastModifiedFromFileDependencies(); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Response.Cache.AppendCacheExtension(<span class="hljs-string"><span class="hljs-string">"max-age=0"</span></span>); <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Response.Cache.VaryByParams[<span class="hljs-string"><span class="hljs-string">"genre"</span></span>] = <span class="hljs-literal"><span class="hljs-literal">true</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.Response.Cache.SetCacheability(HttpCacheability.ServerAndPrivate); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> View(genreModel); }</code> </pre> <br>  The standard OutputCache attribute must be removed, otherwise it will not respond to your dependencies.  If you wish, you can write your ActionFilter for caching, so as not to copy-paste the code. <br><br>  To reset the cache, call Redis.DeleteKey in the methods that modify the data. <br><br>  Repeated load test issued 52 scripts per second.  This is less than without Redis, but performance will not noticeably fall with an increase in the number of records in the table. <br><br><h5>  What else can be done with Redis? </h5><br>  In addition to manually placing data in the cache, you can use the NuGet <a href="https://www.nuget.org/packages/Microsoft.Web.RedisSessionStateProvider">Microsoft.Web.RedisSessionStateProvider</a> and <a href="https://www.nuget.org/packages/Microsoft.Web.RedisOutputCacheProvider/">Microsoft.Web.RedisOutputCacheProvider</a> packages to place the session state and page cache on Redis.  Unfortunately, the custom OutputCacheProvider restricts the use of CacheDependency to reset the output cache. <br><br><h4>  Conclusion </h4><br>  In ASP.NET, there are a lot of caching options, besides the posts reviewed in this series there are also cache validation callbacks, linking to files and directories.  But there are pitfalls that I haven‚Äôt mentioned yet.  If you are interested in everything related to optimization of web applications on ASP.NET, then come to my seminar - <a href="http://gandjustas.timepad.ru/event/150915/">gandjustas.timepad.ru/event/150915</a> <br><br><h5>  All posts series </h5><br><ul><li>  Caching Strategies - <a href="http://habrahabr.ru/post/168725/">habrahabr.ru/post/168725</a> </li><li>  Caching in ASP.NET MVC - <a href="http://habrahabr.ru/post/168869/">habrahabr.ru/post/168869</a> </li><li>  Application of caching infrastructure in ASP.NET - <a href="http://habrahabr.ru/post/227129/">habrahabr.ru/post/227129</a> </li><li>  Application of caching infrastructure in ASP.NET, continued - <a href="http://habrahabr.ru/post/240269/">habrahabr.ru/post/240269</a> </li></ul><br>  Source code along with tests is available on GitHub - <a href="https://github.com/gandjustas/McvMusicStoreCache">github.com/gandjustas/McvMusicStoreCache</a> </div><p>Source: <a href="https://habr.com/ru/post/240269/">https://habr.com/ru/post/240269/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../240245/index.html">A simple reminder for Linux</a></li>
<li><a href="../240247/index.html">How we spent the whole day 10 rubles or Hakaton poison</a></li>
<li><a href="../240261/index.html">From the diary of the prize-winner of the first All-Russian Programming Olympiad for schoolchildren in 1989</a></li>
<li><a href="../240265/index.html">Using Backbone.js when working with html5 canvas</a></li>
<li><a href="../240267/index.html">ASUS ZenFone 5: tested in humans</a></li>
<li><a href="../240271/index.html">Design vs. Layout?</a></li>
<li><a href="../240273/index.html">Epson WorkForce Pro - even more profitable office printing</a></li>
<li><a href="../240275/index.html">Dependency management in a complex Agile environment</a></li>
<li><a href="../240277/index.html">Docker containers for web developer under OS X</a></li>
<li><a href="../240281/index.html">Online conference "E-commerce MegaIndex.tv 2014. Autumn practice"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>