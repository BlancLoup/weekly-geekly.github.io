<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Protocol features in IO games</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Suppose you want to create an IO game. Something like agar.io, slither.io and thousands of them . 

 What is an IO game?  This name was assigned to th...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Protocol features in IO games</h1><div class="post__text post__text-html js-mediator-article">  Suppose you want to create an IO game.  Something like agar.io, slither.io and <a href="http://iogames.one/">thousands of them</a> . <br><br><div class="spoiler">  <b class="spoiler_title">What is an IO game?</b> <div class="spoiler_text">  This name was assigned to the browser, client-server multiplayer games in real time. <br><br>  The mechanics of such games are usually relatively simple and interest is achieved through epic battles between a large number of real players. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      The ancestor of the genre is <a href="http://agar.io/">agar.io</a> </div></div><br>  Many people know that in these games use websocket.  And there is nothing difficult in creating your own protocol above it.  I thought so when about a year ago we started a space shooter project in this style. <br><br>  Now I do not think so. <br><a name="habracut"></a><br><h3>  What is the problem </h3><br>  The main problem that all multiplayer game developers have to solve is achieving the ‚Äúsimultaneity‚Äù of what is happening. <br><br>  Naive approach: let me move my hero, send these movements to the server, and the server will send them to my opponents - does not work.  If you do this, then your hero will live in real time, and his rivals in the past.  Their movements will lag about two pings to the server.  Let's say if ping is 100ms, then you will see where the rivals were 200ms ago.  Accordingly, it will be impossible to play. <br><br><h3>  Formulation of the problem </h3><br>  There are two-dimensional rooms in which flying, following the mouse pointer, space ships. <br>  You need to create a protocol so that: <br><br><ul><li>  movements were smooth </li><li>  all the "pilots" picture was the same and displayed all the ships at any one time </li></ul><br>  Disclaimer: <br><br>  The final result is very simple. <br><br>  But try, for the purity of the experiment, to come up with your own version before reading the article, in order to avoid the effect of retroactive knowledge when writing comments. <br><br><h3>  First decision </h3><br>  Let each client, when drawing each frame, send the position of the mouse cursor to the server. <br>  And the server, having received it, immediately reads the current coordinates of the ship and sends them to all clients (including the one who transmitted the coordinates of the mouse). <br><br>  It's simple.  Simultaneity is achieved here. <br><br>  And it even works while we have a server locally, and very few clients. <br><br>  Under the conditions close to real, such an approach gave three things: rabid traffic (which exceeded the traffic of agar.io by an order of magnitude), periodic ‚Äújumps‚Äù of ships (instead of a smooth flight) and wild lags, which usually began in 3-5 minutes, and then they never went through and were ‚Äútreated‚Äù only by restarting the browser. <br><br><h3>  The second version of the protocol </h3><br>  The first edit was obvious: it was wrong to send ship transfers immediately after receiving a management team from a client. <br><br>  If you do this, then the frequency of the arrival of commands from the server to clients depends on three things: <br><br><ul><li>  the frequency of their ship ship to the server </li><li>  channel load from the ship to the server </li><li>  and load channels from the server to other clients </li></ul><br>  Too many variables.  Measurements showed that commands that, in theory, are sent every 20 ms, arrive at a random interval from 5 to 90 ms. <br><br>  The solution to this problem was simple - instead of sending the command to the client immediately, they made a timer sending - one command in 20ms. <br><br>  "Jumping" ships have decreased significantly ... <br><br><h3>  Third version </h3><br>  ... but not disappeared. <br><br>  At some point, obeying the network lags, the next packet came with a big delay.  Not after 20ms, but after 100, for example. <br><br>  Accordingly, the ship first braked, and then abruptly darting off and "teleported" a few pixels. <br><br>  And then a strange idea arose: and in the case of such delays, let us move the ship in the same direction, to which it flew earlier. <br><br>  Maybe the picture will become smoother?  This idea did not work, but it turned out to be a step towards the right decision. <br><br>  And so, the ship on the client now all the time (that is, every frame) flies with its constant speed. <br><br>  Commands to change this speed come from the server, as well as ‚Äúcorrections‚Äù for the coordinates of the ship. <br><br>  Result?  Instead of rare long-distance jumps, our ships began to make a series of jumps for short distances. <br><br>  It turned out that from the point of view of the client the ship is in one place, and from the point of view of the server - in another. <br><br>  ‚ÄúCorrections‚Äù sent from the server and led to microjumps. <br><br>  Further can serve as an example, as two <s>moronic</s> not entirely successful ideas, implemented consistently, can give an unexpected result: <br><br>  And let's send the amendment less often and see what happens! <br><br>  Nothing good, of course, did not work - the jumps again became more rare and long. <br>  But on the other hand, I noticed that the control of the ship does not become less responsive even with a multiple increase in the interval between the sending of the amendment. <br><br><h3>  Fourth version </h3><br>  But this means that I absolutely in vain mixed two characteristic quantities: FPS - the need to move the ship on the screen 60 times per second, and sending a control signal from the mouse. <br><br>  The control signal can be sent much less frequently, since it correlates not with the peculiarities of human vision, but with the speed of human reaction. <br><br>  And she - about 200-250ms! <br><br>  Taking into account the ping to the server (approximately 100 ms), this meant that the control signals can be sent about once every 100‚Äì150 ms, and the smoothness of movement is already provided on the client. <br><br>  As a result, the fourth version of the protocol looked like this: <br><br><ul><li>  the client sends the mouse position to the server once every 120ms </li><li>  receiving this control command, the server recalculated the coordinates of the ship </li><li>  asynchronously, a thread worked on the server that sent the ship‚Äôs coordinates and speed to clients exactly once every 120ms </li><li>  after receiving the coordinates, customers moved the ships to this new point, and used the speed for the smooth movement of the ship in order to achieve an acceptable FPS </li></ul><br>  Bonus from this version - a sharp decrease in traffic.  Now he has become the same as on agar (it seems that Matheus Valadares knew something!). <br><br>  But the most important thing is that the problem of heavy lags, occurring in 3-5 minutes and incurable by nothing, was automatically solved. <br><br>  (A few days later I came across <a href="https://habrahabr.ru/post/322690/">this article</a> and it became clear exactly what was happening there). <br><br>  Now there was only one problem - small jumps of the ships during synchronization. <br><br><h3>  Version five - final </h3><br>  If synchronization is not done or is rarely done, then the location of the ships on the server and on the clients turned out to be different, which naturally was unacceptable. <br><br>  But we also did not want to endure jumps that turned into really full-fledged jumps at any network delay. <br><br>  The original idea looked like this: What if we "spread" time synchronization?  Here we will not immediately move the ship to the desired point, but tell it to move there frames for 7-8? <br><br>  ‚ÄúSo, but this is an additional delay ...‚Äù <br>  - And by the way, we change the speed of the ship only once every 120ms.  So we know in advance where it will be after 120ms! <br>  - From this place more! <br><br>  Thus, the simplest (when retroactively considered) idea was born: instead of synchronization, the server sends to the client the coordinates of the ship where it should be in 120ms. <br><br>  And the whole protocol became so: <br><br><ul><li>  the client sends the mouse position to the server once every 120ms </li><li>  receiving this control command, the server recalculates the coordinates of the ship </li><li>  asynchronously, a thread is running on the server, which exactly once in the same 120ms sends to the client the coordinates in which the ship must be at the end of the next 120ms </li><li>  after receiving the coordinates, customers make a simple calculation: if the ship is now at point A, then how fast should you move it within the next 120ms so that it will be at point B that came from the server </li></ul><br>  This protocol solved all the problems.  It is resistant to packet delays. <br><br>  Even if for some reason the ship did not reach (or flew) the former one at the moment of receiving a new target, this will not affect the smoothness of the course in any way - only the speed will be slightly corrected. <br><br>  Now we are pleased with the protocol.  The result can be seen here: <a href="https://spacewar.io/">https://spacewar.io</a> </div><p>Source: <a href="https://habr.com/ru/post/323466/">https://habr.com/ru/post/323466/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../323452/index.html">Visual Studio 2017 and new features of Microsoft tools</a></li>
<li><a href="../323456/index.html">Women who have changed business</a></li>
<li><a href="../323458/index.html">What to base React applications</a></li>
<li><a href="../323460/index.html">How to return to coders when over forty</a></li>
<li><a href="../323462/index.html">Creating a blog engine with Phoenix and Elixir / Part 8. Finish with comments</a></li>
<li><a href="../323468/index.html">How we ranked nine million developers on Github</a></li>
<li><a href="../323470/index.html">Why are all virtual assistants women?</a></li>
<li><a href="../323472/index.html">Why are we sure we deployed</a></li>
<li><a href="../323474/index.html">How IT professionals work. Daria Kulaga, Lead Developer, AT Consulting Regional Business Unit</a></li>
<li><a href="../323476/index.html">Everyone lies or interviews, which was not</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>