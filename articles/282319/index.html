<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Mozilla Thunderbird OAuth authorization: from inception to release</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some time ago we talked about how Mail.Ru implemented mail collection using the OAuth 2.0 protocol . We continue to improve mail security and push the...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Mozilla Thunderbird OAuth authorization: from inception to release</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/files/4d3/cd5/26a/4d3cd526a9a3409895fab682dc247a13.jpg"><br></p><br><p>  Some time ago we talked about how <a href="https://habrahabr.ru/company/mailru/blog/264049/">Mail.Ru implemented mail collection using the OAuth 2.0 protocol</a> .  We continue to improve mail security and push the OAuth 2.0 standard to the masses.  And today we will tell about how we added OAuth authentication to the Mozilla Thunderbird email client.  In this example, we will analyze the process of introducing a new feature into an open source product, from creating a ticket to a release.  If you have long wanted to make your first pull request, but did not know how, - read our story. </p><a name="habracut"></a><br><img src="https://habrastorage.org/files/98c/8dd/810/98c8dd810f2a4a53a23991f05b447d0a.png"><br><h1>  1. The general scheme of work </h1><br><p> On user actions Thunderbird opens a web view with an address for OAuth authorization.  If the user has successfully passed the authorization procedure and agreed to provide the application with access to his data, then we redirect the user to the address specified in the <code>redirect_uri</code> parameter.  So the application will receive an authorization token and can use it to work with our postal service.  Address to request a token: </p><br><pre> <code class="hljs perl">https:<span class="hljs-regexp"><span class="hljs-regexp">//o</span></span>2.mail.ru/login ?response_type=code &amp;client_id=&lt; &gt; &amp;redirect_uri=http%3A%2F%2Flocalhost</code> </pre> <br><p>  It is worth noting that the application sets the localhost value for the <code>redirect_uri</code> parameter itself, and does not transmit the <a href="https://tools.ietf.org/html/rfc6749">state</a> parameter (used by the client to support the connection between the request and the callback).  Below is a diagram of the interaction of the application with the service: </p><br><p><img src="https://habrastorage.org/files/151/d14/880/151d148808a44a6a9022b9e800aef665.png" width="500" height="500"><br></p><br><h1>  2. How is the integration process, the main stages </h1><br><p>  Although the integration process itself is fairly simple and does not take much time, it is still worth talking about specific points that should be planned in advance. </p><br><p>  Since Thunderbird is a Mozilla product, we immediately went to <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird">MDN</a> .  So we quickly got a general idea of ‚Äã‚Äãthe main stages of integration: </p><br><ol><li>  Ticket to add mail client. </li><li>  Ticket to add configuration to the ISP-base. </li><li>  Patch to the comm-central repository. </li><li>  Patch to ISP database. </li><li>  Test build. </li><li>  Preserving backward compatibility. </li><li>  Testing functionality in early releases. </li><li>  Release Testing </li></ol><br><p>  Next, we consider each stage separately. </p><br><h2>  2.1.  Ticket to add mail client </h2><br><p>  Before you put a ticket, make sure that no one has done this before you.  Setting a ticket is a key step in solving any similar problem, so it is very important to fill in all the required fields correctly: </p><br><ul><li><p>  <strong><em>Product</em></strong> : The <code>comm-central</code> repository structure is divided into independent products.  We had no problems with this, since the name of the product MailNews is immediately mentioned on the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird">start page</a> . </p><br></li><li><p>  <strong><em>Component</em></strong> : Opposite this item there is a hint, however, here and so intuitively it is clear that the work is connected with the network, therefore we choose Networking. </p><br></li><li><p>  <strong><em>Version</em></strong> : To understand which release version to choose, you should refer to the <a href="https://www.mozilla.org/en-US/thunderbird/releases/">release list</a> page.  However, this information will not be enough, since it is important for us to understand at what stage the release is not yet released.  With this we will help release <a href="https://wiki.mozilla.org/RapidRelease/Calendar">calendar</a> .  More information about the release cycle can be found on the corresponding <a href="https://wiki.mozilla.org/RapidRelease">page</a> .  But if you still doubt which release version to choose, feel free to ask your question on <a href="https://lists.mozilla.org/listinfo/dev-apps-thunderbird">the mailing list</a> or the <a href="http://irc//irc.mozilla.org/maildev">IRC channel</a> .  If absolutely necessary, ticket reviewers will help you. </p><br></li><li><p>  <strong><em>Platform</em></strong> : In our case, the product is platform- <code>all</code> ( <code>all</code> ). </p><br></li><li><p>  <strong><em>Importance</em></strong> : As we expand the functionality, the type will be <code>enhancement</code> . </p><br></li><li>  <strong><em>Keywords</em></strong> : Keyword list is limited.  A quick search for similar tickets prompted to choose a <code>feature</code> , <code>user-doc-needed</code> . </li></ul><br><blockquote>  Advice: in order to not miss any stage, add a <a href="">calendar</a> to yourself. </blockquote><br><h2>  2.2.  Ticket to add configuration to the ISP-base </h2><br><p>  We got a good reviewer who helped with filling out most of the fields and release.  See an example of <a href="https://bugzilla.mozilla.org/show_bug.cgi%3Fid%3D1253196">our</a> ticket. </p><br><h2>  2.3.  Patch in the comm-central repository </h2><br><p>  If you noticed, the Mozilla community is very sensitive about documenting their products.  Guidance on the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Simple_Thunderbird_build">assembly of the</a> product, the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Mailnews_and_Mail_code_review_requirements">style of</a> writing code, etc. All references to this are located in one place and do not require, as is often the case with other products, the passage of a certain quest.  I‚Äôll say right away that there is no ‚Äúrocket science‚Äù in adding a new OAuth provider to Thunderbird, this becomes clear after the <a href="http://hg.mozilla.org/comm-central">repository</a> grep and a quick acquaintance with the source code.  Although there were quite a few files with the OAuth keyword: </p><br><pre> <code class="hljs ruby">‚ûú hg clone <span class="hljs-symbol"><span class="hljs-symbol">http:</span></span>/<span class="hljs-regexp"><span class="hljs-regexp">/hg.mozilla.org/comm</span></span>-central ... ‚ûú hg grep --ignore-<span class="hljs-keyword"><span class="hljs-keyword">case</span></span> --files-with-matches oauth <span class="hljs-params"><span class="hljs-params">| wc -l 91</span></span></code> </pre> <br><p>  Intuition suggested that everything should be easier.  And we were not mistaken when we opened the first file from the list: </p><br><pre> <code class="hljs cs">mailnews/<span class="hljs-keyword"><span class="hljs-keyword">base</span></span>/util/OAuth2Providers.jsm</code> </pre> <br><p>  I will not torment, just look diff: </p><br><pre> <code class="hljs pgsql">‚ûú hg <span class="hljs-keyword"><span class="hljs-keyword">log</span></span> -p -l <span class="hljs-number"><span class="hljs-number">1</span></span></code> </pre> <br><pre> <code class="diff hljs">changeset: [draft] 18512:a2f404184ac0 support_oauth_mail_ru_1231642 tip author: Alexander Abashkin &lt;monolithed@gmail.com&gt; date: Mon, 14 Dec 2015 15:17:09 +0300 (4 months ago) summary: Bug 1231642 - Log in to Mail.Ru (IMAP/SMTP) using OAuth M mailnews/base/util/OAuth2Providers.jsm diff --git a/mailnews/base/util/OAuth2Providers.jsm b/mailnews/base/util/OAuth2Providers.jsm --- a/mailnews/base/util/OAuth2Providers.jsm +++ b/mailnews/base/util/OAuth2Providers.jsm @@ -10,32 +10,41 @@ var EXPORTED_SYMBOLS = ["OAuth2Providers var {classes: Cc, interfaces: Ci, results: Cr, utils: Cu} = Components; // map of hostnames to [issuer, scope] var kHostnames = new Map([ ["imap.googlemail.com", ["accounts.google.com", "https://mail.google.com/"]], ["smtp.googlemail.com", ["accounts.google.com", "https://mail.google.com/"]], ["imap.gmail.com", ["accounts.google.com", "https://mail.google.com/"]], ["smtp.gmail.com", ["accounts.google.com", "https://mail.google.com/"]], + ["imap.mail.ru", ["o2.mail.ru", "mail.imap"]], + ["smtp.mail.ru", ["o2.mail.ru", "mail.imap"]], ]); // map of issuers to appKey, appSecret, authURI, tokenURI var kIssuers = new Map ([ ["accounts.google.com", [ '406964657835-aq8lmia8j95dhl1a2bvharmfk3t1hgqj.apps.googleusercontent.com', 'xxxxxxxxxxxx', 'https://accounts.google.com/o/oauth2/auth', 'https://www.googleapis.com/oauth2/v3/token' ]], + ["o2.mail.ru", [ + 'thunderbird', + 'xxxxxxxxxxxx', + 'https://o2.mail.ru/login', + 'https://o2.mail.ru/token' + ]], ]);</code> </pre> <br><p>  If you paid attention, then, unfortunately, we have not yet supported the <a href="https://tools.ietf.org/html/rfc7591">new protocol</a> , which allows you to dynamically register a client, but we are working on it!  And then the patch attach by ticket number: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hg</span></span> diff -g &gt; <span class="hljs-number"><span class="hljs-number">1231642</span></span>.patch</code> </pre> <br><p>  PS Be prepared for the fact that cloning the repository requires up to 5 GB of free disk space. </p><br><h2>  2.4.  Patch to ISP database </h2><br><p>  This configuration is necessary to select the protocol to be used by default.  An example of autoconfig file: <a href="">https://autoconfig.thunderbird.net/v1.1/mail.ru</a> .  The <code>ISP</code> SVN repository is located at the following address: </p><br><pre> <code class="hljs objectivec">https:<span class="hljs-comment"><span class="hljs-comment">//svn.mozilla.org/mozillamessaging.com/sites/autoconfig.mozillamessaging.com/</span></span></code> </pre> <br><p>  Since we have already dealt with this config earlier, it will be easier to show diff than telling: </p><br><pre> <code class="hljs 1c">‚ûú svn diff trunk/mail.ru <span class="hljs-string"><span class="hljs-string">| vi -R -</span></span></code> </pre> <br><pre> <code class="diff hljs"><span class="hljs-comment"><span class="hljs-comment">--- trunk/mail.ru| (revision 150325) +++ trunk/mail.ru| (working copy) @@ -13,6 +13,7 @@ &lt;incomingServer type="imap"&gt; &lt;hostname&gt;imap.mail.ru&lt;/hostname&gt; &lt;port&gt;993&lt;/port&gt; &lt;socketType&gt;SSL&lt;/socketType&gt; &lt;username&gt;%EMAILADDRESS%&lt;/username&gt; + &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;password-cleartext&lt;/authentication&gt; &lt;/incomingServer&gt; &lt;incomingServer type="imap"&gt; &lt;hostname&gt;imap.mail.ru&lt;/hostname&gt; &lt;port&gt;143&lt;/port&gt; &lt;socketType&gt;STARTTLS&lt;/socketType&gt; &lt;username&gt;%EMAILADDRESS%&lt;/username&gt; + &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;password-cleartext&lt;/authentication&gt; &lt;/incomingServer&gt; &lt;outgoingServer type="smtp"&gt; &lt;hostname&gt;smtp.mail.ru&lt;/hostname&gt; &lt;port&gt;465&lt;/port&gt; &lt;socketType&gt;SSL&lt;/socketType&gt; &lt;username&gt;%EMAILADDRESS%&lt;/username&gt; + &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;password-cleartext&lt;/authentication&gt; &lt;/outgoingServer&gt; &lt;outgoingServer type="smtp"&gt; &lt;hostname&gt;smtp.mail.ru&lt;/hostname&gt; &lt;port&gt;587&lt;/port&gt; &lt;socketType&gt;STARTTLS&lt;/socketType&gt; &lt;username&gt;%EMAILADDRESS%&lt;/username&gt; + &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;password-cleartext&lt;/authentication&gt; &lt;/outgoingServer&gt;</span></span></code> </pre> <br><p>  At this stage, you should not hurry, even if your server already supports OAuth authorization, because you can get the side effect in the form of broken authorization.  Alternatively, you can place the autoconfig file on your server: <a href="">https://autoconfig.mail.ru/mail/config-v1.1.xml</a> .  In this case, your file will have a higher priority and you will be able to independently manage the authorization method not only at the testing stage.  If your mail service has domain aliases, then you should not worry: the ISP server looks at the MX records.  For more information about this server configuration method, see <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Autoconfiguration">here</a> . </p><br><h2>  2.5.  Test build </h2><br><p>  Clone repository: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">hg</span></span> clone http://hg.mozilla.org/comm-central cd comm-central python client.py checkout</code> </pre> <br><p>  Add a configuration for the test environment: </p><br><pre> <code class="hljs bash">‚ûú <span class="hljs-built_in"><span class="hljs-built_in">echo</span></span> $<span class="hljs-string"><span class="hljs-string">'ac_add_options --enable-application=mail\nac_add_options --enable-debug'</span></span> &gt; .mozconfig</code> </pre> <br><p>  We collect the project: </p><br><pre> <code class="hljs">./mozilla/mach build</code> </pre> <br><p>  If during the build an error appears that the source code is outdated, then run the following command and restart the build again: </p><br><pre> <code class="hljs pgsql">./mozilla/mach mercurial-setup <span class="hljs-comment"><span class="hljs-comment">--update-only</span></span></code> </pre> <br><p>  For more information about the build project, see <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Simple_Thunderbird_build">here</a> . </p><br><p>  Possible problems: </p><br><p>  For OS X 10.9‚Äì10.10 (at 10.11 this option interferes with the build) you may need to add the following option: </p><br><pre> <code class="hljs scala">echo <span class="hljs-symbol"><span class="hljs-symbol">'ac_add_options</span></span> --<span class="hljs-keyword"><span class="hljs-keyword">with</span></span>-macos-sdk=/<span class="hljs-type"><span class="hljs-type">Applications</span></span>/<span class="hljs-type"><span class="hljs-type">Xcode</span></span>.app/<span class="hljs-type"><span class="hljs-type">Contents</span></span>/<span class="hljs-type"><span class="hljs-type">Developer</span></span>/<span class="hljs-type"><span class="hljs-type">Platforms</span></span>/<span class="hljs-type"><span class="hljs-type">MacOSX</span></span>.platform/<span class="hljs-type"><span class="hljs-type">Developer</span></span>/<span class="hljs-type"><span class="hljs-type">SDKs</span></span>/'</code> </pre> <br><p>  Also during the build process you may be asked to install autoconf 2.13: </p><br><pre> <code class="hljs javascript">fx-team ./mach build /usr/bin/make -f client.mk -s Adding client.mk options <span class="hljs-keyword"><span class="hljs-keyword">from</span></span> : MOZ_OBJDIR=<span class="hljs-regexp"><span class="hljs-regexp">/Applications/</span></span>MAMP/htdocs/fx-team/obj-x86_64-apple-darwin14<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> OBJDIR=<span class="hljs-regexp"><span class="hljs-regexp">/Applications/</span></span>MAMP/htdocs/fx-team/obj-x86_64-apple-darwin14<span class="hljs-number"><span class="hljs-number">.0</span></span><span class="hljs-number"><span class="hljs-number">.0</span></span> /Applications/MAMP/htdocs/fx-team/client.mk:<span class="hljs-number"><span class="hljs-number">304</span></span>: *** Could not find autoconf <span class="hljs-number"><span class="hljs-number">2.13</span></span>. Stop. make: *** [build] <span class="hljs-built_in"><span class="hljs-built_in">Error</span></span> <span class="hljs-number"><span class="hljs-number">2</span></span> <span class="hljs-number"><span class="hljs-number">0</span></span> compiler warnings present.</code> </pre> <br><p>  OS X Solution: </p><br><pre> <code class="hljs sql">brew rm autoconf brew tap homebrew/versions brew <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> autoconf213</code> </pre> <br><p>  It may be our fault, but for some reason the <code>configure</code> file was generated with syntax errors: </p><br><pre> <code class="bash hljs">0:00.70 *** Fix above errors and <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> restart with\ 0:00.70 <span class="hljs-string"><span class="hljs-string">"/opt/local/bin/gmake -f client.mk build"</span></span> 0:00.71 /comm-central/client.mk:361:      ¬´configure¬ª 0:00.71 gmake[1]: *** [configure]  1</code> </pre> <br><p>  Decision: </p><br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">rm</span></span> configure &amp;&amp; ./mozilla/mach build</code> </pre> <br><p>  Such an error indicates the absence of a YASM compiler in the system. </p><br><pre> <code class="bash hljs">0:09.52 configure:21252: checking <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> CoreMedia/CoreMedia.h 0:09.52 configure:21262: /usr/bin/clang -E -Qunused-arguments conftest.c &gt;/dev/null 2&gt;conftest.out 0:09.52 configure: error: yasm is a required build tool <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> this architecture when webm is enabled. You may either install yasm or --<span class="hljs-built_in"><span class="hljs-built_in">disable</span></span>-webm (<span class="hljs-built_in"><span class="hljs-built_in">which</span></span> disables the WebM video format). See https://developer.mozilla.org/en/YASM <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> more details. 0:09.52 *** Fix above errors and <span class="hljs-keyword"><span class="hljs-keyword">then</span></span> restart with\ 0:09.52               <span class="hljs-string"><span class="hljs-string">"/opt/local/bin/gmake -f client.mk build"</span></span> 0:09.52 /comm-central/client.mk:361:      ¬´configure¬ª 0:09.52 gmake[1]: *** [configure]  1</code> </pre> <br><p>  Solution (for OS X): </p><br><pre> <code class="hljs sql">brew <span class="hljs-keyword"><span class="hljs-keyword">install</span></span> yasm &amp;&amp; ./mozilla/mach <span class="hljs-keyword"><span class="hljs-keyword">build</span></span></code> </pre> <br><p>  Information on possible build issues can be found in the <a href="">client.mk</a> file.  Be prepared for the fact that the source code of the project and the assembly will occupy 8.3 GB of disk space! </p><br><p>  Launch of the project: </p><br><p>  In the configuration, we specified the key - <code>--enable-debug</code> , it will help us to see all debugging information, including outgoing requests to third-party services. </p><br><pre> <code class="hljs">./mozilla/mach run</code> </pre> <br><p>  The <code>run</code> command will automatically find the path to the application and launch it.  In our case, after building the application is located in the following way: </p><br><pre> <code class="hljs">./obj-x86_64-apple-darwin15.0.0/dist/DailyDebug.app/Contents/MacOS/thunderbird</code> </pre> <br><p>  Automated Testing: </p><br><p>  To automate testing, Thunderbird uses the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Thunderbird_MozMill_Testing">MozMill</a> framework and <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_bindings/XPConnect/xpcshell/Reference">XPCShell</a> .  We run unit tests: </p><br><pre> <code class="hljs cmake">./mozilla/mach xpcshell-<span class="hljs-keyword"><span class="hljs-keyword">test</span></span></code> </pre> <br><p>  For more information on unit testing, see the links below: </p><br><ol><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_bindings/XPConnect/xpcshell/Reference">XPCShell manual</a> . </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/MailNews_xpcishell-tests">Instructions for running XPCShell tests in MailNews</a> . </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/MailNews/AsyncTestUtils_Extended_Framework">Information about the AsyncTestUtils testing framework</a> . </li></ol><br><p>  We run integration tests: </p><br><pre> <code class="hljs go">./build/pymake/<span class="hljs-built_in"><span class="hljs-built_in">make</span></span>.py mozmill</code> </pre> <br><p>  For integration testing, the <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Thunderbird_MozMill_Testing">MozMill</a> framework is <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Thunderbird_MozMill_Testing">used</a> . </p><br><p>  After the local run, the tests run the revision, and it also checks the declared functionality.  As soon as the release engineer includes your patch in the release in the <a href="https://treeherder.mozilla.org/">Treeherder CI</a> , the regression testing cycle will <a href="https://treeherder.mozilla.org/">start</a> .  For more information about other types (for example, <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/MailNews/Leak_And_Bloat_Tests">testing for memory leaks</a> ) testing, see this <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Thunderbird_Automated_Testing">link</a> . </p><br><p>  A guide to Treeherder CI is <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Firefox_OS/Automated_testing/Treeherder">here</a> . </p><br><h2>  2.6.  Testing functionality in early releases </h2><br><p>  As soon as the release engineer includes your patch in the early release, you can begin the next stage of testing.  According to the work process, an early release called Aurora is going to be the first, then Beta and release.  Links to download early releases are <a href="https://www.mozilla.org/en-US/thunderbird/channel/">here</a> .  <a href="https://calendar.google.com/calendar/embed%3Fsrc%3DbW96aWxsYS5jb21fZGJxODRhbnI5aTh0Y25taGFiYXRzdHY1Y29AZ3JvdXAuY2FsZW5kYXIuZ29vZ2xlLmNvbQ">The calendar</a> will help not to miss an important release date for you. </p><br><p>  The general scheme of the stages of release is as follows: </p><br><img src="https://habrastorage.org/files/5af/7fb/2f2/5af7fb2f280b4938ab3d2be1dab05de4.jpg"><br><p>  The release cycle of each stage takes six weeks. </p><br><h2>  2.7.  Backward compatibility </h2><br><p>  For customers who have not yet updated to the 45th release, the standard authorization scheme should work.  And if you don‚Äôt think about it in advance, the user will always see an authorization error (unless manually changing the authorization method): <br><br></p><br><img src="https://habrastorage.org/files/638/066/54f/63806654f5194371ae25e5563443e472.png"><br><p><br></p><br><p>  In order to maintain backward compatibility, we began to give the <a href="">configuration file</a> , focusing on the User-Agent: </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">location</span></span> /mail/config-v1.<span class="hljs-number"><span class="hljs-number">1</span></span>.xml { <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (<span class="hljs-variable"><span class="hljs-variable">$http_user_agent</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ Thunderbird/(\d|[1-3]\d|4[0-4])\.)</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span> config-v1\.<span class="hljs-number"><span class="hljs-number">1</span></span>\.xml /mail/original.config-v1.<span class="hljs-number"><span class="hljs-number">1</span></span>.xml; } }</code> </pre> <br><p>  We set the title <a href="https://varvy.com/mobile/vary-user-agent.html">Vary: User-Agent</a> </p><br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">add_header</span></span> Vary User-Agent;</code> </pre> <br><p>  Now users of old clients will receive a configuration file without OAuth.  Checking: </p><br><pre> <code class="bash hljs">‚ûú curl <span class="hljs-string"><span class="hljs-string">'https://autoconfig.mail.ru/mail/config-v1.1.xml'</span></span> -H <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:38.0) Gecko/20100101 Thunderbird/38.3.0 Lightning/4.0.5.2'</span></span> 2&gt;/dev/null | fgrep -i oauth</code> </pre> <br><pre> <code class="bash hljs">‚ûú curl <span class="hljs-string"><span class="hljs-string">'https://autoconfig.mail.ru/mail/config-v1.1.xml'</span></span> -H <span class="hljs-string"><span class="hljs-string">'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:38.0) Gecko/20100101 Thunderbird/45.0.0 Lightning/4.0.5.2'</span></span> 2&gt;/dev/null | fgrep -i oauth &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;OAuth2&lt;/authentication&gt; &lt;authentication&gt;OAuth2&lt;/authentication&gt;</code> </pre> <br><h2>  2.8.  Release Testing </h2><br><p>  Now that a few long months are over, you can download the release from the <a href="https://www.mozilla.org/en-US/thunderbird/">main page</a> !  Further we will show what the user will eventually see. <br><br></p><br><h1>  3. Usage scenario </h1><br><p>  There are several ways to add an email account to Thunderbird, but they all boil down to the same actions, so consider the most obvious: </p><br><p>  1. Open the start page.  In the section for creating a new email account, select <code>Email</code> : </p><br><img src="https://habrastorage.org/files/73c/9a3/d7f/73c9a3d7fa014a15ac671d456ba2524e.png"><br><p><br>  2. We skip this step, since we already have a mail account: </p><br><img src="https://habrastorage.org/files/e26/a13/878/e26a1387877143fa93d37b8010076323.png"><br><p><br>  3. Add a mailing address and click the button "Continue": </p><br><img src="https://habrastorage.org/files/325/9b4/079/3259b40799f64910a0552a53c2d8b3f7.png"><br><p><br>  4. Select the mail collection protocol ( <code>IMAP</code> ) and click the ‚ÄúFinish‚Äù button: </p><br><img src="https://habrastorage.org/files/3a1/cc9/d4a/3a1cc9d4a06c488c9cfa445445fb6d1d.png"><br><p><br>  5. At this step, we check the settings of the mail server and, if everything is in order, click the ‚ÄúFinish‚Äù button: </p><br><img src="https://habrastorage.org/files/984/a71/bba/984a71bba8544ad48277b6f69e9cc51e.png"><br><p><br>  6. Enter the authorization data from your Mail.Ru account: </p><br><img src="https://habrastorage.org/files/ab7/1c5/0f6/ab71c50f67bf4b32b8939ff34f2f6b03.png"><br><p><br>  7. We agree that Thunderbird will collect mail from our account: </p><br><img src="https://habrastorage.org/files/185/a92/ad7/185a92ad7cb04995ae6854eccf60ab06.png"><br><p><br>  8. We are waiting for the letters to be downloaded: </p><br><img src="https://habrastorage.org/files/40a/43c/aaf/40a43caafb2349799c5142262e618d62.png"><br><p><br></p><br><h1>  4. Conclusion </h1><br><p>  As you see, we are trying to develop not only our <a href="https://opensource.mail.ru/">opensource projects</a> , but also third-party ones.  We are extremely sensitive about security issues, so we decided to join the development of Mozilla Thunderbird and help with the implementation of OAuth 2.0.  We hope our post will inspire someone to make their first pull request, and the world opensource article a little better. </p><br><h1>  5. Thanks </h1><br><ul><li>  <a href="https://twitter.com/rkentjames">Kent James</a> - for the code review and the inclusion of our patch in the early release. </li><li>  <a href="https://twitter.com/asutherland">Andrew Sutherland</a> for helping with ISP. </li></ul><br><h1>  6. Information links </h1><br><ul><li>  <a href="https://habrahabr.ru/company/mailru/blog/264049/">How mail.Ru implements mail collection using OAuth 2.0</a> </li><li>  <a href="https://habrahabr.ru/company/mailru/blog/115163/">OAuth 2.0 is simple and straightforward.</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Thunderbird_Automated_Testing">Thunderbird Automated Tests Intro</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Tech/XPCOM/Language_bindings/XPConnect/xpcshell/Reference">XPCShell manual</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/MailNews_xpcishell-tests">Instructions for running XPCShell tests in MailNews</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/MailNews/Leak_And_Bloat_Tests">Testing Memory Leaks in MailNews</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Projects/MailNews/AsyncTestUtils_Extended_Framework">Information about the AsyncTestUtils testing framework</a> </li><li>  <a href="http://hg.mozilla.org/comm-central">Comm-central repository</a> </li><li>  <a href="https://svn.mozilla.org/mozillamessaging.com/sites/autoconfig.mozillamessaging.com/">ISP repository</a> </li><li>  <a href="https://ftp.mozilla.org/pub/thunderbird/">FTP server Thunderbird</a> </li><li>  <a href="https://treeherder.mozilla.org/">Treeherder ci</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Firefox_OS/Automated_testing/Treeherder">Treeherder CI Guide</a> </li><li>  <a href="https://www.mozilla.org/en-US/thunderbird/">Thunderbird client home page</a> </li><li>  <a href="https://www.mozilla.org/en-US/thunderbird/releases/">Thunderbird's full release list</a> </li><li>  <a href="https://www.mozilla.org/en-US/thunderbird/channel/">Thunderbird Early Releases</a> </li><li>  <a href="https://bugzilla.mozilla.org/">Bugzilla bugtracker</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Thunderbird_API_documentation">Thunderbird api</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Developer_guide/Build_Instructions/Simple_Thunderbird_build">Thunderbird build guide</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird">Thunderbird Documentation</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/comm-central">Comm-central repository documentation</a> </li><li>  <a href="https://wiki.mozilla.org/Thunderbird/CommunicationChannels">Thunderbird Developer Communication Channels</a> </li><li>  <a href="https://developer.mozilla.org/en-US/docs/Mozilla/Thunderbird/Mailnews_and_Mail_code_review_requirements">Requirements for the style of writing code</a> </li><li>  <a href="https://wiki.mozilla.org/RapidRelease">Mozilla Release Management Information</a> </li><li>  <a href="https://calendar.google.com/calendar/embed%3Fsrc%3DbW96aWxsYS5jb21fZGJxODRhbnI5aTh0Y25taGFiYXRzdHY1Y29AZ3JvdXAuY2FsZW5kYXIuZ29vZ2xlLmNvbQ">Mozilla Event Calendar</a> </li></ul></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/282319/">https://habr.com/ru/post/282319/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../282301/index.html">C / C ++: how to measure CPU time</a></li>
<li><a href="../282305/index.html">Optimizing the Nested Set model in PHPixie</a></li>
<li><a href="../282311/index.html">Organization of functional requirements for a large project</a></li>
<li><a href="../282313/index.html">Magic, broken calculator or just a "divorce"?</a></li>
<li><a href="../282317/index.html">Review of the review of the minuses of Bitrix, or the dude reads only the first 5 pages</a></li>
<li><a href="../282321/index.html">Machine Learning Competitions (Spring-Summer 2016)</a></li>
<li><a href="../282325/index.html">The digest of interesting materials from the world of web development and IT for the last week ‚Ññ208 (April 18 - 24, 2016)</a></li>
<li><a href="../282327/index.html">Mathematical model of perception (Part 2)</a></li>
<li><a href="../282331/index.html">PHP Digest number 84 - interesting news, materials and tools (April 10 - 24, 2016)</a></li>
<li><a href="../282333/index.html">Confessions of Bitrix Hayter</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>