<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Implementing multi-level undo / redo functionality using the example of a spreadsheet prototype</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Introduction 
 The Undo and Redo buttons, which allow you to undo and redo any user actions, as well as view a list of all actions performed, are the ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Implementing multi-level undo / redo functionality using the example of a spreadsheet prototype</h1><div class="post__text post__text-html js-mediator-article"><h4>  Introduction </h4><br>  The Undo and Redo buttons, which allow you to undo and redo any user actions, as well as view a list of all actions performed, are the de facto standard for such applications as word processors and development environments, graphics editors and CAD systems editing and editing sound and video.  They are so familiar to the user that the latter perceives their presence as a given, just one functionality along with dozens of others.  But from the developer's point of view, the requirement for the presence of undo is one of the factors affecting the entire project architecture, defined at the earliest stages of the development project. <br><br><img src="https://habrastorage.org/files/8d5/02f/e6e/8d502fe6e66a4db1bc9ce55015b2def9.png" alt="Undo functions in LibreOffice and GIMP applications" width="400"><br><br>  In open sources there is quite a bit of information about how to practically implement undo / redo functionality.  The classic book of E. Gamma et al. <a href="http://www.ozon.ru/context/detail/id/2457392/">‚ÄúObject-oriented programming techniques.</a>  <a href="http://www.ozon.ru/context/detail/id/2457392/">Design Patterns ‚Äù</a> briefly mentions the suitability of the‚Äú team ‚Äùpattern for this purpose, there is a lot of general information on this topic on the Internet, but we could not find a sufficiently complete, well-developed example of implementation.  In our article we will try to fill this gap and, based on the experience of the author, to demonstrate a detailed example of the architecture of an application supporting undo / redo, which can be taken as a basis for other projects. <br><a name="habracut"></a><br>  The code examples in the article are in Java, but there is nothing Java-specific in them and all the ideas presented here are suitable for any object-oriented language (the author himself first implemented them in Delphi). 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      It should be noted that for various needs and types of applications there are different ‚Äúundo models‚Äù: linear - with the cancellation of operations strictly in reverse order, and nonlinear - with the cancellation of arbitrary operations from the history of the actions performed.  We will talk about the implementation of <i>linear Undo in a system with synchronized modifications of the data model</i> , that is, one in which the simultaneous modification of the internal state of the data model in different execution threads is not allowed.  The classification of possible undo models is given, for example, <a href="https://en.wikipedia.org/wiki/Undo">in a Wikipedia article</a> . <br><br>  We naturally assume that the application implements the separation of the data model (Model) from the view (View), and <i>the undo functionality is implemented at the data model level</i> , in the form of the <b>undo ()</b> and <b>redo ()</b> methods of one of its classes. <br><br><h4>  Illustrative example </h4><br>  As an illustrative example, the article discusses the data model of an application that prototypes a spreadsheet (in the style of MS Excel / LibreOffice Calc).  There is a sheet (for simplicity - only one), consisting of cells, the values ‚Äã‚Äãand dimensions of which can be changed, rows and columns - interchanged, and all these actions, respectively, are cancelable.  Source codes and related unit tests are available at <a href="https://github.com/inponomarev/undoredo">https://github.com/inponomarev/undoredo</a> and can be compiled and executed using Maven. <br><br>  The main entities in our example are: <br><br><ol><li>  worksheet - <b>Worksheet</b> class, </li><li>  rows and columns - <b>Row</b> and <b>Column</b> classes (inherited from the <b>AxisElement</b> class), </li><li>  cells - class <b>Cell</b> . </li></ol><br>  The resulting simple data model is presented in the class diagram in the figure below: <br><br><img src="https://habrastorage.org/files/6f7/7a9/e5e/6f77a9e5ef844e96b16f3aa3010205b9.png" alt="Data Model Classes for Illustrative Example" width="600"><br><br>  Without going into details of the implementation of spreadsheets, we note briefly the basic principles of the source code.  Although the spreadsheet sheet is presented to the user as a two-dimensional data array, the boundaries of which go far beyond the screen, the use of a two-dimensional array for the data model is not justified either in terms of memory consumption, or in terms of performance of typical operations.  For example, if in early versions of MS Excel, 65,536 columns and rows were allowed to exist, then memory allocation for 65536 <sup>2</sup> , i.e. 4 billion cells, would be simply technically impossible in a 32-bit system. <br><br>  The solution is to use tree-based dictionaries and hash tables to store only the changed values, substituting some default value instead of the value missing in the dictionary. <br><br>  To store instances of <b>Row</b> and <b>Column</b> , the <b>TreeMap &lt;Integer, Row&gt; rows</b> and <b>TreeMap &lt;Integer, Column&gt; columns</b> dictionaries are used in the <b>Worksheet</b> class.  To store <b>Cell</b> instances, use the <b>HashMap &lt;Column, Cell&gt; cells</b> dictionary in the <b>Row</b> class.  The values ‚Äã‚Äãof this hash table are references to <b>Cell</b> objects, and the keys are column objects.  This approach to data storage allows you to find the optimal balance between speed and the amount of used memory for all practically necessary operations on the contents of the <b>Worksheet</b> . <br><br><h4>  Model root class and undone methods </h4><br>  The <b>Worksheet</b> class in our example is central: 1) working with all other business logic objects begins with obtaining an instance of this particular class, 2) instances of other classes can work only in the context of the <b>Worksheet</b> object, 3) through the <b>save (...)</b> method and It saves the static <b>load (...)</b> method to the stream and restores the state of the entire system from the stream.  This class we will call the <i>root class of the model</i> .  As a rule, when developing applications in the Model-View-Controller architecture, there is no difficulty in determining what is the root class of the model.  It is he who is supplied with methods specific to the functionality of Undo / Redo. <br><br>  Also, it should not be difficult to determine the <i>methods that change the state of the model</i> .  These are the methods whose call result must be undone.  In our example, the following: <br><br><ul><li>  <b>setCellValue (int row, int col, String value)</b> - sets the cell value (for the sake of simplicity, we assume that cells can take only string values!), </li><li>  <b>insertValues ‚Äã‚Äã(int top, int left, String [] [] value)</b> - inserts into the cells the values ‚Äã‚Äãof a two-dimensional array (for example, obtained from the clipboard), </li><li>  <b>setRowHeight (int row, int height)</b> , <b>setColWidth (int col, int width)</b> - set the row height and column width, </li><li>  <b>insertColumnLeft (int colNum)</b> , <b>insertRowAbove (int rowNum)</b> - insert columns and rows, </li><li>  <b>deleteColumn (int colNum)</b> , <b>deleteRow (int rowNum)</b> - delete columns and rows, </li><li>  <b>moveColumn (int from, int to)</b> , <b>moveRow (int from, int to)</b> - move the columns and rows along with the contents, replacing the contents of the final column / row. </li></ul><br>  In a real application, of course, they can be much more.  Each of them is required to compare the corresponding command class (which will be discussed further), and the methods must be rewritten in a special way. <br><br><h4>  Undo and redo stacks </h4><br>  In the Undo linear model, operations are canceled in such a way as to preserve the sequence of actions performed on the document.  For example, if a column was first added to the document, and then its width was changed, then the cancellation of these operations is possible only in the reverse order, and the return - in the forward.  Therefore, to store operations subject to cancellation and restoration, it is natural to use two stacks on linked lists, which are part of the root class of the model.  When calling a method that changes the state of the model, the Redo stack is cleared, and the Undo stack is replenished with the next value.  Executing the Undo command should fetch the value from the Undo stack and transfer it to the Redo stack.  Running the Redo command, if it happens, should return the value to the Undo stack again (see the figure). <br><br><img src="https://habrastorage.org/files/a16/222/845/a162228459204192ad71e55f1af16611.png" alt="Undo and redo stacks" width="800"><br><br>  The contents of these stacks are objects inherited from the <b>Command</b> class, which will be discussed later.  Here is a list of public root-class business logic methods giving access to the Undo / Redo functionality: <br><br><ul><li>  <b>undo ()</b> - canceling an action performed by calling any method that changes the state of the model, and transferring it to the Redo stack: <br><br><pre><code class="java hljs">Command cmd = undoStack.pop(); cmd.undo(); redoStack.push(cmd);</code> </pre> <br>  Each callback rolls back the changes in the chain until the Undo stack is exhausted. After the stack is exhausted, the method is not called again. <br></li><li>  <b>redo ()</b> - returns the action canceled by the call to undo, and putting it back on the undo stack.  The repeated call rolls operations canceled by Undo until the Redo stack is exhausted, after which the redo () call is ignored.  The entire Redo stack is reset after calling any method that changes the state of the model. </li><li>  <b>getUndoStack ()</b> , <b>getRedoStack ()</b> - return entire stacks so that the user can create a list of operations available for undo or redo. </li><li>  <b>isUndoActive ()</b> , <b>setUndoActive (boolean value)</b> - allows you to deactivate the Undo mechanism (activated by default).  It is necessary to 1) improve performance and reduce memory consumption when making very large changes in the state of a document 2) working with a document from external applications via interfaces in which the Undo / Redo functionality is not available. </li></ul><br><h4>  Team Pattern </h4><br>  Methods that change the state of a model may have different parameters and generally be defined in different classes of the model.  Fully encapsulate information about the parameters and the target object of the method, ‚Äúcombing one size fits all‚Äù, allows the design pattern ‚Äúcommand‚Äù.  The nontriviality of this pattern is that usually <i>entities</i> in object-oriented code describe some <i>entities</i> .  Here, the class does not describe the entity, but the <i>action</i> performed by the method changing the state of the model, ‚Äútaking away‚Äù this prerogative from the method itself. <br><br>  The class of each command is inherited from the base abstract class <b>Command</b> .  By itself, the <b>Command</b> has only three abstract methods: <b>execute</b> , <b>undo</b> and <b>getDescription</b> , which do not have (what is important!) No parameters.  This allows you to execute and cancel commands with the <b>undo ()</b> and <b>redo ()</b> methods of the root class, ‚Äúknowing nothing‚Äù about those operations that are performed or canceled.  The <b>getDescription ()</b> method should return a text description of the action: this description will be available to the user in the list of canceled actions. <br><br><img src="https://habrastorage.org/files/308/76f/53e/30876f53ee2249788256a9f9e8be11bd.png" alt="Command class and its heirs" width="400"><br><br>  The heirs of the <b>Command</b> class, in addition to the implementation of its abstract methods, can contain as many additional fields as possible containing information about the command launch parameters and information necessary to cancel an already executed command and display a text description of the executed command.  In this case, the <b>execute ()</b> method must contain the code that is usually contained in the method that changes the state of the model, but instead of the method parameters, this code should use the fields of the command class.  Note that the team operates on the internal state of the model object just as it used to do its own method.  Therefore, the team must have access to the hidden fields of the model object.  In the Java language, this is convenient to achieve if you make the successor class <b>Command</b> nested in the corresponding model class.  In our application, for example, the <b>SetSize</b> command <b>is</b> nested in the <b>AxisElement</b> model <b>class</b> , the rest of the commands are nested in the <b>Worksheet</b> . <br><br>  The <b>undo ()</b> method, in turn, should be able to undo the consequences of calling the <b>execute ()</b> method.  All necessary information for this should be stored in the fields of the team class.  The matter is simplified if we understand that at the time of calling the <b>undo ()</b> method, the state of business logic objects will always be identical to what it was immediately after the execution of the corresponding <b>execute ()</b> method.  If the user has performed other operations since then, then before he gets to the <b>undo () of the</b> current command, he will have to execute <b>undo ()</b> for all commands that have been called after her.  In practice, the understanding of this principle greatly facilitates the writing of the <b>undo ()</b> method and reduces the amount of information stored in the command. <br><br>  Consider the implementation of the command setting the value of the cell: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">SetCellValue</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> row; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> col; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> String val; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">SetCellValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> col, String newValue)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.row = row; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.col = col; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.val = newValue; } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> (<span class="hljs-string"><span class="hljs-string">" "</span></span>); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">private</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">changeVal</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ String oldValue = getCellValue(row, col); Row r = rows.get(row); Column c = columns.get(col); <span class="hljs-comment"><span class="hljs-comment">//....   cell  row  col... cell.setValue(val); //.... val = oldValue; } @Override public void execute() { changeVal(); } @Override public void undo() { changeVal(); } }</span></span></code> </pre><br>  As we see, there are variables in the class for storing the cell address and its value.  And in order to save memory, you can do only one variable to save the value: new if the <b>execute ()</b> method has not yet been executed, or old if the <b>execute ()</b> method has already been completed.  That is, the fact that the <b>execute ()</b> and <b>undo ()</b> methods are executed in turn is used here.  The <b>getDescription ()</b> method can use class variables to make the command description more detailed. <br><br><h4>  Cancel Method Template </h4><br>  How are commands used in abolished methods?  If usually such methods, taking into account their parameters, simply perform some actions on the model, then in a system with undo all of them strictly must perform the following three operations: <br><br><ol><li>  create an instance of the corresponding command (heir class <b>Command</b> ), </li><li>  initialize the command fields with method parameters and possibly additional information </li><li>  execute the <b>execute (Command cmd)</b> method of the root object, passing the newly created and initialized command as a parameter. </li></ol><br>  In our example, the implementation of the <b>setCellValue</b> method looks like this: <br><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">setCellValue</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> row, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> col, String value)</span></span></span><span class="hljs-function"> </span></span>{ Command cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> SetCellValue(row, col, value); execute(cmd); }</code> </pre><br>  Approximately all other canceled methods look the same. <br><br>  The root class's <b>execute (Command cmd)</b> method performs the command action, clears the redo stack, and puts the command on the undo stack: <br><br><pre> <code class="java hljs"> undoStack.push(cmd); redoStack.clear(); cmd.execute();</code> </pre><br>  From this point on, the team becomes part of a chain of undo / redo actions.  As mentioned above, calling the <b>undo ()</b> method in the root class calls the <b>undo ()</b> method of the command at the top of the Undo stack and transfers it to the Redo stack.  Calling the root class's <b>redo ()</b> method, in turn, executes the <b>execute ()</b> method of the command at the top of the Redo stack and transfers it to the Undo stack. <br><br><h5>  Command Class Reuse </h5><br>  So, for tasks that normally require writing one method, systems with undo need to create a whole class, which leads to fair concerns about the amount of code and the complexity of its support: in real projects, the number of canceled methods is in the tens. <br><br>  In fact, there can be significantly less command-classes due to their universalization and the use of one command-class for several methods being abolished.  For example, the main code of the <b>SetCellValue</b> class, in fact, can be used for any methods in which you want to change one value of a variable.  You can make the command class more universal both by adding additional fields and by parametrizing the class. <br><br>  For example, consider the universal delete command, which is used to delete both rows and columns in a table: <br><br><pre> <code class="java hljs"> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Delete</span></span></span><span class="hljs-class">&lt;</span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">T</span></span></span><span class="hljs-class"> </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">AxisElement</span></span></span><span class="hljs-class">&gt; </span><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">extends</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Command</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> T deleted; <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> TreeMap&lt;Integer, T&gt; map; Delete(TreeMap&lt;Integer, T&gt; map, <span class="hljs-keyword"><span class="hljs-keyword">int</span></span> num) { <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.num = num; <span class="hljs-keyword"><span class="hljs-keyword">this</span></span>.map = map; deleted = map.get(num); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> String </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getDescription</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> String.format(<span class="hljs-string"><span class="hljs-string">" %s %d"</span></span>, map == columns ? <span class="hljs-string"><span class="hljs-string">""</span></span> : <span class="hljs-string"><span class="hljs-string">""</span></span>, num); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">execute</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ internalDelete(map, num); } <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">undo</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ internalInsert(map, num); map.put(num, deleted); } } <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">static</span></span> &lt;T extends AxisElement&gt; <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">internalDelete</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(TreeMap&lt;Integer, T&gt; map, </span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> num)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-comment"><span class="hljs-comment">//... //      num //      &gt; num     //... } private static &lt;T extends AxisElement&gt; void internalInsert(TreeMap&lt;Integer, T&gt; map, int num) { //... //     &gt;= num     //... } }</span></span></code> </pre><br>  Its use in the <b>deleteColumn</b> and <b>deleteRow</b> methods is as follows: <br><br><pre> <code class="java hljs"> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteColumn</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> colNum)</span></span></span><span class="hljs-function"> </span></span>{ Command cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Delete&lt;Column&gt;(columns, colNum); execute(cmd); } <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">deleteRow</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(</span></span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-params"><span class="hljs-keyword">int</span></span></span></span><span class="hljs-function"><span class="hljs-params"> rowNum)</span></span></span><span class="hljs-function"> </span></span>{ Command cmd = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Delete&lt;Row&gt;(rows, rowNum); execute(cmd); }</code> </pre><br><h4>  Macros </h4><br>  Sometimes it may turn out that a call to a state-changing method is too small a unit to be stored in the Undo stack.  Consider the procedure <b>insertValues ‚Äã‚Äã(int top, int left, String [] [] value)</b> inserting values ‚Äã‚Äãfrom a two-dimensional list (for example, from the clipboard) into a document.  This procedure, in a loop, one after another, updates the cells of the document with the values ‚Äã‚Äãof the cells from the buffer.  Thus, if we insert a piece of a 4 √ó 4 table, then, from the point of view of the Undo mechanism, we make 16 changes to the cells of the document.  This means that if the user wants to undo the result of the insertion, then he will have to press the Undo button 16 times, while in the table one after the other 16 cells will restore their previous values. <br><br>  Of course, this is wrong: the results of operations like this should be canceled and restored as a whole, and displayed in the list of canceled operations in one line.  In order to make this possible, macros are applied. <br><br>  The idea of ‚Äã‚Äãimplementing a macro is simple: it is just a special inheritor of the class <b>Command</b> , containing within itself a chain of other commands, as shown in fig .: <br><br><img src="https://habrastorage.org/files/769/02e/434/76902e434f854705a5b5fb8e0ea5e026.png" alt="Stack Undo with Macro" width="450"><br><br>  The <b>execute ()</b> method of the <b>MacroCommand</b> class runs through its own list of commands and executes their <b>execute ()</b> methods.  When calling the <b>undo ()</b> method of the same macro, it runs through the same list of commands in the reverse order and calls their <b>undo ()</b> methods. <br><br>  Macro methods like the clipboard paste method in applications built in the Model / View / Controller architecture, as a rule, are not part of the model, but are implemented at the controller level.  Often they represent only the automation of some routine work, the need for which, depending on the type of user interface, may or may not exist.  In addition, it often becomes necessary to group several user actions into one: for example, text editors group the user into entering a single macro-action, instead of littering the undo-stack with entries about entering each individual letter. <br><br>  Therefore, support for macros can and should be implemented at an abstract level, independent of the application.  This is done by adding the public methods <b>beginMacro (String description)</b> and <b>endMacro ()</b> to the root class of the model.  Methods are invoked before and after macro actions.  Calling <b>beginMacro (...)</b> with a string parameter, the value of which will then be available to the user in the list of canceled operations, we generate an object of type <b>MacroCommand</b> and temporarily replace the Undo-stack with an internal macro stack.  Thus, after a call to beginMacro, any subsequent transfer of a command to the <b>execute (...)</b> method of the root class results in its writing not directly to the Undo stack, but to the internal stack of the current macro command (which, in turn, is written to the Undo stack ).  The call to <b>endMacro ()</b> returns everything to its place.  Multilevel attachment of macros into each other is also allowed. <br><br><h4>  Tracking Unsaved Changes </h4><br>  The presence of undo functionality provides a reliable way to track unsaved changes to a document.  This is necessary to implement the correct behavior of the Save button in the application: <br><br><ol><li>  the ‚ÄúSave‚Äù button should be active if and only if unsaved changes are present (otherwise there is no need to save: the document has not been changed), </li><li>  when closing a document, it makes sense to ask the user whether he wants to save the changes, only if unsaved changes are present. </li></ol><br>  In our example, the presence of unsaved changes is returned by the <b>isModified ()</b> method.  It is implemented as follows: with each call to the <b>save (...)</b> method, the current top of the Undo stack is stored in the <b>lastSavedPoint</b> variable.  When the <b>isModified</b> method is <b>called, the</b> current top of the Undo stack is compared with the <b>lastSavedPoint</b> value: if they are equal, there are no unsaved changes.  When the undo mechanism is deactivated, the <b>isModified ()</b> method always returns <b>true</b> . <br><br><h4>  Conclusion </h4><br>  We looked at the basic principles of implementing linear multilevel Undo / Redo with an example that, in our opinion, is universal enough to serve as a template for other projects. <br><br>  It is not surprising that the functionality of undo and redo makes quite serious demands on the application architecture and the professionalism of the developers.  But such things as strict adherence to the Model / View / Controller architecture and a well-thought-out model (writing each of the methods that change the state of the model in a system with undo ‚Äúcosts more‚Äù), despite some labor intensity, pays off with the high quality and reliability of the program being created which ultimately will result in the satisfaction of its users. <br><br>  * * * <br><br>  The complete source codes and the corresponding unit tests of the example discussed in the article are available at <a href="https://github.com/inponomarev/undoredo">https://github.com/inponomarev/undoredo</a> and can be compiled and executed using Maven. </div><p>Source: <a href="https://habr.com/ru/post/277245/">https://habr.com/ru/post/277245/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../277235/index.html">Preparing ASP.NET Core: how to present static content as resources</a></li>
<li><a href="../277237/index.html">How do we decide what to do?</a></li>
<li><a href="../277239/index.html">How not to recover data, or so lucky for you too</a></li>
<li><a href="../277241/index.html">Pattern recognition. Beginning theory</a></li>
<li><a href="../277243/index.html">Useful links for warranty verification</a></li>
<li><a href="../277247/index.html">Registration for NeoQUEST-2016 is open</a></li>
<li><a href="../277249/index.html">How to turn your old mobile phone into a home security system</a></li>
<li><a href="../277251/index.html">ARP: Cisco equipment features and interesting cases. Part 2</a></li>
<li><a href="../277253/index.html">How to create an animated flask using CSS</a></li>
<li><a href="../277255/index.html">What's wrong with javascript in a big project? What problems did we face and how did we solve them</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>