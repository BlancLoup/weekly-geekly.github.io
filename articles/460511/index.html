<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>PHP-FPM setup: use pm static for maximum performance</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="An unedited version of the article was originally published on haydenjames.io and published here with the permission of its author . 


 I will briefl...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>PHP-FPM setup: use pm static for maximum performance</h1><div class="post__text post__text-html js-mediator-article"><p><img src="https://habrastorage.org/webt/-2/iz/ag/-2izagcq0hhqolvsxmnbt63lwb8.png"></p><br><p>  <em>An unedited version of the article was originally published on <a href="https://haydenjames.io/php-fpm-tuning-using-pm-static-max-performance/">haydenjames.io</a> and published here with the permission of its <a href="https://haydenjames.io/">author</a> .</em> </p><br><p>  I will briefly tell you how best to configure PHP-FPM to increase throughput, reduce latency, and more consistently use processor resources and memory.  The default PM string (process manager, process manager) in PHP-FPM is <em>dynamic</em> , and if you do not have enough memory, it is better to install <em>ondemand</em> .  Let's compare 2 management options based on php.net documentation and see how my favorite <em>static</em> pm differs from them for a large amount of traffic: </p><br><p>  <strong>pm = dynamic</strong> - the number of child processes is configured dynamically based on the following directives: <em>pm.max_children, pm.start_servers, pm.min_spare_servers, pm.max_spare_servers</em> . <br>  <strong>pm = ondemand</strong> - processes are created on demand (as opposed to dynamic creation, when pm.start_servers are started when the service is started). <br>  <strong>pm = static</strong> - the number of child processes is fixed and specified by the <em>pm.max_children</em> parameter. </p><a name="habracut"></a><br><p>  See the <a href="http://php.net/manual/en/install.fpm.configuration.php">full list of global php-fpm.conf directives for details</a> . </p><br><h3 id="shodstva-menedzhera-processa-php-fpm-s-regulyatorom-chastoty-processora">  PHP-FPM Process Manager Similarities with a CPU Frequency Controller </h3><br><p>  This may seem offtopic, but I'm going to link this to the topic of PHP-FPM customization.  Who has not slowed down the processor at least once - on a laptop, virtual machine or a dedicated server.  Remember the CPU frequency scaling?  These options, available for <em>nix and Windows, can improve system performance and speed of response if you change the processor regulator parameter from</em> ondemand <em>to</em> performance *.  This time, let's compare the descriptions and look at the similarities: </p><br><p>  <strong>Governor = ondemand</strong> - dynamic scaling of the processor frequency depending on the current load.  Sharply switches to maximum frequency, and then reduces it when idle periods increase. <br>  <strong>Governor = conservative =</strong> dynamic frequency scaling depending on the current load.  Increases and decreases the frequency smoother than ondemand. <br>  <strong>Governor = performance</strong> - the frequency is always the maximum. </p><br><p>  For details, see the <a href="https://www.kernel.org/doc/Documentation/cpu-freq/governors.txt">complete list of CPU frequency control parameters</a> . </p><br><p>  See the similarities?  I wanted to show this comparison to convince you that it is best to use <em>pm static</em> for PHP-FPM. </p><br><p>  For a processor controller, the <em>performance</em> parameter helps to safely increase performance, because it depends almost entirely on the server's processor limit.  In addition, of course, there are still factors such as temperature, battery charge (in a laptop) and other side effects of a permanent processor operation of 100%.  Performance tuning provides the fastest processor performance.  Read, for example, about <a href="https://haydenjames.io/raspberry-pi-3-overclock/">the force_turbo parameter in the Raspberry Pi</a> , with which the RPi panel will use the <em>performance</em> controller, where <em>performance</em> improvements will be more noticeable due to the low CPU clock frequency. </p><br><h3 id="ispolzovanie-pm-static-dlya-dostizheniya-maksimalnoy-proizvoditelnosti-servera">  Use pm static for maximum server performance </h3><br><p>  The PHP-FPM <em>pm static</em> parameter is largely dependent on the free memory on the server.  If there is little memory, it is better to choose <em>ondemand</em> or <em>dynamic</em> .  On the other hand, if you have memory, you can avoid the extra costs of the PHP process manager by setting pm <em>static</em> to the maximum server capacity.  In other words, if everything is well calculated, you need to set <em>pm.static</em> to the maximum amount of PHP-FPM processes that can be executed <em>without creating problems with insufficient memory or cache.</em>  <em>But not so high to overload the processors and accumulate a bunch of PHP-FPM operations that are waiting to be completed</em> . </p><br><p> <a href=""><img src="https://habrastorage.org/webt/ku/aw/nx/kuawnxjy5mun0bzouv2kh-virsu.png"></a> </p><br><p>  In the screenshot above, the server is set to <em>pm = static and pm.max_children = 100</em> , and it takes about 10 GB out of the available 32. Pay attention to the highlighted columns, here and so everything is clear.  This screenshot was about 200 active users (over 60 seconds) in Google Analytics.  At this level, approximately 70% of the PHP-FPM child processes are still inactive.  This means that PHP-FPM is always set to the maximum amount of server resources, regardless of current traffic.  The idle process waits for traffic peaks and responds instantly.  You do not have to wait for <em>pm to</em> create child processes, and then complete them when the <em>pm.process_idle_timeout</em> period <em>expires</em> .  I set a very great value for <em>pm.max_requests</em> , because it is a working server with no memory leaks in PHP.  You can set <em>pm.max_requests = 0</em> with static, if you are fully confident in the existing and future PHP scripts.  But it is better to restart the scripts with time.  Set a large number of requests, because we want to avoid the extra costs of pm.  For example, at least <em>pm.max_requests = 1000</em> - depending on the number of <em>pm.max_children</em> and the number of requests per second. </p><br><p>  The screenshot shows the <a href="https://haydenjames.io/linux-top-customize-it/">Linux top</a> command, filtered by u (user) and the PHP-FPM username.  Only the first 50 or so processes are shown (not exactly counted), but, in fact, the top shows the top statistics that fit into the terminal window.  In this case, sorted by% CPU (% CPU).  To view all 100 PHP-FPM processes, run the command: </p><br><pre><code class="plaintext hljs">top -bn1 | grep php-fpm</code> </pre> <br><h3 id="kogda-ispolzovat-pm-ondemand-i-dynamic">  When to use pm ondemand and dynamic </h3><br><p>  If you use pm <em>dynamic</em> , these errors occur: </p><br><pre> <code class="plaintext hljs">WARNING: [pool xxxx] seems busy (you may need to increase pm.start_servers, or pm.min/max_spare_servers), spawning 32 children, there are 4 idle, and 59 total children</code> </pre> <br><p>  Try to change the parameter, the error will not go anywhere, as <a href="https://serverfault.com/questions/773216/php-error-pool-www-seems-busy-you-may-need-to-increase-pm-start-servers-or-p">described in this post on Serverfault</a> .  In this case, the value of pm.min was too small, and since the web traffic is changing a lot and it has high peaks and deep drops, it is difficult to adequately configure pm <em>dynamic</em> .  Usually this uses pm <em>ondemand</em> , <a href="https://serverfault.com/questions/773216/php-error-pool-www-seems-busy-you-may-need-to-increase-pm-start-servers-or-p">as advised in the same post</a> .  But this is even worse, because <em>ondemand</em> terminates inactive processes to zero, when there is little or no traffic, and in the end, you will still suffer with costs when traffic changes.  Unless, of course, you have set a huge waiting time.  And then it‚Äôs better to use <em>pm.static</em> + high <em>pm.max_requests</em> . </p><br><p>  PM <em>dynamic</em> and especially <em>ondemand</em> can be useful if you have several PHP-FPM pools.  For example, you place several cPanel accounts or several websites in different pools.  I have a server where, let's say, 100+ cpanel accounts and about 200 domains, and pm.static or even dynamic wouldn't save me.  All that is needed is <em>ondemand</em> , because more than two-thirds of websites receive little or no traffic, and with <em>ondemand</em> all child processes will fall off, which will save us a lot of memory!  Fortunately, the cPanel developers noticed this and set the default <em>ondemand</em> .  Previously, when the default value was <em>dynamic</em> , PHP-FPM was not at all appropriate for busy shared servers.  Many people used <em>suPHP</em> because pm <em>dynamic</em> consumed memory even with idle pools and cPanel PHP-FPM accounts.  Most likely, with good traffic, you will not be hosted on a server with a large number of PHP-FPM pools (shared hosting). </p><br><h3 id="zaklyuchenie">  Conclusion </h3><br><p>  If you use PHP-FPM and you have serious traffic, the <em>ondemand</em> and <em>dynamic</em> process managers for PHP-FPM will limit the bandwidth due to their inherent costs.  Examine your system and configure the PHP-FPM processes to match the maximum server capacity.  First, set <em>pm.max_children</em> depending on the maximum use of pm <em>dynamic</em> or <em>ondemand</em> , and then increase this value to a level where the memory and processor will work without overloading.  You will notice that with <em>pm static</em> , since everything is stored in your memory, traffic peaks will cause less peaks for the processor over time, and the average server and processor loads will equalize.  The average size of the PHP-FPM process depends on the web server and requires manual configuration; therefore, more automated process managers ‚Äî <em>dynamic</em> and <em>ondemand</em> ‚Äî are more popular.  Hope the article was helpful. </p><br><p>  <strong>UPD</strong> Added benchmark chart <a href="httpd.apache.org/docs/2.4/programs/ab.html">ab</a> .  If the PHP-FPM processes are in memory, the performance increases due to the memory consumption where they sit and wait.  Find the best option for yourself. </p><br><p> <a href=""><img src="https://habrastorage.org/webt/uw/6w/h4/uw6wh4vkhvsokb13szxoonv98jw.png"></a> </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/460511/">https://habr.com/ru/post/460511/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../460503/index.html">Wireless configuration Raspberry PI 3 B +</a></li>
<li><a href="../460505/index.html">Allure three crosses, or Why projects are so hard to finish on time</a></li>
<li><a href="../460507/index.html">XEN and the future of automotive: how open source hypervisor becomes a competitor to commercial automotive solutions</a></li>
<li><a href="../460509/index.html">How resident proxies help in business: a real case of using Infatica in the field of Data Mining</a></li>
<li><a href="../46051/index.html">Installing Wireless DLink AirPlus XtremeG DWL G520 on Debian Linux</a></li>
<li><a href="../460513/index.html">Flutter 1.7 - what's new in the release of July 10, 2019</a></li>
<li><a href="../460515/index.html">How close are we really to the emergence of robility?</a></li>
<li><a href="../460517/index.html">How to detect attacks on Windows infrastructure: we study the tools of hackers</a></li>
<li><a href="../46052/index.html">Widget Yandex.Clock for the New Year</a></li>
<li><a href="../460521/index.html">The Adventures of the Elusive Malvari, Part IV: DDE and the Word Document Fields</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>