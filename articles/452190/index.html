<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Using WebAssembly, we accelerated web application 20 times</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="This article discusses a case for accelerating a browser application by replacing JavaScript calculations with WebAssembly. 

 WebAssembly - what is i...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Using WebAssembly, we accelerated web application 20 times</h1><div class="post__text post__text-html js-mediator-article"><img src="https://habrastorage.org/getpro/habr/post_images/a4f/e5d/a03/a4fe5da03dbbf5ee42d599480e676428.png" alt="image"><br><br>  This article discusses a case for accelerating a browser application by replacing JavaScript calculations with WebAssembly. <br><a name="habracut"></a><br><h3>  WebAssembly - what is it? </h3><br>  In short, this is a binary instruction format for a stack virtual machine.  Often, Wasm (abbreviated name) is called a programming language, but it is not.  The instruction format is executed in the browser along with JavaScript. <br><br>  It is important that WebAssembly can be obtained by compiling source codes in languages ‚Äã‚Äãsuch as C / C ++, Rust, Go.  Here statistical typing and the so-called flat memory model are applied.  The code, as stated above, is stored in a compact binary format, so it runs almost as fast as if the application was started using the command line.  These capabilities have led to the rise in popularity of WebAssembly. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <blockquote>  <b>We remind:</b> <i>for all readers of "Habr" - a discount of 10,000 rubles when writing to any Skillbox course on the promotional code "Habr".</i> <br><br>  <b>Skillbox recommends:</b> Practical course <a href="https://skillbox.ru/agima/%3Futm_source%3Dskillbox.media%26utm_medium%3Dhabr.com%26utm_campaign%3DAGIMA%26utm_content%3Darticles%26utm_term%3Dwasm20min">"Mobile Developer PRO"</a> . <br></blockquote><br>  At the moment, Wasm is used in many applications, from games like Doom 3 to web applications like Autocad and Figma.  Wasm is also used in the realm of serverless computing. <br><br>  This article gives an example of using Wasm to speed up an analytical web service.  For clarity, we took a working application written in C, which will be compiled into WebAssembly.  The result will be used to replace the underperforming JS plots. <br><br><h3>  Application transformation </h3><br>  The example will use the fastq.bio browser service, which is intended for geneticists.  The tool allows to evaluate the quality of DNA sequencing (decoding). <br><br>  Here is an example application in work: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/815/b0e/9ea/815b0e9eaf7480d4e827762341c78a4a.jpg"><br><br>  The details of the process are not worth mentioning, since they are rather difficult for non-specialists, but if in brief, then the scientists on the above infographic can understand whether the DNA sequencing process went smoothly and what problems they had. <br><br>  This service has alternatives, desktop programs.  But fastq.bio allows you to speed up the work by visualizing the data.  In most other cases, you need to be able to work with the command line, but not all geneticists have the necessary experience. <br><br>  Everything works simply.  At the entrance - the data presented in the form of a text file.  This file is generated by specialized sequencing tools.  The file contains a list of DNA sequences and a quality assessment for each nucleotide.  The file format is .fastq, so the service got its name. <br><br><h3>  JavaScript implementation </h3><br>  The first user step when working with fastq.bio is to select the appropriate file.  Using the File object, the application reads a random sample of data from a file and processes this packet.  The task of JavaScript here is to perform simple string operations and count indicators.  One of them is the number of nucleotides A, C, G and T on different DNA fragments. <br><br>  After calculating the required indicators, they are visualized using Plotly.js, and the service begins to work with a new data sample.  Fragmentation is done to improve the quality of the UX.  If you work with all the data at once, the process will freeze for a while, since files with sequencing results take up hundreds of gigabytes of file space.  The service also takes sections of data from 0.5 to 1 MB in size and works with them step by step, building graphic data. <br><br>  Here's how it works: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/758/06a/eda/75806aeda6741781f9a10dc1a48f04f4.png"><br><br>  In the red box there is an algorithm for string conversions for visualization.  This is the most loaded part of the service in terms of computing.  It is worth trying to replace it with Wasm. <br><br><h3>  We test WebAssembly </h3><br>  To assess the possibility of using the Wasm, the project team started looking for ready-made solutions for creating a QC-metric (QC - quality control) based on fastq files.  The search was conducted among the tools written in C, C ++ or Rust, so that it was possible to port the code to WebAssembly.  In addition, the tool should not be "raw", it required a service already proven by scientists. <br><br>  As a result, the choice was made in favor of <a href="https://github.com/lh3/seqtk">seqtk</a> .  The application is quite popular, it is open-source, the source language is C. <br><br>  Before converting to Wasm, you should look at the seqtk compilation principle for the desktop.  According to the Makefile, here‚Äôs what you need: <br><br><pre><code class="plaintext hljs"># Compile to binary $ gcc seqtk.c \ -o seqtk \ -O2 \ -lm \ -lz</code> </pre> <br>  In principle, you can compile seqtk using Emscripten.  If it is not there, we get along <a href="https://hub.docker.com/r/robertaboukhalil/emsdk/tags">with the Docker image</a> . <br><br><pre> <code class="plaintext hljs">$ docker pull robertaboukhalil/emsdk:1.38.26 $ docker run -dt --name wasm-seqtk robertaboukhalil/emsdk:1.38.26</code> </pre> <br>  If you wish, <a href="https://emscripten.org/docs/getting_started/downloads.html">you can collect it yourself</a> , but it takes time. <br><br>  Inside the container you can easily take emcc as an alternative to gcc: <br><br><pre> <code class="plaintext hljs"># Compile to WebAssembly $ emcc seqtk.c \ -o seqtk.js \ -O2 \ -lm \ -s USE_ZLIB=1 \ -s FORCE_FILESYSTEM=1</code> </pre> <br>  Minimum changes: <br><br>  Instead of outputting to the Emscripten binary file, .wasm and .js are used to generate the files, which is used to launch the WebAssemby module. <br><br>  To support the zlib library, the USE_ZLIB flag is used.  The library is distributed and ported to WebAssembly, and Emscripten includes it in the project. <br><br>  The virtual file system Emscrippten is activated.  This is a <a href="">POSIX-like FS</a> running in RAM inside the browser.  When the page is updated, the memory is cleared. <br><br>  To understand why a virtual file system is needed, it is worth comparing the method of running seqtk from the command line with the method of running the compiled module WebAssembly. <br><br><pre> <code class="plaintext hljs"># On the command line $ ./seqtk fqchk data.fastq # In the browser console &gt; Module.callMain(["fqchk", "data.fastq"])</code> </pre> <br>  Getting access to the virtual file system is necessary in order not to rewrite seqtk for string rather than file input.  In this case, the data fragment is displayed as a data.fastq file in a virtual file system with a call to it main () seqtk. <br><br>  Here is the new architecture: <br><br><img src="https://habrastorage.org/getpro/habr/post_images/c10/bc9/d59/c10bc9d59f93b84eb5faf81a14415f54.png"><br><br>  The figure demonstrates that instead of computing in the main browser thread, <a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API/Using_web_workers" rel="noopener noreferrer nofollow">WebWorkers is</a> used.  This method allows you to perform calculations in the background thread, without compromising the responsiveness of the browser.  Well, the WebWorker controller starts the Worker, controlling its interaction with the main thread. <br><br>  The seqtk command is run by the Worker on the mounted file.  After completion, the Worker returns the result as a Promise.  When the message is received by the main thread, the result is used to update the graphs.  And so in several iterations. <br><br><h3>  What about performance of WebAssembly? </h3><br>  In order to evaluate the performance change, the project team used the parameter for the number of read operations per second.  The time for building interactive graphs is not taken into account, since JavaScript is used in both implementations. <br><br>  When using the out-of-the-box solution, the performance increase was ninefold. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/436/dc6/67b/436dc667b8b186146cb3bbef44f32e21.png"><br><br>  This is an excellent result, but as it turned out, it is possible to optimize it.  The fact is that a large number of QC analysis results are not used by seqtk, so they can be deleted.  If this is done, the result is 13 times better than JS. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/640/d78/56f/640d7856fd49ac45068a0a99474aa6b8.png"><br><br>  We managed to achieve it by simply commenting on the printf () commands. <br><br>  But that's not all.  The fact is that at this stage, fastq.bio receives the results of the analysis with calling various functions C. Each of them calculates its own set of characteristics, so each fragment of the file is read twice. <br><br>  In order to get around this problem, it was decided to combine the two functions into one.  As a result, productivity increased by 20 times. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/730/cd7/342/730cd7342f45f12992506f111ca1b33f.jpg"><br><br>  It is worth noting that such an outstanding result can be achieved far from always.  In some cases, performance drops, so it is worth evaluating each specific case. <br><br>  As a conclusion, it can be said that Wasm really provides an opportunity to improve application performance, but you need to use it wisely. <br><br><blockquote>  <b>Skillbox recommends:</b> <br><br><ul><li>  Two-year practical course <a href="https://iamwebdev.skillbox.ru/%3Futm_source%3Dskillbox.media%26utm_medium%3Dhabr.com%26utm_campaign%3DWEBDEVPRO%26utm_content%3Darticles%26utm_term%3Dwasm20min">"I am a web developer PRO"</a> . </li><li>  Online course <a href="https://skillbox.ru/c-sharp/%3Futm_source%3Dskillbox.media%26utm_medium%3Dhabr.com%26utm_campaign%3DCSHDEV%26utm_content%3Darticles%26utm_term%3Dwasm20min">"C # developer with 0"</a> . </li><li>  Practical annual course <a href="https://skillbox.ru/php/%3Futm_source%3Dskillbox.media%26utm_medium%3Dhabr.com%26utm_campaign%3DPHPDEV%26utm_content%3Darticles%26utm_term%3Dwasm20min">"PHP developer from 0 to PRO"</a> . <br></li></ul></blockquote></div><p>Source: <a href="https://habr.com/ru/post/452190/">https://habr.com/ru/post/452190/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../452182/index.html">Employee survey. Main mistake</a></li>
<li><a href="../452184/index.html">On anonymity in account-based blockchains</a></li>
<li><a href="../452186/index.html">The rarest and most expensive programming languages</a></li>
<li><a href="../452188/index.html">Unit Testing Json Serialization in Spring Boot</a></li>
<li><a href="../45219/index.html">Serial, however</a></li>
<li><a href="../452192/index.html">What is this here? The inner workings of JavaScript objects</a></li>
<li><a href="../452198/index.html">What should every QA engineer know about Selenium 4?</a></li>
<li><a href="../4522/index.html">PayPal "opened" Russia</a></li>
<li><a href="../45220/index.html">Nokia mobile phones will work with Lotus Domino servers</a></li>
<li><a href="../452200/index.html">GOSTIM: P2P F2F E2EE IM in one evening with GOST-cryptography</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>