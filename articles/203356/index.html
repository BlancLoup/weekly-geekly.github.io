<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Extend cartridge life</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Some manufacturers of laser printers embed EEPROM memory chips in their cartridges to store current information on the status of the cartridge. Specif...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Extend cartridge life</h1><div class="post__text post__text-html js-mediator-article">  Some manufacturers of laser printers embed EEPROM memory chips in their cartridges to store current information on the status of the cartridge.  Specifically, Samsung MLT-D104X (700 pages) or MLT-D104S (1500 pages) is considered for printers such as the Samsung ML-1665.  The situation with these cartridges is as follows.  The cartridge has an EEPROM chip with an I2C interface ... Cartridges are quite expensive (about $ 70), so there is an option to take the cartridge to an unofficial service, where it can be refilled and reset the page counter.  In this case, the reset of the counter is more expensive than the filling!  Therefore, there was an idea to learn how to reset the counter by yourself and give the cartridge only for refilling (for about 10 bucks). <br><a name="habracut"></a><br>  <strong>So, we have:</strong> <br>  Samsung ML-1665 printer.  Samsung MLT-D104X cartridge. <br><br>  <strong>We want:</strong> <br>  Reset the page count well or extend its work in another way. <br><br>  <strong>Decision:</strong> <br>  Suddenly, the idea arose to apply our board for prototyping Grambo Pi robots to a seemingly completely different problem! 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
      As mentioned <a href="http://habrahabr.ru/company/grambo_pi/blog/203124/">in our first article</a> , the Grambo Pi has several standard hardware interfaces, including I2C.  Since the board itself is programmable, it can be temporarily converted into a USB &lt;-&gt; I2C converter.  It was unexpectedly easy to do this - around one page of text on an embedded script.  A GUI script for Python has been added to this, which, in fact, communicates with the cartridge and returns what is written in it. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/1d9/737/b9d/1d9737b9d8b83d803dce27e9d8884f50.png" alt="image"><br><br>  In general, the cartridge is connected to the I2C bus. <br><br><img src="https://habrastorage.org/getpro/habr/post_images/faa/aed/060/faaaed0603cf39ac389895f1c6acc5b9.jpg" alt="image"><br><br>  Contacts on the cartridge are signed ..., as if it were specifically for the people to overwrite the EEPROM themselves! <br><br><img src="https://habrastorage.org/getpro/habr/post_images/ade/796/0ab/ade7960abcadf0ba761ce672bb393792.jpg" alt="image"><br><br>  The problem was to establish what exactly the EEPROM chip was installed in (since nothing is found on the Google labeling).  I had to act through all I2C addresses.  This particular chip responds to addresses 25, 30, and 40. At address 40, it appears that the memory page number is located, and at address 30, the data itself appeared.  After reading the data 2 times before and after printing a test page, it was possible to establish exactly which bytes change when printing pages. <br><br>  Unfortunately, it was not possible to clarify in what form the number of pages was encoded: 4 bytes per eye are changing at once rather randomly.  Trying to decipher - too lazy.  Therefore, it was decided to simply keep the firmware of the still ‚Äúlive‚Äù cartridge, and when approaching the critical 700 pages, the firmware should be rolled back to the saved value. <br><br>  <strong>Thus, replacing the cartridge is delayed for, we hope, for an unlimited time!</strong> <br><br><div class="spoiler">  <b class="spoiler_title">Script source code for the Grambo Pi board</b> <div class="spoiler_text"><pre><code class="hljs lua">#include &lt;supply&gt; new ioBuffer[<span class="hljs-number"><span class="hljs-number">32</span></span>] <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>( i2cAddr, chipAddr, cnt ) { new wr[<span class="hljs-number"><span class="hljs-number">2</span></span>] wr[<span class="hljs-number"><span class="hljs-number">0</span></span>] = chipAddr // IO operation at I2C bus. setLed( <span class="hljs-number"><span class="hljs-number">3</span></span> ) new res = i2cIo( i2cAddr, wr, <span class="hljs-number"><span class="hljs-number">1</span></span>, ioBuffer, cnt, <span class="hljs-number"><span class="hljs-number">500</span></span> ) setLed( <span class="hljs-number"><span class="hljs-number">0</span></span> ) // Operation result. setIo( <span class="hljs-number"><span class="hljs-number">1</span></span>, res ) new i <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;cnt; i++ ) setIo( i+<span class="hljs-number"><span class="hljs-number">2</span></span>, ioBuffer[i] ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res } <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>( i2cAddr, chipAddr, cnt ) { ioBuffer[<span class="hljs-number"><span class="hljs-number">0</span></span>] = chipAddr new i <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( i=<span class="hljs-number"><span class="hljs-number">0</span></span>; i&lt;cnt; i++ ) ioBuffer[i+<span class="hljs-number"><span class="hljs-number">1</span></span>] = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( i+<span class="hljs-number"><span class="hljs-number">4</span></span> ) // IO operation at I2C bus. setLed( <span class="hljs-number"><span class="hljs-number">3</span></span> ) new res = i2cIo( i2cAddr, ioBuffer, cnt+<span class="hljs-number"><span class="hljs-number">1</span></span>, ioBuffer, <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">500</span></span> ) setLed( <span class="hljs-number"><span class="hljs-number">0</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> res } main() { new led = <span class="hljs-number"><span class="hljs-number">0</span></span> // Reset command at the very beginning. setIo( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) setI2cEn( <span class="hljs-number"><span class="hljs-number">1</span></span> ) <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> ( ;; ) { new i2cAddr new devAddr new cnt new res // Check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">read</span></span> operation? <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> ) == <span class="hljs-number"><span class="hljs-number">1</span></span> ) { i2cAddr = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">1</span></span> ) devAddr = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">2</span></span> ) cnt = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">3</span></span> ) res = <span class="hljs-built_in"><span class="hljs-built_in">read</span></span>( i2cAddr, devAddr, cnt ) setIo( <span class="hljs-number"><span class="hljs-number">1</span></span>, res ) setIo( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) } // Else check <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> <span class="hljs-built_in"><span class="hljs-built_in">write</span></span> operation? <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">0</span></span> ) == <span class="hljs-number"><span class="hljs-number">2</span></span> ) { i2cAddr = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">1</span></span> ) devAddr = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">2</span></span> ) cnt = <span class="hljs-built_in"><span class="hljs-built_in">io</span></span>( <span class="hljs-number"><span class="hljs-number">3</span></span> ) res = <span class="hljs-built_in"><span class="hljs-built_in">write</span></span>( i2cAddr, devAddr, cnt ) setIo( <span class="hljs-number"><span class="hljs-number">1</span></span>, res ) // Report operation is completed setIo( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) } // Else it is unrecognized <span class="hljs-keyword"><span class="hljs-keyword">and</span></span> just reset! <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> setIo( <span class="hljs-number"><span class="hljs-number">0</span></span>, <span class="hljs-number"><span class="hljs-number">0</span></span> ) // Some delay. msleep( <span class="hljs-number"><span class="hljs-number">50</span></span> ) // Blinking LED number <span class="hljs-number"><span class="hljs-number">1.</span></span> setLed( led ) <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> ( led == <span class="hljs-number"><span class="hljs-number">0</span></span> ) led = <span class="hljs-number"><span class="hljs-number">1</span></span> <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> led = <span class="hljs-number"><span class="hljs-number">0</span></span> // When IO takes place both LEDs should blink. } }</code> </pre> <br></div></div><br><div class="spoiler">  <b class="spoiler_title">Python Script GUI Source Code</b> <div class="spoiler_text"><pre> <code class="python hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/python import xmlrpclib from Tkinter import * from time import sleep from supplyctrlusb import * # Data obtained with pages count 580 # 16 32 3 255 &lt;183&gt; 254 &lt;122 0 63&gt; 255 &lt;183&gt; 254 51 16 32 3 0 0 0 0 0 0 0 0 0 0 0 8 37 15 232 16 0 0 0 0 0 0 0 0 16 0 0 0 0 0 0 0 0 0 0 28 133 101 101 0 160 0 7 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 # Data obtained with pages count 581 # 16 32 3 255 &lt;151&gt; 254 &lt;138 255 201&gt; 255 &lt;151&gt; 254 51 16 32 3 0 0 0 0 0 0 0 0 0 0 0 8 37 15 232 16 0 0 0 0 0 0 0 0 16 0 0 0 0 0 0 0 0 0 0 28 133 101 101 0 160 0 7 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 # After zerowing attempt. # 16 32 3 255 124 254 35 255 189 255 124 254 51 16 32 3 0 0 0 0 0 0 0 0 0 0 0 8 37 15 232 16 class Application(Frame): DELAY = 0.1 TRIES = 50 FRAME = 4 def read( self, i2cAddr, devAddr, cnt ): print "read " + str(i2cAddr) + ", " + str(devAddr) + ", " + str(cnt) io = self.io io.setIo( 1, i2cAddr ) io.setIo( 2, devAddr ) io.setIo( 3, cnt ) # Start reading data pp = io.io( 0 ) print "pp = " + str( pp ) io.setIo( 0, 1 ) # Waiting for completion for t in range( self.TRIES ): finished = io.io( 0 ) print "finished = " + str( finished) if ( finished == 0 ): res = io.io( 1 ) print "res = " + str( res ) if res != 0: return (res, []) d = [] for i in range(cnt): v = io.io( 2+i ) d.append( v ) print "data", d return ( res, d ) sleep( self.DELAY ) print "Read timeout" def write( self, i2cAddr, devAddr, data ): io = self.io io.setIo( 1, i2cAddr ) io.setIo( 2, devAddr ) cnt = len( data ) print "write " + str(i2cAddr) + ", " + str(devAddr) + ", " + str(cnt) io.setIo( 3, cnt ) for i in range( cnt ): io.setIo( 4+i, data[i] ) # Start writing data. io.setIo( 0, 2 ) # Waiting for completion for t in range( self.TRIES ): finished = io.io( 0 ) print "finished = " + str( finished) if ( finished == 0 ): res = io.io( 1 ) print "res = " + str( res ) return res sleep( self.DELAY ) print "Write timeout" def readI2c( self ): # Clear output self.text.delete( 1.0, END ) i2cAddr = int( self.i2cAddr.get(), 2 ) # Binary number print "i2cAddr = " + str( i2cAddr ) devAddr = int( self.devAddr.get() ) print "devAddr = " + str( devAddr ) cnt = int( self.bytesCnt.get() ) print "bytesCnt = " + str( cnt ) # Return before real device interaction. #~ return for i in range( 0, cnt, self.FRAME ): res, data = self.read( i2cAddr, devAddr+i, self.FRAME ) if res &gt; 0: print "res = " + str( res ) return for k in range( len( data ) ): self.text.insert( END, str( data[k] ) + " " ) def writeI2c( self ): i2cAddr = int( self.i2cAddr.get(), 2 ) # Binary number print "i2cAddr = " + str( i2cAddr ) devAddr = int( self.devAddr.get() ) print "devAddr = " + str( devAddr ) cnt = int( self.bytesCnt.get() ) print "bytesCnt = " + str( cnt ) data = self.text.get( 1.0, END ) print "data = ", data d = data.split() print "data = ", d data = [] for i in range( len(d) ): data.append( int(d[i]) ) print "data = ", data # Return before executing critical changes. #~ return for i in range( 0, cnt, self.FRAME ): d = [] for k in range( self.FRAME ): d.append( data[i+k] ) res = self.write( i2cAddr, devAddr+i, d ) if res &gt; 0: print "res = " + str( res ) return print "Ready" def toString( self ): stri = self.text.get( 1.0, END ) d = stri.split() stri = "" cnt = len( d ) print "Characters cnt = " + str( cnt ) for i in range( cnt ): ch = chr( int( d[i] ) ) print "ch[" + str( i ) + "] = " + str( ch ) stri += ch print stri def createWidgets(self): self.lblI2cAddr = Label( self, text='I2C addr:' ) self.lblI2cAddr.grid( row=0, column=0, rowspan=1, columnspan=1 ) self.i2cAddr = Entry( self ) self.i2cAddr.insert( 0, "11110" ) self.i2cAddr.grid( row=0, column=1, rowspan=1, columnspan=1 ) self.lblDevAddr = Label( self, text='Dev addr:' ) self.lblDevAddr.grid( row=0, column=2, rowspan=1, columnspan=1 ) self.devAddr = Entry( self ) self.devAddr.insert( 0, "0" ) self.devAddr.grid( row=0, column=3, rowspan=1, columnspan=1 ) self.lblCnt = Label( self, text='Bytes cnt:' ) self.lblCnt.grid( row=0, column=4, rowspan=1, columnspan=1 ) self.bytesCnt = Entry( self ) self.bytesCnt.insert( 0, "128" ) self.bytesCnt.grid( row=0, column=5, rowspan=1, columnspan=1 ) self.i2cReadBtn = Button( self, text='Read I2C' ) self.i2cReadBtn["command"] = self.readI2c self.i2cReadBtn.grid( row=1, column=0, rowspan=1, columnspan=1 ) self.i2cWriteBtn = Button( self, text='Write I2C' ) self.i2cWriteBtn["command"] = self.writeI2c self.i2cWriteBtn.grid( row=1, column=5, rowspan=1, columnspan=1 ) self.text = Text( self ) self.text.grid( row=2, column=0, rowspan=5, columnspan=6 ) self.toTextBtn = Button( self, text = 'To string' ) self.toTextBtn["command"] = self.toString self.toTextBtn.grid( row=8, column = 3 ) def __init__(self, master=None): Frame.__init__(self, master) self.pack() self.createWidgets() self.io = Supply() pp = self.io.io( 0 ) print "initial pp = " + str( pp ) #~ for a in range( 24, 127 ): #~ res, d = self.read( a, 0, 4 ) #~ print " addr = " + str( a ) + ", res = " + str( res ) root = Tk() app = Application( master=root ) app.mainloop()</span></span></code> </pre><br></div></div></div><p>Source: <a href="https://habr.com/ru/post/203356/">https://habr.com/ru/post/203356/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../203346/index.html">We create the first application on the NancyFX part five. Application Testing</a></li>
<li><a href="../203348/index.html">We update Nexus 4, 7, 10 to Android 4.4 with the new interface</a></li>
<li><a href="../203350/index.html">We create the first application on NancyFX. Part six. Nancy.Selfhosting</a></li>
<li><a href="../203352/index.html">Telephone business NOKIA sold MSFT</a></li>
<li><a href="../203354/index.html">LG will stop watching SmartTV users</a></li>
<li><a href="../203358/index.html">Once again about Security in Symfony2 the user-resource-privilege approach</a></li>
<li><a href="../203360/index.html">CMS Textpattern development and who needs it</a></li>
<li><a href="../203362/index.html">Knapsack problem and gray code</a></li>
<li><a href="../203364/index.html">Windows Deployment Services and DHCP server on Linux + a couple of features</a></li>
<li><a href="../203366/index.html">9th Habravstrecha in Kiev</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>