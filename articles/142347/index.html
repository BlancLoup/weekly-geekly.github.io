<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>GeoIP and Django</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Web developers often face the classic task of locating a user by their IP address. There are many different solutions, for example, based on the globa...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>GeoIP and Django</h1><div class="post__text post__text-html js-mediator-article"> <a href="http://django-geoip.readthedocs.org/en/latest/index.html"><img src="https://habrastorage.org/storage2/c38/8aa/d82/c388aad82a435b7dadce99c8c67dbbf5.png" align="right"></a>  Web developers often face the classic task of locating a user by their IP address.  There are many different solutions, for example, based on the global base of Maxmind Geolite or Russian IpgeoBase.  All of them have quite low-level APIs, well, that's understandable: at the entrance there is an aypishnik, at the exit a country, or a city and, if lucky, there is some other useful information. <br><br>  All sites with GeoIP, which <a href="http://futurecolors.ru/">we</a> launched, have a common feature: they not only need simple geolocation, it is also necessary to display different content on the site depending on the location of the user.  To simplify this task for ourselves, we <a href="http://django-geoip.readthedocs.org/">wrote a small django-geoip battery</a> , inspired by the django-ipgeobase application. <br><a name="habracut"></a><br><br><h4>  Django-geoip </h4><br>  The main advantage of the application: it can automatically determine the geography of the user and pass it to the request object.  Now content on a site that has ‚Äúregionality‚Äù can be easily filtered into views.py by the value of request.location. 
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <h5>  Features </h5><ul><li>  pip install django-geoip and a few simple steps to install; </li><li>  <a href="http://django-geoip.readthedocs.org/en/latest/index.html">detailed documentation</a> on ReadTheDocs; </li><li>  <a href="https://secure.travis-ci.org/">coating tests</a> ; </li><li>  update database management team; </li><li>  an intuitive API for creating ‚Äúyour‚Äù geography model in addition to the existing ones; </li><li>  the user can change his region using the <a href="http://django-geoip.readthedocs.org/en/latest/usage.html">view</a> ; </li><li>  <a href="http://django-hosts.readthedocs.org/en/latest/index.html">django-hosts</a> integration </li></ul><br><br><h4>  Features of the implementation </h4>  The django-geoip application supports the geography hierarchy of Country - Region - City, which is stored in a normalized form in a DBMS.  Data on the range of IP-addresses with links to all elements of geography - in the fourth table.  The current version works only with the data of ipgeobase.ru, it is almost a thousand cities of Russia and Ukraine and 150 thousand IP ranges. <br><br>  One of the reasons for storing data in a database is the need to create its own geography model that meets the objectives of business logic.  For example, in one of the projects we limit the definition of a user's location to areas of Russia, in the other - to a set of cities in which the company is present.  This model implements the ‚Äúfacade‚Äù pattern to the ipgeobase hierarchy of geography, allowing you to flexibly configure geolocation for you. <br><br>  Imagine that our site has several regional "versions", each of which may contain its own content.  At the same time, a region can have an arbitrary name and, for example, contain several regions of the Russian Federation (geo_location table in the diagram): <br><img src="https://habrastorage.org/storage2/e8c/448/7c6/e8c4487c63b9178d64e6110c96d27999.png"><br>  Here is an example of how it is configured and works.  Define your geography model MyCustomLocation: <br><br><pre><code class="python hljs"><span class="hljs-comment"><span class="hljs-comment"># geo/models.py class MyCustomLocation(GeoLocationFacade): name = models.CharField(max_length=100) region = models.OneToOneField(Region, related_name='my_custom_location') is_default = models.BooleanField(default=False) @classmethod def get_by_ip_range(cls, ip_range): """     IP-.       , ,   ,       """ return ip_range.region.geo_location @classmethod def get_default_location(cls): """  -,  ,       IP""" return cls.objects.get(is_default=True) @classmethod def get_available_locations(cls): return cls.objects.all() class Meta: db_table = 'geo_location'</span></span></code> </pre> <br>  This is a regular django model, supplemented with three class methods that implement the ‚Äúinterface‚Äù of the GeoIP facade.  The purpose of each function is clear from the title and pre-stringing.  It remains to fill the base with the names of cities and link them to the models djagno-geoip. <br><br>  Register in settings.py: <br><pre> <code class="python hljs">GEOIP_LOCATION_MODEL = <span class="hljs-string"><span class="hljs-string">'geo.models.MyCustomLocation'</span></span></code> </pre><br>  Add middleware to automatically determine the region: <br><pre> <code class="python hljs">MIDDLEWARE_CLASSES = (... <span class="hljs-string"><span class="hljs-string">'django_geoip.middleware.LocationMiddleware'</span></span>, ... )</code> </pre><br>  And voila: request.location now contains the value of our MyCustomLocation model for each user. <br><pre> <code class="python hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">def</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">my_view</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(request)</span></span></span><span class="hljs-function">:</span></span> <span class="hljs-string"><span class="hljs-string">""" Passing location into template """</span></span> ... context[<span class="hljs-string"><span class="hljs-string">'location'</span></span>] = request.location ...</code> </pre><br>  If the user is not in any of these cities, he will be assigned the region by default (get_default_location). <br><br>  This approach greatly simplifies the task of creating ‚Äúregional‚Äù sites that differ from each other in content depending on the location of the user. <br><br><h4>  What's next </h4><br>  The application, although alpha, works well with us in production (version 0.2.2).  The alpha status hints that the API will change in the future.  We plan to support and develop it further, including implementing the definition of a region not only for Russia, but also for the <a href="http://www.maxmind.com/app/geolitecity">rest of the</a> <a href="http://habrahabr.ru/post/135596/">world</a> .  Also interesting was the idea of <a href="http://habrahabr.ru/post/138536/">optimizing the search for a suitable IP range on the base</a> . <br><br>  Source codes are available <a href="https://github.com/futurecolors/django-geoip">on github</a> , waiting for your comments. </div><p>Source: <a href="https://habr.com/ru/post/142347/">https://habr.com/ru/post/142347/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../142342/index.html">Why many people choose PHP</a></li>
<li><a href="../142343/index.html">Google Project Glass - Russian version</a></li>
<li><a href="../142344/index.html">JavaOne / Oracle Develop 2012: general impressions. Story with pictures</a></li>
<li><a href="../142345/index.html">Yahoo for the first time in a long time shows the growth of financial indicators</a></li>
<li><a href="../142346/index.html">Windows Phone Marketing Director resigned only 5 months after starting work</a></li>
<li><a href="../142348/index.html">Google Earth adds pictures from balloons</a></li>
<li><a href="../142349/index.html">Terraria: or write games correctly</a></li>
<li><a href="../142350/index.html">* .Docx templates using Groovy scriptlets</a></li>
<li><a href="../142351/index.html">Functional programming for all</a></li>
<li><a href="../142352/index.html">The most correct safe printf</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>