<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Battle server for Django application: Ubuntu Server 10.04 LTS + django 1.4 + nginx + gunicorn</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="Many Django development tutorials reveal how to quickly get a working debug server (python manage.py runserver), and the issue of deploying in combat ...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Battle server for Django application: Ubuntu Server 10.04 LTS + django 1.4 + nginx + gunicorn</h1><div class="post__text post__text-html js-mediator-article">  Many Django development tutorials reveal how to quickly get a working debug server (python manage.py runserver), and the issue of deploying in combat mode often remains undisclosed or covers far from the simplest and most effective methods. <br>  Below I will talk about one of the ways to deploy a site on Django in combat mode, starting with the choice of hosting, ending with the deployment of a web server.  Thus, the article may be useful to those who have mastered the development based on Django, but have no experience deploying servers.  My way is one of many, but it is quite simple, efficient in work and easy to maintain.  We use VPS hosting, Ubuntu 10.04, nginx, gunicorn. <br><br><a name="habracut"></a><br><br><a name="contents"></a><h4>  Table of contents </h4><br><ul><li>  <a href="https://habr.com/ru/post/159575/">Table of contents</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Project structure</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Hosting</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Ubuntu server</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Deploying the project</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Nginx web server setup</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Gunicorn and supervisor setup</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Troubleshooting</a> </li><li>  <a href="https://habr.com/ru/post/159575/">Conclusion</a> </li><li>  <a href="https://habr.com/ru/post/159575/">useful links</a> </li></ul>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <a name="structure"></a><h4>  Project structure </h4><br>  To further the story, it is necessary to tell about the structure of the project being developed: <br><pre><code class="hljs 1c">- myproject/ -  ,  ,   <span class="hljs-keyword"><span class="hljs-keyword"></span></span>   ; - env/ -  ,    virtualenv; - src/ -   ,      IDE, <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,     myproject <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ; - myproject/ -   ,    Django-; - __init__.py - settings.py - manage.py - urls.py - myapp1/ - myapp2/ ... - static_content/ -  <span class="hljs-keyword"><span class="hljs-keyword"></span></span> ,   -   (  - nginx),  ,    - ,   ; - static/ -    (    ); - media/ - media-,        ; - docs/ -    <span class="hljs-built_in"><span class="hljs-built_in"></span></span>, ,  ; - logs/ - ,   ,   ; - pids/ -  pid-.</code> </pre> <br>  At first glance, the nesting depth of the source may seem redundant.  However, my experience shows that the costs of working at such a depth are small, and the merits of greater structuredness are considerable. <br><br><div class="spoiler">  <b class="spoiler_title">About source code storage</b> <div class="spoiler_text">  The article does not disclose the question of storing the source of the project, since the choice, organization, and setting up repository access is a separate topic for the article. <br></div></div><br><br><a name="hosting"></a><h4>  Hosting </h4><br>  For myself, I found out a long time ago that the most convenient hosting for django is VPS hosting.  Having tried several VPS hosting sites, I settled on the most acceptable price / performance ratio - <a href="http://firstvds.ru/%3Ffrom%3D96322">FirstVDS</a> .  I use the tariff for 400 rubles per month - 1500 MB RAM, 24000 MB HDD.  But at first it cost 150 rubles (in this case you will need to teach some applications to consume less resources). <br>  So, in order to start you need to order and pay for VPS, while choosing the type of virtualization OpenVZ - an incomplete imitation of a physical machine, but quite sufficient for our tasks, it is worth noting that with such virtualization for the same money they give more memory useful for memcached .  As an operating system, I recommend choosing Ubuntu Server 10.04 LTS #.  Ubuntu Server 12.04 LTS is also available, I managed to put it into operation without much difficulty, however, the hosting template has appeared recently, and the hosting provider‚Äôs experts do not recommend it yet be installed on the combat servers.  Now I use it only on a test server. <br><br><div class="spoiler">  <b class="spoiler_title">Alternative Ubuntu Server operating systems for hosting</b> <div class="spoiler_text">  Surely there will be lawyers for more stable hosting systems: FreeBSD, Debian, RedHat, CentOS.  I will not get involved in holivar.  I note only that my experience shows that to develop on Django, quite new versions of packages and applications are often required.  On the listed systems, these packages arise after they are supported by a set of crutches, which, as a result, negates its reliability.  In Ubutnu, newer versions of packages are accepted into the repository much faster. <br></div></div><br><br>  After ordering and paying for the mail comes SSH-access, you can now begin to configure the operating system. <br><br><a name="ubuntu"></a><h4>  Ubuntu server </h4><br>  Having access, I, first of all, update the system, then disable root access via SSH. <br>  You can connect via SSH in Windows with the well-known <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">Putty</a> program, but I use its more ‚Äúwired‚Äù modification - <a href="http://www.9bis.net/kitty/">kitty</a> .  As the IP address of the server, enter the address sent by the host, connect, enter root as user and password when prompted. <br>  To connect to Linux-like systems, we use a native terminal (Terminal, Konsole, etc.), by typing a simple command in it: <br><pre> <code class="bash hljs">ssh root@1.2.3.4</code> </pre> <br>  where 1.2.3.4 is the IP address sent by the hoster, when prompted, enter the password sent by the hosting provider. <br>  First of all, we will change the password of the root, for the sake of paranoia: <br><pre> <code class="bash hljs">passwd</code> </pre> <br>  upon request, we enter the new password twice, I advise you to generate and store in <a href="http://www.keepassx.org/">KeePassX</a> , do not hesitate to make it more complicated (&gt; 20 characters), you will hardly have to use it. <br>  We update packages in the system: <br><pre> <code class="bash hljs">apt-get update apt-get upgrade</code> </pre><br>  Add a user on behalf of whom we will deploy the server: <br><pre> <code class="bash hljs">adduser myuser</code> </pre> <br>  you can not enter anything except the password, but it is better to come up with it more complicated <br>  Now you need an editor to edit configs, I prefer nano: <br><pre> <code class="bash hljs">apt-get install nano</code> </pre> <br>  Add the rights to the user to execute commands as root (sudo): <br><pre> <code class="bash hljs">nano /etc/sudoers <span class="hljs-comment"><span class="hljs-comment">#   root ALL=(ALL:ALL) ALL #     myuser ALL=(ALL:ALL) ALL</span></span></code> </pre><br>  Now we disable the ability for the root user to log in via SSH (optionally, a security measure): <br><pre> <code class="bash hljs">nano /etc/ssh/sshd_config <span class="hljs-comment"><span class="hljs-comment">#  PermitRootLogin yes #   PermitRootLogin no</span></span></code> </pre><br>  after that, I reboot the machine to make sure everything went as it should: <br><pre> <code class="bash hljs">reboot</code> </pre> <br>  After a minute, you can log in as myuser (or you can pre-verify that the username root does not work anymore): <br><pre> <code class="bash hljs">ssh myuser@1.2.3.4</code> </pre> <br><br>  Now I put a number of system packages necessary for the Django application and infrastructure to work: <br><pre> <code class="bash hljs">sudo apt-get install gcc mysql-server python-mysqldb memcached mercurial python-profiler w3m python-setuptools libmysqlclient-dev git-core python-dev rabbitmq-server supervisor nginx</code> </pre><br>  Let's take a look at what is what: <br><ul><li>  gcc is a C compiler, C ++ compiler, something else before the heap, definitely needed to build some packages; </li><li>  python-setuptools - installing the easy_install command, you only need to install virtualenv, the fact is that the system package virtualenv is not installed the latest version, with which there are a number of annoying problems; </li><li>  mysql-server - from the name it is clear that this is a MySQL server, we will need it, since we are going to raise the database server on the host of the web application; </li><li>  libmysqlclient-dev - this package is needed in order to build the MySQL access interface for python; </li><li>  python-dev - python's API, definitely needed to build some packages; </li><li>  supervisor is a daemon controller program, needed for taming a web server and possibly a number of other programs; </li><li>  nginx - nginx web server, I express my gratitude to <a href="http://sysoev.ru/about.html">Igor Sysoev</a> ; </li><li>  rabbitmq-server - optional, AMQP server, useful if you need to use celery; </li><li>  memcached is an optional, in-memory known cache implementation; </li><li>  git-core - optional, the client for the git version control system, will be required if the necessary packages are stored in the git-repository; </li><li>  mercurial - optionally, the client for the version control system mercurial (hg) is required if the necessary packages are stored in the mercurial repository. </li></ul><br><br><a name="deployement"></a><h4>  Deploying the project </h4><br>  For deployment, we will use the virtual environment using the virtualenv tool. <br>  In the previous chapter, we installed the useful utility easy_install, with which we will install the latest version of virtualenv now: <br><pre> <code class="bash hljs">sudo easy_install virtualenv</code> </pre><br>  Note.  I deliberately did not install pip globally, so that there were no random conflicts with it in pip's in virtual environments. <br>  Now you can begin to deploy the project.  First you need to place it somewhere in your home directory, let it be: <br><pre> <code class="bash hljs">/home/myuser/web/myproject</code> </pre><br>  I use the git version control system.  But you can achieve this by simply copying over the scp.  In Windows, you can use <a href="http://winscp.net/">WinSCP</a> , in Linux file managers support the address format sftp: //myuser@1.2.3.4, as you probably guessed, data for access via SSH is used as authentication data. <br>  In my project, the root file for building a virtual environment is build_env.sh: <br><pre> <code class="bash hljs"><span class="hljs-comment"><span class="hljs-comment">#!/bin/bash echo $0: Creating virtual environment virtualenv --prompt="&lt;myenv&gt;" ./env mkdir ./logs mkdir ./pids mkdir ./db mkdir ./static_content mkdir ./static_content/media echo $0: Installing dependencies source ./env/bin/activate export PIP_REQUIRE_VIRTUALENV=true ./env/bin/pip install --requirement=./requirements.conf --log=./logs/build_pip_packages.log echo $0: Making virtual environment relocatable virtualenv --relocatable ./env echo $0: Creating virtual environment finished.</span></span></code> </pre><br>  and the requirements.conf file, which contains the packages necessary for the application to work: <br><pre> <code class="hljs nginx"><span class="hljs-attribute"><span class="hljs-attribute">django</span></span> git+git://github.com/sehmaschine/django-grappelli.git#egg=django-grappelli git+git://github.com/django-mptt/django-mptt.git#egg=django-mptt git+git://github.com/krvss/django-social-auth.git#django-social-auth git+git://github.com/gabrielhurley/django-wymeditor.git#django-wymeditor git+git://github.com/jtauber/django-mailer.git#django-mailer git+git://github.com/tweepy/tweepy.git#tweepy django-celery django-<span class="hljs-literal"><span class="hljs-literal">debug</span></span>-toolbar django-pdb python-memcached MySQL-python xlrd unidecode anyjson gunicorn pillow south fabric requests xlwt</code> </pre><br>  This is a possible set of packages, somehow I will tell you more about some of them, but we do not delve into the development aspects of this topic. <br>  So, after running in the project folder / home / myuser / web / myproject: <br><pre> <code class="bash hljs">./build_env.sh</code> </pre><br>  set a virtual environment for our server. <br>  Now you need to take care of creating the database.  In our projects we use MySQL.  We start the MySQL console: <br><pre> <code class="bash hljs">mysql -uroot -pROOTPASSWORD</code> </pre><br>  where we create the base and user: <br><pre> <code class="sql hljs"><span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">DATABASE</span></span> myproject <span class="hljs-built_in"><span class="hljs-built_in">CHARACTER</span></span> <span class="hljs-keyword"><span class="hljs-keyword">SET</span></span> utf8 <span class="hljs-keyword"><span class="hljs-keyword">COLLATE</span></span> utf8_general_ci; <span class="hljs-keyword"><span class="hljs-keyword">CREATE</span></span> <span class="hljs-keyword"><span class="hljs-keyword">USER</span></span> <span class="hljs-string"><span class="hljs-string">'myproject'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span> <span class="hljs-keyword"><span class="hljs-keyword">IDENTIFIED</span></span> <span class="hljs-keyword"><span class="hljs-keyword">BY</span></span> <span class="hljs-string"><span class="hljs-string">'USERPASSWORD'</span></span>; <span class="hljs-keyword"><span class="hljs-keyword">GRANT</span></span> ALL <span class="hljs-keyword"><span class="hljs-keyword">PRIVILEGES</span></span> <span class="hljs-keyword"><span class="hljs-keyword">ON</span></span> myproject.* <span class="hljs-keyword"><span class="hljs-keyword">TO</span></span> <span class="hljs-string"><span class="hljs-string">'myproject'</span></span>@<span class="hljs-string"><span class="hljs-string">'localhost'</span></span>;</code> </pre><br>  Now access settings can be entered into the project settings file (settings.py or local_settings.py). <br>  If you have a database dump, you know what to do.  If not, then create in it the scheme and the necessary data: <br><pre> <code class="bash hljs"><span class="hljs-built_in"><span class="hljs-built_in">cd</span></span> ~/web/myproject <span class="hljs-comment"><span class="hljs-comment">#     source env/bin/activate #    python manage.py syncdb #     </span></span></code> </pre>  now we will collect static files: <br><pre> <code class="bash hljs">python manage.py collectstatic</code> </pre><br>  On this application is ready to run. <br><br><a name="nginx"></a><h4>  Nginx web server setup </h4><br>  To configure the Nginx web server, you need to place the myproject.conf config (the suffix must be .conf) in the / etc / nginx / sites-available / folder. <br>  You can create and edit a file in the SSH console over nano: <br><pre> <code class="bash hljs">sudo nano /etc/nginx/sites-available/myproject.conf</code> </pre><br>  then paste the contents of the example below (Shift + Insert), fix them to fit your needs, save (Ctrl + O), exit (Ctrl + X). <br>  An example of the content of the myproject.conf file: <br><pre> <code class="nginx hljs"><span class="hljs-attribute"><span class="hljs-attribute">upstream</span></span> myproject.ru { <span class="hljs-attribute"><span class="hljs-attribute">server</span></span> localhost:<span class="hljs-number"><span class="hljs-number">12345</span></span> fail_timeout=<span class="hljs-number"><span class="hljs-number">0</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> www.myproject.ru; <span class="hljs-attribute"><span class="hljs-attribute">rewrite</span></span><span class="hljs-regexp"><span class="hljs-regexp"> ^/(.*)</span></span> http://myproject.ru/<span class="hljs-variable"><span class="hljs-variable">$1</span></span> <span class="hljs-literal"><span class="hljs-literal">permanent</span></span>; } <span class="hljs-section"><span class="hljs-section">server</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">listen</span></span> <span class="hljs-number"><span class="hljs-number">80</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">client_max_body_size</span></span> <span class="hljs-number"><span class="hljs-number">4G</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">server_name</span></span> myproject.ru; <span class="hljs-attribute"><span class="hljs-attribute">access_log</span></span> /home/myuser/web/myproject/logs/myproject.access.log; <span class="hljs-attribute"><span class="hljs-attribute">keepalive_timeout</span></span> <span class="hljs-number"><span class="hljs-number">5</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/myuser/web/myproject/static_content; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> / { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://myproject.ru; } <span class="hljs-attribute"><span class="hljs-attribute">error_page</span></span> <span class="hljs-number"><span class="hljs-number">500</span></span> <span class="hljs-number"><span class="hljs-number">502</span></span> <span class="hljs-number"><span class="hljs-number">503</span></span> <span class="hljs-number"><span class="hljs-number">504</span></span> /<span class="hljs-number"><span class="hljs-number">500</span></span>.html; <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> = /<span class="hljs-number"><span class="hljs-number">500</span></span>.html { <span class="hljs-attribute"><span class="hljs-attribute">root</span></span> /home/myuser/web/myproject/static_content/static/html; } <span class="hljs-attribute"><span class="hljs-attribute">location</span></span> <span class="hljs-regexp"><span class="hljs-regexp">~ ^/(static|media)/</span></span> { <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> X-Forwarded-For <span class="hljs-variable"><span class="hljs-variable">$proxy_add_x_forwarded_for</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_set_header</span></span> Host <span class="hljs-variable"><span class="hljs-variable">$http_host</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">proxy_redirect</span></span> <span class="hljs-literal"><span class="hljs-literal">off</span></span>; <span class="hljs-attribute"><span class="hljs-attribute">if</span></span> (!-f <span class="hljs-variable"><span class="hljs-variable">$request_filename</span></span>) { <span class="hljs-attribute"><span class="hljs-attribute">proxy_pass</span></span> http://myproject.ru; break; } } }</code> </pre>  Let's try to understand the general words, what is what. <br>  In this example, the upstream is a localhost: 12345 socket, to which we will forward all requests that do not satisfy the following url: <br>  / static / * - static site files; <br>  / media / * - media files, files that are created during the operation of the site; <br>  On this socket we will hang on listening to our gunicorn in the next part of the article.  The name of the Upstream, theoretically, is chosen arbitrarily, however, I encountered problems if the name of the Upstream was different from the domain name of the site (I do not remember the text of Django errors to describe in more detail). <br><br>  Another interesting part of the config: <br>  <a href="http://www.myproject.ru/">Redirecting</a> from myproject.ru subdomain <a href="http://www.myproject.ru/">www.myproject.ru</a> ; you can do the opposite, if you prefer; <br>  5XX error handling is provided by issuing a static 500.html file.  It is quite simple to get such a file: make the site show a 404 page, save it as 500.html in the browser and edit the error text; <br>  if the static file is not found, the request is sent to gunicorn so that it can produce a standard error 404. <br><br>  After the config file is placed where it should be (you can check with cat /etc/nginx/sites-available/myproject.conf), you need to put a symlink on it: <br><pre> <code class="bash hljs">sudo ln -s /etc/nginx/sites-available/myproject.conf /etc/nginx/sites-enabled/</code> </pre><br>  and restart nginx: <br><pre> <code class="bash hljs">sudo service nginx restart</code> </pre><br><br><a name="gunicorn"></a><h4>  Gunicorn and supervisor setup </h4><br>  When deploying the project, we installed the gunicorn package, now we use it to generate dynamic HTTP responses (HTTP response) by a Django application.  Gunicorn itself can receive requests and formulate responses to them, however, it is necessary to keep gunicorn running, for example, to start when the system is restarted, we will entrust it to the supervisor specializing in this program. <br>  Note that gunicorn developers strongly do not recommend putting it on the front line, but instruct the reception of requests from users to specialized servers, such as nginx, as we do. <br>  So, we create in the /etc/supervisor/conf.d/ folder the file myproject.conf with the following content: <br><pre> <code class="hljs ruby">[<span class="hljs-symbol"><span class="hljs-symbol">program:</span></span>myproject] command=<span class="hljs-regexp"><span class="hljs-regexp">/home/myuser</span></span><span class="hljs-regexp"><span class="hljs-regexp">/web/myproject</span></span><span class="hljs-regexp"><span class="hljs-regexp">/env/bin</span></span><span class="hljs-regexp"><span class="hljs-regexp">/python /home</span></span><span class="hljs-regexp"><span class="hljs-regexp">/myuser/web</span></span><span class="hljs-regexp"><span class="hljs-regexp">/myproject/src</span></span><span class="hljs-regexp"><span class="hljs-regexp">/myproject/manage</span></span>.py run_gunicorn --bind=<span class="hljs-symbol"><span class="hljs-symbol">localhost:</span></span><span class="hljs-number"><span class="hljs-number">12345</span></span> --workers=<span class="hljs-number"><span class="hljs-number">3</span></span> --pid=<span class="hljs-regexp"><span class="hljs-regexp">/home/myuser</span></span><span class="hljs-regexp"><span class="hljs-regexp">/web/myproject</span></span><span class="hljs-regexp"><span class="hljs-regexp">/pids/gunicorn</span></span>.pid --log-file /home/myuser/web/myproject/logs/gunicorn.log directory=<span class="hljs-regexp"><span class="hljs-regexp">/home/myuser</span></span><span class="hljs-regexp"><span class="hljs-regexp">/web/myproject</span></span><span class="hljs-regexp"><span class="hljs-regexp">/src/myproject</span></span> umask=<span class="hljs-number"><span class="hljs-number">022</span></span> autostart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> autorestart=<span class="hljs-literal"><span class="hljs-literal">true</span></span> startsecs=<span class="hljs-number"><span class="hljs-number">10</span></span> startretries=<span class="hljs-number"><span class="hljs-number">3</span></span> exitcodes=<span class="hljs-number"><span class="hljs-number">0</span></span>,<span class="hljs-number"><span class="hljs-number">2</span></span> stopsignal=TERM stopwaitsecs=<span class="hljs-number"><span class="hljs-number">10</span></span> user=myuser</code> </pre><br>  Note that in the gunicorn parameters we pass the same port for wiretapping (in our example 12345), which was indicated in the nginx config.  The number of workflows is set to 3, selected this parameter subjectively for one of the sites, based on their workloads, and so far I cannot recommend any value. <br>  After the config is placed in the correct folder (you can check it by running cat /etc/supervisor/conf.d/myproject.conf) you need to re-read the file or just restart supervisor, I use the second option for reliability: <br><pre> <code class="bash hljs">sudo supervisorctl reload</code> </pre><br>  You can check the launch success with the command: <br><pre> <code class="bash hljs">sudo supervisorctl status</code> </pre><br>  if successful, the status of the myproject process will become RUNNING after a few seconds. <br><br><a name="problems"></a><h4>  Troubleshooting </h4><br><div class="spoiler">  <b class="spoiler_title">perl: warning: Setting locale failed.</b> <div class="spoiler_text">  From the very beginning of work, when entering commands, the system starts to issue a warning: <br><pre> <code class="hljs sql">perl: warning: Setting locale failed. perl: warning: Please <span class="hljs-keyword"><span class="hljs-keyword">check</span></span> that your locale <span class="hljs-keyword"><span class="hljs-keyword">settings</span></span>:</code> </pre>  is solved by adding the correct locale: <br><pre> <code class="bash hljs">locale-gen ru_RU.UTF8</code> </pre><br>  based on: <a href="http://askubuntu.com/questions/76013/how-do-i-add-locale-to-ubuntu-server">http://askubuntu.com/questions/76013/how-do-i-add-locale-to-ubuntu-server</a> <br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">sudo: must be setuid root</b> <div class="spoiler_text">  When you first use sudo from under a new user, an error may occur: <br><pre> <code class="hljs rust">sudo: must <span class="hljs-keyword"><span class="hljs-keyword">be</span></span> setuid root</code> </pre><br>  for example: <br><pre> <code class="bash hljs">chmod 4755 /usr/bin/sudo</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">E: Unable to correct problems, you have held broken packages.</b> <div class="spoiler_text">  when installing some packages in Ubuntu 12.04 (for example, python-dev or libmysql-dev), an error may occur: <br><pre> <code class="hljs pgsql">libc6-dev : <span class="hljs-keyword"><span class="hljs-keyword">Depends</span></span>: libc6 (= <span class="hljs-number"><span class="hljs-number">2.15</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span>ubuntu10<span class="hljs-number"><span class="hljs-number">.2</span></span>) but <span class="hljs-number"><span class="hljs-number">2.15</span></span><span class="hljs-number"><span class="hljs-number">-0</span></span>ubuntu10+openvz0 <span class="hljs-keyword"><span class="hljs-keyword">is</span></span> <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> be installed E: Unable <span class="hljs-keyword"><span class="hljs-keyword">to</span></span> correct problems, you have held broken packages.</code> </pre>  To solve it, it is enough to modify the file /etc/apt/preferences.d/99ovz-libc-pin: <br>  replacing <br><pre> <code class="hljs">libc-bin libc6</code> </pre><br>  on <br><pre> <code class="hljs">libc-bin libc6 libc6-dev libc-dev-bin</code> </pre><br></div></div><br><br><div class="spoiler">  <b class="spoiler_title">Couldn't open / dev / null: Permission denied</b> <div class="spoiler_text">  When creating a user, an error may occur: <br><pre> <code class="hljs vhdl">Couldn<span class="hljs-symbol"><span class="hljs-symbol">'t</span></span> <span class="hljs-keyword"><span class="hljs-keyword">open</span></span> /dev/<span class="hljs-keyword"><span class="hljs-keyword">null</span></span>: Permission denied</code> </pre><br>  solved it like this: <br><pre> <code class="bash hljs">sudo chmod 666 /dev/null</code> </pre><br>  I do not know how correct this is, but I did not see the dangers. <br></div></div><br><br><a name="conclusion"></a><h4>  Conclusion </h4><br>  Note the positive aspects of this deployment: <br><ul><li>  Deploying the solution on a VPS virtual machine gives you virtually unlimited administration. </li><li>  The independence of nginx from gunicorn, as is often suggested when using Apache and mod_python, for example.  In particular, it is quite easy to replace, for example for debugging, with a gunicorn development server: <br><pre> <code class="bash hljs">sudo supervisorctl stop myproject python manage.py runserver localhost:12345 <span class="hljs-comment"><span class="hljs-comment">#    </span></span></code> </pre><br>  Now nginx will send requests to the developer's server, without even knowing about the changes. </li><li>  Nginx as a distributor of static files is recognized as one of the best, maybe even the best. </li><li>  virtualenv allows you to easily and naturally isolate the virtual environments of different projects from each other.  Nowadays, disk space costs are incomparably cheaper than messing around with package version conflicts. </li><li>  gunicorn under the control of the supervisor is much more convenient and reliable than the ways of launching gunicorn under the control of scripts in /etc/init.d/ and some other ways of launching, since it provides a way of monitoring running programs, carefully restarting programs in case of failures. </li></ul><br>  In the article only one of the many options for deploying a Django application was examined, I came to it through many trials and errors.  My recommendations do not pretend to be the ultimate truth.  Moreover, I will be glad to any constructive criticism. <br><br><a name="links"></a><h4>  useful links </h4><br><ol><li>  <a href="http://firstvds.ru/%3Ffrom%3D96322">FirstVDS</a> - cheap VPS hosting, with a link order for a quarter cheaper. </li><li>  <a href="http://www.chiark.greenend.org.uk/~sgtatham/putty/download.html">Putty</a> and <a href="http://www.9bis.net/kitty/">Kitty</a> are SSH clients for Windows. </li><li>  <a href="http://winscp.net/">WinSCP</a> - SCP-client under Windows, no need to raise the FTP-server, just use your existing SSH-account. </li><li>  <a href="http://www.keepassx.org/">KeePassX</a> - cross-platform password storage utility. </li><li>  <a href="https://wiki.ubuntu.com/LTS">Ubuntu LTS</a> is a release release policy for Ubuntu Long Term Support. </li><li>  <a href="http://www.rationallyparanoid.com/articles/ubuntu-10-lts-security.html">Ubuntu Security</a> - setting for paranoids for the desktop, but something can be learned for the server. </li><li>  <a href="https://docs.djangoproject.com/en/dev/howto/deployment/fastcgi/">Django Deployement</a> - other ways to deploy sites on Django. </li><li>  <a href="http://pypi.python.org/pypi/virtualenv">virtualenv</a> - use virtualenv. </li><li>  <a href="https://calomel.org/nginx.html">Nginx</a> - a lot of interesting things about configuring nginx. </li><li>  <a href="http://gunicorn.org/">Supervisor + gunicorn</a> - about using gunicorn via nginx. </li></ol></div><p>Source: <a href="https://habr.com/ru/post/159575/">https://habr.com/ru/post/159575/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../159563/index.html">JQuery "floating" menu for beginners</a></li>
<li><a href="../159565/index.html">Vkontakte closed for users without a mobile phone</a></li>
<li><a href="../159567/index.html">Dart: web components in action</a></li>
<li><a href="../159569/index.html">List of companies that own domains with keywords</a></li>
<li><a href="../159573/index.html">Statistics on Android devices (2012, November)</a></li>
<li><a href="../159577/index.html">Google asks to vote against censorship and restrictions on the Internet</a></li>
<li><a href="../159579/index.html">Linux Administration Olympiad on November 27th</a></li>
<li><a href="../159587/index.html">Uploading files to the server in 2012</a></li>
<li><a href="../159589/index.html">Deadline theses</a></li>
<li><a href="../159591/index.html">Google promises to return December in Android 4.2 "soon"</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>