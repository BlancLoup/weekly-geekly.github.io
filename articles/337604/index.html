<!doctype html>
<html class="no-js" lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-134931760-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'UA-134931760-1');
  </script>

  <meta charset="utf-8">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <title>Spring: Your Next Java Microfilm</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <meta name="description" content="In this article, we‚Äôll talk about a new concept in the upcoming Spring Framework 5, which is called a functional web framework, and see how it can hel...">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="../../css/main.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="../../js/vendors/jquery-3.3.1.min.js"><\/script>')</script>

  <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script>
       (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-6974184241884155",
            enable_page_level_ads: true
       });
  </script>
</head>

<body>
  <!--[if lte IE 9]>
    <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience and security.</p>
  <![endif]-->
  <header class="page-header js-page-header">
    <a class="page-header-logo-container" href="https://weekly-geekly.github.io/index.html"></a>
    <div class="page-header-text">Geekly Articles each Day</div>
  </header>
  <nav class="page-headings-container js-page-headings-container"></nav>
  <div class="tools-bar js-tools-bar">
    <!-- <a href="../../search.html" title="Search">üîé</a> -->
    <a class="js-list-of-headings-button" data-state="closed" href="#" title="Headings">üìú</a>
    <a class="js-go-to-top-button" href="#" title="Go to Top">‚¨ÜÔ∏è</a>
    <a class="js-go-to-bottom-button" href="#" title="Go to Bottom">‚¨áÔ∏è</a>
  </div>
  <a href="http://bit.ly/donateToWeeklyGeekly" class="donate-btn">DONATE</a>
  <section class="page js-page"><h1>Spring: Your Next Java Microfilm</h1><div class="post__text post__text-html js-mediator-article"><p>  In this article, we‚Äôll talk about a new concept in the upcoming Spring Framework 5, which is called a <em>functional web framework,</em> and see how it can help in developing lightweight applications and microservices. </p><a name="habracut"></a><br><p>  You may be surprised to see <strong>Spring</strong> and the <strong>microframe</strong> in one sentence.  But that's right, <strong>Spring</strong> may well become your next Java microform.  To avoid misunderstandings, let's define what they mean by <em>micro</em> : </p><br><ul><li>  Laconic - minimum boilerplate, minimum settings </li><li>  Simple - no magic </li><li>  Simple Deployment - One Deployment Artifact </li><li>  Easy to run - no additional dependencies </li><li>  Lightweight - minimal memory / CPU usage </li><li>  Non-blocking - for writing competitive non-blocking applications </li></ul><br><p> Although some of these items are relevant when using <strong>Spring Boot</strong> , it alone adds additional magic over the <strong>Spring Framework itself</strong> .  Even basic annotations such as <code>@Controller</code> not quite straightforward, what can we say about auto-configuration and scanning of components.  In general, for large-scale applications, it is simply indispensable that <strong>Spring</strong> takes care of DI, routing, configuration, etc.  However, in the world of microservices, where applications are just gears in one big machine, the whole power of <strong>Spring Boot</strong> can be a bit unnecessary. </p><br><p>  To solve this problem, the Spring team introduced a new feature, which is called a <em>functional web framework</em> - and we will talk about it.  Overall, this is part of the larger <strong>Spring WebFlux</strong> sub-project, formerly called <strong>Spring Reactive Web</strong> . </p><br><p>  First, let's go back to the basics and see what a web application is and what components we expect to have in it.  Undoubtedly, there is a basic thing - a <em>web server</em> .  To avoid manual processing of requests and calling application methods, a <em>router is</em> useful to us.  And finally, we need a <em>handler</em> - a piece of code that accepts the request and responds.  In fact, that's all you need!  And it is these components that <em>Spring</em> provides a <em>functional web framework</em> , removing all magic and focusing on a fundamental minimum.  I note that this does not mean at all that <strong>Spring</strong> abruptly changes direction and moves away from <em>Spring MVC</em> , the functional web just gives <em>another</em> opportunity to create applications on <strong>Spring</strong> . </p><br><h1 id="obrabotchik">  Handler </h1><br><p>  Let's take an example.  First of all, let's go to <a href="https://start.spring.io/">Spring Initializr</a> and create a new project using <em>Spring Boot 2.0</em> and <em>Reactive Web</em> as the only dependency.  Now we can write our first <strong>handler</strong> - a function that accepts the request and responds. </p><br><pre> <code class="java hljs">HandlerFunction hello = <span class="hljs-keyword"><span class="hljs-keyword">new</span></span> HandlerFunction() { <span class="hljs-meta"><span class="hljs-meta">@Override</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> Mono </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">handle</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(ServerRequest request)</span></span></span><span class="hljs-function"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> ServerResponse.ok().body(fromObject(<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>)); } };</code> </pre> <br><p>  So, our <em>handler</em> is just an implementation of the <code>HandlerFunction</code> interface that accepts a <code>request</code> parameter (of type <code>ServerRequest</code> ) and returns an object of type <code>ServerResponse</code> with the text "Hello".  <strong>Spring</strong> also provides convenient builders to create a response from the server.  In our case, we use <code>ok()</code> which automatically return the HTTP response code 200. To return the answer, we need another helper <code>fromObject</code> to form the response from the provided object. </p><br><p>  We can also make the code a bit more concise and use <em>lambdas</em> from Java 8 and since  <code>HandlerFunction</code> is a single method interface (single abstract method interface, SAM), we can write our function as: </p><br><pre> <code class="java hljs">HandlerFunction hello = request -&gt; ServerResponse.ok().body(fromObject(<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>));</code> </pre> <br><h1 id="router">  Router </h1><br><p>  Now that we have a handler, it's time to define a <em>router</em> .  For example, we want to call our handler when the URL "/" was called using the HTTP <code>GET</code> method.  To achieve this, we define an object of type <code>RouterFunction</code> which maps the function handler, to the route: </p><br><pre> <code class="java hljs">RouterFunction router = route(GET(<span class="hljs-string"><span class="hljs-string">"/"</span></span>), hello);</code> </pre> <br><p>  <code>route</code> and <code>GET</code> are static methods from the <code>RequestPredicates</code> and <code>RouterFunctions</code> , they allow you to create a so-called <code>RouterFunction</code> .  Such a function accepts the request, checks whether it matches all predicates (URL, method, content type, etc) and calls the required handler function.  In this case, the predicate is the <em>http method GET and the URL '/'</em> , and the handler function is <code>hello</code> , which is defined above. </p><br><h1 id="veb-server">  Web server </h1><br><p>  And now it's time to put everything together in a single application.  We use a lightweight and simple <code>Reactive Netty</code> server.  To integrate our router with a web server, you need to turn it into a <code>HttpHandler</code> .  After that you can start the server: </p><br><pre> <code class="java hljs">HttpServer .create(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>) .newHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactorHttpHandlerAdapter(httpHandler)) .block();</code> </pre> <br><p>  <code>ReactorHttpHandlerAdapter</code> is a class provided by Netty, which accepts <code>HttpHandler</code> , the rest of the code, I think, needs no explanation.  We create a new web server tied to the <code>localhost</code> host and on port <code>8080</code> and provide an <code>httpHandler</code> created from our router. </p><br><p>  And that's all, the app is ready!  And its full code: </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">main</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">(String[] args)</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">throws</span></span></span><span class="hljs-function"> IOException, LifecycleException, InterruptedException </span></span>{ HandlerFunction hello = request -&gt; ServerResponse.ok().body(fromObject(<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>)); RouterFunction router = route(GET(<span class="hljs-string"><span class="hljs-string">"/"</span></span>), hello); HttpHandler httpHandler = RouterFunctions.toHttpHandler(router); HttpServer .create(<span class="hljs-string"><span class="hljs-string">"localhost"</span></span>, <span class="hljs-number"><span class="hljs-number">8080</span></span>) .newHandler(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> ReactorHttpHandlerAdapter(httpHandler)) .block(); Thread.currentThread().join(); }</code> </pre> <br><p>  The last line is needed only to keep the JVM process alive, because  HttpServer itself does not block it.  You may immediately notice that the application starts instantly - there is neither a component scan, nor an auto-configuration. </p><br><p>  We can also run this application as a regular Java application, no application containers and other things are required. </p><br><p>  To package the deployment application, we can take advantage of the <em>Maven Spring plugin</em> and just call </p><br><p> <code>./mvnw package</code> </p> <br><p>  This command will create a so-called <em>fat JAR</em> with all dependencies included in the JAR.  This file can be terminated and run without anything but the installed JRE. </p><br><p> <code>java -jar target/functional-web-0.0.1-SNAPSHOT.jar</code> </p> <br><p>  Also, if we check the memory usage of the application, we will see that it keeps around 32 MB - 22 MB used on metaspace (classes) and about 10 MB is occupied directly in the heap.  Of course, our application doesn‚Äôt do anything - but nevertheless, it‚Äôs just an indicator that the framework and runtime themselves require a minimum of system resources. </p><br><h1 id="podderzhka-json">  JSON support </h1><br><p>  In our example, we returned a string, but returning a JSON response is just as easy.  Let's extend our application with a new endpoint that will return JSON.  Our model will be very simple - just one string field called <code>name</code> .  To avoid unnecessary boilerplate code, we will use features from the <a href="https://projectlombok.org/">Lombok</a> project, the <code>@Data</code> annotation.  The presence of this annotation will automatically create getters, setters, <code>equals</code> and <code>hashCode</code> methods, so we don‚Äôt have to manually release them. </p><br><pre> <code class="java hljs"><span class="hljs-meta"><span class="hljs-meta">@Data</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">Hello</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> String name; }</code> </pre> <br><p>  Now, we need to expand our router to return the JSON response when accessing the URL <code>/json</code> .  This can be done by calling the <code>andRoute(...)</code> method on the existing route.  Also, let's move the code of the router into a separate function in order to separate it from the application code and allow it to be used later in tests. </p><br><pre> <code class="java hljs"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">static</span></span></span><span class="hljs-function"> RouterFunction </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">getRouter</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ HandlerFunction hello = request -&gt; ok().body(fromObject(<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>)); <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> route( GET(<span class="hljs-string"><span class="hljs-string">"/"</span></span>), hello) .andRoute( GET(<span class="hljs-string"><span class="hljs-string">"/json"</span></span>), req -&gt; ok() .contentType(APPLICATION_JSON) .body(fromObject(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Hello(<span class="hljs-string"><span class="hljs-string">"world"</span></span>))); }</code> </pre> <br><p>  After restarting, the application will return <code>{ "name": "world" }</code> when accessing the URL <code>/json</code> when requesting content with the type <code>application/json</code> . </p><br><h1 id="kontekst-prilozheniya">  Application context </h1><br><p>  You may have noticed that we have not defined the context of the application - we just do not need it!  Despite the fact that we can declare <code>RouterFunction</code> as a bin (bean) in the context of the Spring WebFlux application, and it will also process requests for specific URLs in the same way, the router can be run just over the Netty Server to create simple and lightweight JSON services. </p><br><h1 id="testirovanie">  Testing </h1><br><p>  To test reactive applications, <strong>Spring</strong> provides a new client called <code>WebTestClient</code> (like <code>MockMvc</code> ).  You can create it for an existing application context, but you can also define it for <code>RouterFunction</code> . </p><br><pre> <code class="java hljs"><span class="hljs-keyword"><span class="hljs-keyword">public</span></span> <span class="hljs-class"><span class="hljs-keyword"><span class="hljs-class"><span class="hljs-keyword">class</span></span></span><span class="hljs-class"> </span><span class="hljs-title"><span class="hljs-class"><span class="hljs-title">FunctionalWebApplicationTests</span></span></span><span class="hljs-class"> </span></span>{ <span class="hljs-keyword"><span class="hljs-keyword">private</span></span> <span class="hljs-keyword"><span class="hljs-keyword">final</span></span> WebTestClient webTestClient = WebTestClient .bindToRouterFunction( FunctionalWebApplication.getRouter()) .build(); <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">indexPage_WhenRequested_SaysHello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ webTestClient.get().uri(<span class="hljs-string"><span class="hljs-string">"/"</span></span>).exchange() .expectStatus().is2xxSuccessful() .expectBody(String.class) .isEqualTo(<span class="hljs-string"><span class="hljs-string">"Hello"</span></span>); } <span class="hljs-meta"><span class="hljs-meta">@Test</span></span> <span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">public</span></span></span><span class="hljs-function"> </span><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">void</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">jsonPage_WhenRequested_SaysHello</span></span></span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">()</span></span></span><span class="hljs-function"> </span></span>{ webTestClient.get().uri(<span class="hljs-string"><span class="hljs-string">"/json"</span></span>).exchange() .expectStatus().is2xxSuccessful() .expectHeader().contentType(APPLICATION_JSON) .expectBody(Hello.class) .isEqualTo(<span class="hljs-keyword"><span class="hljs-keyword">new</span></span> Hello(<span class="hljs-string"><span class="hljs-string">"world"</span></span>)); } }</code> </pre> <br><p>  <code>WebTestClient</code> includes a number of <code>WebTestClient</code> that can be applied to the received response in order to validate the HTTP code, the content of the response, the type of response, etc. </p><br><h1 id="v-zaklyuchenie">  Finally </h1><br><p>  <strong>Spring 5</strong> introduces a new paradigm for developing small and lightweight microservice-style web applications.  Such applications can work without application context, autoconfiguration, and generally use the <em>microframe</em> approach, when the router and handler functions and the web server are explicitly defined in the application body. </p><br><h1 id="kod">  Code </h1><br><p>  Available on <a href="https://github.com/alek-sys/spring-functional-microframework">GitHub</a> </p><br><h1 id="ssylki">  Links </h1><br><ul><li>  <a href="https://spring.io/blog/2016/09/22/new-in-spring-5-functional-web-framework">New in Spring 5: Functional Web Framework</a> </li><li>  <a href="https://spring.io/blog/2016/06/13/notes-on-reactive-programming-part-ii-writing-some-code">Notes on Reactive Programming Part II: Writing Some Code</a> </li><li>  Very nice intro to Spring Functional Web from Baeldung - <a href="http://www.baeldung.com/spring-5-functional-web">Introduction to the Functional Web Framework in Spring 5</a> </li><li>  <a href="https://spring.io/blog/2016/07/28/reactive-programming-with-spring-5-0-m1">Reactive Programming with Spring 5.0 M1</a> </li><li>  Discussion of the original article on <a href="https://www.reddit.com/r/programming/comments/65rdta/spring_your_next_java_microframework/">Reddit</a> </li></ul><br><h1 id="ot-perevodchika">  From translator </h1><br><p>  I am also the author of the original article, so questions can be asked in the comments. </p></div>
      <br>
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <ins class="adsbygoogle"
          style="display:block; text-align:center;"
          data-ad-layout="in-article"
          data-ad-format="fluid"
          data-ad-client="ca-pub-6974184241884155"
          data-ad-slot="8945601208"></ins>
        <script>
          (adsbygoogle = window.adsbygoogle || []).push({});
        </script>
      <br>
    <p>Source: <a href="https://habr.com/ru/post/337604/">https://habr.com/ru/post/337604/</a></p>
<section class="more-articles-navigation-panel js-more-articles-navigation-panel">
<h4>More articles:</h4>
<nav class="list-of-articles-container js-list-of-articles-container"><ul class="list-of-pages js-list-of-pages">
<li><a href="../337590/index.html">Esoteric language translated into C ++ templates</a></li>
<li><a href="../337594/index.html">Balanced B-tree Search Tree (t = 2)</a></li>
<li><a href="../337596/index.html">Jack and Android or the Tale of Earth and Sky</a></li>
<li><a href="../337598/index.html">ggplot2: how to easily combine multiple graphs in one, part 2</a></li>
<li><a href="../337602/index.html">Work and life in Bulgaria. Part two</a></li>
<li><a href="../337606/index.html">Count to three: four</a></li>
<li><a href="../337608/index.html">The hunt for the Kremlin demon</a></li>
<li><a href="../337610/index.html">The digest of fresh materials from the world of the frontend for the last week ‚Ññ279 (September 4 - 10, 2017)</a></li>
<li><a href="../337614/index.html">Workplace control: a new ruling by the European Court</a></li>
<li><a href="../337616/index.html">PHP Digest number 116 - the latest news, materials and tools (August 27 - September 10, 2017)</a></li>
</ul></nav>
</section><br />
<a href="../../allArticles.html"><strong>All Articles</strong></a>
<script src="../../js/main.js"></script>

<!-- Yandex.Metrika counter -->
<script type="text/javascript" >
  (function (d, w, c) {
      (w[c] = w[c] || []).push(function() {
          try {
              w.yaCounter52496797 = new Ya.Metrika({
                  id:52496797,
                  clickmap:true,
                  trackLinks:true,
                  accurateTrackBounce:true,
                  webvisor:true
              });
          } catch(e) { }
      });

      var n = d.getElementsByTagName("script")[0],
          s = d.createElement("script"),
          f = function () { n.parentNode.insertBefore(s, n); };
      s.type = "text/javascript";
      s.async = true;
      s.src = "https://mc.yandex.ru/metrika/watch.js";

      if (w.opera == "[object Opera]") {
          d.addEventListener("DOMContentLoaded", f, false);
      } else { f(); }
  })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/52496797" style="position:absolute; left:-9999px;" alt="" /></div></noscript>

<!-- Google Analytics -->
  <script>
    window.ga = function () { ga.q.push(arguments) }; ga.q = []; ga.l = +new Date;
    ga('create', 'UA-134931760-1', 'auto'); ga('send', 'pageview')
  </script>
  <script src="https://www.google-analytics.com/analytics.js" async defer></script>

</section>

  <footer class="page-footer">
    <div class="page-footer-legal-info-container page-footer-element">
      <p>
        Weekly-Geekly | <span class="page-footer-legal-info-year js-page-footer-legal-info-year">2019</span>
      </p>
    </div>
    <div class="page-footer-counters-container page-footer-element">
      <a class="page-footer-counter-clustrmap" href='#'  title='Visit tracker'><img src='https://clustrmaps.com/map_v2.png?cl=698e5a&w=271&t=t&d=6iCFw7uJz0zcOaoxz5k5PcLCJUzv2WG8G5V8M3U6Rc4&co=3a3a3a&ct=ffffff'/></a>
    </div>
  </footer>
</body>

</html>